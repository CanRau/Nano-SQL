!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("really-small-events")):"function"==typeof define&&define.amd?define(["exports","really-small-events"],n):n(t.nSQL={},t.reallySmallEvents)}(this,function(t,o){"use strict";o=o&&o.hasOwnProperty("default")?o.default:o;var h="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function n(t){return t&&t.t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function r(t,n){return t(n={exports:{}},n.exports),n.exports}var i=function(t,n){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var r in n)n.hasOwnProperty(r)&&(t[r]=n[r])})(t,n)};var e=function(){return(e=Object.assign||function(t){for(var n,r=1,i=arguments.length;r<i;r++)for(var e in n=arguments[r])Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e]);return t}).apply(this,arguments)};function u(t){var n="function"==typeof Symbol&&t[Symbol.iterator],r=0;return n?n.call(t):{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}}}function s(t,n){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var i,e,o=r.call(t),u=[];try{for(;(void 0===n||0<n--)&&!(i=o.next()).done;)u.push(i.value)}catch(t){e={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(e)throw e.error}}return u}function l(t){return this instanceof l?(this.v=t,this):new l(t)}var c=Object.freeze({n:function(t,n){function r(){this.constructor=t}i(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)},get r(){return e},i:function(t,n){var r={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&n.indexOf(i)<0&&(r[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var e=0;for(i=Object.getOwnPropertySymbols(t);e<i.length;e++)n.indexOf(i[e])<0&&(r[i[e]]=t[i[e]])}return r},e:function(t,n,r,i){var e,o=arguments.length,u=o<3?n:null===i?i=Object.getOwnPropertyDescriptor(n,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)u=Reflect.decorate(t,n,r,i);else for(var s=t.length-1;0<=s;s--)(e=t[s])&&(u=(o<3?e(u):3<o?e(n,r,u):e(n,r))||u);return 3<o&&u&&Object.defineProperty(n,r,u),u},o:function(r,i){return function(t,n){i(t,n,r)}},u:function(t,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,n)},s:function(o,u,s,c){return new(s||(s=Promise))(function(t,n){function r(t){try{e(c.next(t))}catch(t){n(t)}}function i(t){try{e(c.throw(t))}catch(t){n(t)}}function e(n){n.done?t(n.value):new s(function(t){t(n.value)}).then(r,i)}e((c=c.apply(o,u||[])).next())})},c:function(r,i){var e,o,u,t,s={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]};return t={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function n(n){return function(t){return function(n){if(e)throw new TypeError("Generator is already executing.");for(;s;)try{if(e=1,o&&(u=2&n[0]?o.return:n[0]?o.throw||((u=o.return)&&u.call(o),0):o.next)&&!(u=u.call(o,n[1])).done)return u;switch(o=0,u&&(n=[2&n[0],u.value]),n[0]){case 0:case 1:u=n;break;case 4:return s.label++,{value:n[1],done:!1};case 5:s.label++,o=n[1],n=[0];continue;case 7:n=s.ops.pop(),s.trys.pop();continue;default:if(!(u=0<(u=s.trys).length&&u[u.length-1])&&(6===n[0]||2===n[0])){s=0;continue}if(3===n[0]&&(!u||n[1]>u[0]&&n[1]<u[3])){s.label=n[1];break}if(6===n[0]&&s.label<u[1]){s.label=u[1],u=n;break}if(u&&s.label<u[2]){s.label=u[2],s.ops.push(n);break}u[2]&&s.ops.pop(),s.trys.pop();continue}n=i.call(r,s)}catch(t){n=[6,t],o=0}finally{e=u=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,t])}}},f:function(t,n){for(var r in t)n.hasOwnProperty(r)||(n[r]=t[r])},a:u,h:s,l:function(){for(var t=[],n=0;n<arguments.length;n++)t=t.concat(s(arguments[n]));return t},d:l,p:function(t,n,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,o=r.apply(t,n||[]),u=[];return e={},i("next"),i("throw"),i("return"),e[Symbol.asyncIterator]=function(){return this},e;function i(i){o[i]&&(e[i]=function(r){return new Promise(function(t,n){1<u.push([i,r,t,n])||s(i,r)})})}function s(t,n){try{(r=o[t](n)).value instanceof l?Promise.resolve(r.value.v).then(c,f):a(u[0][2],r)}catch(t){a(u[0][3],t)}var r}function c(t){s("next",t)}function f(t){s("throw",t)}function a(t,n){t(n),u.shift(),u.length&&s(u[0][0],u[0][1])}},y:function(i){var t,e;return t={},n("next"),n("throw",function(t){throw t}),n("return"),t[Symbol.iterator]=function(){return this},t;function n(n,r){t[n]=i[n]?function(t){return(e=!e)?{value:l(i[n](t)),done:"return"===n}:r?r(t):t}:r}},b:function(c){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=c[Symbol.asyncIterator];return n?n.call(c):(c=u(c),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(s){t[s]=c[s]&&function(u){return new Promise(function(t,n){var r,i,e,o;u=c[s](u),r=t,i=n,e=u.done,o=u.value,Promise.resolve(o).then(function(t){r({value:t,done:e})},i)})}}},w:function(t,n){return Object.defineProperty?Object.defineProperty(t,"raw",{value:n}):t.raw=n,t},g:function(t){if(t&&t.t)return t;var n={};if(null!=t)for(var r in t)Object.hasOwnProperty.call(t,r)&&(n[r]=t[r]);return n.default=t,n},m:function(t){return t&&t.t?t:{default:t}}}),w=r(function(t,c){Object.defineProperty(c,"t",{value:!0}),c.buildQuery=function(t,n){return{table:t,action:n,state:"pending",result:[],time:Date.now(),queryID:c.uuid(),extend:[],comments:[]}},c.noop=function(){},c.throwErr=function(t){throw new Error(t)},c._=function(t){return t?JSON.parse(JSON.stringify(t)):null},c.compareObjects=function(t,n){if(t===n)return!0;if("object"!=typeof t)return!1;if(!t||!n)return!1;var r=Array.isArray(t),i=Object.keys(t),e=r?t.length===n.length:i.length===Object.keys(n).length;if(!e)return!1;for(var o=i.length;o--&&e;){var u=i[o];e="object"==typeof t[u]?c.compareObjects(t[u],n[u]):t[u]===n[u]}return e},c.chainAsync=function(o,u){return new Promise(function(t,n){if(o&&o.length){var r=[],i=0,e=function(){i<o.length?u(o[i],i,function(t){t&&r.push(t||0),++i%500==0?c.setFast(e):e()},function(t){n(t)}):t(r.length?r:void 0)};e()}else t([])})},c.allAsync=function(t,e){return Promise.all((t||[]).map(function(r,i){return new Promise(function(t,n){e(r,i,t,n)})}))};var n="undefined"==typeof window?"":navigator.userAgent||"";c.isSafari=0!==n.length&&(/^((?!chrome|android).)*safari/i.test(n)||/iPad|iPhone|iPod/.test(n)&&!window.MSStream),c.isMSBrowser=0!==n.length&&(0<n.indexOf("MSIE ")||0<n.indexOf("Trident/")||0<n.indexOf("Edge/")),c.isAndroid=/Android/.test(n),c.random16Bits=function(){if("undefined"==typeof crypto)return Math.round(Math.random()*Math.pow(2,16));if(crypto.getRandomValues){var t=new Uint16Array(1);return crypto.getRandomValues(t),t[0]}return void 0!==h&&h.S.randomBytes?h.S.randomBytes(2).reduce(function(t,n){return n*t}):Math.round(Math.random()*Math.pow(2,16))},c.throttle=function(r,i){var e=!1;return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];e||(e=!0,setTimeout(function(){r.apply(null,t),e=!1},i))}},c.timeid=function(t){for(var n=Math.round((new Date).getTime()/(t?1:1e3)).toString();n.length<(t?13:10);)n="0"+n;return n+"-"+(c.random16Bits()+c.random16Bits()).toString(16)},c.intersect=function(t,n){return!(!t||!n)&&(!(!t.length||!n.length)&&0<(t||[]).filter(function(t){return-1!==(n||[]).indexOf(t)}).length)},c.uuid=function(){var i,e,o="";return[o,o,o,o,o,o,o,o].reduce(function(t,n,r){for(i=c.random16Bits(),e=3===r?4:4===r?(i%16&3|8).toString(16):o,i=i.toString(16);i.length<4;)i="0"+i;return t+(-1<[2,3,4,5].indexOf(r)?"-":o)+(e+i).slice(0,4)},o)},c.hash=function(t){for(var n=5381,r=t.length;r;)n=33*n^t.charCodeAt(--r);return(n>>>0).toString(16)};var r={int:function(t){return t},uuid:c.uuid,timeId:function(){return c.timeid()},timeIdms:function(){return c.timeid(!0)}};c.generateID=function(t,n){return r[t]?r[t](n||1):""},c.cleanArgs=function(t,n){for(var r={},i=t.length;i--;){var e=t[i].split(":");1<e.length?r[e[0]]=c.cast(e[1],n[e[0]]||void 0,!0):r[e[0]]=n[e[0]]||void 0}return r},c.isObject=function(t){return"[object Object]"===Object.prototype.toString.call(t)},c.objSort=function(i,e){return function(t,n){var r=i?c.objQuery(i,t)>c.objQuery(i,n)?-1:1:n<t?-1:1;return e?-1*r:r}},c.cast=function(t,r,i){if("any"===t||"blob"===t)return r;if(-1!==t.indexOf("[]")){var n=t.slice(0,t.lastIndexOf("[]"));return Array.isArray(r)?r.map(function(t){return c.cast(n,t,i)}):[]}var e=typeof r,o={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},u=function(t,n){switch(t){case"safestr":return u("string",n).replace(/[&<>"'`=\/]/gim,function(t){return o[t]});case"int":return"number"!==e||n%1!=0?parseInt(n||0):n;case"number":case"float":return"number"!==e?parseFloat(n||0):n;case"array":return Array.isArray(n)?n:[];case"uuid":case"timeId":case"timeIdms":case"string":return"string"!==e?String(n):n;case"object":case"obj":case"map":return c.isObject(n)?n:{};case"boolean":case"bool":return!0===n||1===n}return i?r:null};if(null==r)return null;var s=u(String(t||"").toLowerCase(),r);return void 0!==s&&-1<["int","float","number"].indexOf(t)&&isNaN(s)?0:s},c.O=function(t){return Object.isFrozen(t)?c._(t):t},c.deepFreeze=function(r){return Object.getOwnPropertyNames(r||{}).forEach(function(t){var n=r[t];"object"==typeof n&&null!==n&&(r[t]=c.deepFreeze(n))}),Object.freeze(r)},c.crowDistance=function(t,n,r,i,e){void 0===e&&(e=6371);var o=function(t){return t*(Math.PI/180)},u=o(r-t),s=o(i-n),c=Math.sin(u/2)*Math.sin(u/2)+Math.cos(o(t))*Math.cos(o(r))*Math.sin(s/2)*Math.sin(s/2);return e*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))};var o={};c.resolveObjPath=function(t,n){var r=t+(n?"0":"1");if(o[r])return o[r];var i=-1<t.indexOf("[")?t.split(/\.|\[/gim).map(function(t){return t.replace(/\]/gim,"")}):t.split(".");if(n){var e=i.shift()+"."+i.shift();i.unshift(e)}return o[r]=i,o[r]},c.getFnValue=function(t,n,r){return n.match(/\".*\"|\'.*\'/gim)?n.replace(/\"(.*)\"|\'(.*)\'/gim,"$1"):c.objQuery(n,t,r)},c.objQuery=function(t,n,r){var i=function(t,n,r){return t[n]&&r?i(t,n+1,r[t[n]]):r};return i(Array.isArray(t)?t:c.resolveObjPath(t,r),0,n)};var e=0,u={},i=Array.prototype.slice,s="undefined"!=typeof window&&window.postMessage&&window.addEventListener,f=function(t){return t[0].apply(null,i.call(t,1))};s&&window.addEventListener("message",function(t){var n,r=t.data;"string"==typeof r&&0===r.indexOf("setMsg")&&(n=u[r])&&(delete u[r],f(n))});var a=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var r=e++,i="setMsg"+r;return u[i]=t,window.postMessage(i,"*"),r};c.setFast=s?a:function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];void 0!==h?h.setImmediate(function(){f(t)}):setTimeout(function(){f(t)},0)}});n(w);w.buildQuery,w.noop,w.throwErr,w._,w.compareObjects,w.chainAsync,w.allAsync,w.isSafari,w.isMSBrowser,w.isAndroid,w.random16Bits,w.throttle,w.timeid,w.intersect,w.uuid,w.hash,w.generateID,w.cleanArgs,w.isObject,w.objSort,w.cast,w.O,w.deepFreeze,w.crowDistance,w.resolveObjPath,w.getFnValue,w.objQuery,w.setFast;var p=r(function(t,n){var r;Object.defineProperty(n,"t",{value:!0}),(r=n.IWhereType||(n.IWhereType={}))[r.fast=0]="fast",r[r.medium=1]="medium",r[r.slow=2]="slow",r[r.fn=3]="fn",r[r.none=4]="none"});n(p);p.IWhereType;var f=r(function(t,n){Object.defineProperty(n,"t",{value:!0});var r=function(){function t(t,n,r){this.k=t,this.N=n,this.j=r,this.A=[],this.T=0,this.M=[]}return t.prototype.debounce=function(t){return this.M[this.A.length]=t,this.A.push("dbnc"),this},t.prototype.distinct=function(t,n){return this.M[this.A.length]=[t||function(t){return t},n||function(t,n){return t===n}],this.A.push("dsct"),this},t.prototype.filter=function(t){return this.M[this.A.length]=t,this.A.push("fltr"),this},t.prototype.map=function(t){return this.M[this.A.length]=t,this.A.push("mp"),this},t.prototype.first=function(t){return this.M[this.A.length]=t||function(t,n){return!0},this.A.push("fst"),this},t.prototype.skip=function(t){return this.M[this.A.length]=t,this.A.push("skp"),this},t.prototype.take=function(t){return this.M[this.A.length]=t,this.A.push("tk"),this},t.prototype.subscribe=function(s){var c,f=this,a={},h={},l={},v={};return new p.INanoSQLObserverSubscriber(this.k,this.N,{next:function(i,e){if(f.T++,!c){var o=0,u=function(){if(o===f.A.length)"function"==typeof s?s(i,e):s.next&&s.next(i,e),c&&s.complete&&s.complete(i,e);else{var t=function(t){if(0===f.T)return 0;for(var n=t,r=f.T,i=!1;n--&&!i;)void 0!==v[n]&&(i=!0,r=v[n]);return r};switch(f.A[o]){case"dbnc":if(h[o]){clearTimeout(l[o]);var n=f.M[o];return void(l[o]=setTimeout(function(){Date.now()-h[o]>=n&&(h[o]=Date.now(),void 0===v[o]&&(v[o]=0),v[o]++,o++,u())},n-(Date.now()-h[o])))}h[o]=Date.now();break;case"dsct":var r=f.M[o][0](i,e);if(!1!==f.M[o][1](a[o],r))return;a[o]=r,void 0===v[o]&&(v[o]=0),v[o]++;break;case"fltr":if(!1===f.M[o](i,t(o),e))return;void 0===v[o]&&(v[o]=0),v[o]++;break;case"fst":if(!0!==f.M[o](i,t(o),e))return;void 0===v[o]&&(v[o]=0),v[o]++,c=!0;break;case"mp":i=f.M[o](i,t(o),e);break;case"skp":if(t(o)<=f.M[o])return;break;case"tk":t(o)>=f.M[o]&&(c=!0)}o++,u()}};u()}},error:function(t){s.error&&s.error(t)}},this.j)},t}();n.Observer=r;var i=function(){function t(t,n,r,i){var e=this;this.P=!1,this.exec=this.exec.bind(this),this.unsubscribe=this.unsubscribe.bind(this);var o=this.x();o&&(this.j=this.j.concat([o.table]),this.j=this.j.filter(function(t,n,r){return r.indexOf(t)===n}),this.exec()),this.j.forEach(function(t){e.k.selectTable(t).on("change",e.exec)})}return t.prototype.exec=function(t){var n=this;w.setFast(function(){n.x(t)})},t.prototype.unsubscribe=function(){var n=this;this.j.forEach(function(t){n.k.selectTable(t).off("change",n.exec)}),this.P=!0},t.prototype.closed=function(){return this.P},t}();n.ObserverSubscriber=i});n(f);f.Observer,f.ObserverSubscriber;var v=function(t,n,r){var i,e,o,u,s,c,f,a;if(t===n)return 0;if(i=t.length,e=n.length,0===i)return e;if(0===e)return i;r&&(t=t.toLowerCase(),n=n.toLowerCase());f=0;for(;f<i;)y[f]=t.charCodeAt(f),d[f]=++f;a=0;for(;a<e;)for(o=n.charCodeAt(a),u=s=a++,f=-1;++f<i;)c=o===y[f]?s:s+1,s=d[f],d[f]=u=u<s?u<c?u+1:c:s<c?s+1:c;return u},d=[],y=[];var a=r(function(t,n){Object.defineProperty(n,"t",{value:!0});var a={};n.attachDefaultFns=function(f){f.functions={COUNT:{type:"A",aggregateStart:{result:0,row:{}},call:function(t,n,r,i,e){return e&&"*"!==e?w.objQuery(e,n,r)&&i.result++:i.result++,i.row=n,i}},MAX:{type:"A",aggregateStart:{result:void 0,row:{}},call:function(t,n,r,i,e){var o=w.objQuery(e,n,r)||0;return void 0===i.result?(i.result=o,i.row=n):o>i.result&&(i.result=o,i.row=n),i}},MIN:{type:"A",aggregateStart:{result:void 0,row:{}},call:function(t,n,r,i,e){var o=w.objQuery(e,n,r)||0;return void 0===i.result?(i.result=o,i.row=n):o<i.result&&(i.result=o,i.row=n),i}},GREATEST:{type:"S",call:function(t,n,r,i){for(var e=[],o=4;o<arguments.length;o++)e[o-4]=arguments[o];return{result:e.map(function(t){return isNaN(t)?w.getFnValue(n,t,r):parseFloat(t)}).sort(function(t,n){return t<n?1:-1})[0]}}},LEAST:{type:"S",call:function(t,n,r,i){for(var e=[],o=4;o<arguments.length;o++)e[o-4]=arguments[o];return{result:e.map(function(t){return isNaN(t)?w.getFnValue(n,t,r):parseFloat(t)}).sort(function(t,n){return n<t?1:-1})[0]}}},AVG:{type:"A",aggregateStart:{result:0,row:{},total:0,records:0},call:function(t,n,r,i,e){var o=parseFloat(w.objQuery(e,n,r)||0)||0;return i.total+=isNaN(o)?0:o,i.records++,i.result=i.total/i.records,i.row=n,i}},SUM:{type:"A",aggregateStart:{result:0,row:{}},call:function(t,n,r,i,e){var o=parseFloat(w.objQuery(e,n,r)||0)||0;return i.result+=isNaN(o)?0:o,i.row=n,i}},LOWER:{type:"S",call:function(t,n,r,i,e){return{result:String(w.getFnValue(n,e,r)).toLowerCase()}}},UPPER:{type:"S",call:function(t,n,r,i,e){return{result:String(w.getFnValue(n,e,r)).toUpperCase()}}},CAST:{type:"S",call:function(t,n,r,i,e,o){return{result:w.cast(o,w.objQuery(e,n,r))}}},CONCAT:{type:"S",call:function(t,n,r,i){for(var e=[],o=4;o<arguments.length;o++)e[o-4]=arguments[o];return{result:e.map(function(t){return w.getFnValue(n,t,r)}).join("")}}},LEVENSHTEIN:{type:"S",call:function(t,n,r,i,e,o){var u=w.getFnValue(n,e,r),s=w.getFnValue(n,o,r),c=u+"::"+s;return a[c]||(a[c]=v(u,s)),{result:a[c]}}},CROW:{type:"S",call:function(t,n,r,i,e,o,u){var s=w.objQuery(e+".lat",n,r),c=w.objQuery(e+".lon",n,r);return{result:w.crowDistance(s,c,parseFloat(o),parseFloat(u),f.earthRadius)}},whereIndex:function(t,n,r,i){if(">"===i[1]||">="===i[1]){var e="string"==typeof n.table?t.tables[n.table].indexes:{},o=w.resolveObjPath(r[0]),u=[];if(Object.keys(e).forEach(function(t){var n=e[t];w.compareObjects(n.path.slice(0,n.path.length-1),o)&&u.push(n.name.replace("-lat","").replace("-lon",""))}),2===u.length)return{index:u[0],fnName:"CROW",fnArgs:r,comp:i[1],value:i[2]}}return!1},queryIndex:function(t,n,r,i,e,o){}}},Object.getOwnPropertyNames(Math).forEach(function(s){f.functions[s.toUpperCase()]={type:"S",call:function(t,n,r,i){for(var e=[],o=4;o<arguments.length;o++)e[o-4]=arguments[o];var u=e.map(function(t){return parseFloat(isNaN(t)?w.objQuery(t,n,r):t)});return{result:Math[s].apply(null,u)}}}})}});n(a);a.attachDefaultFns;function b(t){if(!(this instanceof b))return new b(t);t=t||{},this.concurrency=t.concurrency||1/0,this.pending=0,this.jobs=[],this.cbs=[],this.I=function(){this.pending--,this.C()}.bind(this)}["push","unshift","splice"].forEach(function(n){b.prototype[n]=function(){var t=Array.prototype[n].apply(this.jobs,arguments);return this.C(),t}}),Object.defineProperty(b.prototype,"length",{get:function(){return this.pending+this.jobs.length}}),b.prototype.C=function(){if(this.pending!==this.concurrency){if(this.jobs.length){var t=this.jobs.shift();this.pending++,t(this.I),this.C()}if(0===this.pending)for(;0!==this.cbs.length;){var n=this.cbs.pop();process.nextTick(n)}}},b.prototype.onDone=function(t){"function"==typeof t&&(this.cbs.push(t),this.C())};var g,m=b,_=(g=c)&&g.default||g,S=r(function(t,n){Object.defineProperty(n,"t",{value:!0});var r=function(){function f(t,n,r,i,e){var o=this;this.nSQL=t,this.query=n,this.progress=r,this.complete=i,this.error=e,this.L=[],this.R=!0,this.q=[],this.D=!1,this.J=!1,this.F={},this.query.state="processing";var u=n.action.toLowerCase().trim();if("select"!==u&&"string"!=typeof n.table)return this.query.state="error",void this.error('Only "select" queries are available for this resource!');if("string"==typeof n.table&&!this.nSQL.state.connected)return this.query.state="error",void this.error("Can't execute query before the database has connected!");var s=function(t){return"string"!=typeof o.query.table?(o.query.state="error",void o.error(o.query.action+" query requires a string table argument!")):o.query.actionArgs?void t():(o.query.state="error",void o.error(o.query.action+" query requires an additional argument!"))},c=function(){"error"!==o.query.state&&(o.query.state="complete",o.complete())};switch(u){case"select":this.Q(c,this.error);break;case"upsert":this.W(this.progress,this.complete);break;case"delete":this.U(this.progress,this.complete);break;case"show tables":this.V();break;case"describe":this.B();break;case"drop":case"drop table":this.dropTable(this.query.table,c,this.error);break;case"create table":case"create table if not exists":s(function(){o.createTable(o.query.actionArgs,c,o.error)});break;case"alter table":s(function(){o.alterTable(o.query.actionArgs,c,o.error)});break;case"create relation":s(function(){o.G(o.query.table,o.query.actionArgs,c,o.error)});break;case"drop relation":this.K(this.query.table,c,this.error);break;case"rebuild index":this.H(this.query.table,c,this.error);break;default:this.query.state="error",this.error('Query type "'+n.action+'" not supported!')}}return f.prototype.X=function(d,t,p,n){var r,y=this;if(!d[0])return p(t),void n();var b=function(e,n,t){var r=d[n],i=0,o=[],u=0;if("cross"!==r.type&&!r.on)return y.query.state="error",void y.error("Non 'cross' joins require an 'on' parameter!");var s="Must use 'AS' when joining temporary tables!";if("string"!=typeof r.with.table&&!r.with.as)return y.query.state="error",void y.error(s);if("string"!=typeof y.query.table&&!y.query.tableAS)return y.query.state="error",void y.error(s);var c=function(t){return("string"==typeof t[0]?[t]:t).map(function(t){if(Array.isArray(t[0]))return c(t);if("AND"===t||"OR"===t)return t;var n=w.resolveObjPath(t[0]),r=w.resolveObjPath(t[2]),i=n[0]===(y.query.tableAS||y.query.table);return[i?r.slice(1).join("."):n.slice(1).join("."),i?-1!==t[1].indexOf(">")?t[1].replace(">","<"):t[1].replace("<",">"):t[1],w.objQuery(i?n:r,e)]})},f=function(t){var e;d[n+1]?(u++,b(t,n+1,function(){u--,a()})):p((e=t,Object.keys(e).reduce(function(n,r){var i=e[r];return i&&Object.keys(i).forEach(function(t){n[r+"."+t]=i[t]}),n},{})))},a=function(){u||t()},h="string"==typeof r.with.table?y.nSQL.tables[r.with.table].pkCol:"",l=String(r.with.as||r.with.table),v=String(y.query.tableAS||y.query.table);y.nSQL.triggerQuery(_.r({},w.buildQuery(r.with.table,"select"),{tableAS:r.with.as,where:r.on&&"cross"!==r.type?c(r.on):void 0,skipQueue:!0}),function(t){var n;i++,"right"!==r.type&&"outer"!==r.type||o.push(h?t[h]:w.hash(JSON.stringify(t))),f(_.r({},e,((n={})[l]=t,n)))},function(){var t,n;switch(r.type){case"left":0===i&&f(_.r({},e,((t={})[l]=void 0,t))),a();break;case"inner":case"cross":a();break;case"outer":case"right":0===i&&"outer"===r.type&&f(_.r({},e,((n={})[l]=void 0,n))),y.nSQL.triggerQuery(_.r({},w.buildQuery(r.with.table,"select"),{skipQueue:!0,where:h?[h,"NOT IN",o]:void 0}),function(t){var n;(h||-1===o.indexOf(w.hash(JSON.stringify(t))))&&f(_.r({},e,((n={})[v]=void 0,n[l]=t,n)))},function(){a()},function(t){y.query.state="error",y.error(t)})}},function(t){y.query.state="error",y.error(t)})};b(((r={})[String(this.query.tableAS||this.query.table)]=t,r),0,n)},f.prototype.Q=function(n,t){var e=this;if(this.$=this.query.where?this.z(this.query.where,"string"!=typeof this.query.table||void 0!==this.query.union):{type:p.IWhereType.none},this.Y=this.query.having?this.z(this.query.having,!0):{type:p.IWhereType.none},this.Z(),"error"!==this.query.state){if(1<[this.query.orm,this.query.join,this.query.union].filter(function(t){return t}).length)return this.query.state="error",void t("Can only have one of orm, join or union!");var i=[this.query.offset||0,(this.query.offset||0)+(this.query.limit||0)],o=0<i[0]+i[1];if(this.query.union){var u=[],s=[],c=0;w.chainAsync(this.query.union.queries,function(t,n,r){t().then(function(t){s.length||(s=Object.keys(t[0])),e.query.where&&(t=t.filter(function(t,n){return e.tt(t,e.$.slowWhere,!1)})),t=t.map(function(i){if(e.query.union&&"distinct"===e.query.union.type){var t=w.hash(JSON.stringify(i));if(0===n)u.push(t);else{if(-1!==u.indexOf(t))return;u.push(t)}}return Object.keys(i).reduce(function(t,n,r){return r<s.length&&(t[s[r]]=i[n]),t},{})}).filter(function(t){return t}),e.query.orderBy?e.L=e.L.concat(t.map(function(t){var n=e.nt(t,!1);return!e.query.having||e.tt(n,e.Y.slowWhere,!1)?n:void 0}).filter(function(t){return t})):t.forEach(function(t,n){var r=e.nt(t,!1);(!e.query.having||e.tt(r,e.Y.slowWhere,!1))&&(o?i[0]<=c&&c<i[1]&&e.progress(e.nt(t,!1),c):e.progress(e.nt(t,!1),c),c++)}),r()})}).then(function(){if(e.query.orderBy){var t=e.L.sort(e.rt);(o?t.slice(i[0],i[1]):t).forEach(e.progress)}n()})}else{var f=Array.isArray(this.query.join)?this.query.join:[this.query.join],a=!1,h=0;!this.R||this.query.join||this.query.orderBy||this.query.having||this.query.groupBy||(a=!0);var l=function(){if(0===h){if(a||e.R)return void n();e.it(),e.query.having&&(e.L=e.L.filter(function(t){return e.tt(t,e.Y.slowWhere,void 0!==e.query.join)})),e.query.orderBy&&e.L.sort(e.rt),o&&(e.L=e.L.slice(i[0],i[1])),e.L.forEach(function(t,n){e.progress(t,i[0]+n)}),n()}};this.et(function(t,n){if(a)o?i[0]<=n&&n<i[1]&&e.progress(e.q.length?e.nt(t,!1):t,n):e.progress(e.q.length?e.nt(t,!1):t,n);else{t=w.O(t);var r=0;h++,e.X(f,t,function(t){if(e.R){var n=!0;t=e.q.length?e.nt(t,void 0!==e.query.join):t,e.query.having&&(n=e.tt(t,e.Y.slowWhere,void 0!==e.query.join)),n&&o&&(n=i[0]<=r&&r<i[1]),n&&e.progress(t,r),r++}else e.L.push(t)},function(){h--,l()})}},l)}}},f.prototype.it=function(){var o=this;this.query.groupBy?(this.L.sort(function(t,n){return o.ot(t,n,o.ut)}).forEach(function(n,t){var r=o.ut.sort.map(function(t){return String(w.objQuery(t.path,n,void 0!==o.query.join))}).join(".");o.F[r]||(o.F[r]=[]),o.F[r].push(n)}),this.L=[],this.st?Object.keys(this.F).forEach(function(t){var i=o.q.reduce(function(t,n){return"A"===o.nSQL.functions[n.value].type&&(t[n.value]={aggr:o.nSQL.functions[n.value].aggregateStart,args:n.args}),t},{}),e=Object.keys(i)[0];o.F[t].forEach(function(r,t){Object.keys(i).forEach(function(t){var n;i[t].aggr=(n=o.nSQL.functions[t]).call.apply(n,[o.query,r,void 0!==o.query.join,i[t].aggr].concat(i[t].args))})}),o.L.push(o.q.reduce(function(t,n){var r;return t[n.as||n.value]=n.isFn&&i[n.value]?i[n.value].aggr.result:n.isFn?(r=o.nSQL.functions[n.value]).call.apply(r,[o.query,i[e].aggr.row,void 0!==o.query.join,{}].concat(n.args||[])):w.objQuery(n.value,i[e].aggr.row),t},{}))}):Object.keys(this.F).forEach(function(t){o.F[t].forEach(function(t){o.L.push(o.nt(t,void 0!==o.query.join))})})):this.L=this.L.map(function(t){return o.nt(t,void 0!==o.query.join)})},f.prototype.W=function(t,n){var e=this;if(this.query.actionArgs||(this.error("Can't upsert without records!"),this.query.state="error"),this.$=this.query.where?this.z(this.query.where):{type:p.IWhereType.none},"error"!==this.query.state){var r=Array.isArray(this.query.actionArgs)?this.query.actionArgs:[this.query.actionArgs],o=this.nSQL.tables[this.query.table];if(r=r.map(function(t){return e.nSQL.default(t,e.query.table)}),this.$.type===p.IWhereType.none)w.allAsync(r,function(n,t,r,i){n[o.pkCol]?e.nSQL.adapter.read(e.query.table,n[o.pkCol],function(t){t?e.ct(n,t,r,i):e.ft(n,r,i)},function(t){e.ft(n,r,i)}):e.ft(n,r,i)}).then(function(){t({result:r.length+" row(s) upserted"},0),n()});else{if(1<r.length)return this.query.state="error",void this.error("Cannot upsert multiple records with where condition!");var i=function(){c&&0===u&&(t({result:s+" row(s) upserted"},0),n())},u=0,s=0,c=!1;this.et(function(t,n){u++,s++,e.ct(r[0],t,function(){u--,i()},function(t){e.query.state="error",e.error(t)})},function(){c=!0,i()})}}},f.prototype.ct=function(t,n,r,i){var f=this;this.nSQL.doFilter("updateRow",{result:t,row:n,query:this.query}).then(function(t){var o=_.r({},n,t),u=f.at(f.nSQL.tables[f.query.string].indexes,o),s=f.at(f.nSQL.tables[f.query.string].indexes,n),c=f.nSQL.tables[f.query.table];w.allAsync(Object.keys(s).concat(["__pk__"]),function(i,t,n,r){if("__pk__"===i)f.nSQL.adapter.write(f.query.table,o[c.pkCol],o,function(t){o[c.pkCol]=t,n(null)},r);else{var e="_idx_"+f.query.table+"_"+i;u[i]!==s[i]?w.allAsync(["rm","add"],function(t,n,r){switch(t){case"add":f.nSQL.adapter.read(e,u[i],function(t){(t=w.O(t||{id:u[i],pks:[]})).pks.push(o[c.pkCol]),f.nSQL.adapter.write(e,u[i],t,function(){r(null)},function(){r(null)})},function(t){r(null)});break;case"rm":f.nSQL.adapter.read(e,s[i],function(t){var n=(t=w.O(t)).pks.indexOf(o[c.pkCol]);-1!==n?((t.pks||[]).splice(n,1),f.nSQL.adapter.write(e,s[i],t,function(){r(null)},function(){r(null)})):r(null)},function(t){r(null)})}}).then(n):n(null)}}).then(function(){f.nSQL.doFilter("updatedRow",{result:o,new:!1}),r(o)})}).catch(i)},f.prototype.ft=function(t,n,r){var c=this;this.nSQL.doFilter("addRow",{result:t,query:this.query}).then(function(o){var u=c.at(c.nSQL.tables[c.query.string].indexes,o),s=c.nSQL.tables[c.query.table];w.allAsync(Object.keys(u).concat(["__pk__"]),function(n,t,r,i){if("__pk__"===n)c.nSQL.adapter.write(c.query.table,o[s.pkCol],o,function(t){o[s.pkCol]=t,r(null)},i);else{var e="_idx_"+c.query.table+"_"+n;c.nSQL.adapter.read(e,u[n],function(t){(t=w.O(t||{id:u[n],pks:[]})).pks.push(o[s.pkCol]),c.nSQL.adapter.write(e,u[n],t,function(){r(null)},function(){r(null)})},function(t){r(null)})}}).then(function(){c.nSQL.doFilter("updatedRow",{result:o,new:!0}),n(o)})}).catch(r)},f.prototype.U=function(t,n){var s=this;if(this.$=this.query.where?this.z(this.query.where):{type:p.IWhereType.none},"error"!==this.query.state)if(this.$.type===p.IWhereType.none)this.query.state="error",this.error("Can't do delete query without where condition!");else{var r=0,i=0,e=!1,c=this.nSQL.tables[this.query.table],f=function(){e&&0===r&&(t({result:i+" row(s) deleted"},0),n())};this.et(function(u,t){r++,s.nSQL.doFilter("deleteRow",{result:u,query:s.query}).then(function(n){var o=s.at(c.indexes,u);w.allAsync(Object.keys(o).concat(["__del__"]),function(r,t,i){if("__del__"===r)s.nSQL.adapter.delete(s.query.table,n[c.pkCol],function(){i(null)},function(t){s.query.state="error",s.error(t)});else{var e="_idx_"+s.query.table+"_"+r;s.nSQL.adapter.read(e,o[r],function(t){var n=(t=w.O(t)).pks.indexOf(u[c.pkCol]);-1!==n?(t.pks.splice(n,1),s.nSQL.adapter.write(e,o[r],t,function(){i(null)},function(){i(null)})):i(null)},function(t){i(null)})}}).then(function(){r--,i++,f()}).catch(function(t){s.query.state="error",s.error(t)})}).catch(function(){r--,f()})},function(){e=!0,f()})}},f.prototype.at=function(r,i){return Object.keys(r).reduce(function(t,n){return t[n]=w.cast(r[n].type,w.objQuery(r[n].path,i)),t},{})},f.prototype.V=function(){this.progress({tables:Object.keys(this.nSQL.tables)},0),this.complete()},f.prototype.B=function(){return"string"!=typeof this.query.table?(this.query.state="error",void this.error("Can't call describe on that!")):this.nSQL.tables[this.query.table]?(this.progress({describe:w._(this.nSQL.tables[this.query.table].columns)},0),void this.complete()):(this.query.state="error",void this.error("Table "+this.query.table+" not found!"))},f.prototype.G=function(r,i,t,n){var o=this;new Promise(function(t,n){return o.nSQL.doFilter("registerRelation",{result:{name:r,rel:i}})}).then(function(e){return new Promise(function(t,n){var r={left:w.resolveObjPath(e.rel[0]),sync:e.rel[1],right:w.resolveObjPath(e.rel[2])};if(-1===["<=","<=>","=>"].indexOf(r.sync)||r.left.length<2||r.right.length<2)n("Invalid relation!");else{var i=Object.keys(o.nSQL.tables);-1!==i.indexOf(r.left[0])?-1!==i.indexOf(r.right[0])?(o.nSQL.relations[e.name]=r,t(o.nSQL.relations[e.name])):n("Relation error, can't find table "+r.right[0]+"!"):n("Relation error, can't find table "+r.left[0]+"!")}})}).then(t).catch(n)},f.prototype.K=function(r,t,n){var i=this;new Promise(function(t,n){return i.nSQL.doFilter("destroyRelation",{result:r})}).then(function(r){return new Promise(function(t,n){i.nSQL.relations[r]?(delete i.nSQL.relations[r],t(r)):n("Relation "+r+" not found!")})}).then(t).catch(n)},f.prototype.nt=function(r,i){var e=this;if(this.q.length){var o={};return this.q.forEach(function(t){var n;e.nSQL.functions[t.value]||(e.query.state="error",e.error("Function "+t.value+" not found!")),t.isFn?o[t.as||t.value]=(n=e.nSQL.functions[t.value]).call.apply(n,[e.query,r,i,{}].concat(t.args||[])):o[t.as||t.value]=w.objQuery(t.value,r,i)}),o}return r},f.prototype.rt=function(t,n){return this.ot(t,n,this.ht)},f.prototype.ot=function(e,o,t){return t.sort.reduce(function(t,n){var r=w.objQuery(n.path,e),i=w.objQuery(n.path,o);return t||(r===i?0:(i<r?1:-1)*("DESC"===n.dir?-1:1))},0)},f.prototype.createTable=function(e,t,n){var c=this;new Promise(function(t,r){var i=!1,n=e.name;e.lt||0!==n.indexOf("_")&&null===n.match(/\s/g)&&null===n.match(/[\(\)\]\[\.]/g)?(e.model.forEach(function(t){var n=t.key.split(":");1===n.length&&n.push("any"),n[0]&&null===n[0].match(/[\(\)\]\[\.]/g)&&0!==n[0].indexOf("_")||(i=!0,r("nSQL: Invalid Data Model at "+e.name+", "+JSON.stringify(t)+"! https://docs.nanosql.io/setup/data-models"))}),e.model=e.model.map(function(t){return _.r({},t,{name:t.key.replace(/\s+/g,"-")})}),i||t()):r("nSQL: Invalid Table Name "+e.name+"! https://docs.nanosql.io/setup/data-models")}).then(function(){return c.nSQL.doFilter("createTable",{result:e})}).then(function(s){return new Promise(function(t,r){var n=function(t){return t.map(function(t){return 0===(t.key.split(":")[1]||"any").indexOf("geo")&&(t.model=[{key:"lat:float",default:0},{key:"lon:float",default:0}]),t.model&&(t.model=n(t.model)),t})},i=function(t){return t.filter(function(t){return"*"!==t.key}).map(function(t){return{key:t.key.split(":")[0],type:t.key.split(":")[1]||"any",default:t.default||null,notNull:!(!t.props||-1===t.props.indexOf("not_null()")),model:t.model?i(t.model):void 0}})},e=!1,o=n(s.model);if(c.nSQL.tables[s.name]={model:o,columns:i(o),actions:s.actions||[],views:s.views||[],indexes:(s.indexes||[]).map(function(t){return{name:t.name.split(":")[0],type:t.name.split(":")[1]||"string",path:w.resolveObjPath(t.path)}}).reduce(function(t,n){return-1===Object.keys(c.nSQL.indexTypes).indexOf(n.type)?(e=!0,r('Index "'+n.name+'" does not have a valid type!')):-1!==n.type.indexOf("geo")?(t[n.name+"-lat"]={name:n.name+"-lat",type:"float",path:n.path.concat(["lat"])},t[n.name+"-lon"]={name:n.name+"-lon",type:"float",path:n.path.concat(["lon"])}):t[n.name]=t,t},{}),pkType:s.model.reduce(function(t,n){return n.props&&-1!==n.props.indexOf("pk()")?n.key.split(":")[1]:t},""),pkCol:s.model.reduce(function(t,n){return n.props&&-1!==n.props.indexOf("pk()")?n.key.split(":")[0]:t},""),ai:s.model.reduce(function(t,n){return!(!n.props||-1===n.props.indexOf("pk()")||-1===n.props.indexOf("ai()"))||t},!1)},""===c.nSQL.tables[s.name].pkCol&&(c.nSQL.tables[s.name].pkCol="_id_",c.nSQL.tables[s.name].pkType="uuid",c.nSQL.tables[s.name].model.unshift({key:"_id_:uuid",props:["pk()"]}),c.nSQL.tables[s.name].columns=i(c.nSQL.tables[s.name].model)),!e){var u=[s.name];Object.keys(c.nSQL.tables[s.name].indexes).forEach(function(t,n){var r=c.nSQL.tables[s.name].indexes[t],i="_idx_"+s.name+"_"+r.name;u.push(i),c.nSQL.tables[i]={model:[{key:"id:"+(r.type||"uuid"),props:["pk()"]},{key:"pks:"+c.nSQL.tables[s.name].pkType+"[]"}],columns:[{key:"id",type:r.type||"uuid"},{key:"pks",type:c.nSQL.tables[s.name].pkType+"[]"}],actions:[],views:[],indexes:{},pkType:r.type,pkCol:"id",ai:!1}}),w.allAsync(u,function(t,n,r,i){c.nSQL.adapter.createTable(t,c.nSQL.tables[t],r,i)}).then(t).catch(r)}}).then(t).catch(n)})},f.prototype.alterTable=function(t,r,i){var o=this;this.nSQL.doFilter("alterTable",{result:t}).then(function(e){var n=[e.name];Object.keys(o.nSQL.tables[t.name].indexes).forEach(function(t){n.push("_idx_"+e.name+"_"+t)}),w.allAsync(n,function(t,n,r,i){o.nSQL.adapter.disconnectTable(e.name,r,i)}).then(function(){o.createTable(e,r,i)}).catch(i)}).catch(i)},f.prototype.dropTable=function(t,n,i){var e=this;this.nSQL.doFilter("destroyTable",{result:[t]}).then(function(t){var r=t;t.forEach(function(n){Object.keys(e.nSQL.tables[n].indexes).forEach(function(t){r.push("_idx_"+n+"_"+t)})}),w.allAsync(r,function(t,n,r,i){e.nSQL.adapter.dropTable(t,function(){delete e.nSQL.tables[t],r(t)},i)}).then(n).catch(i)})},f.prototype.vt=function(t){this.query.state="error",this.error(t)},f.prototype.dt=function(t,i,n,r,e,o,u){var s=this;switch(n.comp){case"=":t?(o(n.value,0),u()):this.nSQL.adapter.read(i,n.value,function(t){o(t,0),u()},this.vt);break;case"BETWEEN":(t?this.nSQL.adapter.readMultiPK:this.nSQL.adapter.readMulti)(i,"range",n.value[0],n.value[1],r,function(t,n){o(t,n)},u,this.vt);break;case"IN":var c=e?r?n.value.sort(function(t,n){return t<n?1:-1}):n.value.sort(function(t,n){return n<t?1:-1}):n.value;t?(c.forEach(function(t,n){o(t,n)}),u()):w.chainAsync(c,function(t,n,r){s.nSQL.adapter.read(i,t,function(t){o(t,n),r()},s.vt)}).then(u)}},f.prototype.pt=function(r,t){var e=this;if(this.$.fastWhere)if(1===this.$.fastWhere.length){var n=this.$.fastWhere[0],i=this.D&&"DESC"===this.ht.sort[0].dir;n.index&&n.fnName?this.nSQL.functions[n.fnName].queryIndex(this.nSQL,this,n,!1,r,t):n.col===this.nSQL.tables[this.query.table].pkCol?this.dt(!1,this.query.table,n,i,this.D,r,t):this.yt(!1,n,r,t)}else{var o={},u=0;w.chainAsync(this.$.fastWhere,function(t,n,r){if(n%2!=1){u=n;var i=function(t){o[t]=n};t.index&&t.fnName?e.nSQL.functions[t.fnName].queryIndex(e.nSQL,e,t,!0,i,r):t.col===e.nSQL.tables[e.query.table].pkCol?e.dt(!0,e.query.table,t,!1,!1,i,r):e.yt(!0,t,i,r)}else r()}).then(function(){var n=[];Object.keys(o).forEach(function(t){o[t]===u&&n.push(t)}),e.dt(!1,e.query.table,{index:"_pk_",col:e.nSQL.tables[e.query.table].pkCol,comp:"IN",value:n},!1,!1,function(t,n){r(t,n)},t)})}},f.prototype.yt=function(n,t,r,i){var e=this;if(this.nSQL.tables[this.query.table].indexes[t.index]){var o=!1,u=!1,s=0,c=0,f=function(){h.length?e.dt(!1,e.query.table,{index:"_pk_",col:e.nSQL.tables[e.query.table].pkCol,comp:"IN",value:h.shift().pks},!1,!1,function(t){r(t,s),s++},function(){s%100==0?w.setFast(f):f()}):o?i():w.setFast(function(){1e3<++c?setTimeout(f,Math.min(c/10,1e3)):f()})},a="_idx_"+this.query.table+"_"+t.index,h=[],l=[],v=this.J&&"DESC"===this.ht.sort[0].dir;this.dt(!1,a,t,v,this.J,function(t){n?l=l.concat(t.pks||[]):(h.push(t),u||(u=!0,f()))},function(){if(o=!0,n){for(var t=0;t<l.length;)r(l[t],t),t++;i()}})}else this.vt("Index not found!")},f.prototype.et=function(r,i){var e=this,t=function(t){for(var n=0;n<t.length;)e.$.type!==p.IWhereType.none?e.$.whereFn?e.$.whereFn(t[n],n)&&r(t[n],n):e.tt(t[n],e.$.slowWhere,void 0!==e.query.join)&&r(t[n],n):r(t[n],n),n++;i()};if("string"==typeof this.query.table)switch(this.$.type){case p.IWhereType.fast:this.pt(r,i);break;case p.IWhereType.medium:this.pt(function(t,n){e.tt(t,e.$.slowWhere,!1)&&r(t,n)},i);break;case p.IWhereType.slow:case p.IWhereType.none:case p.IWhereType.fn:var n=this.D&&"DESC"===this.ht.sort[0].dir;this.nSQL.adapter.readMulti(this.query.table,"all",void 0,void 0,n,function(t,n){e.$.type===p.IWhereType.slow?e.tt(t,e.$.slowWhere,!1)&&r(t,n):e.$.type===p.IWhereType.fn&&e.$.whereFn?e.$.whereFn(t,n)&&r(t,n):r(t,n)},i,function(t){e.query.state="error",e.error(t)})}else"function"==typeof this.query.table?this.query.table().then(t).catch(function(t){e.error(t)}):Array.isArray(this.query.table)&&t(this.query.table)},f.prototype.H=function(t,n,r){},f.prototype.tt=function(t,n,r){if(1<n.length){for(var i=!0;0<n.length;){var e=n[0];i=Array.isArray(e[0])?this.tt(t,e,r||!1):this.bt(e,t,r||!1)}return i}return this.bt(n[0],t,r||!1)},f.prototype.wt=function(t,n){if(!f.likeCache[n]){var r="";f.likeCache[n]=new RegExp(n.split("").map(function(t){return"\\"===r?r=t:"%"===(r=t)?".*":"_"===t?".":t}).join(""),"gmi")}return"string"!=typeof t?"number"==typeof t?null!==String(t).match(f.likeCache[n]):null!==JSON.stringify(t).match(f.likeCache[n]):null!==t.match(f.likeCache[n])},f.prototype.gt=function(t,n,r){var i;return t.fnName?(i=this.nSQL.functions[t.fnName]).call.apply(i,[this.query,n,r,this.nSQL.functions[t.fnName].aggregateStart||{result:void 0}].concat(t.fnArgs||[])):w.objQuery(t.col,n,r)},f.prototype.bt=function(t,n,r){var i=this.gt(t,n,r),e=t.value,o=t.comp;if("NULL"===e||"NOT NULL"===e){var u=-1!==[void 0,null,""].indexOf(i),s="="===o||"LIKE"===o;switch(e){case"NULL":return s?u:!u;case"NOT NULL":return s?!u:u}}if(-1!==["IN","NOT IN","BETWEEN","INTERSECT","INTERSECT ALL","NOT INTERSECT"].indexOf(o)&&!Array.isArray(e))return this.query.state="error",this.query.error('WHERE "'+o+'" comparison requires an array value!'),!1;switch(o){case"=":return w.compareObjects(e,i);case"!=":return!w.compareObjects(e,i);case">":return e<i;case"<":return i<e;case"<=":return i<=e;case">=":return e<=i;case"IN":return-1!==e.indexOf(i);case"NOT IN":return-1===e.indexOf(i);case"REGEXP":case"REGEX":return null!==(i||"").match(e);case"LIKE":return this.wt(i||"",e);case"NOT LIKE":return!this.wt(i||"",e);case"BETWEEN":return e[0]<=i&&e[1]>i;case"INCLUDES":return-1!==(i||[]).indexOf(e);case"NOT INCLUDES":return-1===(i||[]).indexOf(e);case"INTERSECT":return 0<(i||[]).filter(function(t){return-1<e.indexOf(t)}).length;case"INTERSECT ALL":return(i||[]).filter(function(t){return-1<e.indexOf(t)}).length===e.length;case"NOT INTERSECT":return 0===(i||[]).filter(function(t){return-1<e.indexOf(t)}).length;default:return!1}},f.prototype.mt=function(t,n){var r=t&&t.length?w.hash(JSON.stringify(t)):"";if(!r)return{sort:[],index:""};if(f._t[r])return f._t[r];var i=t.map(function(t){return t.split(" ").map(function(t){return t.trim()})}).reduce(function(t,n){return t.push({path:w.resolveObjPath(n[0]),dir:(n[1]||"asc").toUpperCase()}),t},[]),e="";if(n&&1===i.length){var o="string"==typeof this.query.table?this.nSQL.tables[this.query.table].pkCol:"";if(i[0].path[0].length&&i[0].path[0]===o)e="_pk_";else for(var u=Object.keys(this.nSQL.tables[this.query.table].indexes),s=u.length;s--&&!e;)w.compareObjects(this.nSQL.tables[this.query.table].indexes[u[s]],i[0].path)&&(e=this.nSQL.tables[this.query.table].indexes[u[s]].name)}return f._t[r]={sort:i,index:e},f._t[r]},f.prototype.Z=function(){var e=this,t=this.query.actionArgs&&this.query.actionArgs.length?JSON.stringify(this.query.actionArgs):"";this.ht=this.mt(this.query.orderBy||[],"string"==typeof this.query.table),this.ut=this.mt(this.query.groupBy||[],!1),t?f.St[t]?(this.st=f.St[t].hasAggrFn,this.q=f.St[t].args):((this.query.actionArgs||[]).forEach(function(t){var n=t.split(/\s+as\s+/i).map(function(t){return t.trim()});if(-1!==n[0].indexOf("(")){var r=n[0].split("(")[1].replace(")","").split(",").map(function(t){return t.trim()}),i=n[0].split("(")[0].trim().toUpperCase();e.q.push({isFn:!0,value:i,as:n[1],args:r}),e.nSQL.functions[i]?"A"===e.nSQL.functions[i].type&&(e.st=!0):(e.query.state="error",e.error('Function "'+i+'" not found!'))}else e.q.push({isFn:!1,value:n[0],as:n[1]})}),"error"!==this.query.state&&(f.St[t]={hasAggrFn:this.st,args:this.q})):this.q=[];var n=!1;this.$.type===p.IWhereType.none?(n="_pk_"===this.ht.index)&&(this.D=!0):(n=!!(this.ht.index.length&&this.$.fastWhere&&w.compareObjects(this.$.fastWhere[0].col,this.ht.sort[0].path)))&&(this.J=!0),(this.ht.sort.length&&!n||this.ut.sort.length||this.st)&&(this.R=!1)},f.prototype.z=function(t,n){var h=this,r=t||[],i=JSON.stringify(r)+(n?"0":"1");if(f.Ot[i])return f.Ot[i];if("function"==typeof r)return{type:p.IWhereType.fn,whereFn:r};if(!r.length)return f.Ot[i]={type:p.IWhereType.none},f.Ot[i];for(var l="string"==typeof this.query.table?Object.keys(this.nSQL.tables[this.query.table].indexes).map(function(t){return h.nSQL.tables[h.query.table].indexes[t]}):[],v="string"==typeof this.query.table?this.nSQL.tables[this.query.table].pkCol:"",d=function(t,f){var a=!n&&0===f;return t.reduce(function(n,r,t){if(t%2==1)return"string"!=typeof r?(h.query.state="error",h.error("Malformed WHERE statement!")):n.push(r),n;if(!Array.isArray(r))return h.query.state="error",h.error("Malformed WHERE statement!"),n;if(Array.isArray(r[0]))n.push(d(r,f+1));else{if(-1===r[0].indexOf("(")){var i=!1;if(["=","BETWEEN","IN"].indexOf(r[1])&&a)if(r[0]===v)i=!0,n.push({index:"_pk_",col:r[0],comp:r[1],value:r[2]});else{var e=w.resolveObjPath(r[0]);l.forEach(function(t){w.compareObjects(t.path,e)&&(i=!0,n.push({index:t.name,col:r[0],comp:r[1],value:r[2]}))})}return i||n.push({col:r[0],comp:r[1],value:r[2]}),n}var o=r[0].split("(")[1].replace(")","").split(",").map(function(t){return t.trim()}).filter(function(t){return t}),u=r[0].split("(")[0].trim().toUpperCase(),s=!1;if(!h.nSQL.functions[u])return h.query.state="error",h.error('Function "'+u+'" not found!'),n;if(a&&h.nSQL.functions[u]&&h.nSQL.functions[u].whereIndex){var c=h.nSQL.functions[u].whereIndex(h.nSQL,h.query,o,r);c&&(s=!0,n.push(c))}s||n.push({fnName:u,fnArgs:o,comp:r[1],value:r[2]})}},[])},e=d("string"==typeof r[0]?[r]:r,0),o=!0,u=0,s=-1;u<e.length&&o;)u%2==1?"AND"!==e[u]&&(o=!1,s=u):!Array.isArray(e[u])&&e[u].index||(o=!1,s=u),u++;if(s%2==0&&s++,-1===s||"AND"!==e[s]&&e[s])f.Ot[i]={type:p.IWhereType.slow,slowWhere:e};else{var c=e.slice(s+1);f.Ot[i]={type:c.length?p.IWhereType.medium:p.IWhereType.fast,slowWhere:c,fastWhere:e.slice(0,s)}}return f.Ot[i]},f.likeCache={},f.St={},f}();n.kt=r});n(S);S.kt;var O=r(function(t,n){Object.defineProperty(n,"t",{value:!0});var r=function(){function t(t){this.useLS=t,this.plugin={name:"Sync Storage Adapter",version:2,dependencies:{core:[2]}}}return t.prototype.connect=function(t,n,r){},t.prototype.createTable=function(t,n,r,i){},t.prototype.disconnectTable=function(t,n,r){},t.prototype.dropTable=function(t,n,r){},t.prototype.disconnect=function(t,n){},t.prototype.write=function(t,n,r,i,e){},t.prototype.read=function(t,n,r,i){},t.prototype.delete=function(t,n,r,i){},t.prototype.readMulti=function(t,n,r,i,e,o,u,s){},t.prototype.readMultiPK=function(t,n,r,i,e,o,u,s){},t.prototype.getIndex=function(t,n,r){},t.prototype.getNumberOfRecords=function(t,n,r){},t}();n.SyncStorage=r});n(O);O.SyncStorage;var k=r(function(t,n){Object.defineProperty(n,"t",{value:!0});var r=function(){function t(){this.plugin={name:"WebSQL Adapter",version:2,dependencies:{core:[2]}}}return t.prototype.connect=function(t,n,r){},t.prototype.createTable=function(t,n,r,i){},t.prototype.disconnectTable=function(t,n,r){},t.prototype.dropTable=function(t,n,r){},t.prototype.disconnect=function(t,n){},t.prototype.write=function(t,n,r,i,e){},t.prototype.read=function(t,n,r,i){},t.prototype.delete=function(t,n,r,i){},t.prototype.readMulti=function(t,n,r,i,e,o,u,s){},t.prototype.readMultiPK=function(t,n,r,i,e,o,u,s){},t.prototype.getIndex=function(t,n,r){},t.prototype.getNumberOfRecords=function(t,n,r){},t}();n.WebSQL=r});n(k);k.WebSQL;var N=r(function(t,n){Object.defineProperty(n,"t",{value:!0});var r=function(){function t(){this.plugin={name:"IndexedDB Adapter",version:2,dependencies:{core:[2]}}}return t.prototype.connect=function(t,n,r){},t.prototype.createTable=function(t,n,r,i){},t.prototype.disconnectTable=function(t,n,r){},t.prototype.dropTable=function(t,n,r){},t.prototype.disconnect=function(t,n){},t.prototype.write=function(t,n,r,i,e){},t.prototype.read=function(t,n,r,i){},t.prototype.delete=function(t,n,r,i){},t.prototype.readMulti=function(t,n,r,i,e,o,u,s){},t.prototype.readMultiPK=function(t,n,r,i,e,o,u,s){},t.prototype.getIndex=function(t,n,r){},t.prototype.getNumberOfRecords=function(t,n,r){},t}();n.IndexedDB=r});n(N);N.IndexedDB;var j=r(function(t,n){Object.defineProperty(n,"t",{value:!0});var r=function(){function t(t,n,r,i,e){this.Nt=t,this.jt=e||"",this.N="string"==typeof r?_.r({},w.buildQuery(n,r),{comments:[],state:"pending",action:r,actionArgs:i,result:[]}):_.r({},w.buildQuery(n,""),r(t),{state:"pending"})}return t.prototype.where=function(t){return this.N.where=t,this},t.prototype.orderBy=function(t){return this.N.orderBy=t,this},t.prototype.groupBy=function(t){return this.N.groupBy=t,this},t.prototype.having=function(t){return this.N.having=t,this},t.prototype.join=function(t){var n=this,r="Join commands requires table and type arguments!";return Array.isArray(t)?t.forEach(function(t){t.with.table&&t.type||(n.Et=r)}):t.with.table&&t.type||(this.Et=r),this.N.join=t,this},t.prototype.limit=function(t){return this.N.limit=t,this},t.prototype.comment=function(t){return this.N.comments.push(t),this},t.prototype.extend=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];return this.N.extend.push({scope:t,args:n}),this},t.prototype.union=function(t,n){return this.N.union={queries:t,type:n?"all":"distinct"},this},t.prototype.offset=function(t){return this.N.offset=t,this},t.prototype.emit=function(){return this.N},t.prototype.ttl=function(t,n){if(void 0===t&&(t=60),"upsert"!==this.N.action)throw new Error("nSQL: Can only do ttl on upsert queries!");return this.N.ttl=t,this.N.ttlCols=n||[],this},t.prototype.toCSV=function(n){var r=this;return r.exec().then(function(t){return Promise.resolve(r.Nt.JSONtoCSV(t,n))})},t.prototype.stream=function(t,n,r){this.Nt.triggerQuery(this.N,t,n,r)},t.prototype.cache=function(){var i=this;return new Promise(function(n,t){var r=w.uuid();i.exec().then(function(t){i.Nt.At[r]=t,n({id:r,total:t.length})}).catch(t)})},t.prototype.orm=function(t){return this.N.orm=t,this},t.prototype.from=function(t,n){return this.N.table=t,this.N.tableAS=n||"",this},t.prototype.exec=function(){var i=this;return new Promise(function(t,n){var r=[];i.stream(function(t){r.push(t)},function(){t(r)},n)})},t}();n.Tt=r});n(j);j.Tt;var E=r(function(t,n){var i;Object.defineProperty(n,"t",{value:!0}),void 0!==h&&(i=h.Mt);var u=new m({concurrency:1}),r=function(){function t(){this.version=2,this.earthRadius=6371,this.state={activeAV:"",hasAnyEvents:!1,peers:[],pid:w.uuid(),id:w.uuid(),peerEvents:[],focused:!0,peerMode:!1,connected:!1,ready:!1,selectedTable:""},this.tables={},this.plugins=[],this.At={},this.indexTypes={string:function(t){return"object"==typeof t?JSON.stringify(t):String(t)},geo:function(t){},float:function(t){var n=parseFloat(t);return isNaN(n)?0:n},int:function(t){var n=parseInt(t);return isNaN(n)?0:n},number:function(t){var n=parseFloat(t);return isNaN(n)?0:n}},this.Pt={Core:new o.ReallySmallEvents},this.xt=this.xt.bind(this),a.attachDefaultFns(this)}return t.prototype.doFilter=function(e,o){var u=this;return this.filters[e]?new Promise(function(t,i){w.chainAsync(u.filters[e],function(t,n,r){u.filters[e][n](o).then(function(t){(o=t).abort?i(t.abort):r()})}).then(function(){t(o.result)})}):Promise.resolve(o.result)},t.prototype.getCache=function(t,n){if(!this.At[t])throw new Error('Cache "'+t+'" not found!');return n?this.At[t].slice(n.offset,n.offset+n.limit):this.At[t].slice()},t.prototype.clearCache=function(t){var n=void 0!==this.At[t];return delete this.At[t],n},t.prototype.clearTTL=function(t){var r=this,i=this.state.selectedTable+"."+t;return new Promise(function(t,n){r.triggerQuery(_.r({},w.buildQuery("_ttl","delete"),{where:["key","=",i]}),w.noop,t,n)})},t.prototype.expires=function(e){var o=this;return new Promise(function(t,n){var r=o.state.selectedTable+"."+e,i=[];o.triggerQuery(_.r({},w.buildQuery("_ttl","select"),{where:["key","=",r]}),function(t){i.push(t)},function(){i.length?t({time:(i[0].date-Date.now())/1e3,cols:i[0].cols}):t({time:-1,cols:[]})},n)})},t.prototype.xt=function(){var c=this;if(!this.config.disableTTL){this.It&&clearTimeout(this.It);var t=0,f=0,r=function(){var n=[];c.triggerQuery(_.r({},w.buildQuery("_ttl","select"),{limit:20,offset:20*t}),function(t){n.push(t)},function(){n.length?w.chainAsync(n,function(t,n,r){if(t.date<Date.now()){var i=function(){c.triggerQuery(_.r({},w.buildQuery("_ttl","delete"),{where:["key","=",t.key]}),w.noop,r,w.throwErr)},e=t.key.split("."),o=e[0],u=-1===["float","int","number"].indexOf(c.tables[o].pkType)?e[1]:parseFloat(e[1]);if(t.cols.length){var s={};t.cols.forEach(function(t){s[t]=null}),c.triggerQuery(_.r({},w.buildQuery(o,"upsert"),{actionArgs:s,where:[c.tables[o].pkCol,"=",u]}),w.noop,i,w.throwErr)}else c.triggerQuery(_.r({},w.buildQuery(o,"delete"),{where:[c.tables[o].pkCol,"=",u]}),w.noop,i,w.throwErr)}else f=Math.max(f,t.date),r()}).then(function(){t++,r()}):f&&(c.It=setTimeout(c.xt,f-Date.now()))},w.throwErr)};r()}},t.prototype.selectTable=function(t){return t&&(this.state.selectedTable=t),this},t.prototype.getPeers=function(){return JSON.parse(localStorage.getItem("nsql-peers-"+this.state.id)||"[]")},t.prototype.Ct=function(){return"undefined"==typeof window?"ROCKS":w.isSafari?"WSQL":"undefined"!=typeof indexedDB?"IDB":"undefined"!=typeof window&&void 0!==window.openDatabase?"WSQL":"LS"},t.prototype.Lt=function(f){var i=this;return new Promise(function(t,u){var r={};(f.plugins||[]).forEach(function(t){(t.filters||[]).forEach(function(t){r[t.name]||(r[t.name]=[]);for(var n=t.priority;r[t.name][n];)n++;r[t.name][n]=t.callback})}),Object.keys(r).forEach(function(n){i.filters[n]=[],r[n].forEach(function(t){t&&i.filters[n].unshift(t)})});var s=function(t,n){return!n||!n.length||(1===n.length?t>=n[0]:t>=n[0]&&t<n[1])},c=!1;(f.plugins||[]).forEach(function(e){if(e.dependencies){var o=e.dependencies||{};Object.keys(e.dependencies).forEach(function(r,t,n){if("core"===r)s(2,o[r])||(c=!0,u('Plugin "'+e.name+'" requires a different core version of nano-sql!'));else{var i=(f.plugins||[]).reduce(function(t,n){return n.name===r?n:t});i||(c=!0,u('Plugin "'+e.name+'" requires plugin "'+r+"\" but it isn't installed!")),s(i.version,o[r])||(c=!0,u('Plugin "'+e.name+'" requires a different version of "'+r+'"!'))}})}}),c||t()})},t.prototype.connect=function(r){var o=this;return new Promise(function(t,n){return o.Lt(r)}).then(function(){return o.doFilter("config",{result:r})}).then(function(t){return o.state.id=r.id||"nSQL_DB",o.config=t,"undefined"!=typeof window&&t&&t.peer&&(o.state.peerMode=!0),o.doFilter("willConnect",{result:{}})}).then(function(){return new Promise(function(t,n){var r=void 0!==o.config.mode?o.config.mode:"TEMP";if("string"==typeof r)switch("PERM"===r&&(r=o.Ct()),r){case"TEMP":o.adapter=new O.SyncStorage(!1);break;case"LS":o.adapter=new O.SyncStorage(!0);break;case"WSQL":o.adapter=new k.WebSQL;break;case"IDB":o.adapter=new N.IndexedDB;break;case"ROCKS":case"LVL":o.adapter=new i;break;default:n("Cannot find mode "+r+"!")}else o.adapter=r;o.adapter.plugin&&(o.config.plugins||[]).push(o.adapter.plugin),o.Lt(o.config).then(function(){(o.adapter.nSQL=o).adapter.connect(o.state.id,t,n)}).catch(n)})}).then(function(){o.triggerEvent({target:"Core",targetId:o.state.id,events:["connect"],time:Date.now()}),o.state.connected=!0;var t=["_util","_ttl"].concat((o.config.tables||[]).map(function(t){return t.name}));return w.allAsync(t,function(n,t,r,i){switch(n){case"_util":o.triggerQuery(_.r({},w.buildQuery("create table",""),{model:{name:"_util",model:[{key:"key:string",props:["pk()"]},{key:"value:any"}],lt:!0}}),w.noop,r,i);break;case"_ttl":o.triggerQuery(_.r({},w.buildQuery("create table",""),{model:{name:"_ttl",model:[{key:"key:string",props:["pk()"]},{key:"table:string"},{key:"cols:string[]"},{key:"date:number"}],lt:!0}}),w.noop,r,i);break;default:var e=(o.config.tables||[]).filter(function(t){return t.name===n})[0];if(!e)return void i("Table not found!");o.triggerQuery(_.r({},w.buildQuery("create table",""),{model:e}),w.noop,r,i)}})}).then(function(){return new Promise(function(t,n){var r;o.triggerQuery(_.r({},w.buildQuery("_util","select"),{where:["key","=","version"]}),function(t){t&&(r=t.value)},function(){!r||r<2?o.triggerQuery(_.r({},w.buildQuery("_util","upsert"),{actionArgs:{key:"version",value:2}}),w.noop,t,n):t()},n)})}).then(function(){return new Promise(function(t,i){var e;o.config.version?o.triggerQuery(_.r({},w.buildQuery("_util","select"),{where:["key","=","db-version"]}),function(t){t&&(e=t.value)},function(){var n=function(t,n,r){o.triggerQuery(_.r({},w.buildQuery("_util","upsert"),{actionArgs:{key:"db-version",value:t}}),w.noop,n,r)};if(e){var r=function(){if(e===o.config.version)n(o.config.version||0,t,i);else{if(!o.config.onVersionUpdate)return void n(o.config.version||0,t,i);o.config.onVersionUpdate(e).then(function(t){n(e=t,function(){w.setFast(r)},i)}).catch(i)}};r()}else n(o.config.version||0,t,i)},i):t()})}).then(function(){return new Promise(function(t,n){o.triggerEvent({target:"Core",targetId:o.state.id,events:["ready"],time:Date.now()}),o.state.ready=!0,o.config.disableTTL||o.xt(),o.config.peer&&o.Rt(),t()})})},t.prototype.Rt=function(){var s=this,c=0;this.state.pid=w.uuid(),this.state.peers=this.getPeers(),this.state.peers.unshift(this.state.pid),localStorage.setItem("nsql-peers-"+this.state.id,JSON.stringify(this.state.peers)),window.addEventListener("storage",function(t){if(t.key==="nsql-peers-"+s.state.id&&(s.state.peers=s.getPeers()),t.key&&0===t.key.indexOf(s.state.pid+".")){localStorage.removeItem(t.key);var n=JSON.parse(t.newValue||"{}");s.state.peerEvents.push(n.query.queryID||""),s.triggerEvent(_.r({},n,{types:["peer-change"]})),w.setFast(function(){s.triggerEvent(n)})}if(50<++c&&s.state.peers[0]===s.state.pid){c=0;for(var r=localStorage.length,i={};r--;){var e=localStorage.key(r),o=e?e.match(/\w{8}-\w{4}-\w{4}-\w{4}-\w{8}/gim):null;if(e&&o){var u=(o||[""])[0];i[u]||(i[u]=[]),i[u].push(e)}}Object.keys(i).forEach(function(n){10<i[n].length&&(s.state.peers=s.state.peers.filter(function(t){return t!==n}),i[n].forEach(function(t){localStorage.removeItem(t)}),localStorage.setItem("nsql-peers-"+s.state.id,JSON.stringify(s.state.peers)))})}}),window.onblur=function(){s.state.focused=!1},window.onfocus=function(){s.state.peers=s.state.peers.filter(function(t){return t!==s.state.pid}),s.state.peers.unshift(s.state.pid),localStorage.setItem("nsql-peers-"+s.state.id,JSON.stringify(s.state.peers)),s.state.focused=!0},n.nSQL("*").on("change",function(n){var t=s.state.peerEvents.indexOf(n.query.queryID||"");-1===t?s.state.peers.filter(function(t){return t!==s.state.pid}).forEach(function(t){localStorage.setItem(t+"."+n.query.queryID,JSON.stringify(n))}):s.state.peerEvents.splice(t,1)}),window.addEventListener("beforeunload",function(){return s.state.peers=s.state.peers.filter(function(t){return t!==s.state.pid}),localStorage.setItem("nsql-peers-"+s.state.id,JSON.stringify(s.state.peers)),!1})},t.prototype.on=function(t,n){var r="string"!=typeof this.state.selectedTable?"":this.state.selectedTable;if(-1!==r.indexOf("Plugin:"))return this.Pt[r]||(this.Pt[r]=new o.ReallySmallEvents),this.Pt[r].on(t,n),this.qt();switch(t){case"connect":case"ready":case"disconnect":case"peer-change":case"slow-query":this.Pt.Core.on(t,n);break;default:var i="Table:"+w.resolveObjPath(r).join(".");this.Pt[i]||(this.Pt[i]=new o.ReallySmallEvents),this.Pt[i].on(t,n)}return this.qt()},t.prototype.off=function(t,n){var r="string"!=typeof this.state.selectedTable?"":this.state.selectedTable;if(-1!==r.indexOf("Plugin:"))return this.Pt[r].off(t,n),this.qt();switch(t){case"connect":case"ready":case"disconnect":case"peer-change":case"slow-query":this.Pt.Core.off(t,n);break;default:var i="Table:"+w.resolveObjPath(r).join(".");this.Pt[i].off(t,n)}return this.qt()},t.prototype.qt=function(){var i=this;return this.state.hasAnyEvents=Object.keys(this.Pt).reduce(function(t,r){return!0===t||(0<Object.keys(i.Pt[r].eventListeners).reduce(function(t,n){return i.Pt[r].eventListeners[n].length+t},0)||t)},!1),this},t.prototype.getView=function(t,n){return void 0===n&&(n={}),"string"!=typeof this.state.selectedTable?Promise.reject():this.Dt("View",this.state.selectedTable,t,n)},t.prototype.doAction=function(t,n){return"string"!=typeof this.state.selectedTable?Promise.reject():this.Dt("Action",this.state.selectedTable,t,n)},t.prototype.Dt=function(t,n,r,i){var e=this;return this.doFilter(t,{result:{AVType:t,table:n,AVName:r,AVargs:i}}).then(function(r){var t="Action"===r.AVType?"actions":"views",n=e.tables[r.table][t].reduce(function(t,n){return n.name===r.AVName?n:t},null);return n?n.call(n.args?w.cleanArgs(n.args,r.AVargs):{},e):new Promise(function(t,n){return n(r.AVType+' "'+r.AVName+'" Not Found!')})})},t.prototype.query=function(t,n){var r=this.state.activeAV;return this.state.activeAV="",new j.Tt(this,this.state.selectedTable,t,n,r)},t.prototype.triggerQuery=function(t,r,i,e){var o=this;this.state.connected||"string"!=typeof t.table?this.doFilter("query",{result:t}).then(function(t){o.config.queue&&!t.skipQueue?u.push(function(n){new S.kt(o,t,r,function(){n(),i()},function(t){n(),e(t)})}):new S.kt(o,t,r,i,e)}).catch(e):e("nSQL: Can't do a query before the database is connected!")},t.prototype.triggerEvent=function(n){var r=this;return this.doFilter("event",{result:n}).then(function(t){r.state.hasAnyEvents&&r.Pt[n.target]&&w.setFast(function(){n.events.forEach(function(t){r.Pt[n.target].trigger(t,n)})})}).catch(function(t){console.error("Event suppressed",t)}),this},t.prototype.default=function(t,n){if(t=t||{},!n&&"string"!=typeof this.state.selectedTable)throw new Error("Must select table to generate defualts!");if(n=n||this.state.selectedTable,!this.tables[n])throw new Error('nSQL: Table "'+n+'" not found for generating default object!');var s="",c=function(n,r,i){var e={};if(i&&i.length&&-1!==i.indexOf("[]"))return Array.isArray(r)?r.map(function(t){return c(n,t,i.slice(0,i.lastIndexOf("[]")))}):[];var o=!1;if(n.forEach(function(n){if("*"!==n.key){if(n.model)if(-1!==n.type.indexOf("[]")){var t=void 0!==r?r[n.key]:[];Array.isArray(t)?e[n.key]=t.map(function(t){return c(n.model,t,n.type.slice(0,n.type.lastIndexOf("[]")))}):e[n.key]=[]}else e[n.key]=c(n.model,void 0!==r?r[n.key]:void 0);else e[n.key]=void 0!==r[n.key]?w.cast(n.type,e[n.key]):n.default;n.notNull&&null===e[n.key]&&(s="Data error, "+n.key+" cannot be null!")}else o=!0}),s.length)return new Error(s);if(o&&r){var u=n.map(function(t){return t.key});Object.keys(r).filter(function(t){return-1===u.indexOf(t)}).forEach(function(t){e[t]=r[t]})}return e};return c(this.tables[n].columns,t)},t.prototype.rawDump=function(n,e){var o=this,t=Object.keys(this.tables).filter(function(t){return!n.length||-1!==n.indexOf(t)});return w.chainAsync(t,function(n,t,r,i){o.adapter.readMulti(n,"all",void 0,void 0,!1,function(t){e(n,t)},r,i||w.noop)})},t.prototype.rawImport=function(i,u){var s=this,c=0,f=Object.keys(i).reduce(function(t,n){return t+=i[n].length},0),n=Object.keys(this.tables),t=Object.keys(i).filter(function(t){return-1!==n.indexOf(t)});return w.chainAsync(t,function(e,t,n,r){var o=s.tables[e].pkCol;w.chainAsync(i[e],function(t,n,r,i){t[o]||!i?s.adapter.write(e,t[o],t,function(t){r(),c++,u&&u(Math.round(c/f*1e4)/100)},i||w.noop):i("No primary key found, can't import: "+JSON.stringify(t))}).then(n).catch(r)})},t.prototype.disconnect=function(){var r=this;return this.doFilter("disconnect",{}).then(function(){return new Promise(function(t,n){return r.adapter.disconnect(t,n)})})},t.prototype.observable=function(t,n){return new f.Observer(this,t,n||[])},t.prototype.extend=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];return this.doFilter("extend",{scope:t,args:n,result:null})},t.prototype.loadJS=function(t,n){return"string"!=typeof this.state.selectedTable?Promise.reject("nSQL: Can't load JS into temporary table!"):Promise.resolve([])},t.prototype.JSONtoCSV=function(t,n,r){var i=[];if(!t.length)return"";var e=[];return e=r||(t.forEach(function(t){e=Object.keys(t).concat(e)}),e.filter(function(t,n,r){return r.indexOf(t)===n})),n&&i.push(e.join(",")),t.forEach(function(n){i.push(e.map(function(t){return null===n[t]||void 0===n[t]?"":"string"==typeof n[t]?'"'+n[t].replace(/\"/g,'""')+'"':"boolean"==typeof n[t]?!0===n[t]?"true":"false":"object"==typeof n[t]?'"'+JSON.stringify(n[t]).replace(/\"/g,'""')+'"':n[t]}).join(","))}),i.join("\r\n")},t.prototype.csvToArray=function(t){for(var n,r="",i=[""],e=[i],o=0,u=0,s=!0,c=0,f=t;c<f.length;c++)'"'===(n=f[c])?(s&&n===r&&(i[o]+=n),s=!s):","===n&&s?n=i[++o]="":"\n"===n&&s?("\r"===r&&(i[o]=i[o].slice(0,-1)),i=e[++u]=[n=""],o=0):i[o]+=n,r=n;return e[0]},t.prototype.CSVtoJSON=function(t,o){var u=this,s=[];return t.split(/\r?\n|\r|\t/gm).map(function(t,n){if(0!==n){var r=u.csvToArray(t);if(r){r=r.map(function(t){return t.trim()});for(var i=s.length,e={};i--;)if(r[i])if("true"===r[i]||"false"===r[i])e[s[i]]="true"===r[i];else if(0===r[i].indexOf("{")||0===r[i].indexOf("["))try{e[s[i]]=JSON.parse(r[i])}catch(t){e[s[i]]=r[i]}else 0===r[i].indexOf('"')?e[s[i]]=r[i].slice(1,r[i].length-1).replace(/\"\"/gim,'"'):e[s[i]]=r[i];return o?o(e):e}}else s=t.split(",")}).filter(function(t){return t})},t.prototype.loadCSV=function(t,n,e){var o=this,u=this.state.selectedTable;if("string"!=typeof u)return Promise.reject("nSQL: Can't load CSV into temporary table!");var s=this.CSVtoJSON(t,n);return w.chainAsync(s,function(t,n,r,i){e&&e(Math.round((n+1)/s.length*1e4)/100),o.triggerQuery(_.r({},w.buildQuery(u,"upsert"),{actionArgs:t}),w.noop,r,i||w.noop)})},t}(),e=new(n.NanoSQL=r);n.nSQL=function(t){return e.selectTable(t)},"undefined"!=typeof window&&(window["nano-sql"]={nSQL:n.nSQL,NanoSQLInstance:r})}),A=n(E),T=E.NanoSQL,M=E.nSQL;t.default=A,t.NanoSQL=T,t.nSQL=M,Object.defineProperty(t,"t",{value:!0})});
