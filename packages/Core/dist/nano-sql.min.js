!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var n in r)("object"==typeof exports?exports:e)[n]=r[n]}}(window,function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"e",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.e)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.e?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=6)}([function(e,t,r){Object.defineProperty(t,"e",{value:!0});var n=r(3),i=r(4);t.blankTableDefinition={id:"",name:"",model:{},columns:[],indexes:{},actions:[],queries:{},views:[],pkType:"string",pkCol:[],isPkNum:!1,ai:!1},t.binarySearch=function(e,r,n,i,o){var a=i||0,s=o||e.length;if(e[a]>=r)return n?-1:a;if(e[s]<=r)return n?-1:s+1;var u=Math.floor((a+s)/2);return r==e[u]?u:s-1==a?n?-1:s:r>e[u]?t.binarySearch(e,r,n,u,s):r<e[u]?t.binarySearch(e,r,n,a,u):n?-1:s},t.titleCase=function(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()},t.slugify=function(e){return String(e).replace(/\s+/g,"-").replace(/[^0-9a-z\-]/gi,"").toLowerCase()},t.buildQuery=function(e,r,n){return{table:r||e.state.selectedTable,parent:e,action:n,state:"pending",result:[],time:Date.now(),queryID:t.uuid(),extend:[],comments:[],tags:[]}},t.adapterFilters=function(e,t){return{write:function(r,n,i,o,a){e.doFilter("adapterWrite",{res:{table:r,pk:n,row:i,complete:o,error:a},query:t},function(t){t&&(e.u[t.res.table].mode||e.adapter).write(e.a[t.res.table],t.res.pk,t.res.row,function(e){t.res.complete(e)},t.res.error)},a)},read:function(r,n,i,o){e.doFilter("adapterRead",{res:{table:r,pk:n,complete:i,error:o},query:t},function(t){t&&(e.u[t.res.table].mode||e.adapter).read(e.a[t.res.table],t.res.pk,function(e){e?t.res.complete(e):t.res.complete(void 0)},t.res.error)},o)},readMulti:function(r,n,i,o,a,s,u,c){e.doFilter("adapterReadMulti",{res:{table:r,type:n,offsetOrLow:i,limitOrHigh:o,reverse:a,onRow:s,complete:u,error:c},query:t},function(t){t&&(e.u[t.res.table].mode||e.adapter).readMulti(e.a[t.res.table],t.res.type,t.res.offsetOrLow,t.res.limitOrHigh,t.res.reverse,function(e,r){t.res.onRow(e,r)},function(){t.res.complete()},t.res.error)},c)},connect:function(r,n,i){e.doFilter("adapterConnect",{res:{id:r,complete:n,error:i},query:t},function(t){t&&e.adapter.connect(t.res.id,t.res.complete,t.res.error)},i)},disconnect:function(r,n){e.doFilter("adapterDisconnect",{res:{complete:r,error:n},query:t},function(t){t&&e.adapter.disconnect(t.res.complete,t.res.error)},n)},createTable:function(r,n,i,o){e.doFilter("adapterCreateTable",{res:{table:r,tableData:n,complete:i,error:o},query:t},function(t){t&&(n.mode||e.adapter).createTable(e.a[t.res.table],t.res.tableData,t.res.complete,t.res.error)},o)},dropTable:function(r,n,i){e.doFilter("adapterDropTable",{res:{table:r,complete:n,error:i},query:t},function(t){t&&(e.u[t.res.table].mode||e.adapter).dropTable(e.a[t.res.table],t.res.complete,t.res.error)},i)},delete:function(r,n,i,o){e.doFilter("adapterDelete",{res:{table:r,pk:n,complete:i,error:o},query:t},function(t){t&&(e.u[t.res.table].mode||e.adapter).delete(e.a[t.res.table],t.res.pk,t.res.complete,t.res.error)},o)},getTableIndex:function(r,n,i){e.doFilter("adapterGetTableIndex",{res:{table:r,complete:n,error:i},query:t},function(t){t&&(e.u[t.res.table].mode||e.adapter).getTableIndex(e.a[t.res.table],t.res.complete,t.res.error)},i)},getTableIndexLength:function(r,n,i){e.doFilter("adapterGetTableIndexLength",{res:{table:r,complete:n,error:i},query:t},function(t){t&&(e.u[t.res.table].mode||e.adapter).getTableIndexLength(e.a[t.res.table],t.res.complete,t.res.error)},i)},createIndex:function(r,n,i,o,a){e.doFilter("adapterCreateIndex",{res:{table:r,indexName:n,type:i,complete:o,error:a},query:t},function(t){t&&(e.u[t.res.table].mode||e.adapter).createIndex(e.a[t.res.table],t.res.indexName,t.res.type,t.res.complete,t.res.error)},a)},deleteIndex:function(r,n,i,o){e.u[r].indexes[n]?e.doFilter("adapterDeleteIndex",{res:{table:r,indexName:n,complete:i,error:o},query:t},function(t){t&&(e.u[t.res.table].mode||e.adapter).deleteIndex(e.a[t.res.table],t.res.indexName,t.res.complete,t.res.error)},o):o({error:"Index "+n+" not found!"})},addIndexValue:function(r,n,i,o,a,s){if(e.u[r].indexes[n]){var u=o;"number"==typeof u&&e.u[r].indexes[n].props&&e.u[r].indexes[n].props.offset&&(u+=e.u[r].indexes[n].props.offset||0),e.u[r].indexes[n].props&&e.u[r].indexes[n].props.ignore_case&&(u=String(u||"").toUpperCase()),e.doFilter("adapterAddIndexValue",{res:{table:r,indexName:n,key:i,value:u,complete:a,error:s},query:t},function(t){t&&(e.u[t.res.table].mode||e.adapter).addIndexValue(e.a[t.res.table],t.res.indexName,t.res.key,t.res.value,t.res.complete,t.res.error)},s)}else s({error:"Index "+n+" not found!"})},deleteIndexValue:function(r,n,i,o,a,s){if(e.u[r].indexes[n]){var u=o;"number"==typeof u&&e.u[r].indexes[n].props&&e.u[r].indexes[n].props.offset&&(u+=e.u[r].indexes[n].props.offset||0),e.u[r].indexes[n].props&&e.u[r].indexes[n].props.ignore_case&&(u=String(u||"").toUpperCase()),e.doFilter("adapterDeleteIndexValue",{res:{table:r,indexName:n,key:i,value:u,complete:a,error:s},query:t},function(t){t&&(e.u[t.res.table].mode||e.adapter).deleteIndexValue(e.a[t.res.table],t.res.indexName,t.res.key,t.res.value,t.res.complete,t.res.error)},s)}else s({error:"Index "+n+" not found!"})},readIndexKey:function(r,n,i,o,a,s){if(e.u[r].indexes[n]){var u=i;"number"==typeof u&&e.u[r].indexes[n].props&&e.u[r].indexes[n].props.offset&&(u+=e.u[r].indexes[n].props.offset||0),e.u[r].indexes[n].props&&e.u[r].indexes[n].props.ignore_case&&(u=String(u||"").toUpperCase()),e.doFilter("adapterReadIndexKey",{res:{table:r,indexName:n,pk:u,onRowPK:o,complete:a,error:s},query:t},function(t){t&&(e.u[t.res.table].mode||e.adapter).readIndexKey(e.a[t.res.table],t.res.indexName,t.res.pk,t.res.onRowPK,t.res.complete,t.res.error)},s)}else s({error:"Index "+n+" not found!"})},readIndexKeys:function(r,n,i,o,a,s,u,c,l){var f=o,h=a;e.u[r].indexes[n]?("number"==typeof f&&"number"==typeof h&&"range"===i&&e.u[r].indexes[n]&&e.u[r].indexes[n].props.offset&&(f+=e.u[r].indexes[n].props.offset||0,h+=e.u[r].indexes[n].props.offset||0),"range"===i&&e.u[r].indexes[n].props&&e.u[r].indexes[n].props.ignore_case&&(f=String(f||"").toUpperCase(),h=String(h||"").toUpperCase()),e.doFilter("adapterReadIndexKeys",{res:{table:r,indexName:n,type:i,offsetOrLow:f,limitOrHigh:h,reverse:s,onRowPK:u,complete:c,error:l},query:t},function(t){t&&(e.u[t.res.table].mode||e.adapter).readIndexKeys(e.a[t.res.table],t.res.indexName,t.res.type,t.res.offsetOrLow,t.res.limitOrHigh,t.res.reverse,t.res.onRowPK,t.res.complete,t.res.error)},l)):l({error:"Index "+n+" not found!"})}}},t.ISO_8601_FULL=/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(\.\d+)?(([+-]\d\d:\d\d)|Z)?$/i,t.maybeDate=function(e){return e&&"string"==typeof e&&t.ISO_8601_FULL.test(e)?Date.parse(e):e},t.mutateRowTypes=function(e,t,r){if(!r.u[t])throw new Error('nSQL: Table "'+t+'" not found!');var n=function(e,t,r){return t?r&&r.length&&-1!==r.indexOf("[]")?Array.isArray(t)?t.map(function(t){return n(e,t,r.slice(0,r.lastIndexOf("[]")))}):[]:(e.forEach(function(e){if(e.model)if(-1!==e.type.indexOf("[]")){var r=void 0!==t?t[e.key]:[];Array.isArray(r)?t[e.key]=r.map(function(t){return n(e.model,t,e.type.slice(0,e.type.lastIndexOf("[]")))}):t[e.key]=[]}else t[e.key]=n(e.model,void 0!==t?t[e.key]:void 0);else switch(e.type){case"date":t[e.key]=new Date(t[e.key]).toISOString();break;default:t[e.key]=t[e.key]}}),t):t};return n(r.u[t].columns,e)},t.noop=function(){},t.throwErr=function(e){throw new Error(e)},t.nan=function(e){return isNaN(e)||null===e?0:parseFloat(e)},t.assign=function(e){return e?JSON.parse(JSON.stringify(e)):e},t.objectsEqual=function(e,t){return e===t||"object"==typeof e&&!(!e||!t)&&i(e,t)};var o=function(){function e(e,t,r){this.processItem=e,this.onError=t,this.onComplete=r,this.f=[],this.h=!1,this.v=!1,this.y=0,this.g=!1,this.b=this.b.bind(this)}return e.prototype.b=function(){var e=this;if(!this.g){if(this.v&&!this.f.length)return this.g=!0,void(this.onComplete&&this.onComplete());if(this.f.length){var r=function(){e.y++,e.y%100==0?t.setFast(e.b):e.b()},n=this.f.shift()||[];n[1]?n[1](n[0],r,this.onError?this.onError:t.noop):this.processItem&&this.processItem(n[0],this.y,r,this.onError?this.onError:t.noop)}else this.h=!1}},e.prototype.finished=function(){this.v=!0,this.g||this.h||this.f.length||(this.g=!0,this.onComplete&&this.onComplete())},e.prototype.newItem=function(e,t){this.f.push([e,t]),this.h||(this.h=!0,this.b())},e}();t.w=o,t.chainAsync=function(e,r){return new Promise(function(n,i){if(e&&e.length){var o=[],a=0,s=function(){a<e.length?r(e[a],a,function(e){e&&o.push(e||0),++a%250==0?t.setFast(function(){s()}):s()},function(e){i(e)}):n(o.length?o:void 0)};s()}else n([])})},t.allAsync=function(e,t){return Promise.all((e||[]).map(function(e,r){return new Promise(function(n,i){t(e,r,n,i)})}))};var a="undefined"==typeof window?"":navigator.userAgent||"";t.isSafari=0!==a.length&&(/^((?!chrome|android).)*safari/i.test(a)||/iPad|iPhone|iPod/.test(a)&&!window.MSStream),t.isMSBrowser=0!==a.length&&(0<a.indexOf("MSIE ")||0<a.indexOf("Trident/")||0<a.indexOf("Edge/")),t.isAndroid=/Android/.test(a),t.random16Bits=function(){if("undefined"==typeof crypto)return Math.round(Math.random()*Math.pow(2,16));if(crypto.getRandomValues){var e=new Uint16Array(1);return crypto.getRandomValues(e),e[0]}return"undefined"!=typeof global&&global.S.randomBytes?global.S.randomBytes(2).reduce(function(e,t){return t*e}):Math.round(Math.random()*Math.pow(2,16))},t.throttle=function(e,t,r){var n=!1;return function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];n||(n=!0,setTimeout(function(){t.apply(e,i),n=!1},r))}},t.timeid=function(e){for(var r=Math.round((new Date).getTime()/(e?1:1e3)).toString();r.length<(e?13:10);)r="0"+r;for(var n=(t.random16Bits()+t.random16Bits()).toString(16);n.length<5;)n="0"+n;return r+"-"+n},t.intersect=function(e,t){return!(!e||!t)&&!(!e.length||!t.length)&&0<(e||[]).filter(function(e){return-1!==(t||[]).indexOf(e)}).length},t.uuid=function(){var e,r,n="";return[n,n,n,n,n,n,n,n].reduce(function(i,o,a){for(e=t.random16Bits(),r=3===a?4:4===a?(e%16&3|8).toString(16):n,e=e.toString(16);e.length<4;)e="0"+e;return i+(-1<[2,3,4,5].indexOf(a)?"-":n)+(r+e).slice(0,4)},n)},t.hash=function(e){for(var t=5381,r=e.length;r;)t=33*t^e.charCodeAt(--r);return(t>>>0).toString(16)},t.generateID=function(e,r){var n={int:function(e){return e},date:function(e){return e},float:function(e){return e},uuid:t.uuid,timeId:function(){return t.timeid()},timeIdms:function(){return t.timeid(!0)}};return n[e]?n[e](r||1):void 0},t.cleanArgs2=function(e,r,n){var i=function(r,o,a){if(-1!==r.indexOf("[]")){var s=r.slice(0,r.lastIndexOf("[]"));return Array.isArray(o)?o.map(function(e){return i(s,e,a)}):[]}if("string"==typeof a){var u=a.replace(/\[\]/gim,""),c=Object.keys(n.config.types||{}).reduce(function(e,t){return t===u?(n.config.types||{})[t]:e},void 0);if(!c)throw new Error("Can't find type "+u+"!");return i(a,e,c)}var l={},f=!1,h=[];return Object.keys(a).forEach(function(e){var r=e.split(":");"*"===r[0]?f=!0:(h.push(r[0]),l[r[0]]=t.cast(r[1],o[r[0]],!1,n))}),f&&t.isObject(o)&&Object.keys(o).filter(function(e){return-1===h.indexOf(e)}).forEach(function(e){l[e]=o[e]}),l};return i("string"==typeof r?r:"",e,r)},t.cleanArgs=function(e,r,n){var i={},o=e.length;for(Object.keys(n.config.types||{});o--;){var a=e[o].split(":");1<a.length?i[a[0]]=t.cast(a[1],r[a[0]]||void 0,!0,n):i[a[0]]=r[a[0]]||void 0}return i},t.isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},t.objSort=function(e,r){return function(n,i){var o=e?t.deepGet(e,n)>t.deepGet(e,i)?-1:1:i<n?-1:1;return r?-1*o:o}},t.execFunction=function(e,r,n,i){var o,a=r.match(/\((.*)\)/gim);if(!a[0])return{result:void 0};var s=a[0].substr(1,a[0].length-2).split(/\,\s?(?![^\(]*\))/).map(function(e){return e.trim()}),u=r.split("(").shift(),c=s.map(function(r){return-1!==r.indexOf("(")?t.execFunction(e,r,n,i).result:r});return e.parent.functions[u]?(o=e.parent.functions[u]).call.apply(o,[e,n,i].concat(c)):{result:void 0}},t.cast=function(e,r,n,i){if("any"===e||"blob"===e||"*"===e)return r;if(-1!==e.indexOf("[]")){var o=e.slice(0,e.lastIndexOf("[]"));return Array.isArray(r)?r.map(function(e){return t.cast(o,e,n)}):[]}var a=typeof r,s={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},u=i&&i.config.types||{};if(-1!==Object.keys(u).indexOf(e)){if(t.isObject(r)){var c=u[e];return Object.keys(c).reduce(function(e,o){var a=o.split(":");return e[a[0]]=t.cast(a[1],r[a[0]],n,i),e},{})}return{}}var l=function(e,i){switch(e){case"safestr":return l("string",i).replace(/[&<>"'`=\/]/gim,function(e){return s[e]});case"date":if("string"===a)return Date.parse(i);case"int":return"number"!==a||i%1!=0?Math.round(t.nan(i)):i;case"number":case"float":return"number"!==a?t.nan(i):i;case"array":return Array.isArray(i)?i:[];case"uuid":case"timeId":case"timeIdms":case"string":return"string"!==a?String(i):i;case"object":case"obj":case"map":return t.isObject(i)?i:{};case"boolean":case"bool":return!0===i||1===i}return n?r:null};if(null==r)return null;var f=l(String(e||"").toLowerCase(),r);return void 0!==f&&-1<["int","float","number"].indexOf(e)&&isNaN(f)?0:f},t.rad2deg=function(e){return 180*e/Math.PI},t.deg2rad=function(e){return e*(Math.PI/180)},t.crowDistance=function(e,r,n,i,o){void 0===o&&(o=6371);var a=t.deg2rad(n-e),s=t.deg2rad(i-r),u=Math.pow(Math.sin(a/2),2)+Math.cos(t.deg2rad(e))*Math.cos(t.deg2rad(n))*Math.pow(Math.sin(s/2),2);return o*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))},t.levenshtein=function(e,t){return n(e,t)};var s={};t.resolvePath=function(e){if(!e)return[];if(s[e])return s[e].slice();var t=-1!==e.indexOf("[")?e.split(/\.|\[/gim).map(function(e){return e.replace(/\]/gim,"")}):e.split(".");return s[e]=t,s[e].slice()},t.getFnValue=function(e,r){return r.match(/\".*\"|\'.*\'/gim)?r.replace(/\"|\'/gim,""):t.deepGet(r,e)},t.deepFreeze=function(e){return Object.getOwnPropertyNames(e||{}).forEach(function(r){var n=e[r];"object"==typeof n&&null!==n&&(e[r]=t.deepFreeze(n))}),Object.freeze(e)},t.deepSet=function(e,r,n){var i=function(e,r,o){e[r+1]?(o[e[r]]&&(Array.isArray(o[e[r]])||t.isObject(o[e[r]]))||(isNaN(e[r+1])?o[e[r]]={}:o[e[r]]=[]),i(e,r+1,o[e[r]])):o[e[r]]=n};return i(Array.isArray(e)?e:t.resolvePath(e),0,r),r},t.deepGet=function(e,r){var n=function(e,t,r){return e[t]&&r?n(e,t+1,r[e[t]]):r};return n(Array.isArray(e)?e:t.resolvePath(e),0,r)},t.maybeAssign=function(e){return Object.isFrozen(e)?t.assign(e):e};var u=function(e){return e[0].apply(null,Array.prototype.slice.call(e,1))};t.setFast="undefined"!=typeof Promise?function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];Promise.resolve().then(function(){u(e)})}:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];setTimeout(function(){u(e)},0)}},function(e,t){var r,n;Object.defineProperty(t,"e",{value:!0}),t.VERSION=2.2,(r=t.InanoSQLFKActions||(t.InanoSQLFKActions={}))[r.NONE=0]="NONE",r[r.CASCADE=1]="CASCADE",r[r.RESTRICT=2]="RESTRICT",r[r.SET_NULL=3]="SET_NULL",(n=t.IWhereType||(t.IWhereType={}))[n.fast=0]="fast",n[n.medium=1]="medium",n[n.slow=2]="slow",n[n.fn=3]="fn",n[n.none=4]="none"},function(e,t,r){var n=this&&this.O||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"e",{value:!0});var i=r(0);t.err=new Error("Memory index doesn't support this action!");var o=function(){function e(e,t){this.assign=e,this.useCache=t}return e.prototype.connect=function(e,r,n){n(t.err)},e.prototype.disconnect=function(e,r){r(t.err)},e.prototype.createTable=function(e,r,n,i){i(t.err)},e.prototype.dropTable=function(e,r,n){n(t.err)},e.prototype.write=function(e,r,n,i,o){o(t.err)},e.prototype.read=function(e,r,n,i){i(t.err)},e.prototype.delete=function(e,r,n,i){i(t.err)},e.prototype.readMulti=function(e,r,n,i,o,a,s,u){u(t.err)},e.prototype.getTableIndex=function(e,r,n){n(t.err)},e.prototype.getTableIndexLength=function(e,r,n){n(t.err)},e.prototype.createIndex=function(e,t,r,o,a){var s="_idx_"+e+"_"+t;this.createTable(s,n({},i.blankTableDefinition,{pkType:r,pkCol:["id"],isPkNum:-1!==["float","int","number"].indexOf(r)}),function(){o()},a)},e.prototype.deleteIndex=function(e,t,r,n){var i="_idx_"+e+"_"+t;this.dropTable(i,r,n)},e.prototype.addIndexValue=function(e,t,r,n,o,a){var s=this,u="_idx_"+e+"_"+t;this.read(u,n,function(e){var t=e?e.pks:[];if(0===(t=s.assign?i.assign(t):t).length)t.push(r);else{var c=i.binarySearch(t,r,!1);t.splice(c,0,r)}s.write(u,n,{id:r,pks:s.assign?i.assign(t):t},o,a)},a)},e.prototype.deleteIndexValue=function(e,t,r,n,o,a){var s=this,u="_idx_"+e+"_"+t;this.read(u,n,function(e){var t=e?e.pks:[];if(0!==(t=s.assign?i.assign(t):t).length){var c=t.length<100?t.indexOf(r):i.binarySearch(t,r,!0);-1!==c&&t.splice(c,1),t.length?s.write(u,n,{id:r,pks:s.assign?i.assign(t):t},o,a):s.delete(u,n,o,a)}else o()},a)},e.prototype.readIndexKey=function(e,t,r,n,i,o){var a="_idx_"+e+"_"+t;this.read(a,r,function(e){e&&e.pks.forEach(n),i()},o)},e.prototype.readIndexKeys=function(e,t,r,n,i,o,a,s,u){var c="_idx_"+e+"_"+t;this.readMulti(c,r,n,i,o,function(e){e&&e.pks.forEach(function(t){a(t,e.id)})},s,u)},e}();t.nanoSQLMemoryIndex=o},function(e,t,r){"use strict";e.exports=function(e,t,r){var o,a,s,u,c,l,f,h;if(e===t)return 0;if(o=e.length,a=t.length,0===o)return a;if(0===a)return o;for(r&&(e=e.toLowerCase(),t=t.toLowerCase()),f=0;f<o;)i[f]=e.charCodeAt(f),n[f]=++f;for(h=0;h<a;)for(s=t.charCodeAt(h),u=c=h++,f=-1;++f<o;)l=s===i[f]?c:c+1,c=n[f],n[f]=u=u<c?u<l?u+1:l:c<l?c+1:l;return u};var n=[],i=[]},function(e,t,r){"use strict";var n=Array.isArray,i=Object.keys,o=Object.prototype.hasOwnProperty;e.exports=function e(t,r){if(t===r)return!0;if(t&&r&&"object"==typeof t&&"object"==typeof r){var a,s,u,c=n(t),l=n(r);if(c&&l){if((s=t.length)!=r.length)return!1;for(a=s;0!=a--;)if(!e(t[a],r[a]))return!1;return!0}if(c!=l)return!1;var f=t instanceof Date,h=r instanceof Date;if(f!=h)return!1;if(f&&h)return t.getTime()==r.getTime();var p=t instanceof RegExp,d=r instanceof RegExp;if(p!=d)return!1;if(p&&d)return t.toString()==r.toString();var y=i(t);if((s=y.length)!==i(r).length)return!1;for(a=s;0!=a--;)if(!o.call(r,y[a]))return!1;for(a=s;0!=a--;)if(!e(t[u=y[a]],r[u]))return!1;return!0}return t!=t&&r!=r}},function(e,t,r){Object.defineProperty(t,"e",{value:!0});var n,i=r(0),o=r(11),a=r(12),s=r(13);"undefined"!=typeof global&&(n=global._),t.detectStorage=function(){return"undefined"==typeof window?"RKS":i.isSafari&&void 0!==window.openDatabase?"WSQL":"undefined"!=typeof indexedDB?"IDB":void 0!==window.openDatabase?"WSQL":"LS"},t.resolveMode=function(e,r){if("string"!=typeof e)return e;switch("PERM"===e&&(e=t.detectStorage()),e){case"TEMP":return new o.SyncStorage(!1);case"LS":return new o.SyncStorage(!0);case"WSQL":return new a.WebSQL(r&&r.size);case"IDB":return new s.IndexedDB(r&&r.version);case"RKS":case"LVL":return new n(r&&r.path);default:throw new Error("Cannot find mode "+e+"!")}}},function(e,t,r){e.exports=r(7)},function(e,t,r){var n=this&&this.O||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"e",{value:!0});var i=r(8),o=r(0),a=r(1);t.InanoSQLInstance=a.InanoSQLInstance;var s=r(9),u=r(10),c=r(14),l=r(0),f=r(5),h=function(){function e(){this.version=a.VERSION,this.planetRadius=6371,this.N=new o.w,this.state={activeAV:"",hasAnyEvents:!1,peers:[],pid:o.uuid(),id:o.uuid(),cacheId:o.uuid(),peerEvents:[],focused:!0,peerMode:!1,connected:!1,ready:!1,selectedTable:"",exportQueryObj:!1},this.config={id:"temp",queue:!1},this.u={},this.I={},this.a={T:"_util",j:"_ttl"},this.A={},this.filters={};var e=function(e){return"object"==typeof e?JSON.stringify(e):String(e)},t=function(e){return function(t){return isNaN(t)||null===t?0:e(t)}};this.indexTypes={string:e,geo:function(e){},float:t(parseFloat),int:t(parseInt),number:t(parseFloat),date:t(parseInt),uuid:e,timeId:e,timeIdms:e},this.eventFNs={Core:{"*":new i.ReallySmallEvents},"*":{"*":new i.ReallySmallEvents}},this.x=this.x.bind(this),s.attachDefaultFns(this)}return e.prototype.k=function(){var e=this;this.state.cacheId=o.uuid(),this.I={},Object.keys(this.u).forEach(function(t){var r=e.u[t];Object.keys(r.indexes).forEach(function(n){var i=r.indexes[n];if(i.props&&i.props.foreignKey){var s=o.resolvePath(i.props.foreignKey.target),u=s.shift();e.I[u]||(e.I[u]=[]),e.I[u].push({selfPath:s.map(function(e){return e.replace(/\[\]/gim,"")}),selfIsArray:-1!==i.props.foreignKey.target.indexOf("[]"),childTable:t,childPath:i.path,childIsArray:i.isArray,childIndex:n,onDelete:i.props.foreignKey.onDelete||a.InanoSQLFKActions.NONE})}})})},e.prototype.doFilter=function(e,t,r,n){var i=this;this.filters[e]?o.chainAsync(this.filters[e],function(r,o,a){i.filters[e][o](t,function(e){t=e,a()},n)}).then(function(){r(t)}):r(t)},e.prototype.getCache=function(e,t){if(!this.A[e])throw new Error('Cache "'+e+'" not found!');return t?this.A[e].slice(t.offset,t.offset+t.limit):this.A[e].slice()},e.prototype.clearCache=function(e){var t=void 0!==this.A[e];return delete this.A[e],t},e.prototype.clearTTL=function(e){var t=this,r=this.state.selectedTable+"."+e;return new Promise(function(e,i){t.triggerQuery(n({},o.buildQuery(t,"_ttl","delete"),{where:["key","=",r]}),o.noop,e,i)})},e.prototype.expires=function(e){var t=this;return new Promise(function(r,i){var a=t.state.selectedTable+"."+e,s=[];t.triggerQuery(n({},o.buildQuery(t,"_ttl","select"),{where:["key","=",a]}),function(e){s.push(e)},function(){s.length?r({time:(s[0].date-Date.now())/1e3,cols:s[0].cols}):r({time:-1,cols:[]})},i)})},e.prototype.x=function(){var e=this;if(!this.config.disableTTL){this.D&&clearTimeout(this.D);var t=0,r=0,i=function(){var a=[];e.triggerQuery(n({},o.buildQuery(e,"_ttl","select"),{limit:20,offset:20*t}),function(e){a.push(e)},function(){a.length?o.chainAsync(a,function(t,i,a){if(t.date<Date.now()){var s=function(){e.triggerQuery(n({},o.buildQuery(e,"_ttl","delete"),{where:["key","=",t.key]}),o.noop,a,o.throwErr)},u=t.key.split("."),c=u[0],l=-1===["float","int","number"].indexOf(e.u[c].pkType)?u[1]:parseFloat(u[1]);if(t.cols.length){var f={};t.cols.forEach(function(e){f[e]=null}),e.triggerQuery(n({},o.buildQuery(e,c,"upsert"),{actionArgs:f,where:[e.u[c].pkCol,"=",l]}),o.noop,s,o.throwErr)}else e.triggerQuery(n({},o.buildQuery(e,c,"delete"),{where:[e.u[c].pkCol,"=",l]}),o.noop,s,o.throwErr)}else r=Math.max(r,t.date),a()}).then(function(){t++,i()}):r&&(e.D=setTimeout(e.x,r-Date.now()))},o.throwErr)};i()}},e.prototype.selectTable=function(e){return e&&(this.state.selectedTable=e),this},e.prototype.getPeers=function(){return JSON.parse(localStorage.getItem("nsql-peers-"+this.state.id)||"[]")},e.prototype.R=function(e){var t=this;return new Promise(function(r,n){var i={};(e.plugins||[]).forEach(function(e){(e.filters||[]).forEach(function(e){i[e.name]||(i[e.name]=[]);for(var t=e.priority;i[e.name][t];)t++;i[e.name][t]=e.call})}),Object.keys(i).forEach(function(e){t.filters[e]=[],i[e].forEach(function(r){r&&t.filters[e].unshift(r)})});var o=function(e,t){return!t||!t.length||(1===t.length?e>=t[0]:e>=t[0]&&e<t[1])},s=!1;(e.plugins||[]).forEach(function(t){if(t.dependencies){var r=t.dependencies||{};Object.keys(t.dependencies).forEach(function(i,u,c){if("core"===i)o(a.VERSION,r[i])||(s=!0,n('Plugin "'+t.name+'" requires a different core version of nano-sql!'));else{var l=(e.plugins||[]).reduce(function(e,t){return t.name===i?t:e});l||(s=!0,n('Plugin "'+t.name+'" requires plugin "'+i+"\" but it isn't installed!")),o(l.version,r[i])||(s=!0,n('Plugin "'+t.name+'" requires a different version of "'+i+'"!'))}})}}),s||r()})},e.prototype.M=function(){var e=this;return new Promise(function(t,r){e.triggerQuery(n({},o.buildQuery(e,"_util","upsert"),{actionArgs:o.assign({key:"tableIds",value:e.a})}),o.noop,t,r)})},e.prototype.presetQuery=function(e){var t=this;if("string"!=typeof this.state.selectedTable)throw new Error("Can't get table queries without selecting a table!");if(-1===Object.keys(this.u[this.state.selectedTable].queries).indexOf(e))throw new Error("Can't find preset query "+e+"!");var r=!1;return{promise:function(n){return new Promise(function(i,a){if(r)a("Query already streaming!");else{r=!0;var s=t.u[t.state.selectedTable].queries[e].args,u={};s&&(u=o.cleanArgs2(n,s,t));var c=[];t.u[t.state.selectedTable].queries[e].call(t,u,function(e){c.push(e)},function(){i(c)},a)}})},stream:function(n,i,a,s){if(r)s("Query already using promise!");else{r=!0;var u=t.u[t.state.selectedTable].queries[e].args,c={};u&&(c=o.cleanArgs2(n,u,t)),t.u[t.state.selectedTable].queries[e].call(t,c,i,a,s)}}}},e.prototype.connect=function(e){var t=this;return this.R(e).then(function(){return new Promise(function(r,n){t.doFilter("config",{res:e},function(e){r(e.res)},n)})}).then(function(e){return t.state.id=e.id||"nSQL_DB",t.config=n({plugins:[]},e),"undefined"!=typeof window&&e&&e.peer&&(t.state.peerMode=!0),new Promise(function(e,r){t.doFilter("willConnect",{res:t},function(){e()},r)})}).then(function(){return new Promise(function(e,r){t.adapter=f.resolveMode(t.config.mode||"TEMP",t.config),t.adapter.plugin&&(t.config.plugins||[]).push(t.adapter.plugin),t.R(t.config).then(function(){t.adapter.nSQL=t,o.adapterFilters(t).connect(t.state.id,function(){t.doFilter("postConnect",{res:t.config},function(r){t.config=r.res,e()},r)},r)}).catch(r),t.config.planetRadius&&(t.planetRadius=t.config.planetRadius)})}).then(function(){t.triggerEvent({target:"Core",targetId:t.state.id,path:"*",events:["connect"],time:Date.now()}),t.state.connected=!0;var e=["_util","_ttl"].concat((t.config.tables||[]).map(function(e){return e.name}));return o.chainAsync(e,function(e,r,i,a){switch(e){case"_util":t.triggerQuery(n({},o.buildQuery(t,"_util","create table"),{actionArgs:{name:"_util",model:{"key:string":{pk:!0},"value:any":{}},C:!0}}),o.noop,function(){t.triggerQuery(n({},o.buildQuery(t,"_util","select"),{where:["key","=","tableIds"]}),function(e){t.a=n({},t.a,e.value)},function(){i()},a)},a);break;case"_ttl":t.triggerQuery(n({},o.buildQuery(t,"_ttl","create table"),{actionArgs:{name:"_ttl",model:{"key:string":{pk:!0},"table:string":{},"cols:string[]":{},"date:number":{}},C:!0}}),o.noop,i,a);break;default:var s=(t.config.tables||[]).filter(function(t){return t.name===e})[0];if(!s)return void a("Table not found!");t.triggerQuery(n({},o.buildQuery(t,e,"create table"),{actionArgs:s}),o.noop,i,a)}})}).then(function(){return new Promise(function(e,r){var i;t.triggerQuery(n({},o.buildQuery(t,"_util","select"),{where:["key","=","version"]}),function(e){e&&(i=e.value)},function(){!i||i<2?t.triggerQuery(n({},o.buildQuery(t,"_util","upsert"),{actionArgs:{key:"version",value:a.VERSION}}),o.noop,e,r):e()},r)})}).then(function(){return new Promise(function(e,r){var i;t.config.version?t.triggerQuery(n({},o.buildQuery(t,"_util","select"),{where:["key","=","db-version"]}),function(e){e&&(i=e.value)},function(){var a=function(e,r,i){t.triggerQuery(n({},o.buildQuery(t,"_util","upsert"),{actionArgs:{key:"db-version",value:e}}),o.noop,r,i)};if(i){var s=function(){if(i===t.config.version)a(t.config.version||0,e,r);else{if(!t.config.onVersionUpdate)return void a(t.config.version||0,e,r);t.config.onVersionUpdate(i).then(function(e){a(i=e,function(){o.setFast(s)},r)}).catch(r)}};s()}else a(t.config.version||0,e,r)},r):e()})}).then(function(){return new Promise(function(e,r){var n={target:"Core",path:"*",targetId:t.state.id,events:["ready"],time:Date.now()};t.doFilter("ready",{res:n},function(r){t.triggerEvent(r.res),t.state.ready=!0,t.config.disableTTL||t.x(),t.config.peer&&t.L(),e()},r)})})},e.prototype.L=function(){var e=this,r=0;this.state.pid=o.uuid(),this.state.peers=this.getPeers(),this.state.peers.unshift(this.state.pid),localStorage.setItem("nsql-peers-"+this.state.id,JSON.stringify(this.state.peers)),window.addEventListener("storage",function(t){if(t.key==="nsql-peers-"+e.state.id&&(e.state.peers=e.getPeers()),t.key&&0===t.key.indexOf(e.state.pid+".")){localStorage.removeItem(t.key);var i=JSON.parse(t.newValue||"{}");e.state.peerEvents.push(i.query.queryID||""),e.triggerEvent(n({},i,{types:["peer change"]})),o.setFast(function(){e.triggerEvent(i)})}if(50<++r&&e.state.peers[0]===e.state.pid){r=0;for(var a=localStorage.length,s={};a--;){var u=localStorage.key(a),c=u?u.match(/\w{8}-\w{4}-\w{4}-\w{4}-\w{8}/gim):null;if(u&&c){var l=(c||[""])[0];s[l]||(s[l]=[]),s[l].push(u)}}Object.keys(s).forEach(function(t){10<s[t].length&&(e.state.peers=e.state.peers.filter(function(e){return e!==t}),s[t].forEach(function(e){localStorage.removeItem(e)}),localStorage.setItem("nsql-peers-"+e.state.id,JSON.stringify(e.state.peers)))})}}),window.onblur=function(){e.state.focused=!1},window.onfocus=function(){e.state.peers=e.state.peers.filter(function(t){return t!==e.state.pid}),e.state.peers.unshift(e.state.pid),localStorage.setItem("nsql-peers-"+e.state.id,JSON.stringify(e.state.peers)),e.state.focused=!0},t.nSQL("*").on("change",function(t){var r=e.state.peerEvents.indexOf(t.query.queryID||"");-1===r?e.state.peers.filter(function(t){return t!==e.state.pid}).forEach(function(e){localStorage.setItem(e+"."+t.query.queryID,JSON.stringify(t))}):e.state.peerEvents.splice(r,1)}),window.addEventListener("beforeunload",function(){return e.state.peers=e.state.peers.filter(function(t){return t!==e.state.pid}),localStorage.setItem("nsql-peers-"+e.state.id,JSON.stringify(e.state.peers)),!1})},e.prototype.every=function(e){for(var t=0,r=[];t<=e.length;)e.every?t%e.every==0&&r.push(t+(e.offset||0)):r.push(t+(e.offset||0)),t++;return r},e.prototype.on=function(e,t,r){var n=this,a=this,s=r||("string"!=typeof a.state.selectedTable?"":a.state.selectedTable);this.doFilter("onEvent",{res:{action:e,callback:t}},function(t){switch(t.res.action){case"connect":case"ready":case"disconnect":case"peer change":case"slow query":n.eventFNs.Core["*"].on(t.res.action,t.res.callback);break;case"select":case"change":case"delete":case"upsert":case"*":var r=o.resolvePath(s);n.eventFNs[r[0]]||(n.eventFNs[r[0]]={"*":new i.ReallySmallEvents});var u=r.filter(function(e,t){return 0<t}).join(".")||"*";n.eventFNs[r[0]][u]||(n.eventFNs[r[0]][u]=new i.ReallySmallEvents),n.eventFNs[r[0]][u].on(t.res.action,t.res.callback);break;default:new Promise(function(t,r){n.doFilter("customEvent",{res:{nameSpace:"",path:"*"},selectedTable:s,action:e,on:!0},t,r)}).then(function(r){if(!r.res.nameSpace)throw new Error('Invalid event "'+e+'"!');n.eventFNs[r.res.nameSpace]||(n.eventFNs[r.res.nameSpace]={"*":new i.ReallySmallEvents}),n.eventFNs[r.res.nameSpace][r.res.path]||(n.eventFNs[r.res.nameSpace][r.res.path]=new i.ReallySmallEvents),n.eventFNs[r.res.nameSpace][r.res.path].on(t.res.action,t.res.callback),a.q()})}a.q()},o.noop)},e.prototype.off=function(e,t,r){var n=this,a=this,s=r||"string"!=typeof a.state.selectedTable?"":a.state.selectedTable;this.doFilter("onEvent",{res:{action:e,callback:t}},function(t){switch(t.res.action){case"connect":case"ready":case"disconnect":case"peer change":case"slow query":n.eventFNs.Core["*"].off(t.res.action,t.res.callback);break;case"select":case"change":case"delete":case"upsert":case"*":var r=o.resolvePath(s);n.eventFNs[r[0]]||(n.eventFNs[r[0]]={"*":new i.ReallySmallEvents});var u=r.filter(function(e,t){return 0<t}).join(".")||"*";n.eventFNs[r[0]][u]||(n.eventFNs[r[0]][u]=new i.ReallySmallEvents),n.eventFNs[r[0]][u].off(t.res.action,t.res.callback);break;default:new Promise(function(t,r){n.doFilter("customEvent",{res:{nameSpace:"",path:"*"},selectedTable:s,action:e,on:!0},t,r)}).then(function(r){if(!r.res.nameSpace)throw new Error('Invalid event "'+e+'"!');n.eventFNs[r.res.nameSpace]||(n.eventFNs[r.res.nameSpace]={"*":new i.ReallySmallEvents}),n.eventFNs[r.res.nameSpace][r.res.path]||(n.eventFNs[r.res.nameSpace][r.res.path]=new i.ReallySmallEvents),n.eventFNs[r.res.nameSpace][r.res.path].off(t.res.action,t.res.callback),a.q()})}a.q()},o.noop)},e.prototype.q=function(){var e=this;return this.state.hasAnyEvents=Object.keys(this.eventFNs).reduce(function(t,r){return!0===t||0<Object.keys(e.eventFNs[r]).reduce(function(t,n){return Object.keys(e.eventFNs[r][n].eventListeners).length+t},0)||t},!1),this},e.prototype.getView=function(e,t){return this.P("v",this.state.selectedTable,e,t)},e.prototype.doAction=function(e,t){return this.P("a",this.state.selectedTable,e,t)},e.prototype.P=function(e,t,r,n){var i=this;return"string"!=typeof this.state.selectedTable?Promise.reject("Can't do Action/View with selected table!"):new Promise(function(o,a){i.doFilter("actionView",{res:{AVType:e,table:t,AVName:r,AVArgs:n}},o,a)}).then(function(e){var t="a"===e.res.AVType?"actions":"views",r=i.u[e.res.table][t].reduce(function(t,r){return r.name===e.res.AVName?r:t},null);return r?r.call(r.args?o.cleanArgs(r.args,e.res.AVArgs,i):{},i):new Promise(function(t,r){return r(e.res.AVType+' "'+e.res.AVName+'" Not Found!')})})},e.prototype.query=function(e,t){var r=this.state.activeAV;return this.state.activeAV="",new c.F(this,this.state.selectedTable,e,t,r)},e.prototype.triggerQuery=function(e,t,r,n){var i=this;this.state.connected||"string"!=typeof e.table?this.doFilter("query",{res:e},function(e){i.config.queue&&!e.res.skipQueue?i.N.newItem({query:e.res,onRow:t,complete:r,error:n},function(e,t,r){new u.U(i,e.query,e.onRow,function(){t(),e.complete()},function(r){t(),e.error(r)})}):new u.U(i,e.res,function(e){t(e)},r,n)},n):n("nSQL: Can't do a query before the database is connected!")},e.prototype.triggerEvent=function(e,t){var r=this;return this.doFilter("event",{res:e},function(e){r.state.hasAnyEvents&&o.setFast(function(){e.res.events.forEach(function(n){if(t||Object.keys(r.eventFNs["*"]).forEach(function(t){r.eventFNs["*"][t].trigger(n,e.res)}),r.eventFNs[e.res.target])if("_all_"===e.res.path)Object.keys(r.eventFNs[e.res.target]).forEach(function(t){r.eventFNs[e.res.target][t].trigger(n,e.res)});else{if(!r.eventFNs[e.res.target][e.res.path])return;r.eventFNs[e.res.target][e.res.path].trigger(n,e.res)}})})},function(e){console.log("Event suppressed",e)}),this},e.prototype.default=function(e,t){var r=this;if(e=e||{},!t&&"string"!=typeof this.state.selectedTable)throw new Error("Must select table to generate defualts!");if(t=t||this.state.selectedTable,!this.u[t])throw new Error('nSQL: Table "'+t+'" not found for generating default object!');var n="",i=function(e,t,a){var s={};if(t=t||{},a&&a.length&&-1!==a.indexOf("[]"))return Array.isArray(t)?t.map(function(t){return i(e,t,a.slice(0,a.lastIndexOf("[]")))}):[];var u=!1;if(e.forEach(function(e){if("*"!==e.key){if(e.model)if(-1!==e.type.indexOf("[]")){var a=void 0!==t?t[e.key]:[];Array.isArray(a)?s[e.key]=a.map(function(t){return i(e.model,t,e.type.slice(0,e.type.lastIndexOf("[]")))}):s[e.key]=[]}else s[e.key]=i(e.model,void 0!==t?t[e.key]:void 0);else{var c=void 0!==t[e.key]?o.cast(e.type,t[e.key],!1,r):e.default;void 0!==e.max&&c>e.max&&(n="Data error, column "+e.key+" can't be greater than "+e.max+"!"),void 0!==e.min&&c<e.min&&(n="Data error, column "+e.key+" can't be less than "+e.min+"!"),s[e.key]=c}!e.notNull||null!==s[e.key]&&void 0!==s[e.key]||(n="Data error, "+e.key+" cannot be null!")}else u=!0}),n.length)return new Error(n);if(u&&t){var c=e.map(function(e){return e.key});Object.keys(t).filter(function(e){return-1===c.indexOf(e)}).forEach(function(e){s[e]=t[e]})}return s};return i(this.u[t].columns,e)},e.prototype.rawDump=function(e,t,r){var n=this,i=t?e:Object.keys(this.u).filter(function(t){return!e.length||-1!==e.indexOf(t)});return o.chainAsync(i,function(e,i,a,s){if(t){var u=-1!==e.indexOf(":")?e.split(":")[0]:e,c=-1!==e.indexOf(":")?[e.split(":")[1]]:Object.keys(n.u[e].indexes);o.chainAsync(c,function(e,t,i,a){o.adapterFilters(n).readIndexKeys(u,e,"all",void 0,void 0,!1,function(t,n){r(u+"."+e,{indexId:n,rowId:t})},i,a)}).then(a).catch(s)}else o.adapterFilters(n).readMulti(e,"all",void 0,void 0,!1,function(t){r(e,t)},a,s||o.noop)})},e.prototype.rawImport=function(e,t,r){var n=this,i=0,a=Object.keys(e).reduce(function(t,r){return t+e[r].length},0),s=Object.keys(this.u),u=t?Object.keys(e):Object.keys(e).filter(function(e){return-1!==s.indexOf(e)});return o.chainAsync(u,function(s,u,c,l){if(t){var f=s.split(".")[0],h=s.split(".")[1];o.chainAsync(e[s],function(e,t,r,i){o.adapterFilters(n).addIndexValue(f,h,e.rowId,e.indexId,r,i)}).then(c).catch(l)}else{var p=n.u[s].pkCol;o.chainAsync(e[s],function(e,t,u,c){o.deepGet(p,e)||!c?o.adapterFilters(n).write(s,o.deepGet(p,e),e,function(e){u(),i++,r&&r(Math.round(i/a*1e4)/100)},c||o.noop):c("No primary key found, can't import: "+JSON.stringify(e))}).then(c).catch(l)}})},e.prototype.disconnect=function(){var e=this;return new Promise(function(t,r){e.doFilter("disconnect",{},function(){o.adapterFilters(e).disconnect(t,r)},r)})},e.prototype.extend=function(e){for(var t=this,r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];return new Promise(function(n,i){t.doFilter("extend",{scope:e,args:r,res:null},n,i)})},e.prototype.loadJS=function(e,t,r){var i=this,a=this.state.selectedTable;if("string"!=typeof a)return Promise.reject("nSQL: Can't load JS into temporary table!");var s=e.length,u=0;return(r?o.allAsync:o.chainAsync)(e,function(e,r,c,l){i.triggerQuery(n({},o.buildQuery(i,a,"upsert"),{actionArgs:e}),function(e){},function(){u++,t&&t(u/s*1e4/100),c()},l)})},e.prototype.JSONtoCSV=function(e,t,r){var n=[];if(!e.length)return"";var i=[];return i=r||(e.forEach(function(e){i=Object.keys(e).concat(i)}),i.filter(function(e,t,r){return r.indexOf(e)===t})),t&&n.push(i.map(function(e){return'"'+e+'"'}).join(",")),e.forEach(function(e){n.push(i.map(function(t){return null===e[t]||void 0===e[t]?"":"string"==typeof e[t]?'"'+e[t].replace(/\"/g,'""')+'"':"boolean"==typeof e[t]?!0===e[t]?"true":"false":"object"==typeof e[t]?'"'+JSON.stringify(e[t]).replace(/\"/g,'""')+'"':e[t]}).join(","))}),n.join("\n")},e.prototype.csvToArray=function(e){for(var t,r="",n=[""],i=[n],o=0,a=0,s=!0,u=0,c=e;u<c.length;u++)'"'===(t=c[u])?(s&&t===r&&(n[o]+=t),s=!s):","===t&&s?t=n[++o]="":"\n"===t&&s?("\r"===r&&(n[o]=n[o].slice(0,-1)),n=i[++a]=[t=""],o=0):n[o]+=t,r=t;return i[0]},e.prototype.CSVtoJSON=function(e,t){var r=this,n=[];return e.split(/\r?\n|\r|\t/gm).map(function(e,i){if(0!==i){var o=r.csvToArray(e);if(o){o=o.map(function(e){return e.trim()});for(var a=n.length,s={};a--;)if(o[a])if("true"===o[a]||"false"===o[a])s[n[a]]="true"===o[a];else if(0===o[a].indexOf("{")||0===o[a].indexOf("["))try{s[n[a]]=JSON.parse(o[a])}catch(e){s[n[a]]=o[a]}else 0===o[a].indexOf('"')?s[n[a]]=o[a].slice(1,o[a].length-1).replace(/\"\"/gim,'"'):s[n[a]]=o[a];return t?t(s):s}}else n=e.split(",").map(function(e){return e.substring(1,e.length-1)})}).filter(function(e){return e})},e.prototype.loadCSV=function(e,t,r,i){var a=this,s=this.state.selectedTable;if("string"!=typeof s)return Promise.reject("nSQL: Can't load CSV into temporary table!");var u=this.CSVtoJSON(e,t),c=i?o.allAsync:o.chainAsync,l=0;return c(u,function(e,t,i,c){a.triggerQuery(n({},o.buildQuery(a,s,"upsert"),{actionArgs:e}),o.noop,function(){l++,r&&r(Math.round(l/u.length*1e4)/100),i()},c||o.noop)})},e}();t.nanoSQL=h,t.nSQLv1Config=function(e){var t={},r={},i="",o=function(e){return(i=e||i)&&!t[i]&&(t[i]={name:i,model:{},indexes:{},actions:[],views:[]}),{model:function(r){var n={};return t[i].model=r.reduce(function(e,t){var r=t.key+":"+t.type;return e[r]={},t.props&&(-1!==t.props.indexOf("pk")&&(e[r].pk=!0),-1!==t.props.indexOf("ai")&&(e[r].ai=!0),n&&-1!==t.props.indexOf("idx")&&(n[r]={})),e},{}),t[i].indexes=n,o(e)},actions:function(r){return t[i].actions=r,o(e)},views:function(r){return t[i].views=r,o(e)},config:function(t){return r=t,o(e)},table:function(e){return o(e)},rowFilter:function(r){return t[i].filter=r,o(e)}}};return e(o),n({},r,{tables:Object.keys(t).map(function(e){return t[e]})})};var p=new h;t.nSQL=function(e){return p.selectTable(e)},"undefined"!=typeof window&&(window["@nano-sql"]||(window["@nano-sql"]={}),window["@nano-sql"].core={nSQL:t.nSQL,nanoSQL:h,utilities:l,nSQLv1Config:t.nSQLv1Config})},function(e,t){Object.defineProperty(t,"e",{value:!0});var r=function(){function e(){this.eventListeners={}}return e.prototype.on=function(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)},e.prototype.off=function(e,t){var r=this;this.eventListeners[e]&&this.eventListeners[e].length&&this.eventListeners[e].forEach(function(n,i){n===t&&r.eventListeners[e].splice(i,1)})},e.prototype.trigger=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this.eventListeners[e]&&this.eventListeners[e].forEach(function(e){return e.apply(void 0,t)})},e}();t.ReallySmallEvents=r,t.RSE=new r},function(e,t,r){Object.defineProperty(t,"e",{value:!0});var n=r(0),i=r(3),o={},a=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];return t.map(function(t){return parseFloat(isNaN(t)?n.getFnValue(e,t):t)})};t.attachDefaultFns=function(e){e.functions={COUNT:{type:"A",aggregateStart:{result:0,row:{}},call:function(e,t,r,i){return i&&"*"!==i?n.getFnValue(t,i)&&r.result++:r.result++,r.row=t,r}},MAX:{type:"A",aggregateStart:{result:void 0,row:{}},call:function(e,t,r,i){var o=n.getFnValue(t,i)||0;return void 0===r.result?(r.result=o,r.row=t):o>r.result&&(r.result=o,r.row=t),r}},MIN:{type:"A",aggregateStart:{result:void 0,row:{}},call:function(e,t,r,i){var o=n.getFnValue(t,i)||0;return void 0===r.result?(r.result=o,r.row=t):o<r.result&&(r.result=o,r.row=t),r}},GREATEST:{type:"S",call:function(e,t,r){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return{result:i.map(function(e){return isNaN(e)?n.getFnValue(t,e):parseFloat(e)}).sort(function(e,t){return e<t?1:-1})[0]}}},LEAST:{type:"S",call:function(e,t,r){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return{result:i.map(function(e){return isNaN(e)?n.getFnValue(t,e):parseFloat(e)}).sort(function(e,t){return t<e?1:-1})[0]}}},AVG:{type:"A",aggregateStart:{result:0,row:{},total:0,records:0},call:function(e,t,r,i){var o=parseFloat(n.getFnValue(t,i)||0)||0;return r.total+=isNaN(o)?0:o,r.records++,r.result=r.total/r.records,r.row=t,r}},SUM:{type:"A",aggregateStart:{result:0,row:{}},call:function(e,t,r,i){var o=parseFloat(n.getFnValue(t,i)||0)||0;return r.result+=isNaN(o)?0:o,r.row=t,r}},ADD:{type:"S",call:function(e,t,r){for(var n=[],i=3;i<arguments.length;i++)n[i-3]=arguments[i];return{result:a(t,n).reduce(function(e,t,r){return 0===r?t:e+t})}}},SUB:{type:"S",call:function(e,t,r){for(var n=[],i=3;i<arguments.length;i++)n[i-3]=arguments[i];return{result:a(t,n).reduce(function(e,t,r){return 0===r?t:e-t})}}},DIV:{type:"S",call:function(e,t,r,n){for(var i=[],o=4;o<arguments.length;o++)i[o-4]=arguments[o];return{result:a(t,i).reduce(function(e,t,r){return 0===r?t:e/t})}}},MULT:{type:"S",call:function(e,t,r){for(var n=[],i=3;i<arguments.length;i++)n[i-3]=arguments[i];return{result:a(t,n).reduce(function(e,t,r){return 0===r?t:e*t})}}},MOD:{type:"S",call:function(e,t,r,n,i){var o=a(t,n,i);return{result:o[0]%o[1]}}},PI:{type:"S",call:function(e,t,r){return{result:Math.PI}}},TRUNCATE:{type:"S",call:function(e,t,r,n,i){var o=a(t,n,i),s=o[0],u=o[1];return{result:parseFloat(s.toFixed(u))}}},LOWER:{type:"S",call:function(e,t,r,i){return{result:String(n.getFnValue(t,i)).toLowerCase()}}},TRIM:{type:"S",call:function(e,t,r,i){return{result:String(n.getFnValue(t,i)).trim()}}},UPPER:{type:"S",call:function(e,t,r,i){return{result:String(n.getFnValue(t,i)).toUpperCase()}}},CAST:{type:"S",call:function(e,t,r,i,o){return{result:n.cast(n.getFnValue(t,o),n.getFnValue(t,i),!1,e.parent)}}},CONCAT:{type:"S",call:function(e,t,r){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return{result:i.map(function(e){return n.getFnValue(t,e)}).join("")}}},CONCAT_WS:{type:"S",call:function(e,t,r,i){for(var o=[],a=4;a<arguments.length;a++)o[a-4]=arguments[a];return{result:o.map(function(e){return n.getFnValue(t,e)}).join(n.getFnValue(t,i))}}},REPLACE:{type:"S",call:function(e,t,r,i,o,a){var s=String(n.getFnValue(t,i)),u=String(n.getFnValue(t,o)),c=String(n.getFnValue(t,a));return{result:s.replace(u,c)}}},STRCMP:{type:"S",call:function(e,t,r,i,o){var a=String(n.getFnValue(t,i)),s=String(n.getFnValue(t,o));return a<s?{result:-1}:s<a?{result:1}:{result:0}}},LEVENSHTEIN:{type:"S",call:function(e,t,r,a,s){var u=n.getFnValue(t,a),c=n.getFnValue(t,s),l=u+"::"+c;return o[l]||(o[l]=i(u,c)),{result:o[l]}}},IF:{type:"S",call:function(e,t,r,i,o,a){var s=i.split(/<|=|>|<=|>=/gim).map(function(e){return isNaN(e)?n.getFnValue(t,e):parseFloat(e)}),u=i.match(/<|=|>|<=|>=/gim)[0];if(!u)return{result:n.getFnValue(t,a)};switch(u){case"=":return s[0]==s[1]?n.getFnValue(t,o):n.getFnValue(t,a);case">":return s[0]>s[1]?n.getFnValue(t,o):n.getFnValue(t,a);case"<":return s[0]<s[1]?n.getFnValue(t,o):n.getFnValue(t,a);case"<=":return s[0]<=s[1]?n.getFnValue(t,o):n.getFnValue(t,a);case">=":return s[0]<s[1]?n.getFnValue(t,o):n.getFnValue(t,a);default:return{result:n.getFnValue(t,a)}}}},CROW:{type:"S",call:function(t,r,i,o,a,s){var u=n.getFnValue(r,o+".lat"),c=n.getFnValue(r,o+".lon");return{result:n.crowDistance(u,c,parseFloat(a),parseFloat(s),e.planetRadius)}},checkIndex:function(t,r,i){if("<"===i[1]||"<="===i[1]){var o="string"==typeof t.table?e.u[t.table].indexes:{},a=n.resolvePath(r[0]),s=[];if(Object.keys(o).forEach(function(e){var t=o[e];"float"===t.type&&n.objectsEqual(t.path.slice(0,t.path.length-1),a)&&s.push(e.replace(".lat","").replace(".lon",""))}),2===s.length)return{index:s[0],parsedFn:{name:"CROW",args:r},comp:i[1],value:i[2]}}return!1},queryIndex:function(t,r,i,o,a,s){var u=t.table,c=r.index+".lat",l=r.index+".lon",f=r.comp,h=parseFloat(r.value||"0"),p=parseFloat(r.parsedFn?r.parsedFn.args[1]:"0"),d=parseFloat(r.parsedFn?r.parsedFn.args[2]:"0"),y=h/(2*e.planetRadius*Math.PI)*360,g=[-1,1].map(function(e){return p+y*e}),v=[],b=[],m=!1,S=Math.max(90-y,0);if(Math.abs(g[0])>S||Math.abs(g[1])>S)m=!0,g[0]<-1*S&&(g=[-90,g[1]]),g[1]>S&&(g=[g[0],90]);else{var w=Math.max(Math.abs(g[0]),Math.abs(g[1]));if(v=[-1,1].map(function(e){return d+y*e/Math.cos(n.deg2rad(w))}),180<Math.abs(v[0])){var q=Math.abs(v[0])-180;b=[180-q,180]}180<Math.abs(v[1])&&(q=Math.abs(v[1])-180,b=[-180,-180+q])}var x={};n.allAsync([c,l,l],function(r,i,o,a){var s=[g,v,b][i];s.length?n.adapterFilters(e,t).readIndexKeys(u,r,"range",s[0],s[1],!1,function(e,t){x[e]?x[e].num++:x[e]={key:e,lat:0,lon:0,num:0},0===i?x[e].lat=t-90:x[e].lon=t-180},function(){o(null)},a):o(null)}).then(function(){var u=0,c=(m?Object.keys(x):Object.keys(x).filter(function(t){if(x[t].num<1)return!1;var r=n.crowDistance(x[t].lat,x[t].lon,p,d,e.planetRadius);return"<"===f?r<h:r<=h})).map(function(e){return x[e]});m||!i?n.allAsync(c,function(a,s,c,l){n.adapterFilters(t.parent,t).read(t.table,a.key,function(a){if(a){if(!m)return o(a,s),void c(null);var l=n.deepGet((r.parsedFn?r.parsedFn.args[0]:"")+".lat",a),y=n.deepGet((r.parsedFn?r.parsedFn.args[0]:"")+".lon",a),g=n.crowDistance(l,y,p,d,e.planetRadius);("<"===f?g<h:g<=h)&&(o(i?n.deepGet(e.u[t.table].pkCol,a):a,u),u++),c(null)}else c(null)},l)}).catch(s).then(function(){a()}):c.forEach(function(e,t){o(e.key,t)})}).catch(s)}}},(Object.getOwnPropertyNames?Object.getOwnPropertyNames(Math):["abs","acos","asin","atan","atan2","ceil","cos","exp","floor","log","max","min","pow","random","round","sin","sqrt","tan"]).forEach(function(t){e.functions[t.toUpperCase()]={type:"S",call:function(e,r,n){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return{result:Math[t].apply(null,a(r,i))}}}})}},function(e,t,r){var n=this&&this.O||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"e",{value:!0});var i=r(1),o=r(0),a=r(5);t.secondaryIndexQueue={};var s={},u=function(){function e(e,t,r,n,i){var o=this;this.nSQL=e,this.query=t,this.progress=r,this.complete=n,this.error=i,this.J=[],this.W=!0,this.Q=[],this.B=!1,this.K=!1,this.V=[],this.H={},this.query.state="processing",this.X=[],this.G=Date.now();var a=t.action.toLowerCase().trim();if(this.Y=this.Y.bind(this),this.$=this.$.bind(this),-1===["select","clone"].indexOf(a)&&"string"!=typeof t.table)return this.query.state="error",void this.error('Only "select" and "clone" queries are available for this resource!');if("string"==typeof t.table&&!this.nSQL.state.connected)return this.query.state="error",void this.error("Can't execute query before the database has connected!");var s=function(e,t){return"string"!=typeof o.query.table?(o.query.state="error",void o.error(o.query.action+" query requires a string table argument!")):e&&!o.query.actionArgs?(o.query.state="error",void o.error(o.query.action+" query requires an additional argument!")):void t()},u=function(){"error"!==o.query.state&&(o.query.state="complete",o.complete())};switch(this.query.cacheID||(this.query.cacheID=this.query.queryID),a){case"select":this.z(u,this.error);break;case"upsert":this.Z(this.progress,this.complete,this.error);break;case"delete":this.tt(this.progress,this.complete,this.error);break;case"show tables":this.nt();break;case"describe":this.it();break;case"describe indexes":this.it("idx");break;case"drop":case"drop table":this.et(this.query.table,u,this.error);break;case"create table":case"create table if not exists":s(!0,function(){o.rt(o.query.actionArgs,!1,r,u,o.error)});break;case"alter table":s(!0,function(){o.rt(o.query.actionArgs,!0,r,u,o.error)});break;case"rebuild indexes":s(!1,function(){o.ot(o.progress,u,o.error)});break;case"conform rows":s(!1,function(){o.ut(o.progress,u,o.error)});break;case"clone":s(!0,function(){o.st(o.progress,u,o.error)});break;default:this.nSQL.doFilter("customQuery",{res:void 0,query:this.query,onRow:r,complete:n,error:i},function(){o.query.state="error",o.error('Query type "'+t.action+'" not supported!')},function(e){o.query.state="error",o.error(e)})}}return e.prototype.st=function(e,t,r){var i=this,s=this.query.actionArgs&&this.query.actionArgs.mode,u=this.query.actionArgs&&this.query.actionArgs.getAdapter,c=this.query.actionArgs&&this.query.actionArgs.id||this.query.parent.state.id;if(c&&s){var l=a.resolveMode(s),f="*"!==this.query.table?[this.query.table]:Object.keys(this.nSQL.u),h={};l.connect(c,function(){o.chainAsync(f,function(t,n,a,s){var u=i.query.parent.u[t];u?l.createTable(i.query.parent.a[u.name],u,function(){h[u.name]=i.query.parent.a[u.name],o.allAsync(Object.keys(u.indexes),function(e,t,r,n){var o=u.indexes[e];l.createIndex(i.query.parent.a[u.name],e,o.type,r,n)}).then(function(){var t=new o.w(function(t,r,n,a){e({target:u.name,targetId:i.query.parent.a[u.name],object:t},r),r++,l.write(i.query.parent.a[u.name],o.deepGet(u.pkCol,t),t,n,a)},r,function(){o.chainAsync(Object.keys(u.indexes),function(t,r,n,a){u.indexes[t],o.adapterFilters(i.query.parent,i.query).readIndexKeys(u.name,t,"all",void 0,void 0,!1,function(n,s){e({target:i.query.parent.a[u.name]+"."+t,targetId:u.name+"."+t,object:{key:s,rowId:n}},r),r++,l.addIndexValue(i.query.parent.a[u.name],t,n,s,o.noop,a)},n,a)}).then(function(){a()}).catch(r)});o.adapterFilters(i.query.parent,i.query).readMulti(u.name,"all",void 0,void 0,!1,function(e,r){t.newItem(e)},function(){t.finished()},r)}).catch(r)},r):s("Table "+u+" not found!")}).then(function(){l.createTable("_util",n({},o.blankTableDefinition,{name:"_util",model:{"key:string":{pk:!0},"value:any":{}}}),function(){l.read("_util","tableIds",function(e){var i=n({},e&&e.value||{},h);l.write("_util","taleIds",{key:"tableIds",value:i},function(){u?(u(l),t()):l.disconnect(function(){t()},r)},r)},r)},r)}).catch(r)},r)}else r("Id & Mode required for clone query!")},e.prototype.ut=function(e,t,r){var n=this,i=this.query.table,a=this.query.actionArgs||function(e){return e};if(this.nSQL.u[i]){var s=new o.w(function(t,a,s,u){var c=n.nSQL.default(t,i);n.nSQL.doFilter("conformRow",{res:c,oldRow:t,query:n.query},function(r){n.ct(n.query.table,t,r.res,function(){var u={target:i,path:"*",events:["upsert","change","*"],time:Date.now(),performance:Date.now()-n.G,result:r.res,oldRow:t,query:n.query,indexes:n.X};n.nSQL.state.hasAnyEvents&&(n.nSQL.triggerEvent(u),Object.keys(n.nSQL.eventFNs[n.query.table]).forEach(function(e){"*"!==e&&(o.objectsEqual(o.deepGet(e,t),o.deepGet(e,r.res))||n.nSQL.triggerEvent({target:n.query.table,path:e,events:["upsert","change","*"],time:Date.now(),performance:Date.now()-n.G,result:r.res,oldRow:t,query:n.query,indexes:n.X},!0))})),n.G=Date.now(),e(n.query.returnEvent?u:r.res,a),s()},u)},r)},r,function(){t()});this.at(function(e,t){s.newItem(a(e))},function(){s.finished()},r)}else r(new Error("Table "+i+" not found for conforming!"))},e.prototype.ft=function(e,t,r,n){var i=this,o=this.query.cacheID;if("function"==typeof r){if(s[o]||(s[o]={}),!s[o][e])return s[o][e]={loading:!0,rows:[],cache:!0},void r(t).then(function(t){var r=t.cache&&!t.filtered||!1;s[o][e]={loading:!1,rows:r?t.rows:[],cache:r},n(t)}).catch(this.$);if(s[o][e].loading)return void setTimeout(function(){i.ft(e,t,r,n)},10);if(s[o][e].cache)return void n({filtered:!1,rows:s[o][e].rows,cache:!0});r(t).then(function(e){n(e)}).catch(this.$)}else n({rows:r,filtered:!1,cache:!1})},e.prototype.ht=function(e,t,r,i){var a,s=this;if(!e[0])return r(t),void i();var u=function(t,i,a){var c=e[i],l=0,f=[];if("cross"!==c.type&&!c.on)return s.query.state="error",void s.error(new Error("Non 'cross' joins require an 'on' parameter!"));var h=new Error("Must use 'AS' when joining temporary tables!");if("string"!=typeof c.with.table&&!c.with.as)return s.query.state="error",void s.error(h);if("string"!=typeof s.query.table&&!s.query.tableAS)return s.query.state="error",void s.error(h);var p=new o.w(function(t,n,o,a){e[i+1]?u(t,i+1,o):(r(t),o())},s.error,a),d="string"==typeof c.with.table?s.nSQL.u[c.with.table].pkCol:[],y=String(c.with.as||c.with.table),g=String(s.query.tableAS||s.query.table);s.nSQL.triggerQuery(n({},o.buildQuery(s.nSQL,c.with.table,"select"),{tableAS:c.with.as,cacheID:s.query.cacheID,where:c.on&&"cross"!==c.type?s.lt(c.on,c.with.as||c.with.table,t):void 0,skipQueue:!0}),function(e){var r;l++,"right"!==c.type&&"outer"!==c.type||f.push(d?o.deepGet(d,e):o.hash(JSON.stringify(e))),p.newItem(n({},t,((r={})[y]=e,r)))},function(){var e,r;switch(c.type){case"left":0===l&&p.newItem(n({},t,((e={})[y]=void 0,e))),p.finished();break;case"inner":case"cross":p.finished();break;case"outer":case"right":0===l&&"outer"===c.type&&p.newItem(n({},t,((r={})[y]=void 0,r))),s.nSQL.triggerQuery(n({},o.buildQuery(s.nSQL,c.with.table,"select"),{skipQueue:!0,cacheID:s.query.cacheID,where:d?[d,"NOT IN",f]:void 0}),function(e){var r;(d||-1===f.indexOf(o.hash(JSON.stringify(e))))&&p.newItem(n({},t,((r={})[g]=void 0,r[y]=e,r)))},function(){p.finished()},function(e){s.query.state="error",s.error(e)})}},function(e){s.query.state="error",s.error(e)})};u(((a={})[String(this.query.tableAS||this.query.table)]=t,a),0,i)},e.prototype.z=function(e,t){var r=this;if(this.vt=this.query.where?this.dt(this.query.where,"string"!=typeof this.query.table||void 0!==this.query.union):{type:i.IWhereType.none},this.pt=this.query.having?this.dt(this.query.having,!0):{type:i.IWhereType.none},this.yt(),"error"!==this.query.state){var n=[this.query.offset||0,(this.query.offset||0)+(this.query.limit||0)],a=0<n[0]+n[1],u={},c=function(e){return(r.query.distinct||[]).reduce(function(t,r){return t+JSON.stringify(o.deepGet(r,e)||{})},"")};if(this.query.union){var l=[],f=[],h=0;o.chainAsync(this.query.union.queries,function(e,t,i){e().then(function(e){f.length||(f=Object.keys(e[0])),r.query.where&&(e=e.filter(function(e,t){return r.gt(e,r.vt.slowWhere)})),e=e.map(function(e){if(r.query.union&&"distinct"===r.query.union.type){var n=o.hash(JSON.stringify(e));if(0===t)l.push(n);else{if(-1!==l.indexOf(n))return;l.push(n)}}return Object.keys(e).reduce(function(t,r,n){return n<f.length&&(t[f[n]]=e[r]),t},{})}).filter(function(e){return e}),r.query.orderBy?r.J=r.J.concat(e.map(function(e){var t=!0;if(r.query.distinct){var n=c(e);u[n]?t=!1:u[n]=!0}var i=r.bt(e);return r.query.having&&!r.gt(i,r.pt.slowWhere)||!t?void 0:i}).filter(function(e){return e})):e.forEach(function(e,t){var i=!0;if(r.query.distinct){var o=c(e);u[o]?i=!1:u[o]=!0}if(i){var s=r.bt(e);(!r.query.having||r.gt(s,r.pt.slowWhere))&&(a?n[0]<=h&&h<n[1]&&r.progress(s,h):r.progress(s,h),h++)}}),i()})}).then(function(){if(r.query.orderBy){var t=r.J.sort(r.Y);(a?t.slice(n[0],n[1]):t).forEach(r.progress)}r.query.cacheID&&r.query.cacheID===r.query.queryID&&delete s[r.query.cacheID],e()})}else{var p=Array.isArray(this.query.join)?this.query.join:[this.query.join],d=0,y=new o.w(function(e,t,n,i){if(r.query.graph)r.wt(r.query.graph||[],r.query.tableAS||r.query.table,e,g,function(t,i){var o=!0;if(r.query.distinct){var a=c(t);u[a]?o=!1:u[a]=!0}if(!o)return d++,void n();var s=r.bt(t);r.query.having?r.gt(r.bt(e),r.pt.slowWhere)&&r.progress(s,d):r.progress(s,d),d++,n()});else{var o=!0;if(r.query.distinct){var a=c(e);u[a]?o=!1:u[a]=!0}if(!o)return d++,void n();r.progress(r.bt(e),d),d++,n()}},this.$,function(){r.query.cacheID&&r.query.cacheID===r.query.queryID&&delete s[r.query.cacheID],e()}),g=0,v=new o.w(function(e,t,i,o){r.ht(p,e,function(e){r.W?((!a||n[0]<=g&&g<n[1])&&y.newItem(e),g++):r.J.push(e)},i)},this.error,function(){r.W?y.finished():o.allAsync(r.J,function(e,t,n){r.wt(r.query.graph||[],r.query.tableAS||r.query.table,e,t,n)}).then(function(t){r.J=t,r.mt(),r.query.having&&(r.J=r.J.filter(function(e){return r.gt(e,r.pt.slowWhere)})),r.query.orderBy&&!r.St&&r.J.sort(r.Y),a&&(r.J=r.J.slice(n[0],n[1])),r.J.forEach(function(e,t){var n=!0;if(r.query.distinct){var i=c(e);u[i]?n=!1:u[i]=!0}n&&r.progress(e,t)}),r.query.cacheID&&r.query.cacheID===r.query.queryID&&delete s[r.query.cacheID],e()})}),b="string"==typeof this.query.table;this.at(function(e,t){var n={target:r.query.table,path:"_all_",events:["select","*"],time:Date.now(),performance:Date.now()-r.G,result:e,query:r.query,indexes:r.X};b&&r.nSQL.triggerEvent(n),r.G=Date.now(),r.query.returnEvent?r.progress(n,t):v.newItem(e)},function(){r.query.returnEvent?e():v.finished()},t)}}},e.prototype.mt=function(){var e=this;this.query.groupBy||this.Et?(this.J.sort(function(t,r){return e.Ot(t,r,e._t)}).forEach(function(t,r){var n=e._t.sort.map(function(r){return String(r.fn?o.execFunction(e.query,r.fn,t,{result:void 0}).result:o.deepGet(r.path,t))}).join(".");void 0===e.H[n]&&(e.H[n]=e.V.length);var i=e.H[n];e.V[i]||e.V.push([]),e.V[i].push(t)}),this.query.orderBy&&(this.St=!0,this.V=this.V.map(function(t){return t.sort(function(t,r){return e.Ot(t,r,e.Nt)})})),this.J=[],this.Et?this.V.forEach(function(t){var r=e.Q.reduce(function(t,r,n){var i=r.value.split("(").shift();return r.isFn&&e.nSQL.functions[i]&&"A"===e.nSQL.functions[i].type&&(t[n]={idx:n,name:r.value,aggr:o.assign(e.nSQL.functions[i].aggregateStart)}),t},[]),n=r.filter(function(e){return e})[0];t.reverse().forEach(function(t,n){r.forEach(function(n,i){n&&(r[i].aggr=o.execFunction(e.query,r[i].name,t,r[i].aggr))})}),e.J.push(e.Q.reduce(function(t,i,a){var s=i.value;return t[i.as||s]=i.isFn&&r[a]?r[a].aggr.result:i.isFn?o.execFunction(e.query,i.value,r[n.idx].aggr.row,{result:void 0}).result:o.deepGet(i.value,r[n.idx].aggr.row),t},{}))}):this.V.forEach(function(t){e.J.push(e.bt(t.shift()))})):this.J=this.J.map(function(t){return e.bt(t)})},e.prototype.lt=function(e,t,r){var n=this;return"function"==typeof e?function(t){return e(t,r)}:("string"==typeof e[0]?[e]:e).map(function(e){if(Array.isArray(e[0]))return n.lt(e,t,r);if("AND"===e||"OR"===e)return e;var i=o.resolvePath(e[0]),a=o.resolvePath(e[2]),s=i[0]!==t;return[s?a.slice(1).join("."):i.slice(1).join("."),s?-1!==e[1].indexOf(">")?e[1].replace(">","<"):e[1].replace("<",">"):e[1],o.deepGet(s?i:a,r)]})},e.prototype.wt=function(e,t,r,i,a){var s=this,u=Array.isArray(e)?e:[e];u&&0!==u.length?o.allAsync(u,function(e,i,a){var u,c=new Error("Must use 'AS' when graphing temporary tables!");if("string"!=typeof e.with.table&&!e.with.as)return s.query.state="error",void s.error(c);if("string"!=typeof s.query.table&&!s.query.tableAS)return s.query.state="error",void s.error(c);r[e.key]=[];var l=s.lt(e.on,e.with.as||e.with.table,((u={})[t]=r,u));s.ft(e.with.as||e.with.table,l,e.with.table,function(t){t.filtered?(t.rows.forEach(function(t){e.single?r[e.key]=t:r[e.key].push(t)}),a(null)):s.nSQL.triggerQuery(n({},o.buildQuery(s.nSQL,t.rows,"select"),{tableAS:e.with.as,actionArgs:e.select,where:l,limit:e.limit,offset:e.offset,orderBy:e.orderBy,groupBy:e.groupBy,graph:e.graph,skipQueue:!0,cacheID:s.query.cacheID}),function(t){e.single?r[e.key]=t:r[e.key].push(t)},function(){a(null)},s.$)})}).then(function(){a(r,i)}):a(r,i)},e.prototype.Z=function(e,t,r){var n=this;if(this.query.actionArgs||(r("Can't upsert without records!"),this.query.state="error"),-1!==this.query.table.indexOf(".")||-1!==this.query.table.indexOf("[")){var a=o.resolvePath(this.query.table);this.query.table=a.shift(),this.upsertPath=a}if(this.vt=this.query.where?this.dt(this.query.where):{type:i.IWhereType.none},"error"!==this.query.state){var s=Array.isArray(this.query.actionArgs)?this.query.actionArgs:[this.query.actionArgs],u=this.nSQL.u[this.query.table];if(this.vt.type===i.IWhereType.none)o.allAsync(s,function(t,r,i,a){var s=o.deepGet(u.pkCol,t);s?o.adapterFilters(n.nSQL,n.query).read(n.query.table,s,function(o){o?n.It(t,o,function(t){e(t,r),i(null)},a):n.Tt(t,function(t){e(t,r),i(null)},a)},a):n.Tt(t,function(t){e(t,r),i(null)},a)}).then(function(){t()}).catch(this.$);else{if(1<s.length)return this.query.state="error",void r("Cannot upsert multiple records with where condition!");var c=new o.w(function(t,r,i,o){n.It(s[0],t,function(t){e(t,r),i()},o)},r,function(){t()});this.at(function(e,t){c.newItem(e)},function(){c.finished()},r)}}},e.prototype.It=function(e,t,r,i){var a=this;this.nSQL.doFilter("updateRow",{res:e,row:t,query:this.query},function(e){var s=a.nSQL.default(a.upsertPath?o.deepSet(a.upsertPath,o.maybeAssign(t),e.res):n({},t,e.res),a.query.table);a.ct(a.query.table,t,s,function(){var e={target:a.query.table,path:"*",events:["upsert","change","*"],time:Date.now(),performance:Date.now()-a.G,result:s,oldRow:t,query:a.query,indexes:a.X};a.nSQL.doFilter("updateRowEvent",{res:e,query:a.query},function(e){"string"==typeof a.query.table&&(a.nSQL.triggerEvent(e.res),a.nSQL.eventFNs[a.query.table]&&Object.keys(a.nSQL.eventFNs[a.query.table]).forEach(function(e){"*"!==e&&(o.objectsEqual(o.deepGet(e,t),o.deepGet(e,s))||a.nSQL.triggerEvent({target:a.query.table,path:e,events:["upsert","change","*"],time:Date.now(),performance:Date.now()-a.G,result:s,oldRow:t,query:a.query,indexes:a.X},!0))}),a.G=Date.now()),r(a.query.returnEvent?e.res:s)},i)},i)},i)},e.prototype.jt=function(e,t,r,n,i,a){var s=this;o.allAsync(Object.keys(n),function(i,a,u,c){var l=s.nSQL.u[s.query.table].indexes[i].props||{};if(l&&l.unique){var f=[];o.adapterFilters(s.nSQL,s.query).readIndexKey(e,i,n[i],function(e){e!==t&&f.push(e)},function(){0<f.length?c({error:"Unique Index Collision!",row:r,query:s.query}):u(null)},c)}else u(null)}).then(i).catch(a)},e.prototype.ct=function(e,t,r,n,i){var a=this,s=this.At(this.nSQL.u[this.query.table].indexes,r),u=this.At(this.nSQL.u[this.query.table].indexes,t),c=this.nSQL.u[e];this.jt(e,o.deepGet(c.pkCol,t),t,s,function(){o.allAsync(Object.keys(u).concat(["__pk__"]),function(t,n,i,l){if("__pk__"===t)o.adapterFilters(a.nSQL,a.query).write(e,o.deepGet(c.pkCol,r),r,function(e){o.deepSet(c.pkCol,r,e),i(null)},l);else{var f=a.query.table;if(!1===o.objectsEqual(s[t],u[t]))if(c.indexes[t].isArray){var h=s[t].filter(function(e,r,n){return-1===u[t].indexOf(e)}),p=u[t].filter(function(e,r,n){return-1===s[t].indexOf(e)});o.allAsync([h,p],function(e,n,i){e.length?o.allAsync(e,function(e,i,s){a.xt(f,t,e,o.deepGet(c.pkCol,r),0===n,function(){s(null)},l)}).then(i):i(null)}).then(i)}else o.chainAsync(["rm","add"],function(e,n,i){switch(e){case"add":a.xt(f,t,s[t],o.deepGet(c.pkCol,r),!0,function(){i(null)},l);break;case"rm":a.xt(f,t,u[t],o.deepGet(c.pkCol,r),!1,function(){i(null)},l)}}).then(i);else i(null)}}).then(n).catch(i)},i)},e.prototype.xt=function(e,r,n,i,a,s,u){var c=this,l={table:e,indexName:r,value:n,pk:i,addToIndex:a,done:s,err:u,query:this.query,nSQL:this.nSQL};this.nSQL.doFilter("updateIndex",{res:l,query:this.query},function(e){t.secondaryIndexQueue[c.nSQL.state.id+e.res.indexName].newItem(e.res,function(e,t,r){(e.addToIndex?o.adapterFilters(e.nSQL,e.query).addIndexValue:o.adapterFilters(e.nSQL,e.query).deleteIndexValue)(e.table,e.indexName,e.pk,e.value,function(){e.done(),t()},function(r){e.err(r),t()})})},u)},e.prototype.Tt=function(e,t,r){var n=this;this.nSQL.doFilter("addRow",{res:e,query:this.query},function(e){var i=n.nSQL.u[n.query.table];e.res=n.nSQL.default(o.maybeAssign(n.upsertPath?o.deepSet(n.upsertPath,{},e.res):e.res),n.query.table);var a=n.At(n.nSQL.u[n.query.table].indexes,e.res);n.jt(n.query.table,o.deepGet(i.pkCol,e.res),e.res,a,function(){o.adapterFilters(n.nSQL,n.query).write(n.query.table,o.deepGet(i.pkCol,e.res),e.res,function(s){o.deepSet(i.pkCol,e.res,s),o.allAsync(Object.keys(a),function(t,r,s,u){if(i.indexes[t].isArray){var c=a[t]||[];o.allAsync(c,function(r,a,s){n.xt(n.query.table,t,r,o.deepGet(i.pkCol,e.res),!0,function(){s(null)},u)}).then(function(){s(null)}).catch(u)}else n.xt(n.query.table,t,a[t],o.deepGet(i.pkCol,e.res),!0,function(){s(null)},u)}).then(function(){var i={target:n.query.table,path:"*",events:["upsert","change","*"],time:Date.now(),performance:Date.now()-n.G,result:e.res,oldRow:void 0,query:n.query,indexes:n.X};n.nSQL.doFilter("addRowEvent",{res:i,query:n.query},function(r){"string"==typeof n.query.table&&n.nSQL.triggerEvent(r.res),n.G=Date.now(),t(n.query.returnEvent?r.res:e.res)},r)})},r)},r)},r)},e.prototype.tt=function(e,t,r){var a=this;if(this.vt=this.query.where?this.dt(this.query.where):{type:i.IWhereType.none},"error"!==this.query.state){var s=this.nSQL.u[this.query.table],u=new o.w(function(t,r,u,c){new Promise(function(e,r){var s=a.query.table;a.nSQL.I[s]&&a.nSQL.I[s].length?o.allAsync(a.nSQL.I[s],function(e,r,s,u){var c=o.deepGet(e.selfPath,t),l=o.cast("any[]",e.selfIsArray?c:[c]);o.allAsync(l,function(t,r,c,l){switch(e.onDelete){case i.InanoSQLFKActions.RESTRICT:var f=0;o.adapterFilters(a.nSQL,a.query).readIndexKey(e.childTable,e.childIndex,t,function(e){f++},function(){0<f?l("Foreign key restraint error, can't delete!"):c()},u);break;case i.InanoSQLFKActions.CASCADE:var h=[];o.adapterFilters(a.nSQL,a.query).readIndexKey(e.childTable,e.childIndex,t,function(e){h.push(e)},function(){a.nSQL.triggerQuery(n({},o.buildQuery(a.nSQL,e.childTable,"delete"),{where:[e.childPath.join("."),e.childIsArray?"INCLUDES":"IN",h]}),o.noop,c,l)},u);break;case i.InanoSQLFKActions.SET_NULL:var p=[];o.adapterFilters(a.nSQL,a.query).readIndexKey(e.childTable,e.childIndex,t,function(e){p.push(e)},function(){var t;a.nSQL.triggerQuery(n({},o.buildQuery(a.nSQL,e.childTable,"upsert"),{actionArgs:(t={},t[e.childPath.join(".")]=null,t),where:[e.childPath.join("."),e.childIsArray?"INCLUDES":"IN",h]}),o.noop,c,l)},u);break;default:s()}}).then(s).catch(u)}).then(e).catch(r):e()}).then(function(){a.kt(s,t,function(t){e(t,r),u()},c)}).catch(c)},r,function(){t()});this.at(function(e,t){u.newItem(e)},function(){u.finished()},r)}},e.prototype.kt=function(e,t,r,n){var i=this,a=this.At(e.indexes,t);this.nSQL.doFilter("deleteRow",{res:t,query:this.query},function(t){o.allAsync(Object.keys(a).concat(["__del__"]),function(r,s,u){if("__del__"===r)o.adapterFilters(i.nSQL,i.query).delete(i.query.table,o.deepGet(e.pkCol,t.res),function(){u(null)},function(e){i.query.state="error",n(e)});else if(e.indexes[r].isArray){var c=a[r]||[];o.allAsync(c,function(a,s,u){i.xt(i.query.table,r,a,o.deepGet(e.pkCol,t.res),!1,function(){u(null)},n)}).then(u)}else i.xt(i.query.table,r,a[r],o.deepGet(e.pkCol,t.res),!1,function(){u(null)},i.$)}).then(function(){var e={target:i.query.table,path:"_all_",events:["change","delete","*"],time:Date.now(),performance:Date.now()-i.G,result:t.res,query:i.query,indexes:i.X};i.nSQL.doFilter("deleteRowEvent",{res:e,query:i.query},function(e){"string"==typeof i.query.table&&i.nSQL.triggerEvent(e.res),i.G=Date.now(),r(i.query.returnEvent?e.res:t.res)},n)}).catch(n)},n)},e.prototype.At=function(e,t){var r=this;return Object.keys(e).reduce(function(n,i){var a=o.deepGet(e[i].path,t),s=e[i].type;return n[i]=e[i].isArray?(Array.isArray(a)?a:[]).map(function(e){return r.nSQL.indexTypes[s](e)}):r.nSQL.indexTypes[s](a),n},{})},e.prototype.nt=function(){var e=this;Object.keys(this.nSQL.u).forEach(function(t,r){e.progress({table:t},r)}),this.complete()},e.prototype.it=function(e){var t=this;if(void 0===e&&(e="table"),"string"!=typeof this.query.table)return this.query.state="error",void this.error({error:"Can't call describe on that!",query:this.query});if(!this.nSQL.u[this.query.table])return this.query.state="error",void this.error({error:"Table "+this.query.table+" not found!",query:this.query});switch(e){case"table":this.nSQL.u[this.query.table].columns.forEach(function(e,r){t.progress(o.assign(e),r)});break;case"idx":Object.keys(this.nSQL.u[this.query.table].indexes).forEach(function(e,r){var n=t.nSQL.u[t.query.table].indexes[e];t.progress(o.assign(n),r)})}this.complete()},e.prototype.Dt=function(e){return Object.keys(e).reduce(function(t,r){var n=e[r];return n&&Object.keys(n).forEach(function(e){t[r+"."+e]=n[e]}),t},{})},e.prototype.bt=function(e){var t=this,r=(this.query.distinct||[]).map(function(e){return{isFn:!1,value:e}}),n=(this.Q||[]).concat(r);if(n.length){var i={};return n.forEach(function(r){r.isFn?i[r.as||r.value]=o.execFunction(t.query,r.value,e,{}).result:i[r.as||r.value]=o.deepGet(r.value,e)}),this.query.join?this.Dt(i):i}return this.query.join?this.Dt(e):e},e.prototype.Y=function(e,t){return this.Ot(e,t,this.Nt)},e.prototype.Ot=function(e,t,r){var n=this,i="string"==typeof this.query.table?this.nSQL.u[this.query.table].pkCol:[],a=!!i.length&&o.deepGet(i,e),s=!!i.length&&o.deepGet(i,t);return r.sort.reduce(function(r,i){var u=i.fn?o.execFunction(n.query,i.fn,e,{result:void 0}).result:o.deepGet(i.path,e),c=i.fn?o.execFunction(n.query,i.fn,t,{result:void 0}).result:o.deepGet(i.path,t);return r||(u===c?a===s?0:s<a?1:-1:(c<u?1:-1)*("DESC"===i.dir?-1:1))},0)},e.prototype.Rt=function(){return[0,1].map(function(){for(var e=o.random16Bits().toString(16);e.length<4;)e="0"+e;return e}).join("-")},e.prototype.rt=function(e,r,i,s,u){var c=this,l=this.nSQL.a[e.name]||this.Rt();r||-1===Object.keys(this.nSQL.u).indexOf(e.name)||(r=!0),new Promise(function(t,r){var n=!1,i=e.name;e.C||0!==i.indexOf("_")&&null===i.match(/\s/g)&&null===i.match(/[\(\)\]\[\.]/g)?(Object.keys(e.model).forEach(function(t){var i=t.replace(/\s+/g,"-").split(":");1===i.length&&i.push("any"),i[0]&&null===i[0].match(/[\(\)\]\[\.]/g)&&0!==i[0].indexOf("_")||(n=!0,r({error:"Invalid Data Model at "+e.name+"."+t+"! https://docs.nanosql.io/setup/data-models",query:c.query}))}),n||t()):r({error:"Invalid Table Name "+e.name+"! https://docs.nanosql.io/setup/data-models",query:c.query})}).then(function(){return new Promise(function(t,r){c.nSQL.doFilter("configTable",{res:e,query:c.query},t,r)})}).then(function(e){var t=function(e,r){if("string"==typeof e){var i=!1,o=-1!==e.indexOf("[]"),a=e.replace(/\[\]/gim,"");if(0===r&&o)throw new Error("Can't use array types as table definition.");if(Object.keys(c.nSQL.config.types||{}).reduce(function(e,t){return t===a[1]?(i=!0,(c.nSQL.config.types||{})[t]):e},{}),!1===i){if(0===r)throw new Error("Type "+e+" not found!");return}}return Object.keys(e).reduce(function(i,o){return 0===(o.split(":")[1]||"any").indexOf("geo")?i[o]={default:{lat:0,lon:0},model:{"lat:float":{max:90,min:-90},"lon:float":{max:180,min:-180}}}:e[o].model?i[o]=n({},e[o],{model:t(e[o].model,r+1)}):i[o]=e[o],i},{})},r=function(e){return Object.keys(e).filter(function(e){return"*"!==e}).map(function(t){return{key:t.split(":")[0],type:t.split(":")[1]||"any",ai:e[t].ai,pk:e[t].pk,default:e[t].default,notNull:e[t].notNull,max:e[t].max,min:e[t].min,model:e[t].model?r(e[t].model):void 0}})},i="",s=t(e.res.model,0),u=function(e){return"string"==typeof e?"":Object.keys(e).reduce(function(t,r){return e[r]&&e[r].pk?r.split(":")[1]:!t.length&&e[r].model?u(e[r].model):t},"")},f=e.res.indexes||{},h=!1,p=function(e,t){if("string"==typeof t)return[];var r=!1;return Object.keys(t).reduce(function(n,i){return t[i]&&t[i].pk?(r=!0,t[i].ai&&(h=!0),n.push(i.split(":")[0]),n):!r&&t[i].model?p(e.concat([i.split(":")[0]]),t[i].model):n},e)},d=e.res.primaryKey?e.res.primaryKey.split(":")[1]:u(e.res.model),y={id:l,name:e.res.name,mode:e.res.mode?a.resolveMode(e.res.mode):void 0,model:s,columns:r(s),filter:e.res.filter,actions:e.res.actions||[],views:e.res.views||[],queries:(e.res.queries||[]).reduce(function(e,t){return e[t.name]=t,e},{}),indexes:Object.keys(f).map(function(e){return{id:o.resolvePath(e.split(":")[0]).join("."),type:(e.split(":")[1]||"string").replace(/\[\]/gim,""),isArray:-1!==(e.split(":")[1]||"string").indexOf("[]"),path:o.resolvePath(e.split(":")[0]),props:f[e]}}).reduce(function(e,t){return-1===Object.keys(c.nSQL.indexTypes).indexOf(t.type)?i='Index "'+t.id+'" does not have a valid type!':-1!==t.type.indexOf("geo")?(e[t.id+".lon"]={id:t.id+".lon",type:"float",isArray:!1,path:t.path.concat(["lon"]),props:{offset:180}},e[t.id+".lat"]={id:t.id+".lat",type:"float",isArray:!1,path:t.path.concat(["lat"]),props:{offset:90}}):e[t.id]=t,e},{}),pkType:d,pkCol:e.res.primaryKey?o.resolvePath(e.res.primaryKey.split(":")[0]):p([],e.res.model),isPkNum:-1!==["number","int","float","date"].indexOf(d),ai:h};return 0===y.pkCol.length&&(y.pkCol=["_id"],y.pkType="uuid",y.model.Mt={pk:!0},y.columns=r(t(y.model,0))),i&&i.length?Promise.reject(i):new Promise(function(e,t){c.nSQL.doFilter("configTableSystem",{res:y,query:c.query},function(t){e(t.res)},t)})}).then(function(e){var t=c.nSQL.u[c.query.table]&&c.nSQL.u[c.query.table].mode;return e.mode||t?new Promise(function(n,i){if(r&&e.mode===t)n(e);else{var o=function(){e.mode?e.mode.connect(c.nSQL.state.id,function(){n(e)},i):n(e)};t?t.disconnect(function(){o()},i):o()}}):Promise.resolve(e)}).then(function(e){var n=r?Object.keys(c.nSQL.u[c.query.table].indexes):[],a=Object.keys(e.indexes),s=a.filter(function(e){return-1===n.indexOf(e)}),u=[e.name].concat(s);return i(e,0),o.chainAsync(u,function(i,s,u,l){if(0===s){var f={name:i,conf:e};if(c.nSQL.a[f.name]=e.id,r){delete c.nSQL.a[c.query.table];var h=n.filter(function(e){return-1===a.indexOf(e)});o.allAsync(h,function(e,t,r,n){o.adapterFilters(c.nSQL,c.query).deleteIndex(i,e,function(){r(null)},n)}).then(function(){c.nSQL.u[f.name]=f.conf,u(null)}).catch(l)}else o.adapterFilters(c.nSQL,c.query).createTable(f.name,f.conf,function(){c.nSQL.u[f.name]=f.conf,u(null)},l)}else{var p=e.indexes[i];t.secondaryIndexQueue[c.nSQL.state.id+p.id]=new o.w,o.adapterFilters(c.nSQL,c.query).createIndex(e.name,p.id,p.type,function(){u(null)},l)}})}).then(function(){return c.nSQL.k(),"_util"===c.query.table?Promise.resolve():c.nSQL.M()}).then(function(){s()}).catch(u)},e.prototype.et=function(e,t,r){var a=this,s=[e];Object.keys(this.nSQL.u[e].indexes).forEach(function(e){s.push(e)}),new Promise(function(t,r){a.nSQL.I[e]&&a.nSQL.I[e].length?o.allAsync(a.nSQL.I[e],function(e,t,r,s){switch(e.onDelete){case i.InanoSQLFKActions.RESTRICT:var u=0;o.adapterFilters(a.nSQL,a.query).readIndexKeys(e.childTable,e.childIndex,"offset",0,1,!1,function(e,t){u++},function(){0<u?s("Foreign key restraint error, can't drop!"):r()},s);break;case i.InanoSQLFKActions.CASCADE:var c=[];o.adapterFilters(a.nSQL,a.query).readIndexKeys(e.childTable,e.childIndex,"all",0,0,!1,function(e,t){c.push(e)},function(){a.nSQL.triggerQuery(n({},o.buildQuery(a.nSQL,e.childTable,"delete"),{where:[e.childPath.join("."),e.childIsArray?"INCLUDES":"IN",c]}),o.noop,r,s)},s);break;case i.InanoSQLFKActions.SET_NULL:var l=[];o.adapterFilters(a.nSQL,a.query).readIndexKeys(e.childTable,e.childIndex,"all",0,0,!1,function(e,t){l.push(e)},function(){var t;a.nSQL.triggerQuery(n({},o.buildQuery(a.nSQL,e.childTable,"upsert"),{actionArgs:(t={},t[e.childPath.join(".")]=null,t),where:[e.childPath.join("."),e.childIsArray?"INCLUDES":"IN",c]}),o.noop,r,s)},s);break;default:r()}}).then(t).catch(r):t()}).then(function(){return o.allAsync(s,function(t,r,n,i){0===r?o.adapterFilters(a.nSQL,a.query).dropTable(t,function(){delete a.nSQL.u[t],delete a.nSQL.a[t],a.nSQL.M().then(function(){n(t)}).catch(i)},i):o.adapterFilters(a.nSQL,a.query).deleteIndex(e,t,n,i)}).then(function(){t()})}).catch(r)},e.prototype.$=function(e){this.query.state="error",this.error(e)},e.prototype.Ct=function(e,t,r,n,i){var a=this;if(t.index&&t.parsedFn)this.nSQL.functions[t.parsedFn.name].queryIndex(this.query,t,e,n,i,this.$);else{var s="_pk_"===t.index,u=this.nSQL.u[this.query.table].pkCol,c=0,l=new o.w(function(t,r,i,l){t?s?(n(e?o.deepGet(u,t):t,0),i()):e?(n(t,c),c++,i()):o.adapterFilters(a.nSQL,a.query).read(a.query.table,t,function(e){e&&n(e,c),c++,i()},a.error):i()},this.$,i);if(t.indexArray)switch(t.comp){case"INCLUDES LIKE":o.adapterFilters(this.nSQL,this.query).readIndexKeys(this.query.table,t.index,"range",t.value.replace(/\%/gim,"")+" ",t.value.replace(/\%/gim,"")+"~",r,function(e){l.newItem(e)},function(){l.finished()},this.$);break;case"INCLUDES":o.adapterFilters(this.nSQL,this.query).readIndexKey(this.query.table,t.index,t.value,function(e){l.newItem(e)},function(){l.finished()},this.error);break;case"INTERSECT ALL":case"INTERSECT":var f={},h=0;o.allAsync(t.value||[],function(e,r,n){o.adapterFilters(a.nSQL,a.query).readIndexKey(a.query.table,t.index,e,function(e){h=r+1,e&&(f[e]=(f[e]||0)+1)},function(){n(null)},a.error)}).then(function(){("INTERSECT"===t.comp?Object.keys(f):Object.keys(f).filter(function(e){return f[e]===h})).forEach(function(e){l.newItem(e)}),l.finished()})}else switch(t.comp){case"=":e&&s?(n(t.value,0),i()):s?o.adapterFilters(this.nSQL,this.query).read(this.query.table,t.value,function(e){l.newItem(e),l.finished()},this.error):o.adapterFilters(this.nSQL,this.query).readIndexKey(this.query.table,t.index,t.value,function(e){l.newItem(e)},function(){l.finished()},this.error);break;case"LIKE":s?o.adapterFilters(this.nSQL,this.query).readMulti(this.query.table,"range",t.value.replace(/\%/gim,"")+"0",t.value.replace(/\%/gim,"")+"Z",r,function(e,t){l.newItem(e)},function(){l.finished()},this.$):o.adapterFilters(this.nSQL,this.query).readIndexKeys(this.query.table,t.index,"range",t.value.replace(/\%/gim,"")+" ",t.value.replace(/\%/gim,"")+"~",r,function(e){l.newItem(e)},function(){l.finished()},this.$);break;case"BETWEEN":s?o.adapterFilters(this.nSQL,this.query).readMulti(this.query.table,"range",t.value[0],t.value[1],r,function(e,t){l.newItem(e)},function(){l.finished()},this.$):o.adapterFilters(this.nSQL,this.query).readIndexKeys(this.query.table,t.index,"range",t.value[0],t.value[1],r,function(e){l.newItem(e)},function(){l.finished()},this.$);break;case"IN":var p=r?t.value.sort(function(e,t){return e<t?1:-1}):t.value.sort(function(e,t){return t<e?1:-1});e&&s?(p.forEach(function(e,t){return n(e,t)}),i()):o.allAsync(p,function(e,r,n){s?o.adapterFilters(a.nSQL,a.query).read(a.query.table,e,function(e){l.newItem(e),n()},a.error):o.adapterFilters(a.nSQL,a.query).readIndexKey(a.query.table,t.index,e,function(e){l.newItem(e)},function(){n()},a.error)}).then(function(){l.finished()})}}},e.prototype.Lt=function(e,t){var r=this;if(this.vt.fastWhere)if(1===this.vt.fastWhere.length){var n=this.vt.fastWhere[0],i=this.B&&"DESC"===this.Nt.sort[0].dir;this.Ct(!1,n,i,function(t,r){e(t,r)},t)}else{var a={},s=0;o.chainAsync(this.vt.fastWhere,function(e,t,n){t%2!=1?(s=t,r.Ct(!0,e,!1,function(e){a[e]=(a[e]||0)+1},n)):n()}).then(function(){var n=[];Object.keys(a).forEach(function(e){a[e]===s&&n.push(e)}),r.Ct(!1,{index:"_pk_",col:r.nSQL.u[r.query.table].pkCol.join("."),comp:"IN",value:n},!1,e,t)})}},e.prototype.at=function(e,t,r){var n=this,a=function(r){for(var o=0;o<r.length;)n.vt.type!==i.IWhereType.none?n.vt.whereFn?n.vt.whereFn(r[o],o)&&e(r[o],o):n.gt(r[o],n.vt.slowWhere)&&e(r[o],o):e(r[o],o),o++;t()};if("string"==typeof this.query.table)switch(this.vt.type){case i.IWhereType.fast:this.Lt(function(t,r){e(o.mutateRowTypes(t,n.query.table,n.nSQL),r)},t);break;case i.IWhereType.medium:this.Lt(function(t,r){n.gt(t,n.vt.slowWhere)&&e(o.mutateRowTypes(t,n.query.table,n.nSQL),r)},t);break;case i.IWhereType.slow:case i.IWhereType.none:case i.IWhereType.fn:var s=this.B&&"DESC"===this.Nt.sort[0].dir;o.adapterFilters(this.nSQL,this.query).readMulti(this.query.table,"all",void 0,void 0,s,function(t,r){n.vt.type===i.IWhereType.slow?n.gt(t,n.vt.slowWhere)&&e(o.mutateRowTypes(t,n.query.table,n.nSQL),r):n.vt.type===i.IWhereType.fn&&n.vt.whereFn?n.vt.whereFn(t,r)&&e(o.mutateRowTypes(t,n.query.table,n.nSQL),r):e(o.mutateRowTypes(t,n.query.table,n.nSQL),r)},function(){t()},this.$)}else"function"==typeof this.query.table?this.ft(this.query.tableAS||o.uuid(),this.query.where,this.query.table,function(e){a(e.rows)}):Array.isArray(this.query.table)?a(this.query.table):r("Can't get selected table!")},e.prototype.ot=function(e,t,r){var n=this,a=this.query.table;if(this.nSQL.u[a])if(this.vt=this.query.where?this.dt(this.query.where):{type:i.IWhereType.none},this.query.where){var s=new o.w(function(t,r,i,o){n.kt(n.nSQL.u[a],t,function(){n.Tt(t,i,o),e(t,r)},o)},r,function(){t()});this.at(function(e){s.newItem(e)},function(){s.finished()},r)}else{var u=Object.keys(this.nSQL.u[a].indexes);o.allAsync(u,function(e,t,r,i){o.adapterFilters(n.nSQL,n.query).deleteIndex(a,e,function(){o.adapterFilters(n.nSQL,n.query).createIndex(a,e,n.nSQL.u[a].indexes[e].type,function(){r(null)},i)},i)}).then(function(){var i=new o.w(function(t,r,i,s){var u=n.At(n.nSQL.u[a].indexes,t),c=o.deepGet(n.nSQL.u[a].pkCol,t);o.allAsync(Object.keys(u),function(i,o,s,l){var f=u[i];n.xt(a,i,f,c,!0,function(){e(t,r),s()},l)}).then(i).catch(s)},r,function(){t()});n.at(function(e){i.newItem(e)},function(){i.finished()},r)}).catch(r)}else r(new Error("Table "+a+" not found for rebuilding indexes!"))},e.prototype.gt=function(e,t){if(1<t.length){for(var r="AND",n=!0,i=0;i<t.length;){var o=t[i];if(i%2==1)r=o;else{var a;a=Array.isArray(o[0])?this.gt(e,o):this.qt(o,e),n=0===i?a:"AND"===r?n&&a:n||a}i++}return n}return this.qt(t[0],e)},e.prototype.Pt=function(t,r){if(!e.likeCache[r]){var n="",i=r.split("").length-1;e.likeCache[r]=new RegExp(r.split("").map(function(e,t){return"\\"===n?n=e:"%"===(n=e)?".*":"_"===e?".":0===t?"^"+e:t===i?e+"$":e}).join(""),"gmi")}return"string"!=typeof t?"number"==typeof t?null!==String(t).match(e.likeCache[r]):null!==JSON.stringify(t).match(e.likeCache[r]):null!==t.match(e.likeCache[r])},e.prototype.Ft=function(e,t){return e.fnString?o.execFunction(this.query,e.fnString,t,{result:void 0}).result:o.deepGet(e.col,t)},e.prototype.qt=function(e,t){var r=this,n=this.Ft(e,t),i=e.value,a=e.comp;if("NULL"===i||"NOT NULL"===i){var s=-1!==[void 0,null,""].indexOf(n),u="="===a||"LIKE"===a;switch(i){case"NULL":return u?s:!s;case"NOT NULL":return u?!s:s}}if(-1!==["IN","NOT IN","BETWEEN","INTERSECT","INTERSECT ALL","NOT INTERSECT"].indexOf(a)&&!Array.isArray(i))return this.query.state="error",this.query.error('WHERE "'+a+'" comparison requires an array value!'),!1;switch(a){case"=":return o.objectsEqual(i,n);case"!=":return!o.objectsEqual(i,n);case">":return i<n;case"<":return n<i;case"<=":return n<=i;case">=":return i<=n;case"IN":return-1!==i.indexOf(n);case"NOT IN":return-1===i.indexOf(n);case"REGEXP":case"REGEX":return null!==(n||"").match(i);case"LIKE":return this.Pt(n||"",i);case"NOT LIKE":return!this.Pt(n||"",i);case"BETWEEN":return i[0]<=n&&i[1]>=n;case"NOT BETWEEN":return i[0]>=n||i[1]<=n;case"INCLUDES":return-1!==(n||[]).indexOf(i);case"INCLUDES LIKE":return 0<(n||[]).filter(function(e){return r.Pt(e,i)}).length;case"NOT INCLUDES":return-1===(n||[]).indexOf(i);case"INTERSECT":return 0<(n||[]).filter(function(e){return-1<i.indexOf(e)}).length;case"INTERSECT ALL":return(n||[]).filter(function(e){return-1<i.indexOf(e)}).length===i.length;case"NOT INTERSECT":return 0===(n||[]).filter(function(e){return-1<i.indexOf(e)}).length;default:return!1}},e.prototype.Ut=function(t,r){var n=(t&&t.length?o.hash(JSON.stringify(t)):"")+this.nSQL.state.cacheId+this.nSQL.state.cacheId;if(!n)return{sort:[],index:""};if(e.Jt[n])return e.Jt[n];var i=!1,a=t.map(function(e){return e.split(" ").map(function(e){return e.trim()})}).reduce(function(e,t){var r=-1!==t[0].indexOf("(");return r&&(i=!0),e.push({path:r?[]:o.resolvePath(t[0]),fn:r?t[0]:void 0,dir:(t[1]||"asc").toUpperCase()}),e},[]),s="";if(r&&!1===i&&1===a.length){var u="string"==typeof this.query.table?this.nSQL.u[this.query.table].pkCol:[];if(a[0].path[0].length&&o.objectsEqual(a[0].path,u))s="_pk_";else for(var c=Object.keys(this.nSQL.u[this.query.table].indexes),l=c.length;l--&&!s;)o.objectsEqual(this.nSQL.u[this.query.table].indexes[c[l]],a[0].path)&&(s=this.nSQL.u[this.query.table].indexes[c[l]].id)}return e.Jt[n]={sort:a,index:s},e.Jt[n]},e.prototype.yt=function(){var t=this,r=(this.query.actionArgs&&this.query.actionArgs.length?JSON.stringify(this.query.actionArgs):"")+this.nSQL.state.cacheId;this.Nt=this.Ut(this.query.orderBy||[],"string"==typeof this.query.table),this._t=this.Ut(this.query.groupBy||[],!1),r?e.Wt[r]?(this.Et=e.Wt[r].hasAggrFn,this.Q=e.Wt[r].args):((this.query.actionArgs||[]).forEach(function(e){var r=e.split(/\s+as\s+/i).map(function(e){return e.trim()});if(-1!==r[0].indexOf("(")){var n=r[0].split("(")[0].trim().toUpperCase();t.Q.push({isFn:!0,value:r[0],as:r[1],args:void 0}),t.nSQL.functions[n]?"A"===t.nSQL.functions[n].type&&(t.Et=!0):(t.query.state="error",t.error('Function "'+n+'" not found!'))}else t.Q.push({isFn:!1,value:r[0],as:r[1]})}),"error"!==this.query.state&&(e.Wt[r]={hasAggrFn:this.Et,args:this.Q})):this.Q=[];var n=!1;this.vt.type===i.IWhereType.none?(n="_pk_"===this.Nt.index)&&(this.B=!0):(n=!!(this.Nt.index.length&&this.vt.fastWhere&&o.objectsEqual(this.vt.fastWhere[0].col,this.Nt.sort[0].path)))&&(this.K=!0),(this.Nt.sort.length&&!n||this._t.sort.length||this.Et)&&(this.W=!1)},e.prototype.dt=function(t,r){var n=this,a=t||[],s=JSON.stringify(a,function(e,t){return t&&t.constructor&&"RegExp"===t.constructor.name?t.toString():t})+(r?"0":"1")+this.nSQL.state.cacheId;if(e.Qt[s])return e.Qt[s];if("function"==typeof a)return{type:i.IWhereType.fn,whereFn:a};if(!a.length)return e.Qt[s]={type:i.IWhereType.none},e.Qt[s];for(var u="string"==typeof this.query.table?Object.keys(this.nSQL.u[this.query.table].indexes).map(function(e){return n.nSQL.u[n.query.table].indexes[e]}):[],c="string"==typeof this.query.table?this.nSQL.u[this.query.table].pkCol:[],l="string"==typeof this.query.table?this.nSQL.u[this.query.table].pkType:"",f=function(e,t){var i=!r&&0===t;return e.reduce(function(e,r,a){if(a%2==1)return"string"!=typeof r?(n.query.state="error",n.error("Malformed WHERE statement!")):e.push(r),e;if(!Array.isArray(r))return n.query.state="error",n.error("Malformed WHERE statement!"),e;if(Array.isArray(r[0]))e.push(f(r,t+1));else if(-1!==r[0].indexOf("(")){var s=r[0].split("(")[1].replace(")","").split(",").map(function(e){return e.trim()}).filter(function(e){return e}),h=r[0].split("(")[0].trim().toUpperCase(),p=!1;if(!n.nSQL.functions[h])return n.query.state="error",n.error('Function "'+h+'" not found!'),e;if(i&&n.nSQL.functions[h]&&n.nSQL.functions[h].checkIndex){var d=n.nSQL.functions[h].checkIndex(n.query,s,r);d&&(n.X.push(o.assign(r)),p=!0,e.push(d))}p||e.push({fnString:r[0],parsedFn:{name:h,args:s},comp:r[1],value:r[2]})}else{var y=!1,g=i?o.resolvePath(r[0]):[];r[2]=Array.isArray(r[2])?r[2].map(function(e){return o.maybeDate(e)}):o.maybeDate(r[2]),-1!==["=","BETWEEN","IN","LIKE"].indexOf(r[1])&&i&&("LIKE"!==r[1]||r[2].match(/.*\%$/gim))&&(o.objectsEqual(g,c)?"LIKE"===r[1]&&"string"!==l||(y=!0,n.X.push(o.assign(r)),e.push({index:"_pk_",col:r[0],comp:r[1],value:r[2]})):u.forEach(function(t){"LIKE"===r[1]&&"string"!==t.type||!1===y&&o.objectsEqual(t.path,g)&&!1===t.isArray&&(y=!0,n.X.push(o.assign(r)),e.push({index:t.id,col:r[0],comp:r[1],value:r[2]}))})),i&&!y&&-1!==["INCLUDES","INTERSECT","INTERSECT ALL","INCLUDES LIKE"].indexOf(r[1])&&u.forEach(function(t){o.objectsEqual(t.path,g)&&!0===t.isArray&&("INCLUDES LIKE"===r[1]&&"string"!==t.type||(y=!0,n.X.push(o.assign(r)),e.push({index:t.id,indexArray:!0,col:r[0],comp:r[1],value:r[2]})))}),y||e.push({col:r[0],comp:r[1],value:r[2]})}return e},[])},h=f("string"==typeof a[0]?[a]:a,0),p=!0,d=0,y=-1;d<h.length&&p;)d%2==1?"AND"!==h[d]?p=!1:y=d:Array.isArray(h[d])||!h[d].index?p=!1:y=d,d++;if(y%2==0&&y++,-1===y||"AND"!==h[y]&&h[y])e.Qt[s]={type:i.IWhereType.slow,slowWhere:h};else{var g=h.slice(y+1);e.Qt[s]={type:g.length?i.IWhereType.medium:i.IWhereType.fast,slowWhere:g,fastWhere:h.slice(0,y)}}return e.Qt[s]},e.likeCache={},e.Jt={},e.Wt={},e.Qt={},e}();t.U=u},function(e,t,r){var n,i=this&&this.Bt||(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"e",{value:!0});var o=r(1),a=r(0),s=function(e){function t(t){var r=e.call(this,!0,!1)||this;return r.useLS=t,r.plugin={name:"Sync Storage Adapter",version:o.VERSION},r.Kt={},r.Vt={},r.Ht={},r.Xt={},r}return i(t,e),t.prototype.connect=function(e,t,r){this.Gt=e,t()},t.prototype.createTable=function(e,t,r,n){if(this.Kt[e]=[],this.Vt[e]={},this.Xt[e]=t,this.useLS){var i=localStorage.getItem(this.Gt+"->"+e+"_idx");i&&(this.Kt[e]=JSON.parse(i),this.Ht[e]=parseFloat(localStorage.getItem(this.Gt+"->"+e+"_ai")||"0"))}r()},t.prototype.dropTable=function(e,t,r){var n=this;this.Kt[e].forEach(function(t){n.useLS?localStorage.removeItem(n.Gt+"->"+e+"__"+t):delete n.Vt[e][t]}),this.useLS&&localStorage.removeItem(this.Gt+"->"+e+"_idx"),delete this.Kt[e],delete this.Vt[e],t()},t.prototype.disconnect=function(e,t){e()},t.prototype.write=function(e,t,r,n,i){if(void 0!==(t=t||a.generateID(this.Xt[e].pkType,this.Ht[e]+1))){if(this.Xt[e].ai&&(this.Ht[e]=Math.max(this.Ht[e]||0,t)),-1===this.Kt[e].indexOf(t)){var o=a.binarySearch(this.Kt[e],t,!1);this.Kt[e].splice(o,0,t),this.useLS&&(localStorage.setItem(this.Gt+"->"+e+"_idx",JSON.stringify(this.Kt[e])),localStorage.setItem(this.Gt+"->"+e+"_ai",String(this.Ht[e])))}a.deepSet(this.Xt[e].pkCol,r,t),this.useLS?localStorage.setItem(this.Gt+"->"+e+"__"+t,JSON.stringify(r)):this.Vt[e][t]=a.deepFreeze(r),n(t)}else i(new Error("Can't add a row without a primary key!"))},t.prototype.read=function(e,t,r,n){if(this.useLS){var i=localStorage.getItem(this.Gt+"->"+e+"__"+t);r(i?JSON.parse(i):void 0)}else r(this.Vt[e][t])},t.prototype.delete=function(e,t,r,n){var i=this.Kt[e].indexOf(t);-1!==i&&(this.Kt[e].splice(i,1),this.useLS&&localStorage.setItem(this.Gt+"->"+e+"_idx",JSON.stringify(this.Kt[e].keys()))),this.useLS?localStorage.removeItem(this.Gt+"->"+e+"__"+t):delete this.Vt[e][t],r()},t.prototype.readMulti=function(e,t,r,n,i,o,s,u){var c=this,l={range:[r,n],offset:[r,r+n],all:[]}[t],f=function(){switch(t){case"all":return c.Kt[e].slice();case"offset":var r=c.Kt[e].length-1;return i?c.Kt[e].slice(r-l[1],r-l[0]):c.Kt[e].slice(l[0],l[1]);case"range":for(var n=a.binarySearch(c.Kt[e],l[0],!1),o=a.binarySearch(c.Kt[e],l[1],!1);c.Kt[e][o]>l[1];)o--;for(;c.Kt[e][n]<l[0];)n++;return c.Kt[e].slice(n,o+1)}return[]}();i&&f.reverse(),f.forEach(function(t,r){c.useLS?o(JSON.parse(localStorage.getItem(c.Gt+"->"+e+"__"+t)||"{}"),r):o(c.Vt[e][t],r)}),s()},t.prototype.getTableIndex=function(e,t,r){t(this.Kt[e].slice())},t.prototype.getTableIndexLength=function(e,t,r){t(this.Kt[e].length)},t}(r(2).nanoSQLMemoryIndex);t.SyncStorage=s},function(e,t,r){var n,i=this&&this.Bt||(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"e",{value:!0});var o=r(1),a=r(0),s=r(2);t.SQLiteAbstract=function(e,t){var r=[],n={},i=function(e){if(-1===r.indexOf(e))throw Error("No table "+e+" found!");return'"'+e+'"'};return{createAI:function(t,r){e(!0,'CREATE TABLE IF NOT EXISTS "_ai" (id TEXT PRIMARY KEY UNIQUE, inc BIGINT)',[],a.noop,t,r)},createTable:function(t,i,o,s,u){r.push(t),n[t]=i,e(!0,'CREATE TABLE IF NOT EXISTS "'+t+'" (id '+(i.isPkNum?"REAL":"TEXT")+" PRIMARY KEY UNIQUE, data TEXT)",[],a.noop,function(){if(i.ai){var r=[];e(!1,'SELECT "inc" FROM "_ai" WHERE id = ?',[t],function(e){r.push(e)},function(){r.length?(o[t]=parseInt(r[0].inc),s()):(o[t]=0,e(!0,'INSERT into "_ai" (id, inc) VALUES (?, ?)',[t,0],a.noop,s,u))},u)}else s()},u)},dropTable:function(t,n,o){e(!0,"DROP TABLE IF EXISTS "+i(t),[],a.noop,function(){e(!0,'UPDATE "_ai" SET inc = ? WHERE id = ?',[0,t],a.noop,function(){r.splice(r.indexOf(t),1),n()},o)},o)},write:function(t,r,n,o,s,u,c,l,f){if(void 0!==(o=o||a.generateID(t,c[n]+1))){u&&(c[n]=Math.max(o,c[n])),a.deepSet(r,s,o);var h=JSON.stringify(s),p=function(){u&&o>=c[n]?e(!0,'UPDATE "_ai" SET inc = ? WHERE id = ?',[c[n],n],a.noop,function(){l(o)},f):l(o)},d=[];e(!1,"SELECT id FROM "+i(n)+" WHERE id = ?",[o],function(e){d.push(e)},function(){d.length?e(!0,"UPDATE "+i(n)+" SET data = ? WHERE id = ?",[h,o],a.noop,p,f):e(!0,"INSERT INTO "+i(n)+" (id, data) VALUES (?, ?)",[o,h],a.noop,p,f)},f)}else f(new Error("Can't add a row without a primary key!"))},read:function(t,r,n,o){var a=[];e(!1,"SELECT data FROM "+i(t)+" WHERE id = ?",[r],function(e){a.push(e)},function(){a.length?n(JSON.parse(a[0].data)):n(void 0)},o)},remove:function(t,r,n,o){e(!0,"DELETE FROM "+i(t)+" WHERE id = ?",[r],a.noop,function(){n()},o)},getIndex:function(t,r,n){var o=[];e(!1,"SELECT id FROM "+i(t)+" ORDER BY id",[],function(e){o.push(e.id)},function(){r(o)},n)},getNumberOfRecords:function(t,r,n){var o=[];e(!1,"SELECT COUNT(*) FROM "+i(t),[],function(e){o.push(e)},function(){r(o[0]["COUNT(*)"])},n)},readMulti:function(t,r,n,o,a,s,u,c){var l="SELECT data FROM "+i(t);"range"===r&&(l+=" WHERE id BETWEEN ? AND ?");var f=l+=a?" ORDER BY id DESC":" ORDER BY id";"offset"===r&&(f+=" LIMIT "+o+" OFFSET "+(a?n+1:n)),e(!1,f,"range"===r?[n,o]:[],function(e,t){s(JSON.parse(e.data),t)},function(){u()},c)}}};var u=function(e){function r(r,n){var i=e.call(this,!1,!1)||this;return i.plugin={name:"WebSQL Adapter",version:o.VERSION},i.Yt=1e3*(r||0)*1e3,i.Ht={},i.$t=i.$t.bind(i),i.Xt={},i.zt=t.SQLiteAbstract(i.$t,n||500),i}return i(r,e),r.prototype.connect=function(e,t,r){var n=this;this.Gt=e;try{this.Zt=window.openDatabase(this.Gt,String(this.nSQL.config.version)||"1.0",this.Gt,a.isAndroid?5e6:this.Yt)}catch(e){r(e)}a.setFast(function(){n.zt.createAI(t,r)})},r.prototype.createTable=function(e,t,r,n){this.Xt[e]=t,this.zt.createTable(e,t,this.Ht,r,n)},r.prototype.$t=function(e,t,r,n,i,o){var a=function(e){e.executeSql(t,r,function(e,t){for(var r=0;r<t.rows.length;r++)n(t.rows.item(r),r);i()},function(e,t){return o(t),!1})};e?this.Zt.transaction(a):this.Zt.readTransaction(a)},r.prototype.dropTable=function(e,t,r){this.zt.dropTable(e,t,r)},r.prototype.disconnect=function(e,t){e()},r.prototype.write=function(e,t,r,n,i){this.zt.write(this.Xt[e].pkType,this.Xt[e].pkCol,e,t,r,this.Xt[e].ai,this.Ht,n,i)},r.prototype.read=function(e,t,r,n){this.zt.read(e,t,r,n)},r.prototype.delete=function(e,t,r,n){this.zt.remove(e,t,r,n)},r.prototype.readMulti=function(e,t,r,n,i,o,a,s){this.zt.readMulti(e,t,r,n,i,o,a,s)},r.prototype.getTableIndex=function(e,t,r){this.zt.getIndex(e,t,r)},r.prototype.getTableIndexLength=function(e,t,r){this.zt.getNumberOfRecords(e,t,r)},r}(s.nanoSQLMemoryIndex);t.WebSQL=u},function(e,t,r){var n,i=this&&this.Bt||(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"e",{value:!0});var o=r(1),a=r(0),s=function(e){function t(t){var r=e.call(this,!1,!1)||this;return r.version=t,r.plugin={name:"IndexedDB Adapter",version:o.VERSION},r.Zt={},r.Ht={},r.Xt={},r}return i(t,e),t.prototype.connect=function(e,t,r){this.Gt=e,t()},t.prototype.createTable=function(e,t,r,n){var i=this,o=1;this.Xt[e]=t;var s=a.hash(JSON.stringify(t.columns));this.version?o=this.version:(o=parseInt(localStorage.getItem(this.Gt+"_"+e+"_idb_version")||"1"),(localStorage.getItem(this.Gt+"_"+e+"_idb_hash")||s)!==s&&o++,localStorage.setItem(this.Gt+"_"+e+"_idb_version",String(o)),localStorage.setItem(this.Gt+"_"+e+"_idb_hash",s));var u=indexedDB.open(this.Gt+"_"+e,o);this.Ht[e]=parseInt(localStorage.getItem(this.Gt+"_"+e+"_idb_ai")||"0"),u.onerror=n,u.onupgradeneeded=function(r){i.Zt[e]=r.target.result,i.Zt[e].objectStoreNames.contains(e)||i.Zt[e].createObjectStore(e,{keyPath:t.pkCol.join(".")})},u.onsuccess=function(t){i.Zt[e]=t.target.result,r()}},t.prototype.dropTable=function(e,t,r){var n=this,i=this.Zt[e].transaction(e,"readwrite");i.onerror=r;var o=i.objectStore(e).clear();o.onerror=r,o.onsuccess=function(){n.Zt[e].close(),delete n.Zt[e],localStorage.removeItem(n.Gt+"_"+e+"_idb_version"),localStorage.removeItem(n.Gt+"_"+e+"_idb_hash"),localStorage.removeItem(n.Gt+"_"+e+"_idb_ai"),t()}},t.prototype.disconnect=function(e,t){var r=this;a.allAsync(Object.keys(this.Zt),function(e,t,n,i){r.Zt[e].close(),a.setFast(function(){n()})}).then(e).catch(t)},t.prototype.store=function(e,t,r,n){var i=this.Zt[e].transaction(e,t);i.onabort=n,i.onerror=n,r(i,i.objectStore(e))},t.prototype.write=function(e,t,r,n,i){void 0!==(t=t||a.generateID(this.Xt[e].pkType,this.Ht[e]+1))?(this.Ht[e]=Math.max(t,this.Ht[e]),this.Xt[e].ai&&(this.Ht[e]=a.cast("int",Math.max(this.Ht[e]||0,t)),localStorage.setItem(this.Gt+"_"+e+"_idb_ai",String(this.Ht[e]))),a.deepSet(this.Xt[e].pkCol,r,t),this.store(e,"readwrite",function(e,o){try{o.put(r).onsuccess=function(){n(t)}}catch(e){i(e)}},i)):i(new Error("Can't add a row without a primary key!"))},t.prototype.read=function(e,t,r,n){this.store(e,"readonly",function(e,n){var i=n.get(t);i.onerror=function(e){r(void 0)},i.onsuccess=function(){r(i.result)}},n)},t.prototype.delete=function(e,t,r,n){this.store(e,"readwrite",function(e,i){var o=i.delete(t);o.onerror=n,o.onsuccess=function(e){r()}},n)},t.prototype.readMulti=function(e,t,r,n,i,o,a,s){var u=0,c="offset"===t?r:0,l=c+n,f=!0;this.store(e,"readonly",function(e,h){if(h.getAll){var p=h.getAll("range"!==t?void 0:IDBKeyRange.bound(r,n,!1,!1),"offset"!==t||i?void 0:n+r);p.onsuccess=function(e){var s=i?e.target.result.reverse():e.target.result;if("offset"===t){var u=i?1:0;s.slice(r+u,r+n+u).forEach(o)}else s.forEach(o);a()},p.onerror=s}else h.openCursor("range"!==t?void 0:IDBKeyRange.bound(r,n,!1,!1),i?"prev":"next").onsuccess=function(e){var n=e.target.result;if(n){if("offset"===t){if(f){var s=i?c+1:c;return n.advance(s),u=s,void(f=!1)}(i?u<=l:u<l)&&o(n.value,u-r)}else o(n.value,u);u++,n.continue()}else a()}},s)},t.prototype.getTableIndex=function(e,t,r){var n=this,i=[];this.store(e,"readonly",function(r,o){o.openCursor().onsuccess=function(r){var o=r.target.result;o?(i.push(a.deepGet(n.Xt[e].pkCol,o.value)),o.continue()):t(i)}},r)},t.prototype.getTableIndexLength=function(e,t,r){this.store(e,"readonly",function(n,i){var o=n.objectStore(e).count();o.onsuccess=function(){t(o.result)},o.onerror=r},r)},t}(r(2).nanoSQLMemoryIndex);t.IndexedDB=s},function(e,t,r){var n=this&&this.O||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"e",{value:!0});var i,o,a=r(0),s=r(4),u=function(){function e(e,t,r,i,o){this.Zt=e,this.tn=o||"",this.$t="string"==typeof r?n({},a.buildQuery(e,t,r),{comments:[],state:"pending",action:r,actionArgs:i,result:[]}):n({},r(e),{state:"pending",result:[]})}return e.prototype.where=function(e){return this.$t.where=e,this},e.prototype.orderBy=function(e){return Array.isArray(e)?this.$t.orderBy=e:this.$t.orderBy=Object.keys(e).map(function(t){return t+" "+String(e[t]).toUpperCase()}),this},e.prototype.distinct=function(e){return this.$t.distinct=e,this},e.prototype.groupBy=function(e){return Array.isArray(e)?this.$t.groupBy=e:this.$t.groupBy=Object.keys(e).map(function(t){return t+" "+String(e[t]).toUpperCase()}),this},e.prototype.having=function(e){return this.$t.having=e,this},e.prototype.join=function(e){var t=this,r="Join commands requires table and type arguments!";return Array.isArray(e)?e.forEach(function(e){e.with.table&&e.type||(t.nn=r)}):e.with.table&&e.type||(this.nn=r),this.$t.join=e,this},e.prototype.limit=function(e){return this.$t.limit=e,this},e.prototype.comment=function(e){return this.$t.comments.push(e),this},e.prototype.tag=function(e){return this.$t.tags.push(e),this},e.prototype.extend=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];return this.$t.extend.push({scope:e,args:t}),this},e.prototype.union=function(e,t){return this.$t.union={queries:e,type:t?"all":"distinct"},this},e.prototype.offset=function(e){return this.$t.offset=e,this},e.prototype.emit=function(){return this.$t},e.prototype.ttl=function(e,t){if(void 0===e&&(e=60),"upsert"!==this.$t.action)throw new Error("nSQL: Can only do ttl on upsert queries!");return this.$t.ttl=e,this.$t.ttlCols=t||[],this},e.prototype.graph=function(e){return this.$t.graph=e,this},e.prototype.from=function(e){return"string"==typeof e||Array.isArray(e)?this.$t.table=e:(this.$t.table=e.table,this.$t.tableAS=e.as),this},e.prototype.into=function(e){return this.$t.table=e,this},e.prototype.on=function(e){return this.$t.table=e,this},e.prototype.toCSV=function(e){var t=this;return this.exec().then(function(r){return Promise.resolve(t.Zt.JSONtoCSV(r,e))})},e.prototype.copyTo=function(e,t){return this.$t.copyTo={table:e,mutate:t||function(e){return e}},this},e.prototype.exec=function(e){var t=this;return new Promise(function(r,n){var i=[];t.stream(function(e){e&&i.push(e)},function(){r(i)},n,e)})},e.prototype.listen=function(e){return new c(this.$t,e&&e.debounce,e&&e.unique,e&&e.compareFn)},e.prototype.stream=function(e,t,r,i){var o=this;if(this.$t.returnEvent=i,this.Zt.state.exportQueryObj)e(this.$t),t();else{var s=this.$t.copyTo?new a.w(function(t,r,i,s){o.$t.parent.triggerQuery(n({},a.buildQuery(o.$t.parent,o.$t.copyTo&&o.$t.copyTo.table||"","upsert"),{actionArgs:o.$t.copyTo&&o.$t.copyTo.mutate(t)}),a.noop,function(){e(t),i()},s)},r,function(){t()}):void 0;this.Zt.triggerQuery(this.$t,function(t){s?s.newItem(t):e(t)},function(){s?s.finished():t()},r)}},e.prototype.cache=function(e,t,r){var n=this,i=a.uuid(),o=[],s=!1,u=0,c=r||{pageSize:0,onPage:a.noop};this.stream(function(e){o.push(e),c.pageSize&&c.onPage&&o.length%c.pageSize==0&&(s=!0,c.onPage(u,o.slice(o.length-c.pageSize)),u++,c.doNotCache&&(o=[]))},function(){c.pageSize&&c.onPage&&(!s||c.doNotCache?c.onPage(0,o.slice()):c.onPage(u,o.slice(u*c.pageSize))),c.doNotCache?(o=[],e("",0)):(n.Zt.A[i]=o,e(i,o.length))},t)},e}();t.F=u,(o=i||(i={}))[o.stream=0]="stream",o[o.exec=1]="exec";var c=function(){function e(e,t,r,n){void 0===t&&(t=500),void 0===r&&(r=!1),void 0===n&&(n=s);var i=this;if(this.query=e,this.debounce=t,this.unique=r,this.compareFn=n,this.in=[],this.en=!0,this.trigger=this.trigger.bind(this),this.rn=this.rn.bind(this),this.un=this.rn.bind(this),this.sn={stream:[a.noop,a.noop,a.noop,!1],exec:[a.noop,!1]},"string"!=typeof e.table)throw new Error("Can't listen on dynamic tables!");if("select"!==e.action)throw new Error("Can't listen to this kind of query!");if(this.in.push(e.table),e.join){var o=Array.isArray(e.join)?e.join:[e.join];this.in.concat(this.cn(o))}if(e.graph){var u=Array.isArray(e.graph)?e.graph:[e.graph];this.in.concat(this.cn(u))}this.in=this.in.filter(function(e,t,r){return r.indexOf(e)===t}),this.un=a.throttle(this,this.rn,t),this.in.forEach(function(t){e.parent.on("change",i.un,t)})}return e.prototype.cn=function(e){var t=this,r=[];return e.forEach(function(e){e.with&&e.with.table&&"string"==typeof e.with.table&&r.push(e.with.table);var n=e.graph;if(n){var i=Array.isArray(n)?n:[n];r.concat(t.cn(i))}}),r},e.prototype.rn=function(){var e=this;if(this.en&&void 0!==this.an)switch(this.an){case i.stream:this.query.returnEvent=this.sn.stream[3],this.query.parent.triggerQuery(this.query,this.sn.stream[0],this.sn.stream[1],this.sn.stream[2]);break;case i.exec:this.query.returnEvent=this.sn.exec[1];var t=[];this.query.parent.triggerQuery(this.query,function(e){t.push(e)},function(){e.unique?(!e.hn||e.hn.length!==t.length||!e.compareFn(e.hn,t))&&(e.hn=t,e.sn.exec[0](a.assign(t))):e.sn.exec[0](t)},function(t){e.sn.exec[0]([],t)})}},e.prototype.ln=function(){if(void 0!==this.an)throw new Error("Listen can't have multiple exports!")},e.prototype.trigger=function(){this.un()},e.prototype.stream=function(e,t,r,n){if(this.unique)throw new Error("Can't use unique with stream listener!");this.ln(),this.an=i.stream,this.sn.stream=[e,t,r,n||!1],this.rn()},e.prototype.exec=function(e,t){this.ln(),this.an=i.exec,this.sn.exec=[e,t||!1],this.rn()},e.prototype.unsubscribe=function(){var e=this;this.en=!1,this.in.forEach(function(t){e.query.parent.off("change",e.un,t)})},e}()}])});