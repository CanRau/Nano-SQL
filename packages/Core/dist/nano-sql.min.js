!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var n=e();for(var r in n)("object"==typeof exports?exports:t)[r]=n[r]}}(window,function(){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.e)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(r,i,function(e){return t[e]}.bind(null,i));return r},n.n=function(t){var e=t&&t.e?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=2)}([function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.binarySearch=function(t,n,r,i){var o=r||0,s=i||t.length;if(t[o]>n)return o;if(t[s]<n)return s+1;var a=Math.floor((o+s)/2);return n===t[a]?a:s-1===o?s:n>t[a]?e.binarySearch(t,n,a,s):n<t[a]?e.binarySearch(t,n,o,a):s},e.buildQuery=function(t,n){return{table:t,action:n,state:"pending",result:[],time:Date.now(),queryID:e.uuid(),extend:[],comments:[],tags:[]}},e.adapterFilters=function(t,e){return{write:function(n,r,i,o,s){t.doFilter("adapterWillWrite",{result:{table:n,pk:r,row:i},query:e}).then(function(e){e&&t.adapter.write(e.table,e.pk,e.row,function(e){t.doFilter("adapterDidWrite",{result:e}).then(function(t){o(t)}).catch(s)},s)}).catch(s)},read:function(n,r,i,o){t.doFilter("adapterWillRead",{result:void 0,table:n,pk:r,i:0,query:e}).then(function(s){s?i(s):t.adapter.read(n,r,function(s){t.doFilter("adapterDidRead",{result:s,table:n,pk:r,i:0,query:e}).then(function(t){i(t)}).catch(o)},o)})},readMulti:function(r,i,o,s,a,u,c,l){var f=new n(function(n,i,o,s){var a=t.tables[r].pkCol;t.doFilter("adapterDidRead",{result:n,table:r,pk:n[a],i:i,query:e}).then(function(t){u(t,i),o()}).catch(s)},l,c);t.doFilter("adapterWillReadMulti",{result:{table:r,type:i,offsetOrLow:o,limitOrHigh:s,reverse:a},onRow:u,complete:c,error:l,query:e}).then(function(e){e&&t.adapter.readMulti(e.table,e.type,e.offsetOrLow,e.limitOrHigh,e.reverse,function(t){f.newItem(t)},function(){f.finished()},f.onError)})}}},e.noop=function(){},e.throwErr=function(t){throw new Error(t)},e.u=function(t){return t?JSON.parse(JSON.stringify(t)):null},e.a=function(t,n){if(t===n)return!0;if("object"!=typeof t)return!1;if(!t||!n)return!1;var r=Object.keys(t),i=Array.isArray(t)?t.length===n.length:r.length===Object.keys(n).length;if(!i)return!1;for(var o=r.length;o--&&i;){var s=r[o];i="object"==typeof t[s]?e.a(t[s],n[s]):t[s]===n[s]}return i};var n=function(){function t(t,e,n){this.processItem=t,this.onError=e,this.onComplete=n,this.f=[],this.h=!1,this.v=!1,this.g=0,this.y=!1,this.b=this.b.bind(this)}return t.prototype.b=function(){var t=this;if(!this.y){if(this.v&&!this.f.length)return this.y=!0,void(this.onComplete&&this.onComplete());if(this.f.length){var n=function(){t.g++,t.g%100==0?e.setFast(t.b):t.b()},r=this.f.shift()||[];r[1]?r[1](r[0],n,this.onError?this.onError:e.noop):this.processItem&&this.processItem(r[0],this.g,n,this.onError?this.onError:e.noop)}else this.h=!1}},t.prototype.finished=function(){this.v=!0,this.y||this.h||(this.y=!0,this.onComplete&&this.onComplete())},t.prototype.newItem=function(t,e){this.f.push([t,e]),this.h||(this.h=!0,this.b())},t}();e.w=n,e.chainAsync=function(t,n){return new Promise(function(r,i){if(t&&t.length){var o=[],s=0,a=function(){s<t.length?n(t[s],s,function(t){t&&o.push(t||0),++s%500==0?e.setFast(a):a()},function(t){i(t)}):r(o.length?o:void 0)};a()}else r([])})},e.allAsync=function(t,e){return Promise.all((t||[]).map(function(t,n){return new Promise(function(r,i){e(t,n,r,i)})}))};var r="undefined"==typeof window?"":navigator.userAgent||"";e.isSafari=0!==r.length&&(/^((?!chrome|android).)*safari/i.test(r)||/iPad|iPhone|iPod/.test(r)&&!window.MSStream),e.isMSBrowser=0!==r.length&&(r.indexOf("MSIE ")>0||r.indexOf("Trident/")>0||r.indexOf("Edge/")>0),e.isAndroid=/Android/.test(r),e.random16Bits=function(){if("undefined"==typeof crypto)return Math.round(Math.random()*Math.pow(2,16));if(crypto.getRandomValues){var t=new Uint16Array(1);return crypto.getRandomValues(t),t[0]}return"undefined"!=typeof global&&global.S.randomBytes?global.S.randomBytes(2).reduce(function(t,e){return e*t}):Math.round(Math.random()*Math.pow(2,16))},e.throttle=function(t,e){var n=!1;return function(){for(var r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];n||(n=!0,setTimeout(function(){t.apply(null,r),n=!1},e))}},e.timeid=function(t){for(var n=Math.round((new Date).getTime()/(t?1:1e3)).toString();n.length<(t?13:10);)n="0"+n;return n+"-"+(e.random16Bits()+e.random16Bits()).toString(16)},e.intersect=function(t,e){return!(!t||!e)&&!(!t.length||!e.length)&&(t||[]).filter(function(t){return-1!==(e||[]).indexOf(t)}).length>0},e.uuid=function(){var t,n,r="";return[r,r,r,r,r,r,r,r].reduce(function(i,o,s){for(t=e.random16Bits(),n=3===s?4:4===s?(t%16&3|8).toString(16):r,t=t.toString(16);t.length<4;)t="0"+t;return i+([2,3,4,5].indexOf(s)>-1?"-":r)+(n+t).slice(0,4)},r)},e.hash=function(t){for(var e=5381,n=t.length;n;)e=33*e^t.charCodeAt(--n);return(e>>>0).toString(16)};var i={int:function(t){return t},uuid:e.uuid,timeId:function(){return e.timeid()},timeIdms:function(){return e.timeid(!0)}};e.generateID=function(t,e){return i[t]?i[t](e||1):""},e.cleanArgs=function(t,n){for(var r={},i=t.length;i--;){var o=t[i].split(":");o.length>1?r[o[0]]=e.cast(o[1],n[o[0]]||void 0,!0):r[o[0]]=n[o[0]]||void 0}return r},e.isObject=function(t){return"[object Object]"===Object.prototype.toString.call(t)},e.objSort=function(t,n){return function(r,i){var o=t?e.deepGet(t,r)>e.deepGet(t,i)?-1:1:r>i?-1:1;return n?-1*o:o}},e.cast=function(t,n,r){if("any"===t||"blob"===t)return n;if(-1!==t.indexOf("[]")){var i=t.slice(0,t.lastIndexOf("[]"));return Array.isArray(n)?n.map(function(t){return e.cast(i,t,r)}):[]}var o=typeof n,s={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},a=function(t,i){switch(t){case"safestr":return a("string",i).replace(/[&<>"'`=\/]/gim,function(t){return s[t]});case"int":return"number"!==o||i%1!=0?parseInt(i||0):i;case"number":case"float":return"number"!==o?parseFloat(i||0):i;case"array":return Array.isArray(i)?i:[];case"uuid":case"timeId":case"timeIdms":case"string":return"string"!==o?String(i):i;case"object":case"obj":case"map":return e.isObject(i)?i:{};case"boolean":case"bool":return!0===i||1===i}return r?n:null};if(void 0===n||null===n)return null;var u=a(String(t||"").toLowerCase(),n);return void 0!==u&&["int","float","number"].indexOf(t)>-1&&isNaN(u)?0:u},e.crowDistance=function(t,e,n,r,i){void 0===i&&(i=6371);var o=function(t){return t*(Math.PI/180)},s=o(n-t),a=o(r-e),u=Math.sin(s/2)*Math.sin(s/2)+Math.cos(o(t))*Math.cos(o(n))*Math.sin(a/2)*Math.sin(a/2);return i*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))};var o={};e.resolvePath=function(t){var e=t;if(o[e])return o[e];var n=-1!==t.indexOf("[")?t.split(/\.|\[/gim).map(function(t){return t.replace(/\]/gim,"")}):t.split(".");return o[e]=n,o[e]},e.getFnValue=function(t,n){return n.match(/\".*\"|\'.*\'/gim)?n.replace(/\"|\'/gim,""):e.deepGet(n,t)},e.deepFreeze=function(t){return Object.getOwnPropertyNames(t||{}).forEach(function(n){var r=t[n];"object"==typeof r&&null!==r&&(t[n]=e.deepFreeze(r))}),Object.freeze(t)},e.deepSet=function(t,n,r){var i=function(t,e,n){t[e+1]?(n[t[e]]||(isNaN(t[e+1])?n[t[e]]={}:n[t[e]]=[]),i(t,e+1,n[t[e]])):n[t[e]]=r};return i(Array.isArray(t)?t:e.resolvePath(t),0,n),n},e.deepGet=function(t,n){var r=function(t,e,n){return t[e]&&n?r(t,e+1,n[t[e]]):n};return r(Array.isArray(t)?t:e.resolvePath(t),0,n)},e._=function(t){return Object.isFrozen(t)?e.u(t):t};var s=0,a={},u=Array.prototype.slice,c="undefined"!=typeof window&&window.postMessage&&window.addEventListener,l=function(t){return t[0].apply(null,u.call(t,1))};c&&window.addEventListener("message",function(t){var e,n=t.data;"string"==typeof n&&0===n.indexOf("setMsg")&&(e=a[n])&&(delete a[n],l(e))});e.setFast=c?function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=s++,r="setMsg"+n;return a[r]=t,window.postMessage(r,"*"),n}:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];"undefined"!=typeof global?global.setImmediate(function(){l(t)}):setTimeout(function(){l(t)},0)}},function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.VERSION=2,function(t){t[t.fast=0]="fast",t[t.medium=1]="medium",t[t.slow=2]="slow",t[t.fn=3]="fn",t[t.none=4]="none"}(e.IWhereType||(e.IWhereType={}))},function(t,e,n){t.exports=n(3)},function(t,e,n){var r=this&&this.O||Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t};Object.defineProperty(e,"__esModule",{value:!0});var i,o=n(4),s=n(0),a=n(5),u=n(1),c=n(6),l=n(8),f=n(9),h=n(10),p=n(11),d=n(12);"undefined"!=typeof global&&(i=global.N);var y=function(){function t(){this.version=u.VERSION,this.earthRadius=6371,this.T=new s.w,this.state={activeAV:"",hasAnyEvents:!1,peers:[],pid:s.uuid(),id:s.uuid(),peerEvents:[],focused:!0,peerMode:!1,connected:!1,ready:!1,selectedTable:""},this.config={id:"temp",queue:!1},this.tables={},this.k={},this.filters={},this.indexTypes={string:function(t){return"object"==typeof t?JSON.stringify(t):String(t)},geo:function(t){},float:function(t){var e=parseFloat(t);return isNaN(e)?0:e},int:function(t){var e=parseInt(t);return isNaN(e)?0:e},number:function(t){var e=parseFloat(t);return isNaN(e)?0:e}},this.eventFNs={Core:{"*":new o.ReallySmallEvents},"*":{"*":new o.ReallySmallEvents}},this.A=this.A.bind(this),c.attachDefaultFns(this)}return t.prototype.doFilter=function(t,e){var n=this;return this.filters[t]?new Promise(function(r,i){s.chainAsync(n.filters[t],function(r,o,s){n.filters[t][o](e).then(function(t){e=t,t.abort?i(t.abort):s()})}).then(function(){r(e.result)})}):Promise.resolve(e.result)},t.prototype.getCache=function(t,e){if(!this.k[t])throw new Error('Cache "'+t+'" not found!');return e?this.k[t].slice(e.offset,e.offset+e.limit):this.k[t].slice()},t.prototype.clearCache=function(t){var e=void 0!==this.k[t];return delete this.k[t],e},t.prototype.clearTTL=function(t){var e=this,n=this.state.selectedTable+"."+t;return new Promise(function(t,i){e.triggerQuery(r({},s.buildQuery("_ttl","delete"),{where:["key","=",n]}),s.noop,t,i)})},t.prototype.expires=function(t){var e=this;return new Promise(function(n,i){var o=e.state.selectedTable+"."+t,a=[];e.triggerQuery(r({},s.buildQuery("_ttl","select"),{where:["key","=",o]}),function(t){a.push(t)},function(){a.length?n({time:(a[0].date-Date.now())/1e3,cols:a[0].cols}):n({time:-1,cols:[]})},i)})},t.prototype.A=function(){var t=this;if(!this.config.disableTTL){this.j&&clearTimeout(this.j);var e=0,n=0,i=function(){var o=[];t.triggerQuery(r({},s.buildQuery("_ttl","select"),{limit:20,offset:20*e}),function(t){o.push(t)},function(){o.length?s.chainAsync(o,function(e,i,o){if(e.date<Date.now()){var a=function(){t.triggerQuery(r({},s.buildQuery("_ttl","delete"),{where:["key","=",e.key]}),s.noop,o,s.throwErr)},u=e.key.split("."),c=u[0],l=-1===["float","int","number"].indexOf(t.tables[c].pkType)?u[1]:parseFloat(u[1]);if(e.cols.length){var f={};e.cols.forEach(function(t){f[t]=null}),t.triggerQuery(r({},s.buildQuery(c,"upsert"),{actionArgs:f,where:[t.tables[c].pkCol,"=",l]}),s.noop,a,s.throwErr)}else t.triggerQuery(r({},s.buildQuery(c,"delete"),{where:[t.tables[c].pkCol,"=",l]}),s.noop,a,s.throwErr)}else n=Math.max(n,e.date),o()}).then(function(){e++,i()}):n&&(t.j=setTimeout(t.A,n-Date.now()))},s.throwErr)};i()}},t.prototype.selectTable=function(t){return t&&(this.state.selectedTable=t),this},t.prototype.getPeers=function(){return JSON.parse(localStorage.getItem("nsql-peers-"+this.state.id)||"[]")},t.prototype.I=function(){return"undefined"==typeof window?"RKS":s.isSafari?"WSQL":"undefined"!=typeof indexedDB?"IDB":"undefined"!=typeof window&&void 0!==window.openDatabase?"WSQL":"LS"},t.prototype.M=function(t){var e=this;return new Promise(function(n,r){var i={};(t.plugins||[]).forEach(function(t){(t.filters||[]).forEach(function(t){i[t.name]||(i[t.name]=[]);for(var e=t.priority;i[t.name][e];)e++;i[t.name][e]=t.call})}),Object.keys(i).forEach(function(t){e.filters[t]=[],i[t].forEach(function(n){n&&e.filters[t].unshift(n)})});var o=function(t,e){return!e||!e.length||(1===e.length?t>=e[0]:t>=e[0]&&t<e[1])},s=!1;(t.plugins||[]).forEach(function(e){if(e.dependencies){var n=e.dependencies||{};Object.keys(e.dependencies).forEach(function(i,a,c){if("core"===i)o(u.VERSION,n[i])||(s=!0,r('Plugin "'+e.name+'" requires a different core version of nano-sql!'));else{var l=(t.plugins||[]).reduce(function(t,e){return e.name===i?e:t});l||(s=!0,r('Plugin "'+e.name+'" requires plugin "'+i+"\" but it isn't installed!")),o(l.version,n[i])||(s=!0,r('Plugin "'+e.name+'" requires a different version of "'+i+'"!'))}})}}),s||n()})},t.prototype.connect=function(t){var e=this;return this.M(t).then(function(){return e.doFilter("config",{result:t})}).then(function(t){return e.state.id=t.id||"nSQL_DB",e.config=r({plugins:[]},t),"undefined"!=typeof window&&t&&t.peer&&(e.state.peerMode=!0),e.doFilter("willConnect",{result:{}})}).then(function(){return new Promise(function(t,n){var r=void 0!==e.config.mode?e.config.mode:"TEMP";if("string"==typeof r)switch("PERM"===r&&(r=e.I()),r){case"TEMP":e.adapter=new f.SyncStorage(!1);break;case"LS":e.adapter=new f.SyncStorage(!0);break;case"WSQL":e.adapter=new h.WebSQL;break;case"IDB":e.adapter=new p.IndexedDB(e.config.version);break;case"RKS":case"LVL":e.adapter=new i(e.config.path);break;default:n("Cannot find mode "+r+"!")}else e.adapter=r;e.adapter.plugin&&(e.config.plugins||[]).push(e.adapter.plugin),e.M(e.config).then(function(){e.adapter.nSQL=e,e.adapter.connect(e.state.id,t,n)}).catch(n)})}).then(function(){e.triggerEvent({target:"Core",targetId:e.state.id,path:"*",events:["connect"],time:Date.now()}),e.state.connected=!0;var t=["_util","_ttl"].concat((e.config.tables||[]).map(function(t){return t.name}));return s.allAsync(t,function(t,n,i,o){switch(t){case"_util":e.triggerQuery(r({},s.buildQuery("","create table"),{actionArgs:{name:"_util",model:[{key:"key:string",props:["pk()"]},{key:"value:any"}],R:!0}}),s.noop,i,o);break;case"_ttl":e.triggerQuery(r({},s.buildQuery("","create table"),{actionArgs:{name:"_ttl",model:[{key:"key:string",props:["pk()"]},{key:"table:string"},{key:"cols:string[]"},{key:"date:number"}],R:!0}}),s.noop,i,o);break;default:var a=(e.config.tables||[]).filter(function(e){return e.name===t})[0];if(!a)return void o("Table not found!");e.triggerQuery(r({},s.buildQuery("","create table"),{actionArgs:a}),s.noop,i,o)}})}).then(function(){return new Promise(function(t,n){var i;e.triggerQuery(r({},s.buildQuery("_util","select"),{where:["key","=","version"]}),function(t){t&&(i=t.value)},function(){!i||i<2?e.triggerQuery(r({},s.buildQuery("_util","upsert"),{actionArgs:{key:"version",value:u.VERSION}}),s.noop,t,n):t()},n)})}).then(function(){return new Promise(function(t,n){var i;e.config.version?e.triggerQuery(r({},s.buildQuery("_util","select"),{where:["key","=","db-version"]}),function(t){t&&(i=t.value)},function(){var o=function(t,n,i){e.triggerQuery(r({},s.buildQuery("_util","upsert"),{actionArgs:{key:"db-version",value:t}}),s.noop,n,i)};if(i){var a=function(){if(i===e.config.version)o(e.config.version||0,t,n);else{if(!e.config.onVersionUpdate)return void o(e.config.version||0,t,n);e.config.onVersionUpdate(i).then(function(t){o(i=t,function(){s.setFast(a)},n)}).catch(n)}};a()}else o(e.config.version||0,t,n)},n):t()})}).then(function(){return new Promise(function(t,n){e.triggerEvent({target:"Core",path:"*",targetId:e.state.id,events:["ready"],time:Date.now()}),e.state.ready=!0,e.config.disableTTL||e.A(),e.config.peer&&e.L(),t()})})},t.prototype.L=function(){var t=this,n=0;this.state.pid=s.uuid(),this.state.peers=this.getPeers(),this.state.peers.unshift(this.state.pid),localStorage.setItem("nsql-peers-"+this.state.id,JSON.stringify(this.state.peers)),window.addEventListener("storage",function(e){if(e.key==="nsql-peers-"+t.state.id&&(t.state.peers=t.getPeers()),e.key&&0===e.key.indexOf(t.state.pid+".")){localStorage.removeItem(e.key);var i=JSON.parse(e.newValue||"{}");t.state.peerEvents.push(i.query.queryID||""),t.triggerEvent(r({},i,{types:["peer change"]})),s.setFast(function(){t.triggerEvent(i)})}if(++n>50&&t.state.peers[0]===t.state.pid){n=0;for(var o=localStorage.length,a={};o--;){var u=localStorage.key(o),c=u?u.match(/\w{8}-\w{4}-\w{4}-\w{4}-\w{8}/gim):null;if(u&&c){var l=(c||[""])[0];a[l]||(a[l]=[]),a[l].push(u)}}Object.keys(a).forEach(function(e){a[e].length>10&&(t.state.peers=t.state.peers.filter(function(t){return t!==e}),a[e].forEach(function(t){localStorage.removeItem(t)}),localStorage.setItem("nsql-peers-"+t.state.id,JSON.stringify(t.state.peers)))})}}),window.onblur=function(){t.state.focused=!1},window.onfocus=function(){t.state.peers=t.state.peers.filter(function(e){return e!==t.state.pid}),t.state.peers.unshift(t.state.pid),localStorage.setItem("nsql-peers-"+t.state.id,JSON.stringify(t.state.peers)),t.state.focused=!0},e.nSQL("*").on("change",function(e){var n=t.state.peerEvents.indexOf(e.query.queryID||"");-1===n?t.state.peers.filter(function(e){return e!==t.state.pid}).forEach(function(t){localStorage.setItem(t+"."+e.query.queryID,JSON.stringify(e))}):t.state.peerEvents.splice(n,1)}),window.addEventListener("beforeunload",function(){return t.state.peers=t.state.peers.filter(function(e){return e!==t.state.pid}),localStorage.setItem("nsql-peers-"+t.state.id,JSON.stringify(t.state.peers)),!1})},t.prototype.on=function(t,e){var n=this,r=this,i="string"!=typeof r.state.selectedTable?"":r.state.selectedTable;switch(t){case"connect":case"ready":case"disconnect":case"peer change":case"slow-query":this.eventFNs.Core["*"].on(t,e);break;case"select":case"change":case"delete":case"upsert":case"*":var a=s.resolvePath(i);this.eventFNs[a[0]]||(this.eventFNs[a[0]]={"*":new o.ReallySmallEvents});var u=a.filter(function(t,e){return e>0}).join(".")||"*";this.eventFNs[a[0]][u]||(this.eventFNs[a[0]][u]=new o.ReallySmallEvents),this.eventFNs[a[0]][u].on(t,e);break;default:this.doFilter("customEvent",{result:{nameSpace:"",path:"*"},selectedTable:i,action:t,on:!0}).then(function(i){if(!i.nameSpace)throw new Error('Invalid event "'+t+'"!');n.eventFNs[i.nameSpace]||(n.eventFNs[i.nameSpace]={"*":new o.ReallySmallEvents}),n.eventFNs[i.nameSpace][i.path]||(n.eventFNs[i.nameSpace][i.path]=new o.ReallySmallEvents),n.eventFNs[i.nameSpace][i.path].on(t,e),r.C()})}return r.C()},t.prototype.off=function(t,e){var n=this,r=this,i="string"!=typeof r.state.selectedTable?"":r.state.selectedTable;switch(t){case"connect":case"ready":case"disconnect":case"peer change":case"slow query":this.eventFNs.Core["*"].off(t,e);break;case"select":case"change":case"delete":case"upsert":var a=s.resolvePath(i);this.eventFNs[a[0]]||(this.eventFNs[a[0]]={"*":new o.ReallySmallEvents});var u=a.filter(function(t,e){return e>0}).join(".")||"*";this.eventFNs[a[0]][u]||(this.eventFNs[a[0]][u]=new o.ReallySmallEvents),this.eventFNs[a[0]][u].off(t,e);break;default:this.doFilter("customEvent",{result:{nameSpace:"",path:"*"},selectedTable:i,action:t,on:!0}).then(function(i){if(!i.nameSpace)throw new Error('Invalid event "'+t+'"!');n.eventFNs[i.nameSpace]||(n.eventFNs[i.nameSpace]={"*":new o.ReallySmallEvents}),n.eventFNs[i.nameSpace][i.path]||(n.eventFNs[i.nameSpace][i.path]=new o.ReallySmallEvents),n.eventFNs[i.nameSpace][i.path].off(t,e),r.C()})}return r.C()},t.prototype.C=function(){var t=this;return this.state.hasAnyEvents=Object.keys(this.eventFNs).reduce(function(e,n){return!0===e||Object.keys(t.eventFNs[n]).reduce(function(e,r){return Object.keys(t.eventFNs[n][r].eventListeners).length+e},0)>0||e},!1),this},t.prototype.getView=function(t,e){return this.D("View",this.state.selectedTable,t,e)},t.prototype.doAction=function(t,e){return this.D("Action",this.state.selectedTable,t,e)},t.prototype.D=function(t,e,n,r){var i=this;return"string"!=typeof this.state.selectedTable?Promise.reject("Can't do Action/View with selected table!"):this.doFilter(t,{result:{AVType:t,table:e,AVName:n,AVargs:r}}).then(function(t){var e="Action"===t.AVType?"actions":"views",n=i.tables[t.table][e].reduce(function(e,n){return n.name===t.AVName?n:e},null);return n?n.call(n.args?s.cleanArgs(n.args,t.AVargs):{},i):new Promise(function(e,n){return n(t.AVType+' "'+t.AVName+'" Not Found!')})})},t.prototype.query=function(t,e){var n=this.state.activeAV;return this.state.activeAV="",new d.q(this,this.state.selectedTable,t,e,n)},t.prototype.triggerQuery=function(t,e,n,r){var i=this;this.state.connected||"string"!=typeof t.table?this.doFilter("query",{result:t}).then(function(t){i.config.queue&&!t.skipQueue?i.T.newItem({query:t,onRow:e,complete:n,error:r},function(t,e,n){new l.x(i,t.query,t.onRow,function(){e(),t.complete()},function(n){e(),t.error(n)})}):new l.x(i,t,e,n,r)}).catch(r):r("nSQL: Can't do a query before the database is connected!")},t.prototype.triggerEvent=function(t,e){var n=this;return this.doFilter("event",{result:t}).then(function(t){n.state.hasAnyEvents&&s.setFast(function(){t.events.forEach(function(r){if(e||Object.keys(n.eventFNs["*"]).forEach(function(e){n.eventFNs["*"][e].trigger(r,t)}),n.eventFNs[t.target])if("_all_"===t.path)Object.keys(n.eventFNs[t.target]).forEach(function(e){n.eventFNs[t.target][e].trigger(r,t)});else{if(!n.eventFNs[t.target][t.path])return;n.eventFNs[t.target][t.path].trigger(r,t)}})})}).catch(function(t){console.error("Event suppressed",t)}),this},t.prototype.default=function(t,e){if(t=t||{},!e&&"string"!=typeof this.state.selectedTable)throw new Error("Must select table to generate defualts!");if(e=e||this.state.selectedTable,!this.tables[e])throw new Error('nSQL: Table "'+e+'" not found for generating default object!');var n="",r=function(t,e,i){var o={};if(i&&i.length&&-1!==i.indexOf("[]"))return Array.isArray(e)?e.map(function(e){return r(t,e,i.slice(0,i.lastIndexOf("[]")))}):[];var a=!1;if(t.forEach(function(t){if("*"!==t.key){if(t.model)if(-1!==t.type.indexOf("[]")){var i=void 0!==e?e[t.key]:[];Array.isArray(i)?o[t.key]=i.map(function(e){return r(t.model,e,t.type.slice(0,t.type.lastIndexOf("[]")))}):o[t.key]=[]}else o[t.key]=r(t.model,void 0!==e?e[t.key]:void 0);else o[t.key]=void 0!==e[t.key]?s.cast(t.type,e[t.key]):t.default;t.notNull&&null===o[t.key]&&(n="Data error, "+t.key+" cannot be null!")}else a=!0}),n.length)return new Error(n);if(a&&e){var u=t.map(function(t){return t.key});Object.keys(e).filter(function(t){return-1===u.indexOf(t)}).forEach(function(t){o[t]=e[t]})}return o};return r(this.tables[e].columns,t)},t.prototype.rawDump=function(t,e){var n=this,r=Object.keys(this.tables).filter(function(e){return!t.length||-1!==t.indexOf(e)});return s.chainAsync(r,function(t,r,i,o){n.adapter.readMulti(t,"all",void 0,void 0,!1,function(n){e(t,n)},i,o||s.noop)})},t.prototype.rawImport=function(t,e){var n=this,r=0,i=Object.keys(t).reduce(function(e,n){return e+t[n].length},0),o=Object.keys(this.tables),a=Object.keys(t).filter(function(t){return-1!==o.indexOf(t)});return s.chainAsync(a,function(o,a,u,c){var l=n.tables[o].pkCol;s.chainAsync(t[o],function(t,a,u,c){t[l]||!c?n.adapter.write(o,t[l],t,function(t){u(),r++,e&&e(Math.round(r/i*1e4)/100)},c||s.noop):c("No primary key found, can't import: "+JSON.stringify(t))}).then(u).catch(c)})},t.prototype.disconnect=function(){var t=this;return this.doFilter("disconnect",{}).then(function(){return new Promise(function(e,n){return t.adapter.disconnect(e,n)})})},t.prototype.observable=function(t,e){return new a.Observer(this,t,e||[])},t.prototype.extend=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return this.doFilter("extend",{scope:t,args:e,result:null})},t.prototype.loadJS=function(t,e){return"string"!=typeof this.state.selectedTable?Promise.reject("nSQL: Can't load JS into temporary table!"):Promise.resolve([])},t.prototype.JSONtoCSV=function(t,e,n){var r=[];if(!t.length)return"";var i=[];return n?i=n:(t.forEach(function(t){i=Object.keys(t).concat(i)}),i=i.filter(function(t,e,n){return n.indexOf(t)===e})),e&&r.push(i.join(",")),t.forEach(function(t){r.push(i.map(function(e){return null===t[e]||void 0===t[e]?"":"string"==typeof t[e]?'"'+t[e].replace(/\"/g,'""')+'"':"boolean"==typeof t[e]?!0===t[e]?"true":"false":"object"==typeof t[e]?'"'+JSON.stringify(t[e]).replace(/\"/g,'""')+'"':t[e]}).join(","))}),r.join("\r\n")},t.prototype.csvToArray=function(t){for(var e,n="",r=[""],i=[r],o=0,s=0,a=!0,u=0,c=t;u<c.length;u++)'"'===(e=c[u])?(a&&e===n&&(r[o]+=e),a=!a):","===e&&a?e=r[++o]="":"\n"===e&&a?("\r"===n&&(r[o]=r[o].slice(0,-1)),r=i[++s]=[e=""],o=0):r[o]+=e,n=e;return i[0]},t.prototype.CSVtoJSON=function(t,e){var n=this,r=[];return t.split(/\r?\n|\r|\t/gm).map(function(t,i){if(0!==i){var o=n.csvToArray(t);if(o){o=o.map(function(t){return t.trim()});for(var s=r.length,a={};s--;)if(o[s])if("true"===o[s]||"false"===o[s])a[r[s]]="true"===o[s];else if(0===o[s].indexOf("{")||0===o[s].indexOf("["))try{a[r[s]]=JSON.parse(o[s])}catch(t){a[r[s]]=o[s]}else 0===o[s].indexOf('"')?a[r[s]]=o[s].slice(1,o[s].length-1).replace(/\"\"/gim,'"'):a[r[s]]=o[s];return e?e(a):a}}else r=t.split(",")}).filter(function(t){return t})},t.prototype.loadCSV=function(t,e,n){var i=this,o=this.state.selectedTable;if("string"!=typeof o)return Promise.reject("nSQL: Can't load CSV into temporary table!");var a=this.CSVtoJSON(t,e);return s.chainAsync(a,function(t,e,u,c){n&&n(Math.round((e+1)/a.length*1e4)/100),i.triggerQuery(r({},s.buildQuery(o,"upsert"),{actionArgs:t}),s.noop,u,c||s.noop)})},t}();e.NanoSQL=y;var v=new y;e.nSQL=function(t){return v.selectTable(t)},"undefined"!=typeof window&&(window["nano-sql"]={nSQL:e.nSQL,NanoSQL:y})},function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){this.eventListeners={}}return t.prototype.on=function(t,e){this.eventListeners[t]||(this.eventListeners[t]=[]),this.eventListeners[t].push(e)},t.prototype.off=function(t,e){var n=this;this.eventListeners[t]&&this.eventListeners[t].length&&this.eventListeners[t].forEach(function(r,i){r===e&&n.eventListeners[t].splice(i,1)})},t.prototype.trigger=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.eventListeners[t]&&this.eventListeners[t].forEach(function(t){return t.apply(void 0,e)})},t}();e.ReallySmallEvents=n,e.RSE=new n},function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0});var r=n(1),i=n(0),o=function(){function t(t,e,n){this.P=t,this.F=e,this.J=n,this.W=[],this.g=0,this.B=[]}return t.prototype.debounce=function(t){return this.B[this.W.length]=t,this.W.push("dbnc"),this},t.prototype.distinct=function(t,e){return this.B[this.W.length]=[t||function(t){return t},e||function(t,e){return t===e}],this.W.push("dsct"),this},t.prototype.filter=function(t){return this.B[this.W.length]=t,this.W.push("fltr"),this},t.prototype.map=function(t){return this.B[this.W.length]=t,this.W.push("mp"),this},t.prototype.first=function(t){return this.B[this.W.length]=t||function(t,e){return!0},this.W.push("fst"),this},t.prototype.skip=function(t){return this.B[this.W.length]=t,this.W.push("skp"),this},t.prototype.take=function(t){return this.B[this.W.length]=t,this.W.push("tk"),this},t.prototype.subscribe=function(t){var e,n=this,i={},o={},s={},a={};return new r.INanoSQLObserverSubscriber(this.P,this.F,{next:function(r,u){if(n.g++,!e){var c=0,l=function(){if(c===n.W.length)"function"==typeof t?t(r,u):t.next&&t.next(r,u),e&&t.complete&&t.complete(r,u);else{var f=function(t){if(0===n.g)return 0;for(var e=t,r=n.g,i=!1;e--&&!i;)void 0!==a[e]&&(i=!0,r=a[e]);return r};switch(n.W[c]){case"dbnc":if(o[c]){clearTimeout(s[c]);var h=n.B[c];return void(s[c]=setTimeout(function(){Date.now()-o[c]>=h&&(o[c]=Date.now(),void 0===a[c]&&(a[c]=0),a[c]++,c++,l())},h-(Date.now()-o[c])))}o[c]=Date.now();break;case"dsct":var p=n.B[c][0](r,u);if(!1!==n.B[c][1](i[c],p))return;i[c]=p,void 0===a[c]&&(a[c]=0),a[c]++;break;case"fltr":if(!1===n.B[c](r,f(c),u))return;void 0===a[c]&&(a[c]=0),a[c]++;break;case"fst":if(!0!==n.B[c](r,f(c),u))return;void 0===a[c]&&(a[c]=0),a[c]++,e=!0;break;case"mp":r=n.B[c](r,f(c),u);break;case"skp":if(f(c)<=n.B[c])return;break;case"tk":f(c)>=n.B[c]&&(e=!0)}c++,l()}};l()}},error:function(e){t.error&&t.error(e)}},this.J)},t}();e.Observer=o;var s=function(){function t(t,e,n,r){var i=this;this.Q=!1,this.exec=this.exec.bind(this),this.unsubscribe=this.unsubscribe.bind(this);var o=this.U();o&&(this.J=this.J.concat([o.table]),this.J=this.J.filter(function(t,e,n){return n.indexOf(t)===e}),this.exec()),this.J.forEach(function(t){i.P.selectTable(t).on("change",i.exec)})}return t.prototype.exec=function(t){var e=this;i.setFast(function(){e.U(t)})},t.prototype.unsubscribe=function(){var t=this;this.J.forEach(function(e){t.P.selectTable(e).off("change",t.exec)}),this.Q=!0},t.prototype.closed=function(){return this.Q},t}();e.ObserverSubscriber=s},function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),i=n(7),o={};e.attachDefaultFns=function(t){t.functions={COUNT:{type:"A",aggregateStart:{result:0,row:{}},call:function(t,e,n,i){return i&&"*"!==i?r.deepGet(i,e)&&n.result++:n.result++,n.row=e,n}},MAX:{type:"A",aggregateStart:{result:void 0,row:{}},call:function(t,e,n,i){var o=r.deepGet(i,e)||0;return void 0===n.result?(n.result=o,n.row=e):o>n.result&&(n.result=o,n.row=e),n}},MIN:{type:"A",aggregateStart:{result:void 0,row:{}},call:function(t,e,n,i){var o=r.deepGet(i,e)||0;return void 0===n.result?(n.result=o,n.row=e):o<n.result&&(n.result=o,n.row=e),n}},GREATEST:{type:"S",call:function(t,e,n){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return{result:i.map(function(t){return isNaN(t)?r.getFnValue(e,t):parseFloat(t)}).sort(function(t,e){return t<e?1:-1})[0]}}},LEAST:{type:"S",call:function(t,e,n){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return{result:i.map(function(t){return isNaN(t)?r.getFnValue(e,t):parseFloat(t)}).sort(function(t,e){return t>e?1:-1})[0]}}},AVG:{type:"A",aggregateStart:{result:0,row:{},total:0,records:0},call:function(t,e,n,i){var o=parseFloat(r.deepGet(i,e)||0)||0;return n.total+=isNaN(o)?0:o,n.records++,n.result=n.total/n.records,n.row=e,n}},SUM:{type:"A",aggregateStart:{result:0,row:{}},call:function(t,e,n,i){var o=parseFloat(r.deepGet(i,e)||0)||0;return n.result+=isNaN(o)?0:o,n.row=e,n}},LOWER:{type:"S",call:function(t,e,n,i){return{result:String(r.getFnValue(e,i)).toLowerCase()}}},UPPER:{type:"S",call:function(t,e,n,i){return{result:String(r.getFnValue(e,i)).toUpperCase()}}},CAST:{type:"S",call:function(t,e,n,i,o){return{result:r.cast(o,r.deepGet(i,e))}}},CONCAT:{type:"S",call:function(t,e,n){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return{result:i.map(function(t){return r.getFnValue(e,t)}).join("")}}},LEVENSHTEIN:{type:"S",call:function(t,e,n,s,a){var u=r.getFnValue(e,s),c=r.getFnValue(e,a),l=u+"::"+c;return o[l]||(o[l]=i(u,c)),{result:o[l]}}},CROW:{type:"S",call:function(e,n,i,o,s,a){var u=r.deepGet(o+".lat",n),c=r.deepGet(o+".lon",n);return{result:r.crowDistance(u,c,parseFloat(s),parseFloat(a),t.earthRadius)}},whereIndex:function(t,e,n,i){if(">"===i[1]){var o="string"==typeof e.table?t.tables[e.table].indexes:{},s=r.resolvePath(n[0]),a=[];if(Object.keys(o).forEach(function(t){var e=o[t];r.a(e.path.slice(0,e.path.length-1),s)&&a.push(e.name.replace("-lat","").replace("-lon",""))}),2===a.length)return{index:a[0],fnName:"CROW",fnArgs:n,comp:i[1],value:i[2]}}return!1},queryIndex:function(t,e,n,i,o,s,a){var u="_idx_"+e.table+"_"+n.index+"-lat",c="_idx_"+e.table+"_"+n.index+"-lon",l=parseFloat(n.value||"0"),f=parseFloat(n.fnArgs?n.fnArgs[1]:"0"),h=parseFloat(n.fnArgs?n.fnArgs[2]:"0"),p=[-1,1].map(function(e){return f+l*e/t.earthRadius*(180*Math.PI)}),d=[-1,1].map(function(e){return h+l*e/t.earthRadius*(180*Math.PI)/Math.cos(f*Math.PI/180)}),y={};r.allAsync([u,c],function(e,n,r,i){var o=0===n?p:d;t.adapter.readMulti(e,"range",o[0],o[1],!1,function(t,e){t.pks.forEach(function(t){y[t]=Math.max(e,y[t]?y[t]:0)})},function(){r(null)},i)}).then(function(){var u=0,c=Object.keys(y).filter(function(t){return 1===y[t]}),p=new r.w(function(s,a,c,p){var d=r.deepGet((n.fnArgs?n.fnArgs[0]:"")+".lat",s),y=r.deepGet((n.fnArgs?n.fnArgs[0]:"")+".lon",s);r.crowDistance(d,y,f,h,t.earthRadius)<l&&(o(i?s[t.tables[e.table].pkCol]:s,u),u++),c()},a,s);r.allAsync(c,function(n,r,i,o){t.adapter.read(e.table,n,function(t){t&&p.newItem(t),i(null)},a)}).catch(a).then(function(){p.finished()})}).catch(a)}}},Object.getOwnPropertyNames(Math).forEach(function(e){t.functions[e.toUpperCase()]={type:"S",call:function(t,n,i){for(var o=[],s=3;s<arguments.length;s++)o[s-3]=arguments[s];var a=o.map(function(t){return parseFloat(isNaN(t)?r.deepGet(t,n):t)});return{result:Math[e].apply(null,a)}}}})}},function(t,e,n){"use strict";t.exports=function(t,e,n){var o,s,a,u,c,l,f,h;if(t===e)return 0;if(o=t.length,s=e.length,0===o)return s;if(0===s)return o;for(n&&(t=t.toLowerCase(),e=e.toLowerCase()),f=0;f<o;)i[f]=t.charCodeAt(f),r[f]=++f;for(h=0;h<s;)for(a=e.charCodeAt(h),u=c=h++,f=-1;++f<o;)l=a===i[f]?c:c+1,c=r[f],r[f]=u=c>u?l>u?u+1:l:l>c?c+1:l;return u};var r=[],i=[]},function(t,e,n){var r=this&&this.O||Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t};Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),o=n(0);e.secondaryIndexQueue={};var s={},a=function(){function t(t,e,n,r,i){var o=this;this.nSQL=t,this.query=e,this.progress=n,this.complete=r,this.error=i,this.V=[],this.H=!0,this.K=[],this.X=!1,this.Y=!1,this.G=[],this.z={},this.query.state="processing";var s=e.action.toLowerCase().trim();if(this.Z=this.Z.bind(this),"select"!==s&&"string"!=typeof e.table)return this.query.state="error",void this.error('Only "select" queries are available for this resource!');if("string"==typeof e.table&&!this.nSQL.state.connected)return this.query.state="error",void this.error("Can't execute query before the database has connected!");var a=function(t,e){return"string"!=typeof o.query.table?(o.query.state="error",void o.error(o.query.action+" query requires a string table argument!")):t&&!o.query.actionArgs?(o.query.state="error",void o.error(o.query.action+" query requires an additional argument!")):void e()},u=function(){"error"!==o.query.state&&(o.query.state="complete",o.complete())};switch(this.query.cacheID||(this.query.cacheID=this.query.queryID),s){case"select":this.$(u,this.error);break;case"upsert":this.tt(this.progress,this.complete,this.error);break;case"delete":this.nt(this.progress,this.complete,this.error);break;case"show tables":this.it();break;case"describe":this.et();break;case"drop":case"drop table":this.rt(this.query.table,u,this.error);break;case"create table":case"create table if not exists":a(!0,function(){o.ot(o.query.actionArgs,u,o.error)});break;case"alter table":a(!0,function(){o.ut(o.query.actionArgs,u,o.error)});break;case"rebuild indexes":a(!1,function(){o.st(o.progress,u,o.error)});break;case"conform rows":a(!1,function(){o.ct(o.progress,u,o.error)});break;default:this.nSQL.doFilter("customQuery",{result:void 0,query:this,onRow:n,complete:r,error:i}).then(function(){o.query.state="error",o.error('Query type "'+e.action+'" not supported!')}).catch(function(t){o.query.state="error",o.error(t)})}}return t.prototype.ct=function(t,e,n){var r=this,i=this.query.table;if(this.nSQL.tables[i]){var s=0,a=new o.w(function(e,n,a,u){var c=r.nSQL.default(e,i);r.nSQL.doFilter("conformRow",{result:c,oldRow:e}).then(function(c){r.nSQL.state.hasAnyEvents&&(r.nSQL.triggerEvent({target:i,path:"*",events:["upsert","change","*"],time:Date.now(),result:c,oldRow:e,query:r.query}),Object.keys(r.nSQL.eventFNs[r.query.table]).forEach(function(t){"*"!==t&&(o.a(o.deepGet(t,e),o.deepGet(t,c))||r.nSQL.triggerEvent({target:r.query.table,path:t,events:["upsert","change","*"],time:Date.now(),result:c,oldRow:e,query:r.query},!0))})),r.at(r.query.table,e,c,function(){t(void 0,n),s++,a()},u)}).catch(u)},n,function(){t({result:"Conformed "+s+" row(s)."},s),e()});this.ft(function(t,e){a.newItem(t)},function(){a.finished()})}else n(new Error("Table "+i+" not found for conforming!"))},t.prototype.ht=function(t,e,n,r){var i=this,o=this.query.cacheID;if("function"==typeof n){if(s[o]||(s[o]={}),!s[o][t])return s[o][t]={loading:!0,rows:[],cache:!0},void n(e).then(function(e){var n=e.cache&&!e.filtered||!1;s[o][t]={loading:!1,rows:n?e.rows:[],cache:n},r(e)}).catch(this.lt);if(s[o][t].loading)return void setTimeout(function(){i.ht(t,e,n,r)},10);if(s[o][t].cache)return void r({filtered:!1,rows:s[o][t].rows,cache:!0});n(e).then(function(t){r(t)}).catch(this.lt)}else r({rows:n,filtered:!1,cache:!1})},t.prototype.vt=function(t,e,n,i){var s,a=this;if(!t[0])return n(e),void i();var u=function(e,i,s){var c=t[i],l=0,f=[];if("cross"!==c.type&&!c.on)return a.query.state="error",void a.error(new Error("Non 'cross' joins require an 'on' parameter!"));var h=new Error("Must use 'AS' when joining temporary tables!");if("string"!=typeof c.with.table&&!c.with.as)return a.query.state="error",void a.error(h);if("string"!=typeof a.query.table&&!a.query.tableAS)return a.query.state="error",void a.error(h);var p=new o.w(function(e,r,o,s){t[i+1]?u(e,i+1,o):(n(e),o())},a.error,s),d="string"==typeof c.with.table?a.nSQL.tables[c.with.table].pkCol:"",y=String(c.with.as||c.with.table),v=String(a.query.tableAS||a.query.table),g=a.query.tableAS||a.query.table,b=c.on&&"cross"!==c.type?a.dt(c.on,c.with.as||c.with.table,g,e):[];a.ht(g,b,c.with.table,function(t){var n=function(t){var n;l++,"right"!==c.type&&"outer"!==c.type||f.push(d?t[d]:o.hash(JSON.stringify(t))),p.newItem(r({},e,((n={})[y]=t,n)))},i=function(){var t,n;switch(c.type){case"left":0===l&&p.newItem(r({},e,((t={})[y]=void 0,t))),p.finished();break;case"inner":case"cross":p.finished();break;case"outer":case"right":0===l&&"outer"===c.type&&p.newItem(r({},e,((n={})[y]=void 0,n))),a.nSQL.triggerQuery(r({},o.buildQuery(c.with.table,"select"),{skipQueue:!0,cacheID:a.query.cacheID,where:d?[d,"NOT IN",f]:void 0}),function(t){var n;(d||-1===f.indexOf(o.hash(JSON.stringify(t))))&&p.newItem(r({},e,((n={})[v]=void 0,n[y]=t,n)))},function(){p.finished()},function(t){a.query.state="error",a.error(t)})}};t.filtered?(t.rows.forEach(n),i()):a.nSQL.triggerQuery(r({},o.buildQuery(t.rows,"select"),{tableAS:c.with.as,cacheID:a.query.cacheID,where:c.on&&"cross"!==c.type?a.dt(c.on,c.with.as||c.with.table,g,e):void 0,skipQueue:!0}),n,i,function(t){a.query.state="error",a.error(t)})})};u(((s={})[String(this.query.tableAS||this.query.table)]=e,s),0,i)},t.prototype.$=function(t,e){var n=this;if(this.pt=this.query.where?this.gt(this.query.where,"string"!=typeof this.query.table||void 0!==this.query.union):{type:i.IWhereType.none},this.yt=this.query.having?this.gt(this.query.having,!0):{type:i.IWhereType.none},this.bt(),"error"!==this.query.state){var r=[this.query.offset||0,(this.query.offset||0)+(this.query.limit||0)],a=r[0]+r[1]>0;if(this.query.union){var u=[],c=[],l=0;o.chainAsync(this.query.union.queries,function(t,e,i){t().then(function(t){c.length||(c=Object.keys(t[0])),n.query.where&&(t=t.filter(function(t,e){return n.wt(t,n.pt.slowWhere)})),t=t.map(function(t){if(n.query.union&&"distinct"===n.query.union.type){var r=o.hash(JSON.stringify(t));if(0===e)u.push(r);else{if(-1!==u.indexOf(r))return;u.push(r)}}return Object.keys(t).reduce(function(e,n,r){return r<c.length&&(e[c[r]]=t[n]),e},{})}).filter(function(t){return t}),n.query.orderBy?n.V=n.V.concat(t.map(function(t){var e=n.St(t);return!n.query.having||n.wt(e,n.yt.slowWhere)?e:void 0}).filter(function(t){return t})):t.forEach(function(t,e){var i=n.St(t);(!n.query.having||n.wt(i,n.yt.slowWhere))&&(a?l>=r[0]&&l<r[1]&&n.progress(n.St(t),l):n.progress(n.St(t),l),l++)}),i()})}).then(function(){if(n.query.orderBy){var e=n.V.sort(n.Z);(a?e.slice(r[0],r[1]):e).forEach(n.progress)}n.query.cacheID&&n.query.cacheID===n.query.queryID&&delete s[n.query.cacheID],t()})}else{var f=Array.isArray(this.query.join)?this.query.join:[this.query.join],h=new o.w(function(t,e,r,i){var o=!0;n.query.having&&(o=n.wt(n.St(t),n.yt.slowWhere)),o?n.query.graph?n.mt(n.query.graph||[],n.query.tableAS||n.query.table,t,p,function(t,e){n.progress(n.St(t),e),p++,r()}):(n.progress(n.St(t),p),p++,r()):r()},this.lt,function(){n.query.cacheID&&n.query.cacheID===n.query.queryID&&delete s[n.query.cacheID],t()}),p=0,d=new o.w(function(t,e,i,s){t=o._(t),n.vt(f,t,function(t){n.H?((!a||p>=r[0]&&p<r[1])&&h.newItem(t),p++):n.V.push(t)},i)},this.error,function(){n.H?h.finished():o.allAsync(n.V,function(t,e,r){n.mt(n.query.graph||[],n.query.tableAS||n.query.table,t,e,r)}).then(function(e){n.V=e,n._t(),n.query.having&&(n.V=n.V.filter(function(t){return n.wt(t,n.yt.slowWhere)})),n.query.orderBy&&n.V.sort(n.Z),a&&(n.V=n.V.slice(r[0],r[1])),n.V.forEach(function(t,e){n.progress(t,r[0]+e)}),n.query.cacheID&&n.query.cacheID===n.query.queryID&&delete s[n.query.cacheID],t()})}),y="string"==typeof this.query.table;this.ft(function(t,e){d.newItem(t),y&&n.nSQL.triggerEvent({target:n.query.table,path:"_all_",events:["select","*"],time:Date.now(),result:t,query:n.query})},function(){d.finished()})}}},t.prototype._t=function(){var t=this;this.query.groupBy||this.Et?(this.V.sort(function(e,n){return t.Ot(e,n,t.Nt)}).forEach(function(e,n){var r=t.Nt.sort.map(function(t){return String(o.deepGet(t.path,e))}).join(".");void 0===t.z[r]&&(t.z[r]=t.G.length);var i=t.z[r];t.G[i]||t.G.push([]),t.G[i].push(e)}),this.V=[],this.Et?this.G.forEach(function(e){var n=t.K.reduce(function(e,n,r){return t.nSQL.functions[n.value]&&"A"===t.nSQL.functions[n.value].type&&(e[r]={idx:r,name:n.value,aggr:o.u(t.nSQL.functions[n.value].aggregateStart),args:n.args}),e},[]),r=n.filter(function(t){return t})[0];e.forEach(function(e,r){n.forEach(function(r,i){var o;r&&(n[i].aggr=(o=t.nSQL.functions[r.name]).call.apply(o,[t.query,e,n[i].aggr].concat(n[i].args)))})}),t.V.push(t.K.reduce(function(e,i,s){var a,u=i.isFn?i.value+"("+(i.args||[]).join(", ")+")":i.value;return e[i.as||u]=i.isFn&&n[s]?n[s].aggr.result:i.isFn?(a=t.nSQL.functions[i.value]).call.apply(a,[t.query,n[r.idx].aggr.row,{}].concat(i.args||[])):o.deepGet(i.value,n[r.idx].aggr.row),e},{}))}):this.G.forEach(function(e){e.forEach(function(e){t.V.push(t.St(e))})})):this.V=this.V.map(function(e){return t.St(e)})},t.prototype.dt=function(t,e,n,r){var i=this;return"function"==typeof t?function(e){return t(e,r)}:("string"==typeof t[0]?[t]:t).map(function(t){if(Array.isArray(t[0]))return i.dt(t,e,n,r);if("AND"===t||"OR"===t)return t;var s=o.resolvePath(t[0]),a=o.resolvePath(t[2]),u=s[0]===n;return[u?a.slice(1).join("."):s.slice(1).join("."),u?-1!==t[1].indexOf(">")?t[1].replace(">","<"):t[1].replace("<",">"):t[1],o.deepGet(u?s:a,r)]})},t.prototype.mt=function(t,e,n,i,s){var a=this,u=Array.isArray(t)?t:[t];u&&0!==u.length?o.allAsync(u,function(t,i,s){var u,c=new Error("Must use 'AS' when graphing temporary tables!");if("string"!=typeof t.with.table&&!t.with.as)return a.query.state="error",void a.error(c);if("string"!=typeof a.query.table&&!a.query.tableAS)return a.query.state="error",void a.error(c);n[t.key]=[];var l=a.dt(t.on,t.with.as||t.with.table,e,((u={})[e]=n,u));a.ht(t.with.as||t.with.table,l,t.with.table,function(e){e.filtered?(e.rows.forEach(function(e){t.single?n[t.key]=e:n[t.key].push(e)}),s(null)):a.nSQL.triggerQuery(r({},o.buildQuery(e.rows,"select"),{tableAS:t.with.as,actionArgs:t.select,where:l,limit:t.limit,offset:t.offset,orderBy:t.orderBy,groupBy:t.groupBy,graph:t.graph,skipQueue:!0,cacheID:a.query.cacheID}),function(e){t.single?n[t.key]=e:n[t.key].push(e)},function(){s(null)},a.lt)})}).then(function(){s(n,i)}):s(n,i)},t.prototype.tt=function(t,e,n){var r=this;if(this.query.actionArgs||(n("Can't upsert without records!"),this.query.state="error"),-1!==this.query.table.indexOf(".")||-1!==this.query.table.indexOf("[")){var s=o.resolvePath(this.query.table);this.query.table=s.shift(),this.upsertPath=s}if(this.pt=this.query.where?this.gt(this.query.where):{type:i.IWhereType.none},"error"!==this.query.state){var a=Array.isArray(this.query.actionArgs)?this.query.actionArgs:[this.query.actionArgs],u=this.nSQL.tables[this.query.table];if(this.pt.type===i.IWhereType.none)o.allAsync(a,function(t,e,n,i){t[u.pkCol]?o.adapterFilters(r.nSQL,r.query).read(r.query.table,t[u.pkCol],function(e){e?r.Tt(t,e,n,i):r.kt(t,n,i)},i):r.kt(t,n,i)}).then(function(){t({result:a.length+" row(s) upserted"},0),e()});else{if(a.length>1)return this.query.state="error",void n("Cannot upsert multiple records with where condition!");var c=0,l=new o.w(function(t,e,n,i){c++,r.Tt(a[0],t,n,i)},n,function(){t({result:c+" row(s) upserted"},0),e()});this.ft(function(t,e){l.newItem(t)},function(){l.finished()})}}},t.prototype.Tt=function(t,e,n,i){var s=this;this.nSQL.doFilter("updateRow",{result:t,row:e,query:this.query}).then(function(t){var a=s.nSQL.default(s.upsertPath?o.deepSet(s.upsertPath,o._(e),t):r({},e,t),s.query.table);"string"==typeof s.query.table&&(s.nSQL.triggerEvent({target:s.query.table,path:"*",events:["upsert","change","*"],time:Date.now(),result:a,oldRow:e,query:s.query}),Object.keys(s.nSQL.eventFNs[s.query.table]).forEach(function(t){"*"!==t&&(o.a(o.deepGet(t,e),o.deepGet(t,a))||s.nSQL.triggerEvent({target:s.query.table,path:t,events:["upsert","change","*"],time:Date.now(),result:a,oldRow:e,query:s.query},!0))})),s.at(s.query.table,e,a,function(){n(a)},i)}).catch(i)},t.prototype.at=function(t,e,n,r,i){var s=this,a=this.At(this.nSQL.tables[this.query.table].indexes,n),u=this.At(this.nSQL.tables[this.query.table].indexes,e),c=this.nSQL.tables[t];o.allAsync(Object.keys(u).concat(["__pk__"]),function(e,r,i,l){if("__pk__"===e)o.adapterFilters(s.nSQL,s.query).write(t,n[c.pkCol],n,function(t){n[c.pkCol]=t,i(null)},l);else{var f="_idx_"+s.query.table+"_"+e;if(!1===o.a(a[e],u[e]))if(c.indexes[e].isArray){var h=a[e].filter(function(t,n,r){return-1===u[e].indexOf(t)}),p=u[e].filter(function(t,n,r){return-1===a[e].indexOf(t)});o.allAsync([h,p],function(t,e,r){t.length?o.allAsync(t,function(t,r,i){s.jt(f,t,n[c.pkCol],0===e,function(){i(null)},l)}).then(r):r(null)}).then(i)}else o.allAsync(["rm","add"],function(t,r,i){switch(t){case"add":s.jt(f,a[e],n[c.pkCol],!0,function(){i(null)},l);break;case"rm":s.jt(f,u[e],n[c.pkCol],!1,function(){i(null)},l)}}).then(i);else i(null)}}).then(r).catch(i)},t.prototype.jt=function(t,n,r,i,s,a){e.secondaryIndexQueue[this.nSQL.state.id+this.query.table].newItem({indexTable:t,value:n,pk:r,addToIndex:i,done:s,err:a,query:this.query,nSQL:this.nSQL},function(t,e,n){o.adapterFilters(t.nSQL,t.query).read(t.indexTable,t.value,function(r){var i=o._(r||function(t){return{id:t,pks:[]}}(t.value)),s=i.pks.indexOf(t.pk);if(t.addToIndex)-1===s&&i.pks.push(t.pk);else{if(-1===s)return void t.done();i.pks.splice(s,1)}o.adapterFilters(t.nSQL,t.query).write(t.indexTable,t.value,i,function(){t.done(),e()},function(e){t.err(),n&&n(e)})},t.err)})},t.prototype.kt=function(t,e,n){var r=this;this.nSQL.doFilter("addRow",{result:t,query:this.query}).then(function(t){var i=r.nSQL.tables[r.query.table];t=r.nSQL.default(o._(r.upsertPath?o.deepSet(r.upsertPath,{},t):t),r.query.table);var s=r.At(r.nSQL.tables[r.query.table].indexes,t);o.adapterFilters(r.nSQL,r.query).write(r.query.table,t[i.pkCol],t,function(n){t[i.pkCol]=n,o.allAsync(Object.keys(s),function(e,n,a,u){var c="_idx_"+r.query.table+"_"+e;if(i.indexes[e].isArray){var l=s[e]||[];o.allAsync(l,function(e,n,o){r.jt(c,e,t[i.pkCol],!0,function(){a(null)},u)}).then(a)}else r.jt(c,s[e],t[i.pkCol],!0,function(){a(null)},u)}).then(function(){e(t)})},n)}).catch(n)},t.prototype.nt=function(t,e,n){var r=this;if(this.pt=this.query.where?this.gt(this.query.where):{type:i.IWhereType.none},"error"!==this.query.state){var s=0,a=this.nSQL.tables[this.query.table],u=new o.w(function(e,n,i,o){t(void 0,s),s++,r.It(a,e,i,o)},n,function(){t({result:s+" row(s) deleted"},s),e()});this.ft(function(t,e){u.newItem(t)},function(){u.finished()})}},t.prototype.It=function(t,e,n,r){var i=this,s=this.At(t.indexes,e);this.nSQL.doFilter("deleteRow",{result:e,query:this.query}).then(function(e){"string"==typeof i.query.table&&i.nSQL.triggerEvent({target:i.query.table,path:"_all_",events:["change","delete","*"],time:Date.now(),result:e,query:i.query}),o.allAsync(Object.keys(s).concat(["__del__"]),function(n,a,u){if("__del__"===n)i.nSQL.adapter.delete(i.query.table,e[t.pkCol],function(){u(null)},function(t){i.query.state="error",r(t)});else{var c="_idx_"+i.query.table+"_"+n;if(t.indexes[n].isArray){var l=s[n]||[];o.allAsync(l,function(n,o,s){i.jt(c,n,e[t.pkCol],!1,function(){s(null)},r)}).then(u)}else i.jt(c,s[n],e[t.pkCol],!1,function(){u(null)},i.lt)}}).then(n).catch(r)})},t.prototype.At=function(t,e){var n=this;return Object.keys(t).reduce(function(r,i){var s=o.deepGet(t[i].path,e),a=t[i].type;return r[i]=t[i].isArray?(Array.isArray(s)?s:[]).map(function(t){return n.nSQL.indexTypes[a](t)}):n.nSQL.indexTypes[a](s),r},{})},t.prototype.it=function(){this.progress({tables:Object.keys(this.nSQL.tables)},0),this.complete()},t.prototype.et=function(){return"string"!=typeof this.query.table?(this.query.state="error",void this.error("Can't call describe on that!")):this.nSQL.tables[this.query.table]?(this.progress({describe:o.u(this.nSQL.tables[this.query.table].columns)},0),void this.complete()):(this.query.state="error",void this.error("Table "+this.query.table+" not found!"))},t.prototype.Mt=function(t){return Object.keys(t).reduce(function(e,n){var r=t[n];return r?(Object.keys(r).forEach(function(t){e[n+"."+t]=r[t]}),e):e},{})},t.prototype.St=function(t){var e=this;if(this.K.length){var n={};return this.K.forEach(function(r){var i;if(r.isFn){if(!e.nSQL.functions[r.value])return e.query.state="error",void e.error("Function "+r.value+" not found!");n[r.as||r.value]=(i=e.nSQL.functions[r.value]).call.apply(i,[e.query,t,{}].concat(r.args||[])).result}else n[r.as||r.value]=o.deepGet(r.value,t)}),this.query.join?this.Mt(n):n}return this.query.join?this.Mt(t):t},t.prototype.Z=function(t,e){return this.Ot(t,e,this.Rt)},t.prototype.Ot=function(t,e,n){return n.sort.reduce(function(n,r){var i=o.deepGet(r.path,t),s=o.deepGet(r.path,e);return n||(i===s?0:(i>s?1:-1)*("DESC"===r.dir?-1:1))},0)},t.prototype.ot=function(t,n,i){var s=this;new Promise(function(e,n){var i=!1,o=t.name;t.R||0!==o.indexOf("_")&&null===o.match(/\s/g)&&null===o.match(/[\(\)\]\[\.]/g)?(t.model.forEach(function(e){var r=e.key.split(":");1===r.length&&r.push("any"),r[0]&&null===r[0].match(/[\(\)\]\[\.]/g)&&0!==r[0].indexOf("_")||(i=!0,n("nSQL: Invalid Data Model at "+t.name+", "+JSON.stringify(e)+"! https://docs.nanosql.io/setup/data-models"))}),t.model=t.model.map(function(t){return r({},t,{key:t.key.replace(/\s+/g,"-")})}),i||e()):n("nSQL: Invalid Table Name "+t.name+"! https://docs.nanosql.io/setup/data-models")}).then(function(){return s.nSQL.doFilter("configTable",{result:t,query:s.query})}).then(function(t){var n=function(t){return t.map(function(t){return 0===(t.key.split(":")[1]||"any").indexOf("geo")&&(t.model=[{key:"lat:float",default:0},{key:"lon:float",default:0}]),t.model&&(t.model=n(t.model)),t})},r=function(t){return t.filter(function(t){return"*"!==t.key}).map(function(t){return{key:t.key.split(":")[0],type:t.key.split(":")[1]||"any",default:t.default||null,notNull:!(!t.props||-1===t.props.indexOf("not_null()")),model:t.model?r(t.model):void 0}})},i="",a=n(t.model),u={},c=t.model.reduce(function(t,e){return e.props&&-1!==e.props.indexOf("pk()")?e.key.split(":")[1]:t},"");if(u[t.name]={model:a,columns:r(a),actions:t.actions||[],views:t.views||[],indexes:(t.indexes||[]).map(function(t){return{name:t.name.replace(/\W/g,"").replace(/\s+/g,"-").toLowerCase(),type:(t.key.split(":")[1]||"string").replace(/\[\]/gim,""),isArray:-1!==(t.key.split(":")[1]||"string").indexOf("[]"),path:o.resolvePath(t.key.split(":")[0])}}).reduce(function(t,e){return-1===Object.keys(s.nSQL.indexTypes).indexOf(e.type)?(i='Index "'+e.name+'" does not have a valid type!',t):(-1!==e.type.indexOf("geo")?(t[e.name+"-lat"]={name:e.name+"-lat",type:"float",path:e.path.concat(["lat"])},t[e.name+"-lon"]={name:e.name+"-lon",type:"float",path:e.path.concat(["lon"])}):t[e.name]=e,t)},{}),pkType:c,pkCol:t.model.reduce(function(t,e){return e.props&&-1!==e.props.indexOf("pk()")?e.key.split(":")[0]:t},""),isPkNum:-1!==["number","int","float"].indexOf(c),ai:t.model.reduce(function(t,e){return!(!e.props||-1===e.props.indexOf("pk()")||-1===e.props.indexOf("ai()"))||t},!1)},""===u[t.name].pkCol&&(u[t.name].pkCol="_id_",u[t.name].pkType="uuid",u[t.name].model.unshift({key:"_id_:uuid",props:["pk()"]}),u[t.name].columns=r(u[t.name].model)),i&&i.length)return Promise.reject(i);var l=[t.name];return Object.keys(u[t.name].indexes).forEach(function(e,n){var r=u[t.name].indexes[e],i="_idx_"+t.name+"_"+r.name;l.push(i),u[i]={model:[{key:"id:"+(r.type||"string"),props:["pk()"]},{key:"pks:"+u[t.name].pkType+"[]"}],columns:[{key:"id",type:r.type||"string"},{key:"pks",type:u[t.name].pkType+"[]"}],actions:[],views:[],indexes:{},isPkNum:-1!==["number","int","float"].indexOf(r.type||"string"),pkType:r.type,pkCol:"id",ai:!1}}),e.secondaryIndexQueue[s.nSQL.state.id+t.name]=new o.w,o.allAsync(l,function(t,e,n,r){s.nSQL.doFilter("addTable",{result:{name:t,conf:u[t]},query:s.query}).then(function(t){t?s.nSQL.adapter.createAndInitTable(t.name,t.conf,function(){s.nSQL.tables[t.name]=t.conf,n(null)},r):n(null)})})}).then(n).catch(i)},t.prototype.ut=function(t,e,n){var r=this;this.nSQL.doFilter("alterTable",{result:t,query:this.query}).then(function(i){if(i){var s=[i.name];Object.keys(r.nSQL.tables[t.name].indexes).forEach(function(t){s.push("_idx_"+i.name+"_"+t)}),o.allAsync(s,function(t,e,n,o){r.nSQL.adapter.disconnectTable(i.name,n,o)}).then(function(){r.ot(i,e,n)}).catch(n)}else e()}).catch(n)},t.prototype.rt=function(t,e,n){var r=this;this.nSQL.doFilter("dropTable",{result:t,query:this.query}).then(function(t){if(t){var i=[t];i.forEach(function(t){Object.keys(r.nSQL.tables[t].indexes).forEach(function(e){i.push("_idx_"+t+"_"+e)})}),o.allAsync(i,function(t,e,n,i){r.nSQL.adapter.dropTable(t,function(){delete r.nSQL.tables[t],n(t)},i)}).then(e).catch(n)}else e()})},t.prototype.lt=function(t){this.query.state="error",this.error(t)},t.prototype.Lt=function(t,e,n,r,i){var s=this;if(e.index&&e.fnName)this.nSQL.functions[e.fnName].queryIndex(this.nSQL,this,e,t,r,i,this.lt);else{var a="_pk_"===e.index,u=this.nSQL.tables[this.query.table].pkCol,c="_idx_"+this.query.table+"_"+e.index,l=0,f=0,h=!1,p=function(){h&&0===l&&i()},d=function(e,n){e?a?(r(t?e[u]:e,0),n()):t?((e.pks||[]).forEach(function(t,e){r(t,f),f++}),n()):o.allAsync(e.pks,function(t,e,n){o.adapterFilters(s.nSQL,s.query).read(s.query.table,t,function(t){t&&(r(t,f),f++),n(null)},s.error)}).then(n):n()};if(e.indexArray)switch(e.comp){case"INCLUDES":o.adapterFilters(this.nSQL,this.query).read(c,e.value,function(t){d(t,i)},this.error);break;case"INTERSECT ALL":case"INTERSECT":var y={},v=0;o.allAsync(e.value||[],function(t,e,n){o.adapterFilters(s.nSQL,s.query).read(c,t,function(t){v=e+1,t&&(t.pks||[]).forEach(function(t){y[t]=(y[t]||0)+1}),n(null)},s.error)}).then(function(){d({pks:"INTERSECT"===e.comp?Object.keys(y):Object.keys(y).filter(function(t){return y[t]===v})},i)})}else switch(e.comp){case"=":t&&a?(r(e.value,0),i()):o.adapterFilters(this.nSQL,this.query).read(a?this.query.table:c,e.value,function(t){d(t,i)},this.error);break;case"BETWEEN":o.adapterFilters(this.nSQL,this.query).readMulti(a?this.query.table:c,"range",e.value[0],e.value[1],n,function(t,e){l++,d(t,function(){l--,p()})},function(){h=!0,p()},this.lt);break;case"IN":var g=n?e.value.sort(function(t,e){return t<e?1:-1}):e.value.sort(function(t,e){return t>e?1:-1});t&&a?(g.forEach(function(t,e){return r(t,e)}),i()):o.allAsync(g,function(t,e,n){o.adapterFilters(s.nSQL,s.query).read(a?s.query.table:c,t,function(t){l++,d(t,function(){l--,p(),n(null)})},s.error)}).then(function(){h=!0,p()})}}},t.prototype.Ct=function(t,e){var n=this;if(this.pt.fastWhere)if(1===this.pt.fastWhere.length){var r=this.pt.fastWhere[0],i=this.X&&"DESC"===this.Rt.sort[0].dir;this.Lt(!1,r,i,t,e)}else{var s={},a=0;o.chainAsync(this.pt.fastWhere,function(t,e,r){e%2!=1?(a=e,n.Lt(!0,t,!1,function(t){s[t]=(s[t]||0)+1},r)):r()}).then(function(){var r=[];Object.keys(s).forEach(function(t){s[t]===a&&r.push(t)}),n.Lt(!1,{index:"_pk_",col:n.nSQL.tables[n.query.table].pkCol,comp:"IN",value:r},!1,t,e)})}},t.prototype.ft=function(t,e){var n=this,r=function(r){for(var o=0;o<r.length;)n.pt.type!==i.IWhereType.none?n.pt.whereFn?n.pt.whereFn(r[o],o)&&t(r[o],o):n.wt(r[o],n.pt.slowWhere)&&t(r[o],o):t(r[o],o),o++;e()};if("string"==typeof this.query.table)switch(this.pt.type){case i.IWhereType.fast:this.Ct(t,e);break;case i.IWhereType.medium:this.Ct(function(e,r){n.wt(e,n.pt.slowWhere)&&t(e,r)},e);break;case i.IWhereType.slow:case i.IWhereType.none:case i.IWhereType.fn:var s=this.X&&"DESC"===this.Rt.sort[0].dir;o.adapterFilters(this.nSQL,this.query).readMulti(this.query.table,"all",void 0,void 0,s,function(e,r){n.pt.type===i.IWhereType.slow?n.wt(e,n.pt.slowWhere)&&t(e,r):n.pt.type===i.IWhereType.fn&&n.pt.whereFn?n.pt.whereFn(e,r)&&t(e,r):t(e,r)},e,function(t){n.query.state="error",n.error(t)})}else"function"==typeof this.query.table?this.ht(this.query.tableAS||this.query.table,this.query.where,this.query.table,function(t){r(t.rows)}):Array.isArray(this.query.table)&&r(this.query.table)},t.prototype.st=function(t,n,r){var i=this,s=this.query.table;if(this.nSQL.tables[s]){var a=Object.keys(this.nSQL.tables[s].indexes).map(function(t){return"_idx_"+s+"_"+t});if(this.query.where){var u=0,c=new o.w(function(e,n,r,o){i.It(i.nSQL.tables[s],e,function(){i.kt(e,r,o),t(void 0,u),u++},o)},r,function(){n(),t({result:"Rebuilt "+u+" row indexes."},u)});this.ft(function(t){c.newItem(t)},function(){c.finished()})}else o.allAsync(a,function(t,e,n,r){i.nSQL.adapter.dropTable(t,function(){i.nSQL.adapter.createAndInitTable(t,i.nSQL.tables[t],function(){n(null)},r)},r)}).then(function(){var a=0;e.secondaryIndexQueue[i.nSQL.state.id+s].newItem(o.uuid(),function(e,s,u){var c=new o.w(function(e,n,r,o){i.kt(e,function(e){a++,t(void 0,n),r()},o)},r,function(){t({result:"Rebuilt "+a+" row indexes."},a),n(),s()});i.ft(function(t){c.newItem(t)},function(){c.finished()})})}).catch(r)}else r(new Error("Table "+s+" not found for rebuilding indexes!"))},t.prototype.wt=function(t,e){if(e.length>1){for(var n="AND",r=!0,i=0;i<e.length;){var o=e[i];if(i%2==1)n=o;else{var s;s=Array.isArray(o[0])?this.wt(t,o):this.Dt(o,t),r=0===i?s:"AND"===n?r&&s:r||s}i++}return r}return this.Dt(e[0],t)},t.prototype.qt=function(e,n){if(!t.likeCache[n]){var r="";t.likeCache[n]=new RegExp(n.split("").map(function(t){return"\\"===r?(r=t,t):(r=t,"%"===t?".*":"_"===t?".":t)}).join(""),"gmi")}return"string"!=typeof e?"number"==typeof e?null!==String(e).match(t.likeCache[n]):null!==JSON.stringify(e).match(t.likeCache[n]):null!==e.match(t.likeCache[n])},t.prototype.xt=function(t,e){var n;return t.fnName?(n=this.nSQL.functions[t.fnName]).call.apply(n,[this.query,e,this.nSQL.functions[t.fnName].aggregateStart||{result:void 0}].concat(t.fnArgs||[])):o.deepGet(t.col,e)},t.prototype.Dt=function(t,e){var n=this.xt(t,e),r=t.value,i=t.comp;if("NULL"===r||"NOT NULL"===r){var s=-1!==[void 0,null,""].indexOf(n),a="="===i||"LIKE"===i;switch(r){case"NULL":return a?s:!s;case"NOT NULL":return a?!s:s}}if(-1!==["IN","NOT IN","BETWEEN","INTERSECT","INTERSECT ALL","NOT INTERSECT"].indexOf(i)&&!Array.isArray(r))return this.query.state="error",this.query.error('WHERE "'+i+'" comparison requires an array value!'),!1;switch(i){case"=":return o.a(r,n);case"!=":return!o.a(r,n);case">":return n>r;case"<":return n<r;case"<=":return n<=r;case">=":return n>=r;case"IN":return-1!==r.indexOf(n);case"NOT IN":return-1===r.indexOf(n);case"REGEXP":case"REGEX":return null!==(n||"").match(r);case"LIKE":return this.qt(n||"",r);case"NOT LIKE":return!this.qt(n||"",r);case"BETWEEN":return r[0]<=n&&r[1]>n;case"INCLUDES":return-1!==(n||[]).indexOf(r);case"NOT INCLUDES":return-1===(n||[]).indexOf(r);case"INTERSECT":return(n||[]).filter(function(t){return r.indexOf(t)>-1}).length>0;case"INTERSECT ALL":return(n||[]).filter(function(t){return r.indexOf(t)>-1}).length===r.length;case"NOT INTERSECT":return 0===(n||[]).filter(function(t){return r.indexOf(t)>-1}).length;default:return!1}},t.prototype.Pt=function(e,n){var r=e&&e.length?o.hash(JSON.stringify(e)):"";if(!r)return{sort:[],index:""};if(t.Ft[r])return t.Ft[r];var i=e.map(function(t){return t.split(" ").map(function(t){return t.trim()})}).reduce(function(t,e){return t.push({path:o.resolvePath(e[0]),dir:(e[1]||"asc").toUpperCase()}),t},[]),s="";if(n&&1===i.length){var a="string"==typeof this.query.table?this.nSQL.tables[this.query.table].pkCol:"";if(i[0].path[0].length&&i[0].path[0]===a)s="_pk_";else for(var u=Object.keys(this.nSQL.tables[this.query.table].indexes),c=u.length;c--&&!s;)o.a(this.nSQL.tables[this.query.table].indexes[u[c]],i[0].path)&&(s=this.nSQL.tables[this.query.table].indexes[u[c]].name)}return t.Ft[r]={sort:i,index:s},t.Ft[r]},t.prototype.bt=function(){var e=this,n=this.query.actionArgs&&this.query.actionArgs.length?JSON.stringify(this.query.actionArgs):"";this.Rt=this.Pt(this.query.orderBy||[],"string"==typeof this.query.table),this.Nt=this.Pt(this.query.groupBy||[],!1),n?t.Jt[n]?(this.Et=t.Jt[n].hasAggrFn,this.K=t.Jt[n].args):((this.query.actionArgs||[]).forEach(function(t){var n=t.split(/\s+as\s+/i).map(function(t){return t.trim()});if(-1!==n[0].indexOf("(")){var r=n[0].split("(")[1].replace(")","").split(",").map(function(t){return t.trim()}),i=n[0].split("(")[0].trim().toUpperCase();e.K.push({isFn:!0,value:i,as:n[1],args:r}),e.nSQL.functions[i]?"A"===e.nSQL.functions[i].type&&(e.Et=!0):(e.query.state="error",e.error('Function "'+i+'" not found!'))}else e.K.push({isFn:!1,value:n[0],as:n[1]})}),"error"!==this.query.state&&(t.Jt[n]={hasAggrFn:this.Et,args:this.K})):this.K=[];var r=!1;this.pt.type===i.IWhereType.none?(r="_pk_"===this.Rt.index)&&(this.X=!0):(r=!!(this.Rt.index.length&&this.pt.fastWhere&&o.a(this.pt.fastWhere[0].col,this.Rt.sort[0].path)))&&(this.Y=!0),(this.Rt.sort.length&&!r||this.Nt.sort.length||this.Et)&&(this.H=!1)},t.prototype.gt=function(e,n){var r=this,s=e||[],a=JSON.stringify(s)+(n?"0":"1");if(t.Wt[a])return t.Wt[a];if("function"==typeof s)return{type:i.IWhereType.fn,whereFn:s};if(!s.length)return t.Wt[a]={type:i.IWhereType.none},t.Wt[a];for(var u="string"==typeof this.query.table?Object.keys(this.nSQL.tables[this.query.table].indexes).map(function(t){return r.nSQL.tables[r.query.table].indexes[t]}):[],c="string"==typeof this.query.table?this.nSQL.tables[this.query.table].pkCol:"",l=function(t,e){var i=!n&&0===e;return t.reduce(function(t,n,s){if(s%2==1)return"string"!=typeof n?(r.query.state="error",r.error("Malformed WHERE statement!"),t):(t.push(n),t);if(!Array.isArray(n))return r.query.state="error",r.error("Malformed WHERE statement!"),t;if(Array.isArray(n[0]))t.push(l(n,e+1));else{if(-1===n[0].indexOf("(")){var a=!1,f=i?o.resolvePath(n[0]):[];return-1!==["=","BETWEEN","IN"].indexOf(n[1])&&i&&(n[0]===c?(a=!0,t.push({index:"_pk_",col:n[0],comp:n[1],value:n[2]})):u.forEach(function(e){!1===a&&o.a(e.path,f)&&!1===e.isArray&&(a=!0,t.push({index:e.name,col:n[0],comp:n[1],value:n[2]}))})),i&&!a&&-1!==["INCLUDES","INTERSECT","INTERSECT ALL"].indexOf(n[1])&&u.forEach(function(e){o.a(e.path,f)&&!0===e.isArray&&(a=!0,t.push({index:e.name,indexArray:!0,col:n[0],comp:n[1],value:n[2]}))}),a||t.push({col:n[0],comp:n[1],value:n[2]}),t}var h=n[0].split("(")[1].replace(")","").split(",").map(function(t){return t.trim()}).filter(function(t){return t}),p=n[0].split("(")[0].trim().toUpperCase(),d=!1;if(!r.nSQL.functions[p])return r.query.state="error",r.error('Function "'+p+'" not found!'),t;if(i&&r.nSQL.functions[p]&&r.nSQL.functions[p].whereIndex){var y=r.nSQL.functions[p].whereIndex(r.nSQL,r.query,h,n);y&&(d=!0,t.push(y))}d||t.push({fnName:p,fnArgs:h,comp:n[1],value:n[2]})}},[])},f=l("string"==typeof s[0]?[s]:s,0),h=!0,p=0,d=-1;p<f.length&&h;)p%2==1?"AND"!==f[p]?h=!1:d=p:Array.isArray(f[p])||!f[p].index?h=!1:d=p,p++;if(d%2==0&&d++,-1===d||"AND"!==f[d]&&f[d])t.Wt[a]={type:i.IWhereType.slow,slowWhere:f};else{var y=f.slice(d+1);t.Wt[a]={type:y.length?i.IWhereType.medium:i.IWhereType.fast,slowWhere:y,fastWhere:f.slice(0,d)}}return t.Wt[a]},t.likeCache={},t.Ft={},t.Jt={},t.Wt={},t}();e.x=a},function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0});var r=n(1),i=n(0),o=function(){function t(t){this.useLS=t,this.plugin={name:"Sync Storage Adapter",version:r.VERSION},this.Bt={},this.Qt={},this.Ut={}}return t.prototype.connect=function(t,e,n){this.Vt=t,e()},t.prototype.createAndInitTable=function(t,e,n,r){if(this.Bt[t]=[],this.Qt[t]={},this.useLS){var i=localStorage.getItem(this.Vt+"->"+t+"_idx");i&&(this.Bt[t]=JSON.parse(i),this.Ut[t]=parseFloat(localStorage.getItem(this.Vt+"->"+t+"_ai")||"0"))}n()},t.prototype.disconnectTable=function(t,e,n){delete this.Bt[t],delete this.Qt[t],e()},t.prototype.dropTable=function(t,e,n){var r=this;this.Bt[t].forEach(function(e){r.useLS?localStorage.removeItem(r.Vt+"->"+t+"__"+e):delete r.Qt[t][e]}),this.useLS&&localStorage.removeItem(this.Vt+"->"+t+"_idx"),delete this.Bt[t],delete this.Qt[t],e()},t.prototype.disconnect=function(t,e){t()},t.prototype.write=function(t,e,n,r,o){if(void 0!==(e=e||i.generateID(this.nSQL.tables[t].pkType,this.Ut[t]+1))){if(this.Ut[t]=Math.max(e,this.Ut[t]),this.nSQL.tables[t].ai&&(this.Ut[t]=Math.max(this.Ut[t]||0,e)),-1===this.Bt[t].indexOf(e)){var s=i.binarySearch(this.Bt[t],e);this.Bt[t].splice(s,0,e),this.useLS&&(localStorage.setItem(this.Vt+"->"+t+"_idx",JSON.stringify(this.Bt[t])),localStorage.setItem(this.Vt+"->"+t+"_ai",String(this.Ut[t])))}n[this.nSQL.tables[t].pkCol]=e,this.useLS?(localStorage.setItem(this.Vt+"->"+t+"__"+e,JSON.stringify(n)),r(n[this.nSQL.tables[t].pkCol])):(this.Qt[t][e]=i.deepFreeze(n),r(n[this.nSQL.tables[t].pkCol]))}else o(new Error("Can't add a row without a primary key!"))},t.prototype.read=function(t,e,n,r){if(this.useLS){var i=localStorage.getItem(this.Vt+"->"+t+"__"+e);n(i?JSON.parse(i):void 0)}else n(this.Qt[t][e])},t.prototype.delete=function(t,e,n,r){var i=this.Bt[t].indexOf(e);-1!==i&&(this.Bt[t].splice(i,1),this.useLS&&localStorage.setItem(this.Vt+"->"+t+"_idx",JSON.stringify(this.Bt[t].keys()))),this.useLS?localStorage.removeItem(this.Vt+"->"+t+"__"+e):delete this.Qt[t][e],n()},t.prototype.readMulti=function(t,e,n,r,i,o,s,a){var u=this,c={range:[n,r],offset:[n,n+r],all:!1}[e];this.Bt[t].forEach(function(n,r){(!c||("range"===e?n>=c[0]&&n<c[1]:r>=c[0]&&r<c[1]))&&(u.useLS?o(JSON.parse(localStorage.getItem(u.Vt+"->"+t+"__"+n)||"{}"),r):o(u.Qt[t][n],r))}),s()},t.prototype.getIndex=function(t,e,n){e(this.Bt[t].slice())},t.prototype.getNumberOfRecords=function(t,e,n){e(this.Bt[t].length)},t}();e.SyncStorage=o},function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0});var r=n(1),i=n(0);e.SQLiteAbstract=function(t,e){var n=[],r=function(t){if(-1===n.indexOf(t))throw Error("No table "+t+" found!");return'"'+t+'"'};return{createAI:function(e,n){t(!0,'CREATE TABLE IF NOT EXISTS "_ai" (id TEXT PRIMARY KEY UNIQUE, inc BIGINT)',[],e,n)},createTable:function(e,r,i,o,s){n.push(e),t(!0,'CREATE TABLE IF NOT EXISTS "'+e+'" (id BLOB PRIMARY KEY UNIQUE, data TEXT)',[],function(){r?t(!1,'SELECT "inc" FROM "_ai" WHERE id = ?',[e],function(n){n.rows.length?(i[e]=parseInt(n.rows.item(0).inc),o()):(i[e]=0,t(!0,'INSERT into "_ai" (id, inc) VALUES (?, ?)',[e,0],function(){o()},s))},s):o()},s)},dropTable:function(e,i,o){t(!0,"DROP TABLE IF EXISTS "+r(e),[],function(){t(!0,'UPDATE "_ai" SET inc = ? WHERE id = ?',[0,e],function(){n.splice(n.indexOf(e),1),i()},o)},o)},write:function(e,n,o,s,a,u,c,l,f){if(void 0!==(s=s||i.generateID(e,c[o]+1))){c[o]=Math.max(s,c[o]),a[n]=s;var h=JSON.stringify(a);t(!0,"INSERT INTO "+r(o)+" (id, data) VALUES (?, ?) ON CONFLICT (id) DO UPDATE SET data = ?",[s,h,h],function(){u?t(!0,'UPDATE "_ai" SET inc = ? WHERE id = ?',[c[o],o],function(){l(s)},f):l(s)},f)}else f(new Error("Can't add a row without a primary key!"))},read:function(e,n,i,o){t(!1,"SELECT data FROM "+r(e)+" WHERE id = ?",[n],function(t){t.rows.length?i(JSON.parse(t.rows.item(0).data)):i(void 0)},o)},remove:function(e,n,i,o){t(!0,"DELETE FROM "+r(e)+" WHERE id = ?",[n],function(){i()},o)},getIndex:function(e,n,i){t(!1,"SELECT id FROM "+r(e)+" ORDER BY id",[],function(t){for(var e=[],r=0;r<t.rows.length;r++)e.push(t.rows.item(r).id);n(e)},i)},getNumberOfRecords:function(e,n,i){t(!1,"SELECT COUNT(*) FROM "+r(e),[],function(t){n(t.rows.item(0)["COUNT(*)"])},i)},readMulti:function(n,i,o,s,a,u,c,l){var f="SELECT data FROM "+r(n);"range"===i&&(f+=" WHERE id >= ? AND id < ?"),f+=a?" ORDER BY id DESC":" ORDER BY id";var h=0,p=function(){var n=f;if("offset"===i)if(s<=e)n+=" LIMIT "+s+" OFFSET "+o;else{var r=Math.min(e,s-h*e),a=o+h*e;if(r<=0)return void c();n+=" LIMIT "+r+" OFFSET "+a}else n+=" LIMIT "+e+" OFFSET "+h*e;t(!1,n,"range"===i?[o,s]:[],function(t){if(t.rows.length){for(var n=0;n<t.rows.length;n++)u(JSON.parse(t.rows.item(n).data),h*e+n);t.rows.length===e?(h++,p()):c()}else c()},l)};p()}}};var o=function(){function t(t,n){this.plugin={name:"WebSQL Adapter",version:r.VERSION},this.Ht=1e3*(t||0)*1e3,this.Ut={},this.F=this.F.bind(this),this.Kt=e.SQLiteAbstract(this.F,n||500)}return t.prototype.connect=function(t,e,n){var r=this;this.Vt=t,this.Xt=window.openDatabase(this.Vt,String(this.nSQL.config.version)||"1.0",this.Vt,i.isAndroid?5e6:this.Ht),i.setFast(function(){r.Kt.createAI(e,n)})},t.prototype.createAndInitTable=function(t,e,n,r){this.Kt.createTable(t,e.ai,this.Ut,n,r)},t.prototype.F=function(t,e,n,r,i){var o=function(t){t.executeSql(e,n,function(t,e){r(e)},function(t,e){return i(e),!1})};t?this.Xt.transaction(o):this.Xt.readTransaction(o)},t.prototype.disconnectTable=function(t,e,n){e()},t.prototype.dropTable=function(t,e,n){this.Kt.dropTable(t,e,n)},t.prototype.disconnect=function(t,e){t()},t.prototype.write=function(t,e,n,r,i){this.Kt.write(this.nSQL.tables[t].pkType,this.nSQL.tables[t].pkCol,t,e,n,this.nSQL.tables[t].ai,this.Ut,r,i)},t.prototype.read=function(t,e,n,r){this.Kt.read(t,e,n,r)},t.prototype.delete=function(t,e,n,r){this.Kt.remove(t,e,n,r)},t.prototype.readMulti=function(t,e,n,r,i,o,s,a){this.Kt.readMulti(t,e,n,r,i,o,s,a)},t.prototype.getIndex=function(t,e,n){this.Kt.getIndex(t,e,n)},t.prototype.getNumberOfRecords=function(t,e,n){this.Kt.getNumberOfRecords(t,e,n)},t}();e.WebSQL=o},function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0});var r=n(1),i=n(0),o=function(){function t(t){this.version=t,this.plugin={name:"IndexedDB Adapter",version:r.VERSION},this.Xt={},this.Ut={}}return t.prototype.connect=function(t,e,n){this.Vt=t,e()},t.prototype.createAndInitTable=function(t,e,n,r){var o=this,s=1,a=i.hash(JSON.stringify(e.columns));this.version?s=this.version:(s=parseInt(localStorage.getItem(this.Vt+"_"+t+"_idb_version")||"")||1,(localStorage.getItem(this.Vt+"_"+t+"_idb_hash")||a)!==a&&s++,localStorage.setItem(this.Vt+"_"+t+"_idb_version",String(s)),localStorage.setItem(this.Vt+"_"+t+"_idb_hash",a));var u=indexedDB.open(this.Vt+"_"+t,s);this.Ut[t]=parseInt(localStorage.getItem(this.Vt+"_"+t+"_idb_ai")||"0"),u.onerror=r,u.onupgradeneeded=function(n){o.Xt[t]=n.target.result,o.Xt[t].objectStoreNames.contains(t)||o.Xt[t].createObjectStore(t,{keyPath:e.pkCol})},u.onsuccess=function(e){o.Xt[t]=e.target.result,n()}},t.prototype.disconnectTable=function(t,e,n){this.Xt[t].onerror=n,this.Xt[t].close(),delete this.Xt[t],e()},t.prototype.dropTable=function(t,e,n){var r=this,i=this.Xt[t].transaction(t,"readwrite");i.onerror=n,i.objectStore(t).clear().onsuccess=function(){r.disconnectTable(t,e,n)}},t.prototype.disconnect=function(t,e){t()},t.prototype.store=function(t,e,n,r){var i=this.Xt[t].transaction(t,e);i.onabort=r,i.onerror=r,n(i,i.objectStore(t))},t.prototype.write=function(t,e,n,r,o){void 0!==(e=e||i.generateID(this.nSQL.tables[t].pkType,this.Ut[t]+1))?(this.Ut[t]=Math.max(e,this.Ut[t]),this.nSQL.tables[t].ai&&(this.Ut[t]=i.cast("int",Math.max(this.Ut[t]||0,e)),localStorage.setItem(this.Vt+"_"+t+"_idb_ai",String(this.Ut[t]))),n[this.nSQL.tables[t].pkCol]=e,this.store(t,"readwrite",function(t,i){try{i.put(n).onsuccess=function(){r(e)}}catch(t){o(t)}},o)):o(new Error("Can't add a row without a primary key!"))},t.prototype.read=function(t,e,n,r){this.store(t,"readonly",function(t,r){var i=r.get(e);i.onerror=function(){n(void 0)},i.onsuccess=function(){n(i.result)}},r)},t.prototype.delete=function(t,e,n,r){this.store(t,"readwrite",function(t,i){var o=i.delete(e);o.onerror=r,o.onsuccess=function(t){n()}},r)},t.prototype.readMulti=function(t,e,n,r,i,o,s,a){var u="offset"===e,c=0,l=u?n:0,f=l+r;this.store(t,"readonly",function(t,a){a.openCursor("all"===e||u?void 0:IDBKeyRange.bound(n,r,!0,!1),i?"prev":"next").onsuccess=function(t){var e=t.target.result;e?(u?l<=c&&f>c&&o(e.value,c-n):o(e.value,c),c++,e.continue()):s()}},a)},t.prototype.getIndex=function(t,e,n){var r=this,i=[];this.store(t,"readonly",function(n,o){o.openCursor().onsuccess=function(n){var o=n.target.result;o?(i.push(o.value[r.nSQL.tables[t].pkCol]),o.continue()):e(i)}},n)},t.prototype.getNumberOfRecords=function(t,e,n){var r=0;this.store(t,"readonly",function(t,n){n.openCursor().onsuccess=function(t){var n=t.target.result;n?(r++,n.continue()):e(r)}},n)},t}();e.IndexedDB=o},function(t,e,n){var r=this&&this.O||Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t};Object.defineProperty(e,"__esModule",{value:!0});var i=n(0),o=function(){function t(t,e,n,o,s){this.Xt=t,this.Yt=s||"",this.F="string"==typeof n?r({},i.buildQuery(e,n),{comments:[],state:"pending",action:n,actionArgs:o,result:[]}):r({},i.buildQuery(e,""),n(t),{state:"pending"})}return t.prototype.where=function(t){return this.F.where=t,this},t.prototype.orderBy=function(t){return this.F.orderBy=t,this},t.prototype.groupBy=function(t){return this.F.groupBy=t,this},t.prototype.having=function(t){return this.F.having=t,this},t.prototype.join=function(t){var e=this,n="Join commands requires table and type arguments!";return Array.isArray(t)?t.forEach(function(t){t.with.table&&t.type||(e.Gt=n)}):t.with.table&&t.type||(this.Gt=n),this.F.join=t,this},t.prototype.limit=function(t){return this.F.limit=t,this},t.prototype.comment=function(t){return this.F.comments.push(t),this},t.prototype.tag=function(t){return this.F.tags.push(t),this},t.prototype.extend=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return this.F.extend.push({scope:t,args:e}),this},t.prototype.union=function(t,e){return this.F.union={queries:t,type:e?"all":"distinct"},this},t.prototype.offset=function(t){return this.F.offset=t,this},t.prototype.emit=function(){return this.F},t.prototype.ttl=function(t,e){if(void 0===t&&(t=60),"upsert"!==this.F.action)throw new Error("nSQL: Can only do ttl on upsert queries!");return this.F.ttl=t,this.F.ttlCols=e||[],this},t.prototype.graph=function(t){return this.F.graph=t,this},t.prototype.from=function(t){return this.F.table=t.table,this.F.tableAS=t.as,this},t.prototype.into=function(t){return this.F.table=t,this},t.prototype.on=function(t){return this.F.table=t,this},t.prototype.toCSV=function(t){var e=this;return e.exec().then(function(n){return Promise.resolve(e.Xt.JSONtoCSV(n,t))})},t.prototype.exec=function(){var t=this;return new Promise(function(e,n){var r=[];t.stream(function(t){t&&r.push(t)},function(){e(r)},n)})},t.prototype.stream=function(t,e,n){this.Xt.triggerQuery(this.F,t,e,n)},t.prototype.cache=function(){var t=this;return new Promise(function(e,n){var r=i.uuid();t.exec().then(function(n){t.Xt.k[r]=n,e({id:r,total:n.length})}).catch(n)})},t}();e.q=o}])});