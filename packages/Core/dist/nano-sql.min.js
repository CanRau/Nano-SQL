!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var n in r)("object"==typeof exports?exports:e)[n]=r[n]}}(window,function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=2)}([function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.binarySearch=function(e,r,n,i){var o=n||0,s=i||e.length;if(e[o]>r)return o;if(e[s]<r)return s+1;var a=Math.floor((o+s)/2);return r===e[a]?a:s-1===o?s:r>e[a]?t.binarySearch(e,r,a,s):r<e[a]?t.binarySearch(e,r,o,a):s},t.buildQuery=function(e,r){return{table:e,action:r,state:"pending",result:[],time:Date.now(),queryID:t.uuid(),extend:[],comments:[]}},t.noop=function(){},t.throwErr=function(e){throw new Error(e)},t._assign=function(e){return e?JSON.parse(JSON.stringify(e)):null},t.compareObjects=function(e,r){if(e===r)return!0;if("object"!=typeof e)return!1;if(!e||!r)return!1;var n=Array.isArray(e),i=Object.keys(e),o=n?e.length===r.length:i.length===Object.keys(r).length;if(!o)return!1;for(var s=i.length;s--&&o;){var a=i[s];o="object"==typeof e[a]?t.compareObjects(e[a],r[a]):e[a]===r[a]}return o};var r=function(){function e(e,t,r){this.processItem=e,this.onError=t,this.onComplete=r,this._items=[],this._going=!1,this._done=!1,this._count=0,this._progressBuffer=this._progressBuffer.bind(this)}return e.prototype._progressBuffer=function(){var e=this;if(!this._done||this._items.length)if(this._items.length){var r=this._items.shift();this.processItem&&this.processItem(r,this._count,function(){e._count++,e._count%500==0?t.setFast(e._progressBuffer):e._progressBuffer()},this.onError?this.onError:t.noop)}else this._going=!1;else this.onComplete&&this.onComplete()},e.prototype.finished=function(){this._done=!0,this._going||this.onComplete&&this.onComplete()},e.prototype.newItem=function(e){this._items.push(e),this._going||(this._going=!0,this._progressBuffer())},e}();t.NanoSQLBuffer=r,t.chainAsync=function(e,r){return new Promise(function(n,i){if(e&&e.length){var o=[],s=0,a=function(){s<e.length?r(e[s],s,function(e){e&&o.push(e||0),++s%500==0?t.setFast(a):a()},function(e){i(e)}):n(o.length?o:void 0)};a()}else n([])})},t.allAsync=function(e,t){return Promise.all((e||[]).map(function(e,r){return new Promise(function(n,i){t(e,r,n,i)})}))};var n="undefined"==typeof window?"":navigator.userAgent||"";t.isSafari=0!==n.length&&(/^((?!chrome|android).)*safari/i.test(n)||/iPad|iPhone|iPod/.test(n)&&!window.MSStream),t.isMSBrowser=0!==n.length&&(n.indexOf("MSIE ")>0||n.indexOf("Trident/")>0||n.indexOf("Edge/")>0),t.isAndroid=/Android/.test(n),t.random16Bits=function(){if("undefined"==typeof crypto)return Math.round(Math.random()*Math.pow(2,16));if(crypto.getRandomValues){var e=new Uint16Array(1);return crypto.getRandomValues(e),e[0]}return"undefined"!=typeof global&&global._crypto.randomBytes?global._crypto.randomBytes(2).reduce(function(e,t){return t*e}):Math.round(Math.random()*Math.pow(2,16))},t.throttle=function(e,t){var r=!1;return function(){for(var n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];r||(r=!0,setTimeout(function(){e.apply(null,n),r=!1},t))}},t.timeid=function(e){for(var r=Math.round((new Date).getTime()/(e?1:1e3)).toString();r.length<(e?13:10);)r="0"+r;return r+"-"+(t.random16Bits()+t.random16Bits()).toString(16)},t.intersect=function(e,t){return!(!e||!t)&&(!(!e.length||!t.length)&&(e||[]).filter(function(e){return-1!==(t||[]).indexOf(e)}).length>0)},t.uuid=function(){var e,r,n="";return[n,n,n,n,n,n,n,n].reduce(function(i,o,s){for(e=t.random16Bits(),r=3===s?4:4===s?(e%16&3|8).toString(16):n,e=e.toString(16);e.length<4;)e="0"+e;return i+([2,3,4,5].indexOf(s)>-1?"-":n)+(r+e).slice(0,4)},n)},t.hash=function(e){for(var t=5381,r=e.length;r;)t=33*t^e.charCodeAt(--r);return(t>>>0).toString(16)};var i={int:function(e){return e},uuid:t.uuid,timeId:function(){return t.timeid()},timeIdms:function(){return t.timeid(!0)}};t.generateID=function(e,t){return i[e]?i[e](t||1):""},t.cleanArgs=function(e,r){for(var n={},i=e.length;i--;){var o=e[i].split(":");o.length>1?n[o[0]]=t.cast(o[1],r[o[0]]||void 0,!0):n[o[0]]=r[o[0]]||void 0}return n},t.isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},t.objSort=function(e,r){return function(n,i){var o=e?t.deepGet(e,n)>t.deepGet(e,i)?-1:1:n>i?-1:1;return r?-1*o:o}},t.cast=function(e,r,n){if("any"===e||"blob"===e)return r;if(-1!==e.indexOf("[]")){var i=e.slice(0,e.lastIndexOf("[]"));return Array.isArray(r)?r.map(function(e){return t.cast(i,e,n)}):[]}var o=typeof r,s={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},a=function(e,i){switch(e){case"safestr":return a("string",i).replace(/[&<>"'`=\/]/gim,function(e){return s[e]});case"int":return"number"!==o||i%1!=0?parseInt(i||0):i;case"number":case"float":return"number"!==o?parseFloat(i||0):i;case"array":return Array.isArray(i)?i:[];case"uuid":case"timeId":case"timeIdms":case"string":return"string"!==o?String(i):i;case"object":case"obj":case"map":return t.isObject(i)?i:{};case"boolean":case"bool":return!0===i||1===i}return n?r:null};if(void 0===r||null===r)return null;var u=a(String(e||"").toLowerCase(),r);return void 0!==u&&["int","float","number"].indexOf(e)>-1&&isNaN(u)?0:u},t.crowDistance=function(e,t,r,n,i){void 0===i&&(i=6371);var o=function(e){return e*(Math.PI/180)},s=o(r-e),a=o(n-t),u=Math.sin(s/2)*Math.sin(s/2)+Math.cos(o(e))*Math.cos(o(r))*Math.sin(a/2)*Math.sin(a/2);return i*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))};var o={};t.resolveObjPath=function(e){var t=e;if(o[t])return o[t];var r=e.indexOf("[")>-1?e.split(/\.|\[/gim).map(function(e){return e.replace(/\]/gim,"")}):e.split(".");return o[t]=r,o[t]},t.getFnValue=function(e,r){return r.match(/\".*\"|\'.*\'/gim)?r.replace(/\"|\'/gim,""):t.deepGet(r,e)},t.deepFreeze=function(e){return Object.getOwnPropertyNames(e||{}).forEach(function(r){var n=e[r];"object"==typeof n&&null!==n&&(e[r]=t.deepFreeze(n))}),Object.freeze(e)},t.deepSet=function(e,r,n){var i=function(e,t,r){e[t+1]?(r[e[t]]||(isNaN(e[t+1])?r[e[t]]={}:r[e[t]]=[]),i(e,t+1,r[e[t]])):r[e[t]]=n};return i(Array.isArray(e)?e:t.resolveObjPath(e),0,r),r},t.deepGet=function(e,r){var n=function(e,t,r){return e[t]&&r?n(e,t+1,r[e[t]]):r};return n(Array.isArray(e)?e:t.resolveObjPath(e),0,r)},t._maybeAssign=function(e){return Object.isFrozen(e)?t._assign(e):e};var s=0,a={},u=Array.prototype.slice,c="undefined"!=typeof window&&window.postMessage&&window.addEventListener,l=function(e){return e[0].apply(null,u.call(e,1))};c&&window.addEventListener("message",function(e){var t,r=e.data;"string"==typeof r&&0===r.indexOf("setMsg")&&(t=a[r])&&(delete a[r],l(t))});var f=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=s++,n="setMsg"+r;return a[n]=e,window.postMessage(n,"*"),r};t.setFast=c?f:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];"undefined"!=typeof global?global.setImmediate(function(){l(e)}):setTimeout(function(){l(e)},0)}},function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.fast=0]="fast",e[e.medium=1]="medium",e[e.slow=2]="slow",e[e.fn=3]="fn",e[e.none=4]="none"}(t.IWhereType||(t.IWhereType={}))},function(e,t,r){e.exports=r(3)},function(e,t,r){var n=this&&this.__assign||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i,o=r(4),s=r(0),a=r(5),u=r(6),c=r(8),l=r(9),f=r(10),h=r(11),p=r(12);"undefined"!=typeof global&&(i=global._rocksDB);var d=2,y=function(){function e(){this.version=d,this.earthRadius=6371,this._Q=new s.NanoSQLBuffer,this.state={activeAV:"",hasAnyEvents:!1,peers:[],pid:s.uuid(),id:s.uuid(),peerEvents:[],focused:!0,peerMode:!1,connected:!1,ready:!1,selectedTable:""},this.config={id:"temp",queue:!1},this.tables={},this._queryCache={},this.filters={},this.indexTypes={string:function(e){return"object"==typeof e?JSON.stringify(e):String(e)},geo:function(e){},float:function(e){var t=parseFloat(e);return isNaN(t)?0:t},int:function(e){var t=parseInt(e);return isNaN(t)?0:t},number:function(e){var t=parseFloat(e);return isNaN(t)?0:t}},this._eventCBs={Core:new o.ReallySmallEvents},this._checkTTL=this._checkTTL.bind(this),u.attachDefaultFns(this)}return e.prototype.doFilter=function(e,t){var r=this;return this.filters[e]?new Promise(function(n,i){s.chainAsync(r.filters[e],function(n,o,s){r.filters[e][o](t).then(function(e){t=e,e.abort?i(e.abort):s()})}).then(function(){n(t.result)})}):Promise.resolve(t.result)},e.prototype.getCache=function(e,t){if(!this._queryCache[e])throw new Error('Cache "'+e+'" not found!');return t?this._queryCache[e].slice(t.offset,t.offset+t.limit):this._queryCache[e].slice()},e.prototype.clearCache=function(e){var t=void 0!==this._queryCache[e];return delete this._queryCache[e],t},e.prototype.clearTTL=function(e){var t=this,r=this.state.selectedTable+"."+e;return new Promise(function(e,i){t.triggerQuery(n({},s.buildQuery("_ttl","delete"),{where:["key","=",r]}),s.noop,e,i)})},e.prototype.expires=function(e){var t=this;return new Promise(function(r,i){var o=t.state.selectedTable+"."+e,a=[];t.triggerQuery(n({},s.buildQuery("_ttl","select"),{where:["key","=",o]}),function(e){a.push(e)},function(){a.length?r({time:(a[0].date-Date.now())/1e3,cols:a[0].cols}):r({time:-1,cols:[]})},i)})},e.prototype._checkTTL=function(){var e=this;if(!this.config.disableTTL){this._ttlTimer&&clearTimeout(this._ttlTimer);var t=0,r=0,i=function(){var o=[];e.triggerQuery(n({},s.buildQuery("_ttl","select"),{limit:20,offset:20*t}),function(e){o.push(e)},function(){o.length?s.chainAsync(o,function(t,i,o){if(t.date<Date.now()){var a=function(){e.triggerQuery(n({},s.buildQuery("_ttl","delete"),{where:["key","=",t.key]}),s.noop,o,s.throwErr)},u=t.key.split("."),c=u[0],l=-1===["float","int","number"].indexOf(e.tables[c].pkType)?u[1]:parseFloat(u[1]);if(t.cols.length){var f={};t.cols.forEach(function(e){f[e]=null}),e.triggerQuery(n({},s.buildQuery(c,"upsert"),{actionArgs:f,where:[e.tables[c].pkCol,"=",l]}),s.noop,a,s.throwErr)}else e.triggerQuery(n({},s.buildQuery(c,"delete"),{where:[e.tables[c].pkCol,"=",l]}),s.noop,a,s.throwErr)}else r=Math.max(r,t.date),o()}).then(function(){t++,i()}):r&&(e._ttlTimer=setTimeout(e._checkTTL,r-Date.now()))},s.throwErr)};i()}},e.prototype.selectTable=function(e){return e&&(this.state.selectedTable=e),this},e.prototype.getPeers=function(){return JSON.parse(localStorage.getItem("nsql-peers-"+this.state.id)||"[]")},e.prototype._detectStorageMethod=function(){return"undefined"==typeof window?"ROCKS":s.isSafari?"WSQL":"undefined"!=typeof indexedDB?"IDB":"undefined"!=typeof window&&void 0!==window.openDatabase?"WSQL":"LS"},e.prototype._initPlugins=function(e){var t=this;return new Promise(function(r,n){var i={};(e.plugins||[]).forEach(function(e){(e.filters||[]).forEach(function(e){i[e.name]||(i[e.name]=[]);for(var t=e.priority;i[e.name][t];)t++;i[e.name][t]=e.callback})}),Object.keys(i).forEach(function(e){t.filters[e]=[],i[e].forEach(function(r){r&&t.filters[e].unshift(r)})});var o=function(e,t){return!t||!t.length||(1===t.length?e>=t[0]:e>=t[0]&&e<t[1])},s=!1;(e.plugins||[]).forEach(function(t){if(t.dependencies){var r=t.dependencies||{};Object.keys(t.dependencies).forEach(function(i,a,u){if("core"===i)o(d,r[i])||(s=!0,n('Plugin "'+t.name+'" requires a different core version of nano-sql!'));else{var c=(e.plugins||[]).reduce(function(e,t){return t.name===i?t:e});c||(s=!0,n('Plugin "'+t.name+'" requires plugin "'+i+"\" but it isn't installed!")),o(c.version,r[i])||(s=!0,n('Plugin "'+t.name+'" requires a different version of "'+i+'"!'))}})}}),s||r()})},e.prototype.connect=function(e){var t=this;return this._initPlugins(e).then(function(){return t.doFilter("config",{result:e})}).then(function(e){return t.state.id=e.id||"nSQL_DB",t.config=n({plugins:[]},e),"undefined"!=typeof window&&e&&e.peer&&(t.state.peerMode=!0),t.doFilter("willConnect",{result:{}})}).then(function(){return new Promise(function(e,r){var n=void 0!==t.config.mode?t.config.mode:"TEMP";if("string"==typeof n)switch("PERM"===n&&(n=t._detectStorageMethod()),n){case"TEMP":t.adapter=new l.SyncStorage(!1);break;case"LS":t.adapter=new l.SyncStorage(!0);break;case"WSQL":t.adapter=new f.WebSQL;break;case"IDB":t.adapter=new h.IndexedDB;break;case"ROCKS":case"LVL":t.adapter=new i;break;default:r("Cannot find mode "+n+"!")}else t.adapter=n;t.adapter.plugin&&(t.config.plugins||[]).push(t.adapter.plugin),t._initPlugins(t.config).then(function(){t.adapter.nSQL=t,t.adapter.connect(t.state.id,e,r)}).catch(r)})}).then(function(){t.triggerEvent({target:"Core",targetId:t.state.id,events:["connect"],time:Date.now()}),t.state.connected=!0;var e=["_util","_ttl"].concat((t.config.tables||[]).map(function(e){return e.name}));return s.allAsync(e,function(e,r,i,o){switch(e){case"_util":t.triggerQuery(n({},s.buildQuery("","create table"),{actionArgs:{name:"_util",model:[{key:"key:string",props:["pk()"]},{key:"value:any"}],_internal:!0}}),s.noop,i,o);break;case"_ttl":t.triggerQuery(n({},s.buildQuery("","create table"),{actionArgs:{name:"_ttl",model:[{key:"key:string",props:["pk()"]},{key:"table:string"},{key:"cols:string[]"},{key:"date:number"}],_internal:!0}}),s.noop,i,o);break;default:var a=(t.config.tables||[]).filter(function(t){return t.name===e})[0];if(!a)return void o("Table not found!");t.triggerQuery(n({},s.buildQuery("","create table"),{actionArgs:a}),s.noop,i,o)}})}).then(function(){return new Promise(function(e,r){var i;t.triggerQuery(n({},s.buildQuery("_util","select"),{where:["key","=","version"]}),function(e){e&&(i=e.value)},function(){!i||i<2?t.triggerQuery(n({},s.buildQuery("_util","upsert"),{actionArgs:{key:"version",value:d}}),s.noop,e,r):e()},r)})}).then(function(){return new Promise(function(e,r){var i;t.config.version?t.triggerQuery(n({},s.buildQuery("_util","select"),{where:["key","=","db-version"]}),function(e){e&&(i=e.value)},function(){var o=function(e,r,i){t.triggerQuery(n({},s.buildQuery("_util","upsert"),{actionArgs:{key:"db-version",value:e}}),s.noop,r,i)};if(i){var a=function(){if(i===t.config.version)o(t.config.version||0,e,r);else{if(!t.config.onVersionUpdate)return void o(t.config.version||0,e,r);t.config.onVersionUpdate(i).then(function(e){o(i=e,function(){s.setFast(a)},r)}).catch(r)}};a()}else o(t.config.version||0,e,r)},r):e()})}).then(function(){return new Promise(function(e,r){t.triggerEvent({target:"Core",targetId:t.state.id,events:["ready"],time:Date.now()}),t.state.ready=!0,t.config.disableTTL||t._checkTTL(),t.config.peer&&t._initPeers(),e()})})},e.prototype._initPeers=function(){var e=this,r=0;this.state.pid=s.uuid(),this.state.peers=this.getPeers(),this.state.peers.unshift(this.state.pid),localStorage.setItem("nsql-peers-"+this.state.id,JSON.stringify(this.state.peers)),window.addEventListener("storage",function(t){if(t.key==="nsql-peers-"+e.state.id&&(e.state.peers=e.getPeers()),t.key&&0===t.key.indexOf(e.state.pid+".")){localStorage.removeItem(t.key);var i=JSON.parse(t.newValue||"{}");e.state.peerEvents.push(i.query.queryID||""),e.triggerEvent(n({},i,{types:["peer-change"]})),s.setFast(function(){e.triggerEvent(i)})}if(++r>50&&e.state.peers[0]===e.state.pid){r=0;for(var o=localStorage.length,a={};o--;){var u=localStorage.key(o),c=u?u.match(/\w{8}-\w{4}-\w{4}-\w{4}-\w{8}/gim):null;if(u&&c){var l=(c||[""])[0];a[l]||(a[l]=[]),a[l].push(u)}}Object.keys(a).forEach(function(t){a[t].length>10&&(e.state.peers=e.state.peers.filter(function(e){return e!==t}),a[t].forEach(function(e){localStorage.removeItem(e)}),localStorage.setItem("nsql-peers-"+e.state.id,JSON.stringify(e.state.peers)))})}}),window.onblur=function(){e.state.focused=!1},window.onfocus=function(){e.state.peers=e.state.peers.filter(function(t){return t!==e.state.pid}),e.state.peers.unshift(e.state.pid),localStorage.setItem("nsql-peers-"+e.state.id,JSON.stringify(e.state.peers)),e.state.focused=!0},t.nSQL("*").on("change",function(t){var r=e.state.peerEvents.indexOf(t.query.queryID||"");-1===r?e.state.peers.filter(function(t){return t!==e.state.pid}).forEach(function(e){localStorage.setItem(e+"."+t.query.queryID,JSON.stringify(t))}):e.state.peerEvents.splice(r,1)}),window.addEventListener("beforeunload",function(){return e.state.peers=e.state.peers.filter(function(t){return t!==e.state.pid}),localStorage.setItem("nsql-peers-"+e.state.id,JSON.stringify(e.state.peers)),!1})},e.prototype.on=function(e,t){var r=this,n="string"!=typeof r.state.selectedTable?"":r.state.selectedTable;if(-1!==n.indexOf("Plugin:"))return this._eventCBs[n]||(this._eventCBs[n]=new o.ReallySmallEvents),this._eventCBs[n].on(e,t),r._refreshEventChecker();switch(e){case"connect":case"ready":case"disconnect":case"peer-change":case"slow-query":this._eventCBs.Core.on(e,t);break;default:var i="Table:"+s.resolveObjPath(n).join(".");this._eventCBs[i]||(this._eventCBs[i]=new o.ReallySmallEvents),this._eventCBs[i].on(e,t)}return r._refreshEventChecker()},e.prototype.off=function(e,t){var r=this,n="string"!=typeof r.state.selectedTable?"":r.state.selectedTable;if(-1!==n.indexOf("Plugin:"))return this._eventCBs[n].off(e,t),r._refreshEventChecker();switch(e){case"connect":case"ready":case"disconnect":case"peer-change":case"slow-query":this._eventCBs.Core.off(e,t);break;default:var i="Table:"+s.resolveObjPath(n).join(".");this._eventCBs[i].off(e,t)}return r._refreshEventChecker()},e.prototype._refreshEventChecker=function(){var e=this;return this.state.hasAnyEvents=Object.keys(this._eventCBs).reduce(function(t,r){return!0===t||(Object.keys(e._eventCBs[r].eventListeners).reduce(function(t,n){return e._eventCBs[r].eventListeners[n].length+t},0)>0||t)},!1),this},e.prototype.getView=function(e,t){return this._doAV("View",this.state.selectedTable,e,t)},e.prototype.doAction=function(e,t){return this._doAV("Action",this.state.selectedTable,e,t)},e.prototype._doAV=function(e,t,r,n){var i=this;return"string"!=typeof this.state.selectedTable?Promise.reject():this.doFilter(e,{result:{AVType:e,table:t,AVName:r,AVargs:n}}).then(function(e){var t="Action"===e.AVType?"actions":"views",r=i.tables[e.table][t].reduce(function(t,r){return r.name===e.AVName?r:t},null);return r?r.call(r.args?s.cleanArgs(r.args,e.AVargs):{},i):new Promise(function(t,r){return r(e.AVType+' "'+e.AVName+'" Not Found!')})})},e.prototype.query=function(e,t){var r=this.state.activeAV;return this.state.activeAV="",new p._NanoSQLQueryBuilder(this,this.state.selectedTable,e,t,r)},e.prototype.triggerQuery=function(e,t,r,n){var i=this;this.state.connected||"string"!=typeof e.table?(this._Q.processItem||(this._Q.processItem=function(e,t,r,n){new c._NanoSQLQuery(i,e.query,e.onRow,function(){r(),e.complete()},function(t){r(),e.error(t)})}),this.doFilter("query",{result:e}).then(function(e){i.config.queue&&!e.skipQueue?i._Q.newItem({query:e,onRow:t,complete:r,error:n}):new c._NanoSQLQuery(i,e,t,r,n)}).catch(n)):n("nSQL: Can't do a query before the database is connected!")},e.prototype.triggerEvent=function(e){var t=this;return this.doFilter("event",{result:e}).then(function(r){t.state.hasAnyEvents&&t._eventCBs[e.target]&&s.setFast(function(){e.events.forEach(function(r){t._eventCBs[e.target].trigger(r,e)})})}).catch(function(e){console.error("Event suppressed",e)}),this},e.prototype.default=function(e,t){if(e=e||{},!t&&"string"!=typeof this.state.selectedTable)throw new Error("Must select table to generate defualts!");if(t=t||this.state.selectedTable,!this.tables[t])throw new Error('nSQL: Table "'+t+'" not found for generating default object!');var r="",n=function(e,t,i){var o={};if(i&&i.length&&-1!==i.indexOf("[]"))return Array.isArray(t)?t.map(function(t){return n(e,t,i.slice(0,i.lastIndexOf("[]")))}):[];var a=!1;if(e.forEach(function(e){if("*"!==e.key){if(e.model)if(-1!==e.type.indexOf("[]")){var i=void 0!==t?t[e.key]:[];Array.isArray(i)?o[e.key]=i.map(function(t){return n(e.model,t,e.type.slice(0,e.type.lastIndexOf("[]")))}):o[e.key]=[]}else o[e.key]=n(e.model,void 0!==t?t[e.key]:void 0);else o[e.key]=void 0!==t[e.key]?s.cast(e.type,t[e.key]):e.default;e.notNull&&null===o[e.key]&&(r="Data error, "+e.key+" cannot be null!")}else a=!0}),r.length)return new Error(r);if(a&&t){var u=e.map(function(e){return e.key});Object.keys(t).filter(function(e){return-1===u.indexOf(e)}).forEach(function(e){o[e]=t[e]})}return o};return n(this.tables[t].columns,e)},e.prototype.rawDump=function(e,t){var r=this,n=Object.keys(this.tables).filter(function(t){return!e.length||-1!==e.indexOf(t)});return s.chainAsync(n,function(e,n,i,o){r.adapter.readMulti(e,"all",void 0,void 0,!1,function(r){t(e,r)},i,o||s.noop)})},e.prototype.rawImport=function(e,t){var r=this,n=0,i=Object.keys(e).reduce(function(t,r){return t+=e[r].length},0),o=Object.keys(this.tables),a=Object.keys(e).filter(function(e){return-1!==o.indexOf(e)});return s.chainAsync(a,function(o,a,u,c){var l=r.tables[o].pkCol;s.chainAsync(e[o],function(e,a,u,c){e[l]||!c?r.adapter.write(o,e[l],e,function(e){u(),n++,t&&t(Math.round(n/i*1e4)/100)},c||s.noop):c("No primary key found, can't import: "+JSON.stringify(e))}).then(u).catch(c)})},e.prototype.disconnect=function(){var e=this;return this.doFilter("disconnect",{}).then(function(){return new Promise(function(t,r){return e.adapter.disconnect(t,r)})})},e.prototype.observable=function(e,t){return new a.Observer(this,e,t||[])},e.prototype.extend=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];return this.doFilter("extend",{scope:e,args:t,result:null})},e.prototype.loadJS=function(e,t){return"string"!=typeof this.state.selectedTable?Promise.reject("nSQL: Can't load JS into temporary table!"):Promise.resolve([])},e.prototype.JSONtoCSV=function(e,t,r){var n=[];if(!e.length)return"";var i=[];return r?i=r:(e.forEach(function(e){i=Object.keys(e).concat(i)}),i=i.filter(function(e,t,r){return r.indexOf(e)===t})),t&&n.push(i.join(",")),e.forEach(function(e){n.push(i.map(function(t){return null===e[t]||void 0===e[t]?"":"string"==typeof e[t]?'"'+e[t].replace(/\"/g,'""')+'"':"boolean"==typeof e[t]?!0===e[t]?"true":"false":"object"==typeof e[t]?'"'+JSON.stringify(e[t]).replace(/\"/g,'""')+'"':e[t]}).join(","))}),n.join("\r\n")},e.prototype.csvToArray=function(e){for(var t,r="",n=[""],i=[n],o=0,s=0,a=!0,u=0,c=e;u<c.length;u++)'"'===(t=c[u])?(a&&t===r&&(n[o]+=t),a=!a):","===t&&a?t=n[++o]="":"\n"===t&&a?("\r"===r&&(n[o]=n[o].slice(0,-1)),n=i[++s]=[t=""],o=0):n[o]+=t,r=t;return i[0]},e.prototype.CSVtoJSON=function(e,t){var r=this,n=[];return e.split(/\r?\n|\r|\t/gm).map(function(e,i){if(0!==i){var o=r.csvToArray(e);if(o){o=o.map(function(e){return e.trim()});for(var s=n.length,a={};s--;)if(o[s])if("true"===o[s]||"false"===o[s])a[n[s]]="true"===o[s];else if(0===o[s].indexOf("{")||0===o[s].indexOf("["))try{a[n[s]]=JSON.parse(o[s])}catch(e){a[n[s]]=o[s]}else 0===o[s].indexOf('"')?a[n[s]]=o[s].slice(1,o[s].length-1).replace(/\"\"/gim,'"'):a[n[s]]=o[s];return t?t(a):a}}else n=e.split(",")}).filter(function(e){return e})},e.prototype.loadCSV=function(e,t,r){var i=this,o=this.state.selectedTable;if("string"!=typeof o)return Promise.reject("nSQL: Can't load CSV into temporary table!");var a=this.CSVtoJSON(e,t);return s.chainAsync(a,function(e,t,u,c){r&&r(Math.round((t+1)/a.length*1e4)/100),i.triggerQuery(n({},s.buildQuery(o,"upsert"),{actionArgs:e}),s.noop,u,c||s.noop)})},e}();t.NanoSQL=y;var g=new y;t.nSQL=function(e){return g.selectTable(e)},"undefined"!=typeof window&&(window["nano-sql"]={nSQL:t.nSQL,NanoSQLInstance:y})},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){this.eventListeners={}}return e.prototype.on=function(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)},e.prototype.off=function(e,t){var r=this;this.eventListeners[e]&&this.eventListeners[e].length&&this.eventListeners[e].forEach(function(n,i){n===t&&r.eventListeners[e].splice(i,1)})},e.prototype.trigger=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this.eventListeners[e]&&this.eventListeners[e].forEach(function(e){return e.apply(void 0,t)})},e}();t.ReallySmallEvents=r,t.RSE=new r},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=r(1),i=r(0),o=function(){function e(e,t,r){this._nSQL=e,this._query=t,this._tables=r,this._order=[],this._count=0,this._config=[]}return e.prototype.debounce=function(e){return this._config[this._order.length]=e,this._order.push("dbnc"),this},e.prototype.distinct=function(e,t){return this._config[this._order.length]=[e||function(e){return e},t||function(e,t){return e===t}],this._order.push("dsct"),this},e.prototype.filter=function(e){return this._config[this._order.length]=e,this._order.push("fltr"),this},e.prototype.map=function(e){return this._config[this._order.length]=e,this._order.push("mp"),this},e.prototype.first=function(e){return this._config[this._order.length]=e||function(e,t){return!0},this._order.push("fst"),this},e.prototype.skip=function(e){return this._config[this._order.length]=e,this._order.push("skp"),this},e.prototype.take=function(e){return this._config[this._order.length]=e,this._order.push("tk"),this},e.prototype.subscribe=function(e){var t,r=this,i={},o={},s={},a={};return new n.INanoSQLObserverSubscriber(this._nSQL,this._query,{next:function(n,u){if(r._count++,!t){var c=0,l=function(){if(c===r._order.length)"function"==typeof e?e(n,u):e.next&&e.next(n,u),t&&e.complete&&e.complete(n,u);else{var f=function(e){if(0===r._count)return 0;for(var t=e,n=r._count,i=!1;t--&&!i;)void 0!==a[t]&&(i=!0,n=a[t]);return n};switch(r._order[c]){case"dbnc":if(o[c]){clearTimeout(s[c]);var h=r._config[c];return void(s[c]=setTimeout(function(){Date.now()-o[c]>=h&&(o[c]=Date.now(),void 0===a[c]&&(a[c]=0),a[c]++,c++,l())},h-(Date.now()-o[c])))}o[c]=Date.now();break;case"dsct":var p=r._config[c][0](n,u);if(!1!==r._config[c][1](i[c],p))return;i[c]=p,void 0===a[c]&&(a[c]=0),a[c]++;break;case"fltr":if(!1===r._config[c](n,f(c),u))return;void 0===a[c]&&(a[c]=0),a[c]++;break;case"fst":if(!0!==r._config[c](n,f(c),u))return;void 0===a[c]&&(a[c]=0),a[c]++,t=!0;break;case"mp":n=r._config[c](n,f(c),u);break;case"skp":if(f(c)<=r._config[c])return;break;case"tk":f(c)>=r._config[c]&&(t=!0)}c++,l()}};l()}},error:function(t){e.error&&e.error(t)}},this._tables)},e}();t.Observer=o;var s=function(){function e(e,t,r,n){var i=this;this._closed=!1,this.exec=this.exec.bind(this),this.unsubscribe=this.unsubscribe.bind(this);var o=this._getQuery();o&&(this._tables=this._tables.concat([o.table]),this._tables=this._tables.filter(function(e,t,r){return r.indexOf(e)===t}),this.exec()),this._tables.forEach(function(e){i._nSQL.selectTable(e).on("change",i.exec)})}return e.prototype.exec=function(e){var t=this;i.setFast(function(){t._getQuery(e)})},e.prototype.unsubscribe=function(){var e=this;this._tables.forEach(function(t){e._nSQL.selectTable(t).off("change",e.exec)}),this._closed=!0},e.prototype.closed=function(){return this._closed},e}();t.ObserverSubscriber=s},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),i=r(7),o={};t.attachDefaultFns=function(e){e.functions={COUNT:{type:"A",aggregateStart:{result:0,row:{}},call:function(e,t,r,i){return i&&"*"!==i?n.deepGet(i,t)&&r.result++:r.result++,r.row=t,r}},MAX:{type:"A",aggregateStart:{result:void 0,row:{}},call:function(e,t,r,i){var o=n.deepGet(i,t)||0;return void 0===r.result?(r.result=o,r.row=t):o>r.result&&(r.result=o,r.row=t),r}},MIN:{type:"A",aggregateStart:{result:void 0,row:{}},call:function(e,t,r,i){var o=n.deepGet(i,t)||0;return void 0===r.result?(r.result=o,r.row=t):o<r.result&&(r.result=o,r.row=t),r}},GREATEST:{type:"S",call:function(e,t,r){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return{result:i.map(function(e){return isNaN(e)?n.getFnValue(t,e):parseFloat(e)}).sort(function(e,t){return e<t?1:-1})[0]}}},LEAST:{type:"S",call:function(e,t,r){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return{result:i.map(function(e){return isNaN(e)?n.getFnValue(t,e):parseFloat(e)}).sort(function(e,t){return e>t?1:-1})[0]}}},AVG:{type:"A",aggregateStart:{result:0,row:{},total:0,records:0},call:function(e,t,r,i){var o=parseFloat(n.deepGet(i,t)||0)||0;return r.total+=isNaN(o)?0:o,r.records++,r.result=r.total/r.records,r.row=t,r}},SUM:{type:"A",aggregateStart:{result:0,row:{}},call:function(e,t,r,i){var o=parseFloat(n.deepGet(i,t)||0)||0;return r.result+=isNaN(o)?0:o,r.row=t,r}},LOWER:{type:"S",call:function(e,t,r,i){return{result:String(n.getFnValue(t,i)).toLowerCase()}}},UPPER:{type:"S",call:function(e,t,r,i){return{result:String(n.getFnValue(t,i)).toUpperCase()}}},CAST:{type:"S",call:function(e,t,r,i,o){return{result:n.cast(o,n.deepGet(i,t))}}},CONCAT:{type:"S",call:function(e,t,r){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return{result:i.map(function(e){return n.getFnValue(t,e)}).join("")}}},LEVENSHTEIN:{type:"S",call:function(e,t,r,s,a){var u=n.getFnValue(t,s),c=n.getFnValue(t,a),l=u+"::"+c;return o[l]||(o[l]=i(u,c)),{result:o[l]}}},CROW:{type:"S",call:function(t,r,i,o,s,a){var u=n.deepGet(o+".lat",r),c=n.deepGet(o+".lon",r);return{result:n.crowDistance(u,c,parseFloat(s),parseFloat(a),e.earthRadius)}},whereIndex:function(e,t,r,i){if(">"===i[1]||">="===i[1]){var o="string"==typeof t.table?e.tables[t.table].indexes:{},s=n.resolveObjPath(r[0]),a=[];if(Object.keys(o).forEach(function(e){var t=o[e];n.compareObjects(t.path.slice(0,t.path.length-1),s)&&a.push(t.name.replace("-lat","").replace("-lon",""))}),2===a.length)return{index:a[0],fnName:"CROW",fnArgs:r,comp:i[1],value:i[2]}}return!1},queryIndex:function(e,t,r,n,i,o){}}},Object.getOwnPropertyNames(Math).forEach(function(t){e.functions[t.toUpperCase()]={type:"S",call:function(e,r,i){for(var o=[],s=3;s<arguments.length;s++)o[s-3]=arguments[s];var a=o.map(function(e){return parseFloat(isNaN(e)?n.deepGet(e,r):e)});return{result:Math[t].apply(null,a)}}}})}},function(e,t,r){"use strict";e.exports=function(e,t,r){var o,s,a,u,c,l,f,h;if(e===t)return 0;if(o=e.length,s=t.length,0===o)return s;if(0===s)return o;r&&(e=e.toLowerCase(),t=t.toLowerCase());f=0;for(;f<o;)i[f]=e.charCodeAt(f),n[f]=++f;h=0;for(;h<s;)for(a=t.charCodeAt(h),u=c=h++,f=-1;++f<o;)l=a===i[f]?c:c+1,c=n[f],n[f]=u=c>u?l>u?u+1:l:l>c?c+1:l;return u};var n=[],i=[]},function(e,t,r){var n=this&&this.__assign||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i=r(1),o=r(0),s=function(){function e(e,t,r,n,i){var o=this;this.nSQL=e,this.query=t,this.progress=r,this.complete=n,this.error=i,this._queryBuffer=[],this._stream=!0,this._selectArgs=[],this._pkOrderBy=!1,this._idxOrderBy=!1,this._sortGroups=[],this._sortGroupKeys={},this._joinTableCache={},this._joinTableCacheLoading={},this._graphTableCache={},this._graphTableCacheLoading={},this.query.state="processing";var s=t.action.toLowerCase().trim();if(this._orderByRows=this._orderByRows.bind(this),"select"!==s&&"string"!=typeof t.table)return this.query.state="error",void this.error('Only "select" queries are available for this resource!');if("string"==typeof t.table&&!this.nSQL.state.connected)return this.query.state="error",void this.error("Can't execute query before the database has connected!");var a=function(e){return"string"!=typeof o.query.table?(o.query.state="error",void o.error(o.query.action+" query requires a string table argument!")):o.query.actionArgs?void e():(o.query.state="error",void o.error(o.query.action+" query requires an additional argument!"))},u=function(){"error"!==o.query.state&&(o.query.state="complete",o.complete())};switch(s){case"select":this._select(u,this.error);break;case"upsert":this._upsert(this.progress,this.complete,this.error);break;case"delete":this._delete(this.progress,this.complete,this.error);break;case"show tables":this._showTables();break;case"describe":this._describe();break;case"drop":case"drop table":this._dropTable(this.query.table,u,this.error);break;case"create table":case"create table if not exists":a(function(){o._createTable(o.query.actionArgs,u,o.error)});break;case"alter table":a(function(){o._alterTable(o.query.actionArgs,u,o.error)});break;case"rebuild indexes":a(function(){o._rebuildIndexes(o.progress,u,o.error)});break;default:this.nSQL.doFilter("customQuery",{query:this,onRow:r,complete:n,error:i}).then(function(){o.query.state="error",o.error('Query type "'+t.action+'" not supported!')}).catch(function(e){o.query.state="error",o.error(e)})}}return e.prototype._getTableCache=function(e,t,r){var n=this;if("function"==typeof t){if(this._joinTableCache[e])return void(this._joinTableCacheLoading[e]?setTimeout(function(){n._getTableCache(e,t,r)},10):r(this._joinTableCache[e]));this._joinTableCacheLoading[e]=!0,this._joinTableCache[e]=[],t().then(function(t){n._joinTableCache[e]=t,n._joinTableCacheLoading[e]=!1,r(t)}).catch(function(e){n.query.state="error",n.error(e)})}else r(t)},e.prototype._maybeJoin=function(e,t,r,i){var s,a=this;if(!e[0])return r(t),void i();var u=function(t,i,s){var c=e[i],l=0,f=[];if("cross"!==c.type&&!c.on)return a.query.state="error",void a.error(new Error("Non 'cross' joins require an 'on' parameter!"));var h=new Error("Must use 'AS' when joining temporary tables!");if("string"!=typeof c.with.table&&!c.with.as)return a.query.state="error",void a.error(h);if("string"!=typeof a.query.table&&!a.query.tableAS)return a.query.state="error",void a.error(h);var p=new o.NanoSQLBuffer(function(t,n,o,s){e[i+1]?u(t,i+1,o):(r(function(e){return Object.keys(e).reduce(function(t,r){var n=e[r];return n?(Object.keys(n).forEach(function(e){t[r+"->"+e]=n[e]}),t):t},{})}(t)),o())},a.error,s),d="string"==typeof c.with.table?a.nSQL.tables[c.with.table].pkCol:"",y=String(c.with.as||c.with.table),g=String(a.query.tableAS||a.query.table);a._getTableCache(String("J-"+i),c.with.table,function(e){var r,i=a.query.tableAS||a.query.table;a.nSQL.triggerQuery(n({},o.buildQuery(e,"select"),{tableAS:c.with.as,where:c.on&&"cross"!==c.type?a._buildCombineWhere(c.on,c.with.as||c.with.table,i,(r={},r[i]=t,r)):void 0,skipQueue:!0}),function(e){var r;l++,"right"!==c.type&&"outer"!==c.type||f.push(d?e[d]:o.hash(JSON.stringify(e))),p.newItem(n({},t,((r={})[y]=e,r)))},function(){var e,r;switch(c.type){case"left":0===l&&p.newItem(n({},t,((e={})[y]=void 0,e))),p.finished();break;case"inner":case"cross":p.finished();break;case"outer":case"right":0===l&&"outer"===c.type&&p.newItem(n({},t,((r={})[y]=void 0,r))),a.nSQL.triggerQuery(n({},o.buildQuery(c.with.table,"select"),{skipQueue:!0,where:d?[d,"NOT IN",f]:void 0}),function(e){var r;(d||-1===f.indexOf(o.hash(JSON.stringify(e))))&&p.newItem(n({},t,((r={})[g]=void 0,r[y]=e,r)))},function(){p.finished()},function(e){a.query.state="error",a.error(e)})}},function(e){a.query.state="error",a.error(e)})})};u(((s={})[String(this.query.tableAS||this.query.table)]=t,s),0,i)},e.prototype._select=function(e,t){var r=this;if(this._whereArgs=this.query.where?this._parseWhere(this.query.where,"string"!=typeof this.query.table||void 0!==this.query.union):{type:i.IWhereType.none},this._havingArgs=this.query.having?this._parseWhere(this.query.having,!0):{type:i.IWhereType.none},this._parseSelect(),"error"!==this.query.state){var n=[this.query.offset||0,(this.query.offset||0)+(this.query.limit||0)],s=n[0]+n[1]>0;if(this.query.union){var a=[],u=[],c=0;o.chainAsync(this.query.union.queries,function(e,t,i){e().then(function(e){u.length||(u=Object.keys(e[0])),r.query.where&&(e=e.filter(function(e,t){return r._where(e,r._whereArgs.slowWhere)})),e=e.map(function(e){if(r.query.union&&"distinct"===r.query.union.type){var n=o.hash(JSON.stringify(e));if(0===t)a.push(n);else{if(-1!==a.indexOf(n))return;a.push(n)}}return Object.keys(e).reduce(function(t,r,n){return n<u.length&&(t[u[n]]=e[r]),t},{})}).filter(function(e){return e}),r.query.orderBy?r._queryBuffer=r._queryBuffer.concat(e.map(function(e){var t=r._streamAS(e);return!r.query.having||r._where(t,r._havingArgs.slowWhere)?t:void 0}).filter(function(e){return e})):e.forEach(function(e,t){var i=r._streamAS(e);(!r.query.having||r._where(i,r._havingArgs.slowWhere))&&(s?c>=n[0]&&c<n[1]&&r.progress(r._streamAS(e),c):r.progress(r._streamAS(e),c),c++)}),i()})}).then(function(){if(r.query.orderBy){var t=r._queryBuffer.sort(r._orderByRows);(s?t.slice(n[0],n[1]):t).forEach(r.progress)}e()})}else{var l=Array.isArray(this.query.join)?this.query.join:[this.query.join],f=!1;!this._stream||this.query.join||this.query.orderBy||this.query.having||this.query.groupBy||(f=!0);var h=0,p=new o.NanoSQLBuffer(function(e,t,i,a){e=o._maybeAssign(e);var u=new o.NanoSQLBuffer(function(e,t,i,o){var a=!0;r.query.having&&(a=r._where(r._selectArgs.length?r._streamAS(e):e,r._havingArgs.slowWhere)),a&&s&&(a=h>=n[0]&&h<n[1]),a&&r.query.graph?r._graph(r.query.graph||[],e,r.query.tableAS||r.query.table,h,function(e,t){r.progress(r._selectArgs.length?r._streamAS(e):e,t),h++,i()},0):(a&&r.progress(r._selectArgs.length?r._streamAS(e):e,h),h++,i())},r._onError,function(){i()});r._maybeJoin(l,e,function(e){r._stream?u.newItem(e):r._queryBuffer.push(e)},function(){u.finished()})},this.error,function(){r._stream||f?e():o.allAsync(r._queryBuffer,function(e,t,n){r._graph(r.query.graph||[],r.query.tableAS||r.query.table,e,t,n,0)}).then(function(t){r._queryBuffer=t,r._groupByRows(),r.query.having&&(r._queryBuffer=r._queryBuffer.filter(function(e){return r._where(e,r._havingArgs.slowWhere)})),r.query.orderBy&&r._queryBuffer.sort(r._orderByRows),s&&(r._queryBuffer=r._queryBuffer.slice(n[0],n[1])),r._queryBuffer.forEach(function(e,t){r.progress(e,n[0]+t)}),e()})}),d=new o.NanoSQLBuffer(function(e,t,n,i){r._graph(r.query.graph||[],r.query.tableAS||r.query.table,e,t,function(e,t){r.progress(r._selectArgs.length?r._streamAS(e):e,t),n()},0)},this._onError,function(){p.finished()});this._getRecords(function(e,t){f?(!s||t>=n[0]&&t<n[1])&&d.newItem(e):p.newItem(e)},function(){d.finished()})}}},e.prototype._groupByRows=function(){var e=this;this.query.groupBy||this._hasAggrFn?(this._queryBuffer.sort(function(t,r){return e._sortObj(t,r,e._groupBy)}).forEach(function(t,r){var n=e._groupBy.sort.map(function(e){return String(o.deepGet(e.path,t))}).join(".");void 0===e._sortGroupKeys[n]&&(e._sortGroupKeys[n]=e._sortGroups.length);var i=e._sortGroupKeys[n];e._sortGroups[i]||e._sortGroups.push([]),e._sortGroups[i].push(t)}),this._queryBuffer=[],this._hasAggrFn?this._sortGroups.forEach(function(t){var r=e._selectArgs.reduce(function(t,r,n){return e.nSQL.functions[r.value]&&"A"===e.nSQL.functions[r.value].type&&(t[n]={idx:n,name:r.value,aggr:o._assign(e.nSQL.functions[r.value].aggregateStart),args:r.args}),t},[]),n=r.filter(function(e){return e})[0];t.forEach(function(t,n){r.forEach(function(n,i){var o;n&&(r[i].aggr=(o=e.nSQL.functions[n.name]).call.apply(o,[e.query,t,r[i].aggr].concat(r[i].args)))})}),e._queryBuffer.push(e._selectArgs.reduce(function(t,i,s){var a,u=i.isFn?i.value+"("+(i.args||[]).join(",")+")":i.value;return t[i.as||u]=i.isFn&&r[s]?r[s].aggr.result:i.isFn?(a=e.nSQL.functions[i.value]).call.apply(a,[e.query,r[n.idx].aggr.row,{}].concat(i.args||[])):o.deepGet(i.value,r[n.idx].aggr.row),t},{}))}):this._sortGroups.forEach(function(t){t.forEach(function(t){e._queryBuffer.push(e._streamAS(t))})})):this._queryBuffer=this._queryBuffer.map(function(t){return e._streamAS(t)})},e.prototype._buildCombineWhere=function(e,t,r,i){var s=this;return"function"==typeof e?function(r){var o;return e(n(((o={})[t]=r,o),i))}:("string"==typeof e[0]?[e]:e).map(function(e){if(Array.isArray(e[0]))return s._buildCombineWhere(e,t,r,i);if("AND"===e||"OR"===e)return e;var n=o.resolveObjPath(e[0]),a=o.resolveObjPath(e[2]),u=n[0]===r;return[u?a.slice(1).join("."):n.slice(1).join("."),u?-1!==e[1].indexOf(">")?e[1].replace(">","<"):e[1].replace("<",">"):e[1],o.deepGet(u?n:a,i)]})},e.prototype._graph=function(e,t,r,i,s,a){var u=this;e&&0!==e.length?(r=o._maybeAssign(r),o.allAsync(e,function(e,i,s){var c=new Error("Must use 'AS' when graphing temporary tables!");if(r[e.key]=[],"string"!=typeof e.with.table&&!e.with.as)return u.query.state="error",void u.error(c);if("string"!=typeof u.query.table&&!u.query.tableAS)return u.query.state="error",void u.error(c);var l=new o.NanoSQLBuffer(function(t,n,i,o){e.graph?u._graph(e.graph,e.with.as||e.with.table,t,n,function(t){r[e.key].push(t),i()},a+1):(r[e.key].push(t),i())},u._onError,function(){s(null)}),f=JSON.stringify([a,i]);u._getTableCache(String("G-"+f),e.with.table,function(i){var s;u.nSQL.triggerQuery(n({},o.buildQuery(i,"select"),{actionArgs:e.select,where:u._buildCombineWhere(e.on,e.with.as||e.with.table,t,(s={},s[t]=r,s)),limit:e.limit,offset:e.offset,orderBy:e.orderBy,groupBy:e.groupBy,skipQueue:!0}),function(e){l.newItem(e)},function(){l.finished()},u._onError)})}).then(function(){s(r,i)})):s(r,i)},e.prototype._upsert=function(e,t,r){var n=this;if(this.query.actionArgs||(r("Can't upsert without records!"),this.query.state="error"),-1!==this.query.table.indexOf(".")||-1!==this.query.table.indexOf("[")){var s=o.resolveObjPath(this.query.table);this.query.table=s.shift(),this.upsertPath=s}if(this._whereArgs=this.query.where?this._parseWhere(this.query.where):{type:i.IWhereType.none},"error"!==this.query.state){var a=Array.isArray(this.query.actionArgs)?this.query.actionArgs:[this.query.actionArgs],u=this.nSQL.tables[this.query.table];if(this._whereArgs.type===i.IWhereType.none)o.allAsync(a,function(e,t,r,i){e[u.pkCol]?n.nSQL.adapter.read(n.query.table,e[u.pkCol],function(t){t?n._updateRow(e,t,r,i):n._newRow(e,r,i)},function(t){n._newRow(e,r,i)}):n._newRow(e,r,i)}).then(function(){e({result:a.length+" row(s) upserted"},0),t()});else{if(a.length>1)return this.query.state="error",void r("Cannot upsert multiple records with where condition!");var c=0,l=new o.NanoSQLBuffer(function(e,t,r,i){c++,n._updateRow(a[0],e,r,i)},r,function(){e({result:c+" row(s) upserted"},0),t()});this._getRecords(function(e,t){l.newItem(e)},function(){l.finished()})}}},e.prototype._updateRow=function(e,t,r,i){var s=this;this.nSQL.doFilter("updateRow",{result:e,row:t,query:this.query}).then(function(e){var i=s.nSQL.default(s.upsertPath?o.deepSet(s.upsertPath,o._maybeAssign(t),e):n({},t,e),s.query.table),a=s._getIndexValues(s.nSQL.tables[s.query.table].indexes,i),u=s._getIndexValues(s.nSQL.tables[s.query.table].indexes,t),c=s.nSQL.tables[s.query.table];o.allAsync(Object.keys(u).concat(["__pk__"]),function(e,t,r,n){if("__pk__"===e)s.nSQL.adapter.write(s.query.table,i[c.pkCol],i,function(e){i[c.pkCol]=e,r(null)},n);else{var l="_idx_"+s.query.table+"_"+e;if(!1===o.compareObjects(a[e],u[e]))if(c.indexes[e].isArray){var f=a[e].filter(function(t,r,n){return-1===u[e].indexOf(t)}),h=u[e].filter(function(t,r,n){return-1===a[e].indexOf(t)});o.allAsync([f,h],function(e,t,r){e.length?o.allAsync(e,function(e,r,o){s._updateIndex(l,e,i[c.pkCol],0===t,function(){o(null)},n)}).then(r):r(null)}).then(r)}else o.allAsync(["rm","add"],function(t,r,o){switch(t){case"add":s._updateIndex(l,a[e],i[c.pkCol],!0,function(){o(null)},n);break;case"rm":s._updateIndex(l,u[e],i[c.pkCol],!1,function(){o(null)},n)}}).then(r);else r(null)}}).then(function(){s.nSQL.doFilter("updatedRow",{newRow:i,oldRow:t,query:s.query}).then(function(){r(i)})})}).catch(i)},e.prototype._updateIndex=function(e,t,r,n,i,s){var a=this;this.nSQL.adapter.read(e,t,function(u){var c=(u=o._maybeAssign(u||function(e){return{id:e,pks:[]}}(t))).pks.indexOf(r);if(n)-1===c&&u.pks.push(r);else{if(-1===c)return void i();u.pks.splice(c,1)}a.nSQL.adapter.write(e,t,u,i,s)},s)},e.prototype._newRow=function(e,t,r){var n=this;this.nSQL.doFilter("addRow",{result:e,query:this.query}).then(function(e){var i=n.nSQL.tables[n.query.table];e=n.nSQL.default(o._maybeAssign(n.upsertPath?o.deepSet(n.upsertPath,{},e):e),n.query.table);var s=n._getIndexValues(n.nSQL.tables[n.query.table].indexes,e);n.nSQL.adapter.write(n.query.table,e[i.pkCol],e,function(r){e[i.pkCol]=r,o.allAsync(Object.keys(s),function(t,r,a,u){var c="_idx_"+n.query.table+"_"+t;if(i.indexes[t].isArray){var l=s[t]||[];o.allAsync(l,function(t,r,o){n._updateIndex(c,t,e[i.pkCol],!0,function(){a(null)},u)}).then(a)}else n._updateIndex(c,s[t],e[i.pkCol],!0,function(){a(null)},u)}).then(function(){n.nSQL.doFilter("updatedRow",{newRow:e,query:n.query}).then(function(){t(e)})})},r)}).catch(r)},e.prototype._delete=function(e,t,r){var n=this;if(this._whereArgs=this.query.where?this._parseWhere(this.query.where):{type:i.IWhereType.none},"error"!==this.query.state){var s=0,a=this.nSQL.tables[this.query.table],u=new o.NanoSQLBuffer(function(e,t,i,u){s++,n.nSQL.doFilter("deleteRow",{result:e,query:n.query}).then(function(t){var s=n._getIndexValues(a.indexes,e);o.allAsync(Object.keys(s).concat(["__del__"]),function(i,u,c){if("__del__"===i)n.nSQL.adapter.delete(n.query.table,t[a.pkCol],function(){c(null)},function(e){n.query.state="error",r(e)});else{var l="_idx_"+n.query.table+"_"+i;if(a.indexes[i].isArray){var f=s[i]||[];o.allAsync(f,function(t,i,o){n._updateIndex(l,t,e[a.pkCol],!1,function(){o(null)},r)}).then(c)}else n._updateIndex(l,s[i],e[a.pkCol],!1,function(){c(null)},function(e){n.query.state="error",r(e)})}}).then(i).catch(u)}).catch(u)},r,function(){e({result:s+" row(s) deleted"},0),t()});this._getRecords(function(e,t){u.newItem(e)},function(){u.finished()})}},e.prototype._getIndexValues=function(e,t){var r=this;return Object.keys(e).reduce(function(n,i){var s=o.deepGet(e[i].path,t),a=e[i].type;return n[i]=e[i].isArray?(Array.isArray(s)?s:[]).map(function(e){return r.nSQL.indexTypes[a](e)}):r.nSQL.indexTypes[a](s),n},{})},e.prototype._showTables=function(){this.progress({tables:Object.keys(this.nSQL.tables)},0),this.complete()},e.prototype._describe=function(){return"string"!=typeof this.query.table?(this.query.state="error",void this.error("Can't call describe on that!")):this.nSQL.tables[this.query.table]?(this.progress({describe:o._assign(this.nSQL.tables[this.query.table].columns)},0),void this.complete()):(this.query.state="error",void this.error("Table "+this.query.table+" not found!"))},e.prototype._streamAS=function(e){var t=this;if(this._selectArgs.length){var r={};return this._selectArgs.forEach(function(n){var i;if(n.isFn){if(!t.nSQL.functions[n.value])return t.query.state="error",void t.error("Function "+n.value+" not found!");r[n.as||n.value]=(i=t.nSQL.functions[n.value]).call.apply(i,[t.query,e,{}].concat(n.args||[])).result}else r[n.as||n.value]=o.deepGet(n.value,e)}),r}return e},e.prototype._orderByRows=function(e,t){return this._sortObj(e,t,this._orderBy)},e.prototype._sortObj=function(e,t,r){return r.sort.reduce(function(r,n){var i=o.deepGet(n.path,e),s=o.deepGet(n.path,t);return r||(i===s?0:(i>s?1:-1)*("DESC"===n.dir?-1:1))},0)},e.prototype._createTable=function(e,t,r){var i=this;new Promise(function(t,r){var i=!1,o=e.name;e._internal||0!==o.indexOf("_")&&null===o.match(/\s/g)&&null===o.match(/[\(\)\]\[\.]/g)?(e.model.forEach(function(t){var n=t.key.split(":");1===n.length&&n.push("any"),n[0]&&null===n[0].match(/[\(\)\]\[\.]/g)&&0!==n[0].indexOf("_")||(i=!0,r("nSQL: Invalid Data Model at "+e.name+", "+JSON.stringify(t)+"! https://docs.nanosql.io/setup/data-models"))}),e.model=e.model.map(function(e){return n({},e,{key:e.key.replace(/\s+/g,"-")})}),i||t()):r("nSQL: Invalid Table Name "+e.name+"! https://docs.nanosql.io/setup/data-models")}).then(function(){return i.nSQL.doFilter("createTable",{result:e,query:i.query})}).then(function(e){return new Promise(function(t,r){var n=function(e){return e.map(function(e){return 0===(e.key.split(":")[1]||"any").indexOf("geo")&&(e.model=[{key:"lat:float",default:0},{key:"lon:float",default:0}]),e.model&&(e.model=n(e.model)),e})},s=function(e){return e.filter(function(e){return"*"!==e.key}).map(function(e){return{key:e.key.split(":")[0],type:e.key.split(":")[1]||"any",default:e.default||null,notNull:!(!e.props||-1===e.props.indexOf("not_null()")),model:e.model?s(e.model):void 0}})},a=!1,u=n(e.model);if(i.nSQL.tables[e.name]={model:u,columns:s(u),actions:e.actions||[],views:e.views||[],indexes:(e.indexes||[]).map(function(e){return{name:e.name.replace(/\W/g,"").replace(/\s+/g,"-").toLowerCase(),type:(e.key.split(":")[1]||"string").replace(/\[\]/gim,""),isArray:-1!==(e.key.split(":")[1]||"string").indexOf("[]"),path:o.resolveObjPath(e.key.split(":")[0])}}).reduce(function(e,t){return-1===Object.keys(i.nSQL.indexTypes).indexOf(t.type)?(a=!0,r('Index "'+t.name+'" does not have a valid type!'),e):(-1!==t.type.indexOf("geo")?(e[t.name+"-lat"]={name:t.name+"-lat",type:"float",path:t.path.concat(["lat"])},e[t.name+"-lon"]={name:t.name+"-lon",type:"float",path:t.path.concat(["lon"])}):e[t.name]=t,e)},{}),pkType:e.model.reduce(function(e,t){return t.props&&-1!==t.props.indexOf("pk()")?t.key.split(":")[1]:e},""),pkCol:e.model.reduce(function(e,t){return t.props&&-1!==t.props.indexOf("pk()")?t.key.split(":")[0]:e},""),ai:e.model.reduce(function(e,t){return!(!t.props||-1===t.props.indexOf("pk()")||-1===t.props.indexOf("ai()"))||e},!1)},""===i.nSQL.tables[e.name].pkCol&&(i.nSQL.tables[e.name].pkCol="_id_",i.nSQL.tables[e.name].pkType="uuid",i.nSQL.tables[e.name].model.unshift({key:"_id_:uuid",props:["pk()"]}),i.nSQL.tables[e.name].columns=s(i.nSQL.tables[e.name].model)),!a){var c=[e.name];Object.keys(i.nSQL.tables[e.name].indexes).forEach(function(t,r){var n=i.nSQL.tables[e.name].indexes[t],o="_idx_"+e.name+"_"+n.name;c.push(o),i.nSQL.tables[o]={model:[{key:"id:"+(n.type||"uuid"),props:["pk()"]},{key:"pks:"+i.nSQL.tables[e.name].pkType+"[]"}],columns:[{key:"id",type:n.type||"uuid"},{key:"pks",type:i.nSQL.tables[e.name].pkType+"[]"}],actions:[],views:[],indexes:{},pkType:n.type,pkCol:"id",ai:!1}}),o.allAsync(c,function(e,t,r,n){i.nSQL.adapter.createAndInitTable(e,i.nSQL.tables[e],r,n)}).then(t).catch(r)}}).then(t).catch(r)})},e.prototype._alterTable=function(e,t,r){var n=this;this.nSQL.doFilter("alterTable",{result:e,query:this.query}).then(function(i){var s=[i.name];Object.keys(n.nSQL.tables[e.name].indexes).forEach(function(e){s.push("_idx_"+i.name+"_"+e)}),o.allAsync(s,function(e,t,r,o){n.nSQL.adapter.disconnectTable(i.name,r,o)}).then(function(){n._createTable(i,t,r)}).catch(r)}).catch(r)},e.prototype._dropTable=function(e,t,r){var n=this;this.nSQL.doFilter("destroyTable",{result:e,query:this.query}).then(function(e){var i=[e];i.forEach(function(e){Object.keys(n.nSQL.tables[e].indexes).forEach(function(t){i.push("_idx_"+e+"_"+t)})}),o.allAsync(i,function(e,t,r,i){n.nSQL.adapter.dropTable(e,function(){delete n.nSQL.tables[e],r(e)},i)}).then(t).catch(r)})},e.prototype._onError=function(e){this.query.state="error",this.error(e)},e.prototype._resolveFastWhere=function(e,t,r,n,i){var s=this;if(t.index&&t.fnName)this.nSQL.functions[t.fnName].queryIndex(this.nSQL,this,t,e,n,i);else{var a="_pk_"===t.index,u=this.nSQL.tables[this.query.table].pkCol,c="_idx_"+this.query.table+"_"+t.col,l=0,f=0,h=!1,p=function(){h&&0===l&&i()},d=function(t,r){a?(n(e?t[u]:t,0),r()):e?((t.pks||[]).forEach(function(e,t){n(e,f),f++}),r()):o.allAsync(t.pks,function(e,t,r){s.nSQL.adapter.read(s.query.table,e,function(e){n(e,f),f++,r(null)},s.error)}).then(r)};if(t.indexArray)switch(t.comp){case"INCLUDES":this.nSQL.adapter.read(c,t.value,function(e){d(e,i)},this.error);break;case"INTERSECT ALL":case"INTERSECT":var y={},g=0;o.allAsync(t.value||[],function(e,t,r){s.nSQL.adapter.read(c,e,function(e){g=t+1,(e.pks||[]).forEach(function(e){y[e]=(y[e]||0)+1}),r(null)},s.error)}).then(function(){d({pks:"INTERSECT"===t.comp?Object.keys(y):Object.keys(y).filter(function(e){return y[e]===g})},i)})}else switch(t.comp){case"=":e&&a?(n(t.value,0),i()):this.nSQL.adapter.read(a?this.query.table:c,t.value,function(e){d(e,i)},this.error);break;case"BETWEEN":this.nSQL.adapter.readMulti(a?this.query.table:c,"range",t.value[0],t.value[1],r,function(e,t){l++,d(e,function(){l--,p()})},function(){h=!0,p()},this._onError);break;case"IN":var _=r?t.value.sort(function(e,t){return e<t?1:-1}):t.value.sort(function(e,t){return e>t?1:-1});e&&a?(_.forEach(function(e,t){return n(e,t)}),i()):o.allAsync(_,function(e,t,r){s.nSQL.adapter.read(a?s.query.table:c,e,function(e){l++,d(e,function(){l--,p(),r(null)})},s.error)}).then(function(){h=!0,p()})}}},e.prototype._fastQuery=function(e,t){var r=this;if(this._whereArgs.fastWhere)if(1===this._whereArgs.fastWhere.length){var n=this._whereArgs.fastWhere[0],i=this._pkOrderBy&&"DESC"===this._orderBy.sort[0].dir;this._resolveFastWhere(!1,n,i,e,t)}else{var s={},a=0;o.chainAsync(this._whereArgs.fastWhere,function(e,t,n){if(t%2!=1){a=t;r._resolveFastWhere(!0,e,!1,function(e){s[e]=(s[e]||0)+1},n)}else n()}).then(function(){var n=[];Object.keys(s).forEach(function(e){s[e]===a&&n.push(e)}),r._resolveFastWhere(!1,{index:"_pk_",col:r.nSQL.tables[r.query.table].pkCol,comp:"IN",value:n},!1,e,t)})}},e.prototype._getRecords=function(e,t){var r=this,n=function(n){for(var o=0;o<n.length;)r._whereArgs.type!==i.IWhereType.none?r._whereArgs.whereFn?r._whereArgs.whereFn(n[o],o)&&e(n[o],o):r._where(n[o],r._whereArgs.slowWhere)&&e(n[o],o):e(n[o],o),o++;t()};if("string"==typeof this.query.table)switch(this._whereArgs.type){case i.IWhereType.fast:this._fastQuery(e,t);break;case i.IWhereType.medium:this._fastQuery(function(t,n){r._where(t,r._whereArgs.slowWhere)&&e(t,n)},t);break;case i.IWhereType.slow:case i.IWhereType.none:case i.IWhereType.fn:var o=this._pkOrderBy&&"DESC"===this._orderBy.sort[0].dir;this.nSQL.adapter.readMulti(this.query.table,"all",void 0,void 0,o,function(t,n){r._whereArgs.type===i.IWhereType.slow?r._where(t,r._whereArgs.slowWhere)&&e(t,n):r._whereArgs.type===i.IWhereType.fn&&r._whereArgs.whereFn?r._whereArgs.whereFn(t,n)&&e(t,n):e(t,n)},t,function(e){r.query.state="error",r.error(e)})}else"function"==typeof this.query.table?this.query.table().then(n).catch(function(e){r.error(e)}):Array.isArray(this.query.table)&&n(this.query.table)},e.prototype._rebuildIndexes=function(e,t,r){var n=this,i=Array.isArray(this.query.actionArgs)?this.query.actionArgs:[this.query.actionArgs];o.allAsync(i,function(t,i,s,a){if(n.nSQL.tables[t]){var u=Object.keys(n.nSQL.tables[t].indexes).map(function(e){return"_idx_"+t+"_"+e});o.allAsync(u,function(e,t,r,i){n.nSQL.adapter.dropTable(e,function(){n.nSQL.adapter.createAndInitTable(e,n.nSQL.tables[e],function(){r(null)},i)},i)}).then(function(){var i=new o.NanoSQLBuffer(function(r,i,o,s){n._newRow(r,function(r){e({table:t,row:r},i),o()},s)},r,function(){s(null)});n.nSQL.adapter.readMulti(t,"all",void 0,void 0,!1,function(e,t){i.newItem(e)},function(){i.finished()},a)}).catch(a)}else a(new Error("Table "+t+" not found for rebuilding indexes!"))}).then(t).catch(r)},e.prototype._where=function(e,t){if(t.length>1){for(var r="AND",n=!0,i=0;i<t.length;){var o=t[i];if(i%2==1)r=o;else{var s=!1;s=Array.isArray(o[0])?this._where(e,o):this._compare(o,e),n=0===i?s:"AND"===r?n&&s:n||s}i++}return n}return this._compare(t[0],e)},e.prototype._processLIKE=function(t,r){if(!e.likeCache[r]){var n="";e.likeCache[r]=new RegExp(r.split("").map(function(e){return"\\"===n?(n=e,e):(n=e,"%"===e?".*":"_"===e?".":e)}).join(""),"gmi")}return"string"!=typeof t?"number"==typeof t?null!==String(t).match(e.likeCache[r]):null!==JSON.stringify(t).match(e.likeCache[r]):null!==t.match(e.likeCache[r])},e.prototype._getColValue=function(e,t){var r;return e.fnName?(r=this.nSQL.functions[e.fnName]).call.apply(r,[this.query,t,this.nSQL.functions[e.fnName].aggregateStart||{result:void 0}].concat(e.fnArgs||[])):o.deepGet(e.col,t)},e.prototype._compare=function(e,t){var r=this._getColValue(e,t),n=e.value,i=e.comp;if("NULL"===n||"NOT NULL"===n){var s=-1!==[void 0,null,""].indexOf(r),a="="===i||"LIKE"===i;switch(n){case"NULL":return a?s:!s;case"NOT NULL":return a?!s:s}}if(-1!==["IN","NOT IN","BETWEEN","INTERSECT","INTERSECT ALL","NOT INTERSECT"].indexOf(i)&&!Array.isArray(n))return this.query.state="error",this.query.error('WHERE "'+i+'" comparison requires an array value!'),!1;switch(i){case"=":return o.compareObjects(n,r);case"!=":return!o.compareObjects(n,r);case">":return r>n;case"<":return r<n;case"<=":return r<=n;case">=":return r>=n;case"IN":return-1!==n.indexOf(r);case"NOT IN":return-1===n.indexOf(r);case"REGEXP":case"REGEX":return null!==(r||"").match(n);case"LIKE":return this._processLIKE(r||"",n);case"NOT LIKE":return!this._processLIKE(r||"",n);case"BETWEEN":return n[0]<=r&&n[1]>r;case"INCLUDES":return-1!==(r||[]).indexOf(n);case"NOT INCLUDES":return-1===(r||[]).indexOf(n);case"INTERSECT":return(r||[]).filter(function(e){return n.indexOf(e)>-1}).length>0;case"INTERSECT ALL":return(r||[]).filter(function(e){return n.indexOf(e)>-1}).length===n.length;case"NOT INTERSECT":return 0===(r||[]).filter(function(e){return n.indexOf(e)>-1}).length;default:return!1}},e.prototype._parseSort=function(t,r){var n=t&&t.length?o.hash(JSON.stringify(t)):"";if(!n)return{sort:[],index:""};if(e._sortMemoized[n])return e._sortMemoized[n];var i=t.map(function(e){return e.split(" ").map(function(e){return e.trim()})}).reduce(function(e,t){return e.push({path:o.resolveObjPath(t[0]),dir:(t[1]||"asc").toUpperCase()}),e},[]),s="";if(r&&1===i.length){var a="string"==typeof this.query.table?this.nSQL.tables[this.query.table].pkCol:"";if(i[0].path[0].length&&i[0].path[0]===a)s="_pk_";else for(var u=Object.keys(this.nSQL.tables[this.query.table].indexes),c=u.length;c--&&!s;)o.compareObjects(this.nSQL.tables[this.query.table].indexes[u[c]],i[0].path)&&(s=this.nSQL.tables[this.query.table].indexes[u[c]].name)}return e._sortMemoized[n]={sort:i,index:s},e._sortMemoized[n]},e.prototype._parseSelect=function(){var t=this,r=this.query.actionArgs&&this.query.actionArgs.length?JSON.stringify(this.query.actionArgs):"";this._orderBy=this._parseSort(this.query.orderBy||[],"string"==typeof this.query.table),this._groupBy=this._parseSort(this.query.groupBy||[],!1),r?e._selectArgsMemoized[r]?(this._hasAggrFn=e._selectArgsMemoized[r].hasAggrFn,this._selectArgs=e._selectArgsMemoized[r].args):((this.query.actionArgs||[]).forEach(function(e){var r=e.split(/\s+as\s+/i).map(function(e){return e.trim()});if(-1!==r[0].indexOf("(")){var n=r[0].split("(")[1].replace(")","").split(",").map(function(e){return e.trim()}),i=r[0].split("(")[0].trim().toUpperCase();t._selectArgs.push({isFn:!0,value:i,as:r[1],args:n}),t.nSQL.functions[i]?"A"===t.nSQL.functions[i].type&&(t._hasAggrFn=!0):(t.query.state="error",t.error('Function "'+i+'" not found!'))}else t._selectArgs.push({isFn:!1,value:r[0],as:r[1]})}),"error"!==this.query.state&&(e._selectArgsMemoized[r]={hasAggrFn:this._hasAggrFn,args:this._selectArgs})):this._selectArgs=[];var n=!1;this._whereArgs.type===i.IWhereType.none?(n="_pk_"===this._orderBy.index)&&(this._pkOrderBy=!0):(n=!!(this._orderBy.index.length&&this._whereArgs.fastWhere&&o.compareObjects(this._whereArgs.fastWhere[0].col,this._orderBy.sort[0].path)))&&(this._idxOrderBy=!0),(this._orderBy.sort.length&&!n||this._groupBy.sort.length||this._hasAggrFn)&&(this._stream=!1)},e.prototype._parseWhere=function(t,r){var n=this,s=t||[],a=JSON.stringify(s)+(r?"0":"1");if(e._whereMemoized[a])return e._whereMemoized[a];if("function"==typeof s)return{type:i.IWhereType.fn,whereFn:s};if(!s.length)return e._whereMemoized[a]={type:i.IWhereType.none},e._whereMemoized[a];for(var u="string"==typeof this.query.table?Object.keys(this.nSQL.tables[this.query.table].indexes).map(function(e){return n.nSQL.tables[n.query.table].indexes[e]}):[],c="string"==typeof this.query.table?this.nSQL.tables[this.query.table].pkCol:"",l=function(e,t){var i=!r&&0===t;return e.reduce(function(e,r,s){if(s%2==1)return"string"!=typeof r?(n.query.state="error",n.error("Malformed WHERE statement!"),e):(e.push(r),e);if(!Array.isArray(r))return n.query.state="error",n.error("Malformed WHERE statement!"),e;if(Array.isArray(r[0]))e.push(l(r,t+1));else{if(-1===r[0].indexOf("(")){var a=!1,f=i?o.resolveObjPath(r[0]):[];return-1!==["=","BETWEEN","IN"].indexOf(r[1])&&i&&(r[0]===c?(a=!0,e.push({index:"_pk_",col:r[0],comp:r[1],value:r[2]})):u.forEach(function(t){!1===a&&o.compareObjects(t.path,f)&&!1===t.isArray&&(a=!0,e.push({index:t.name,col:r[0],comp:r[1],value:r[2]}))})),i&&!a&&-1!==["INCLUDES","INTERSECT","INTERSECT ALL"].indexOf(r[1])&&u.forEach(function(t){o.compareObjects(t.path,f)&&!0===t.isArray&&(a=!0,e.push({index:t.name,indexArray:!0,col:r[0],comp:r[1],value:r[2]}))}),a||e.push({col:r[0],comp:r[1],value:r[2]}),e}var h=r[0].split("(")[1].replace(")","").split(",").map(function(e){return e.trim()}).filter(function(e){return e}),p=r[0].split("(")[0].trim().toUpperCase(),d=!1;if(!n.nSQL.functions[p])return n.query.state="error",n.error('Function "'+p+'" not found!'),e;if(i&&n.nSQL.functions[p]&&n.nSQL.functions[p].whereIndex){var y=n.nSQL.functions[p].whereIndex(n.nSQL,n.query,h,r);y&&(d=!0,e.push(y))}d||e.push({fnName:p,fnArgs:h,comp:r[1],value:r[2]})}},[])},f=l("string"==typeof s[0]?[s]:s,0),h=!0,p=0,d=-1;p<f.length&&h;)p%2==1?"AND"!==f[p]?h=!1:d=p:Array.isArray(f[p])||!f[p].index?h=!1:d=p,p++;if(d%2==0&&d++,-1===d||"AND"!==f[d]&&f[d])e._whereMemoized[a]={type:i.IWhereType.slow,slowWhere:f};else{var y=f.slice(d+1);e._whereMemoized[a]={type:y.length?i.IWhereType.medium:i.IWhereType.fast,slowWhere:y,fastWhere:f.slice(0,d)}}return e._whereMemoized[a]},e.likeCache={},e._sortMemoized={},e._selectArgsMemoized={},e._whereMemoized={},e}();t._NanoSQLQuery=s},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),i=function(){function e(e){this.useLS=e,this.plugin={name:"Sync Storage Adapter",version:2,dependencies:{core:[2]}},this._index={},this._rows={},this._ai={}}return e.prototype.connect=function(e,t,r){this._id=this.nSQL.config.id,t()},e.prototype.createAndInitTable=function(e,t,r,n){if(this._index[e]=[],this._rows[e]={},this.useLS){var i=localStorage.getItem(this._id+"->"+e+"_idx");i&&(this._index[e]=JSON.parse(i),this._ai[e]=parseFloat(localStorage.getItem(this._id+"->"+e+"_ai")||"0"))}r()},e.prototype.disconnectTable=function(e,t,r){delete this._index[e],delete this._rows[e],t()},e.prototype.dropTable=function(e,t,r){var n=this;this._index[e].forEach(function(t){n.useLS?localStorage.removeItem(n._id+"->"+e+"__"+t):delete n._rows[e][t]}),this.useLS&&localStorage.removeItem(this._id+"->"+e+"_idx"),delete this._index[e],delete this._rows[e],t()},e.prototype.disconnect=function(e,t){e()},e.prototype.write=function(e,t,r,i,o){if(t=t||n.generateID(this.nSQL.tables[e].pkType,this.nSQL.tables[e].ai?this._ai[e]+1:0),this.nSQL.tables[e].ai&&(this._ai[e]=n.cast("int",Math.max(this._ai[e]||0,t))),-1===this._index[e].indexOf(t)){var s=n.binarySearch(this._index[e],t);this._index[e].splice(s,0,t),this.useLS&&(localStorage.setItem(this._id+"->"+e+"_idx",JSON.stringify(this._index[e])),localStorage.setItem(this._id+"->"+e+"_ai",String(n.cast("int",Math.max(this._ai[e]||0,t)))))}r[this.nSQL.tables[e].pkCol]=t,this.useLS?(localStorage.setItem(this._id+"->"+e+"__"+t,JSON.stringify(r)),i(r[this.nSQL.tables[e].pkCol])):(this._rows[e][t]=n.deepFreeze(r),i(r[this.nSQL.tables[e].pkCol]))},e.prototype.read=function(e,t,r,n){if(this.useLS){var i=localStorage.getItem(this._id+"->"+e+"__"+t);r(i?JSON.parse(i):void 0)}else r(this._rows[e][t])},e.prototype.delete=function(e,t,r,n){var i=this._index[e].indexOf(t);-1!==i&&(this._index[e].splice(i,1),this.useLS&&localStorage.setItem(this._id+"->"+e+"_idx",JSON.stringify(this._index[e].keys()))),this.useLS?localStorage.removeItem(this._id+"->"+e+"__"+t):delete this._rows[e][t],r()},e.prototype.readMulti=function(e,t,r,n,i,o,s,a){this.readMultiAbstract(!1,e,t,r,n,i,o,s,a)},e.prototype.readMultiPK=function(e,t,r,n,i,o,s,a){this.readMultiAbstract(!0,e,t,r,n,i,o,s,a)},e.prototype.readMultiAbstract=function(e,t,r,n,i,o,s,a,u){var c=this,l={range:[n,i],offset:[n,n+i],all:!1}[r];this._index[t].forEach(function(n,i){(!l||("range"===r?n>=l[0]&&n<l[1]:i>=l[0]&&i<l[1]))&&(e?s(n,i):c.useLS?s(JSON.parse(localStorage.getItem(c._id+"->"+t+"__"+n)||"{}"),i):s(c._rows[t][n],i))}),a()},e.prototype.getIndex=function(e,t,r){t(this._index[e].slice())},e.prototype.getNumberOfRecords=function(e,t,r){t(this._index[e].length)},e}();t.SyncStorage=i},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){this.plugin={name:"WebSQL Adapter",version:2,dependencies:{core:[2]}}}return e.prototype.connect=function(e,t,r){},e.prototype.createAndInitTable=function(e,t,r,n){},e.prototype.disconnectTable=function(e,t,r){},e.prototype.dropTable=function(e,t,r){},e.prototype.disconnect=function(e,t){},e.prototype.write=function(e,t,r,n,i){},e.prototype.read=function(e,t,r,n){},e.prototype.delete=function(e,t,r,n){},e.prototype.readMulti=function(e,t,r,n,i,o,s,a){},e.prototype.readMultiPK=function(e,t,r,n,i,o,s,a){},e.prototype.getIndex=function(e,t,r){},e.prototype.getNumberOfRecords=function(e,t,r){},e}();t.WebSQL=r},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){this.plugin={name:"IndexedDB Adapter",version:2,dependencies:{core:[2]}}}return e.prototype.connect=function(e,t,r){},e.prototype.createAndInitTable=function(e,t,r,n){},e.prototype.disconnectTable=function(e,t,r){},e.prototype.dropTable=function(e,t,r){},e.prototype.disconnect=function(e,t){},e.prototype.write=function(e,t,r,n,i){},e.prototype.read=function(e,t,r,n){},e.prototype.delete=function(e,t,r,n){},e.prototype.readMulti=function(e,t,r,n,i,o,s,a){},e.prototype.readMultiPK=function(e,t,r,n,i,o,s,a){},e.prototype.getIndex=function(e,t,r){},e.prototype.getNumberOfRecords=function(e,t,r){},e}();t.IndexedDB=r},function(e,t,r){var n=this&&this.__assign||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i=r(0),o=function(){function e(e,t,r,o,s){this._db=e,this._AV=s||"",this._query="string"==typeof r?n({},i.buildQuery(t,r),{comments:[],state:"pending",action:r,actionArgs:o,result:[]}):n({},i.buildQuery(t,""),r(e),{state:"pending"})}return e.prototype.where=function(e){return this._query.where=e,this},e.prototype.orderBy=function(e){return this._query.orderBy=e,this},e.prototype.groupBy=function(e){return this._query.groupBy=e,this},e.prototype.having=function(e){return this._query.having=e,this},e.prototype.join=function(e){var t=this,r="Join commands requires table and type arguments!";return Array.isArray(e)?e.forEach(function(e){e.with.table&&e.type||(t._error=r)}):e.with.table&&e.type||(this._error=r),this._query.join=e,this},e.prototype.limit=function(e){return this._query.limit=e,this},e.prototype.comment=function(e){return this._query.comments.push(e),this},e.prototype.extend=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];return this._query.extend.push({scope:e,args:t}),this},e.prototype.union=function(e,t){return this._query.union={queries:e,type:t?"all":"distinct"},this},e.prototype.offset=function(e){return this._query.offset=e,this},e.prototype.emit=function(){return this._query},e.prototype.ttl=function(e,t){if(void 0===e&&(e=60),"upsert"!==this._query.action)throw new Error("nSQL: Can only do ttl on upsert queries!");return this._query.ttl=e,this._query.ttlCols=t||[],this},e.prototype.graph=function(e){return this._query.graph=e,this},e.prototype.from=function(e){return this._query.table=e.table,this._query.tableAS=e.as,this},e.prototype.into=function(e){return this._query.table=e,this},e.prototype.toCSV=function(e){var t=this;return t.exec().then(function(r){return Promise.resolve(t._db.JSONtoCSV(r,e))})},e.prototype.exec=function(){var e=this;return new Promise(function(t,r){var n=[];e.stream(function(e){n.push(e)},function(){t(n)},r)})},e.prototype.stream=function(e,t,r){this._db.triggerQuery(this._query,e,t,r)},e.prototype.cache=function(){var e=this;return new Promise(function(t,r){var n=i.uuid();e.exec().then(function(r){e._db._queryCache[n]=r,t({id:n,total:r.length})}).catch(r)})},e}();t._NanoSQLQueryBuilder=o}])});