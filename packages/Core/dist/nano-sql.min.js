!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(window,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"e",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.e)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.e?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=2)}([function(e,t){Object.defineProperty(t,"e",{value:!0}),t.binarySearch=function(e,n,r,i){var o=r||0,a=i||e.length;if(e[o]>=n)return o;if(e[a]<=n)return a+1;var s=Math.floor((o+a)/2);return n==e[s]?s:a-1==o?a:n>e[s]?t.binarySearch(e,n,s,a):n<e[s]?t.binarySearch(e,n,o,s):a},t.titleCase=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},t.getWeekOfYear=function(e){var t=new Date(e.getFullYear(),0,1);return Math.ceil(((e.getTime()-t.getTime())/864e5+t.getDay()+1)/7)},t.buildQuery=function(e,n,r){return{table:n,parent:e,action:r,state:"pending",result:[],time:Date.now(),queryID:t.uuid(),extend:[],comments:[],tags:[]}},t.adapterFilters=function(e,t){return{write:function(n,r,i,o,a){e.doFilter("adapterWillWrite",{result:{table:n,pk:r,row:i},query:t},function(t){t&&e.adapter.write(t.table,t.pk,t.row,function(t){e.doFilter("adapterDidWrite",{result:t},function(e){o(e)},a)},a)},a)},read:function(n,r,i,o){var a=r;"number"==typeof a&&e.tables[n].pkOffset&&(a+=e.tables[n].pkOffset),e.doFilter("adapterWillRead",{result:void 0,table:n,pk:a,i:0,query:t},function(r){r?i(r):e.adapter.read(n,a,function(r){r?e.doFilter("adapterDidRead",{result:r,table:n,pk:a,i:0,query:t},function(e){i(e)},o):i(void 0)},o)},o)},readMulti:function(r,i,o,a,s,u,c,l){var f=new n(function(n,i,o,a){var s=e.tables[r].pkCol;e.doFilter("adapterDidRead",{result:n,table:r,pk:n[s],i:i,query:t},function(e){u(e,i),o()},l)},l,c),h=o,p=a;"number"==typeof h&&"number"==typeof p&&"range"===i&&e.tables[r].pkOffset&&(h+=e.tables[r].pkOffset,p+=e.tables[r].pkOffset),e.doFilter("adapterWillReadMulti",{result:{table:r,type:i,offsetOrLow:h,limitOrHigh:p,reverse:s},onRow:u,complete:c,error:l,query:t},function(t){t&&e.adapter.readMulti(t.table,t.type,t.offsetOrLow,t.limitOrHigh,t.reverse,function(e){f.newItem(e)},function(){f.finished()},f.onError)},f.onError)}}},t.noop=function(){},t.throwErr=function(e){throw new Error(e)},t.nan=function(e){return isNaN(e)?0:parseFloat(e)},t.u=function(e){return e?JSON.parse(JSON.stringify(e)):e},t.a=function(e,n){if(e===n)return!0;if("object"!=typeof e)return!1;if(!e||!n)return!1;var r=Object.keys(e),i=Array.isArray(e)?e.length===n.length:r.length===Object.keys(n).length;if(!i)return!1;for(var o=r.length;o--&&i;){var a=r[o];i="object"==typeof e[a]?t.a(e[a],n[a]):e[a]===n[a]}return i};var n=function(){function e(e,t,n){this.processItem=e,this.onError=t,this.onComplete=n,this.f=[],this.h=!1,this.v=!1,this.g=0,this.y=!1,this.b=this.b.bind(this)}return e.prototype.b=function(){var e=this;if(!this.y){if(this.v&&!this.f.length)return this.y=!0,void(this.onComplete&&this.onComplete());if(this.f.length){var n=function(){e.g++,e.g%100==0?t.setFast(e.b):e.b()},r=this.f.shift()||[];r[1]?r[1](r[0],n,this.onError?this.onError:t.noop):this.processItem&&this.processItem(r[0],this.g,n,this.onError?this.onError:t.noop)}else this.h=!1}},e.prototype.finished=function(){this.v=!0,this.y||this.h||this.f.length||(this.y=!0,this.onComplete&&this.onComplete())},e.prototype.newItem=function(e,t){this.f.push([e,t]),this.h||(this.h=!0,this.b())},e}();t.w=n,t.chainAsync=function(e,n){return new Promise(function(r,i){if(e&&e.length){var o=[],a=0,s=function(){a<e.length?n(e[a],a,function(e){e&&o.push(e||0),++a%500==0?t.setFast(s):s()},function(e){i(e)}):r(o.length?o:void 0)};s()}else r([])})},t.allAsync=function(e,t){return Promise.all((e||[]).map(function(e,n){return new Promise(function(r,i){t(e,n,r,i)})}))};var r="undefined"==typeof window?"":navigator.userAgent||"";t.isSafari=0!==r.length&&(/^((?!chrome|android).)*safari/i.test(r)||/iPad|iPhone|iPod/.test(r)&&!window.MSStream),t.isMSBrowser=0!==r.length&&(0<r.indexOf("MSIE ")||0<r.indexOf("Trident/")||0<r.indexOf("Edge/")),t.isAndroid=/Android/.test(r),t.random16Bits=function(){if("undefined"==typeof crypto)return Math.round(Math.random()*Math.pow(2,16));if(crypto.getRandomValues){var e=new Uint16Array(1);return crypto.getRandomValues(e),e[0]}return"undefined"!=typeof global&&global.S.randomBytes?global.S.randomBytes(2).reduce(function(e,t){return t*e}):Math.round(Math.random()*Math.pow(2,16))},t.throttle=function(e,t,n){var r=!1;return function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];r||(r=!0,setTimeout(function(){t.apply(e,i),r=!1},n))}},t.timeid=function(e){for(var n=Math.round((new Date).getTime()/(e?1:1e3)).toString();n.length<(e?13:10);)n="0"+n;return n+"-"+(t.random16Bits()+t.random16Bits()).toString(16)},t.intersect=function(e,t){return!(!e||!t)&&!(!e.length||!t.length)&&0<(e||[]).filter(function(e){return-1!==(t||[]).indexOf(e)}).length},t.uuid=function(){var e,n,r="";return[r,r,r,r,r,r,r,r].reduce(function(i,o,a){for(e=t.random16Bits(),n=3===a?4:4===a?(e%16&3|8).toString(16):r,e=e.toString(16);e.length<4;)e="0"+e;return i+(-1<[2,3,4,5].indexOf(a)?"-":r)+(n+e).slice(0,4)},r)},t.hash=function(e){for(var t=5381,n=e.length;n;)t=33*t^e.charCodeAt(--n);return(t>>>0).toString(16)};var i={int:function(e){return e},float:function(e){return e},uuid:t.uuid,timeId:function(){return t.timeid()},timeIdms:function(){return t.timeid(!0)}};t.generateID=function(e,t){return i[e]?i[e](t||1):void 0},t.cleanArgs=function(e,n){for(var r={},i=e.length;i--;){var o=e[i].split(":");1<o.length?r[o[0]]=t.cast(o[1],n[o[0]]||void 0,!0):r[o[0]]=n[o[0]]||void 0}return r},t.isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},t.objSort=function(e,n){return function(r,i){var o=e?t.deepGet(e,r)>t.deepGet(e,i)?-1:1:i<r?-1:1;return n?-1*o:o}},t.cast=function(e,n,r){if("any"===e||"blob"===e)return n;if(-1!==e.indexOf("[]")){var i=e.slice(0,e.lastIndexOf("[]"));return Array.isArray(n)?n.map(function(e){return t.cast(i,e,r)}):[]}var o=typeof n,a={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},s=function(e,i){switch(e){case"safestr":return s("string",i).replace(/[&<>"'`=\/]/gim,function(e){return a[e]});case"int":return"number"!==o||i%1!=0?parseInt(i||0):i;case"number":case"float":return"number"!==o?parseFloat(i||0):i;case"array":return Array.isArray(i)?i:[];case"uuid":case"timeId":case"timeIdms":case"string":return"string"!==o?String(i):i;case"object":case"obj":case"map":return t.isObject(i)?i:{};case"boolean":case"bool":return!0===i||1===i}return r?n:null};if(null==n)return null;var u=s(String(e||"").toLowerCase(),n);return void 0!==u&&-1<["int","float","number"].indexOf(e)&&isNaN(u)?0:u},t.rad2deg=function(e){return 180*e/Math.PI},t.deg2rad=function(e){return e*(Math.PI/180)},t.crowDistance=function(e,n,r,i,o){void 0===o&&(o=6371);var a=t.deg2rad(r-e),s=t.deg2rad(i-n),u=Math.pow(Math.sin(a/2),2)+Math.cos(t.deg2rad(e))*Math.cos(t.deg2rad(r))*Math.pow(Math.sin(s/2),2);return o*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))};var o={};t.resolvePath=function(e){var t=e;if(o[t])return o[t];var n=-1!==e.indexOf("[")?e.split(/\.|\[/gim).map(function(e){return e.replace(/\]/gim,"")}):e.split(".");return o[t]=n,o[t]},t.getFnValue=function(e,n,r){return r.match(/\".*\"|\'.*\'/gim)?r.replace(/\"|\'/gim,""):t.deepGet(r,n)},t.deepFreeze=function(e){return Object.getOwnPropertyNames(e||{}).forEach(function(n){var r=e[n];"object"==typeof r&&null!==r&&(e[n]=t.deepFreeze(r))}),Object.freeze(e)},t.deepSet=function(e,n,r){var i=function(e,t,n){e[t+1]?(n[e[t]]||(isNaN(e[t+1])?n[e[t]]={}:n[e[t]]=[]),i(e,t+1,n[e[t]])):n[e[t]]=r};return i(Array.isArray(e)?e:t.resolvePath(e),0,n),n},t.deepGet=function(e,n){var r=function(e,t,n){return e[t]&&n?r(e,t+1,n[e[t]]):n};return r(Array.isArray(e)?e:t.resolvePath(e),0,n)},t._=function(e){return Object.isFrozen(e)?t.u(e):e};var a=0,s={},u=Array.prototype.slice,c="setMsg",l="undefined"!=typeof window&&window.postMessage&&window.addEventListener,f=function(e){return e[0].apply(null,u.call(e,1))};l&&window.addEventListener("message",function(e){var t,n=e.data;"string"==typeof n&&0===n.indexOf(c)&&(t=s[n])&&(delete s[n],f(t))});t.setFast=l?function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=a++,r=c+n;return s[r]=e,window.postMessage(r,"*"),n}:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];"undefined"!=typeof global?global.setImmediate(function(){f(e)}):setTimeout(function(){f(e)},0)}},function(e,t){var n;Object.defineProperty(t,"e",{value:!0}),t.VERSION=2,(n=t.IWhereType||(t.IWhereType={}))[n.fast=0]="fast",n[n.medium=1]="medium",n[n.slow=2]="slow",n[n.fn=3]="fn",n[n.none=4]="none"},function(e,t,n){e.exports=n(3)},function(e,t,n){var r=this&&this.O||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"e",{value:!0});var i,o=n(4),a=n(0),s=n(1),u=n(5),c=n(7),l=n(8),f=n(9),h=n(10),p=n(11);"undefined"!=typeof global&&(i=global.N);var d=function(){function e(){this.version=s.VERSION,this.planetRadius=6371,this.T=new a.w,this.state={activeAV:"",hasAnyEvents:!1,peers:[],pid:a.uuid(),id:a.uuid(),peerEvents:[],focused:!0,peerMode:!1,connected:!1,ready:!1,MRTimer:void 0,runMR:{},selectedTable:""},this.config={id:"temp",queue:!1},this.tables={},this.k={},this.filters={},this.indexTypes={string:function(e){return"object"==typeof e?JSON.stringify(e):String(e)},geo:function(e){},float:function(e){var t=parseFloat(e);return isNaN(t)?0:t},int:function(e){var t=parseInt(e);return isNaN(t)?0:t},number:function(e){var t=parseFloat(e);return isNaN(t)?0:t}},this.eventFNs={Core:{"*":new o.ReallySmallEvents},"*":{"*":new o.ReallySmallEvents}},this.A=this.A.bind(this),u.attachDefaultFns(this)}return e.prototype.doFilter=function(e,t,n,r){var i=this;this.filters[e]?a.chainAsync(this.filters[e],function(n,o,a){i.filters[e][o](t,function(e){t=e,a()},function(e){r(e)})}).then(function(){n(t.result)}):n(t.result)},e.prototype.getCache=function(e,t){if(!this.k[e])throw new Error('Cache "'+e+'" not found!');return t?this.k[e].slice(t.offset,t.offset+t.limit):this.k[e].slice()},e.prototype.clearCache=function(e){var t=void 0!==this.k[e];return delete this.k[e],t},e.prototype.clearTTL=function(e){var t=this,n=this.state.selectedTable+"."+e;return new Promise(function(e,i){t.triggerQuery(r({},a.buildQuery(t,"_ttl","delete"),{where:["key","=",n]}),a.noop,e,i)})},e.prototype.expires=function(e){var t=this;return new Promise(function(n,i){var o=t.state.selectedTable+"."+e,s=[];t.triggerQuery(r({},a.buildQuery(t,"_ttl","select"),{where:["key","=",o]}),function(e){s.push(e)},function(){s.length?n({time:(s[0].date-Date.now())/1e3,cols:s[0].cols}):n({time:-1,cols:[]})},i)})},e.prototype.A=function(){var e=this;if(!this.config.disableTTL){this.j&&clearTimeout(this.j);var t=0,n=0,i=function(){var o=[];e.triggerQuery(r({},a.buildQuery(e,"_ttl","select"),{limit:20,offset:20*t}),function(e){o.push(e)},function(){o.length?a.chainAsync(o,function(t,i,o){if(t.date<Date.now()){var s=function(){e.triggerQuery(r({},a.buildQuery(e,"_ttl","delete"),{where:["key","=",t.key]}),a.noop,o,a.throwErr)},u=t.key.split("."),c=u[0],l=-1===["float","int","number"].indexOf(e.tables[c].pkType)?u[1]:parseFloat(u[1]);if(t.cols.length){var f={};t.cols.forEach(function(e){f[e]=null}),e.triggerQuery(r({},a.buildQuery(e,c,"upsert"),{actionArgs:f,where:[e.tables[c].pkCol,"=",l]}),a.noop,s,a.throwErr)}else e.triggerQuery(r({},a.buildQuery(e,c,"delete"),{where:[e.tables[c].pkCol,"=",l]}),a.noop,s,a.throwErr)}else n=Math.max(n,t.date),o()}).then(function(){t++,i()}):n&&(e.j=setTimeout(e.A,n-Date.now()))},a.throwErr)};i()}},e.prototype.selectTable=function(e){return e&&(this.state.selectedTable=e),this},e.prototype.getPeers=function(){return JSON.parse(localStorage.getItem("nsql-peers-"+this.state.id)||"[]")},e.prototype.M=function(){return"undefined"==typeof window?"RKS":a.isSafari?"WSQL":"undefined"!=typeof indexedDB?"IDB":"undefined"!=typeof window&&void 0!==window.openDatabase?"WSQL":"LS"},e.prototype.R=function(e){var t=this;return new Promise(function(n,r){var i={};(e.plugins||[]).forEach(function(e){(e.filters||[]).forEach(function(e){i[e.name]||(i[e.name]=[]);for(var t=e.priority;i[e.name][t];)t++;i[e.name][t]=e.call})}),Object.keys(i).forEach(function(e){t.filters[e]=[],i[e].forEach(function(n){n&&t.filters[e].unshift(n)})});var o=function(e,t){return!t||!t.length||(1===t.length?e>=t[0]:e>=t[0]&&e<t[1])},a=!1;(e.plugins||[]).forEach(function(t){if(t.dependencies){var n=t.dependencies||{};Object.keys(t.dependencies).forEach(function(i,u,c){if("core"===i)o(s.VERSION,n[i])||(a=!0,r('Plugin "'+t.name+'" requires a different core version of nano-sql!'));else{var l=(e.plugins||[]).reduce(function(e,t){return t.name===i?t:e});l||(a=!0,r('Plugin "'+t.name+'" requires plugin "'+i+"\" but it isn't installed!")),o(l.version,n[i])||(a=!0,r('Plugin "'+t.name+'" requires a different version of "'+i+'"!'))}})}}),a||n()})},e.prototype.connect=function(e){var t=this;return this.R(e).then(function(){return new Promise(function(n,r){t.doFilter("config",{result:e},n,r)})}).then(function(e){return t.state.id=e.id||"nSQL_DB",t.config=r({plugins:[]},e),"undefined"!=typeof window&&e&&e.peer&&(t.state.peerMode=!0),new Promise(function(e,n){t.doFilter("willConnect",{result:{}},e,n)})}).then(function(){return new Promise(function(e,n){var r=void 0!==t.config.mode?t.config.mode:"TEMP";if("string"==typeof r)switch("PERM"===r&&(r=t.M()),r){case"TEMP":t.adapter=new l.SyncStorage(!1);break;case"LS":t.adapter=new l.SyncStorage(!0);break;case"WSQL":t.adapter=new f.WebSQL(t.config.size);break;case"IDB":t.adapter=new h.IndexedDB(t.config.version);break;case"RKS":case"LVL":t.adapter=new i(t.config.path);break;default:n("Cannot find mode "+r+"!")}else t.adapter=r;t.adapter.plugin&&(t.config.plugins||[]).push(t.adapter.plugin),t.R(t.config).then(function(){(t.adapter.nSQL=t).adapter.connect(t.state.id,e,n)}).catch(n),t.config.planetRadius&&(t.planetRadius=t.config.planetRadius)})}).then(function(){t.triggerEvent({target:"Core",targetId:t.state.id,path:"*",events:["connect"],time:Date.now()}),t.state.connected=!0,t.triggerMapReduce=t.triggerMapReduce.bind(t);var e=["_util","_ttl"].concat((t.config.tables||[]).map(function(e){return e.name}));return a.allAsync(e,function(e,n,i,o){switch(e){case"_util":t.triggerQuery(r({},a.buildQuery(t,"","create table"),{actionArgs:{name:"_util",model:[{key:"key:string",props:["pk()"]},{key:"value:any"}],I:!0}}),a.noop,i,o);break;case"_ttl":t.triggerQuery(r({},a.buildQuery(t,"","create table"),{actionArgs:{name:"_ttl",model:[{key:"key:string",props:["pk()"]},{key:"table:string"},{key:"cols:string[]"},{key:"date:number"}],I:!0}}),a.noop,i,o);break;default:var s=(t.config.tables||[]).filter(function(t){return t.name===e})[0];if(!s)return void o("Table not found!");t.triggerQuery(r({},a.buildQuery(t,"","create table"),{actionArgs:s}),a.noop,i,o)}})}).then(function(){return new Promise(function(e,n){var i;t.triggerQuery(r({},a.buildQuery(t,"_util","select"),{where:["key","=","version"]}),function(e){e&&(i=e.value)},function(){!i||i<2?t.triggerQuery(r({},a.buildQuery(t,"_util","upsert"),{actionArgs:{key:"version",value:s.VERSION}}),a.noop,e,n):e()},n)})}).then(function(){return new Promise(function(e,n){var i;t.config.version?t.triggerQuery(r({},a.buildQuery(t,"_util","select"),{where:["key","=","db-version"]}),function(e){e&&(i=e.value)},function(){var o=function(e,n,i){t.triggerQuery(r({},a.buildQuery(t,"_util","upsert"),{actionArgs:{key:"db-version",value:e}}),a.noop,n,i)};if(i){var s=function(){if(i===t.config.version)o(t.config.version||0,e,n);else{if(!t.config.onVersionUpdate)return void o(t.config.version||0,e,n);t.config.onVersionUpdate(i).then(function(e){o(i=e,function(){a.setFast(s)},n)}).catch(n)}};s()}else o(t.config.version||0,e,n)},n):e()})}).then(function(){return new Promise(function(e,n){t.triggerEvent({target:"Core",path:"*",targetId:t.state.id,events:["ready"],time:Date.now()}),t.state.ready=!0,t.config.disableTTL||t.A(),t.config.peer&&t.D(),e()})})},e.prototype.D=function(){var e=this,n=0;this.state.pid=a.uuid(),this.state.peers=this.getPeers(),this.state.peers.unshift(this.state.pid),localStorage.setItem("nsql-peers-"+this.state.id,JSON.stringify(this.state.peers)),window.addEventListener("storage",function(t){if(t.key==="nsql-peers-"+e.state.id&&(e.state.peers=e.getPeers()),t.key&&0===t.key.indexOf(e.state.pid+".")){localStorage.removeItem(t.key);var i=JSON.parse(t.newValue||"{}");e.state.peerEvents.push(i.query.queryID||""),e.triggerEvent(r({},i,{types:["peer change"]})),a.setFast(function(){e.triggerEvent(i)})}if(50<++n&&e.state.peers[0]===e.state.pid){n=0;for(var o=localStorage.length,s={};o--;){var u=localStorage.key(o),c=u?u.match(/\w{8}-\w{4}-\w{4}-\w{4}-\w{8}/gim):null;if(u&&c){var l=(c||[""])[0];s[l]||(s[l]=[]),s[l].push(u)}}Object.keys(s).forEach(function(t){10<s[t].length&&(e.state.peers=e.state.peers.filter(function(e){return e!==t}),s[t].forEach(function(e){localStorage.removeItem(e)}),localStorage.setItem("nsql-peers-"+e.state.id,JSON.stringify(e.state.peers)))})}}),window.onblur=function(){e.state.focused=!1},window.onfocus=function(){e.state.peers=e.state.peers.filter(function(t){return t!==e.state.pid}),e.state.peers.unshift(e.state.pid),localStorage.setItem("nsql-peers-"+e.state.id,JSON.stringify(e.state.peers)),e.state.focused=!0},t.nSQL("*").on("change",function(t){var n=e.state.peerEvents.indexOf(t.query.queryID||"");-1===n?e.state.peers.filter(function(t){return t!==e.state.pid}).forEach(function(e){localStorage.setItem(e+"."+t.query.queryID,JSON.stringify(t))}):e.state.peerEvents.splice(n,1)}),window.addEventListener("beforeunload",function(){return e.state.peers=e.state.peers.filter(function(t){return t!==e.state.pid}),localStorage.setItem("nsql-peers-"+e.state.id,JSON.stringify(e.state.peers)),!1})},e.prototype.every=function(e){for(var t=0,n=[];t<=e.length;)e.every?t%e.every==0&&n.push(t+(e.offset||0)):n.push(t+(e.offset||0)),t++;return n},e.prototype.triggerMapReduce=function(e,t,n){var i=this;if(t&&n){if(!this.tables[t])return;if(!this.tables[t].mapReduce)return;if(!this.state.runMR[t])return;if(!this.state.runMR[t][n])return;var o={target:"Core",path:t+"."+n,events:["map reduce"],time:Date.now()};return e&&e(o),void this.state.runMR[t][n](o)}Object.keys(this.tables).forEach(function(t){if(i.tables[t].mapReduce){if(!i.state.runMR[t])return;(i.tables[t].mapReduce||[]).forEach(function(n){if(i.state.runMR[t][n.name]&&n.onTimes){var o=!0,s=-1,u=[],c={};["seconds","minutes","hours","weekDay","weekOfYear","date","month"].forEach(function(e,t){n.onTimes[e]?-1===s&&(s=1,u.forEach(function(e){switch(e){case"seconds":case"minutes":case"hours":c[e]=[0];break;case"weekDay":n.onTimes.weekOfYear&&(c[e]=[0]);break;case"weekOfYear":break;case"date":c[e]=[1]}})):u.push(e)});var l=new Date;if(Object.keys(r({},n.onTimes,c)).forEach(function(e){var t=Array.isArray(n.onTimes[e])?n.onTimes[e]:[n.onTimes[e]];if(t.length)switch(e){case"weekDay":-1===t.indexOf(l.getDay())&&(o=!1);break;case"weekOfYear":-1===t.indexOf(a.getWeekOfYear(l))&&(o=!1);break;default:var r="get"+a.titleCase(e);l[r]&&-1===t.indexOf(l[r]())&&(o=!1)}}),o){var f={target:"Core",path:t+"."+n.name,events:["map reduce"],time:Date.now()};e&&e(f),i.state.runMR[t][n.name](f)}}})}})},e.prototype.on=function(e,t){var n=this,r=this,i="string"!=typeof r.state.selectedTable?"":r.state.selectedTable;switch(e){case"connect":case"ready":case"disconnect":case"peer change":case"slow query":case"map reduce":this.eventFNs.Core["*"].on(e,t);break;case"select":case"change":case"delete":case"upsert":case"*":var s=a.resolvePath(i);this.eventFNs[s[0]]||(this.eventFNs[s[0]]={"*":new o.ReallySmallEvents});var u=s.filter(function(e,t){return 0<t}).join(".")||"*";this.eventFNs[s[0]][u]||(this.eventFNs[s[0]][u]=new o.ReallySmallEvents),this.eventFNs[s[0]][u].on(e,t);break;default:new Promise(function(t,r){n.doFilter("customEvent",{result:{nameSpace:"",path:"*"},selectedTable:i,action:e,on:!0},t,r)}).then(function(i){if(!i.nameSpace)throw new Error('Invalid event "'+e+'"!');n.eventFNs[i.nameSpace]||(n.eventFNs[i.nameSpace]={"*":new o.ReallySmallEvents}),n.eventFNs[i.nameSpace][i.path]||(n.eventFNs[i.nameSpace][i.path]=new o.ReallySmallEvents),n.eventFNs[i.nameSpace][i.path].on(e,t),r.L()})}return r.L()},e.prototype.off=function(e,t){var n=this,r=this,i="string"!=typeof r.state.selectedTable?"":r.state.selectedTable;switch(e){case"connect":case"ready":case"disconnect":case"peer change":case"slow query":case"map reduce":this.eventFNs.Core["*"].off(e,t);break;case"select":case"change":case"delete":case"upsert":var s=a.resolvePath(i);this.eventFNs[s[0]]||(this.eventFNs[s[0]]={"*":new o.ReallySmallEvents});var u=s.filter(function(e,t){return 0<t}).join(".")||"*";this.eventFNs[s[0]][u]||(this.eventFNs[s[0]][u]=new o.ReallySmallEvents),this.eventFNs[s[0]][u].off(e,t);break;default:this.doFilter("customEvent",{result:{nameSpace:"",path:"*"},selectedTable:i,action:e,on:!0},function(i){if(!i.nameSpace)throw new Error('Invalid event "'+e+'"!');n.eventFNs[i.nameSpace]||(n.eventFNs[i.nameSpace]={"*":new o.ReallySmallEvents}),n.eventFNs[i.nameSpace][i.path]||(n.eventFNs[i.nameSpace][i.path]=new o.ReallySmallEvents),n.eventFNs[i.nameSpace][i.path].off(e,t),r.L()},function(){})}return r.L()},e.prototype.L=function(){var e=this;return this.state.hasAnyEvents=Object.keys(this.eventFNs).reduce(function(t,n){return!0===t||0<Object.keys(e.eventFNs[n]).reduce(function(t,r){return Object.keys(e.eventFNs[n][r].eventListeners).length+t},0)||t},!1),this},e.prototype.getView=function(e,t){return this.x("View",this.state.selectedTable,e,t)},e.prototype.doAction=function(e,t){return this.x("Action",this.state.selectedTable,e,t)},e.prototype.x=function(e,t,n,r){var i=this;return"string"!=typeof this.state.selectedTable?Promise.reject("Can't do Action/View with selected table!"):new Promise(function(o,a){i.doFilter(e,{result:{AVType:e,table:t,AVName:n,AVargs:r}},o,a)}).then(function(e){var t="Action"===e.AVType?"actions":"views",n=i.tables[e.table][t].reduce(function(t,n){return n.name===e.AVName?n:t},null);return n?n.call(n.args?a.cleanArgs(n.args,e.AVargs):{},i):new Promise(function(t,n){return n(e.AVType+' "'+e.AVName+'" Not Found!')})})},e.prototype.query=function(e,t){var n=this.state.activeAV;return this.state.activeAV="",new p.C(this,this.state.selectedTable,e,t,n)},e.prototype.triggerQuery=function(e,t,n,r){var i=this;this.state.connected||"string"!=typeof e.table?this.doFilter("query",{result:e},function(e){i.config.queue&&!e.skipQueue?i.T.newItem({query:e,onRow:t,complete:n,error:r},function(e,t,n){new c.q(i,e.query,e.onRow,function(){t(),e.complete()},function(n){t(),e.error(n)})}):new c.q(i,e,function(e){t(e)},n,r)},r):r("nSQL: Can't do a query before the database is connected!")},e.prototype.triggerEvent=function(e,t){var n=this;return this.doFilter("event",{result:e},function(e){n.state.hasAnyEvents&&a.setFast(function(){e.events.forEach(function(r){if(t||Object.keys(n.eventFNs["*"]).forEach(function(t){n.eventFNs["*"][t].trigger(r,e)}),n.eventFNs[e.target])if("_all_"===e.path)Object.keys(n.eventFNs[e.target]).forEach(function(t){n.eventFNs[e.target][t].trigger(r,e)});else{if(!n.eventFNs[e.target][e.path])return;n.eventFNs[e.target][e.path].trigger(r,e)}})})},function(e){console.error("Event suppressed",e)}),this},e.prototype.default=function(e,t){if(e=e||{},!t&&"string"!=typeof this.state.selectedTable)throw new Error("Must select table to generate defualts!");if(t=t||this.state.selectedTable,!this.tables[t])throw new Error('nSQL: Table "'+t+'" not found for generating default object!');var n="",r=function(e,t,i){var o={};if(t=t||{},i&&i.length&&-1!==i.indexOf("[]"))return Array.isArray(t)?t.map(function(t){return r(e,t,i.slice(0,i.lastIndexOf("[]")))}):[];var s=!1;if(e.forEach(function(e){if("*"!==e.key){if(e.model)if(-1!==e.type.indexOf("[]")){var i=void 0!==t?t[e.key]:[];Array.isArray(i)?o[e.key]=i.map(function(t){return r(e.model,t,e.type.slice(0,e.type.lastIndexOf("[]")))}):o[e.key]=[]}else o[e.key]=r(e.model,void 0!==t?t[e.key]:void 0);else{var u=void 0!==t[e.key]?a.cast(e.type,t[e.key]):e.default;void 0!==e.max&&u>e.max&&(n="Data error, column "+e.key+" can't be greater than "+e.max+"!"),void 0!==e.min&&u<e.min&&(n="Data error, column "+e.key+" can't be less than "+e.min+"!"),o[e.key]=u}!e.notNull||null!==o[e.key]&&void 0!==o[e.key]||(n="Data error, "+e.key+" cannot be null!")}else s=!0}),n.length)return new Error(n);if(s&&t){var u=e.map(function(e){return e.key});Object.keys(t).filter(function(e){return-1===u.indexOf(e)}).forEach(function(e){o[e]=t[e]})}return o};return r(this.tables[t].columns,e)},e.prototype.rawDump=function(e,t){var n=this,r=Object.keys(this.tables).filter(function(t){return!e.length||-1!==e.indexOf(t)});return a.chainAsync(r,function(e,r,i,o){n.adapter.readMulti(e,"all",void 0,void 0,!1,function(n){t(e,n)},i,o||a.noop)})},e.prototype.rawImport=function(e,t){var n=this,r=0,i=Object.keys(e).reduce(function(t,n){return t+e[n].length},0),o=Object.keys(this.tables),s=Object.keys(e).filter(function(e){return-1!==o.indexOf(e)});return a.chainAsync(s,function(o,s,u,c){var l=n.tables[o].pkCol;a.chainAsync(e[o],function(e,s,u,c){e[l]||!c?n.adapter.write(o,e[l],e,function(e){u(),r++,t&&t(Math.round(r/i*1e4)/100)},c||a.noop):c("No primary key found, can't import: "+JSON.stringify(e))}).then(u).catch(c)})},e.prototype.disconnect=function(){var e=this;return new Promise(function(t,n){e.doFilter("disconnect",{},function(){e.adapter.disconnect(t,n)},n)})},e.prototype.extend=function(e){for(var t=this,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];return new Promise(function(r,i){t.doFilter("extend",{scope:e,args:n,result:null},r,i)})},e.prototype.loadJS=function(e,t){var n=this,i=this.state.selectedTable;if("string"!=typeof i)return Promise.reject("nSQL: Can't load JS into temporary table!");var o=e.length,s=0;return a.chainAsync(e,function(e,u,c,l){n.triggerQuery(r({},a.buildQuery(n,i,"upsert"),{actionArgs:e}),function(e){},function(){s++,t&&t(s/o*1e4/100),c()},l)})},e.prototype.JSONtoCSV=function(e,t,n){var r=[];if(!e.length)return"";var i=[];return i=n||(e.forEach(function(e){i=Object.keys(e).concat(i)}),i.filter(function(e,t,n){return n.indexOf(e)===t})),t&&r.push(i.map(function(e){return'"'+e+'"'}).join(",")),e.forEach(function(e){r.push(i.map(function(t){return null===e[t]||void 0===e[t]?"":"string"==typeof e[t]?'"'+e[t].replace(/\"/g,'""')+'"':"boolean"==typeof e[t]?!0===e[t]?"true":"false":"object"==typeof e[t]?'"'+JSON.stringify(e[t]).replace(/\"/g,'""')+'"':e[t]}).join(","))}),r.join("\n")},e.prototype.csvToArray=function(e){for(var t,n="",r=[""],i=[r],o=0,a=0,s=!0,u=0,c=e;u<c.length;u++)'"'===(t=c[u])?(s&&t===n&&(r[o]+=t),s=!s):","===t&&s?t=r[++o]="":"\n"===t&&s?("\r"===n&&(r[o]=r[o].slice(0,-1)),r=i[++a]=[t=""],o=0):r[o]+=t,n=t;return i[0]},e.prototype.CSVtoJSON=function(e,t){var n=this,r=[];return e.split(/\r?\n|\r|\t/gm).map(function(e,i){if(0!==i){var o=n.csvToArray(e);if(o){o=o.map(function(e){return e.trim()});for(var a=r.length,s={};a--;)if(o[a])if("true"===o[a]||"false"===o[a])s[r[a]]="true"===o[a];else if(0===o[a].indexOf("{")||0===o[a].indexOf("["))try{s[r[a]]=JSON.parse(o[a])}catch(e){s[r[a]]=o[a]}else 0===o[a].indexOf('"')?s[r[a]]=o[a].slice(1,o[a].length-1).replace(/\"\"/gim,'"'):s[r[a]]=o[a];return t?t(s):s}}else r=e.split(",").map(function(e){return e.substring(1,e.length-1)})}).filter(function(e){return e})},e.prototype.loadCSV=function(e,t,n){var i=this,o=this.state.selectedTable;if("string"!=typeof o)return Promise.reject("nSQL: Can't load CSV into temporary table!");var s=this.CSVtoJSON(e,t);return a.chainAsync(s,function(e,t,u,c){n&&n(Math.round((t+1)/s.length*1e4)/100),i.triggerQuery(r({},a.buildQuery(i,o,"upsert"),{actionArgs:e}),a.noop,u,c||a.noop)})},e}(),y=new(t.nanoSQL=d);t.nSQL=function(e){return y.selectTable(e)},"undefined"!=typeof window&&(window["nano-sql"]={nSQL:t.nSQL,NanoSQL:d})},function(e,t){e.exports=require("really-small-events")},function(e,t,n){Object.defineProperty(t,"e",{value:!0});var r=n(0),i=n(6),o={};t.attachDefaultFns=function(e){e.functions={COUNT:{type:"A",aggregateStart:{result:0,row:{}},call:function(e,t,n,i){return i&&"*"!==i?r.getFnValue(e,t,i)&&n.result++:n.result++,n.row=t,n}},MAX:{type:"A",aggregateStart:{result:void 0,row:{}},call:function(e,t,n,i){var o=r.getFnValue(e,t,i)||0;return void 0===n.result?(n.result=o,n.row=t):o>n.result&&(n.result=o,n.row=t),n}},MIN:{type:"A",aggregateStart:{result:void 0,row:{}},call:function(e,t,n,i){var o=r.getFnValue(e,t,i)||0;return void 0===n.result?(n.result=o,n.row=t):o<n.result&&(n.result=o,n.row=t),n}},GREATEST:{type:"S",call:function(e,t,n){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return{result:i.map(function(n){return isNaN(n)?r.getFnValue(e,t,n):parseFloat(n)}).sort(function(e,t){return e<t?1:-1})[0]}}},LEAST:{type:"S",call:function(e,t,n){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return{result:i.map(function(n){return isNaN(n)?r.getFnValue(e,t,n):parseFloat(n)}).sort(function(e,t){return t<e?1:-1})[0]}}},AVG:{type:"A",aggregateStart:{result:0,row:{},total:0,records:0},call:function(e,t,n,i){var o=parseFloat(r.getFnValue(e,t,i)||0)||0;return n.total+=isNaN(o)?0:o,n.records++,n.result=n.total/n.records,n.row=t,n}},SUM:{type:"A",aggregateStart:{result:0,row:{}},call:function(e,t,n,i){var o=parseFloat(r.getFnValue(e,t,i)||0)||0;return n.result+=isNaN(o)?0:o,n.row=t,n}},LOWER:{type:"S",call:function(e,t,n,i){return{result:String(r.getFnValue(e,t,i)).toLowerCase()}}},UPPER:{type:"S",call:function(e,t,n,i){return{result:String(r.getFnValue(e,t,i)).toUpperCase()}}},CAST:{type:"S",call:function(e,t,n,i,o){return{result:r.cast(o,r.deepGet(i,t))}}},CONCAT:{type:"S",call:function(e,t,n){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return{result:i.map(function(n){return r.getFnValue(e,t,n)}).join("")}}},LEVENSHTEIN:{type:"S",call:function(e,t,n,a,s){var u=r.getFnValue(e,t,a),c=r.getFnValue(e,t,s),l=u+"::"+c;return o[l]||(o[l]=i(u,c)),{result:o[l]}}},CROW:{type:"S",call:function(t,n,i,o,a,s){var u=r.getFnValue(t,n,o+".lat"),c=r.getFnValue(t,n,o+".lon");return{result:r.crowDistance(u,c,parseFloat(a),parseFloat(s),e.planetRadius)}},checkIndex:function(t,n,i){if("<"===i[1]||"<="===i[1]){var o="string"==typeof t.table?e.tables[t.table].indexes:{},a=r.resolvePath(n[0]),s=[];if(Object.keys(o).forEach(function(e){var t=o[e];"float"===t.type&&r.a(t.path.slice(0,t.path.length-1),a)&&s.push(e.replace(".lat","").replace(".lon",""))}),2===s.length)return{index:s[0],fnName:"CROW",fnArgs:n,comp:i[1],value:i[2]}}return!1},queryIndex:function(t,n,i,o,a,s){var u="_idx_"+t.table+"_"+n.index+".lat",c="_idx_"+t.table+"_"+n.index+".lon",l=n.comp,f=parseFloat(n.value||"0"),h=parseFloat(n.fnArgs?n.fnArgs[1]:"0"),p=parseFloat(n.fnArgs?n.fnArgs[2]:"0"),d=f/(2*e.planetRadius*Math.PI)*360,y=[-1,1].map(function(e){return h+d*e}),g=[],v=[],b=!1,m=Math.max(90-d,0);if(Math.abs(y[0])>m||Math.abs(y[1])>m)b=!0,y[0]<-1*m&&(y=[-90,y[1]]),y[1]>m&&(y=[y[0],90]);else{var S=Math.max(Math.abs(y[0]),Math.abs(y[1]));if(g=[-1,1].map(function(e){return p+d*e/Math.cos(r.deg2rad(S))}),180<Math.abs(g[0])){var w=Math.abs(g[0])-180;v=[180-w,180]}180<Math.abs(g[1])&&(w=Math.abs(g[1])-180,v=[-180,-180+w])}var q={};r.allAsync([u,c,c],function(n,i,o,a){var s=[y,g,v][i];s.length?r.adapterFilters(e,t).readMulti(n,"range",s[0],s[1],!1,function(e,t){for(var n=e.pks.length;n--;){var r=e.pks[n];q[r]?q[r].num++:q[r]={key:r,lat:0,lon:0,num:0},0===i?q[r].lat=e.id-90:q[r].lon=e.id-180}},function(){o(null)},a):o(null)}).then(function(){var u=0,c=Object.keys(q).filter(function(t){if(b)return!0;if(0===q[t].num)return!1;var n=r.crowDistance(q[t].lat,q[t].lon,h,p,e.planetRadius);return"<"===l?n<f:n<=f}).map(function(e){return q[e]});r.allAsync(c,function(a,c,d,y){if(!b&&i)return o(a.key,c),void d(null);r.adapterFilters(t.parent,t).read(t.table,a.key,function(a){if(a){if(b){var s=r.deepGet((n.fnArgs?n.fnArgs[0]:"")+".lat",a),y=r.deepGet((n.fnArgs?n.fnArgs[0]:"")+".lon",a),g=r.crowDistance(s,y,h,p,e.planetRadius);("<"===l?g<f:g<=f)&&(o(i?a[e.tables[t.table].pkCol]:a,u),u++)}else o(a,c);d(null)}else d(null)},s)}).catch(s).then(function(){a()})}).catch(s)}}},Object.getOwnPropertyNames(Math).forEach(function(t){e.functions[t.toUpperCase()]={type:"S",call:function(e,n,i){for(var o=[],a=3;a<arguments.length;a++)o[a-3]=arguments[a];var s=o.map(function(e){return parseFloat(isNaN(e)?r.deepGet(e,n):e)});return{result:Math[t].apply(null,s)}}}})}},function(e,t){e.exports=require("levenshtein-edit-distance")},function(e,t,n){var r=this&&this.O||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"e",{value:!0});var i=n(1),o=n(0);t.secondaryIndexQueue={};var a={},s=function(){function e(){}return e.prototype.init=function(e,t,n){return function(r){e.doFilter("mapReduce",{result:!0,table:t,mr:n},function(t){t&&(e.triggerEvent(r,!0),n.call(r))},function(e){console.log("Map reduce aborted",e)})}},e}(),u=function(){function e(e,t,n,r,i){var o=this;this.nSQL=e,this.query=t,this.progress=n,this.complete=r,this.error=i,this.P=[],this.F=!0,this.W=[],this.J=!1,this.U=!1,this.B=[],this.Q={},this.query.state="processing",this.H=[],this.V=Date.now();var a=t.action.toLowerCase().trim();if(this.Y=this.Y.bind(this),this.X=this.X.bind(this),"select"!==a&&"string"!=typeof t.table)return this.query.state="error",void this.error('Only "select" queries are available for this resource!');if("string"==typeof t.table&&!this.nSQL.state.connected)return this.query.state="error",void this.error("Can't execute query before the database has connected!");var s=function(e,t){return"string"!=typeof o.query.table?(o.query.state="error",void o.error(o.query.action+" query requires a string table argument!")):e&&!o.query.actionArgs?(o.query.state="error",void o.error(o.query.action+" query requires an additional argument!")):void t()},u=function(){"error"!==o.query.state&&(o.query.state="complete",o.complete())};switch(this.query.cacheID||(this.query.cacheID=this.query.queryID),a){case"select":this.K(u,this.error);break;case"upsert":this.G(this.progress,this.complete,this.error);break;case"delete":this.z(this.progress,this.complete,this.error);break;case"show tables":this.Z();break;case"describe":this.$();break;case"drop":case"drop table":this.tt(this.query.table,u,this.error);break;case"create table":case"create table if not exists":s(!0,function(){o.nt(o.query.actionArgs,u,o.error)});break;case"alter table":s(!0,function(){o.it(o.query.actionArgs,u,o.error)});break;case"rebuild indexes":s(!1,function(){o.et(o.progress,u,o.error)});break;case"conform rows":s(!1,function(){o.rt(o.progress,u,o.error)});break;default:this.nSQL.doFilter("customQuery",{result:void 0,query:this,onRow:n,complete:r,error:i},function(){o.query.state="error",o.error('Query type "'+t.action+'" not supported!')},function(e){o.query.state="error",o.error(e)})}}return e.prototype.rt=function(e,t,n){var r=this,i=this.query.table;if(this.nSQL.tables[i]){var a=new o.w(function(t,a,s,u){var c=r.nSQL.default(t,i);r.nSQL.doFilter("conformRow",{result:c,oldRow:t},function(n){r.ot(r.query.table,t,n,function(){var u={target:i,path:"*",events:["upsert","change","*"],time:Date.now(),performance:Date.now()-r.V,result:n,oldRow:t,query:r.query,indexes:r.H};r.nSQL.state.hasAnyEvents&&(r.nSQL.triggerEvent(u),Object.keys(r.nSQL.eventFNs[r.query.table]).forEach(function(e){"*"!==e&&(o.a(o.deepGet(e,t),o.deepGet(e,n))||r.nSQL.triggerEvent({target:r.query.table,path:e,events:["upsert","change","*"],time:Date.now(),performance:Date.now()-r.V,result:n,oldRow:t,query:r.query,indexes:r.H},!0))})),e(r.query.returnEvent?u:n,a),s()},u)},n)},n,function(){t()});this.ut(function(e,t){a.newItem(e)},function(){a.finished()})}else n(new Error("Table "+i+" not found for conforming!"))},e.prototype.st=function(e,t,n,r){var i=this,o=this.query.cacheID;if("function"==typeof n){if(a[o]||(a[o]={}),!a[o][e])return a[o][e]={loading:!0,rows:[],cache:!0},void n(t).then(function(t){var n=t.cache&&!t.filtered||!1;a[o][e]={loading:!1,rows:n?t.rows:[],cache:n},r(t)}).catch(this.X);if(a[o][e].loading)return void setTimeout(function(){i.st(e,t,n,r)},10);if(a[o][e].cache)return void r({filtered:!1,rows:a[o][e].rows,cache:!0});n(t).then(function(e){r(e)}).catch(this.X)}else r({rows:n,filtered:!1,cache:!1})},e.prototype.at=function(e,t,n,i){var a,s=this;if(!e[0])return n(t),void i();var u=function(t,i,a){var c=e[i],l=0,f=[];if("cross"!==c.type&&!c.on)return s.query.state="error",void s.error(new Error("Non 'cross' joins require an 'on' parameter!"));var h=new Error("Must use 'AS' when joining temporary tables!");if("string"!=typeof c.with.table&&!c.with.as)return s.query.state="error",void s.error(h);if("string"!=typeof s.query.table&&!s.query.tableAS)return s.query.state="error",void s.error(h);var p=new o.w(function(t,r,o,a){e[i+1]?u(t,i+1,o):(n(t),o())},s.error,a),d="string"==typeof c.with.table?s.nSQL.tables[c.with.table].pkCol:"",y=String(c.with.as||c.with.table),g=String(s.query.tableAS||s.query.table),v=s.query.tableAS||s.query.table,b=c.on&&"cross"!==c.type?s.ct(c.on,c.with.as||c.with.table,v,t):[];s.st(v,b,c.with.table,function(e){var n=function(e){var n;l++,"right"!==c.type&&"outer"!==c.type||f.push(d?e[d]:o.hash(JSON.stringify(e))),p.newItem(r({},t,((n={})[y]=e,n)))},i=function(){var e,n;switch(c.type){case"left":0===l&&p.newItem(r({},t,((e={})[y]=void 0,e))),p.finished();break;case"inner":case"cross":p.finished();break;case"outer":case"right":0===l&&"outer"===c.type&&p.newItem(r({},t,((n={})[y]=void 0,n))),s.nSQL.triggerQuery(r({},o.buildQuery(s.nSQL,c.with.table,"select"),{skipQueue:!0,cacheID:s.query.cacheID,where:d?[d,"NOT IN",f]:void 0}),function(e){var n;(d||-1===f.indexOf(o.hash(JSON.stringify(e))))&&p.newItem(r({},t,((n={})[g]=void 0,n[y]=e,n)))},function(){p.finished()},function(e){s.query.state="error",s.error(e)})}};e.filtered?(e.rows.forEach(n),i()):s.nSQL.triggerQuery(r({},o.buildQuery(s.nSQL,e.rows,"select"),{tableAS:c.with.as,cacheID:s.query.cacheID,where:c.on&&"cross"!==c.type?s.ct(c.on,c.with.as||c.with.table,v,t):void 0,skipQueue:!0}),n,i,function(e){s.query.state="error",s.error(e)})})};u(((a={})[String(this.query.tableAS||this.query.table)]=t,a),0,i)},e.prototype.K=function(e,t){var n=this;if(this.ft=this.query.where?this.ht(this.query.where,"string"!=typeof this.query.table||void 0!==this.query.union):{type:i.IWhereType.none},this.lt=this.query.having?this.ht(this.query.having,!0):{type:i.IWhereType.none},this.vt(),"error"!==this.query.state){var r=[this.query.offset||0,(this.query.offset||0)+(this.query.limit||0)],s=0<r[0]+r[1];if(this.query.union){var u=[],c=[],l=0;o.chainAsync(this.query.union.queries,function(e,t,i){e().then(function(e){c.length||(c=Object.keys(e[0])),n.query.where&&(e=e.filter(function(e,t){return n.dt(e,n.ft.slowWhere)})),e=e.map(function(e){if(n.query.union&&"distinct"===n.query.union.type){var r=o.hash(JSON.stringify(e));if(0===t)u.push(r);else{if(-1!==u.indexOf(r))return;u.push(r)}}return Object.keys(e).reduce(function(t,n,r){return r<c.length&&(t[c[r]]=e[n]),t},{})}).filter(function(e){return e}),n.query.orderBy?n.P=n.P.concat(e.map(function(e){var t=n.pt(e);return!n.query.having||n.dt(t,n.lt.slowWhere)?t:void 0}).filter(function(e){return e})):e.forEach(function(e,t){var i=n.pt(e);(!n.query.having||n.dt(i,n.lt.slowWhere))&&(s?r[0]<=l&&l<r[1]&&n.progress(n.pt(e),l):n.progress(n.pt(e),l),l++)}),i()})}).then(function(){if(n.query.orderBy){var t=n.P.sort(n.Y);(s?t.slice(r[0],r[1]):t).forEach(n.progress)}n.query.cacheID&&n.query.cacheID===n.query.queryID&&delete a[n.query.cacheID],e()})}else{var f=Array.isArray(this.query.join)?this.query.join:[this.query.join],h=0,p=new o.w(function(e,t,r,i){n.query.graph?n.gt(n.query.graph||[],n.query.tableAS||n.query.table,e,d,function(t,i){var o=n.pt(t);n.query.having?n.dt(n.pt(e),n.lt.slowWhere)&&n.progress(o,h):n.progress(o,h),h++,r()}):(n.progress(n.pt(e),h),h++,r())},this.X,function(){n.query.cacheID&&n.query.cacheID===n.query.queryID&&delete a[n.query.cacheID],e()}),d=0,y=new o.w(function(e,t,i,o){n.at(f,e,function(e){n.F?((!s||r[0]<=d&&d<r[1])&&p.newItem(e),d++):n.P.push(e)},i)},this.error,function(){n.F?p.finished():o.allAsync(n.P,function(e,t,r){n.gt(n.query.graph||[],n.query.tableAS||n.query.table,e,t,r)}).then(function(t){n.P=t,n.yt(),n.query.having&&(n.P=n.P.filter(function(e){return n.dt(e,n.lt.slowWhere)})),n.query.orderBy&&!n.bt&&n.P.sort(n.Y),s&&(n.P=n.P.slice(r[0],r[1])),n.P.forEach(function(e,t){n.progress(e,t)}),n.query.cacheID&&n.query.cacheID===n.query.queryID&&delete a[n.query.cacheID],e()})}),g="string"==typeof this.query.table;this.ut(function(e,t){var r={target:n.query.table,path:"_all_",events:["select","*"],time:Date.now(),performance:Date.now()-n.V,result:e,query:n.query,indexes:n.H};g&&n.nSQL.triggerEvent(r),n.query.returnEvent?n.progress(r,t):y.newItem(e)},function(){n.query.returnEvent?e():y.finished()})}}},e.prototype.yt=function(){var e=this;this.query.groupBy||this.wt?(this.P.sort(function(t,n){return e.mt(t,n,e.St)}).forEach(function(t,n){var r=e.St.sort.map(function(n){var r;return n.fn?(r=e.nSQL.functions[n.fn]).call.apply(r,[e.query,t,{result:void 0}].concat(n.path)):String(o.deepGet(n.path,t))}).join(".");void 0===e.Q[r]&&(e.Q[r]=e.B.length);var i=e.Q[r];e.B[i]||e.B.push([]),e.B[i].push(t)}),this.query.orderBy&&(this.bt=!0,this.B=this.B.map(function(t){return t.sort(function(t,n){return e.mt(t,n,e.Et)})})),this.P=[],this.wt?this.B.forEach(function(t){var n=e.W.reduce(function(t,n,r){return e.nSQL.functions[n.value]&&"A"===e.nSQL.functions[n.value].type&&(t[r]={idx:r,name:n.value,aggr:o.u(e.nSQL.functions[n.value].aggregateStart),args:n.args}),t},[]),r=n.filter(function(e){return e})[0];t.forEach(function(t,r){n.forEach(function(r,i){var o;r&&(n[i].aggr=(o=e.nSQL.functions[r.name]).call.apply(o,[e.query,t,n[i].aggr].concat(n[i].args)))})}),e.P.push(e.W.reduce(function(t,i,a){var s,u=i.isFn?i.value+"("+(i.args||[]).join(", ")+")":i.value;return t[i.as||u]=i.isFn&&n[a]?n[a].aggr.result:i.isFn?(s=e.nSQL.functions[i.value]).call.apply(s,[e.query,n[r.idx].aggr.row,{}].concat(i.args||[])):o.deepGet(i.value,n[r.idx].aggr.row),t},{}))}):this.B.forEach(function(t){e.P.push(e.pt(t.pop()))})):this.P=this.P.map(function(t){return e.pt(t)})},e.prototype.ct=function(e,t,n,r){var i=this;return"function"==typeof e?function(t){return e(t,r)}:("string"==typeof e[0]?[e]:e).map(function(e){if(Array.isArray(e[0]))return i.ct(e,t,n,r);if("AND"===e||"OR"===e)return e;var a=o.resolvePath(e[0]),s=o.resolvePath(e[2]),u=a[0]===n;return[u?s.slice(1).join("."):a.slice(1).join("."),u?-1!==e[1].indexOf(">")?e[1].replace(">","<"):e[1].replace("<",">"):e[1],o.deepGet(u?a:s,r)]})},e.prototype.gt=function(e,t,n,i,a){var s=this,u=Array.isArray(e)?e:[e];u&&0!==u.length?o.allAsync(u,function(e,i,a){var u,c=new Error("Must use 'AS' when graphing temporary tables!");if("string"!=typeof e.with.table&&!e.with.as)return s.query.state="error",void s.error(c);if("string"!=typeof s.query.table&&!s.query.tableAS)return s.query.state="error",void s.error(c);n[e.key]=[];var l=s.ct(e.on,e.with.as||e.with.table,t,((u={})[t]=n,u));s.st(e.with.as||e.with.table,l,e.with.table,function(t){t.filtered?(t.rows.forEach(function(t){e.single?n[e.key]=t:n[e.key].push(t)}),a(null)):s.nSQL.triggerQuery(r({},o.buildQuery(s.nSQL,t.rows,"select"),{tableAS:e.with.as,actionArgs:e.select,where:l,limit:e.limit,offset:e.offset,orderBy:e.orderBy,groupBy:e.groupBy,graph:e.graph,skipQueue:!0,cacheID:s.query.cacheID}),function(t){e.single?n[e.key]=t:n[e.key].push(t)},function(){a(null)},s.X)})}).then(function(){a(n,i)}):a(n,i)},e.prototype.G=function(e,t,n){var r=this;if(this.query.actionArgs||(n("Can't upsert without records!"),this.query.state="error"),-1!==this.query.table.indexOf(".")||-1!==this.query.table.indexOf("[")){var a=o.resolvePath(this.query.table);this.query.table=a.shift(),this.upsertPath=a}if(this.ft=this.query.where?this.ht(this.query.where):{type:i.IWhereType.none},"error"!==this.query.state){var s=Array.isArray(this.query.actionArgs)?this.query.actionArgs:[this.query.actionArgs],u=this.nSQL.tables[this.query.table];if(this.ft.type===i.IWhereType.none)o.allAsync(s,function(e,t,n,i){e[u.pkCol]?o.adapterFilters(r.nSQL,r.query).read(r.query.table,e[u.pkCol],function(t){t?r._t(e,t,n,i):r.Ot(e,n,i)},i):r.Ot(e,n,i)}).then(function(){e({result:s.length+" row(s) upserted"},0),t()});else{if(1<s.length)return this.query.state="error",void n("Cannot upsert multiple records with where condition!");var c=0,l=new o.w(function(e,t,n,i){c++,r._t(s[0],e,n,i)},n,function(){e({result:c+" row(s) upserted"},0),t()});this.ut(function(e,t){l.newItem(e)},function(){l.finished()})}}},e.prototype._t=function(e,t,n,i){var a=this;this.nSQL.doFilter("updateRow",{result:e,row:t,query:this.query},function(e){var s=a.nSQL.default(a.upsertPath?o.deepSet(a.upsertPath,o._(t),e):r({},t,e),a.query.table);a.ot(a.query.table,t,s,function(){var e={target:a.query.table,path:"*",events:["upsert","change","*"],time:Date.now(),performance:Date.now()-a.V,result:s,oldRow:t,query:a.query,indexes:a.H};"string"==typeof a.query.table&&(a.nSQL.triggerEvent(e),a.nSQL.eventFNs[a.query.table]&&Object.keys(a.nSQL.eventFNs[a.query.table]).forEach(function(e){"*"!==e&&(o.a(o.deepGet(e,t),o.deepGet(e,s))||a.nSQL.triggerEvent({target:a.query.table,path:e,events:["upsert","change","*"],time:Date.now(),performance:Date.now()-a.V,result:s,oldRow:t,query:a.query,indexes:a.H},!0))})),n(a.query.returnEvent?e:s)},i)},i)},e.prototype.ot=function(e,t,n,r,i){var a=this,s=this.Nt(this.nSQL.tables[this.query.table].indexes,n),u=this.Nt(this.nSQL.tables[this.query.table].indexes,t),c=this.nSQL.tables[e];o.allAsync(Object.keys(u).concat(["__pk__"]),function(t,r,i,l){if("__pk__"===t)o.adapterFilters(a.nSQL,a.query).write(e,n[c.pkCol],n,function(e){n[c.pkCol]=e,i(null)},l);else{var f="_idx_"+a.query.table+"_"+t;if(!1===o.a(s[t],u[t]))if(c.indexes[t].isArray){var h=s[t].filter(function(e,n,r){return-1===u[t].indexOf(e)}),p=u[t].filter(function(e,n,r){return-1===s[t].indexOf(e)});o.allAsync([h,p],function(e,t,r){e.length?o.allAsync(e,function(e,r,i){a.Tt(f,e,n[c.pkCol],0===t,function(){i(null)},l)}).then(r):r(null)}).then(i)}else o.allAsync(["rm","add"],function(e,r,i){switch(e){case"add":a.Tt(f,s[t],n[c.pkCol],!0,function(){i(null)},l);break;case"rm":a.Tt(f,u[t],n[c.pkCol],!1,function(){i(null)},l)}}).then(i);else i(null)}}).then(r).catch(i)},e.prototype.Tt=function(e,n,r,i,a,s){t.secondaryIndexQueue[this.nSQL.state.id+this.query.table].newItem({indexTable:e,value:n,pk:r,addToIndex:i,done:a,err:s,query:this.query,nSQL:this.nSQL},function(e,t,n){o.adapterFilters(e.nSQL,e.query).read(e.indexTable,e.value,function(r){var i=o._(r||{id:e.value,pks:[]}),a=i.pks.indexOf(e.pk);if(e.addToIndex)-1===a&&i.pks.push(e.pk);else{if(-1===a)return e.done(),void t();i.pks.splice(a,1)}o.adapterFilters(e.nSQL,e.query).write(e.indexTable,e.value,i,function(){e.done(),t()},function(t){e.err(),n&&n(t)})},e.err)})},e.prototype.Ot=function(e,t,n){var r=this;this.nSQL.doFilter("addRow",{result:e,query:this.query},function(e){var i=r.nSQL.tables[r.query.table];e=r.nSQL.default(o._(r.upsertPath?o.deepSet(r.upsertPath,{},e):e),r.query.table);var a=r.Nt(r.nSQL.tables[r.query.table].indexes,e);o.adapterFilters(r.nSQL,r.query).write(r.query.table,e[i.pkCol],e,function(n){e[i.pkCol]=n,o.allAsync(Object.keys(a),function(t,n,s,u){var c="_idx_"+r.query.table+"_"+t;if(i.indexes[t].isArray){var l=a[t]||[];o.allAsync(l,function(t,n,o){r.Tt(c,t,e[i.pkCol],!0,function(){s(null)},u)}).then(s)}else r.Tt(c,a[t],e[i.pkCol],!0,function(){s(null)},u)}).then(function(){t(e)})},n)},n)},e.prototype.z=function(e,t,n){var r=this;if(this.ft=this.query.where?this.ht(this.query.where):{type:i.IWhereType.none},"error"!==this.query.state){var a=0,s=this.nSQL.tables[this.query.table],u=new o.w(function(t,n,i,o){e(void 0,a),a++,r.kt(s,t,i,o)},n,function(){e({result:a+" row(s) deleted"},a),t()});this.ut(function(e,t){u.newItem(e)},function(){u.finished()})}},e.prototype.kt=function(e,t,n,r){var i=this,a=this.Nt(e.indexes,t);this.nSQL.doFilter("deleteRow",{result:t,query:this.query},function(t){o.allAsync(Object.keys(a).concat(["__del__"]),function(n,s,u){if("__del__"===n)i.nSQL.adapter.delete(i.query.table,t[e.pkCol],function(){u(null)},function(e){i.query.state="error",r(e)});else{var c="_idx_"+i.query.table+"_"+n;if(e.indexes[n].isArray){var l=a[n]||[];o.allAsync(l,function(n,o,a){i.Tt(c,n,t[e.pkCol],!1,function(){a(null)},r)}).then(u)}else i.Tt(c,a[n],t[e.pkCol],!1,function(){u(null)},i.X)}}).then(function(){"string"==typeof i.query.table&&i.nSQL.triggerEvent({target:i.query.table,path:"_all_",events:["change","delete","*"],time:Date.now(),performance:Date.now()-i.V,result:t,query:i.query,indexes:i.H}),n()}).catch(r)},r)},e.prototype.Nt=function(e,t){var n=this;return Object.keys(e).reduce(function(r,i){var a="_idx_"+n.query.table+"_"+i,s=n.nSQL.tables[a].pkOffset,u=o.deepGet(e[i].path,t),c=e[i].type;return r[i]=e[i].isArray?(Array.isArray(u)?u:[]).map(function(e){return n.nSQL.indexTypes[c](e)}):n.nSQL.indexTypes[c](u),s&&(r[i]+=s),r},{})},e.prototype.Z=function(){this.progress({tables:Object.keys(this.nSQL.tables)},0),this.complete()},e.prototype.$=function(){return"string"!=typeof this.query.table?(this.query.state="error",void this.error("Can't call describe on that!")):this.nSQL.tables[this.query.table]?(this.progress({describe:o.u(this.nSQL.tables[this.query.table].columns)},0),void this.complete()):(this.query.state="error",void this.error("Table "+this.query.table+" not found!"))},e.prototype.At=function(e){return Object.keys(e).reduce(function(t,n){var r=e[n];return r&&Object.keys(r).forEach(function(e){t[n+"."+e]=r[e]}),t},{})},e.prototype.pt=function(e){var t=this;if(this.W.length){var n={};return this.W.forEach(function(r){var i;if(r.isFn){if(!t.nSQL.functions[r.value])return t.query.state="error",void t.error("Function "+r.value+" not found!");n[r.as||r.value]=(i=t.nSQL.functions[r.value]).call.apply(i,[t.query,e,{}].concat(r.args||[])).result}else n[r.as||r.value]=o.deepGet(r.value,e)}),this.query.join?this.At(n):n}return this.query.join?this.At(e):e},e.prototype.Y=function(e,t){return this.mt(e,t,this.Et)},e.prototype.mt=function(e,t,n){var r=this,i="string"==typeof this.query.table&&this.nSQL.tables[this.query.table].pkCol,a=!!i&&e[i],s=!!i&&t[i];return n.sort.reduce(function(n,i){var u,c,l=i.fn?(u=r.nSQL.functions[i.fn]).call.apply(u,[r.query,e,{result:void 0}].concat(i.path)).result:o.deepGet(i.path,e),f=i.fn?(c=r.nSQL.functions[i.fn]).call.apply(c,[r.query,t,{result:void 0}].concat(i.path)).result:o.deepGet(i.path,t);return n||(l===f?a===s?0:s<a?1:-1:(f<l?1:-1)*("DESC"===i.dir?-1:1))},0)},e.prototype.nt=function(e,n,i){var a=this;new Promise(function(t,n){var r=!1,i=e.name;e.I||0!==i.indexOf("_")&&null===i.match(/\s/g)&&null===i.match(/[\(\)\]\[\.]/g)?(Object.keys(e.model).forEach(function(t){var i=t.replace(/\s+/g,"-").split(":");1===i.length&&i.push("any"),i[0]&&null===i[0].match(/[\(\)\]\[\.]/g)&&0!==i[0].indexOf("_")||(r=!0,n("nSQL: Invalid Data Model at "+e.name+"."+t+"! https://docs.nanosql.io/setup/data-models"))}),r||t()):n("nSQL: Invalid Table Name "+e.name+"! https://docs.nanosql.io/setup/data-models")}).then(function(){return new Promise(function(t,n){a.nSQL.doFilter("configTable",{result:e,query:a.query},t,n)})}).then(function(e){var n=function(e){return Object.keys(e).reduce(function(t,i){return 0===(i.split(":")[1]||"any").indexOf("geo")?t[i]={default:{lat:0,lon:0},model:{"lat:float":{max:90,min:-90},"lon:float":{max:180,min:-180}}}:e[i].model?t[i]=r({},e[i],{model:n(e[i].model)}):t[i]=e[i],t},{})},i=function(e){return Object.keys(e).filter(function(e){return"*"!==e}).map(function(t){return{key:t.split(":")[0],type:t.split(":")[1]||"any",ai:e[t].ai,pk:e[t].pk,default:e[t].default,notNull:e[t].notNull,max:e[t].max,min:e[t].min,model:e[t].model?i(e[t].model):void 0}})},s="",u=n(e.model),c={},l=Object.keys(e.model).reduce(function(t,n){return e.model[n]&&e.model[n].pk?n.split(":")[1]:t},""),f=e.indexes||{};if(c[e.name]={model:u,columns:i(u),filter:e.filter,mapReduce:e.mapReduce,actions:e.actions||[],views:e.views||[],indexes:Object.keys(f).map(function(e){return{id:o.resolvePath(e.split(":")[0]).join("."),type:(e.split(":")[1]||"string").replace(/\[\]/gim,""),isArray:-1!==(e.split(":")[1]||"string").indexOf("[]"),path:o.resolvePath(e.split(":")[0]),props:f[e]}}).reduce(function(e,t){return-1===Object.keys(a.nSQL.indexTypes).indexOf(t.type)?s='Index "'+t.id+'" does not have a valid type!':-1!==t.type.indexOf("geo")?(e[t.id+".lon"]={id:t.id+".lon",type:"float",isArray:!1,path:t.path.concat(["lon"]),props:{offset:180}},e[t.id+".lat"]={id:t.id+".lat",type:"float",isArray:!1,path:t.path.concat(["lat"]),props:{offset:90}}):e[t.id]=t,e},{}),pkType:l,pkCol:Object.keys(e.model).reduce(function(t,n){return e.model[n]&&e.model[n].pk?n.split(":")[0]:t},""),pkOffset:0,isPkNum:-1!==["number","int","float"].indexOf(l),ai:Object.keys(e.model).reduce(function(t,n){return!(!e.model[n]||!e.model[n].ai)||t},!1)},a.setMapReduce(e),""===c[e.name].pkCol&&(c[e.name].pkCol="_id",c[e.name].pkType="uuid",c[e.name].model.jt={pk:!0},c[e.name].columns=i(c[e.name].model)),s&&s.length)return Promise.reject(s);var h=[e.name];return Object.keys(c[e.name].indexes).forEach(function(t,n){var r,i=c[e.name].indexes[t],o="_idx_"+e.name+"_"+i.id;h.push(o),c[o]={model:(r={},r["id:"+(i.type||"string")]={pk:!0},r["pks:"+c[e.name].pkType+"[]"]={},r),columns:[{key:"id",type:i.type||"string"},{key:"pks",type:c[e.name].pkType+"[]"}],actions:[],views:[],indexes:{},isPkNum:-1!==["number","int","float"].indexOf(i.type||"string"),pkType:i.type,pkCol:"id",pkOffset:i.props.offset||0,ai:!1}}),t.secondaryIndexQueue[a.nSQL.state.id+e.name]=new o.w,o.allAsync(h,function(e,t,n,r){a.nSQL.doFilter("addTable",{result:{name:e,conf:c[e]},query:a.query},function(e){e?a.nSQL.adapter.createAndInitTable(e.name,e.conf,function(){a.nSQL.tables[e.name]=e.conf,n(null)},r):n(null)},r)})}).then(function(){a.updateMRTimer(),n()}).catch(i)},e.prototype.setMapReduce=function(e,t){var n=this,r=this.query.table;"string"==typeof r&&(this.nSQL.state.runMR[r]||(this.nSQL.state.runMR[r]={}),t&&t.mapReduce&&t.mapReduce.forEach(function(e){e.onEvents&&e.onEvents.forEach(function(t){n.nSQL.off(t,n.nSQL.state.runMR[r][e.name])})}),e&&e.mapReduce&&e.mapReduce.forEach(function(e){n.nSQL.state.runMR[r][e.name]||(e.throttle?n.nSQL.state.runMR[r][e.name]=o.throttle(n,(new s).init(n.nSQL,r,e),e.throttle):n.nSQL.state.runMR[r][e.name]=(new s).init(n.nSQL,r,e)),e.onEvents&&e.onEvents.forEach(function(t){n.nSQL.on(t,n.nSQL.state.runMR[r][e.name])})}))},e.prototype.updateMRTimer=function(){var e=this,t=!1;Object.keys(this.nSQL.tables).forEach(function(n){(e.nSQL.tables[n].mapReduce||[]).forEach(function(e){e.onTimes&&(t=!0)})}),t?this.nSQL.state.MRTimer||(this.nSQL.state.MRTimer=setInterval(this.nSQL.triggerMapReduce,1e3)):(clearInterval(this.nSQL.state.MRTimer),this.nSQL.state.MRTimer=void 0)},e.prototype.it=function(e,t,n){var r=this;this.nSQL.doFilter("alterTable",{result:e,query:this.query},function(i){if(i){var a=[i.name];Object.keys(r.nSQL.tables[e.name].indexes).forEach(function(e){a.push("_idx_"+i.name+"_"+e)}),r.setMapReduce(void 0,r.nSQL.tables[r.query.table]),o.allAsync(a,function(e,t,n,o){r.nSQL.adapter.disconnectTable(i.name,n,o)}).then(function(){r.nt(i,t,n)}).catch(n)}else t()},n)},e.prototype.tt=function(e,t,n){var r=this;this.nSQL.doFilter("dropTable",{result:e,query:this.query},function(e){if(e){var i=[e];i.forEach(function(e){Object.keys(r.nSQL.tables[e].indexes).forEach(function(t){i.push("_idx_"+e+"_"+t)})}),r.setMapReduce(void 0,r.nSQL.tables[r.query.table]),o.allAsync(i,function(e,t,n,i){r.nSQL.adapter.dropTable(e,function(){delete r.nSQL.tables[e],n(e)},i)}).then(function(){t(),r.updateMRTimer()}).catch(n)}else t()},n)},e.prototype.X=function(e){this.query.state="error",this.error(e)},e.prototype.Mt=function(e,t,n,r,i){var a=this;if(t.index&&t.fnName)this.nSQL.functions[t.fnName].queryIndex(this.query,t,e,r,i,this.X);else{var s="_pk_"===t.index,u=this.nSQL.tables[this.query.table].pkCol,c="_idx_"+this.query.table+"_"+t.index,l=0,f=new o.w(function(e,t,n,r){h(e,n)},this.X,i),h=function(t,n){t?s?(r(e?t[u]:t,0),n()):e?((t.pks||[]).forEach(function(e,t){r(e,l),l++}),n()):o.allAsync(t.pks,function(e,t,n){o.adapterFilters(a.nSQL,a.query).read(a.query.table,e,function(e){e&&r(e,l),l++,n(null)},a.error)}).then(n):n()};if(t.indexArray)switch(t.comp){case"INCLUDES":o.adapterFilters(this.nSQL,this.query).read(c,t.value,function(e){h(e,i)},this.error);break;case"INTERSECT ALL":case"INTERSECT":var p={},d=0;o.allAsync(t.value||[],function(e,t,n){o.adapterFilters(a.nSQL,a.query).read(c,e,function(e){d=t+1,e&&(e.pks||[]).forEach(function(e){p[e]=(p[e]||0)+1}),n(null)},a.error)}).then(function(){h({pks:"INTERSECT"===t.comp?Object.keys(p):Object.keys(p).filter(function(e){return p[e]===d})},i)})}else switch(t.comp){case"=":e&&s?(r(t.value,0),i()):o.adapterFilters(this.nSQL,this.query).read(s?this.query.table:c,t.value,function(e){h(e,i)},this.error);break;case"BETWEEN":o.adapterFilters(this.nSQL,this.query).readMulti(s?this.query.table:c,"range",t.value[0],t.value[1],n,function(e,t){f.newItem(e)},function(){f.finished()},this.X);break;case"IN":var y=n?t.value.sort(function(e,t){return e<t?1:-1}):t.value.sort(function(e,t){return t<e?1:-1});e&&s?(y.forEach(function(e,t){return r(e,t)}),i()):o.chainAsync(y,function(e,t,n){o.adapterFilters(a.nSQL,a.query).read(s?a.query.table:c,e,function(e){f.newItem(e),n()},a.error)}).then(function(){f.finished()})}}},e.prototype.Rt=function(e,t){var n=this;if(this.ft.fastWhere)if(1===this.ft.fastWhere.length){var r=this.ft.fastWhere[0],i=this.J&&"DESC"===this.Et.sort[0].dir;this.Mt(!1,r,i,function(t,n){e(t,n)},t)}else{var a={},s=0;o.chainAsync(this.ft.fastWhere,function(e,t,r){t%2!=1?(s=t,n.Mt(!0,e,!1,function(e){a[e]=(a[e]||0)+1},r)):r()}).then(function(){var r=[];Object.keys(a).forEach(function(e){a[e]===s&&r.push(e)}),n.Mt(!1,{index:"_pk_",col:n.nSQL.tables[n.query.table].pkCol,comp:"IN",value:r},!1,e,t)})}},e.prototype.ut=function(e,t){var n=this,r=function(r){for(var o=0;o<r.length;)n.ft.type!==i.IWhereType.none?n.ft.whereFn?n.ft.whereFn(r[o],o)&&e(r[o],o):n.dt(r[o],n.ft.slowWhere)&&e(r[o],o):e(r[o],o),o++;t()};if("string"==typeof this.query.table)switch(this.ft.type){case i.IWhereType.fast:this.Rt(e,t);break;case i.IWhereType.medium:this.Rt(function(t,r){n.dt(t,n.ft.slowWhere)&&e(t,r)},t);break;case i.IWhereType.slow:case i.IWhereType.none:case i.IWhereType.fn:var a=this.J&&"DESC"===this.Et.sort[0].dir;o.adapterFilters(this.nSQL,this.query).readMulti(this.query.table,"all",void 0,void 0,a,function(t,r){n.ft.type===i.IWhereType.slow?n.dt(t,n.ft.slowWhere)&&e(t,r):n.ft.type===i.IWhereType.fn&&n.ft.whereFn?n.ft.whereFn(t,r)&&e(t,r):e(t,r)},function(){t()},this.X)}else"function"==typeof this.query.table?this.st(this.query.tableAS||this.query.table,this.query.where,this.query.table,function(e){r(e.rows)}):Array.isArray(this.query.table)&&r(this.query.table)},e.prototype.et=function(e,n,r){var i=this,a=this.query.table;if(this.nSQL.tables[a]){var s=Object.keys(this.nSQL.tables[a].indexes).map(function(e){return"_idx_"+a+"_"+e});if(this.query.where){var u=0,c=new o.w(function(t,n,r,o){i.kt(i.nSQL.tables[a],t,function(){i.Ot(t,r,o),e(void 0,u),u++},o)},r,function(){n(),e({result:"Rebuilt "+u+" row indexes."},u)});this.ut(function(e){c.newItem(e)},function(){c.finished()})}else o.allAsync(s,function(e,t,n,r){i.nSQL.adapter.dropTable(e,function(){i.nSQL.adapter.createAndInitTable(e,i.nSQL.tables[e],function(){n(null)},r)},r)}).then(function(){var s=0;t.secondaryIndexQueue[i.nSQL.state.id+a].newItem(o.uuid(),function(t,a,u){var c=new o.w(function(t,n,r,o){i.Ot(t,function(t){s++,e(void 0,n),r()},o)},r,function(){e({result:"Rebuilt "+s+" row indexes."},s),n(),a()});i.ut(function(e){c.newItem(e)},function(){c.finished()})})}).catch(r)}else r(new Error("Table "+a+" not found for rebuilding indexes!"))},e.prototype.dt=function(e,t){if(1<t.length){for(var n="AND",r=!0,i=0;i<t.length;){var o=t[i];if(i%2==1)n=o;else{var a;a=Array.isArray(o[0])?this.dt(e,o):this.It(o,e),r=0===i?a:"AND"===n?r&&a:r||a}i++}return r}return this.It(t[0],e)},e.prototype.Dt=function(t,n){if(!e.likeCache[n]){var r="";e.likeCache[n]=new RegExp(n.split("").map(function(e){return"\\"===r?r=e:"%"===(r=e)?".*":"_"===e?".":e}).join(""),"gmi")}return"string"!=typeof t?"number"==typeof t?null!==String(t).match(e.likeCache[n]):null!==JSON.stringify(t).match(e.likeCache[n]):null!==t.match(e.likeCache[n])},e.prototype.Lt=function(e,t){var n;return e.fnName?((n=this.nSQL.functions[e.fnName]).call.apply(n,[this.query,t,this.nSQL.functions[e.fnName].aggregateStart||{result:void 0}].concat(e.fnArgs||[]))||{result:void 0}).result:o.deepGet(e.col,t)},e.prototype.It=function(e,t){var n=this.Lt(e,t),r=e.value,i=e.comp;if("NULL"===r||"NOT NULL"===r){var a=-1!==[void 0,null,""].indexOf(n),s="="===i||"LIKE"===i;switch(r){case"NULL":return s?a:!a;case"NOT NULL":return s?!a:a}}if(-1!==["IN","NOT IN","BETWEEN","INTERSECT","INTERSECT ALL","NOT INTERSECT"].indexOf(i)&&!Array.isArray(r))return this.query.state="error",this.query.error('WHERE "'+i+'" comparison requires an array value!'),!1;switch(i){case"=":return o.a(r,n);case"!=":return!o.a(r,n);case">":return r<n;case"<":return n<r;case"<=":return n<=r;case">=":return r<=n;case"IN":return-1!==r.indexOf(n);case"NOT IN":return-1===r.indexOf(n);case"REGEXP":case"REGEX":return null!==(n||"").match(r);case"LIKE":return this.Dt(n||"",r);case"NOT LIKE":return!this.Dt(n||"",r);case"BETWEEN":return r[0]<=n&&r[1]>=n;case"NOT BETWEEN":return r[0]>=n||r[1]<=n;case"INCLUDES":return-1!==(n||[]).indexOf(r);case"NOT INCLUDES":return-1===(n||[]).indexOf(r);case"INTERSECT":return 0<(n||[]).filter(function(e){return-1<r.indexOf(e)}).length;case"INTERSECT ALL":return(n||[]).filter(function(e){return-1<r.indexOf(e)}).length===r.length;case"NOT INTERSECT":return 0===(n||[]).filter(function(e){return-1<r.indexOf(e)}).length;default:return!1}},e.prototype.xt=function(t,n){var r=this,i=t&&t.length?o.hash(JSON.stringify(t)):"";if(!i)return{sort:[],index:""};if(e.Ct[i])return e.Ct[i];var a=!1,s=t.map(function(e){return e.split(" ").map(function(e){return e.trim()})}).reduce(function(e,t){var n=-1!==t[0].indexOf("(");n&&(a=!0);var i=n?t[0].split("(")[1].replace(")","").split(",").map(function(e){return e.trim()}).filter(function(e){return e}):[],s=n?t[0].split("(")[0].trim().toUpperCase():void 0;return s&&!r.nSQL.functions[s]&&(r.query.state="error",r.error('Function "'+s+'" not found!')),e.push({path:n?i:o.resolvePath(t[0]),fn:s,dir:(t[1]||"asc").toUpperCase()}),e},[]),u="";if(n&&!1===a&&1===s.length){var c="string"==typeof this.query.table?this.nSQL.tables[this.query.table].pkCol:"";if(s[0].path[0].length&&s[0].path[0]===c)u="_pk_";else for(var l=Object.keys(this.nSQL.tables[this.query.table].indexes),f=l.length;f--&&!u;)o.a(this.nSQL.tables[this.query.table].indexes[l[f]],s[0].path)&&(u=this.nSQL.tables[this.query.table].indexes[l[f]].id)}return e.Ct[i]={sort:s,index:u},e.Ct[i]},e.prototype.vt=function(){var t=this,n=this.query.actionArgs&&this.query.actionArgs.length?JSON.stringify(this.query.actionArgs):"";this.Et=this.xt(this.query.orderBy||[],"string"==typeof this.query.table),this.St=this.xt(this.query.groupBy||[],!1),n?e.qt[n]?(this.wt=e.qt[n].hasAggrFn,this.W=e.qt[n].args):((this.query.actionArgs||[]).forEach(function(e){var n=e.split(/\s+as\s+/i).map(function(e){return e.trim()});if(-1!==n[0].indexOf("(")){var r=n[0].split("(")[1].replace(")","").split(",").map(function(e){return e.trim()}),i=n[0].split("(")[0].trim().toUpperCase();t.W.push({isFn:!0,value:i,as:n[1],args:r}),t.nSQL.functions[i]?"A"===t.nSQL.functions[i].type&&(t.wt=!0):(t.query.state="error",t.error('Function "'+i+'" not found!'))}else t.W.push({isFn:!1,value:n[0],as:n[1]})}),"error"!==this.query.state&&(e.qt[n]={hasAggrFn:this.wt,args:this.W})):this.W=[];var r=!1;this.ft.type===i.IWhereType.none?(r="_pk_"===this.Et.index)&&(this.J=!0):(r=!!(this.Et.index.length&&this.ft.fastWhere&&o.a(this.ft.fastWhere[0].col,this.Et.sort[0].path)))&&(this.U=!0),(this.Et.sort.length&&!r||this.St.sort.length||this.wt)&&(this.F=!1)},e.prototype.ht=function(t,n){var r=this,a=t||[],s=JSON.stringify(a)+(n?"0":"1");if(e.Pt[s])return e.Pt[s];if("function"==typeof a)return{type:i.IWhereType.fn,whereFn:a};if(!a.length)return e.Pt[s]={type:i.IWhereType.none},e.Pt[s];for(var u="string"==typeof this.query.table?Object.keys(this.nSQL.tables[this.query.table].indexes).map(function(e){return r.nSQL.tables[r.query.table].indexes[e]}):[],c="string"==typeof this.query.table?this.nSQL.tables[this.query.table].pkCol:"",l=function(e,t){var i=!n&&0===t;return e.reduce(function(e,n,a){if(a%2==1)return"string"!=typeof n?(r.query.state="error",r.error("Malformed WHERE statement!")):e.push(n),e;if(!Array.isArray(n))return r.query.state="error",r.error("Malformed WHERE statement!"),e;if(Array.isArray(n[0]))e.push(l(n,t+1));else if(-1!==n[0].indexOf("(")){var s=n[0].split("(")[1].replace(")","").split(",").map(function(e){return e.trim()}).filter(function(e){return e}),f=n[0].split("(")[0].trim().toUpperCase(),h=!1;if(!r.nSQL.functions[f])return r.query.state="error",r.error('Function "'+f+'" not found!'),e;if(i&&r.nSQL.functions[f]&&r.nSQL.functions[f].checkIndex){var p=r.nSQL.functions[f].checkIndex(r.query,s,n);p&&(r.H.push(o.u(n)),h=!0,e.push(p))}h||e.push({fnName:f,fnArgs:s,comp:n[1],value:n[2]})}else{var d=!1,y=i?o.resolvePath(n[0]):[];-1!==["=","BETWEEN","IN"].indexOf(n[1])&&i&&(n[0]===c?(d=!0,r.H.push(o.u(n)),e.push({index:"_pk_",col:n[0],comp:n[1],value:n[2]})):u.forEach(function(t){!1===d&&o.a(t.path,y)&&!1===t.isArray&&(d=!0,r.H.push(o.u(n)),e.push({index:t.id,col:n[0],comp:n[1],value:n[2]}))})),i&&!d&&-1!==["INCLUDES","INTERSECT","INTERSECT ALL"].indexOf(n[1])&&u.forEach(function(t){o.a(t.path,y)&&!0===t.isArray&&(d=!0,r.H.push(o.u(n)),e.push({index:t.id,indexArray:!0,col:n[0],comp:n[1],value:n[2]}))}),d||e.push({col:n[0],comp:n[1],value:n[2]})}return e},[])},f=l("string"==typeof a[0]?[a]:a,0),h=!0,p=0,d=-1;p<f.length&&h;)p%2==1?"AND"!==f[p]?h=!1:d=p:Array.isArray(f[p])||!f[p].index?h=!1:d=p,p++;if(d%2==0&&d++,-1===d||"AND"!==f[d]&&f[d])e.Pt[s]={type:i.IWhereType.slow,slowWhere:f};else{var y=f.slice(d+1);e.Pt[s]={type:y.length?i.IWhereType.medium:i.IWhereType.fast,slowWhere:y,fastWhere:f.slice(0,d)}}return e.Pt[s]},e.likeCache={},e.Ct={},e.qt={},e.Pt={},e}();t.q=u},function(e,t,n){Object.defineProperty(t,"e",{value:!0});var r=n(1),i=n(0),o=function(){function e(e){this.useLS=e,this.plugin={name:"Sync Storage Adapter",version:r.VERSION},this.Ft={},this.Wt={},this.Jt={}}return e.prototype.connect=function(e,t,n){this.Ut=e,t()},e.prototype.createAndInitTable=function(e,t,n,r){if(this.Ft[e]=[],this.Wt[e]={},this.useLS){var i=localStorage.getItem(this.Ut+"->"+e+"_idx");i&&(this.Ft[e]=JSON.parse(i),this.Jt[e]=parseFloat(localStorage.getItem(this.Ut+"->"+e+"_ai")||"0"))}n()},e.prototype.disconnectTable=function(e,t,n){delete this.Ft[e],delete this.Wt[e],t()},e.prototype.dropTable=function(e,t,n){var r=this;this.Ft[e].forEach(function(t){r.useLS?localStorage.removeItem(r.Ut+"->"+e+"__"+t):delete r.Wt[e][t]}),this.useLS&&localStorage.removeItem(this.Ut+"->"+e+"_idx"),delete this.Ft[e],delete this.Wt[e],t()},e.prototype.disconnect=function(e,t){e()},e.prototype.write=function(e,t,n,r,o){if(void 0!==(t=t||i.generateID(this.nSQL.tables[e].pkType,this.Jt[e]+1))){if(this.nSQL.tables[e].ai&&(this.Jt[e]=Math.max(this.Jt[e]||0,t)),-1===this.Ft[e].indexOf(t)){var a=i.binarySearch(this.Ft[e],t);this.Ft[e].splice(a,0,t),this.useLS&&(localStorage.setItem(this.Ut+"->"+e+"_idx",JSON.stringify(this.Ft[e])),localStorage.setItem(this.Ut+"->"+e+"_ai",String(this.Jt[e])))}n[this.nSQL.tables[e].pkCol]=t,this.useLS?localStorage.setItem(this.Ut+"->"+e+"__"+t,JSON.stringify(n)):this.Wt[e][t]=i.deepFreeze(n),r(n[this.nSQL.tables[e].pkCol])}else o(new Error("Can't add a row without a primary key!"))},e.prototype.read=function(e,t,n,r){if(this.useLS){var i=localStorage.getItem(this.Ut+"->"+e+"__"+t);n(i?JSON.parse(i):void 0)}else n(this.Wt[e][t])},e.prototype.delete=function(e,t,n,r){var i=this.Ft[e].indexOf(t);-1!==i&&(this.Ft[e].splice(i,1),this.useLS&&localStorage.setItem(this.Ut+"->"+e+"_idx",JSON.stringify(this.Ft[e].keys()))),this.useLS?localStorage.removeItem(this.Ut+"->"+e+"__"+t):delete this.Wt[e][t],n()},e.prototype.readMulti=function(e,t,n,r,o,a,s,u){var c=this,l={range:[n,r],offset:[n,n+r],all:[]}[t],f=function(){switch(t){case"all":case"offset":return"all"===t?c.Ft[e].slice():c.Ft[e].slice(l[0],l[1]);case"range":for(var n=i.binarySearch(c.Ft[e],l[0]),r=i.binarySearch(c.Ft[e],l[1]);c.Ft[e][r]>l[1];)r--;for(;c.Ft[e][n]<l[0];)n++;return c.Ft[e].slice(n,r+1)}return[]}();o&&f.reverse(),f.forEach(function(t,n){c.useLS?a(JSON.parse(localStorage.getItem(c.Ut+"->"+e+"__"+t)||"{}"),n):a(c.Wt[e][t],n)}),s()},e.prototype.getIndex=function(e,t,n){t(this.Ft[e].slice())},e.prototype.getNumberOfRecords=function(e,t,n){t(this.Ft[e].length)},e}();t.SyncStorage=o},function(e,t,n){Object.defineProperty(t,"e",{value:!0});var r=n(1),i=n(0),o=[];t.SQLiteAbstract=function(e,t){var n=function(e){if(-1===o.indexOf(e))throw Error("No table "+e+" found!");return'"'+e+'"'};return{createAI:function(t,n){e(!0,'CREATE TABLE IF NOT EXISTS "_ai" (id TEXT PRIMARY KEY UNIQUE, inc BIGINT)',[],t,n)},createTable:function(t,n,r,i,a){o.push(t),e(!0,'CREATE TABLE IF NOT EXISTS "'+t+'" (id '+(n.isPkNum?"REAL":"TEXT")+" PRIMARY KEY UNIQUE, data TEXT)",[],function(){n.ai?e(!1,'SELECT "inc" FROM "_ai" WHERE id = ?',[t],function(n){n.rows.length?(r[t]=parseInt(n.rows.item(0).inc),i()):(r[t]=0,e(!0,'INSERT into "_ai" (id, inc) VALUES (?, ?)',[t,0],function(){i()},a))},a):i()},a)},dropTable:function(t,r,i){e(!0,"DROP TABLE IF EXISTS "+n(t),[],function(){e(!0,'UPDATE "_ai" SET inc = ? WHERE id = ?',[0,t],function(){o.splice(o.indexOf(t),1),r()},i)},i)},write:function(t,r,o,a,s,u,c,l,f){if(void 0!==(a=a||i.generateID(t,c[o]+1))){u&&(c[o]=Math.max(a,c[o])),s[r]=a;var h=JSON.stringify(s);e(!1,"SELECT id FROM "+n(o)+" WHERE id = ?",[a],function(t){t.rows.length?e(!0,"UPDATE "+n(o)+" SET data = ? WHERE id = ?",[h,a],function(){u&&a===c[o]?e(!0,'UPDATE "_ai" SET inc = ? WHERE id = ?',[c[o],o],function(){l(a)},f):l(a)},f):e(!0,"INSERT INTO "+n(o)+" (id, data) VALUES (?, ?)",[a,h],function(){u&&a===c[o]?e(!0,'UPDATE "_ai" SET inc = ? WHERE id = ?',[c[o],o],function(){l(a)},f):l(a)},f)},f)}else f(new Error("Can't add a row without a primary key!"))},read:function(t,r,i,o){e(!1,"SELECT data FROM "+n(t)+" WHERE id = ?",[r],function(e){e.rows.length?i(JSON.parse(e.rows.item(0).data)):i(void 0)},o)},remove:function(t,r,i,o){e(!0,"DELETE FROM "+n(t)+" WHERE id = ?",[r],function(){i()},o)},getIndex:function(t,r,i){e(!1,"SELECT id FROM "+n(t)+" ORDER BY id",[],function(e){for(var t=[],n=0;n<e.rows.length;n++)t.push(e.rows.item(n).id);r(t)},i)},getNumberOfRecords:function(t,r,i){e(!1,"SELECT COUNT(*) FROM "+n(t),[],function(e){r(e.rows.item(0)["COUNT(*)"])},i)},readMulti:function(r,i,o,a,s,u,c,l){var f="SELECT data FROM "+n(r);"range"===i&&(f+=" WHERE id BETWEEN ? AND ?"),f+=s?" ORDER BY id DESC":" ORDER BY id";var h=0,p=function(){var n=f;if("offset"===i)if(a<=t)n+=" LIMIT "+a+" OFFSET "+o;else{var r=Math.min(t,a-h*t),s=o+h*t;if(r<=0)return void c();n+=" LIMIT "+r+" OFFSET "+s}else n+=" LIMIT "+t+" OFFSET "+h*t;e(!1,n,"range"===i?[o,a]:[],function(e){if(e.rows.length){for(var n=0;n<e.rows.length;n++)u(JSON.parse(e.rows.item(n).data),h*t+n);e.rows.length===t?(h++,p()):c()}else c()},l)};p()}}};var a=function(){function e(e,n){this.plugin={name:"WebSQL Adapter",version:r.VERSION},this.Bt=1e3*(e||0)*1e3,this.Jt={},this.Qt=this.Qt.bind(this),this.Ht=t.SQLiteAbstract(this.Qt,n||500)}return e.prototype.connect=function(e,t,n){var r=this;this.Ut=e,this.Vt=window.openDatabase(this.Ut,String(this.nSQL.config.version)||"1.0",this.Ut,i.isAndroid?5e6:this.Bt),i.setFast(function(){r.Ht.createAI(t,n)})},e.prototype.createAndInitTable=function(e,t,n,r){this.Ht.createTable(e,t,this.Jt,n,r)},e.prototype.Qt=function(e,t,n,r,i){var o=function(e){e.executeSql(t,n,function(e,t){r(t)},function(e,t){return i(t),!1})};e?this.Vt.transaction(o):this.Vt.readTransaction(o)},e.prototype.disconnectTable=function(e,t,n){t()},e.prototype.dropTable=function(e,t,n){this.Ht.dropTable(e,t,n)},e.prototype.disconnect=function(e,t){e()},e.prototype.write=function(e,t,n,r,i){this.Ht.write(this.nSQL.tables[e].pkType,this.nSQL.tables[e].pkCol,e,t,n,this.nSQL.tables[e].ai,this.Jt,r,i)},e.prototype.read=function(e,t,n,r){this.Ht.read(e,t,n,r)},e.prototype.delete=function(e,t,n,r){this.Ht.remove(e,t,n,r)},e.prototype.readMulti=function(e,t,n,r,i,o,a,s){this.Ht.readMulti(e,t,n,r,i,o,a,s)},e.prototype.getIndex=function(e,t,n){this.Ht.getIndex(e,t,n)},e.prototype.getNumberOfRecords=function(e,t,n){this.Ht.getNumberOfRecords(e,t,n)},e}();t.WebSQL=a},function(e,t,n){Object.defineProperty(t,"e",{value:!0});var r=n(1),i=n(0),o=function(){function e(e){this.version=e,this.plugin={name:"IndexedDB Adapter",version:r.VERSION},this.Vt={},this.Jt={}}return e.prototype.connect=function(e,t,n){this.Ut=e,t()},e.prototype.createAndInitTable=function(e,t,n,r){var o=this,a=1,s=i.hash(JSON.stringify(t.columns));this.version?a=this.version:(a=parseInt(localStorage.getItem(this.Ut+"_"+e+"_idb_version")||"")||1,(localStorage.getItem(this.Ut+"_"+e+"_idb_hash")||s)!==s&&a++,localStorage.setItem(this.Ut+"_"+e+"_idb_version",String(a)),localStorage.setItem(this.Ut+"_"+e+"_idb_hash",s));var u=indexedDB.open(this.Ut+"_"+e,a);this.Jt[e]=parseInt(localStorage.getItem(this.Ut+"_"+e+"_idb_ai")||"0"),u.onerror=r,u.onupgradeneeded=function(n){o.Vt[e]=n.target.result,o.Vt[e].objectStoreNames.contains(e)||o.Vt[e].createObjectStore(e,{keyPath:t.pkCol})},u.onsuccess=function(t){o.Vt[e]=t.target.result,n()}},e.prototype.disconnectTable=function(e,t,n){this.Vt[e].onerror=n,this.Vt[e].close(),delete this.Vt[e],localStorage.removeItem(this.Ut+"_"+e+"_idb_version"),localStorage.removeItem(this.Ut+"_"+e+"_idb_hash"),localStorage.removeItem(this.Ut+"_"+e+"_idb_ai"),t()},e.prototype.dropTable=function(e,t,n){var r=this,i=this.Vt[e].transaction(e,"readwrite");i.onerror=n,i.objectStore(e).clear().onsuccess=function(){r.disconnectTable(e,t,n)}},e.prototype.disconnect=function(e,t){e()},e.prototype.store=function(e,t,n,r){var i=this.Vt[e].transaction(e,t);i.onabort=r,i.onerror=r,n(i,i.objectStore(e))},e.prototype.write=function(e,t,n,r,o){void 0!==(t=t||i.generateID(this.nSQL.tables[e].pkType,this.Jt[e]+1))?(this.Jt[e]=Math.max(t,this.Jt[e]),this.nSQL.tables[e].ai&&(this.Jt[e]=i.cast("int",Math.max(this.Jt[e]||0,t)),localStorage.setItem(this.Ut+"_"+e+"_idb_ai",String(this.Jt[e]))),n[this.nSQL.tables[e].pkCol]=t,this.store(e,"readwrite",function(e,i){try{i.put(n).onsuccess=function(){r(t)}}catch(e){o(e)}},o)):o(new Error("Can't add a row without a primary key!"))},e.prototype.read=function(e,t,n,r){this.store(e,"readonly",function(e,r){var i=r.get(t);i.onerror=function(){n(void 0)},i.onsuccess=function(){n(i.result)}},r)},e.prototype.delete=function(e,t,n,r){this.store(e,"readwrite",function(e,i){var o=i.delete(t);o.onerror=r,o.onsuccess=function(e){n()}},r)},e.prototype.readMulti=function(e,t,n,r,i,o,a,s){var u=0,c="offset"===t?n:0,l=c+r,f=!0;this.store(e,"readonly",function(e,s){s.openCursor("range"!==t?void 0:IDBKeyRange.bound(n,r,!1,!1),i?"prev":"next").onsuccess=function(e){var r=e.target.result;if(r){if("offset"===t){if(f)return r.advance(c),u=c,void(f=!1);u<l&&o(r.value,u-n)}else o(r.value,u);u++,r.continue()}else a()}},s)},e.prototype.getIndex=function(e,t,n){var r=this,i=[];this.store(e,"readonly",function(n,o){o.openCursor().onsuccess=function(n){var o=n.target.result;o?(i.push(o.value[r.nSQL.tables[e].pkCol]),o.continue()):t(i)}},n)},e.prototype.getNumberOfRecords=function(e,t,n){this.store(e,"readonly",function(r,i){var o=r.objectStore(e).count();o.onsuccess=function(){t(o.result)},o.onerror=n},n)},e}();t.IndexedDB=o},function(e,t,n){var r=this&&this.O||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"e",{value:!0});var i=n(0),o=function(){function e(e,t,n,o,a){this.Vt=e,this.Yt=a||"",this.Qt="string"==typeof n?r({},i.buildQuery(e,t,n),{comments:[],state:"pending",action:n,actionArgs:o,result:[]}):r({},i.buildQuery(e,t,""),n(e),{state:"pending"})}return e.prototype.where=function(e){return this.Qt.where=e,this},e.prototype.orderBy=function(e){return this.Qt.orderBy=e,this},e.prototype.groupBy=function(e){return this.Qt.groupBy=e,this},e.prototype.having=function(e){return this.Qt.having=e,this},e.prototype.join=function(e){var t=this,n="Join commands requires table and type arguments!";return Array.isArray(e)?e.forEach(function(e){e.with.table&&e.type||(t.Xt=n)}):e.with.table&&e.type||(this.Xt=n),this.Qt.join=e,this},e.prototype.limit=function(e){return this.Qt.limit=e,this},e.prototype.comment=function(e){return this.Qt.comments.push(e),this},e.prototype.tag=function(e){return this.Qt.tags.push(e),this},e.prototype.extend=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return this.Qt.extend.push({scope:e,args:t}),this},e.prototype.union=function(e,t){return this.Qt.union={queries:e,type:t?"all":"distinct"},this},e.prototype.offset=function(e){return this.Qt.offset=e,this},e.prototype.emit=function(){return this.Qt},e.prototype.ttl=function(e,t){if(void 0===e&&(e=60),"upsert"!==this.Qt.action)throw new Error("nSQL: Can only do ttl on upsert queries!");return this.Qt.ttl=e,this.Qt.ttlCols=t||[],this},e.prototype.graph=function(e){return this.Qt.graph=e,this},e.prototype.from=function(e){return this.Qt.table=e.table,this.Qt.tableAS=e.as,this},e.prototype.into=function(e){return this.Qt.table=e,this},e.prototype.on=function(e){return this.Qt.table=e,this},e.prototype.toCSV=function(e){var t=this;return t.exec().then(function(n){return Promise.resolve(t.Vt.JSONtoCSV(n,e))})},e.prototype.exec=function(e){var t=this;return new Promise(function(n,r){var i=[];t.Qt.returnEvent=e,t.stream(function(e){e&&i.push(e)},function(){n(i)},r)})},e.prototype.streamEvent=function(e,t,n){this.Qt.returnEvent=!0,this.Vt.triggerQuery(this.Qt,e,t,n)},e.prototype.stream=function(e,t,n){this.Vt.triggerQuery(this.Qt,e,t,n)},e.prototype.cache=function(){var e=this;return new Promise(function(t,n){var r=i.uuid();e.exec().then(function(n){e.Vt.k[r]=n,t({id:r,total:n.length})}).catch(n)})},e}();t.C=o}])});