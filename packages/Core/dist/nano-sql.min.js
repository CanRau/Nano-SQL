!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var s=t();for(var r in s)("object"==typeof exports?exports:e)[r]=s[r]}}(window,function(){return function(e){var t={};function s(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,s),i.l=!0,i.exports}return s.m=e,s.c=t,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(r,i,function(t){return e[t]}.bind(null,i));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=6)}([function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(3),i=s(4);t.blankTableDefinition={id:"",name:"",model:{},columns:[],indexes:{},actions:[],queries:{},views:[],pkType:"string",pkCol:[],isPkNum:!1,ai:!1},t.binarySearch=((e,s,r,i,n)=>{const a=i||0,o=n||e.length;if(e[a]>=s)return r?-1:a;if(e[o]<=s)return r?-1:o+1;const l=Math.floor((a+o)/2);return s==e[l]?l:o-1==a?r?-1:o:s>e[l]?t.binarySearch(e,s,r,l,o):s<e[l]?t.binarySearch(e,s,r,a,l):r?-1:o}),t.titleCase=(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()),t.slugify=(e=>String(e).replace(/\s+/g,"-").replace(/[^0-9a-z\-]/gi,"").toLowerCase()),t.buildQuery=((e,s,r)=>({table:s||e.state.selectedTable,parent:e,action:r,state:"pending",result:[],time:Date.now(),queryID:t.uuid(),extend:[],comments:[],tags:[]})),t.adapterFilters=((e,t)=>({write:(s,r,i,n,a)=>{e.doFilter("adapterWrite",{res:{table:s,pk:r,row:i,complete:n,error:a},query:t},t=>{if(!t)return;(e._tables[t.res.table].mode||e.adapter).write(e._tableIds[t.res.table],t.res.pk,t.res.row,e=>{t.res.complete(e)},t.res.error)},a)},read:(s,r,i,n)=>{e.doFilter("adapterRead",{res:{table:s,pk:r,complete:i,error:n},query:t},t=>{if(!t)return;(e._tables[t.res.table].mode||e.adapter).read(e._tableIds[t.res.table],t.res.pk,e=>{e?t.res.complete(e):t.res.complete(void 0)},t.res.error)},n)},readMulti:(s,r,i,n,a,o,l,h)=>{e.doFilter("adapterReadMulti",{res:{table:s,type:r,offsetOrLow:i,limitOrHigh:n,reverse:a,onRow:o,complete:l,error:h},query:t},t=>{if(!t)return;(e._tables[t.res.table].mode||e.adapter).readMulti(e._tableIds[t.res.table],t.res.type,t.res.offsetOrLow,t.res.limitOrHigh,t.res.reverse,(e,s)=>{t.res.onRow(e,s)},()=>{t.res.complete()},t.res.error)},h)},connect:(s,r,i)=>{e.doFilter("adapterConnect",{res:{id:s,complete:r,error:i},query:t},t=>{t&&e.adapter.connect(t.res.id,t.res.complete,t.res.error)},i)},disconnect:(s,r)=>{e.doFilter("adapterDisconnect",{res:{complete:s,error:r},query:t},t=>{t&&e.adapter.disconnect(t.res.complete,t.res.error)},r)},createTable:(s,r,i,n)=>{e.doFilter("adapterCreateTable",{res:{table:s,tableData:r,complete:i,error:n},query:t},t=>{if(!t)return;(r.mode||e.adapter).createTable(e._tableIds[t.res.table],t.res.tableData,t.res.complete,t.res.error)},n)},dropTable:(s,r,i)=>{e.doFilter("adapterDropTable",{res:{table:s,complete:r,error:i},query:t},t=>{if(!t)return;(e._tables[t.res.table].mode||e.adapter).dropTable(e._tableIds[t.res.table],t.res.complete,t.res.error)},i)},delete:(s,r,i,n)=>{e.doFilter("adapterDelete",{res:{table:s,pk:r,complete:i,error:n},query:t},t=>{if(!t)return;(e._tables[t.res.table].mode||e.adapter).delete(e._tableIds[t.res.table],t.res.pk,t.res.complete,t.res.error)},n)},getTableIndex:(s,r,i)=>{e.doFilter("adapterGetTableIndex",{res:{table:s,complete:r,error:i},query:t},t=>{if(!t)return;(e._tables[t.res.table].mode||e.adapter).getTableIndex(e._tableIds[t.res.table],t.res.complete,t.res.error)},i)},getTableIndexLength:(s,r,i)=>{e.doFilter("adapterGetTableIndexLength",{res:{table:s,complete:r,error:i},query:t},t=>{if(!t)return;(e._tables[t.res.table].mode||e.adapter).getTableIndexLength(e._tableIds[t.res.table],t.res.complete,t.res.error)},i)},createIndex:(s,r,i,n,a)=>{e.doFilter("adapterCreateIndex",{res:{table:s,indexName:r,type:i,complete:n,error:a},query:t},t=>{if(!t)return;(e._tables[t.res.table].mode||e.adapter).createIndex(e._tableIds[t.res.table],t.res.indexName,t.res.type,t.res.complete,t.res.error)},a)},deleteIndex:(s,r,i,n)=>{e._tables[s].indexes[r]?e.doFilter("adapterDeleteIndex",{res:{table:s,indexName:r,complete:i,error:n},query:t},t=>{if(!t)return;(e._tables[t.res.table].mode||e.adapter).deleteIndex(e._tableIds[t.res.table],t.res.indexName,t.res.complete,t.res.error)},n):n({error:`Index ${r} not found!`})},addIndexValue:(s,r,i,n,a,o)=>{if(!e._tables[s].indexes[r])return void o({error:`Index ${r} not found!`});let l=void 0===n||"undefined"===n?"__NULL__":n;"number"==typeof l&&e._tables[s].indexes[r].props&&e._tables[s].indexes[r].props.offset&&(l+=e._tables[s].indexes[r].props.offset||0),e._tables[s].indexes[r].props&&e._tables[s].indexes[r].props.ignore_case&&(l=String(l||"").toUpperCase()),e.doFilter("adapterAddIndexValue",{res:{table:s,indexName:r,key:i,value:l,complete:a,error:o},query:t},t=>{if(!t)return;(e._tables[t.res.table].mode||e.adapter).addIndexValue(e._tableIds[t.res.table],t.res.indexName,t.res.key,t.res.value,t.res.complete,t.res.error)},o)},deleteIndexValue:(s,r,i,n,a,o)=>{if(!e._tables[s].indexes[r])return void o({error:`Index ${r} not found!`});let l=void 0===n||"undefined"===n?"__NULL__":n;"number"==typeof l&&e._tables[s].indexes[r].props&&e._tables[s].indexes[r].props.offset&&(l+=e._tables[s].indexes[r].props.offset||0),e._tables[s].indexes[r].props&&e._tables[s].indexes[r].props.ignore_case&&(l=String(l||"").toUpperCase()),e.doFilter("adapterDeleteIndexValue",{res:{table:s,indexName:r,key:i,value:l,complete:a,error:o},query:t},t=>{if(!t)return;(e._tables[t.res.table].mode||e.adapter).deleteIndexValue(e._tableIds[t.res.table],t.res.indexName,t.res.key,t.res.value,t.res.complete,t.res.error)},o)},readIndexKey:(s,r,i,n,a,o)=>{if(!e._tables[s].indexes[r])return void o({error:`Index ${r} not found!`});let l="NULL"===i?"__NULL__":i;"number"==typeof l&&e._tables[s].indexes[r].props&&e._tables[s].indexes[r].props.offset&&(l+=e._tables[s].indexes[r].props.offset||0),e._tables[s].indexes[r].props&&e._tables[s].indexes[r].props.ignore_case&&(l=String(l||"").toUpperCase()),e.doFilter("adapterReadIndexKey",{res:{table:s,indexName:r,pk:l,onRowPK:n,complete:a,error:o},query:t},t=>{if(!t)return;(e._tables[t.res.table].mode||e.adapter).readIndexKey(e._tableIds[t.res.table],t.res.indexName,t.res.pk,t.res.onRowPK,t.res.complete,t.res.error)},o)},readIndexKeys:(s,r,i,n,a,o,l,h,u)=>{let c=n,d=a;e._tables[s].indexes[r]?("number"==typeof c&&"number"==typeof d&&"range"===i&&e._tables[s].indexes[r]&&e._tables[s].indexes[r].props.offset&&(c+=e._tables[s].indexes[r].props.offset||0,d+=e._tables[s].indexes[r].props.offset||0),"range"===i&&e._tables[s].indexes[r].props&&e._tables[s].indexes[r].props.ignore_case&&(c=String(c||"").toUpperCase(),d=String(d||"").toUpperCase()),e.doFilter("adapterReadIndexKeys",{res:{table:s,indexName:r,type:i,offsetOrLow:c,limitOrHigh:d,reverse:o,onRowPK:l,complete:h,error:u},query:t},t=>{if(!t)return;(e._tables[t.res.table].mode||e.adapter).readIndexKeys(e._tableIds[t.res.table],t.res.indexName,t.res.type,t.res.offsetOrLow,t.res.limitOrHigh,t.res.reverse,(e,s)=>{"__NULL__"!==e&&t.res.onRowPK(e,s)},t.res.complete,t.res.error)},u)):u({error:`Index ${r} not found!`})}})),t.ISO_8601_FULL=/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(\.\d+)?(([+-]\d\d:\d\d)|Z)?$/i,t.maybeDate=(e=>e&&"string"==typeof e&&t.ISO_8601_FULL.test(e)?Date.parse(e):e),t.mutateRowTypes=((e,t,s)=>{if(!s._tables[t])throw new Error(`nSQL: Table "${t}" not found!`);const r=(e,t,s)=>t?s&&s.length&&-1!==s.indexOf("[]")?Array.isArray(t)?t.map(t=>r(e,t,s.slice(0,s.lastIndexOf("[]")))):[]:(e.forEach(e=>{if(e.model)if(-1!==e.type.indexOf("[]")){const s=void 0!==t?t[e.key]:[];Array.isArray(s)?t[e.key]=s.map(t=>r(e.model,t,e.type.slice(0,e.type.lastIndexOf("[]")))):t[e.key]=[]}else t[e.key]=r(e.model,void 0!==t?t[e.key]:void 0);else switch(e.type){case"date":t[e.key]=new Date(t[e.key]).toISOString();break;default:t[e.key]=t[e.key]}}),t):t;return r(s._tables[t].columns,e)}),t.noop=(()=>{}),t.throwErr=(e=>{throw new Error(e)}),t.nan=(e=>isNaN(e)||null===e?0:parseFloat(e)),t.assign=(e=>e?JSON.parse(JSON.stringify(e)):e),t.objectsEqual=((e,t)=>e===t||"object"==typeof e&&(!(!e||!t)&&i(e,t)));t._nanoSQLQueue=class{constructor(e,t,s){this.processItem=e,this.onError=t,this.onComplete=s,this._items=[],this._going=!1,this._done=!1,this._count=0,this._triggeredComplete=!1,this._progressBuffer=this._progressBuffer.bind(this)}_progressBuffer(){if(this._triggeredComplete)return;if(this._done&&!this._items.length)return this._triggeredComplete=!0,void(this.onComplete&&this.onComplete());if(!this._items.length)return void(this._going=!1);const e=()=>{this._count++,this._count%100==0?t.setFast(this._progressBuffer):this._progressBuffer()},s=this._items.shift()||[];s[1]?s[1](s[0],e,this.onError?this.onError:t.noop):this.processItem&&this.processItem(s[0],this._count,e,this.onError?this.onError:t.noop)}finished(){this._done=!0,this._triggeredComplete||this._going||this._items.length||(this._triggeredComplete=!0,this.onComplete&&this.onComplete())}newItem(e,t){this._items.push([e,t]),this._going||(this._going=!0,this._progressBuffer())}},t.chainAsync=((e,s)=>new Promise((r,i)=>{if(!e||!e.length)return void r([]);let n=[],a=0;const o=()=>{a<e.length?s(e[a],a,e=>{e&&n.push(e||0),++a%250==0?t.setFast(()=>{o()}):o()},e=>{i(e)}):r(n.length?n:void 0)};o()})),t.allAsync=((e,t)=>Promise.all((e||[]).map((e,s)=>new Promise((r,i)=>{t(e,s,r,i)}))));const n="undefined"==typeof window?"":navigator.userAgent||"";t.isSafari=0!==n.length&&(/^((?!chrome|android).)*safari/i.test(n)||/iPad|iPhone|iPod/.test(n)&&!window.MSStream),t.isMSBrowser=0!==n.length&&(n.indexOf("MSIE ")>0||n.indexOf("Trident/")>0||n.indexOf("Edge/")>0),t.isAndroid=/Android/.test(n),t.random16Bits=(()=>{if("undefined"==typeof crypto)return Math.round(Math.random()*Math.pow(2,16));if(crypto.getRandomValues){let e=new Uint16Array(1);return crypto.getRandomValues(e),e[0]}return"undefined"!=typeof global&&global._crypto.randomBytes?global._crypto.randomBytes(2).reduce((e,t)=>t*e):Math.round(Math.random()*Math.pow(2,16))}),t.throttle=((e,t,s)=>{let r=!1;return(...i)=>{r||(r=!0,setTimeout(()=>{t.apply(e,i),r=!1},s))}}),t.timeid=(e=>{let s=Math.round((new Date).getTime()/(e?1:1e3)).toString();for(;s.length<(e?13:10);)s="0"+s;let r=(t.random16Bits()+t.random16Bits()).toString(16);for(;r.length<5;)r="0"+r;return s+"-"+r}),t.intersect=((e,t)=>!(!e||!t)&&(!(!e.length||!t.length)&&(e||[]).filter(e=>-1!==(t||[]).indexOf(e)).length>0)),t.uuid=(()=>{let e,s,r="";return[r,r,r,r,r,r,r,r].reduce((i,n,a)=>{for(e=t.random16Bits(),s=3===a?4:4===a?(e%16&3|8).toString(16):r,e=e.toString(16);e.length<4;)e="0"+e;return i+([2,3,4,5].indexOf(a)>-1?"-":r)+(s+e).slice(0,4)},r)}),t.hash=(e=>{let t=5381,s=e.length;for(;s;)t=33*t^e.charCodeAt(--s);return(t>>>0).toString(16)}),t.generateID=((e,s)=>{const r={int:e=>e,date:e=>e,float:e=>e,uuid:t.uuid,timeId:()=>t.timeid(),timeIdms:()=>t.timeid(!0)};return r[e]?r[e](s||1):void 0}),t.cleanArgs2=((e,s,r)=>{const i=(s,n,a)=>{if(-1!==s.indexOf("[]")){const e=s.slice(0,s.lastIndexOf("[]"));return Array.isArray(n)?n.map(t=>i(e,t,a)):[]}if("string"==typeof a){let t=a.replace(/\[\]/gim,""),s=Object.keys(r.config.types||{}).reduce((e,s)=>s===t?(r.config.types||{})[s]:e,void 0);if(!s)throw new Error(`Can't find type ${t}!`);return i(a,e,s)}{let e={},s=!1,i=[];return Object.keys(a).forEach(a=>{const o=a.split(":");"*"===o[0]?s=!0:(i.push(o[0]),e[o[0]]=t.cast(o[1],n[o[0]],!1,r))}),s&&t.isObject(n)&&Object.keys(n).filter(e=>-1===i.indexOf(e)).forEach(t=>{e[t]=n[t]}),e}};return i("string"==typeof s?s:"",e,s)}),t.cleanArgs=((e,s,r)=>{let i={},n=e.length;Object.keys(r.config.types||{});for(;n--;){let a=e[n].split(":");a.length>1?i[a[0]]=t.cast(a[1],s[a[0]]||void 0,!0,r):i[a[0]]=s[a[0]]||void 0}return i}),t.isObject=(e=>"[object Object]"===Object.prototype.toString.call(e)),t.objSort=((e,s)=>(r,i)=>{const n=e?t.deepGet(e,r)>t.deepGet(e,i)?-1:1:r>i?-1:1;return s?-1*n:n}),t.execFunction=((e,s,r,i)=>{const n=s.match(/\((.*)\)/gim);if(!n[0])return{result:void 0};const a=n[0].substr(1,n[0].length-2).split(/\,\s?(?![^\(]*\))/).map(e=>e.trim()),o=s.split("(").shift(),l=a.map(s=>-1!==s.indexOf("(")?t.execFunction(e,s,r,i).result:s);return e.parent.functions[o]?e.parent.functions[o].call(e,r,i,...l):{result:void 0}}),t.cast=((e,s,r,i)=>{if("any"===e||"blob"===e||"*"===e)return s;if(-1!==e.indexOf("[]")){const i=e.slice(0,e.lastIndexOf("[]"));return Array.isArray(s)?s.map(e=>t.cast(i,e,r)):[]}const n=typeof s,a={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},o=i&&i.config.types||{};if(-1!==Object.keys(o).indexOf(e)){if(t.isObject(s)){const n=o[e];return Object.keys(n).reduce((e,n)=>{const a=n.split(":");return e[a[0]]=t.cast(a[1],s[a[0]],r,i),e},{})}return{}}const l=(e,i)=>{switch(e){case"safestr":return l("string",i).replace(/[&<>"'`=\/]/gim,e=>a[e]);case"date":if("string"===n)return Date.parse(i);case"int":return"number"!==n||i%1!=0?Math.round(t.nan(i)):i;case"number":case"float":return"number"!==n?t.nan(i):i;case"array":return Array.isArray(i)?i:[];case"uuid":case"timeId":case"timeIdms":case"string":return"string"!==n?String(i):i;case"object":case"obj":case"map":return t.isObject(i)?i:{};case"boolean":case"bool":return!0===i||1===i}return r?s:null};if(null==s)return null;const h=l(String(e||"").toLowerCase(),s);return void 0!==h&&["int","float","number"].indexOf(e)>-1&&isNaN(h)?0:h}),t.rad2deg=(e=>180*e/Math.PI),t.deg2rad=(e=>e*(Math.PI/180)),t.crowDistance=((e,s,r,i,n=6371)=>{const a=t.deg2rad(r-e),o=t.deg2rad(i-s),l=Math.pow(Math.sin(a/2),2)+Math.cos(t.deg2rad(e))*Math.cos(t.deg2rad(r))*Math.pow(Math.sin(o/2),2);return n*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))}),t.levenshtein=((e,t)=>r(e,t));const a={};t.resolvePath=(e=>{if(!e)return[];if(a[e])return a[e].slice();const t=-1!==e.indexOf("[")?e.split(/\.|\[/gim).map(e=>e.replace(/\]/gim,"")):e.split(".");return a[e]=t,a[e].slice()}),t.getFnValue=((e,s)=>s.match(/\".*\"|\'.*\'/gim)?s.replace(/\"|\'/gim,""):t.deepGet(s,e)),t.deepFreeze=(e=>(Object.getOwnPropertyNames(e||{}).forEach(s=>{const r=e[s];"object"==typeof r&&null!==r&&(e[s]=t.deepFreeze(r))}),Object.freeze(e))),t.deepSet=((e,s,r)=>{const i=(e,s,n)=>{e[s+1]?(n[e[s]]&&(Array.isArray(n[e[s]])||t.isObject(n[e[s]]))||(isNaN(e[s+1])?n[e[s]]={}:n[e[s]]=[]),i(e,s+1,n[e[s]])):n[e[s]]=r};return i(Array.isArray(e)?e:t.resolvePath(e),0,s),s}),t.deepGet=((e,s)=>{const r=(e,t,s)=>e[t]&&s?r(e,t+1,s[e[t]]):s;return r(Array.isArray(e)?e:t.resolvePath(e),0,s)}),t.maybeAssign=(e=>Object.isFrozen(e)?t.assign(e):e);const o=e=>e[0].apply(null,Array.prototype.slice.call(e,1));t.setFast="undefined"!=typeof Promise?(...e)=>{Promise.resolve().then(()=>{o(e)})}:(...e)=>{setTimeout(()=>{o(e)},0)}},function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.VERSION=2.23,function(e){e[e.NONE=0]="NONE",e[e.CASCADE=1]="CASCADE",e[e.RESTRICT=2]="RESTRICT",e[e.SET_NULL=3]="SET_NULL"}(t.InanoSQLFKActions||(t.InanoSQLFKActions={})),function(e){e[e.fast=0]="fast",e[e.medium=1]="medium",e[e.slow=2]="slow",e[e.fn=3]="fn",e[e.none=4]="none"}(t.IWhereType||(t.IWhereType={}))},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(0);t.err=new Error("Memory index doesn't support this action!");t.nanoSQLMemoryIndex=class{constructor(e,t){this.assign=e,this.useCache=t}connect(e,s,r){r(t.err)}disconnect(e,s){s(t.err)}createTable(e,s,r,i){i(t.err)}dropTable(e,s,r){r(t.err)}write(e,s,r,i,n){n(t.err)}read(e,s,r,i){i(t.err)}delete(e,s,r,i){i(t.err)}readMulti(e,s,r,i,n,a,o,l){l(t.err)}getTableIndex(e,s,r){r(t.err)}getTableIndexLength(e,s,r){r(t.err)}createIndex(e,t,s,i,n){const a=`_idx_${e}_${t}`;this.createTable(a,Object.assign({},r.blankTableDefinition,{pkType:s,pkCol:["id"],isPkNum:-1!==["float","int","number"].indexOf(s)}),()=>{i()},n)}deleteIndex(e,t,s,r){const i=`_idx_${e}_${t}`;this.dropTable(i,s,r)}addIndexValue(e,t,s,i,n,a){const o=`_idx_${e}_${t}`;this.read(o,i,e=>{let t=e?e.pks:[];if(0===(t=this.assign?r.assign(t):t).length)t.push(s);else{const e=r.binarySearch(t,s,!1);t.splice(e,0,s)}this.write(o,i,{id:s,pks:this.assign?r.assign(t):t},n,a)},a)}deleteIndexValue(e,t,s,i,n,a){const o=`_idx_${e}_${t}`;this.read(o,i,e=>{let t=e?e.pks:[];if(0!==(t=this.assign?r.assign(t):t).length){{const e=t.length<100?t.indexOf(s):r.binarySearch(t,s,!0);-1!==e&&t.splice(e,1)}t.length?this.write(o,i,{id:s,pks:this.assign?r.assign(t):t},n,a):this.delete(o,i,n,a)}else n()},a)}readIndexKey(e,t,s,r,i,n){const a=`_idx_${e}_${t}`;this.read(a,s,e=>{e?(e.pks.forEach(r),i()):i()},n)}readIndexKeys(e,t,s,r,i,n,a,o,l){const h=`_idx_${e}_${t}`;this.readMulti(h,s,r,i,n,e=>{e&&e.pks.forEach(t=>{a(t,e.id)})},o,l)}}},function(e,t,s){"use strict";e.exports=function(e,t,s){var n,a,o,l,h,u,c,d;if(e===t)return 0;if(n=e.length,a=t.length,0===n)return a;if(0===a)return n;s&&(e=e.toLowerCase(),t=t.toLowerCase());c=0;for(;c<n;)i[c]=e.charCodeAt(c),r[c]=++c;d=0;for(;d<a;)for(o=t.charCodeAt(d),l=h=d++,c=-1;++c<n;)u=o===i[c]?h:h+1,h=r[c],r[c]=l=h>l?u>l?l+1:u:u>h?h+1:u;return l};var r=[],i=[]},function(e,t,s){"use strict";var r=Array.isArray,i=Object.keys,n=Object.prototype.hasOwnProperty;e.exports=function e(t,s){if(t===s)return!0;if(t&&s&&"object"==typeof t&&"object"==typeof s){var a,o,l,h=r(t),u=r(s);if(h&&u){if((o=t.length)!=s.length)return!1;for(a=o;0!=a--;)if(!e(t[a],s[a]))return!1;return!0}if(h!=u)return!1;var c=t instanceof Date,d=s instanceof Date;if(c!=d)return!1;if(c&&d)return t.getTime()==s.getTime();var p=t instanceof RegExp,y=s instanceof RegExp;if(p!=y)return!1;if(p&&y)return t.toString()==s.toString();var f=i(t);if((o=f.length)!==i(s).length)return!1;for(a=o;0!=a--;)if(!n.call(s,f[a]))return!1;for(a=o;0!=a--;)if(!e(t[l=f[a]],s[l]))return!1;return!0}return t!=t&&s!=s}},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(0),i=s(11),n=s(12),a=s(13);let o;"undefined"!=typeof global&&(o=global._rocksAdapter),t.detectStorage=(()=>"undefined"==typeof window?"RKS":r.isSafari&&void 0!==window.openDatabase?"WSQL":"undefined"!=typeof indexedDB?"IDB":void 0!==window.openDatabase?"WSQL":"LS"),t.resolveMode=((e,s)=>{if("string"!=typeof e)return e;switch("PERM"===e&&(e=t.detectStorage()),e){case"TEMP":return new i.SyncStorage(!1);case"LS":return new i.SyncStorage(!0);case"WSQL":return new n.WebSQL(s&&s.size);case"IDB":return new a.IndexedDB(s&&s.version);case"RKS":case"LVL":return new o(s&&s.path);default:throw new Error(`Cannot find mode ${e}!`)}})},function(e,t,s){e.exports=s(7)},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(8),i=s(0),n=s(1);t.InanoSQLInstance=n.InanoSQLInstance;const a=s(9),o=s(10),l=s(14),h=s(0),u=s(5);class c{constructor(){this.version=n.VERSION,this.planetRadius=6371,this._Q=new i._nanoSQLQueue,this.state={activeAV:"",hasAnyEvents:!1,peers:[],pid:i.uuid(),id:i.uuid(),cacheId:i.uuid(),peerEvents:[],focused:!0,peerMode:!1,connected:!1,ready:!1,selectedTable:"",exportQueryObj:!1},this.config={id:"temp",queue:!1},this._tables={},this._fkRels={},this._tableIds={_util:"_util",_ttl:"_ttl"},this._queryCache={},this.filters={};const e=e=>"object"==typeof e?JSON.stringify(e):String(e),t=e=>t=>isNaN(t)||null===t?0:e(t);this.indexTypes={string:e,geo:e=>{},float:t(parseFloat),int:t(parseInt),number:t(parseFloat),date:t(parseInt),uuid:e,timeId:e,timeIdms:e},this.eventFNs={Core:{"*":new r.ReallySmallEvents},"*":{"*":new r.ReallySmallEvents}},this._checkTTL=this._checkTTL.bind(this),a.attachDefaultFns(this)}_rebuildFKs(){this.state.cacheId=i.uuid(),this._fkRels={},Object.keys(this._tables).forEach(e=>{const t=this._tables[e];Object.keys(t.indexes).forEach(s=>{const r=t.indexes[s];if(r.props&&r.props.foreignKey){const t=i.resolvePath(r.props.foreignKey.target),a=t.shift();this._fkRels[a]||(this._fkRels[a]=[]),this._fkRels[a].push({selfPath:t.map(e=>e.replace(/\[\]/gim,"")),selfIsArray:-1!==r.props.foreignKey.target.indexOf("[]"),childTable:e,childPath:r.path,childIsArray:r.isArray,childIndex:s,onDelete:r.props.foreignKey.onDelete||n.InanoSQLFKActions.NONE})}})})}doFilter(e,t,s,r){this.filters[e]?i.chainAsync(this.filters[e],(s,i,n)=>{this.filters[e][i](t,e=>{t=e,n()},r)}).then(()=>{s(t)}):s(t)}getCache(e,t){if(!this._queryCache[e])throw new Error(`Cache "${e}" not found!`);return t?this._queryCache[e].slice(t.offset,t.offset+t.limit):this._queryCache[e].slice()}clearCache(e){const t=void 0!==this._queryCache[e];return delete this._queryCache[e],t}clearTTL(e){const t=this.state.selectedTable+"."+e;return new Promise((e,s)=>{this.triggerQuery(Object.assign({},i.buildQuery(this,"_ttl","delete"),{where:["key","=",t]}),i.noop,e,s)})}expires(e){return new Promise((t,s)=>{const r=this.state.selectedTable+"."+e;let n=[];this.triggerQuery(Object.assign({},i.buildQuery(this,"_ttl","select"),{where:["key","=",r]}),e=>{n.push(e)},()=>{n.length?t({time:(n[0].date-Date.now())/1e3,cols:n[0].cols}):t({time:-1,cols:[]})},s)})}_checkTTL(){if(this.config.disableTTL)return;this._ttlTimer&&clearTimeout(this._ttlTimer);let e=0,t=0;const s=()=>{let r=[];this.triggerQuery(Object.assign({},i.buildQuery(this,"_ttl","select"),{limit:20,offset:20*e}),e=>{r.push(e)},()=>{r.length?i.chainAsync(r,(e,s,r)=>{if(e.date<Date.now()){const t=()=>{this.triggerQuery(Object.assign({},i.buildQuery(this,"_ttl","delete"),{where:["key","=",e.key]}),i.noop,r,i.throwErr)},s=e.key.split("."),n=s[0],a=-1===["float","int","number"].indexOf(this._tables[n].pkType)?s[1]:parseFloat(s[1]);if(e.cols.length){let s={};e.cols.forEach(e=>{s[e]=null}),this.triggerQuery(Object.assign({},i.buildQuery(this,n,"upsert"),{actionArgs:s,where:[this._tables[n].pkCol,"=",a]}),i.noop,t,i.throwErr)}else this.triggerQuery(Object.assign({},i.buildQuery(this,n,"delete"),{where:[this._tables[n].pkCol,"=",a]}),i.noop,t,i.throwErr)}else t=Math.max(t,e.date),r()}).then(()=>{e++,s()}):t&&(this._ttlTimer=setTimeout(this._checkTTL,t-Date.now()))},i.throwErr)};s()}selectTable(e){return e&&(this.state.selectedTable=e),this}getPeers(){return JSON.parse(localStorage.getItem("nsql-peers-"+this.state.id)||"[]")}_initPlugins(e){return new Promise((t,s)=>{let r={};(e.plugins||[]).forEach(e=>{(e.filters||[]).forEach(e=>{r[e.name]||(r[e.name]=[]);let t=e.priority;for(;r[e.name][t];)t++;r[e.name][t]=e.call})}),Object.keys(r).forEach(e=>{this.filters[e]=[],r[e].forEach(t=>{t&&this.filters[e].unshift(t)})});const i=(e,t)=>!t||!t.length||(1===t.length?e>=t[0]:e>=t[0]&&e<t[1]);let a=!1;(e.plugins||[]).forEach(t=>{if(t.dependencies){const r=t.dependencies||{};Object.keys(t.dependencies).forEach((o,l,h)=>{if("core"===o)i(n.VERSION,r[o])||(a=!0,s(`Plugin "${t.name}" requires a different core version of nano-sql!`));else{const n=(e.plugins||[]).reduce((e,t)=>t.name===o?t:e);n||(a=!0,s(`Plugin "${t.name}" requires plugin "${o}" but it isn't installed!`)),i(n.version,r[o])||(a=!0,s(`Plugin "${t.name}" requires a different version of "${o}"!`))}})}}),a||t()})}_saveTableIds(){return new Promise((e,t)=>{this.triggerQuery(Object.assign({},i.buildQuery(this,"_util","upsert"),{actionArgs:i.assign({key:"tableIds",value:this._tableIds})}),i.noop,e,t)})}presetQuery(e){if("string"!=typeof this.state.selectedTable)throw new Error("Can't get table queries without selecting a table!");if(!(-1!==Object.keys(this._tables[this.state.selectedTable].queries).indexOf(e)))throw new Error(`Can't find preset query ${e}!`);let t=!1;return{promise:s=>new Promise((r,n)=>{if(t)return void n("Query already streaming!");t=!0;const a=this._tables[this.state.selectedTable].queries[e].args;let o={};a&&(o=i.cleanArgs2(s,a,this));let l=[];this._tables[this.state.selectedTable].queries[e].call(this,o,e=>{l.push(e)},()=>{r(l)},n)}),stream:(s,r,n,a)=>{if(t)return void a("Query already using promise!");t=!0;const o=this._tables[this.state.selectedTable].queries[e].args;let l={};o&&(l=i.cleanArgs2(s,o,this)),this._tables[this.state.selectedTable].queries[e].call(this,l,r,n,a)}}}connect(e){return this._initPlugins(e).then(()=>new Promise((t,s)=>{this.doFilter("config",{res:e},e=>{t(e.res)},s)})).then(e=>(this.state.id=e.id||"nSQL_DB",this.config=Object.assign({plugins:[]},e),"undefined"!=typeof window&&e&&e.peer&&(this.state.peerMode=!0),new Promise((e,t)=>{this.doFilter("willConnect",{res:this},()=>{e()},t)}))).then(()=>new Promise((e,t)=>{this.adapter=u.resolveMode(this.config.mode||"TEMP",this.config),this.adapter.plugin&&(this.config.plugins||[]).push(this.adapter.plugin),this._initPlugins(this.config).then(()=>{this.adapter.nSQL=this,i.adapterFilters(this).connect(this.state.id,()=>{this.doFilter("postConnect",{res:this.config},t=>{this.config=t.res,e()},t)},t)}).catch(t),this.config.planetRadius&&(this.planetRadius=this.config.planetRadius)})).then(()=>{this.triggerEvent({target:"Core",targetId:this.state.id,path:"*",events:["connect"],time:Date.now()}),this.state.connected=!0;const e=["_util","_ttl"].concat((this.config.tables||[]).map(e=>e.name));return i.chainAsync(e,(e,t,s,r)=>{switch(e){case"_util":this.triggerQuery(Object.assign({},i.buildQuery(this,"_util","create table"),{actionArgs:{name:"_util",model:{"key:string":{pk:!0},"value:any":{}},_internal:!0}}),i.noop,()=>{this.triggerQuery(Object.assign({},i.buildQuery(this,"_util","select"),{where:["key","=","tableIds"]}),e=>{this._tableIds=Object.assign({},this._tableIds,e.value)},()=>{s()},r)},r);break;case"_ttl":this.triggerQuery(Object.assign({},i.buildQuery(this,"_ttl","create table"),{actionArgs:{name:"_ttl",model:{"key:string":{pk:!0},"table:string":{},"cols:string[]":{},"date:number":{}},_internal:!0}}),i.noop,s,r);break;default:const t=(this.config.tables||[]).filter(t=>t.name===e)[0];if(!t)return void r("Table not found!");this.triggerQuery(Object.assign({},i.buildQuery(this,e,"create table"),{actionArgs:t}),i.noop,s,r)}})}).then(()=>new Promise((e,t)=>{let s;this.triggerQuery(Object.assign({},i.buildQuery(this,"_util","select"),{where:["key","=","version"]}),e=>{e&&(s=e.value)},()=>{!s||s<2?this.triggerQuery(Object.assign({},i.buildQuery(this,"_util","upsert"),{actionArgs:{key:"version",value:n.VERSION}}),i.noop,e,t):e()},t)})).then(()=>new Promise((e,t)=>{if(!this.config.version)return void e();let s;this.triggerQuery(Object.assign({},i.buildQuery(this,"_util","select"),{where:["key","=","db-version"]}),e=>{e&&(s=e.value)},()=>{const r=(e,t,s)=>{this.triggerQuery(Object.assign({},i.buildQuery(this,"_util","upsert"),{actionArgs:{key:"db-version",value:e}}),i.noop,t,s)};if(s){const n=()=>{if(s===this.config.version)r(this.config.version||0,e,t);else{if(!this.config.onVersionUpdate)return void r(this.config.version||0,e,t);this.config.onVersionUpdate(s).then(e=>{r(s=e,()=>{i.setFast(n)},t)}).catch(t)}};n()}else r(this.config.version||0,e,t)},t)})).then(()=>new Promise((e,t)=>{const s={target:"Core",path:"*",targetId:this.state.id,events:["ready"],time:Date.now()};this.doFilter("ready",{res:s},t=>{this.triggerEvent(t.res),this.state.ready=!0,this.config.disableTTL||this._checkTTL(),this.config.peer&&this._initPeers(),e()},t)}))}_initPeers(){let e=0;this.state.pid=i.uuid(),this.state.peers=this.getPeers(),this.state.peers.unshift(this.state.pid),localStorage.setItem("nsql-peers-"+this.state.id,JSON.stringify(this.state.peers)),window.addEventListener("storage",t=>{if(t.key==="nsql-peers-"+this.state.id&&(this.state.peers=this.getPeers()),t.key&&0===t.key.indexOf(this.state.pid+".")){localStorage.removeItem(t.key);const e=JSON.parse(t.newValue||"{}");this.state.peerEvents.push(e.query.queryID||""),this.triggerEvent(Object.assign({},e,{types:["peer change"]})),i.setFast(()=>{this.triggerEvent(e)})}if(++e>50&&this.state.peers[0]===this.state.pid){e=0;let t=localStorage.length,s={};for(;t--;){const e=localStorage.key(t),r=e?e.match(/\w{8}-\w{4}-\w{4}-\w{4}-\w{8}/gim):null;if(e&&r){const t=(r||[""])[0];s[t]||(s[t]=[]),s[t].push(e)}}Object.keys(s).forEach(e=>{s[e].length>10&&(this.state.peers=this.state.peers.filter(t=>t!==e),s[e].forEach(e=>{localStorage.removeItem(e)}),localStorage.setItem("nsql-peers-"+this.state.id,JSON.stringify(this.state.peers)))})}}),window.onblur=(()=>{this.state.focused=!1}),window.onfocus=(()=>{this.state.peers=this.state.peers.filter(e=>e!==this.state.pid),this.state.peers.unshift(this.state.pid),localStorage.setItem("nsql-peers-"+this.state.id,JSON.stringify(this.state.peers)),this.state.focused=!0}),t.nSQL("*").on("change",e=>{const t=this.state.peerEvents.indexOf(e.query.queryID||"");-1===t?this.state.peers.filter(e=>e!==this.state.pid).forEach(t=>{localStorage.setItem(t+"."+e.query.queryID,JSON.stringify(e))}):this.state.peerEvents.splice(t,1)}),window.addEventListener("beforeunload",()=>(this.state.peers=this.state.peers.filter(e=>e!==this.state.pid),localStorage.setItem("nsql-peers-"+this.state.id,JSON.stringify(this.state.peers)),!1))}every(e){let t=0,s=[];for(;t<=e.length;)e.every?t%e.every==0&&s.push(t+(e.offset||0)):s.push(t+(e.offset||0)),t++;return s}on(e,t,s){let n=this,a=s||("string"!=typeof n.state.selectedTable?"":n.state.selectedTable);this.doFilter("onEvent",{res:{action:e,callback:t}},t=>{switch(t.res.action){case"connect":case"ready":case"disconnect":case"peer change":case"slow query":this.eventFNs.Core["*"].on(t.res.action,t.res.callback);break;case"select":case"change":case"delete":case"upsert":case"*":const s=i.resolvePath(a);this.eventFNs[s[0]]||(this.eventFNs[s[0]]={"*":new r.ReallySmallEvents});const o=s.filter((e,t)=>t>0).join(".")||"*";this.eventFNs[s[0]][o]||(this.eventFNs[s[0]][o]=new r.ReallySmallEvents),this.eventFNs[s[0]][o].on(t.res.action,t.res.callback);break;default:new Promise((t,s)=>{this.doFilter("customEvent",{res:{nameSpace:"",path:"*"},selectedTable:a,action:e,on:!0},t,s)}).then(s=>{if(!s.res.nameSpace)throw new Error(`Invalid event "${e}"!`);this.eventFNs[s.res.nameSpace]||(this.eventFNs[s.res.nameSpace]={"*":new r.ReallySmallEvents}),this.eventFNs[s.res.nameSpace][s.res.path]||(this.eventFNs[s.res.nameSpace][s.res.path]=new r.ReallySmallEvents),this.eventFNs[s.res.nameSpace][s.res.path].on(t.res.action,t.res.callback),n._refreshEventChecker()})}n._refreshEventChecker()},i.noop)}off(e,t,s){let n=this,a=s||"string"!=typeof n.state.selectedTable?"":n.state.selectedTable;this.doFilter("onEvent",{res:{action:e,callback:t}},t=>{switch(t.res.action){case"connect":case"ready":case"disconnect":case"peer change":case"slow query":this.eventFNs.Core["*"].off(t.res.action,t.res.callback);break;case"select":case"change":case"delete":case"upsert":case"*":const s=i.resolvePath(a);this.eventFNs[s[0]]||(this.eventFNs[s[0]]={"*":new r.ReallySmallEvents});const o=s.filter((e,t)=>t>0).join(".")||"*";this.eventFNs[s[0]][o]||(this.eventFNs[s[0]][o]=new r.ReallySmallEvents),this.eventFNs[s[0]][o].off(t.res.action,t.res.callback);break;default:new Promise((t,s)=>{this.doFilter("customEvent",{res:{nameSpace:"",path:"*"},selectedTable:a,action:e,on:!0},t,s)}).then(s=>{if(!s.res.nameSpace)throw new Error(`Invalid event "${e}"!`);this.eventFNs[s.res.nameSpace]||(this.eventFNs[s.res.nameSpace]={"*":new r.ReallySmallEvents}),this.eventFNs[s.res.nameSpace][s.res.path]||(this.eventFNs[s.res.nameSpace][s.res.path]=new r.ReallySmallEvents),this.eventFNs[s.res.nameSpace][s.res.path].off(t.res.action,t.res.callback),n._refreshEventChecker()})}n._refreshEventChecker()},i.noop)}_refreshEventChecker(){return this.state.hasAnyEvents=Object.keys(this.eventFNs).reduce((e,t)=>{if(!0===e)return!0;return Object.keys(this.eventFNs[t]).reduce((e,s)=>Object.keys(this.eventFNs[t][s].eventListeners).length+e,0)>0||e},!1),this}getView(e,t){return this._doAV("v",this.state.selectedTable,e,t)}doAction(e,t){return this._doAV("a",this.state.selectedTable,e,t)}_doAV(e,t,s,r){return"string"!=typeof this.state.selectedTable?Promise.reject("Can't do Action/View with selected table!"):new Promise((i,n)=>{this.doFilter("actionView",{res:{AVType:e,table:t,AVName:s,AVArgs:r}},i,n)}).then(e=>{const t="a"===e.res.AVType?"actions":"views",s=this._tables[e.res.table][t].reduce((t,s)=>s.name===e.res.AVName?s:t,null);return s?s.call(s.args?i.cleanArgs(s.args,e.res.AVArgs,this):{},this):new Promise((t,s)=>s(`${e.res.AVType} "${e.res.AVName}" Not Found!`))})}query(e,t){const s=this.state.activeAV;return this.state.activeAV="",new l._nanoSQLQueryBuilder(this,this.state.selectedTable,e,t,s)}triggerQuery(e,t,s,r){this.state.connected||"string"!=typeof e.table?this.doFilter("query",{res:e},e=>{this.config.queue&&!e.res.skipQueue?this._Q.newItem({query:e.res,onRow:t,complete:s,error:r},(e,t,s)=>{new o._nanoSQLQuery(this,e.query,e.onRow,()=>{t(),e.complete()},s=>{t(),e.error(s)})}):new o._nanoSQLQuery(this,e.res,e=>{t(e)},s,r)},r):r("nSQL: Can't do a query before the database is connected!")}triggerEvent(e,t){return this.doFilter("event",{res:e},e=>{this.state.hasAnyEvents&&i.setFast(()=>{e.res.events.forEach(s=>{if(t||Object.keys(this.eventFNs["*"]).forEach(t=>{this.eventFNs["*"][t].trigger(s,e.res)}),this.eventFNs[e.res.target])if("_all_"===e.res.path)Object.keys(this.eventFNs[e.res.target]).forEach(t=>{this.eventFNs[e.res.target][t].trigger(s,e.res)});else{if(!this.eventFNs[e.res.target][e.res.path])return;this.eventFNs[e.res.target][e.res.path].trigger(s,e.res)}})})},e=>{console.log("Event suppressed",e)}),this}default(e,t){if(e=e||{},!t&&"string"!=typeof this.state.selectedTable)throw new Error("Must select table to generate defualts!");if(t=t||this.state.selectedTable,!this._tables[t])throw new Error(`nSQL: Table "${t}" not found for generating default object!`);let s="";const r=(t,n,a)=>{let o={};if(n=n||{},a&&a.length&&-1!==a.indexOf("[]"))return Array.isArray(n)?n.map(e=>r(t,e,a.slice(0,a.lastIndexOf("[]")))):[];let l=!1;if(t.forEach(t=>{if("*"!==t.key){if(t.model)if(-1!==t.type.indexOf("[]")){const e=void 0!==n?n[t.key]:[];Array.isArray(e)?o[t.key]=e.map(e=>r(t.model,e,t.type.slice(0,t.type.lastIndexOf("[]")))):o[t.key]=[]}else o[t.key]=r(t.model,void 0!==n?n[t.key]:void 0);else{let r=void 0!==n[t.key]?i.cast(t.type,n[t.key],!1,this):"function"==typeof t.default?t.default(e):t.default;void 0!==t.max&&r>t.max&&(s=`Data error, column ${t.key} can't be greater than ${t.max}!`),void 0!==t.min&&r<t.min&&(s=`Data error, column ${t.key} can't be less than ${t.min}!`),o[t.key]=r}!t.notNull||null!==o[t.key]&&void 0!==o[t.key]||(s=`Data error, ${t.key} cannot be null!`),null===o[t.key]&&(o[t.key]=void 0)}else l=!0}),s.length)throw new Error(s);if(l&&n){const e=t.map(e=>e.key);Object.keys(n).filter(t=>-1===e.indexOf(t)).forEach(e=>{o[e]=n[e]})}return o};return r(this._tables[t].columns,e)}rawDump(e,t,s){const r=t?e:Object.keys(this._tables).filter(t=>!e.length||-1!==e.indexOf(t));return i.chainAsync(r,(e,r,n,a)=>{if(t){const t=-1!==e.indexOf(":")?e.split(":")[0]:e,r=-1!==e.indexOf(":")?[e.split(":")[1]]:Object.keys(this._tables[e].indexes);i.chainAsync(r,(e,r,n,a)=>{i.adapterFilters(this).readIndexKeys(t,e,"all",void 0,void 0,!1,(r,i)=>{s(t+"."+e,{indexId:i,rowId:r})},n,a)}).then(n).catch(a)}else i.adapterFilters(this).readMulti(e,"all",void 0,void 0,!1,t=>{s(e,t)},n,a||i.noop)})}rawImport(e,t,s){let r=0;const n=Object.keys(e).reduce((t,s)=>t+=e[s].length,0),a=Object.keys(this._tables),o=t?Object.keys(e):Object.keys(e).filter(e=>-1!==a.indexOf(e));return i.chainAsync(o,(a,o,l,h)=>{if(t){const t=a.split(".")[0],s=a.split(".")[1];i.chainAsync(e[a],(e,r,n,a)=>{i.adapterFilters(this).addIndexValue(t,s,e.rowId,e.indexId,n,a)}).then(l).catch(h)}else{const t=this._tables[a].pkCol;i.chainAsync(e[a],(e,o,l,h)=>{i.deepGet(t,e)||!h?i.adapterFilters(this).write(a,i.deepGet(t,e),e,e=>{l(),r++,s&&s(Math.round(r/n*1e4)/100)},h||i.noop):h("No primary key found, can't import: "+JSON.stringify(e))}).then(l).catch(h)}})}disconnect(){return new Promise((e,t)=>{this.doFilter("disconnect",{},()=>{i.adapterFilters(this).disconnect(e,t)},t)})}extend(e,...t){return new Promise((s,r)=>{this.doFilter("extend",{scope:e,args:t,res:null},s,r)})}loadJS(e,t,s){const r=this.state.selectedTable;if("string"!=typeof r)return Promise.reject("nSQL: Can't load JS into temporary table!");const n=e.length;let a=0;return(s?i.allAsync:i.chainAsync)(e,(e,s,o,l)=>{this.triggerQuery(Object.assign({},i.buildQuery(this,r,"upsert"),{actionArgs:e}),e=>{},()=>{a++,t&&t(a/n*1e4/100),o()},l)})}JSONtoCSV(e,t,s){let r=[];if(!e.length)return"";let i=[];return s?i=s:(e.forEach(e=>{i=Object.keys(e).concat(i)}),i=i.filter((e,t,s)=>s.indexOf(e)===t)),t&&r.push(i.map(e=>`"${e}"`).join(",")),e.forEach(e=>{r.push(i.map(t=>null===e[t]||void 0===e[t]?"":"string"==typeof e[t]?'"'+e[t].replace(/\"/g,'""')+'"':"boolean"==typeof e[t]?!0===e[t]?"true":"false":"object"==typeof e[t]?'"'+JSON.stringify(e[t]).replace(/\"/g,'""')+'"':e[t]).join(","))}),r.join("\n")}csvToArray(e){let t,s="",r=[""],i=[r],n=0,a=0,o=!0;for(t of e)'"'===t?(o&&t===s&&(r[n]+=t),o=!o):","===t&&o?t=r[++n]="":"\n"===t&&o?("\r"===s&&(r[n]=r[n].slice(0,-1)),r=i[++a]=[t=""],n=0):r[n]+=t,s=t;return i[0]}CSVtoJSON(e,t){let s=[];return e.split(/\r?\n|\r|\t/gim).map((e,r)=>{if(0!==r){if(String(e).trim().length<1)return;let r=this.csvToArray(e);if(!r)return;r=r.map(e=>e.trim());let i=s.length,n={};for(;i--;)if(r[i])if("true"===r[i]||"false"===r[i])n[s[i]]="true"===r[i];else if(0===r[i].indexOf("{")||0===r[i].indexOf("["))try{n[s[i]]=JSON.parse(r[i])}catch(e){n[s[i]]=r[i]}else 0===r[i].indexOf('"')?n[s[i]]=r[i].slice(1,r[i].length-1).replace(/\"\"/gim,'"'):n[s[i]]=r[i];return t?t(n):n}s=e.split(",").map(e=>e.substring(1,e.length-1))}).filter(e=>e)}loadCSV(e,t,s,r){const n=this.state.selectedTable;if("string"!=typeof n)return Promise.reject("nSQL: Can't load CSV into temporary table!");const a=this.CSVtoJSON(e,t),o=r?i.allAsync:i.chainAsync;let l=0;return o(a,(e,t,r,o)=>{this.triggerQuery(Object.assign({},i.buildQuery(this,n,"upsert"),{actionArgs:e}),i.noop,()=>{l++,s&&s(Math.round(l/a.length*1e4)/100),r()},o||i.noop)})}}t.nanoSQL=c,t.nSQLv1Config=(e=>{let t={},s={},r="";const i=e=>((r=e||r)&&!t[r]&&(t[r]={name:r,model:{},indexes:{},actions:[],views:[]}),{model:s=>{let n={};return t[r].model=s.reduce((e,t)=>{const s=t.key+":"+t.type;return e[s]={},t.props&&(-1!==t.props.indexOf("pk")&&(e[s].pk=!0),-1!==t.props.indexOf("ai")&&(e[s].ai=!0),n&&-1!==t.props.indexOf("idx")&&(n[s]={})),e},{}),t[r].indexes=n,i(e)},actions:s=>(t[r].actions=s,i(e)),views:s=>(t[r].views=s,i(e)),config:t=>(s=t,i(e)),table:e=>i(e),rowFilter:s=>(t[r].filter=s,i(e))});return e(i),Object.assign({},s,{tables:Object.keys(t).map(e=>t[e])})});let d=new c;t.nSQL=(e=>d.selectTable(e)),"undefined"!=typeof window&&(window["@nano-sql"]||(window["@nano-sql"]={}),window["@nano-sql"].core={nSQL:t.nSQL,nanoSQL:c,utilities:h,nSQLv1Config:t.nSQLv1Config})},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(){this.eventListeners={}}return e.prototype.on=function(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)},e.prototype.off=function(e,t){var s=this;this.eventListeners[e]&&this.eventListeners[e].length&&this.eventListeners[e].forEach(function(r,i){r===t&&s.eventListeners[e].splice(i,1)})},e.prototype.trigger=function(e){for(var t=[],s=1;s<arguments.length;s++)t[s-1]=arguments[s];this.eventListeners[e]&&this.eventListeners[e].forEach(function(e){return e.apply(void 0,t)})},e}();t.ReallySmallEvents=s,t.RSE=new s},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(0),i=s(3),n={},a=(e,...t)=>t.map(t=>parseFloat(isNaN(t)?r.getFnValue(e,t):t));t.attachDefaultFns=(e=>{e.functions={COUNT:{type:"A",aggregateStart:{result:0,row:{}},call:(e,t,s,i)=>(i&&"*"!==i?r.getFnValue(t,i)&&s.result++:s.result++,s.row=t,s)},MAX:{type:"A",aggregateStart:{result:void 0,row:{}},call:(e,t,s,i)=>{let n=r.getFnValue(t,i)||0;return void 0===s.result?(s.result=n,s.row=t):n>s.result&&(s.result=n,s.row=t),s}},MIN:{type:"A",aggregateStart:{result:void 0,row:{}},call:(e,t,s,i)=>{let n=r.getFnValue(t,i)||0;return void 0===s.result?(s.result=n,s.row=t):n<s.result&&(s.result=n,s.row=t),s}},GREATEST:{type:"S",call:(e,t,s,...i)=>{return{result:i.map(e=>isNaN(e)?r.getFnValue(t,e):parseFloat(e)).sort((e,t)=>e<t?1:-1)[0]}}},LEAST:{type:"S",call:(e,t,s,...i)=>{return{result:i.map(e=>isNaN(e)?r.getFnValue(t,e):parseFloat(e)).sort((e,t)=>e>t?1:-1)[0]}}},AVG:{type:"A",aggregateStart:{result:0,row:{},total:0,records:0},call:(e,t,s,i)=>{const n=parseFloat(r.getFnValue(t,i)||0)||0;return s.total+=isNaN(n)?0:n,s.records++,s.result=s.total/s.records,s.row=t,s}},SUM:{type:"A",aggregateStart:{result:0,row:{}},call:(e,t,s,i)=>{const n=parseFloat(r.getFnValue(t,i)||0)||0;return s.result+=isNaN(n)?0:n,s.row=t,s}},ADD:{type:"S",call:(e,t,s,...r)=>({result:a(t,r).reduce((e,t,s)=>0===s?t:e+t)})},SUB:{type:"S",call:(e,t,s,...r)=>({result:a(t,r).reduce((e,t,s)=>0===s?t:e-t)})},DIV:{type:"S",call:(e,t,s,r,...i)=>({result:a(t,i).reduce((e,t,s)=>0===s?t:e/t)})},MULT:{type:"S",call:(e,t,s,...r)=>({result:a(t,r).reduce((e,t,s)=>0===s?t:e*t)})},MOD:{type:"S",call:(e,t,s,r,i)=>{const[n,o]=a(t,r,i);return{result:n%o}}},PI:{type:"S",call:(e,t,s)=>({result:Math.PI})},TRUNCATE:{type:"S",call:(e,t,s,r,i)=>{const[n,o]=a(t,r,i);return{result:parseFloat(n.toFixed(o))}}},LOWER:{type:"S",call:(e,t,s,i)=>({result:String(r.getFnValue(t,i)).toLowerCase()})},TRIM:{type:"S",call:(e,t,s,i)=>({result:String(r.getFnValue(t,i)).trim()})},UPPER:{type:"S",call:(e,t,s,i)=>({result:String(r.getFnValue(t,i)).toUpperCase()})},CAST:{type:"S",call:(e,t,s,i,n)=>({result:r.cast(r.getFnValue(t,n),r.getFnValue(t,i),!1,e.parent)})},CONCAT:{type:"S",call:(e,t,s,...i)=>({result:i.map(e=>r.getFnValue(t,e)).join("")})},CONCAT_WS:{type:"S",call:(e,t,s,i,...n)=>({result:n.map(e=>r.getFnValue(t,e)).join(r.getFnValue(t,i))})},REPLACE:{type:"S",call:(e,t,s,i,n,a)=>{const o=String(r.getFnValue(t,i)),l=String(r.getFnValue(t,n)),h=String(r.getFnValue(t,a));return{result:o.replace(l,h)}}},STRCMP:{type:"S",call:(e,t,s,i,n)=>{const a=String(r.getFnValue(t,i)),o=String(r.getFnValue(t,n));return a<o?{result:-1}:a>o?{result:1}:{result:0}}},LEVENSHTEIN:{type:"S",call:(e,t,s,a,o)=>{const l=r.getFnValue(t,a),h=r.getFnValue(t,o),u=l+"::"+h;return n[u]||(n[u]=i(l,h)),{result:n[u]}}},IF:{type:"S",call:(e,t,s,i,n,a)=>{const o=i.split(/<|=|>|<=|>=/gim).map(e=>isNaN(e)?r.getFnValue(t,e):parseFloat(e)),l=i.match(/<|=|>|<=|>=/gim)[0];if(!l)return{result:r.getFnValue(t,a)};switch(l){case"=":return o[0]==o[1]?r.getFnValue(t,n):r.getFnValue(t,a);case">":return o[0]>o[1]?r.getFnValue(t,n):r.getFnValue(t,a);case"<":return o[0]<o[1]?r.getFnValue(t,n):r.getFnValue(t,a);case"<=":return o[0]<=o[1]?r.getFnValue(t,n):r.getFnValue(t,a);case">=":return o[0]<o[1]?r.getFnValue(t,n):r.getFnValue(t,a);default:return{result:r.getFnValue(t,a)}}}},CROW:{type:"S",call:(t,s,i,n,a,o)=>{const l=r.getFnValue(s,n+".lat"),h=r.getFnValue(s,n+".lon");return{result:r.crowDistance(l,h,parseFloat(a),parseFloat(o),e.planetRadius)}},checkIndex:(t,s,i)=>{if("<"===i[1]||"<="===i[1]){const n="string"==typeof t.table?e._tables[t.table].indexes:{},a=r.resolvePath(s[0]);let o=[];if(Object.keys(n).forEach(e=>{const t=n[e];"float"===t.type&&r.objectsEqual(t.path.slice(0,t.path.length-1),a)&&o.push(e.replace(".lat","").replace(".lon",""))}),2===o.length)return{index:o[0],parsedFn:{name:"CROW",args:s},comp:i[1],value:i[2]}}return!1},queryIndex:(t,s,i,n,a,o)=>{const l=t.table,h=`${s.index}.lat`,u=`${s.index}.lon`,c=s.comp,d=parseFloat(s.value||"0"),p=parseFloat(s.parsedFn?s.parsedFn.args[1]:"0"),y=parseFloat(s.parsedFn?s.parsedFn.args[2]:"0"),f=d/(2*e.planetRadius*Math.PI)*360;let g=[-1,1].map(e=>p+f*e),_=[],b=[],m=!1;const S=Math.max(90-f,0);if(Math.abs(g[0])>S||Math.abs(g[1])>S)m=!0,g[0]<-1*S&&(g=[-90,g[1]]),g[1]>S&&(g=[g[0],90]);else{const e=Math.max(Math.abs(g[0]),Math.abs(g[1]));if(_=[-1,1].map(t=>{return y+f*t/Math.cos(r.deg2rad(e))}),Math.abs(_[0])>180){const e=Math.abs(_[0])-180;b=[180-e,180]}if(Math.abs(_[1])>180){const e=Math.abs(_[1])-180;b=[-180,-180+e]}}let q={};r.allAsync([h,u,u],(s,i,n,a)=>{const o=[g,_,b][i];o.length?r.adapterFilters(e,t).readIndexKeys(l,s,"range",o[0],o[1],!1,(e,t)=>{q[e]?q[e].num++:q[e]={key:e,lat:0,lon:0,num:0},0===i?q[e].lat=t-90:q[e].lon=t-180},()=>{n(null)},a):n(null)}).then(()=>{let l=0;const h=(m?Object.keys(q):Object.keys(q).filter(t=>{if(q[t].num<1)return!1;const s=r.crowDistance(q[t].lat,q[t].lon,p,y,e.planetRadius);return"<"===c?s<d:s<=d})).map(e=>q[e]);m||!i?r.allAsync(h,(a,o,h,u)=>{r.adapterFilters(t.parent,t).read(t.table,a.key,a=>{if(!a)return void h(null);if(!m)return n(a,o),void h(null);const u=r.deepGet((s.parsedFn?s.parsedFn.args[0]:"")+".lat",a),f=r.deepGet((s.parsedFn?s.parsedFn.args[0]:"")+".lon",a),g=r.crowDistance(u,f,p,y,e.planetRadius);("<"===c?g<d:g<=d)&&(n(i?r.deepGet(e._tables[t.table].pkCol,a):a,l),l++),h(null)},u)}).catch(o).then(()=>{a()}):h.forEach((e,t)=>{n(e.key,t)})}).catch(o)}}},(Object.getOwnPropertyNames?Object.getOwnPropertyNames(Math):["abs","acos","asin","atan","atan2","ceil","cos","exp","floor","log","pow","random","round","sin","sqrt","tan"]).filter(e=>-1===["min","max"].indexOf(e)).forEach(t=>{e.functions[t.toUpperCase()]={type:"S",call:(e,s,r,...i)=>({result:Math[t].apply(null,a(s,...i))})}})})},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(1),i=s(0),n=s(5);t.secondaryIndexQueue={};const a={};class o{constructor(e,t,s,r,i){this.nSQL=e,this.query=t,this.progress=s,this.complete=r,this.error=i,this._queryBuffer=[],this._stream=!0,this._selectArgs=[],this._pkOrderBy=!1,this._idxOrderBy=!1,this._sortGroups=[],this._sortGroupKeys={},this.query.state="processing",this._indexesUsed=[],this._startTime=Date.now();const n=t.action.toLowerCase().trim();if(this._orderByRows=this._orderByRows.bind(this),this._onError=this._onError.bind(this),-1===["select","clone"].indexOf(n)&&"string"!=typeof t.table)return this.query.state="error",void this.error('Only "select" and "clone" queries are available for this resource!');if("string"==typeof t.table&&!this.nSQL.state.connected)return this.query.state="error",void this.error("Can't execute query before the database has connected!");const a=(e,t)=>"string"==typeof this.query.table&&this.query.table?e&&!this.query.actionArgs?(this.query.state="error",void this.error(`${this.query.action} query requires an additional argument!`)):void t():(this.query.state="error",void this.error(`${this.query.action} query requires a table argument!`)),o=()=>{"error"!==this.query.state&&(this.query.state="complete",this.complete())};switch(this.query.cacheID||(this.query.cacheID=this.query.queryID),n){case"select":this._select(o,this.error);break;case"upsert":a(!0,()=>{this._upsert(this.progress,this.complete,this.error)});break;case"delete":a(!1,()=>{this._delete(this.progress,this.complete,this.error)});break;case"show tables":this._showTables();break;case"describe":this._describe();break;case"describe indexes":this._describe("idx");break;case"drop":case"drop table":this._dropTable(this.query.table,o,this.error);break;case"create table":case"create table if not exists":a(!0,()=>{this._createTable(this.query.actionArgs,!1,s,o,this.error)});break;case"alter table":a(!0,()=>{this._createTable(this.query.actionArgs,!0,s,o,this.error)});break;case"rebuild indexes":a(!1,()=>{this._rebuildIndexes(this.progress,o,this.error)});break;case"conform rows":a(!1,()=>{this._conform(this.progress,o,this.error)});break;case"clone":a(!0,()=>{this._clone(this.progress,o,this.error)});break;default:this.nSQL.doFilter("customQuery",{res:void 0,query:this.query,onRow:s,complete:r,error:i},()=>{this.query.state="error",this.error(`Query type "${t.action}" not supported!`)},e=>{this.query.state="error",this.error(e)})}}_clone(e,t,s){const r=this.query.actionArgs&&this.query.actionArgs.mode,a=this.query.actionArgs&&this.query.actionArgs.getAdapter,o=this.query.actionArgs&&this.query.actionArgs.id||this.query.parent.state.id;if(!o||!r)return void s("Id & Mode required for clone query!");const l=n.resolveMode(r),h="*"!==this.query.table?[this.query.table]:Object.keys(this.nSQL._tables);let u={};l.connect(o,()=>{i.chainAsync(h,(t,r,n,a)=>{const o=this.query.parent._tables[t];o?l.createTable(this.query.parent._tableIds[o.name],o,()=>{u[o.name]=this.query.parent._tableIds[o.name],i.allAsync(Object.keys(o.indexes),(e,t,s,r)=>{const i=o.indexes[e];l.createIndex(this.query.parent._tableIds[o.name],e,i.type,s,r)}).then(()=>{const t=new i._nanoSQLQueue((t,s,r,n)=>{e({target:o.name,targetId:this.query.parent._tableIds[o.name],object:t},s),s++,l.write(this.query.parent._tableIds[o.name],i.deepGet(o.pkCol,t),t,r,n)},s,()=>{i.chainAsync(Object.keys(o.indexes),(t,s,r,n)=>{o.indexes[t];i.adapterFilters(this.query.parent,this.query).readIndexKeys(o.name,t,"all",void 0,void 0,!1,(r,a)=>{e({target:this.query.parent._tableIds[o.name]+"."+t,targetId:o.name+"."+t,object:{key:a,rowId:r}},s),s++,l.addIndexValue(this.query.parent._tableIds[o.name],t,r,a,i.noop,n)},r,n)}).then(()=>{n()}).catch(s)});i.adapterFilters(this.query.parent,this.query).readMulti(o.name,"all",void 0,void 0,!1,(e,s)=>{t.newItem(e)},()=>{t.finished()},s)}).catch(s)},s):a(`Table ${o} not found!`)}).then(()=>{l.createTable("_util",Object.assign({},i.blankTableDefinition,{name:"_util",model:{"key:string":{pk:!0},"value:any":{}}}),()=>{l.read("_util","tableIds",e=>{const r=Object.assign({},e&&e.value||{},u);l.write("_util","taleIds",{key:"tableIds",value:r},()=>{a?(a(l),t()):l.disconnect(()=>{t()},s)},s)},s)},s)}).catch(s)},s)}_conform(e,t,s){const r=this.query.table,n=this.query.actionArgs||function(e){return e};if(!this.nSQL._tables[r])return void s(new Error(`Table ${r} not found for conforming!`));const a=new i._nanoSQLQueue((t,n,a,o)=>{const l=this.nSQL.default(t,r);this.nSQL.doFilter("conformRow",{res:l,oldRow:t,query:this.query},s=>{this._diffUpdates(this.query.table,t,s.res,()=>{const o={target:r,path:"*",events:["upsert","change","*"],time:Date.now(),performance:Date.now()-this._startTime,result:s.res,oldRow:t,query:this.query,indexes:this._indexesUsed};this.nSQL.state.hasAnyEvents&&(this.nSQL.triggerEvent(o),Object.keys(this.nSQL.eventFNs[this.query.table]).forEach(e=>{"*"!==e&&(i.objectsEqual(i.deepGet(e,t),i.deepGet(e,s.res))||this.nSQL.triggerEvent({target:this.query.table,path:e,events:["upsert","change","*"],time:Date.now(),performance:Date.now()-this._startTime,result:s.res,oldRow:t,query:this.query,indexes:this._indexesUsed},!0))})),this._startTime=Date.now(),e(this.query.returnEvent?o:s.res,n),0,a()},o)},s)},s,()=>{t()});this._getRecords((e,t)=>{a.newItem(n(e))},()=>{a.finished()},s)}_getTable(e,t,s,r){const i=this.query.cacheID;if("function"==typeof s){if(a[i]||(a[i]={}),!a[i][e])return a[i][e]={loading:!0,rows:[],cache:!0},void s(t).then(t=>{const s=t.cache&&!t.filtered||!1;a[i][e]={loading:!1,rows:s?t.rows:[],cache:s},r(t)}).catch(this._onError);if(a[i][e].loading)return void setTimeout(()=>{this._getTable(e,t,s,r)},10);if(a[i][e].cache)return void r({filtered:!1,rows:a[i][e].rows,cache:!0});s(t).then(e=>{r(e)}).catch(this._onError)}else r({rows:s,filtered:!1,cache:!1})}_maybeJoin(e,t,s,r){if(!e[0])return s(t),void r();const n=(t,r,a)=>{const o=e[r];let l=0,h=[];if("cross"!==o.type&&!o.on)return this.query.state="error",void this.error(new Error("Non 'cross' joins require an 'on' parameter!"));const u=new Error("Must use 'AS' when joining temporary tables!");if("string"!=typeof o.with.table&&!o.with.as)return this.query.state="error",void this.error(u);if("string"!=typeof this.query.table&&!this.query.tableAS)return this.query.state="error",void this.error(u);const c=new i._nanoSQLQueue((t,i,a,o)=>{e[r+1]?n(t,r+1,a):(s(t),a())},this.error,a),d="string"==typeof o.with.table?this.nSQL._tables[o.with.table].pkCol:[],p=String(o.with.as||o.with.table),y=String(this.query.tableAS||this.query.table);this.nSQL.triggerQuery(Object.assign({},i.buildQuery(this.nSQL,o.with.table,"select"),{tableAS:o.with.as,cacheID:this.query.cacheID,where:o.on&&"cross"!==o.type?this._buildCombineWhereJoin(o.on,o.with.as||o.with.table,t):void 0,skipQueue:!0}),e=>{l++,"right"!==o.type&&"outer"!==o.type||h.push(d?i.deepGet(d,e):i.hash(JSON.stringify(e))),c.newItem(Object.assign({},t,{[p]:e}))},()=>{switch(o.type){case"left":0===l&&c.newItem(Object.assign({},t,{[p]:void 0})),c.finished();break;case"inner":case"cross":c.finished();break;case"outer":case"right":0===l&&"outer"===o.type&&c.newItem(Object.assign({},t,{[p]:void 0})),this.nSQL.triggerQuery(Object.assign({},i.buildQuery(this.nSQL,o.with.table,"select"),{skipQueue:!0,cacheID:this.query.cacheID,where:d?[d,"NOT IN",h]:void 0}),e=>{(d||-1===h.indexOf(i.hash(JSON.stringify(e))))&&c.newItem(Object.assign({},t,{[y]:void 0,[p]:e}))},()=>{c.finished()},e=>{this.query.state="error",this.error(e)})}},e=>{this.query.state="error",this.error(e)})};n({[String(this.query.tableAS||this.query.table)]:t},0,r)}_select(e,t){if(this._whereArgs=this.query.where?this._parseWhere(this.query.where,"string"!=typeof this.query.table||void 0!==this.query.union):{type:r.IWhereType.none},this._havingArgs=this.query.having?this._parseWhere(this.query.having,!0):{type:r.IWhereType.none},this._parseSelect(),"error"===this.query.state)return;const s=[this.query.offset||0,(this.query.offset||0)+(this.query.limit||0)],n=s[0]+s[1]>0;let o={};const l=e=>(this.query.distinct||[]).reduce((t,s)=>t+JSON.stringify(i.deepGet(s,e)||{}),"");if(this.query.union){let t=[],r=[],h=0;return void i.chainAsync(this.query.union.queries,(e,a,u)=>{e().then(e=>{r.length||(r=Object.keys(e[0])),this.query.where&&(e=e.filter((e,t)=>this._where(e,this._whereArgs.slowWhere))),e=e.map(e=>{if(this.query.union&&"distinct"===this.query.union.type){const s=i.hash(JSON.stringify(e));if(0===a)t.push(s);else{if(-1!==t.indexOf(s))return;t.push(s)}}return Object.keys(e).reduce((t,s,i)=>(i<r.length&&(t[r[i]]=e[s]),t),{})}).filter(e=>e),this.query.orderBy?this._queryBuffer=this._queryBuffer.concat(e.map(e=>{let t=!0;if(this.query.distinct){const s=l(e);o[s]?t=!1:o[s]=!0}const s=this._streamAS(e);return(!this.query.having||this._where(s,this._havingArgs.slowWhere))&&t?s:void 0}).filter(e=>e)):e.forEach((e,t)=>{let r=!0;if(this.query.distinct){const t=l(e);o[t]?r=!1:o[t]=!0}if(!r)return;const i=this._streamAS(e);(!this.query.having||this._where(i,this._havingArgs.slowWhere))&&(n?h>=s[0]&&h<s[1]&&this.progress(i,h):this.progress(i,h),h++)}),u()})}).then(()=>{if(this.query.orderBy){const e=this._orderBy.sort.length>1?this.quickSort(this._queryBuffer,this._orderBy):this._queryBuffer.sort(this._orderByRows);(n?e.slice(s[0],s[1]):e).forEach(this.progress)}this.query.cacheID&&this.query.cacheID===this.query.queryID&&delete a[this.query.cacheID],e()})}const h=Array.isArray(this.query.join)?this.query.join:[this.query.join];let u=0;const c=new i._nanoSQLQueue((e,t,s,r)=>{if(this.query.graph)this._graph(this.query.graph||[],this.query.tableAS||this.query.table,e,d,(t,r)=>{let i=!0;if(this.query.distinct){const e=l(t);o[e]?i=!1:o[e]=!0}if(!i)return u++,void s();const n=this._streamAS(t);this.query.having?this._where(this._streamAS(e),this._havingArgs.slowWhere)&&this.progress(n,u):this.progress(n,u),u++,s()});else{let t=!0;if(this.query.distinct){const s=l(e);o[s]?t=!1:o[s]=!0}if(!t)return u++,void s();this.progress(this._streamAS(e),u),u++,s()}},this._onError,()=>{this.query.cacheID&&this.query.cacheID===this.query.queryID&&delete a[this.query.cacheID],e()});let d=0;const p=new i._nanoSQLQueue((e,t,r,i)=>{this._maybeJoin(h,e,e=>{this._stream?((!n||d>=s[0]&&d<s[1])&&c.newItem(e),d++):this._queryBuffer.push(e)},r)},this.error,()=>{this._stream?c.finished():i.allAsync(this._queryBuffer,(e,t,s)=>{this._graph(this.query.graph||[],this.query.tableAS||this.query.table,e,t,s)}).then(t=>{this._queryBuffer=t,this._groupByRows(),this.query.having&&(this._queryBuffer=this._queryBuffer.filter(e=>this._where(e,this._havingArgs.slowWhere))),this.query.orderBy&&!this._hasOrdered&&(this._orderBy.sort.length>1?this._queryBuffer=this.quickSort(this._queryBuffer,this._orderBy):this._queryBuffer.sort(this._orderByRows)),n&&(this._queryBuffer=this._queryBuffer.slice(s[0],s[1])),this._queryBuffer.forEach((e,t)=>{let s=!0;if(this.query.distinct){const t=l(e);o[t]?s=!1:o[t]=!0}s&&this.progress(e,t)}),this.query.cacheID&&this.query.cacheID===this.query.queryID&&delete a[this.query.cacheID],e()})}),y="string"==typeof this.query.table;this._getRecords((e,t)=>{const s={target:this.query.table,path:"_all_",events:["select","*"],time:Date.now(),performance:Date.now()-this._startTime,result:e,query:this.query,indexes:this._indexesUsed};y&&this.nSQL.triggerEvent(s),this._startTime=Date.now(),this.query.returnEvent?this.progress(s,t):p.newItem(e)},()=>{this.query.returnEvent?e():p.finished()},t)}_groupByRows(){if(!this.query.groupBy&&!this._hasAggrFn)return void(this._queryBuffer=this._queryBuffer.map(e=>this._streamAS(e)));if((this._groupBy?this._queryBuffer.sort((e,t)=>this._sortObj(e,t,this._groupBy)):this._queryBuffer).forEach((e,t)=>{const s=this._groupBy.sort.map(t=>String(t.fn?i.execFunction(this.query,t.fn,e,{result:void 0}).result:i.deepGet(t.path,e))).join(".");void 0===this._sortGroupKeys[s]&&(this._sortGroupKeys[s]=this._sortGroups.length);const r=this._sortGroupKeys[s];this._sortGroups[r]||this._sortGroups.push([]),this._sortGroups[r].push(e)}),this.query.orderBy&&(this._hasOrdered=!0,this._sortGroups=this._sortGroups.map(e=>e.sort((e,t)=>this._sortObj(e,t,this._orderBy)))),this._queryBuffer=[],this._hasAggrFn){const e=()=>this._selectArgs.reduce((e,t,s)=>{const r=t.value.split("(").shift();return t.isFn&&this.nSQL.functions[r]&&"A"===this.nSQL.functions[r].type&&(e[s]={idx:s,name:t.value,aggr:i.assign(this.nSQL.functions[r].aggregateStart)}),e},[]);if(this._sortGroups.forEach(t=>{const s=e(),r=s.filter(e=>e)[0];t.reverse().forEach((e,t)=>{s.forEach((t,r)=>{t&&(s[r].aggr=i.execFunction(this.query,s[r].name,e,s[r].aggr))})}),this._queryBuffer.push(this._selectArgs.reduce((e,t,n)=>{const a=t.value;return e[t.as||a]=t.isFn&&s[n]?s[n].aggr.result:t.isFn?i.execFunction(this.query,t.value,s[r.idx].aggr.row,{result:void 0}).result:i.deepGet(t.value,s[r.idx].aggr.row)||null,e},{}))}),!this._queryBuffer.length){const t=e(),s=t.filter(e=>e)[0];this._queryBuffer.push(this._selectArgs.reduce((e,r,n)=>{const a=r.value;return e[r.as||a]=r.isFn&&t[n]?t[n].aggr.result:r.isFn?i.execFunction(this.query,r.value,t[s.idx].aggr.row,{result:void 0}).result:i.deepGet(r.value,t[s.idx].aggr.row)||null,e},{}))}}else this._sortGroups.forEach(e=>{this._queryBuffer.push(this._streamAS(e.shift()))})}_buildCombineWhereJoin(e,t,s){return"function"==typeof e?t=>e(t,s):("string"==typeof e[0]?[e]:e).map(e=>{if(Array.isArray(e[0]))return this._buildCombineWhereJoin(e,t,s);if("AND"===e||"OR"===e)return e;const r=i.resolvePath(e[0]),n=i.resolvePath(e[2]),a=r[0]!==t;return[a?n.slice(1).join("."):r.slice(1).join("."),a?-1!==e[1].indexOf(">")?e[1].replace(">","<"):e[1].replace("<",">"):e[1],i.deepGet(a?r:n,s)]})}_graph(e,t,s,r,n){const a=Array.isArray(e)?e:[e];a&&0!==a.length?i.allAsync(a,(e,r,n)=>{const a=new Error("Must use 'AS' when graphing temporary tables!");if("string"!=typeof e.with.table&&!e.with.as)return this.query.state="error",void this.error(a);if("string"!=typeof this.query.table&&!this.query.tableAS)return this.query.state="error",void this.error(a);s[e.key]=[];const o=this._buildCombineWhereJoin(e.on,e.with.as||e.with.table,{[t]:s});this._getTable(e.with.as||e.with.table,o,e.with.table,t=>{t.filtered?(t.rows.forEach(t=>{e.single?s[e.key]=t:s[e.key].push(t)}),n(null)):this.nSQL.triggerQuery(Object.assign({},i.buildQuery(this.nSQL,t.rows,"select"),{tableAS:e.with.as,actionArgs:e.select,where:o,limit:e.limit,offset:e.offset,orderBy:e.orderBy,groupBy:e.groupBy,graph:e.graph,skipQueue:!0,cacheID:this.query.cacheID}),t=>{e.single?s[e.key]=t:s[e.key].push(t)},()=>{n(null)},this._onError)})}).then(()=>{n(s,r)}):n(s,r)}_upsert(e,t,s){if(this.query.actionArgs||(s("Can't upsert without records!"),this.query.state="error"),-1!==this.query.table.indexOf(".")||-1!==this.query.table.indexOf("[")){const e=i.resolvePath(this.query.table);this.query.table=e.shift(),this.upsertPath=e}if(this._whereArgs=this.query.where?this._parseWhere(this.query.where):{type:r.IWhereType.none},"error"===this.query.state)return;let n=Array.isArray(this.query.actionArgs)?this.query.actionArgs:[this.query.actionArgs];const a=this.nSQL._tables[this.query.table];if(this._whereArgs.type===r.IWhereType.none)i.allAsync(n,(t,s,r,n)=>{const o=i.deepGet(a.pkCol,t);o?i.adapterFilters(this.nSQL,this.query).read(this.query.table,o,i=>{i?this._updateRow(t,i,t=>{e(t,s),r(null)},n):this._newRow(t,t=>{e(t,s),r(null)},n)},n):this._newRow(t,t=>{e(t,s),r(null)},n)}).then(()=>{t()}).catch(this._onError);else{if(n.length>1)return this.query.state="error",void s("Cannot upsert multiple records with where condition!");let r=0;const a=new i._nanoSQLQueue((t,s,i,a)=>{r++,this._updateRow(n[0],t,t=>{e(t,s),i()},a)},s,()=>{t()});this._getRecords((e,t)=>{a.newItem(e)},()=>{a.finished()},s)}}_updateRow(e,t,s,r){this.nSQL.doFilter("updateRow",{res:e,row:t,query:this.query},e=>{let n=this.nSQL.default(this.upsertPath?i.deepSet(this.upsertPath,i.maybeAssign(t),e.res):Object.assign({},t,e.res),this.query.table);this._diffUpdates(this.query.table,t,n,()=>{const e={target:this.query.table,path:"*",events:["upsert","change","*"],time:Date.now(),performance:Date.now()-this._startTime,result:n,oldRow:t,query:this.query,indexes:this._indexesUsed};this.nSQL.doFilter("updateRowEvent",{res:e,query:this.query},e=>{"string"==typeof this.query.table&&(this.nSQL.triggerEvent(e.res),this.nSQL.eventFNs[this.query.table]&&Object.keys(this.nSQL.eventFNs[this.query.table]).forEach(e=>{"*"!==e&&(i.objectsEqual(i.deepGet(e,t),i.deepGet(e,n))||this.nSQL.triggerEvent({target:this.query.table,path:e,events:["upsert","change","*"],time:Date.now(),performance:Date.now()-this._startTime,result:n,oldRow:t,query:this.query,indexes:this._indexesUsed},!0))}),this._startTime=Date.now()),s(this.query.returnEvent?e.res:n)},r)},r)},r)}_checkUniqueIndexes(e,t,s,r,n,a){i.allAsync(Object.keys(r),(n,a,o,l)=>{const h=this.nSQL._tables[this.query.table].indexes[n].props||{};if(h&&h.unique){let a=[];i.adapterFilters(this.nSQL,this.query).readIndexKey(e,n,r[n],e=>{e!==t&&a.push(e)},()=>{a.length>0?l({error:"Unique Index Collision!",row:s,query:this.query}):o(null)},l)}else o(null)}).then(n).catch(a)}_diffUpdates(e,t,s,r,n){const a=this._getIndexValues(this.nSQL._tables[this.query.table].indexes,s),o=this._getIndexValues(this.nSQL._tables[this.query.table].indexes,t),l=this.nSQL._tables[e];this._checkUniqueIndexes(e,i.deepGet(l.pkCol,t),t,a,()=>{i.allAsync(Object.keys(o).concat(["__pk__"]),(t,r,n,h)=>{if("__pk__"===t)i.adapterFilters(this.nSQL,this.query).write(e,i.deepGet(l.pkCol,s),s,e=>{i.deepSet(l.pkCol,s,e),n(null)},h);else{const e=this.query.table;if(!1===i.objectsEqual(a[t],o[t]))if(l.indexes[t].isArray){let r=a[t].filter((e,s,r)=>-1===o[t].indexOf(e)),u=o[t].filter((e,s,r)=>-1===a[t].indexOf(e));i.allAsync([r,u],(r,n,a)=>{r.length?i.allAsync(r,(r,a,o)=>{this._updateIndex(e,t,r,i.deepGet(l.pkCol,s),0===n,()=>{o(null)},h)}).then(a):a(null)}).then(n)}else i.chainAsync(["rm","add"],(r,n,u)=>{switch(r){case"add":this._updateIndex(e,t,a[t],i.deepGet(l.pkCol,s),!0,()=>{u(null)},h);break;case"rm":this._updateIndex(e,t,o[t],i.deepGet(l.pkCol,s),!1,()=>{u(null)},h)}}).then(n);else n(null)}}).then(r).catch(n)},n)}_updateIndex(e,s,r,n,a,o,l){const h={table:e,indexName:s,value:r,pk:n,addToIndex:a,done:o,err:l,query:this.query,nSQL:this.nSQL};this.nSQL.doFilter("updateIndex",{res:h,query:this.query},e=>{t.secondaryIndexQueue[this.nSQL.state.id+e.res.indexName].newItem(e.res,(e,t,s)=>{(e.addToIndex?i.adapterFilters(e.nSQL,e.query).addIndexValue:i.adapterFilters(e.nSQL,e.query).deleteIndexValue)(e.table,e.indexName,e.pk,e.value,()=>{e.done(),t()},s=>{e.err(s),t()})})},l)}_newRow(e,t,s){this.nSQL.doFilter("addRow",{res:e,query:this.query},e=>{const r=this.nSQL._tables[this.query.table];e.res=this.nSQL.default(i.maybeAssign(this.upsertPath?i.deepSet(this.upsertPath,{},e.res):e.res),this.query.table);const n=this._getIndexValues(this.nSQL._tables[this.query.table].indexes,e.res);this._checkUniqueIndexes(this.query.table,i.deepGet(r.pkCol,e.res),e.res,n,()=>{i.adapterFilters(this.nSQL,this.query).write(this.query.table,i.deepGet(r.pkCol,e.res),e.res,a=>{i.deepSet(r.pkCol,e.res,a),i.allAsync(Object.keys(n),(t,s,a,o)=>{if(r.indexes[t].isArray){const s=n[t]||[];i.allAsync(s,(s,n,a)=>{this._updateIndex(this.query.table,t,s,i.deepGet(r.pkCol,e.res),!0,()=>{a(null)},o)}).then(()=>{a(null)}).catch(o)}else this._updateIndex(this.query.table,t,n[t],i.deepGet(r.pkCol,e.res),!0,()=>{a(null)},o)}).then(()=>{const r={target:this.query.table,path:"*",events:["upsert","change","*"],time:Date.now(),performance:Date.now()-this._startTime,result:e.res,oldRow:void 0,query:this.query,indexes:this._indexesUsed};this.nSQL.doFilter("addRowEvent",{res:r,query:this.query},s=>{"string"==typeof this.query.table&&this.nSQL.triggerEvent(s.res),this._startTime=Date.now(),t(this.query.returnEvent?s.res:e.res)},s)})},s)},s)},s)}_delete(e,t,s){if(this._whereArgs=this.query.where?this._parseWhere(this.query.where):{type:r.IWhereType.none},"error"===this.query.state)return;const n=this.nSQL._tables[this.query.table],a=new i._nanoSQLQueue((t,s,a,o)=>{new Promise((e,s)=>{const n=this.query.table;this.nSQL._fkRels[n]&&this.nSQL._fkRels[n].length?i.allAsync(this.nSQL._fkRels[n],(e,s,n,a)=>{const o=i.deepGet(e.selfPath,t),l=i.cast("any[]",e.selfIsArray?o:[o]);i.allAsync(l,(t,s,o,l)=>{switch(e.onDelete){case r.InanoSQLFKActions.RESTRICT:let s=0;i.adapterFilters(this.nSQL,this.query).readIndexKey(e.childTable,e.childIndex,t,e=>{s++},()=>{s>0?l("Foreign key restraint error, can't delete!"):o()},a);break;case r.InanoSQLFKActions.CASCADE:let h=[];i.adapterFilters(this.nSQL,this.query).readIndexKey(e.childTable,e.childIndex,t,e=>{h.push(e)},()=>{this.nSQL.triggerQuery(Object.assign({},i.buildQuery(this.nSQL,e.childTable,"delete"),{where:[e.childPath.join("."),e.childIsArray?"INCLUDES":"IN",h]}),i.noop,o,l)},a);break;case r.InanoSQLFKActions.SET_NULL:let u=[];i.adapterFilters(this.nSQL,this.query).readIndexKey(e.childTable,e.childIndex,t,e=>{u.push(e)},()=>{this.nSQL.triggerQuery(Object.assign({},i.buildQuery(this.nSQL,e.childTable,"upsert"),{actionArgs:{[e.childPath.join(".")]:null},where:[e.childPath.join("."),e.childIsArray?"INCLUDES":"IN",h]}),i.noop,o,l)},a);break;default:n()}}).then(n).catch(a)}).then(e).catch(s):e()}).then(()=>{this._removeRowAndIndexes(n,t,t=>{e(t,s),a()},o)}).catch(o)},s,()=>{t()});this._getRecords((e,t)=>{a.newItem(e)},()=>{a.finished()},s)}_removeRowAndIndexes(e,t,s,r){const n=this._getIndexValues(e.indexes,t);this.nSQL.doFilter("deleteRow",{res:t,query:this.query},t=>{i.allAsync(Object.keys(n).concat(["__del__"]),(s,a,o)=>{if("__del__"===s)i.adapterFilters(this.nSQL,this.query).delete(this.query.table,i.deepGet(e.pkCol,t.res),()=>{o(null)},e=>{this.query.state="error",r(e)});else if(e.indexes[s].isArray){const a=n[s]||[];i.allAsync(a,(n,a,o)=>{this._updateIndex(this.query.table,s,n,i.deepGet(e.pkCol,t.res),!1,()=>{o(null)},r)}).then(o)}else this._updateIndex(this.query.table,s,n[s],i.deepGet(e.pkCol,t.res),!1,()=>{o(null)},this._onError)}).then(()=>{const e={target:this.query.table,path:"_all_",events:["change","delete","*"],time:Date.now(),performance:Date.now()-this._startTime,result:t.res,query:this.query,indexes:this._indexesUsed};this.nSQL.doFilter("deleteRowEvent",{res:e,query:this.query},e=>{"string"==typeof this.query.table&&this.nSQL.triggerEvent(e.res),this._startTime=Date.now(),s(this.query.returnEvent?e.res:t.res)},r)}).catch(r)},r)}_getIndexValues(e,t){return Object.keys(e).reduce((s,r)=>{const n=i.deepGet(e[r].path,t),a=e[r].type;return s[r]=e[r].isArray?(Array.isArray(n)?n:[]).map(e=>this.nSQL.indexTypes[a](e)):this.nSQL.indexTypes[a](n),s},{})}_showTables(){Object.keys(this.nSQL._tables).forEach((e,t)=>{this.progress({table:e},t)}),this.complete()}_describe(e="table"){if("string"!=typeof this.query.table)return this.query.state="error",void this.error({error:"Can't call describe on that!",query:this.query});if(!this.nSQL._tables[this.query.table])return this.query.state="error",void this.error({error:`Table ${this.query.table} not found!`,query:this.query});switch(e){case"table":this.nSQL._tables[this.query.table].columns.forEach((e,t)=>{this.progress(i.assign(e),t)});break;case"idx":Object.keys(this.nSQL._tables[this.query.table].indexes).forEach((e,t)=>{const s=this.nSQL._tables[this.query.table].indexes[e];this.progress(i.assign(s),t)})}this.complete()}_combineRows(e){return Object.keys(e).reduce((t,s)=>{const r=e[s];return r?(Object.keys(r).forEach(e=>{t[s+"."+e]=r[e]}),t):t},{})}_streamAS(e){const t=(this.query.distinct||[]).map(e=>({isFn:!1,value:e})),s=(this._selectArgs||[]).concat(t);if(s.length){let t={};return s.forEach(s=>{s.isFn?t[s.as||s.value]=i.execFunction(this.query,s.value,e,{}).result:t[s.as||s.value]=i.deepGet(s.value,e)}),this.query.join?this._combineRows(t):t}return this.query.join?this._combineRows(e):e}quickSort(e,t){if(e.length<2)return e;const s=e=>t.sort.reduce((t,s,r)=>{const n=s.fn?i.execFunction(this.query,s.fn,e,{result:void 0}).result:i.deepGet(s.path,e);return t.push({v:n,d:String(s.dir).toUpperCase()}),t},[]),r=(e,t)=>{let s=0,r=0;for(;r<e.length;)s||e[r].v===t[r].v||(s=(e[r].v>t[r].v?1:-1)*("DESC"===e[r].d?-1:1)),r++;return s},n=s(e[Math.floor(Math.random()*e.length)]);let a=[],o=[],l=[];for(let t of e){const e=r(s(t),n);e>0?l.push(t):e<0?a.push(t):o.push(t)}return this.quickSort(a,t).concat(o).concat(this.quickSort(l,t))}_orderByRows(e,t){return this._sortObj(e,t,this._orderBy)}_sortObj(e,t,s){return s.sort.reduce((s,r)=>{const n=r.fn?i.execFunction(this.query,r.fn,e,{result:void 0}).result:i.deepGet(r.path,e),a=r.fn?i.execFunction(this.query,r.fn,t,{result:void 0}).result:i.deepGet(r.path,t);return n===a?0:s||(n>a?1:-1)*("DESC"===r.dir?-1:1)},0)}_tableID(){return[0,1].map(()=>{let e=i.random16Bits().toString(16);for(;e.length<4;)e="0"+e;return e}).join("-")}_createTable(e,s,r,a,o){const l=this.nSQL._tableIds[e.name]||this._tableID();s||-1===Object.keys(this.nSQL._tables).indexOf(e.name)||(s=!0),new Promise((t,s)=>{let r=!1;const i=e.name;e._internal||0!==i.indexOf("_")&&null===i.match(/\s/g)&&null===i.match(/[\(\)\]\[\.]/g)?(Object.keys(e.model).forEach(t=>{const i=t.replace(/\s+/g,"-").split(":");1===i.length&&i.push("any"),i[0]&&null===i[0].match(/[\(\)\]\[\.]/g)&&0!==i[0].indexOf("_")||(r=!0,s({error:`Invalid Data Model at ${e.name+"."+t}! https://docs.nanosql.io/setup/data-models`,query:this.query}))}),r||t()):s({error:`Invalid Table Name ${e.name}! https://docs.nanosql.io/setup/data-models`,query:this.query})}).then(()=>new Promise((t,s)=>{this.nSQL.doFilter("configTable",{res:e,query:this.query},t,s)})).then(e=>{const t=(e,s)=>{let r={};if("string"==typeof e){let t=!1;const i=-1!==e.indexOf("[]"),n=e.replace(/\[\]/gim,"");if(0===s&&i)throw new Error("Can't use array types as table definition.");if(r=Object.keys(this.nSQL.config.types||{}).reduce((e,s)=>s===n[1]?(t=!0,(this.nSQL.config.types||{})[s]):e,{}),!1===t){if(0===s)throw new Error(`Type ${e} not found!`);return}}else r=e;return Object.keys(e).reduce((r,i)=>{return 0===(i.split(":")[1]||"any").indexOf("geo")?r[i]={default:{lat:0,lon:0},model:{"lat:float":{max:90,min:-90},"lon:float":{max:180,min:-180}}}:e[i].model?r[i]=Object.assign({},e[i],{model:t(e[i].model,s+1)}):r[i]=e[i],r},{})},s=e=>Object.keys(e).filter(e=>"*"!==e).map(t=>({key:t.split(":")[0],type:t.split(":")[1]||"any",ai:e[t].ai,pk:e[t].pk,default:e[t].default,notNull:e[t].notNull,max:e[t].max,min:e[t].min,model:e[t].model?s(e[t].model):void 0}));let r="";const a=t(e.res.model,0),o=e=>"string"==typeof e?"":Object.keys(e).reduce((t,s)=>e[s]&&e[s].pk?s.split(":")[1]:!t.length&&e[s].model?o(e[s].model):t,"");let h=e.res.indexes||{},u=!1;const c=(e,t)=>{if("string"==typeof t)return[];let s=!1;return Object.keys(t).reduce((r,i)=>t[i]&&t[i].pk?(s=!0,t[i].ai&&(u=!0),r.push(i.split(":")[0]),r):!s&&t[i].model?c(e.concat([i.split(":")[0]]),t[i].model):r,e)},d=e.res.primaryKey?e.res.primaryKey.split(":")[1]:o(e.res.model);let p={id:l,name:e.res.name,mode:e.res.mode?n.resolveMode(e.res.mode):void 0,model:a,columns:s(a),filter:e.res.filter,actions:e.res.actions||[],views:e.res.views||[],queries:(e.res.queries||[]).reduce((e,t)=>(e[t.name]=t,e),{}),indexes:Object.keys(h).map(e=>({id:i.resolvePath(e.split(":")[0]).join("."),type:(e.split(":")[1]||"string").replace(/\[\]/gim,""),isArray:-1!==(e.split(":")[1]||"string").indexOf("[]"),path:i.resolvePath(e.split(":")[0]),props:h[e]})).reduce((e,t)=>{return-1===Object.keys(this.nSQL.indexTypes).indexOf(t.type)?(r=`Index "${t.id}" does not have a valid type!`,e):(-1!==t.type.indexOf("geo")?(e[t.id+".lon"]={id:t.id+".lon",type:"float",isArray:!1,path:t.path.concat(["lon"]),props:{offset:180}},e[t.id+".lat"]={id:t.id+".lat",type:"float",isArray:!1,path:t.path.concat(["lat"]),props:{offset:90}}):e[t.id]=t,e)},{}),pkType:d,pkCol:e.res.primaryKey?i.resolvePath(e.res.primaryKey.split(":")[0]):c([],e.res.model),isPkNum:-1!==["number","int","float","date"].indexOf(d),ai:u};return 0===p.pkCol.length&&(p.pkCol=["_id"],p.pkType="uuid",p.model["_id:uuid"]={pk:!0},p.columns=s(t(p.model,0))),r&&r.length?Promise.reject(r):new Promise((e,t)=>{this.nSQL.doFilter("configTableSystem",{res:p,query:this.query},t=>{e(t.res)},t)})}).then(e=>{const t=this.nSQL._tables[this.query.table]&&this.nSQL._tables[this.query.table].mode;return e.mode||t?new Promise((r,i)=>{if(s&&e.mode===t)r(e);else{const s=()=>{e.mode?e.mode.connect(this.nSQL.state.id,()=>{r(e)},i):r(e)};t?t.disconnect(()=>{s()},i):s()}}):Promise.resolve(e)}).then(e=>{const n=s?Object.keys(this.nSQL._tables[this.query.table].indexes):[],a=Object.keys(e.indexes),o=a.filter(e=>-1===n.indexOf(e));let l=[e.name].concat(o);return r(e,0),i.chainAsync(l,(r,o,l,h)=>{if(0===o){const t={name:r,conf:e};if(this.nSQL._tableIds[t.name]=e.id,s){delete this.nSQL._tableIds[this.query.table];const e=n.filter(e=>-1===a.indexOf(e));i.allAsync(e,(e,t,s,n)=>{i.adapterFilters(this.nSQL,this.query).deleteIndex(r,e,()=>{s(null)},n)}).then(()=>{this.nSQL._tables[t.name]=t.conf,l(null)}).catch(h)}else i.adapterFilters(this.nSQL,this.query).createTable(t.name,t.conf,()=>{this.nSQL._tables[t.name]=t.conf,l(null)},h)}else{const s=e.indexes[r];t.secondaryIndexQueue[this.nSQL.state.id+s.id]=new i._nanoSQLQueue,i.adapterFilters(this.nSQL,this.query).createIndex(e.name,s.id,s.type,()=>{l(null)},h)}})}).then(()=>(this.nSQL._rebuildFKs(),"_util"===this.query.table?Promise.resolve():this.nSQL._saveTableIds())).then(()=>{a()}).catch(o)}_dropTable(e,t,s){new Promise((t,s)=>{this.nSQL._fkRels[e]&&this.nSQL._fkRels[e].length?i.allAsync(this.nSQL._fkRels[e],(e,t,s,n)=>{switch(e.onDelete){case r.InanoSQLFKActions.RESTRICT:let t=0;i.adapterFilters(this.nSQL,this.query).readIndexKeys(e.childTable,e.childIndex,"offset",0,1,!1,(e,s)=>{t++},()=>{t>0?n("Foreign key restraint error, can't drop!"):s()},n);break;case r.InanoSQLFKActions.CASCADE:let a=[];i.adapterFilters(this.nSQL,this.query).readIndexKeys(e.childTable,e.childIndex,"all",0,0,!1,(e,t)=>{a.push(e)},()=>{this.nSQL.triggerQuery(Object.assign({},i.buildQuery(this.nSQL,e.childTable,"delete"),{where:[e.childPath.join("."),e.childIsArray?"INCLUDES":"IN",a]}),i.noop,s,n)},n);break;case r.InanoSQLFKActions.SET_NULL:let o=[];i.adapterFilters(this.nSQL,this.query).readIndexKeys(e.childTable,e.childIndex,"all",0,0,!1,(e,t)=>{o.push(e)},()=>{this.nSQL.triggerQuery(Object.assign({},i.buildQuery(this.nSQL,e.childTable,"upsert"),{actionArgs:{[e.childPath.join(".")]:null},where:[e.childPath.join("."),e.childIsArray?"INCLUDES":"IN",a]}),i.noop,s,n)},n);break;default:s()}}).then(t).catch(s):t()}).then(()=>{let s=[];return Object.keys(this.nSQL._tables[e].indexes).forEach(e=>{s.push(e)}),s.push(e),i.chainAsync(s,(t,r,n,a)=>{r===s.length-1?i.adapterFilters(this.nSQL,this.query).dropTable(t,()=>{delete this.nSQL._tables[t],delete this.nSQL._tableIds[t],this.nSQL._saveTableIds().then(()=>{n(t)}).catch(a)},a):i.adapterFilters(this.nSQL,this.query).deleteIndex(e,t,n,a)}).then(()=>{t()})}).catch(s)}_onError(e){this.query.state="error",this.error(e)}_resolveFastWhere(e,t,s,r,n){if(t.index&&t.parsedFn)return void this.nSQL.functions[t.parsedFn.name].queryIndex(this.query,t,e,r,n,this._onError);const a="_pk_"===t.index,o=this.nSQL._tables[this.query.table].pkCol;let l=0;const h=new i._nanoSQLQueue((t,s,n,h)=>{t?a?(r(e?i.deepGet(o,t):t,0),n()):e?(r(t,l),l++,n()):i.adapterFilters(this.nSQL,this.query).read(this.query.table,t,e=>{e&&r(e,l),l++,n()},this.error):n()},this._onError,n);if(t.indexArray)switch(t.comp){case"INCLUDES LIKE":i.adapterFilters(this.nSQL,this.query).readIndexKeys(this.query.table,t.index,"range",t.value.replace(/\%/gim,"")+" ",t.value.replace(/\%/gim,"")+"~",s,e=>{h.newItem(e)},()=>{h.finished()},this._onError);break;case"INCLUDES":i.adapterFilters(this.nSQL,this.query).readIndexKey(this.query.table,t.index,t.value,e=>{h.newItem(e)},()=>{h.finished()},this.error);break;case"INTERSECT ALL":case"INTERSECT":let e={},r=0;i.allAsync(t.value||[],(s,n,a)=>{i.adapterFilters(this.nSQL,this.query).readIndexKey(this.query.table,t.index,s,t=>{r=n+1,t&&(e[t]=(e[t]||0)+1)},()=>{a(null)},this.error)}).then(()=>{("INTERSECT"===t.comp?Object.keys(e):Object.keys(e).filter(t=>e[t]===r)).forEach(e=>{h.newItem(e)}),h.finished()})}else switch(t.comp){case"=":e&&a?(r(t.value,0),n()):a?i.adapterFilters(this.nSQL,this.query).read(this.query.table,t.value,e=>{h.newItem(e),h.finished()},this.error):i.adapterFilters(this.nSQL,this.query).readIndexKey(this.query.table,t.index,t.value,e=>{h.newItem(e)},()=>{h.finished()},this.error);break;case"LIKE":a?i.adapterFilters(this.nSQL,this.query).readMulti(this.query.table,"range",t.value.replace(/\%/gim,"")+"0",t.value.replace(/\%/gim,"")+"Z",s,(e,t)=>{h.newItem(e)},()=>{h.finished()},this._onError):i.adapterFilters(this.nSQL,this.query).readIndexKeys(this.query.table,t.index,"range",t.value.replace(/\%/gim,"")+" ",t.value.replace(/\%/gim,"")+"~",s,e=>{h.newItem(e)},()=>{h.finished()},this._onError);break;case"BETWEEN":a?i.adapterFilters(this.nSQL,this.query).readMulti(this.query.table,"range",t.value[0],t.value[1],s,(e,t)=>{h.newItem(e)},()=>{h.finished()},this._onError):i.adapterFilters(this.nSQL,this.query).readIndexKeys(this.query.table,t.index,"range",t.value[0],t.value[1],s,e=>{h.newItem(e)},()=>{h.finished()},this._onError);break;case"IN":const o=s?t.value.sort((e,t)=>e<t?1:-1):t.value.sort((e,t)=>e>t?1:-1);e&&a?(o.forEach((e,t)=>r(e,t)),n()):i.allAsync(o,(e,s,r)=>{a?i.adapterFilters(this.nSQL,this.query).read(this.query.table,e,e=>{h.newItem(e),r()},this.error):i.adapterFilters(this.nSQL,this.query).readIndexKey(this.query.table,t.index,e,e=>{h.newItem(e)},()=>{r()},this.error)}).then(()=>{h.finished()})}}_fastQuery(e,t){if(this._whereArgs.fastWhere)if(1===this._whereArgs.fastWhere.length){const s=this._whereArgs.fastWhere[0],r=this._pkOrderBy&&"DESC"===this._orderBy.sort[0].dir;this._resolveFastWhere(!1,s,r,(t,s)=>{e(t,s)},t)}else{let s={},r=0;i.chainAsync(this._whereArgs.fastWhere,(e,t,i)=>{if(t%2==1)return void i();r=t;this._resolveFastWhere(!0,e,!1,e=>{s[e]=(s[e]||0)+1},i)}).then(()=>{let i=[];Object.keys(s).forEach(e=>{s[e]===r&&i.push(e)}),this._resolveFastWhere(!1,{index:"_pk_",col:this.nSQL._tables[this.query.table].pkCol.join("."),comp:"IN",value:i},!1,e,t)})}}_getRecords(e,t,s){const n=s=>{let i=0;for(;i<s.length;)this._whereArgs.type!==r.IWhereType.none?this._whereArgs.whereFn?this._whereArgs.whereFn(s[i],i)&&e(s[i],i):this._where(s[i],this._whereArgs.slowWhere)&&e(s[i],i):e(s[i],i),i++;t()};if("string"==typeof this.query.table)switch(this._whereArgs.type){case r.IWhereType.fast:this._fastQuery((t,s)=>{e(i.mutateRowTypes(t,this.query.table,this.nSQL),s)},t);break;case r.IWhereType.medium:this._fastQuery((t,s)=>{this._where(t,this._whereArgs.slowWhere)&&e(i.mutateRowTypes(t,this.query.table,this.nSQL),s)},t);break;case r.IWhereType.slow:case r.IWhereType.none:case r.IWhereType.fn:const s=this._pkOrderBy&&"DESC"===this._orderBy.sort[0].dir;i.adapterFilters(this.nSQL,this.query).readMulti(this.query.table,"all",void 0,void 0,s,(t,s)=>{this._whereArgs.type===r.IWhereType.slow?this._where(t,this._whereArgs.slowWhere)&&e(i.mutateRowTypes(t,this.query.table,this.nSQL),s):this._whereArgs.type===r.IWhereType.fn&&this._whereArgs.whereFn?this._whereArgs.whereFn(t,s)&&e(i.mutateRowTypes(t,this.query.table,this.nSQL),s):e(i.mutateRowTypes(t,this.query.table,this.nSQL),s)},()=>{t()},this._onError)}else"function"==typeof this.query.table?this._getTable(this.query.tableAS||i.uuid(),this.query.where,this.query.table,e=>{n(e.rows)}):Array.isArray(this.query.table)?n(this.query.table):s("Can't get selected table!")}_rebuildIndexes(e,t,s){const n=this.query.table;if(this.nSQL._tables[n])if(this._whereArgs=this.query.where?this._parseWhere(this.query.where):{type:r.IWhereType.none},this.query.where){const r=new i._nanoSQLQueue((t,s,r,i)=>{this._removeRowAndIndexes(this.nSQL._tables[n],t,()=>{this._newRow(t,r,i),e(t,s)},i)},s,()=>{t()});this._getRecords(e=>{r.newItem(e)},()=>{r.finished()},s)}else{const r=Object.keys(this.nSQL._tables[n].indexes);i.allAsync(r,(e,t,s,r)=>{i.adapterFilters(this.nSQL,this.query).deleteIndex(n,e,()=>{i.adapterFilters(this.nSQL,this.query).createIndex(n,e,this.nSQL._tables[n].indexes[e].type,()=>{s(null)},r)},r)}).then(()=>{const r=new i._nanoSQLQueue((t,s,r,a)=>{const o=this._getIndexValues(this.nSQL._tables[n].indexes,t),l=i.deepGet(this.nSQL._tables[n].pkCol,t);i.allAsync(Object.keys(o),(r,i,a,h)=>{const u=o[r];this._updateIndex(n,r,u,l,!0,()=>{e(t,s),a()},h)}).then(r).catch(a)},s,()=>{t()});this._getRecords(e=>{r.newItem(e)},()=>{r.finished()},s)}).catch(s)}else s(new Error(`Table ${n} not found for rebuilding indexes!`))}_where(e,t){if(t.length>1){let s="AND",r=!0,i=0;for(;i<t.length;){const n=t[i];if(i%2==1)s=n;else{let t=!1;t=Array.isArray(n[0])?this._where(e,n):this._compare(n,e),r=0===i?t:"AND"===s?r&&t:r||t}i++}return r}return this._compare(t[0],e)}_processLIKE(e,t){if(!o.likeCache[t]){let e="";const s=t.split("").length-1;o.likeCache[t]=new RegExp(t.split("").map((t,r)=>"\\"===e?(e=t,t):(e=t,"%"===t?".*":"_"===t?".":0===r?"^"+t:r===s?t+"$":t)).join(""),"gmi")}return"string"!=typeof e?"number"==typeof e?null!==String(e).match(o.likeCache[t]):null!==JSON.stringify(e).match(o.likeCache[t]):null!==e.match(o.likeCache[t])}_getColValue(e,t){return e.fnString?i.execFunction(this.query,e.fnString,t,{result:void 0}).result:i.deepGet(e.col,t)}_compare(e,t){const s=this._getColValue(e,t),r=e.value,n=e.comp;if("NULL"===r||"NOT NULL"===r){const e=-1!==[void 0,null,""].indexOf(s),t="="===n||"LIKE"===n;switch(r){case"NULL":return t?e:!e;case"NOT NULL":return t?!e:e}}if(-1!==["IN","NOT IN","BETWEEN","INTERSECT","INTERSECT ALL","NOT INTERSECT"].indexOf(n)&&!Array.isArray(r))return this.query.state="error",this.query.error(`WHERE "${n}" comparison requires an array value!`),!1;switch(n){case"=":return i.objectsEqual(r,s);case"!=":return!i.objectsEqual(r,s);case">":return s>r;case"<":return s<r;case"<=":return s<=r;case">=":return s>=r;case"IN":return-1!==r.indexOf(s);case"NOT IN":return-1===r.indexOf(s);case"REGEXP":case"REGEX":return null!==(s||"").match(r);case"LIKE":return this._processLIKE(s||"",r);case"NOT LIKE":return!this._processLIKE(s||"",r);case"BETWEEN":return r[0]<=s&&r[1]>=s;case"NOT BETWEEN":return r[0]>=s||r[1]<=s;case"INCLUDES":return-1!==(s||[]).indexOf(r);case"INCLUDES LIKE":return(s||[]).filter(e=>this._processLIKE(e,r)).length>0;case"NOT INCLUDES":return-1===(s||[]).indexOf(r);case"INTERSECT":return(s||[]).filter(e=>r.indexOf(e)>-1).length>0;case"INTERSECT ALL":return(s||[]).filter(e=>r.indexOf(e)>-1).length===r.length;case"NOT INTERSECT":return 0===(s||[]).filter(e=>r.indexOf(e)>-1).length;default:return!1}}_parseSort(e,t){const s=(e&&e.length?i.hash(JSON.stringify(e)):"")+this.nSQL.state.cacheId+this.nSQL.state.cacheId;if(!s)return{sort:[],index:""};if(o._sortMemoized[s])return o._sortMemoized[s];let r=!1;const n=e.map(e=>e.split(" ").map(e=>e.trim())).reduce((e,t)=>{const s=-1!==t[0].indexOf("(");return s&&(r=!0),e.push({path:s?[]:i.resolvePath(t[0]),fn:s?t[0]:void 0,dir:(t[1]||"asc").toUpperCase()}),e},[]);let a="";if(t&&!1===r&&1===n.length){const e="string"==typeof this.query.table?this.nSQL._tables[this.query.table].pkCol:[];if(n[0].path[0].length&&i.objectsEqual(n[0].path,e))a="_pk_";else{const e=Object.keys(this.nSQL._tables[this.query.table].indexes);let t=e.length;for(;t--&&!a;)i.objectsEqual(this.nSQL._tables[this.query.table].indexes[e[t]],n[0].path)&&(a=this.nSQL._tables[this.query.table].indexes[e[t]].id)}}return o._sortMemoized[s]={sort:n,index:a},o._sortMemoized[s]}_parseSelect(){const e=(this.query.actionArgs&&this.query.actionArgs.length?JSON.stringify(this.query.actionArgs):"")+this.nSQL.state.cacheId;this._orderBy=this._parseSort(this.query.orderBy||[],"string"==typeof this.query.table),this._groupBy=this._parseSort(this.query.groupBy||[],!1),e?o._selectArgsMemoized[e]?(this._hasAggrFn=o._selectArgsMemoized[e].hasAggrFn,this._selectArgs=o._selectArgsMemoized[e].args):((this.query.actionArgs||[]).forEach(e=>{const t=e.split(/\s+as\s+/i).map(e=>e.trim());if(-1!==t[0].indexOf("(")){const e=t[0].split("(")[0].trim().toUpperCase();this._selectArgs.push({isFn:!0,value:t[0],as:t[1],args:void 0}),this.nSQL.functions[e]?"A"===this.nSQL.functions[e].type&&(this._hasAggrFn=!0):(this.query.state="error",this.error(`Function "${e}" not found!`))}else this._selectArgs.push({isFn:!1,value:t[0],as:t[1]})}),"error"!==this.query.state&&(o._selectArgsMemoized[e]={hasAggrFn:this._hasAggrFn,args:this._selectArgs})):this._selectArgs=[];let t=!1;this._whereArgs.type===r.IWhereType.none?(t="_pk_"===this._orderBy.index)&&(this._pkOrderBy=!0):(t=!!(this._orderBy.index.length&&this._whereArgs.fastWhere&&i.objectsEqual(this._whereArgs.fastWhere[0].col,this._orderBy.sort[0].path)))&&(this._idxOrderBy=!0),(this._orderBy.sort.length&&!t||this._groupBy.sort.length||this._hasAggrFn)&&(this._stream=!1)}_parseWhere(e,t){const s=e||[],n=JSON.stringify(s,(e,t)=>t&&t.constructor&&"RegExp"===t.constructor.name?t.toString():t)+(t?"0":"1")+this.nSQL.state.cacheId;if(o._whereMemoized[n])return o._whereMemoized[n];if("function"==typeof s)return{type:r.IWhereType.fn,whereFn:s};if(!s.length)return o._whereMemoized[n]={type:r.IWhereType.none},o._whereMemoized[n];const a="string"==typeof this.query.table?Object.keys(this.nSQL._tables[this.query.table].indexes).map(e=>this.nSQL._tables[this.query.table].indexes[e]):[],l="string"==typeof this.query.table?this.nSQL._tables[this.query.table].pkCol:[],h="string"==typeof this.query.table?this.nSQL._tables[this.query.table].pkType:"",u=(e,s)=>{const r=!t&&0===s;return e.reduce((e,t,n)=>{if(n%2==1)return"string"!=typeof t?(this.query.state="error",this.error("Malformed WHERE statement!"),e):(e.push(t),e);if(!Array.isArray(t))return this.query.state="error",this.error("Malformed WHERE statement!"),e;if(Array.isArray(t[0]))e.push(u(t,s+1));else if(-1!==t[0].indexOf("(")){const s=t[0].split("(")[1].replace(")","").split(",").map(e=>e.trim()).filter(e=>e),n=t[0].split("(")[0].trim().toUpperCase();let a=!1;if(!this.nSQL.functions[n])return this.query.state="error",this.error(`Function "${n}" not found!`),e;if(r&&this.nSQL.functions[n]&&this.nSQL.functions[n].checkIndex){const r=this.nSQL.functions[n].checkIndex(this.query,s,t);r&&(this._indexesUsed.push(i.assign(t)),a=!0,e.push(r))}a||e.push({fnString:t[0],parsedFn:{name:n,args:s},comp:t[1],value:t[2]})}else{let s=!1;const n=r?i.resolvePath(t[0]):[];t[2]=Array.isArray(t[2])?t[2].map(e=>i.maybeDate(e)):i.maybeDate(t[2]),-1!==["=","BETWEEN","IN","LIKE"].indexOf(t[1])&&r&&("LIKE"!==t[1]||t[2].match(/.*\%$/gim))&&(i.objectsEqual(n,l)?"LIKE"===t[1]&&"string"!==h||(s=!0,this._indexesUsed.push(i.assign(t)),e.push({index:"_pk_",col:t[0],comp:t[1],value:t[2]})):a.forEach(r=>{"LIKE"===t[1]&&"string"!==r.type||!1===s&&i.objectsEqual(r.path,n)&&!1===r.isArray&&"NOT NULL"!==t[2]&&(s=!0,this._indexesUsed.push(i.assign(t)),e.push({index:r.id,col:t[0],comp:t[1],value:t[2]}))})),r&&!s&&-1!==["INCLUDES","INTERSECT","INTERSECT ALL","INCLUDES LIKE"].indexOf(t[1])&&a.forEach(r=>{i.objectsEqual(r.path,n)&&!0===r.isArray&&("INCLUDES LIKE"===t[1]&&"string"!==r.type||(s=!0,this._indexesUsed.push(i.assign(t)),e.push({index:r.id,indexArray:!0,col:t[0],comp:t[1],value:t[2]})))}),s||e.push({col:t[0],comp:t[1],value:t[2]})}return e},[])};let c=u("string"==typeof s[0]?[s]:s,0),d=!0,p=0,y=-1;for(;p<c.length&&d;)p%2==1?"AND"!==c[p]?d=!1:y=p:Array.isArray(c[p])||!c[p].index?d=!1:y=p,p++;if(y%2==0&&y++,-1===y||"AND"!==c[y]&&c[y])o._whereMemoized[n]={type:r.IWhereType.slow,slowWhere:c};else{const e=c.slice(y+1);o._whereMemoized[n]={type:e.length?r.IWhereType.medium:r.IWhereType.fast,slowWhere:e,fastWhere:c.slice(0,y)}}return o._whereMemoized[n]}}o.likeCache={},o._sortMemoized={},o._selectArgsMemoized={},o._whereMemoized={},t._nanoSQLQuery=o},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(1),i=s(0),n=s(2);t.SyncStorage=class extends n.nanoSQLMemoryIndex{constructor(e){super(!0,!1),this.useLS=e,this.plugin={name:"Sync Storage Adapter",version:r.VERSION},this._index={},this._rows={},this._ai={},this._tableConfigs={}}connect(e,t,s){this._id=e,t()}createTable(e,t,s,r){if(this._index[e]=[],this._rows[e]={},this._tableConfigs[e]=t,this.useLS){const t=localStorage.getItem(this._id+"->"+e+"_idx");t&&(this._index[e]=JSON.parse(t),this._ai[e]=parseFloat(localStorage.getItem(this._id+"->"+e+"_ai")||"0"))}s()}dropTable(e,t,s){this._index[e].forEach(t=>{this.useLS?localStorage.removeItem(this._id+"->"+e+"__"+t):delete this._rows[e][t]}),this.useLS&&localStorage.removeItem(this._id+"->"+e+"_idx"),delete this._index[e],delete this._rows[e],t()}disconnect(e,t){e()}write(e,t,s,r,n){if(void 0!==(t=t||i.generateID(this._tableConfigs[e].pkType,this._ai[e]+1))){if(this._tableConfigs[e].ai&&(this._ai[e]=Math.max(this._ai[e]||0,t)),-1===this._index[e].indexOf(t)){const s=i.binarySearch(this._index[e],t,!1);this._index[e].splice(s,0,t),this.useLS&&(localStorage.setItem(this._id+"->"+e+"_idx",JSON.stringify(this._index[e])),localStorage.setItem(this._id+"->"+e+"_ai",String(this._ai[e])))}i.deepSet(this._tableConfigs[e].pkCol,s,t),this.useLS?(localStorage.setItem(this._id+"->"+e+"__"+t,JSON.stringify(s)),r(t)):(this._rows[e][t]=i.deepFreeze(s),r(t))}else n(new Error("Can't add a row without a primary key!"))}read(e,t,s,r){if(this.useLS){const r=localStorage.getItem(this._id+"->"+e+"__"+t);s(r?JSON.parse(r):void 0)}else s(this._rows[e][t])}delete(e,t,s,r){let i=this._index[e].indexOf(t);-1!==i&&(this._index[e].splice(i,1),this.useLS&&localStorage.setItem(this._id+"->"+e+"_idx",JSON.stringify(this._index[e].keys()))),this.useLS?localStorage.removeItem(this._id+"->"+e+"__"+t):delete this._rows[e][t],s()}readMulti(e,t,s,r,n,a,o,l){let h={range:[s,r],offset:[s,s+r],all:[]}[t];const u=(()=>{switch(t){case"all":return this._index[e].slice();case"offset":const s=this._index[e].length-1;return n?this._index[e].slice(s-h[1],s-h[0]):this._index[e].slice(h[0],h[1]);case"range":let r=i.binarySearch(this._index[e],h[0],!1),a=i.binarySearch(this._index[e],h[1],!1);for(;this._index[e][a]>h[1];)a--;for(;this._index[e][r]<h[0];)r++;return this._index[e].slice(r,a+1)}return[]})();n&&u.reverse(),u.forEach((t,s)=>{this.useLS?a(JSON.parse(localStorage.getItem(this._id+"->"+e+"__"+t)||"{}"),s):a(this._rows[e][t],s)}),o()}getTableIndex(e,t,s){t(this._index[e].slice())}getTableIndexLength(e,t,s){t(this._index[e].length)}}},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(1),i=s(0),n=s(2);t.SQLiteAbstract=((e,t)=>{let s=[],r={};const n=e=>{if(-1===s.indexOf(e))throw Error("No table "+e+" found!");return`"${e}"`};return{createAI:(t,s)=>{e(!0,'CREATE TABLE IF NOT EXISTS "_ai" (id TEXT PRIMARY KEY UNIQUE, inc BIGINT)',[],i.noop,t,s)},createTable:(t,n,a,o,l)=>{s.push(t),r[t]=n,e(!0,`CREATE TABLE IF NOT EXISTS "${t}" (id ${n.isPkNum?"REAL":"TEXT"} PRIMARY KEY UNIQUE, data TEXT)`,[],i.noop,()=>{if(n.ai){let s=[];e(!1,'SELECT "inc" FROM "_ai" WHERE id = ?',[t],e=>{s.push(e)},()=>{s.length?(a[t]=parseInt(s[0].inc),o()):(a[t]=0,e(!0,'INSERT into "_ai" (id, inc) VALUES (?, ?)',[t,0],i.noop,o,l))},l)}else o()},l)},dropTable:(t,r,a)=>{e(!0,`DROP TABLE IF EXISTS ${n(t)}`,[],i.noop,()=>{e(!0,'UPDATE "_ai" SET inc = ? WHERE id = ?',[0,t],i.noop,()=>{s.splice(s.indexOf(t),1),r()},a)},a)},write:(t,s,r,a,o,l,h,u,c)=>{if(void 0===(a=a||i.generateID(t,h[r]+1)))return void c(new Error("Can't add a row without a primary key!"));l&&(h[r]=Math.max(a,h[r])),i.deepSet(s,o,a);const d=JSON.stringify(o),p=()=>{l&&a>=h[r]?e(!0,'UPDATE "_ai" SET inc = ? WHERE id = ?',[h[r],r],i.noop,()=>{u(a)},c):u(a)};let y=[];e(!1,`SELECT id FROM ${n(r)} WHERE id = ?`,[a],e=>{y.push(e)},()=>{y.length?e(!0,`UPDATE ${n(r)} SET data = ? WHERE id = ?`,[d,a],i.noop,p,c):e(!0,`INSERT INTO ${n(r)} (id, data) VALUES (?, ?)`,[a,d],i.noop,p,c)},c)},read:(t,s,r,i)=>{let a=[];e(!1,`SELECT data FROM ${n(t)} WHERE id = ?`,[s],e=>{a.push(e)},()=>{a.length?r(JSON.parse(a[0].data)):r(void 0)},i)},remove:(t,s,r,a)=>{e(!0,`DELETE FROM ${n(t)} WHERE id = ?`,[s],i.noop,()=>{r()},a)},getIndex:(t,s,r)=>{let i=[];e(!1,`SELECT id FROM ${n(t)} ORDER BY id`,[],e=>{i.push(e.id)},()=>{s(i)},r)},getNumberOfRecords:(t,s,r)=>{let i=[];e(!1,`SELECT COUNT(*) FROM ${n(t)}`,[],e=>{i.push(e)},()=>{s(i[0]["COUNT(*)"])},r)},readMulti:(t,s,r,i,a,o,l,h)=>{let u=`SELECT data FROM ${n(t)}`;"range"===s&&(u+=" WHERE id BETWEEN ? AND ?");let c=u+=a?" ORDER BY id DESC":" ORDER BY id";if("offset"===s){c+=` LIMIT ${i} OFFSET ${a?r+1:r}`}e(!1,c,"range"===s?[r,i]:[],(e,t)=>{o(JSON.parse(e.data),t)},()=>{l()},h)}}});t.WebSQL=class extends n.nanoSQLMemoryIndex{constructor(e,s){super(!1,!1),this.plugin={name:"WebSQL Adapter",version:r.VERSION},this._size=1e3*(e||0)*1e3,this._ai={},this._query=this._query.bind(this),this._tableConfigs={},this._sqlite=t.SQLiteAbstract(this._query,s||500)}connect(e,t,s){this._id=e;try{this._db=window.openDatabase(this._id,String(this.nSQL.config.version)||"1.0",this._id,i.isAndroid?5e6:this._size)}catch(e){s(e)}i.setFast(()=>{this._sqlite.createAI(t,s)})}createTable(e,t,s,r){this._tableConfigs[e]=t,this._sqlite.createTable(e,t,this._ai,s,r)}_query(e,t,s,r,i,n){const a=e=>{e.executeSql(t,s,(e,t)=>{for(let e=0;e<t.rows.length;e++)r(t.rows.item(e),e);i()},(e,t)=>(n(t),!1))};e?this._db.transaction(a):this._db.readTransaction(a)}dropTable(e,t,s){this._sqlite.dropTable(e,t,s)}disconnect(e,t){e()}write(e,t,s,r,i){this._sqlite.write(this._tableConfigs[e].pkType,this._tableConfigs[e].pkCol,e,t,s,this._tableConfigs[e].ai,this._ai,r,i)}read(e,t,s,r){this._sqlite.read(e,t,s,r)}delete(e,t,s,r){this._sqlite.remove(e,t,s,r)}readMulti(e,t,s,r,i,n,a,o){this._sqlite.readMulti(e,t,s,r,i,n,a,o)}getTableIndex(e,t,s){this._sqlite.getIndex(e,t,s)}getTableIndexLength(e,t,s){this._sqlite.getNumberOfRecords(e,t,s)}}},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(1),i=s(0),n=s(2);t.IndexedDB=class extends n.nanoSQLMemoryIndex{constructor(e){super(!1,!1),this.version=e,this.plugin={name:"IndexedDB Adapter",version:r.VERSION},this._db={},this._ai={},this._tableConfigs={}}connect(e,t,s){this._id=e,t()}createTable(e,t,s,r){let n=1;this._tableConfigs[e]=t;const a=i.hash(JSON.stringify(t.columns));this.version?n=this.version:(n=parseInt(localStorage.getItem(this._id+"_"+e+"_idb_version")||"1"),(localStorage.getItem(this._id+"_"+e+"_idb_hash")||a)!==a&&n++,localStorage.setItem(this._id+"_"+e+"_idb_version",String(n)),localStorage.setItem(this._id+"_"+e+"_idb_hash",a));const o=indexedDB.open(this._id+"_"+e,n);this._ai[e]=parseInt(localStorage.getItem(this._id+"_"+e+"_idb_ai")||"0"),o.onerror=r,o.onupgradeneeded=(s=>{this._db[e]=s.target.result,this._db[e].objectStoreNames.contains(e)||this._db[e].createObjectStore(e,{keyPath:t.pkCol.join(".")})}),o.onsuccess=(t=>{this._db[e]=t.target.result,s()})}dropTable(e,t,s){const r=this._db[e].transaction(e,"readwrite");r.onerror=s;const i=r.objectStore(e).clear();i.onerror=s,i.onsuccess=(()=>{this._db[e].close(),delete this._db[e],localStorage.removeItem(this._id+"_"+e+"_idb_version"),localStorage.removeItem(this._id+"_"+e+"_idb_hash"),localStorage.removeItem(this._id+"_"+e+"_idb_ai"),t()})}disconnect(e,t){i.allAsync(Object.keys(this._db),(e,t,s,r)=>{this._db[e].close(),i.setFast(()=>{s()})}).then(e).catch(t)}store(e,t,s,r){const i=this._db[e].transaction(e,t);i.onabort=r,i.onerror=r,s(i,i.objectStore(e))}write(e,t,s,r,n){void 0!==(t=t||i.generateID(this._tableConfigs[e].pkType,this._ai[e]+1))?(this._ai[e]=Math.max(t,this._ai[e]),this._tableConfigs[e].ai&&(this._ai[e]=i.cast("int",Math.max(this._ai[e]||0,t)),localStorage.setItem(this._id+"_"+e+"_idb_ai",String(this._ai[e]))),i.deepSet(this._tableConfigs[e].pkCol,s,t),this.store(e,"readwrite",(e,i)=>{try{i.put(s).onsuccess=(()=>{r(t)})}catch(e){n(e)}},n)):n(new Error("Can't add a row without a primary key!"))}read(e,t,s,r){this.store(e,"readonly",(e,r)=>{const i=r.get(t);i.onerror=(e=>{s(void 0)}),i.onsuccess=(()=>{s(i.result)})},r)}delete(e,t,s,r){this.store(e,"readwrite",(e,i)=>{const n=i.delete(t);n.onerror=r,n.onsuccess=(e=>{s()})},r)}readMulti(e,t,s,r,i,n,a,o){let l=0;const h="offset"===t?s:0,u=h+r;let c=!0;this.store(e,"readonly",(e,d)=>{if(d.getAll){const e=d.getAll("range"!==t?void 0:IDBKeyRange.bound(s,r,!1,!1),"offset"!==t||i?void 0:r+s);e.onsuccess=(e=>{const o=i?e.target.result.reverse():e.target.result;if("offset"===t){const e=i?1:0;o.slice(s+e,s+r+e).forEach(n)}else o.forEach(n);a()}),e.onerror=o}else d.openCursor("range"!==t?void 0:IDBKeyRange.bound(s,r,!1,!1),i?"prev":"next").onsuccess=(e=>{const r=e.target.result;if(r){if("offset"===t){if(c){const e=i?h+1:h;return r.advance(e),l=e,void(c=!1)}(i?u>=l:u>l)&&n(r.value,l-s)}else n(r.value,l);l++,r.continue()}else a()})},o)}getTableIndex(e,t,s){let r=[];this.store(e,"readonly",(s,n)=>{n.openCursor().onsuccess=(s=>{const n=s.target.result;n?(r.push(i.deepGet(this._tableConfigs[e].pkCol,n.value)),n.continue()):t(r)})},s)}getTableIndexLength(e,t,s){this.store(e,"readonly",(r,i)=>{const n=r.objectStore(e).count();n.onsuccess=(()=>{t(n.result)}),n.onerror=s},s)}}},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(0),i=s(4);var n;t._nanoSQLQueryBuilder=class{constructor(e,t,s,i,n){this._db=e,this._AV=n||"",this._query="string"==typeof s?Object.assign({},r.buildQuery(e,t,s),{comments:[],state:"pending",action:s,actionArgs:i,result:[]}):Object.assign({},s(e),{state:"pending",result:[]})}where(e){return this._query.where=e,this}orderBy(e){return Array.isArray(e)?this._query.orderBy=e:this._query.orderBy=Object.keys(e).map(t=>`${t} ${String(e[t]).toUpperCase()}`),this}distinct(e){return this._query.distinct=e,this}groupBy(e){return Array.isArray(e)?this._query.groupBy=e:this._query.groupBy=Object.keys(e).map(t=>`${t} ${String(e[t]).toUpperCase()}`),this}having(e){return this._query.having=e,this}join(e){const t="Join commands requires table and type arguments!";return Array.isArray(e)?e.forEach(e=>{e.with.table&&e.type||(this._error=t)}):e.with.table&&e.type||(this._error=t),this._query.join=e,this}limit(e){return this._query.limit=e,this}comment(e){return this._query.comments.push(e),this}tag(e){return this._query.tags.push(e),this}extend(e,...t){return this._query.extend.push({scope:e,args:t}),this}union(e,t){return this._query.union={queries:e,type:t?"all":"distinct"},this}offset(e){return this._query.offset=e,this}emit(){return this._query}ttl(e=60,t){if("upsert"!==this._query.action)throw new Error("nSQL: Can only do ttl on upsert queries!");return this._query.ttl=e,this._query.ttlCols=t||[],this}graph(e){return this._query.graph=e,this}from(e){return"string"==typeof e||Array.isArray(e)?this._query.table=e:(this._query.table=e.table,this._query.tableAS=e.as),this}into(e){return this._query.table=e,this}on(e){return this._query.table=e,this}toCSV(e){return this.exec().then(t=>Promise.resolve(this._db.JSONtoCSV(t,e)))}copyTo(e,t){return this._query.copyTo={table:e,mutate:t||(e=>e)},this}exec(e){return new Promise((t,s)=>{let r=[];this.stream(e=>{e&&r.push(e)},()=>{t(r)},s,e)})}listen(e){return new a(this._query,e&&e.debounce,e&&e.unique,e&&e.compareFn)}stream(e,t,s,i){if(this._query.returnEvent=i,this._db.state.exportQueryObj)e(this._query),t&&t();else{const i=this._query.copyTo?new r._nanoSQLQueue((t,s,i,n)=>{this._query.parent.triggerQuery(Object.assign({},r.buildQuery(this._query.parent,this._query.copyTo&&this._query.copyTo.table||"","upsert"),{actionArgs:this._query.copyTo&&this._query.copyTo.mutate(t)}),r.noop,()=>{e(t),i()},n)},s,()=>{t&&t()}):void 0;this._db.triggerQuery(this._query,t=>{i?i.newItem(t):e(t)},()=>{i?i.finished():t&&t()},s||r.noop)}}cache(e,t,s){const i=r.uuid();let n=[],a=!1,o=0;const l=s||{pageSize:0,onPage:r.noop};this.stream(e=>{n.push(e),l.pageSize&&l.onPage&&n.length%l.pageSize==0&&(a=!0,l.onPage(o,n.slice(n.length-l.pageSize)),o++,l.doNotCache&&(n=[]))},()=>{l.pageSize&&l.onPage&&(!a||l.doNotCache?l.onPage(0,n.slice()):l.onPage(o,n.slice(o*l.pageSize))),l.doNotCache?(n=[],e("",0)):(this._db._queryCache[i]=n,e(i,n.length))},t)}},function(e){e[e.stream=0]="stream",e[e.exec=1]="exec"}(n||(n={}));class a{constructor(e,t=500,s=!1,n=i){if(this.query=e,this.debounce=t,this.unique=s,this.compareFn=n,this._listenTables=[],this._active=!0,this.trigger=this.trigger.bind(this),this._doQuery=this._doQuery.bind(this),this._throttleTrigger=this._doQuery.bind(this),this._cbs={stream:[r.noop,r.noop,r.noop,!1],exec:[r.noop,!1]},"string"!=typeof e.table)throw new Error("Can't listen on dynamic tables!");if("select"!==e.action)throw new Error("Can't listen to this kind of query!");if(this._listenTables.push(e.table),e.join){const t=Array.isArray(e.join)?e.join:[e.join];this._listenTables.concat(this._getTables(t))}if(e.graph){const t=Array.isArray(e.graph)?e.graph:[e.graph];this._listenTables.concat(this._getTables(t))}this._listenTables=this._listenTables.filter((e,t,s)=>s.indexOf(e)===t),this._throttleTrigger=r.throttle(this,this._doQuery,t),this._listenTables.forEach(t=>{e.parent.on("change",this._throttleTrigger,t)})}_getTables(e){let t=[];return e.forEach(e=>{e.with&&e.with.table&&"string"==typeof e.with.table&&t.push(e.with.table);const s=e.graph;if(s){const e=Array.isArray(s)?s:[s];t.concat(this._getTables(e))}}),t}_doQuery(){if(this._active&&void 0!==this._mode)switch(this._mode){case n.stream:this.query.returnEvent=this._cbs.stream[3],this.query.parent.triggerQuery(this.query,this._cbs.stream[0],this._cbs.stream[1],this._cbs.stream[2]);break;case n.exec:this.query.returnEvent=this._cbs.exec[1];let e=[];this.query.parent.triggerQuery(this.query,t=>{e.push(t)},()=>{if(this.unique){let t=!1;(t=!this._oldValues||(this._oldValues.length!==e.length||!this.compareFn(this._oldValues,e)))&&(this._oldValues=e,this._cbs.exec[0](r.assign(e)))}else this._cbs.exec[0](e)},e=>{this._cbs.exec[0]([],e)})}}_maybeError(){if(void 0!==this._mode)throw new Error("Listen can't have multiple exports!")}trigger(){this._throttleTrigger()}stream(e,t,s,r){if(this.unique)throw new Error("Can't use unique with stream listener!");this._maybeError(),this._mode=n.stream,this._cbs.stream=[e,t,s,r||!1],this._doQuery()}exec(e,t){this._maybeError(),this._mode=n.exec,this._cbs.exec=[e,t||!1],this._doQuery()}unsubscribe(){this._active=!1,this._listenTables.forEach(e=>{this.query.parent.off("change",this._throttleTrigger,e)})}}}])});