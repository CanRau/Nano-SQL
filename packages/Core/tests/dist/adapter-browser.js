!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(window,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=8)}([function(e,t,n){(function(e){Object.defineProperty(t,"__esModule",{value:!0});var r=n(4);t.blankTableDefinition={id:"",model:{},columns:[],foreignKeys:[],indexes:{},actions:[],views:[],pkType:"string",pkCol:[],isPkNum:!1,ai:!1},t.binarySearch=function(e,n,r,i,o){var s=i||0,a=o||e.length;if(e[s]>=n)return r?-1:s;if(e[a]<=n)return r?-1:a+1;var u=Math.floor((s+a)/2);return n==e[u]?u:a-1==s?r?-1:a:n>e[u]?t.binarySearch(e,n,r,u,a):n<e[u]?t.binarySearch(e,n,r,s,u):r?-1:a},t.titleCase=function(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()},t.slugify=function(e){return String(e).replace(/\s+/g,"-").replace(/[^0-9a-z\-]/gi,"").toLowerCase()},t.getWeekOfYear=function(e){var t=new Date(e.getFullYear(),0,1);return Math.ceil(((e.getTime()-t.getTime())/864e5+t.getDay()+1)/7)},t.buildQuery=function(e,n,r){return{table:n||e.state.selectedTable,parent:e,action:r,state:"pending",result:[],time:Date.now(),queryID:t.uuid(),extend:[],comments:[],tags:[]}},t.adapterFilters=function(e,t){return{write:function(n,r,i,o,s){e.doFilter("adapterWrite",{result:{table:n,pk:r,row:i,complete:o,error:s},query:t},function(t){t&&e.adapter.write(e.tableIds[t.table],t.pk,t.row,function(e){t.complete(e)},t.error)},s)},read:function(n,r,i,o){e.doFilter("adapterRead",{result:{table:n,pk:r,complete:i,error:o},query:t},function(t){t&&e.adapter.read(e.tableIds[t.table],t.pk,function(e){e?t.complete(e):t.complete(void 0)},t.error)},o)},readMulti:function(n,r,i,o,s,a,u,c){e.doFilter("adapterReadMulti",{result:{table:n,type:r,offsetOrLow:i,limitOrHigh:o,reverse:s,onRow:a,complete:u,error:c},query:t},function(t){t&&e.adapter.readMulti(e.tableIds[t.table],t.type,t.offsetOrLow,t.limitOrHigh,t.reverse,function(e,n){t.onRow(e,n)},function(){t.complete()},t.error)},c)},connect:function(n,r,i){e.doFilter("adapterConnect",{result:{id:n,complete:r,error:i},query:t},function(t){t&&e.adapter.connect(t.id,t.complete,t.error)},i)},disconnect:function(n,r){e.doFilter("adapterDisconnect",{result:{complete:n,error:r},query:t},function(t){t&&e.adapter.disconnect(t.complete,t.error)},r)},createTable:function(n,r,i,o){e.doFilter("adapterCreateTable",{result:{tableName:n,tableData:r,complete:i,error:o},query:t},function(t){t&&e.adapter.createTable(e.tableIds[t.tableName],t.tableData,t.complete,t.error)},o)},dropTable:function(n,r,i){e.doFilter("adapterDropTable",{result:{table:e.tableIds[n],complete:r,error:i},query:t},function(t){t&&e.adapter.dropTable(t.table,t.complete,t.error)},i)},delete:function(n,r,i,o){e.doFilter("adapterDelete",{result:{table:e.tableIds[n],pk:r,complete:i,error:o},query:t},function(t){t&&e.adapter.delete(t.table,t.pk,t.complete,t.error)},o)},getTableIndex:function(n,r,i){e.doFilter("adapterGetTableIndex",{result:{table:e.tableIds[n],complete:r,error:i},query:t},function(t){t&&e.adapter.getTableIndex(t.table,t.complete,t.error)},i)},getTableIndexLength:function(n,r,i){e.doFilter("adapterGetTableIndexLength",{result:{table:e.tableIds[n],complete:r,error:i},query:t},function(t){t&&e.adapter.getTableIndexLength(t.table,t.complete,t.error)},i)},createIndex:function(n,r,i,o,s){e.doFilter("adapterCreateIndex",{result:{table:e.tableIds[n],indexName:r,type:i,complete:o,error:s},query:t},function(t){t&&e.adapter.createIndex(t.table,t.indexName,t.type,t.complete,t.error)},s)},deleteIndex:function(n,r,i,o){e.tables[n].indexes[r]?e.doFilter("adapterDeleteIndex",{result:{table:e.tableIds[n],indexName:r,complete:i,error:o},query:t},function(t){t&&e.adapter.deleteIndex(t.table,t.indexName,t.complete,t.error)},o):o({error:"Index "+r+" not found!"})},addIndexValue:function(n,r,i,o,s,a){if(e.tables[n].indexes[r]){var u=o;"number"==typeof u&&e.tables[n].indexes[r].props&&e.tables[n].indexes[r].props.offset&&(u+=e.tables[n].indexes[r].props.offset||0),e.doFilter("adapterAddIndexValue",{result:{table:e.tableIds[n],indexName:r,key:i,value:u,complete:s,error:a},query:t},function(t){t&&e.adapter.addIndexValue(t.table,t.indexName,t.key,t.value,t.complete,t.error)},a)}else a({error:"Index "+r+" not found!"})},deleteIndexValue:function(n,r,i,o,s,a){if(e.tables[n].indexes[r]){var u=o;"number"==typeof u&&e.tables[n].indexes[r].props&&e.tables[n].indexes[r].props.offset&&(u+=e.tables[n].indexes[r].props.offset||0),e.doFilter("adapterDeleteIndexValue",{result:{table:e.tableIds[n],indexName:r,key:i,value:u,complete:s,error:a},query:t},function(t){t&&e.adapter.deleteIndexValue(t.table,t.indexName,t.key,t.value,t.complete,t.error)},a)}else a({error:"Index "+r+" not found!"})},readIndexKey:function(n,r,i,o,s,a){if(e.tables[n].indexes[r]){var u=i;"number"==typeof u&&e.tables[n].indexes[r].props&&e.tables[n].indexes[r].props.offset&&(u+=e.tables[n].indexes[r].props.offset||0),e.doFilter("adapterReadIndexKey",{result:{table:e.tableIds[n],indexName:r,pk:u,onRowPK:o,complete:s,error:a},query:t},function(t){t&&e.adapter.readIndexKey(t.table,t.indexName,t.pk,t.onRowPK,t.complete,t.error)},a)}else a({error:"Index "+r+" not found!"})},readIndexKeys:function(n,r,i,o,s,a,u,c,l){var f=o,d=s;e.tables[n].indexes[r]?("number"==typeof f&&"number"==typeof d&&"range"===i&&e.tables[n].indexes[r]&&e.tables[n].indexes[r].props.offset&&(f+=e.tables[n].indexes[r].props.offset||0,d+=e.tables[n].indexes[r].props.offset||0),e.doFilter("adapterReadIndexKey",{result:{table:e.tableIds[n],indexName:r,type:i,offsetOrLow:f,limitOrHigh:d,reverse:a,onRowPK:u,complete:c,error:l},query:t},function(t){t&&e.adapter.readIndexKeys(t.table,t.indexName,t.type,t.offsetOrLow,t.limitOrHigh,t.reverse,t.onRowPK,t.complete,t.error)},l)):l({error:"Index "+r+" not found!"})}}},t.noop=function(){},t.throwErr=function(e){throw new Error(e)},t.nan=function(e){return"number"==typeof e?e:isNaN(e)?0:parseFloat(e)},t.assign=function(e){return e?JSON.parse(JSON.stringify(e)):e},t.objectsEqual=function(e,n){if(e===n)return!0;if("object"!=typeof e)return!1;if(!e||!n)return!1;var r=Object.keys(e),i=Array.isArray(e)?e.length===n.length:r.length===Object.keys(n).length;if(!i)return!1;for(var o=r.length;o--&&i;){var s=r[o];i="object"==typeof e[s]?t.objectsEqual(e[s],n[s]):e[s]===n[s]}return i};var i=function(){function e(e,t,n){this.processItem=e,this.onError=t,this.onComplete=n,this._items=[],this._going=!1,this._done=!1,this._count=0,this._triggeredComplete=!1,this._progressBuffer=this._progressBuffer.bind(this)}return e.prototype._progressBuffer=function(){var e=this;if(!this._triggeredComplete){if(this._done&&!this._items.length)return this._triggeredComplete=!0,void(this.onComplete&&this.onComplete());if(this._items.length){var n=function(){e._count++,e._count%100==0?t.setFast(e._progressBuffer):e._progressBuffer()},r=this._items.shift()||[];r[1]?r[1](r[0],n,this.onError?this.onError:t.noop):this.processItem&&this.processItem(r[0],this._count,n,this.onError?this.onError:t.noop)}else this._going=!1}},e.prototype.finished=function(){this._done=!0,this._triggeredComplete||this._going||this._items.length||(this._triggeredComplete=!0,this.onComplete&&this.onComplete())},e.prototype.newItem=function(e,t){this._items.push([e,t]),this._going||(this._going=!0,this._progressBuffer())},e}();t._nanoSQLQueue=i,t.chainAsync=function(e,n){return new Promise(function(r,i){if(e&&e.length){var o=[],s=0,a=function(){s<e.length?n(e[s],s,function(e){e&&o.push(e||0),++s%500==0?t.setFast(a):a()},function(e){i(e)}):r(o.length?o:void 0)};a()}else r([])})},t.allAsync=function(e,t){return Promise.all((e||[]).map(function(e,n){return new Promise(function(r,i){t(e,n,r,i)})}))};var o="undefined"==typeof window?"":navigator.userAgent||"";t.isSafari=0!==o.length&&(/^((?!chrome|android).)*safari/i.test(o)||/iPad|iPhone|iPod/.test(o)&&!window.MSStream),t.isMSBrowser=0!==o.length&&(o.indexOf("MSIE ")>0||o.indexOf("Trident/")>0||o.indexOf("Edge/")>0),t.isAndroid=/Android/.test(o),t.random16Bits=function(){if("undefined"==typeof crypto)return Math.round(Math.random()*Math.pow(2,16));if(crypto.getRandomValues){var t=new Uint16Array(1);return crypto.getRandomValues(t),t[0]}return void 0!==e&&e._crypto.randomBytes?e._crypto.randomBytes(2).reduce(function(e,t){return t*e}):Math.round(Math.random()*Math.pow(2,16))},t.throttle=function(e,t,n){var r=!1;return function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];r||(r=!0,setTimeout(function(){t.apply(e,i),r=!1},n))}},t.timeid=function(e){for(var n=Math.round((new Date).getTime()/(e?1:1e3)).toString();n.length<(e?13:10);)n="0"+n;for(var r=(t.random16Bits()+t.random16Bits()).toString(16);r.length<5;)r="0"+r;return n+"-"+r},t.intersect=function(e,t){return!(!e||!t)&&(!(!e.length||!t.length)&&(e||[]).filter(function(e){return-1!==(t||[]).indexOf(e)}).length>0)},t.uuid=function(){var e,n,r="";return[r,r,r,r,r,r,r,r].reduce(function(i,o,s){for(e=t.random16Bits(),n=3===s?4:4===s?(e%16&3|8).toString(16):r,e=e.toString(16);e.length<4;)e="0"+e;return i+([2,3,4,5].indexOf(s)>-1?"-":r)+(n+e).slice(0,4)},r)},t.hash=function(e){for(var t=5381,n=e.length;n;)t=33*t^e.charCodeAt(--n);return(t>>>0).toString(16)},t.generateID=function(e,n){var r={int:function(e){return e},float:function(e){return e},uuid:t.uuid,timeId:function(){return t.timeid()},timeIdms:function(){return t.timeid(!0)}};return r[e]?r[e](n||1):void 0},t.cleanArgs=function(e,n,r){var i={},o=e.length;for(Object.keys(r.config.types||{});o--;){var s=e[o].split(":");s.length>1?i[s[0]]=t.cast(s[1],n[s[0]]||void 0,!0,r):i[s[0]]=n[s[0]]||void 0}return i},t.isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},t.objSort=function(e,n){return function(r,i){var o=e?t.deepGet(e,r)>t.deepGet(e,i)?-1:1:r>i?-1:1;return n?-1*o:o}},t.execFunction=function(e,n,r,i){var o,s=n.match(/\((.*)\)/gim);if(!s[0])return{result:void 0};var a=s[0].substr(1,s[0].length-2).split(/\,\s?(?![^\(]*\))/).map(function(e){return e.trim()}),u=n.split("(").shift(),c=a.map(function(n){return-1!==n.indexOf("(")?t.execFunction(e,n,r,i).result:n});return e.parent.functions[u]?(o=e.parent.functions[u]).call.apply(o,[e,r,i].concat(c)):{result:void 0}},t.cast=function(e,n,r,i){if("any"===e||"blob"===e||"*"===e)return n;if(-1!==e.indexOf("[]")){var o=e.slice(0,e.lastIndexOf("[]"));return Array.isArray(n)?n.map(function(e){return t.cast(o,e,r)}):[]}var s=typeof n,a={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},u=i&&i.config.types||{};if(-1!==Object.keys(u).indexOf(e)){if(t.isObject(n)){var c=[],l="",f=u[e].reduce(function(e,o){var s=o.split(":");return-1!==o.indexOf("*")?(l=o[1]||"*",e):(c.push(s[0]),e[s[0]]=t.cast(s[1],n[s[0]],r,i),e)},{});return l&&l.length&&Object.keys(n).forEach(function(e){-1===c.indexOf(e)&&(f[e]=t.cast(l,n[e],r,i))}),f}return{}}var d=function(e,i){switch(e){case"safestr":return d("string",i).replace(/[&<>"'`=\/]/gim,function(e){return a[e]});case"int":return"number"!==s||i%1!=0?parseInt(i||0):i;case"number":case"float":return"number"!==s?parseFloat(i||0):i;case"array":return Array.isArray(i)?i:[];case"uuid":case"timeId":case"timeIdms":case"string":return"string"!==s?String(i):i;case"object":case"obj":case"map":return t.isObject(i)?i:{};case"boolean":case"bool":return!0===i||1===i}return r?n:null};if(null==n)return null;var h=d(String(e||"").toLowerCase(),n);return void 0!==h&&["int","float","number"].indexOf(e)>-1&&isNaN(h)?0:h},t.rad2deg=function(e){return 180*e/Math.PI},t.deg2rad=function(e){return e*(Math.PI/180)},t.crowDistance=function(e,n,r,i,o){void 0===o&&(o=6371);var s=t.deg2rad(r-e),a=t.deg2rad(i-n),u=Math.pow(Math.sin(s/2),2)+Math.cos(t.deg2rad(e))*Math.cos(t.deg2rad(r))*Math.pow(Math.sin(a/2),2);return o*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))},t.levenshtein=function(e,t){return r(e,t)};var s={};t.resolvePath=function(e){if(!e||!e)return[];var t=e;if(s[t])return s[t];var n=-1!==e.indexOf("[")?e.split(/\.|\[/gim).map(function(e){return e.replace(/\]/gim,"")}):e.split(".");return s[t]=n,s[t]},t.getFnValue=function(e,n){return n.match(/\".*\"|\'.*\'/gim)?n.replace(/\"|\'/gim,""):t.deepGet(n,e)},t.deepFreeze=function(e){return Object.getOwnPropertyNames(e||{}).forEach(function(n){var r=e[n];"object"==typeof r&&null!==r&&(e[n]=t.deepFreeze(r))}),Object.freeze(e)},t.deepSet=function(e,n,r){var i=function(e,n,o){e[n+1]?(o[e[n]]&&(Array.isArray(o[e[n]])||t.isObject(o[e[n]]))||(isNaN(e[n+1])?o[e[n]]={}:o[e[n]]=[]),i(e,n+1,o[e[n]])):o[e[n]]=r};return i(Array.isArray(e)?e:t.resolvePath(e),0,n),n},t.deepGet=function(e,n){var r=function(e,t,n){return e[t]&&n?r(e,t+1,n[e[t]]):n};return r(Array.isArray(e)?e:t.resolvePath(e),0,n)},t.maybeAssign=function(e){return Object.isFrozen(e)?t.assign(e):e};var a=0,u={},c=Array.prototype.slice,l="undefined"!=typeof window&&window.postMessage&&window.addEventListener,f=function(e){return e[0].apply(null,c.call(e,1))};l&&window.addEventListener("message",function(e){var t,n=e.data;"string"==typeof n&&0===n.indexOf("setMsg")&&(t=u[n])&&(delete u[n],f(t))});var d=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=a++,r="setMsg"+n;return u[r]=e,window.postMessage(r,"*"),n};t.setFast=l?d:function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];void 0!==e?e.setImmediate(function(){f(t)}):setTimeout(function(){f(t)},0)}}).call(this,n(3))},function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.VERSION=2,function(e){e[e.fast=0]="fast",e[e.medium=1]="medium",e[e.slow=2]="slow",e[e.fn=3]="fn",e[e.none=4]="none"}(t.IWhereType||(t.IWhereType={}))},function(e,t,n){var r=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(0);t.err=new Error("Memory index doesn't support this action!");var o=function(){function e(e,t){this.assign=e,this.useCache=t,this.indexes={},this.indexLoaded={},this.useCacheIndexes={}}return e.prototype.connect=function(e,n,r){r(t.err)},e.prototype.disconnect=function(e,n){n(t.err)},e.prototype.createTable=function(e,n,r,i){i(t.err)},e.prototype.dropTable=function(e,n,r){r(t.err)},e.prototype.write=function(e,n,r,i,o){o(t.err)},e.prototype.read=function(e,n,r,i){i(t.err)},e.prototype.delete=function(e,n,r,i){i(t.err)},e.prototype.readMulti=function(e,n,r,i,o,s,a,u){u(t.err)},e.prototype.getTableIndex=function(e,n,r){r(t.err)},e.prototype.getTableIndexLength=function(e,n,r){r(t.err)},e.prototype.createIndex=function(e,t,n,o,s){var a=this,u="_idx_"+e+"_"+t;this.createTable(u,r({},i.blankTableDefinition,{pkType:n,pkCol:["id"],isPkNum:-1!==["float","int","number"].indexOf(n)}),function(){a.indexes[u]?o():(a.indexes[u]={},a.indexLoaded[u]=!1,a.useCacheIndexes[u]=a.useCache||!1,o(),a.nSQL.doFilter("loadIndexCache",{result:{load:a.useCache||!1},index:u},function(e){a.useCacheIndexes[u]=e.load,e.load&&a.readMulti(u,"all",void 0,void 0,!1,function(e){a.indexes[u][e.id]||(a.indexes[u][e.id]=e.pks||[])},function(){a.indexLoaded[u]=!0},s)},s))},s)},e.prototype.deleteIndex=function(e,t,n,r){var i="_idx_"+e+"_"+t;delete this.indexes[i],delete this.indexLoaded[i],this.dropTable(i,n,r)},e.prototype.addIndexValue=function(e,t,n,r,o,s){var a=this,u="_idx_"+e+"_"+t;if(this.indexLoaded[u]){if(this.indexes[u][r]){var c=i.binarySearch(this.indexes[u][r],n,!1);this.indexes[u][r].splice(c,0,n)}else this.indexes[u][r]=[],this.indexes[u][r].push(n);this.write(u,r,{id:n,pks:this.assign?i.assign(this.indexes[u][r]):this.indexes[u][r]},o,s)}else this.read(u,r,function(e){var t=e?e.pks:[];if(0===(t=a.assign?i.assign(t):t).length)t.push(n);else{var c=i.binarySearch(t,n,!1);t.splice(c,0,n)}a.useCacheIndexes[u]&&(a.indexes[u][r]=t),a.write(u,r,{id:n,pks:a.assign?i.assign(t):t},o,s)},s)},e.prototype.deleteIndexValue=function(e,t,n,r,o,s){var a=this,u="_idx_"+e+"_"+t;if(this.indexLoaded[u])if(this.indexes[u][r]){var c=this.indexes[u][r].length<100?this.indexes[u][r].indexOf(n):i.binarySearch(this.indexes[u][r],n,!0);-1===c?o():(this.indexes[u][r].splice(c,1),this.write(u,r,{id:r,pks:this.assign?i.assign(this.indexes[u][r]):this.indexes[u][r]},o,s))}else o();else this.read(u,r,function(e){var t=e?e.pks:[];if(0!==(t=a.assign?i.assign(t):t).length){var c=t.length<100?t.indexOf(n):i.binarySearch(t,n,!0);-1!==c?(t.splice(c,1),a.useCacheIndexes[u]&&(a.indexes[u][r]=t),a.write(u,r,{id:n,pks:a.assign?i.assign(t):t},o,s)):o()}else o()},s)},e.prototype.readIndexKey=function(e,t,n,r,i,o){var s="_idx_"+e+"_"+t;this.read(s,n,function(e){e?(e.pks.forEach(r),i()):i()},o)},e.prototype.readIndexKeys=function(e,t,n,r,i,o,s,a,u){var c="_idx_"+e+"_"+t;this.readMulti(c,n,r,i,o,function(e){e&&e.pks.forEach(function(t){s(t,e.id)})},a,u)},e}();t.nanoSQLMemoryIndex=o},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";e.exports=function(e,t,n){var o,s,a,u,c,l,f,d;if(e===t)return 0;if(o=e.length,s=t.length,0===o)return s;if(0===s)return o;n&&(e=e.toLowerCase(),t=t.toLowerCase());f=0;for(;f<o;)i[f]=e.charCodeAt(f),r[f]=++f;d=0;for(;d<s;)for(a=t.charCodeAt(d),u=c=d++,f=-1;++f<o;)l=a===i[f]?c:c+1,c=r[f],r[f]=u=c>u?l>u?u+1:l:l>c?c+1:l;return u};var r=[],i=[]},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this.eventListeners={}}return e.prototype.on=function(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)},e.prototype.off=function(e,t){var n=this;this.eventListeners[e]&&this.eventListeners[e].length&&this.eventListeners[e].forEach(function(r,i){r===t&&n.eventListeners[e].splice(i,1)})},e.prototype.trigger=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.eventListeners[e]&&this.eventListeners[e].forEach(function(e){return e.apply(void 0,t)})},e}();t.ReallySmallEvents=n,t.RSE=new n},function(e,t,n){var r,i=this&&this.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var o=n(1),s=n(0),a=n(2),u=[];t.SQLiteAbstract=function(e,t){var n=function(e){if(-1===u.indexOf(e))throw Error("No table "+e+" found!");return'"'+e+'"'};return{createAI:function(t,n){e(!0,'CREATE TABLE IF NOT EXISTS "_ai" (id TEXT PRIMARY KEY UNIQUE, inc BIGINT)',[],t,n)},createTable:function(t,n,r,i,o){u.push(t),e(!0,'CREATE TABLE IF NOT EXISTS "'+t+'" (id '+(n.isPkNum?"REAL":"TEXT")+" PRIMARY KEY UNIQUE, data TEXT)",[],function(){n.ai?e(!1,'SELECT "inc" FROM "_ai" WHERE id = ?',[t],function(n){n.rows.length?(r[t]=parseInt(n.rows.item(0).inc),i()):(r[t]=0,e(!0,'INSERT into "_ai" (id, inc) VALUES (?, ?)',[t,0],function(){i()},o))},o):i()},o)},dropTable:function(t,r,i){e(!0,"DROP TABLE IF EXISTS "+n(t),[],function(){e(!0,'UPDATE "_ai" SET inc = ? WHERE id = ?',[0,t],function(){u.splice(u.indexOf(t),1),r()},i)},i)},write:function(t,r,i,o,a,u,c,l,f){if(void 0!==(o=o||s.generateID(t,c[i]+1))){u&&(c[i]=Math.max(o,c[i])),s.deepSet(r,a,o);var d=JSON.stringify(a),h=function(t){u&&o===c[i]?e(!0,'UPDATE "_ai" SET inc = ? WHERE id = ?',[c[i],i],function(){l(o)},f):l(o)};e(!1,"SELECT id FROM "+n(i)+" WHERE id = ?",[o],function(t){t.rows.length?e(!0,"UPDATE "+n(i)+" SET data = ? WHERE id = ?",[d,o],h,f):e(!0,"INSERT INTO "+n(i)+" (id, data) VALUES (?, ?)",[o,d],h,f)},f)}else f(new Error("Can't add a row without a primary key!"))},read:function(t,r,i,o){e(!1,"SELECT data FROM "+n(t)+" WHERE id = ?",[r],function(e){e.rows.length?i(JSON.parse(e.rows.item(0).data)):i(void 0)},o)},remove:function(t,r,i,o){e(!0,"DELETE FROM "+n(t)+" WHERE id = ?",[r],function(){i()},o)},getIndex:function(t,r,i){e(!1,"SELECT id FROM "+n(t)+" ORDER BY id",[],function(e){for(var t=[],n=0;n<e.rows.length;n++)t.push(e.rows.item(n).id);r(t)},i)},getNumberOfRecords:function(t,r,i){e(!1,"SELECT COUNT(*) FROM "+n(t),[],function(e){r(e.rows.item(0)["COUNT(*)"])},i)},readMulti:function(r,i,o,s,a,u,c,l){var f="SELECT data FROM "+n(r);"range"===i&&(f+=" WHERE id BETWEEN ? AND ?"),f+=a?" ORDER BY id DESC":" ORDER BY id";var d=0,h=function(){var n=f;if("offset"===i){var r=a?o+1:o,p=s;if(p<=t)n+=" LIMIT "+p+" OFFSET "+r;else{var y=Math.min(t,p-d*t),g=r+d*t;if(y<=0)return void c();n+=" LIMIT "+y+" OFFSET "+g}}else n+=" LIMIT "+t+" OFFSET "+d*t;e(!1,n,"range"===i?[o,s]:[],function(e){if(e.rows.length){for(var n=0;n<e.rows.length;n++)u(JSON.parse(e.rows.item(n).data),d*t+n);e.rows.length===t?(d++,h()):c()}else c()},l)};h()}}};var c=function(e){function n(n,r){var i=e.call(this,!1,!1)||this;return i.plugin={name:"WebSQL Adapter",version:o.VERSION},i._size=1e3*(n||0)*1e3,i._ai={},i._query=i._query.bind(i),i._tableConfigs={},i._sqlite=t.SQLiteAbstract(i._query,r||500),i}return i(n,e),n.prototype.connect=function(e,t,n){var r=this;this._id=e,this._db=window.openDatabase(this._id,String(this.nSQL.config.version)||"1.0",this._id,s.isAndroid?5e6:this._size),s.setFast(function(){r._sqlite.createAI(t,n)})},n.prototype.createTable=function(e,t,n,r){this._tableConfigs[e]=t,this._sqlite.createTable(e,t,this._ai,n,r)},n.prototype._query=function(e,t,n,r,i){var o=function(e){e.executeSql(t,n,function(e,t){r(t)},function(e,t){return i(t),!1})};e?this._db.transaction(o):this._db.readTransaction(o)},n.prototype.dropTable=function(e,t,n){this._sqlite.dropTable(e,t,n)},n.prototype.disconnect=function(e,t){e()},n.prototype.write=function(e,t,n,r,i){this._sqlite.write(this._tableConfigs[e].pkType,this._tableConfigs[e].pkCol,e,t,n,this._tableConfigs[e].ai,this._ai,r,i)},n.prototype.read=function(e,t,n,r){this._sqlite.read(e,t,n,r)},n.prototype.delete=function(e,t,n,r){this._sqlite.remove(e,t,n,r)},n.prototype.readMulti=function(e,t,n,r,i,o,s,a){this._sqlite.readMulti(e,t,n,r,i,o,s,a)},n.prototype.getTableIndex=function(e,t,n){this._sqlite.getIndex(e,t,n)},n.prototype.getTableIndexLength=function(e,t,n){this._sqlite.getNumberOfRecords(e,t,n)},n}(a.nanoSQLMemoryIndex);t.WebSQL=c},function(e,t,n){var r,i=this&&this.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var o=n(1),s=n(0),a=function(e){function t(t){var n=e.call(this,!1,!1)||this;return n.version=t,n.plugin={name:"IndexedDB Adapter",version:o.VERSION},n._db={},n._ai={},n._tableConfigs={},n}return i(t,e),t.prototype.connect=function(e,t,n){this._id=e,t()},t.prototype.createTable=function(e,t,n,r){var i=this,o=1;this._tableConfigs[e]=t;var a=s.hash(JSON.stringify(t.columns));this.version?o=this.version:(o=parseInt(localStorage.getItem(this._id+"_"+e+"_idb_version")||"")||1,(localStorage.getItem(this._id+"_"+e+"_idb_hash")||a)!==a&&o++,localStorage.setItem(this._id+"_"+e+"_idb_version",String(o)),localStorage.setItem(this._id+"_"+e+"_idb_hash",a));var u=indexedDB.open(this._id+"_"+e,o);this._ai[e]=parseInt(localStorage.getItem(this._id+"_"+e+"_idb_ai")||"0"),u.onerror=r;u.onupgradeneeded=function(n){i._db[e]=n.target.result,i._db[e].objectStoreNames.contains(e)||i._db[e].createObjectStore(e,{keyPath:t.pkCol.join(".")})},u.onsuccess=function(t){i._db[e]=t.target.result,n()}},t.prototype.dropTable=function(e,t,n){var r=this,i=this._db[e].transaction(e,"readwrite");i.onerror=n;var o=i.objectStore(e).clear();o.onerror=n,o.onsuccess=function(){r._db[e].close(),delete r._db[e],localStorage.removeItem(r._id+"_"+e+"_idb_version"),localStorage.removeItem(r._id+"_"+e+"_idb_hash"),localStorage.removeItem(r._id+"_"+e+"_idb_ai"),t()}},t.prototype.disconnect=function(e,t){var n=this;s.allAsync(Object.keys(this._db),function(e,t,r,i){n._db[e].close(),s.setFast(function(){r()})}).then(e).catch(t)},t.prototype.store=function(e,t,n,r){var i=this._db[e].transaction(e,t);i.onabort=r,i.onerror=r,n(i,i.objectStore(e))},t.prototype.write=function(e,t,n,r,i){void 0!==(t=t||s.generateID(this._tableConfigs[e].pkType,this._ai[e]+1))?(this._ai[e]=Math.max(t,this._ai[e]),this._tableConfigs[e].ai&&(this._ai[e]=s.cast("int",Math.max(this._ai[e]||0,t)),localStorage.setItem(this._id+"_"+e+"_idb_ai",String(this._ai[e]))),s.deepSet(this._tableConfigs[e].pkCol,n,t),this.store(e,"readwrite",function(e,o){try{o.put(n).onsuccess=function(){r(t)}}catch(e){i(e)}},i)):i(new Error("Can't add a row without a primary key!"))},t.prototype.read=function(e,t,n,r){this.store(e,"readonly",function(e,r){var i=r.get(t);i.onerror=function(e){n(void 0)},i.onsuccess=function(){n(i.result)}},r)},t.prototype.delete=function(e,t,n,r){this.store(e,"readwrite",function(e,i){var o=i.delete(t);o.onerror=r,o.onsuccess=function(e){n()}},r)},t.prototype.readMulti=function(e,t,n,r,i,o,s,a){var u=0,c="offset"===t?n:0,l=c+r,f=!0;this.store(e,"readonly",function(e,a){a.openCursor("range"!==t?void 0:IDBKeyRange.bound(n,r,!1,!1),i?"prev":"next").onsuccess=function(e){var r=e.target.result;if(r){if("offset"===t){if(f){var a=i?c+1:c;return r.advance(a),u=a,void(f=!1)}(i?l>=u:l>u)&&o(r.value,u-n)}else o(r.value,u);u++,r.continue()}else s()}},a)},t.prototype.getTableIndex=function(e,t,n){var r=this,i=[];this.store(e,"readonly",function(n,o){o.openCursor().onsuccess=function(n){var o=n.target.result;o?(i.push(s.deepGet(r._tableConfigs[e].pkCol,o.value)),o.continue()):t(i)}},n)},t.prototype.getTableIndexLength=function(e,t,n){this.store(e,"readonly",function(r,i){var o=r.objectStore(e).count();o.onsuccess=function(){t(o.result)},o.onerror=n},n)},t}(n(2).nanoSQLMemoryIndex);t.IndexedDB=a},function(e,t,n){e.exports=n(9)},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(10),i=n(7),o=n(6),s=n(5);window.RSE=s.RSE;var a=0;console.log("Testing IndexedDB"),new r.nanoSQLAdapterTest(i.IndexedDB,[]).test().then(function(){console.log("Testing WebSQL"),new r.nanoSQLAdapterTest(o.WebSQL,[]).test().then(function(){console.log("Tests Complete"),s.RSE.trigger("done",a)}).catch(function(e){console.error(e),a++})}).catch(function(e){console.error(e),a++})},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(11);t.myConsole=Object.create(console,{assert:{value:function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if("undefined"==typeof window)try{console.assert.apply(console,[e,t].concat(n))}catch(e){console.error(e.stack)}else console.assert.apply(console,[e,t].concat(n))},configurable:!0,enumerable:!0,writable:!0}});var o=function(){function e(e,t){this.adapter=e,this.args=t}return e.prototype.test=function(){var e=this;return this.PrimaryKeys().then(function(){return console.log("✓ Primary Key Tests Passed"),e.Writes()}).then(function(){return console.log("✓ Write Tests Passed"),e.RangeReads()}).then(function(){return console.log("✓ Range Read Tests Passed (number)"),e.RangeReadsUUID()}).then(function(){return console.log("✓ Range Read Tests Passed (uuid)"),e.Deletes()}).then(function(){return console.log("✓ Delete Tests Passed"),e.SecondayIndexes()}).then(function(){console.log("✓ Secondary Index Passed"),console.log("✓ All Tests Passed!******")})},e.newTable=function(e,t,n,r,i,o){e.nSQL=t,e.createTable(n,r,function(){t.tables[n]=r,i()},o)},e.prototype.Deletes=function(){var n,o=new((n=this.adapter).bind.apply(n,[void 0].concat(this.args))),s=new i.nanoSQL,a=[];return new Promise(function(t,n){o.nSQL=s,o.connect("123",function(){e.newTable(o,s,"test",{id:r.uuid(),model:{"id:int":{ai:!0,pk:!0},"name:string":{}},columns:[{key:"id",type:"int"},{key:"name",type:"string"}],indexes:{},actions:[],foreignKeys:[],views:[],pkType:"int",pkCol:["id"],isPkNum:!0,ai:!0},t,n)},n)}).then(function(){return new Promise(function(e,t){for(var n=[],i=0;i<500;i++)a.push({id:i+1,name:"Title "+(i+1)}),n.push("Title "+(i+1));r.chainAsync(n,function(e,n,r){o.write("test",null,{name:e},r,t)}).then(e)})}).then(function(){return new Promise(function(e,n){o.delete("test",3,function(){var i=[];o.readMulti("test","all",void 0,void 0,!1,function(e,t){i.push(e)},function(){var o=r.objectsEqual(i,a.filter(function(e){return 3!==e.id}));t.myConsole.assert(o,"Delete Test"),o?e():n({e:a.filter(function(e){return 3!==e.id}),g:i})},n)},n)})}).then(function(){return new Promise(function(e,t){o.dropTable("test",function(){o.disconnect(e,t)},t)})})},e.prototype.SecondayIndexes=function(){var n,o=new((n=this.adapter).bind.apply(n,[void 0].concat(this.args))),s=new i.nanoSQL,a=[];return new Promise(function(t,n){o.nSQL=s,o.connect("123",function(){e.newTable(o,s,"test",{id:r.uuid(),model:{"id:int":{ai:!0,pk:!0},"name:string":{}},columns:[{key:"id",type:"int"},{key:"name",type:"string"}],indexes:{name:{id:"name",isArray:!1,type:"string",path:["name"],props:{}}},actions:[],foreignKeys:[],views:[],pkType:"int",pkCol:["id"],isPkNum:!0,ai:!0},t,n)},n)}).then(function(){return new Promise(function(e,t){for(var n=0;n<500;n++){var i=n+1;i<=9?i="00"+i:i<=99&&(i="0"+i),a.push({id:n+1,name:"Title "+i})}o.createIndex("test","name","string",function(){r.chainAsync(a,function(e,n,r){o.write("test",null,e,function(){o.addIndexValue("test","name",e.id,e.name,r,t)},t)}).then(e)},t)})}).then(function(){return new Promise(function(e,n){var i=[];o.readIndexKey("test","name","Title 005",function(e){i.push(e)},function(){var o=r.objectsEqual(i,[5]);t.myConsole.assert(o,"Secondary Index Single Read"),o?e():n({e:[5],g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];o.readIndexKeys("test","name","range","Title 004","Title 020",!1,function(e,t){i.push(e)},function(){var o=a.filter(function(e){return e.name>="Title 004"&&e.name<="Title 020"}).map(function(e){return e.id}),s=r.objectsEqual(i,o);t.myConsole.assert(s,"Secondary Index Range Read"),s?e():n({e:o,g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];o.readIndexKeys("test","name","offset",10,20,!1,function(e){i.push(e)},function(){var o=a.filter(function(e,t){return t>=10&&t<30}).map(function(e){return e.id}),s=r.objectsEqual(i,o);t.myConsole.assert(s,"Secondary Index Offset Read"),s?e():n({e:o,g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];o.readIndexKeys("test","name","range","Title 004","Title 020",!0,function(e,t){i.push(e)},function(){var o=a.filter(function(e){return e.name>="Title 004"&&e.name<="Title 020"}).map(function(e){return e.id}).reverse(),s=r.objectsEqual(i,o);t.myConsole.assert(s,"Secondary Index Range Read Reverse"),s?e():n({e:o,g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];o.readIndexKeys("test","name","offset",10,20,!0,function(e){i.push(e)},function(){var o=a.filter(function(e,t){return t>=469&&t<489}).map(function(e){return e.id}).reverse(),s=r.objectsEqual(i,o);t.myConsole.assert(s,"Secondary Index Offset Read Reverse"),s?e():n({e:o,g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];o.deleteIndexValue("test","name",10,"Title 010",function(){o.readIndexKeys("test","name","all",void 0,void 0,!1,function(e){i.push(e)},function(){var o=a.filter(function(e){return 10!==e.id}).map(function(e){return e.id}),s=r.objectsEqual(i,o);t.myConsole.assert(s,"Secondary Index Remove Value"),s?e():n({e:o,g:i})},n)},n)})})},e.prototype.RangeReads=function(){var n,o=new((n=this.adapter).bind.apply(n,[void 0].concat(this.args))),s=new i.nanoSQL,a=[],u=[];return new Promise(function(t,n){o.nSQL=s,o.connect("123",function(){e.newTable(o,s,"test",{id:r.uuid(),model:{"id:int":{ai:!0,pk:!0},"name:string":{}},columns:[{key:"id",type:"int"},{key:"name",type:"string"}],indexes:{},actions:[],views:[],foreignKeys:[],pkType:"int",pkCol:["id"],isPkNum:!0,ai:!0},t,n)},n)}).then(function(){return new Promise(function(e,t){for(var n=[],i=0;i<500;i++)a.push({id:i+1,name:"Title "+(i+1)}),n.push("Title "+(i+1)),u.push(i+1);r.chainAsync(n,function(e,n,r){o.write("test",null,{name:e},r,t)}).then(e)})}).then(function(){return new Promise(function(e,n){var i=[];o.readMulti("test","range",10,20,!0,function(e,t){i.push(e)},function(){var o=a.filter(function(e){return e.id>=10&&e.id<=20}).reverse(),s=r.objectsEqual(i,o);t.myConsole.assert(s,"Select Range Test (Reverse)"),s?e():n({e:o,g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];o.readMulti("test","offset",10,20,!0,function(e,t){i.push(e)},function(){var o=a.filter(function(e,t){return t>=469&&t<489}).reverse(),s=r.objectsEqual(i,o);t.myConsole.assert(s,"Select Offset Test (Reverse)"),s?e():n({e:o,g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];o.readMulti("test","all",void 0,void 0,!0,function(e,t){i.push(e)},function(){var o=a.slice().reverse(),s=r.objectsEqual(i,o);t.myConsole.assert(s,"Select All Rows Test (reverse)"),s?e():n({e:o,g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];o.readMulti("test","range",10,20,!1,function(e,t){i.push(e)},function(){var o=a.filter(function(e){return e.id>=10&&e.id<=20}),s=r.objectsEqual(i,o);t.myConsole.assert(s,"Select Range Test 2"),s?e():n({e:o,g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];o.readMulti("test","offset",10,20,!1,function(e,t){i.push(e)},function(){var o=r.objectsEqual(i,a.filter(function(e){return e.id>10&&e.id<=30}));t.myConsole.assert(o,"Select Offset / Limit Test"),o?e():n({g:i,e:a.filter(function(e){return e.id>10&&e.id<=30})})},n)})}).then(function(){return new Promise(function(e,n){var i=[];o.readMulti("test","all",void 0,void 0,!1,function(e,t){i.push(e)},function(){var o=r.objectsEqual(i,a);t.myConsole.assert(o,"Select Entire Table"),o?e():n({e:a,g:i})},n)})}).then(function(){return new Promise(function(e,n){o.getTableIndex("test",function(i){var o=r.objectsEqual(i,u);t.myConsole.assert(o,"Select Index Test"),o?e():n({e:u,g:i})},n)})}).then(function(){return new Promise(function(e,n){o.getTableIndexLength("test",function(r){var i=500===r;t.myConsole.assert(i,"Select Index Length Test"),i?e():n({e:500,g:r})},n)})}).then(function(){return new Promise(function(e,t){o.dropTable("test",function(){o.disconnect(e,t)},t)})})},e.prototype.RangeReadsUUID=function(){var n,o=new((n=this.adapter).bind.apply(n,[void 0].concat(this.args))),s=new i.nanoSQL,a=[],u=[];return new Promise(function(t,n){o.nSQL=s,o.connect("123",function(){e.newTable(o,s,"test",{id:r.uuid(),model:{"id:uuid":{pk:!0},"name:string":{}},columns:[{key:"id",type:"uuid"},{key:"name",type:"string"}],indexes:{},actions:[],views:[],foreignKeys:[],pkType:"uuid",pkCol:["id"],isPkNum:!1,ai:!1},t,n)},n)}).then(function(){return new Promise(function(e,t){for(var n=[],i=0;i<500;i++){var s=r.uuid();a.push({id:s,name:"Title "+i}),n.push("Title "+i),u.push(s)}u.sort(function(e,t){return e>t?1:-1}),a.sort(function(e,t){return e.id>t.id?1:-1}),r.chainAsync(a,function(e,n,r){o.write("test",e.id,e,r,t)}).then(e)})}).then(function(){return new Promise(function(e,n){var i=[];o.readMulti("test","offset",10,20,!1,function(e,t){i.push(e)},function(){var o=r.objectsEqual(i,a.filter(function(e,t){return t>=10&&t<30}));t.myConsole.assert(o,"Select Range Test 2"),o?e():n({g:i,e:a.filter(function(e,t){return t>=10&&t<30})})},n)})}).then(function(){return new Promise(function(e,n){var i=[];o.readMulti("test","range",a[10].id,a[20].id,!1,function(e,t){i.push(e)},function(){var o=r.objectsEqual(i,a.filter(function(e){return e.id>=a[10].id&&e.id<=a[20].id}));t.myConsole.assert(o,"Select Range Test (Primary Key)"),o?e():n({g:i,e:a.filter(function(e){return e.id>=a[10].id&&e.id<=a[20].id})})},n)})}).then(function(){return new Promise(function(e,n){var i=[];o.readMulti("test","all",void 0,void 0,!1,function(e,t){i.push(e)},function(){var o=r.objectsEqual(i,a);t.myConsole.assert(o,"Select Entire Table Test"),o?e():n({e:a,g:i})},n)})}).then(function(){return new Promise(function(e,n){o.getTableIndex("test",function(i){var o=r.objectsEqual(i,u);t.myConsole.assert(o,"Select Index Test"),o?e():n({e:u,g:i})},n)})}).then(function(){return new Promise(function(e,n){o.getTableIndexLength("test",function(r){var i=500===r;t.myConsole.assert(i,"Select Index Length Test"),i?e():n({e:500,g:r})},n)})}).then(function(){return new Promise(function(e,t){o.dropTable("test",function(){o.disconnect(e,t)},t)})})},e.prototype.Writes=function(){var n,o=new((n=this.adapter).bind.apply(n,[void 0].concat(this.args))),s=new i.nanoSQL;return new Promise(function(t,n){o.nSQL=s,o.connect("123",function(){e.newTable(o,s,"test",{id:r.uuid(),model:{"id:int":{pk:!0,ai:!0},"name:string":{},"posts:string[]":{}},columns:[{key:"id",type:"int"},{key:"name",type:"string"},{key:"posts",type:"string[]"}],indexes:{},actions:[],foreignKeys:[],views:[],pkType:"int",pkCol:["id"],isPkNum:!0,ai:!0},t,n)},n)}).then(function(){return new Promise(function(e,n){o.write("test",null,{name:"Test",posts:[1,2]},function(i){o.read("test",i,function(i){var o={name:"Test",id:1,posts:[1,2]},s=r.objectsEqual(i,o);t.myConsole.assert(s,"Insert Test"),s?e():n({e:o,g:i})},n)},n)})}).then(function(){return new Promise(function(e,n){o.write("test",1,{id:1,name:"Testing",posts:[1,2]},function(i){o.read("test",i,function(i){var o={name:"Testing",id:1,posts:[1,2]},s=r.objectsEqual(i,o);t.myConsole.assert(s,"Update Test"),s?e():n({e:o,g:i})},n)},n)})}).then(function(){return new Promise(function(e,n){o.write("test",1,{id:1,name:"Testing"},function(i){o.read("test",i,function(i){var o={name:"Testing",id:1},s=r.objectsEqual(i,o);t.myConsole.assert(s,"Replace Test"),s?e():n({e:o,g:i})},n)},n)})}).then(function(){return new Promise(function(e,t){o.dropTable("test",function(){o.disconnect(e,t)},t)})})},e.prototype.PrimaryKeys=function(){var n,o=new((n=this.adapter).bind.apply(n,[void 0].concat(this.args))),s=new i.nanoSQL;return new Promise(function(t,n){o.nSQL=s,o.connect("123",function(){Promise.all(["test","test2","test3","test4","test5","test6","test7"].map(function(t){return new Promise(function(n,i){e.newTable(o,s,t,{id:r.uuid(),model:{test:{"id:int":{pk:!0,ai:!0},"name:string":{}},test2:{"id:uuid":{pk:!0},"name:string":{}},test3:{"id:timeId":{pk:!0},"name:string":{}},test4:{"id:timeIdms":{pk:!0},"name:string":{}},test5:{"id:uuid":{pk:!0},"name:string":{}},test6:{"id:float":{pk:!0},"name:string":{}},test7:{"nested:obj":{model:{"id:int":{pk:!0}}},"name:string":{}}}[t],columns:[{test:{key:"id",type:"int"},test2:{key:"id",type:"uuid"},test3:{key:"id",type:"timeId"},test4:{key:"id",type:"timeIdms"},test5:{key:"id",type:"uuid"},test6:{key:"id",type:"float"},test7:{key:"nested",model:[{key:"id",type:"int"}]}}[t],{key:"name",type:"string"}],indexes:{},actions:[],foreignKeys:[],views:[],pkType:{test:"int",test2:"uuid",test3:"timeId",test4:"timeIdms",test5:"uuid",test6:"float",test7:"int"}[t],pkCol:"test7"===t?["nested","id"]:["id"],isPkNum:{test:!0,test2:!1,test3:!1,test4:!1,test5:!1,test6:!0,test7:!0}[t],ai:{test:!0,test2:!1,test3:!1,test4:!1,test5:!1,test6:!1,test7:!1}[t]},n,i)})})).then(t).catch(n)},n)}).then(function(){return new Promise(function(e,n){o.write("test",null,{name:"Test"},function(i){var s=r.objectsEqual(i,1);t.myConsole.assert(s,"Test Auto Incriment Integer."),s?o.read("test",1,function(i){var o=r.objectsEqual(i.id,1);t.myConsole.assert(o,"Select Integer Primary Key."),o?e():n({e:1,g:i.id})},n):n(i)},n)})}).then(function(){return new Promise(function(e,n){o.write("test2",null,{name:"Test"},function(i){var s=i.match(/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/);t.myConsole.assert(s,"Test UUID."),s?o.read("test2",i,function(o){var s=r.objectsEqual(o.id,i);t.myConsole.assert(s,"Select UUID Primary Key."),s?e():n({e:i,g:o.id})},n):n({e:"valid uuid",g:i})},n)})}).then(function(){return new Promise(function(e,n){o.write("test3",null,{name:"Test"},function(i){var s=i.match(/^\w{10}-\w{1,5}$/);t.myConsole.assert(s,"Test timeId."),s?o.read("test3",i,function(o){var s=r.objectsEqual(o.id,i);t.myConsole.assert(s,"Select timeId Primary Key."),s?e():n({e:i,g:o.id})},n):n({e:"valid timeid",g:i})},n)})}).then(function(){return new Promise(function(e,n){o.write("test4",null,{name:"Test"},function(i){var s=i.match(/^\w{13}-\w{1,5}$/);t.myConsole.assert(s,"Test timeIdms."),s?o.read("test4",i,function(o){var s=r.objectsEqual(o.id,i);t.myConsole.assert(s,"Select timeIdms Primary Key."),s?e():n({e:i,g:o.id})},n):n({e:"valid timeidms",g:i})},n)})}).then(function(){return new Promise(function(e,n){for(var i=[],s=0;s<20;s++)i.push(r.uuid());r.chainAsync(i,function(e,t,r){o.write("test5",e,{id:e,name:"Test "+t},r,n)}).then(function(){i.sort();var s=[];o.readMulti("test5","all",void 0,void 0,!1,function(e,t){s.push(e.id)},function(){var o=r.objectsEqual(s,i);t.myConsole.assert(o,"Test Sorted Primary Keys."),o?e():n({e:i,g:s})},n)})})}).then(function(){return new Promise(function(e,n){for(var i=[],s=0;s<20;s++)i.push({id:Math.random(),name:"Test "+s});r.chainAsync(i,function(e,t,r){o.write("test6",e.id,e,r,n)}).then(function(){var s=[];o.readMulti("test6","all",void 0,void 0,!1,function(e){s.push(e)},function(){var a=r.objectsEqual(s,i.sort(function(e,t){return e.id>t.id?1:-1}));t.myConsole.assert(a,"Test float primary keys."),a?o.read("test6",i[0].id,function(o){var s=r.objectsEqual(o.id,i[0].id);t.myConsole.assert(s,"Select Float Primary Key."),s?e():n({e:i[0].id,g:o.id})},n):n({e:i.sort(function(e,t){return e.id>t.id?1:-1}),g:s})},n)}).catch(n)})}).then(function(){return new Promise(function(e,n){for(var i=[],s=1;s<20;s++)i.push({nested:{id:s},name:"Test "+s});r.chainAsync(i,function(e,t,r){o.write("test7",e.nested.id,e,r,n)}).then(function(){var s=[];o.readMulti("test7","all",void 0,void 0,!1,function(e){s.push(e)},function(){var a=r.objectsEqual(s,i);t.myConsole.assert(a,"Test Nested primary keys."),a?o.read("test7",i[2].nested.id,function(o){var s=r.objectsEqual(o.nested.id,i[2].nested.id);t.myConsole.assert(s,"Select Nested Primary Key."),s?e():n({e:i[0].nested.id,g:o.id})},n):n({e:i.sort(function(e,t){return e.id>t.id?1:-1}),g:s})},n)}).catch(n)})}).then(function(){return Promise.all(["test","test2","test3","test4","test5","test6","test7"].map(function(e){return new Promise(function(t,n){o.dropTable(e,t,n)})})).then(function(){return new Promise(function(e,t){o.disconnect(e,t)})})})},e}();t.nanoSQLAdapterTest=o},function(e,t,n){(function(e){var r=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(5),o=n(0),s=n(1);t.InanoSQLInstance=s.InanoSQLInstance;var a,u=n(12),c=n(13),l=n(14),f=n(6),d=n(7),h=n(15),p=n(0);void 0!==e&&(a=e._rocksAdapter);var y=function(){function e(){this.version=s.VERSION,this.planetRadius=6371,this._Q=new o._nanoSQLQueue,this.state={activeAV:"",hasAnyEvents:!1,peers:[],pid:o.uuid(),id:o.uuid(),peerEvents:[],focused:!0,peerMode:!1,connected:!1,ready:!1,selectedTable:""},this.config={id:"temp",queue:!1},this.tables={},this.tableIds={_util:"_util",_ttl:"_ttl"},this._queryCache={},this.filters={},this.indexTypes={string:function(e){return"object"==typeof e?JSON.stringify(e):String(e)},geo:function(e){},float:function(e){var t=parseFloat(e);return isNaN(t)?0:t},int:function(e){var t=parseInt(e);return isNaN(t)?0:t},number:function(e){var t=parseFloat(e);return isNaN(t)?0:t}},this.eventFNs={Core:{"*":new i.ReallySmallEvents},"*":{"*":new i.ReallySmallEvents}},this._checkTTL=this._checkTTL.bind(this),u.attachDefaultFns(this)}return e.prototype.doFilter=function(e,t,n,r){var i=this;this.filters[e]?o.chainAsync(this.filters[e],function(n,o,s){i.filters[e][o](t,function(e){t=e,s()},function(e){r(e)})}).then(function(){n(t.result)}):n(t.result)},e.prototype.getCache=function(e,t){if(!this._queryCache[e])throw new Error('Cache "'+e+'" not found!');return t?this._queryCache[e].slice(t.offset,t.offset+t.limit):this._queryCache[e].slice()},e.prototype.clearCache=function(e){var t=void 0!==this._queryCache[e];return delete this._queryCache[e],t},e.prototype.clearTTL=function(e){var t=this,n=this.state.selectedTable+"."+e;return new Promise(function(e,i){t.triggerQuery(r({},o.buildQuery(t,"_ttl","delete"),{where:["key","=",n]}),o.noop,e,i)})},e.prototype.expires=function(e){var t=this;return new Promise(function(n,i){var s=t.state.selectedTable+"."+e,a=[];t.triggerQuery(r({},o.buildQuery(t,"_ttl","select"),{where:["key","=",s]}),function(e){a.push(e)},function(){a.length?n({time:(a[0].date-Date.now())/1e3,cols:a[0].cols}):n({time:-1,cols:[]})},i)})},e.prototype._checkTTL=function(){var e=this;if(!this.config.disableTTL){this._ttlTimer&&clearTimeout(this._ttlTimer);var t=0,n=0,i=function(){var s=[];e.triggerQuery(r({},o.buildQuery(e,"_ttl","select"),{limit:20,offset:20*t}),function(e){s.push(e)},function(){s.length?o.chainAsync(s,function(t,i,s){if(t.date<Date.now()){var a=function(){e.triggerQuery(r({},o.buildQuery(e,"_ttl","delete"),{where:["key","=",t.key]}),o.noop,s,o.throwErr)},u=t.key.split("."),c=u[0],l=-1===["float","int","number"].indexOf(e.tables[c].pkType)?u[1]:parseFloat(u[1]);if(t.cols.length){var f={};t.cols.forEach(function(e){f[e]=null}),e.triggerQuery(r({},o.buildQuery(e,c,"upsert"),{actionArgs:f,where:[e.tables[c].pkCol,"=",l]}),o.noop,a,o.throwErr)}else e.triggerQuery(r({},o.buildQuery(e,c,"delete"),{where:[e.tables[c].pkCol,"=",l]}),o.noop,a,o.throwErr)}else n=Math.max(n,t.date),s()}).then(function(){t++,i()}):n&&(e._ttlTimer=setTimeout(e._checkTTL,n-Date.now()))},o.throwErr)};i()}},e.prototype.selectTable=function(e){return e&&(this.state.selectedTable=e),this},e.prototype.getPeers=function(){return JSON.parse(localStorage.getItem("nsql-peers-"+this.state.id)||"[]")},e.prototype._detectStorageMethod=function(){return"undefined"==typeof window?"RKS":o.isSafari?"WSQL":"undefined"!=typeof indexedDB?"IDB":"undefined"!=typeof window&&void 0!==window.openDatabase?"WSQL":"LS"},e.prototype._initPlugins=function(e){var t=this;return new Promise(function(n,r){var i={};(e.plugins||[]).forEach(function(e){(e.filters||[]).forEach(function(e){i[e.name]||(i[e.name]=[]);for(var t=e.priority;i[e.name][t];)t++;i[e.name][t]=e.call})}),Object.keys(i).forEach(function(e){t.filters[e]=[],i[e].forEach(function(n){n&&t.filters[e].unshift(n)})});var o=function(e,t){return!t||!t.length||(1===t.length?e>=t[0]:e>=t[0]&&e<t[1])},a=!1;(e.plugins||[]).forEach(function(t){if(t.dependencies){var n=t.dependencies||{};Object.keys(t.dependencies).forEach(function(i,u,c){if("core"===i)o(s.VERSION,n[i])||(a=!0,r('Plugin "'+t.name+'" requires a different core version of nano-sql!'));else{var l=(e.plugins||[]).reduce(function(e,t){return t.name===i?t:e});l||(a=!0,r('Plugin "'+t.name+'" requires plugin "'+i+"\" but it isn't installed!")),o(l.version,n[i])||(a=!0,r('Plugin "'+t.name+'" requires a different version of "'+i+'"!'))}})}}),a||n()})},e.prototype.saveTableIds=function(){var e=this;return new Promise(function(t,n){e.triggerQuery(r({},o.buildQuery(e,"_util","upsert"),{actionArgs:o.assign({key:"tableIds",value:e.tableIds})}),o.noop,t,n)})},e.prototype.connect=function(e){var t=this;return this._initPlugins(e).then(function(){return new Promise(function(n,r){t.doFilter("config",{result:e},n,r)})}).then(function(e){return t.state.id=e.id||"nSQL_DB",t.config=r({plugins:[]},e),"undefined"!=typeof window&&e&&e.peer&&(t.state.peerMode=!0),new Promise(function(e,n){t.doFilter("willConnect",{result:{}},e,n)})}).then(function(){return new Promise(function(e,n){var r=void 0!==t.config.mode?t.config.mode:"TEMP";if("string"==typeof r)switch("PERM"===r&&(r=t._detectStorageMethod()),r){case"TEMP":t.adapter=new l.SyncStorage(!1);break;case"LS":t.adapter=new l.SyncStorage(!0);break;case"WSQL":t.adapter=new f.WebSQL(t.config.size);break;case"IDB":t.adapter=new d.IndexedDB(t.config.version);break;case"RKS":case"LVL":t.adapter=new a(t.config.path);break;default:n("Cannot find mode "+r+"!")}else t.adapter=r;t.adapter.plugin&&(t.config.plugins||[]).push(t.adapter.plugin),t._initPlugins(t.config).then(function(){t.adapter.nSQL=t,o.adapterFilters(t).connect(t.state.id,function(){t.doFilter("postConnect",{result:t.config},function(n){t.config=n,e()},n)},n)}).catch(n),t.config.planetRadius&&(t.planetRadius=t.config.planetRadius)})}).then(function(){t.triggerEvent({target:"Core",targetId:t.state.id,path:"*",events:["connect"],time:Date.now()}),t.state.connected=!0;var e=["_util","_ttl"].concat((t.config.tables||[]).map(function(e){return e.name}));return o.chainAsync(e,function(e,n,i,s){switch(e){case"_util":t.triggerQuery(r({},o.buildQuery(t,"_util","create table"),{actionArgs:{name:"_util",model:{"key:string":{pk:!0},"value:any":{}},_internal:!0}}),o.noop,function(){t.triggerQuery(r({},o.buildQuery(t,"_util","select"),{where:["key","=","tableIds"]}),function(e){t.tableIds=r({},t.tableIds,e.value)},function(){i()},s)},s);break;case"_ttl":t.triggerQuery(r({},o.buildQuery(t,"_ttl","create table"),{actionArgs:{name:"_ttl",model:{"key:string":{pk:!0},"table:string":{},"cols:string[]":{},"date:number":{}},_internal:!0}}),o.noop,i,s);break;default:var a=(t.config.tables||[]).filter(function(t){return t.name===e})[0];if(!a)return void s("Table not found!");t.triggerQuery(r({},o.buildQuery(t,e,"create table"),{actionArgs:a}),o.noop,i,s)}})}).then(function(){return new Promise(function(e,n){var i;t.triggerQuery(r({},o.buildQuery(t,"_util","select"),{where:["key","=","version"]}),function(e){e&&(i=e.value)},function(){!i||i<2?t.triggerQuery(r({},o.buildQuery(t,"_util","upsert"),{actionArgs:{key:"version",value:s.VERSION}}),o.noop,e,n):e()},n)})}).then(function(){return new Promise(function(e,n){var i;t.config.version?t.triggerQuery(r({},o.buildQuery(t,"_util","select"),{where:["key","=","db-version"]}),function(e){e&&(i=e.value)},function(){var s=function(e,n,i){t.triggerQuery(r({},o.buildQuery(t,"_util","upsert"),{actionArgs:{key:"db-version",value:e}}),o.noop,n,i)};if(i){var a=function(){if(i===t.config.version)s(t.config.version||0,e,n);else{if(!t.config.onVersionUpdate)return void s(t.config.version||0,e,n);t.config.onVersionUpdate(i).then(function(e){s(i=e,function(){o.setFast(a)},n)}).catch(n)}};a()}else s(t.config.version||0,e,n)},n):e()})}).then(function(){return new Promise(function(e,n){t.triggerEvent({target:"Core",path:"*",targetId:t.state.id,events:["ready"],time:Date.now()}),t.state.ready=!0,t.config.disableTTL||t._checkTTL(),t.config.peer&&t._initPeers(),e()})})},e.prototype._initPeers=function(){var e=this,n=0;this.state.pid=o.uuid(),this.state.peers=this.getPeers(),this.state.peers.unshift(this.state.pid),localStorage.setItem("nsql-peers-"+this.state.id,JSON.stringify(this.state.peers)),window.addEventListener("storage",function(t){if(t.key==="nsql-peers-"+e.state.id&&(e.state.peers=e.getPeers()),t.key&&0===t.key.indexOf(e.state.pid+".")){localStorage.removeItem(t.key);var i=JSON.parse(t.newValue||"{}");e.state.peerEvents.push(i.query.queryID||""),e.triggerEvent(r({},i,{types:["peer change"]})),o.setFast(function(){e.triggerEvent(i)})}if(++n>50&&e.state.peers[0]===e.state.pid){n=0;for(var s=localStorage.length,a={};s--;){var u=localStorage.key(s),c=u?u.match(/\w{8}-\w{4}-\w{4}-\w{4}-\w{8}/gim):null;if(u&&c){var l=(c||[""])[0];a[l]||(a[l]=[]),a[l].push(u)}}Object.keys(a).forEach(function(t){a[t].length>10&&(e.state.peers=e.state.peers.filter(function(e){return e!==t}),a[t].forEach(function(e){localStorage.removeItem(e)}),localStorage.setItem("nsql-peers-"+e.state.id,JSON.stringify(e.state.peers)))})}}),window.onblur=function(){e.state.focused=!1},window.onfocus=function(){e.state.peers=e.state.peers.filter(function(t){return t!==e.state.pid}),e.state.peers.unshift(e.state.pid),localStorage.setItem("nsql-peers-"+e.state.id,JSON.stringify(e.state.peers)),e.state.focused=!0},t.nSQL("*").on("change",function(t){var n=e.state.peerEvents.indexOf(t.query.queryID||"");-1===n?e.state.peers.filter(function(t){return t!==e.state.pid}).forEach(function(e){localStorage.setItem(e+"."+t.query.queryID,JSON.stringify(t))}):e.state.peerEvents.splice(n,1)}),window.addEventListener("beforeunload",function(){return e.state.peers=e.state.peers.filter(function(t){return t!==e.state.pid}),localStorage.setItem("nsql-peers-"+e.state.id,JSON.stringify(e.state.peers)),!1})},e.prototype.every=function(e){for(var t=0,n=[];t<=e.length;)e.every?t%e.every==0&&n.push(t+(e.offset||0)):n.push(t+(e.offset||0)),t++;return n},e.prototype.on=function(e,t){var n=this,r=this,s="string"!=typeof r.state.selectedTable?"":r.state.selectedTable;switch(e){case"connect":case"ready":case"disconnect":case"peer change":case"slow query":case"map reduce":this.eventFNs.Core["*"].on(e,t);break;case"select":case"change":case"delete":case"upsert":case"*":var a=o.resolvePath(s);this.eventFNs[a[0]]||(this.eventFNs[a[0]]={"*":new i.ReallySmallEvents});var u=a.filter(function(e,t){return t>0}).join(".")||"*";this.eventFNs[a[0]][u]||(this.eventFNs[a[0]][u]=new i.ReallySmallEvents),this.eventFNs[a[0]][u].on(e,t);break;default:new Promise(function(t,r){n.doFilter("customEvent",{result:{nameSpace:"",path:"*"},selectedTable:s,action:e,on:!0},t,r)}).then(function(o){if(!o.nameSpace)throw new Error('Invalid event "'+e+'"!');n.eventFNs[o.nameSpace]||(n.eventFNs[o.nameSpace]={"*":new i.ReallySmallEvents}),n.eventFNs[o.nameSpace][o.path]||(n.eventFNs[o.nameSpace][o.path]=new i.ReallySmallEvents),n.eventFNs[o.nameSpace][o.path].on(e,t),r._refreshEventChecker()})}return r._refreshEventChecker()},e.prototype.off=function(e,t){var n=this,r=this,s="string"!=typeof r.state.selectedTable?"":r.state.selectedTable;switch(e){case"connect":case"ready":case"disconnect":case"peer change":case"slow query":case"map reduce":this.eventFNs.Core["*"].off(e,t);break;case"select":case"change":case"delete":case"upsert":var a=o.resolvePath(s);this.eventFNs[a[0]]||(this.eventFNs[a[0]]={"*":new i.ReallySmallEvents});var u=a.filter(function(e,t){return t>0}).join(".")||"*";this.eventFNs[a[0]][u]||(this.eventFNs[a[0]][u]=new i.ReallySmallEvents),this.eventFNs[a[0]][u].off(e,t);break;default:this.doFilter("customEvent",{result:{nameSpace:"",path:"*"},selectedTable:s,action:e,on:!0},function(o){if(!o.nameSpace)throw new Error('Invalid event "'+e+'"!');n.eventFNs[o.nameSpace]||(n.eventFNs[o.nameSpace]={"*":new i.ReallySmallEvents}),n.eventFNs[o.nameSpace][o.path]||(n.eventFNs[o.nameSpace][o.path]=new i.ReallySmallEvents),n.eventFNs[o.nameSpace][o.path].off(e,t),r._refreshEventChecker()},function(){})}return r._refreshEventChecker()},e.prototype._refreshEventChecker=function(){var e=this;return this.state.hasAnyEvents=Object.keys(this.eventFNs).reduce(function(t,n){return!0===t||(Object.keys(e.eventFNs[n]).reduce(function(t,r){return Object.keys(e.eventFNs[n][r].eventListeners).length+t},0)>0||t)},!1),this},e.prototype.getView=function(e,t){return this._doAV("v",this.state.selectedTable,e,t)},e.prototype.doAction=function(e,t){return this._doAV("a",this.state.selectedTable,e,t)},e.prototype._doAV=function(e,t,n,r){var i=this;return"string"!=typeof this.state.selectedTable?Promise.reject("Can't do Action/View with selected table!"):new Promise(function(o,s){i.doFilter(e,{result:{AVType:e,table:t,AVName:n,AVargs:r}},o,s)}).then(function(e){var t="a"===e.AVType?"actions":"views",n=i.tables[e.table][t].reduce(function(t,n){return n.name===e.AVName?n:t},null);return n?n.call(n.args?o.cleanArgs(n.args,e.AVargs,i):{},i):new Promise(function(t,n){return n(e.AVType+' "'+e.AVName+'" Not Found!')})})},e.prototype.query=function(e,t){var n=this.state.activeAV;return this.state.activeAV="",new h._nanoSQLQueryBuilder(this,this.state.selectedTable,e,t,n)},e.prototype.triggerQuery=function(e,t,n,r){var i=this;this.state.connected||"string"!=typeof e.table?this.doFilter("query",{result:e},function(e){i.config.queue&&!e.skipQueue?i._Q.newItem({query:e,onRow:t,complete:n,error:r},function(e,t,n){new c._nanoSQLQuery(i,e.query,e.onRow,function(){t(),e.complete()},function(n){t(),e.error(n)})}):new c._nanoSQLQuery(i,e,function(e){t(e)},n,r)},r):r("nSQL: Can't do a query before the database is connected!")},e.prototype.triggerEvent=function(e,t){var n=this;return this.doFilter("event",{result:e},function(e){n.state.hasAnyEvents&&o.setFast(function(){e.events.forEach(function(r){if(t||Object.keys(n.eventFNs["*"]).forEach(function(t){n.eventFNs["*"][t].trigger(r,e)}),n.eventFNs[e.target])if("_all_"===e.path)Object.keys(n.eventFNs[e.target]).forEach(function(t){n.eventFNs[e.target][t].trigger(r,e)});else{if(!n.eventFNs[e.target][e.path])return;n.eventFNs[e.target][e.path].trigger(r,e)}})})},function(e){console.log("Event suppressed",e)}),this},e.prototype.default=function(e,t){var n=this;if(e=e||{},!t&&"string"!=typeof this.state.selectedTable)throw new Error("Must select table to generate defualts!");if(t=t||this.state.selectedTable,!this.tables[t])throw new Error('nSQL: Table "'+t+'" not found for generating default object!');var r="",i=function(e,t,s){var a={};if(t=t||{},s&&s.length&&-1!==s.indexOf("[]"))return Array.isArray(t)?t.map(function(t){return i(e,t,s.slice(0,s.lastIndexOf("[]")))}):[];var u=!1;if(e.forEach(function(e){if("*"!==e.key){if(e.model)if(-1!==e.type.indexOf("[]")){var s=void 0!==t?t[e.key]:[];Array.isArray(s)?a[e.key]=s.map(function(t){return i(e.model,t,e.type.slice(0,e.type.lastIndexOf("[]")))}):a[e.key]=[]}else a[e.key]=i(e.model,void 0!==t?t[e.key]:void 0);else{var c=void 0!==t[e.key]?o.cast(e.type,t[e.key],!1,n):e.default;void 0!==e.max&&c>e.max&&(r="Data error, column "+e.key+" can't be greater than "+e.max+"!"),void 0!==e.min&&c<e.min&&(r="Data error, column "+e.key+" can't be less than "+e.min+"!"),a[e.key]=c}!e.notNull||null!==a[e.key]&&void 0!==a[e.key]||(r="Data error, "+e.key+" cannot be null!")}else u=!0}),r.length)return new Error(r);if(u&&t){var c=e.map(function(e){return e.key});Object.keys(t).filter(function(e){return-1===c.indexOf(e)}).forEach(function(e){a[e]=t[e]})}return a};return i(this.tables[t].columns,e)},e.prototype.rawDump=function(e,t,n){var r=this,i=t?e:Object.keys(this.tables).filter(function(t){return!e.length||-1!==e.indexOf(t)});return o.chainAsync(i,function(e,i,s,a){if(t){var u=-1!==e.indexOf(":")?e.split(":")[0]:e,c=-1!==e.indexOf(":")?[e.split(":")[1]]:Object.keys(r.tables[e].indexes);o.chainAsync(c,function(e,t,i,s){o.adapterFilters(r).readIndexKeys(u,e,"all",void 0,void 0,!1,function(t,r){n(e,{indexId:r,rowId:t})},i,s)}).then(s).catch(a)}else o.adapterFilters(r).readMulti(e,"all",void 0,void 0,!1,function(t){n(e,t)},s,a||o.noop)})},e.prototype.rawImport=function(e,t,n){var r=this,i=0,s=Object.keys(e).reduce(function(t,n){return t+=e[n].length},0),a=Object.keys(this.tables),u=t?Object.keys(e):Object.keys(e).filter(function(e){return-1!==a.indexOf(e)});return o.chainAsync(u,function(a,u,c,l){if(t){var f=a.split(":")[0],d=a.split(":")[1];o.chainAsync(e[a],function(e,t,n,i){o.adapterFilters(r).addIndexValue(f,d,e.rowId,e.indexId,n,i)}).then(c).catch(l)}else{var h=r.tables[a].pkCol;o.chainAsync(e[a],function(e,t,u,c){o.deepGet(h,e)||!c?o.adapterFilters(r).write(a,o.deepGet(h,e),e,function(e){u(),i++,n&&n(Math.round(i/s*1e4)/100)},c||o.noop):c("No primary key found, can't import: "+JSON.stringify(e))}).then(c).catch(l)}})},e.prototype.disconnect=function(){var e=this;return new Promise(function(t,n){e.doFilter("disconnect",{},function(){o.adapterFilters(e).disconnect(t,n)},n)})},e.prototype.extend=function(e){for(var t=this,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];return new Promise(function(r,i){t.doFilter("extend",{scope:e,args:n,result:null},r,i)})},e.prototype.loadJS=function(e,t){var n=this,i=this.state.selectedTable;if("string"!=typeof i)return Promise.reject("nSQL: Can't load JS into temporary table!");var s=e.length,a=0;return o.chainAsync(e,function(e,u,c,l){n.triggerQuery(r({},o.buildQuery(n,i,"upsert"),{actionArgs:e}),function(e){},function(){a++,t&&t(a/s*1e4/100),c()},l)})},e.prototype.JSONtoCSV=function(e,t,n){var r=[];if(!e.length)return"";var i=[];return n?i=n:(e.forEach(function(e){i=Object.keys(e).concat(i)}),i=i.filter(function(e,t,n){return n.indexOf(e)===t})),t&&r.push(i.map(function(e){return'"'+e+'"'}).join(",")),e.forEach(function(e){r.push(i.map(function(t){return null===e[t]||void 0===e[t]?"":"string"==typeof e[t]?'"'+e[t].replace(/\"/g,'""')+'"':"boolean"==typeof e[t]?!0===e[t]?"true":"false":"object"==typeof e[t]?'"'+JSON.stringify(e[t]).replace(/\"/g,'""')+'"':e[t]}).join(","))}),r.join("\n")},e.prototype.csvToArray=function(e){for(var t,n="",r=[""],i=[r],o=0,s=0,a=!0,u=0,c=e;u<c.length;u++)'"'===(t=c[u])?(a&&t===n&&(r[o]+=t),a=!a):","===t&&a?t=r[++o]="":"\n"===t&&a?("\r"===n&&(r[o]=r[o].slice(0,-1)),r=i[++s]=[t=""],o=0):r[o]+=t,n=t;return i[0]},e.prototype.CSVtoJSON=function(e,t){var n=this,r=[];return e.split(/\r?\n|\r|\t/gm).map(function(e,i){if(0!==i){var o=n.csvToArray(e);if(o){o=o.map(function(e){return e.trim()});for(var s=r.length,a={};s--;)if(o[s])if("true"===o[s]||"false"===o[s])a[r[s]]="true"===o[s];else if(0===o[s].indexOf("{")||0===o[s].indexOf("["))try{a[r[s]]=JSON.parse(o[s])}catch(e){a[r[s]]=o[s]}else 0===o[s].indexOf('"')?a[r[s]]=o[s].slice(1,o[s].length-1).replace(/\"\"/gim,'"'):a[r[s]]=o[s];return t?t(a):a}}else r=e.split(",").map(function(e){return e.substring(1,e.length-1)})}).filter(function(e){return e})},e.prototype.loadCSV=function(e,t,n){var i=this,s=this.state.selectedTable;if("string"!=typeof s)return Promise.reject("nSQL: Can't load CSV into temporary table!");var a=this.CSVtoJSON(e,t);return o.chainAsync(a,function(e,t,u,c){n&&n(Math.round((t+1)/a.length*1e4)/100),i.triggerQuery(r({},o.buildQuery(i,s,"upsert"),{actionArgs:e}),o.noop,u,c||o.noop)})},e}();t.nanoSQL=y;var g=new y;t.nSQL=function(e){return g.selectTable(e)},"undefined"!=typeof window&&(window["@nano-sql"]||(window["@nano-sql"]={}),window["@nano-sql"].core={nSQL:t.nSQL,nanoSQL:y,utilities:p})}).call(this,n(3))},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(4),o={},s=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return t.map(function(t){return parseFloat(isNaN(t)?r.getFnValue(e,t):t)})};t.attachDefaultFns=function(e){e.functions={COUNT:{type:"A",aggregateStart:{result:0,row:{}},call:function(e,t,n,i){return i&&"*"!==i?r.getFnValue(t,i)&&n.result++:n.result++,n.row=t,n}},MAX:{type:"A",aggregateStart:{result:void 0,row:{}},call:function(e,t,n,i){var o=r.getFnValue(t,i)||0;return void 0===n.result?(n.result=o,n.row=t):o>n.result&&(n.result=o,n.row=t),n}},MIN:{type:"A",aggregateStart:{result:void 0,row:{}},call:function(e,t,n,i){var o=r.getFnValue(t,i)||0;return void 0===n.result?(n.result=o,n.row=t):o<n.result&&(n.result=o,n.row=t),n}},GREATEST:{type:"S",call:function(e,t,n){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return{result:i.map(function(e){return isNaN(e)?r.getFnValue(t,e):parseFloat(e)}).sort(function(e,t){return e<t?1:-1})[0]}}},LEAST:{type:"S",call:function(e,t,n){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return{result:i.map(function(e){return isNaN(e)?r.getFnValue(t,e):parseFloat(e)}).sort(function(e,t){return e>t?1:-1})[0]}}},AVG:{type:"A",aggregateStart:{result:0,row:{},total:0,records:0},call:function(e,t,n,i){var o=parseFloat(r.getFnValue(t,i)||0)||0;return n.total+=isNaN(o)?0:o,n.records++,n.result=n.total/n.records,n.row=t,n}},SUM:{type:"A",aggregateStart:{result:0,row:{}},call:function(e,t,n,i){var o=parseFloat(r.getFnValue(t,i)||0)||0;return n.result+=isNaN(o)?0:o,n.row=t,n}},ADD:{type:"S",call:function(e,t,n){for(var r=[],i=3;i<arguments.length;i++)r[i-3]=arguments[i];return{result:s(t,r).reduce(function(e,t,n){return 0===n?t:e+t})}}},SUB:{type:"S",call:function(e,t,n){for(var r=[],i=3;i<arguments.length;i++)r[i-3]=arguments[i];return{result:s(t,r).reduce(function(e,t,n){return 0===n?t:e-t})}}},DIV:{type:"S",call:function(e,t,n,r){for(var i=[],o=4;o<arguments.length;o++)i[o-4]=arguments[o];return{result:s(t,i).reduce(function(e,t,n){return 0===n?t:e/t})}}},MULT:{type:"S",call:function(e,t,n){for(var r=[],i=3;i<arguments.length;i++)r[i-3]=arguments[i];return{result:s(t,r).reduce(function(e,t,n){return 0===n?t:e*t})}}},MOD:{type:"S",call:function(e,t,n,r,i){var o=s(t,r,i);return{result:o[0]%o[1]}}},PI:{type:"S",call:function(e,t,n){return{result:Math.PI}}},TRUNCATE:{type:"S",call:function(e,t,n,r,i){var o=s(t,r,i),a=o[0],u=o[1];return{result:parseFloat(a.toFixed(u))}}},LOWER:{type:"S",call:function(e,t,n,i){return{result:String(r.getFnValue(t,i)).toLowerCase()}}},TRIM:{type:"S",call:function(e,t,n,i){return{result:String(r.getFnValue(t,i)).trim()}}},UPPER:{type:"S",call:function(e,t,n,i){return{result:String(r.getFnValue(t,i)).toUpperCase()}}},CAST:{type:"S",call:function(e,t,n,i,o){return{result:r.cast(r.getFnValue(t,o),r.getFnValue(t,i),!1,e.parent)}}},CONCAT:{type:"S",call:function(e,t,n){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return{result:i.map(function(e){return r.getFnValue(t,e)}).join("")}}},CONCAT_WS:{type:"S",call:function(e,t,n,i){for(var o=[],s=4;s<arguments.length;s++)o[s-4]=arguments[s];return{result:o.map(function(e){return r.getFnValue(t,e)}).join(r.getFnValue(t,i))}}},REPLACE:{type:"S",call:function(e,t,n,i,o,s){var a=String(r.getFnValue(t,i)),u=String(r.getFnValue(t,o)),c=String(r.getFnValue(t,s));return{result:a.replace(u,c)}}},STRCMP:{type:"S",call:function(e,t,n,i,o){var s=String(r.getFnValue(t,i)),a=String(r.getFnValue(t,o));return s<a?{result:-1}:s>a?{result:1}:{result:0}}},LEVENSHTEIN:{type:"S",call:function(e,t,n,s,a){var u=r.getFnValue(t,s),c=r.getFnValue(t,a),l=u+"::"+c;return o[l]||(o[l]=i(u,c)),{result:o[l]}}},IF:{type:"S",call:function(e,t,n,i,o,s){var a=i.split(/<|=|>|<=|>=/gim).map(function(e){return isNaN(e)?r.getFnValue(t,e):parseFloat(e)}),u=i.match(/<|=|>|<=|>=/gim)[0];if(!u)return{result:r.getFnValue(t,s)};switch(u){case"=":return a[0]==a[1]?r.getFnValue(t,o):r.getFnValue(t,s);case">":return a[0]>a[1]?r.getFnValue(t,o):r.getFnValue(t,s);case"<":return a[0]<a[1]?r.getFnValue(t,o):r.getFnValue(t,s);case"<=":return a[0]<=a[1]?r.getFnValue(t,o):r.getFnValue(t,s);case">=":return a[0]<a[1]?r.getFnValue(t,o):r.getFnValue(t,s);default:return{result:r.getFnValue(t,s)}}}},CROW:{type:"S",call:function(t,n,i,o,s,a){var u=r.getFnValue(n,o+".lat"),c=r.getFnValue(n,o+".lon");return{result:r.crowDistance(u,c,parseFloat(s),parseFloat(a),e.planetRadius)}},checkIndex:function(t,n,i){if("<"===i[1]||"<="===i[1]){var o="string"==typeof t.table?e.tables[t.table].indexes:{},s=r.resolvePath(n[0]),a=[];if(Object.keys(o).forEach(function(e){var t=o[e];"float"===t.type&&r.objectsEqual(t.path.slice(0,t.path.length-1),s)&&a.push(e.replace(".lat","").replace(".lon",""))}),2===a.length)return{index:a[0],parsedFn:{name:"CROW",args:n},comp:i[1],value:i[2]}}return!1},queryIndex:function(t,n,i,o,s,a){var u=t.table,c=n.index+".lat",l=n.index+".lon",f=n.comp,d=parseFloat(n.value||"0"),h=parseFloat(n.parsedFn?n.parsedFn.args[1]:"0"),p=parseFloat(n.parsedFn?n.parsedFn.args[2]:"0"),y=d/(2*e.planetRadius*Math.PI)*360,g=[-1,1].map(function(e){return h+y*e}),v=[],m=[],b=!1,_=Math.max(90-y,0);if(Math.abs(g[0])>_||Math.abs(g[1])>_)b=!0,g[0]<-1*_&&(g=[-90,g[1]]),g[1]>_&&(g=[g[0],90]);else{var w=Math.max(Math.abs(g[0]),Math.abs(g[1]));if(v=[-1,1].map(function(e){return p+y*e/Math.cos(r.deg2rad(w))}),Math.abs(v[0])>180){var S=Math.abs(v[0])-180;m=[180-S,180]}if(Math.abs(v[1])>180){S=Math.abs(v[1])-180;m=[-180,-180+S]}}var q={};r.allAsync([c,l,l],function(n,i,o,s){var a=[g,v,m][i];a.length?r.adapterFilters(e,t).readIndexKeys(u,n,"range",a[0],a[1],!1,function(e,t){q[e]?q[e].num++:q[e]={key:e,lat:0,lon:0,num:0},0===i?q[e].lat=t-90:q[e].lon=t-180},function(){o(null)},s):o(null)}).then(function(){var u=0,c=Object.keys(q).filter(function(t){if(b)return!0;if(0===q[t].num)return!1;var n=r.crowDistance(q[t].lat,q[t].lon,h,p,e.planetRadius);return"<"===f?n<d:n<=d}).map(function(e){return q[e]});b||!i?r.allAsync(c,function(s,a,c,l){r.adapterFilters(t.parent,t).read(t.table,s.key,function(s){if(s){if(!b)return o(s,a),void c(null);var l=r.deepGet((n.parsedFn?n.parsedFn.args[0]:"")+".lat",s),y=r.deepGet((n.parsedFn?n.parsedFn.args[0]:"")+".lon",s),g=r.crowDistance(l,y,h,p,e.planetRadius);("<"===f?g<d:g<=d)&&(o(i?r.deepGet(e.tables[t.table].pkCol,s):s,u),u++),c(null)}else c(null)},l)}).catch(a).then(function(){s()}):c.forEach(function(e,t){o(e.key,t)})}).catch(a)}}},(Object.getOwnPropertyNames?Object.getOwnPropertyNames(Math):["abs","acos","asin","atan","atan2","ceil","cos","exp","floor","log","max","min","pow","random","round","sin","sqrt","tan"]).forEach(function(t){e.functions[t.toUpperCase()]={type:"S",call:function(e,n,r){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return{result:Math[t].apply(null,s(n,i))}}}})}},function(e,t,n){var r=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=n(0);t.secondaryIndexQueue={};var s={},a=function(){function e(e,t,n,r,i){var o=this;this.nSQL=e,this.query=t,this.progress=n,this.complete=r,this.error=i,this._queryBuffer=[],this._stream=!0,this._selectArgs=[],this._pkOrderBy=!1,this._idxOrderBy=!1,this._sortGroups=[],this._sortGroupKeys={},this.query.state="processing",this._indexesUsed=[],this._startTime=Date.now();var s=t.action.toLowerCase().trim();if(this._orderByRows=this._orderByRows.bind(this),this._onError=this._onError.bind(this),"select"!==s&&"string"!=typeof t.table)return this.query.state="error",void this.error('Only "select" queries are available for this resource!');if("string"==typeof t.table&&!this.nSQL.state.connected)return this.query.state="error",void this.error("Can't execute query before the database has connected!");var a=function(e,t){return"string"!=typeof o.query.table?(o.query.state="error",void o.error(o.query.action+" query requires a string table argument!")):e&&!o.query.actionArgs?(o.query.state="error",void o.error(o.query.action+" query requires an additional argument!")):void t()},u=function(){"error"!==o.query.state&&(o.query.state="complete",o.complete())};switch(this.query.cacheID||(this.query.cacheID=this.query.queryID),s){case"select":this._select(u,this.error);break;case"upsert":this._upsert(this.progress,this.complete,this.error);break;case"delete":this._delete(this.progress,this.complete,this.error);break;case"show tables":this._showTables();break;case"describe":this._describe();break;case"describe indexes":this._describe(!0);break;case"drop":case"drop table":this._dropTable(this.query.table,u,this.error);break;case"create table":case"create table if not exists":a(!0,function(){o._createTable(o.query.actionArgs,!1,u,o.error)});break;case"alter table":a(!0,function(){o._createTable(o.query.actionArgs,!0,u,o.error)});break;case"rebuild indexes":a(!1,function(){o._rebuildIndexes(o.progress,u,o.error)});break;case"conform rows":a(!1,function(){o._conform(o.progress,u,o.error)});break;default:this.nSQL.doFilter("customQuery",{result:void 0,query:this,onRow:n,complete:r,error:i},function(){o.query.state="error",o.error('Query type "'+t.action+'" not supported!')},function(e){o.query.state="error",o.error(e)})}}return e.prototype._conform=function(e,t,n){var r=this,i=this.query.table,s=this.query.actionArgs||function(e){return e};if(this.nSQL.tables[i]){var a=new o._nanoSQLQueue(function(t,s,a,u){var c=r.nSQL.default(t,i);r.nSQL.doFilter("conformRow",{result:c,oldRow:t},function(n){r._diffUpdates(r.query.table,t,n,function(){var u={target:i,path:"*",events:["upsert","change","*"],time:Date.now(),performance:Date.now()-r._startTime,result:n,oldRow:t,query:r.query,indexes:r._indexesUsed};r.nSQL.state.hasAnyEvents&&(r.nSQL.triggerEvent(u),Object.keys(r.nSQL.eventFNs[r.query.table]).forEach(function(e){"*"!==e&&(o.objectsEqual(o.deepGet(e,t),o.deepGet(e,n))||r.nSQL.triggerEvent({target:r.query.table,path:e,events:["upsert","change","*"],time:Date.now(),performance:Date.now()-r._startTime,result:n,oldRow:t,query:r.query,indexes:r._indexesUsed},!0))})),e(r.query.returnEvent?u:n,s),0,a()},u)},n)},n,function(){t()});this._getRecords(function(e,t){a.newItem(s(e))},function(){a.finished()})}else n(new Error("Table "+i+" not found for conforming!"))},e.prototype._getTable=function(e,t,n,r){var i=this,o=this.query.cacheID;if("function"==typeof n){if(s[o]||(s[o]={}),!s[o][e])return s[o][e]={loading:!0,rows:[],cache:!0},void n(t).then(function(t){var n=t.cache&&!t.filtered||!1;s[o][e]={loading:!1,rows:n?t.rows:[],cache:n},r(t)}).catch(this._onError);if(s[o][e].loading)return void setTimeout(function(){i._getTable(e,t,n,r)},10);if(s[o][e].cache)return void r({filtered:!1,rows:s[o][e].rows,cache:!0});n(t).then(function(e){r(e)}).catch(this._onError)}else r({rows:n,filtered:!1,cache:!1})},e.prototype._maybeJoin=function(e,t,n,i){var s,a=this;if(!e[0])return n(t),void i();var u=function(t,i,s){var c=e[i],l=0,f=[];if("cross"!==c.type&&!c.on)return a.query.state="error",void a.error(new Error("Non 'cross' joins require an 'on' parameter!"));var d=new Error("Must use 'AS' when joining temporary tables!");if("string"!=typeof c.with.table&&!c.with.as)return a.query.state="error",void a.error(d);if("string"!=typeof a.query.table&&!a.query.tableAS)return a.query.state="error",void a.error(d);var h=new o._nanoSQLQueue(function(t,r,o,s){e[i+1]?u(t,i+1,o):(n(t),o())},a.error,s),p="string"==typeof c.with.table?a.nSQL.tables[c.with.table].pkCol:[],y=String(c.with.as||c.with.table),g=String(a.query.tableAS||a.query.table),v=a.query.tableAS||a.query.table,m=c.on&&"cross"!==c.type?a._buildCombineWhere(c.on,c.with.as||c.with.table,v,t):[];a._getTable(v,m,c.with.table,function(e){var n=function(e){var n;l++,"right"!==c.type&&"outer"!==c.type||f.push(p?o.deepGet(p,e):o.hash(JSON.stringify(e))),h.newItem(r({},t,((n={})[y]=e,n)))},i=function(){var e,n;switch(c.type){case"left":0===l&&h.newItem(r({},t,((e={})[y]=void 0,e))),h.finished();break;case"inner":case"cross":h.finished();break;case"outer":case"right":0===l&&"outer"===c.type&&h.newItem(r({},t,((n={})[y]=void 0,n))),a.nSQL.triggerQuery(r({},o.buildQuery(a.nSQL,c.with.table,"select"),{skipQueue:!0,cacheID:a.query.cacheID,where:p?[p,"NOT IN",f]:void 0}),function(e){var n;(p||-1===f.indexOf(o.hash(JSON.stringify(e))))&&h.newItem(r({},t,((n={})[g]=void 0,n[y]=e,n)))},function(){h.finished()},function(e){a.query.state="error",a.error(e)})}};e.filtered?(e.rows.forEach(n),i()):a.nSQL.triggerQuery(r({},o.buildQuery(a.nSQL,e.rows,"select"),{tableAS:c.with.as,cacheID:a.query.cacheID,where:c.on&&"cross"!==c.type?a._buildCombineWhere(c.on,c.with.as||c.with.table,v,t):void 0,skipQueue:!0}),n,i,function(e){a.query.state="error",a.error(e)})})};u(((s={})[String(this.query.tableAS||this.query.table)]=t,s),0,i)},e.prototype._select=function(e,t){var n=this;if(this._whereArgs=this.query.where?this._parseWhere(this.query.where,"string"!=typeof this.query.table||void 0!==this.query.union):{type:i.IWhereType.none},this._havingArgs=this.query.having?this._parseWhere(this.query.having,!0):{type:i.IWhereType.none},this._parseSelect(),"error"!==this.query.state){var r=[this.query.offset||0,(this.query.offset||0)+(this.query.limit||0)],a=r[0]+r[1]>0;if(this.query.union){var u=[],c=[],l=0;o.chainAsync(this.query.union.queries,function(e,t,i){e().then(function(e){c.length||(c=Object.keys(e[0])),n.query.where&&(e=e.filter(function(e,t){return n._where(e,n._whereArgs.slowWhere)})),e=e.map(function(e){if(n.query.union&&"distinct"===n.query.union.type){var r=o.hash(JSON.stringify(e));if(0===t)u.push(r);else{if(-1!==u.indexOf(r))return;u.push(r)}}return Object.keys(e).reduce(function(t,n,r){return r<c.length&&(t[c[r]]=e[n]),t},{})}).filter(function(e){return e}),n.query.orderBy?n._queryBuffer=n._queryBuffer.concat(e.map(function(e){var t=n._streamAS(e);return!n.query.having||n._where(t,n._havingArgs.slowWhere)?t:void 0}).filter(function(e){return e})):e.forEach(function(e,t){var i=n._streamAS(e);(!n.query.having||n._where(i,n._havingArgs.slowWhere))&&(a?l>=r[0]&&l<r[1]&&n.progress(n._streamAS(e),l):n.progress(n._streamAS(e),l),l++)}),i()})}).then(function(){if(n.query.orderBy){var t=n._queryBuffer.sort(n._orderByRows);(a?t.slice(r[0],r[1]):t).forEach(n.progress)}n.query.cacheID&&n.query.cacheID===n.query.queryID&&delete s[n.query.cacheID],e()})}else{var f=Array.isArray(this.query.join)?this.query.join:[this.query.join],d=0,h=new o._nanoSQLQueue(function(e,t,r,i){n.query.graph?n._graph(n.query.graph||[],n.query.tableAS||n.query.table,e,p,function(t,i){var o=n._streamAS(t);n.query.having?n._where(n._streamAS(e),n._havingArgs.slowWhere)&&n.progress(o,d):n.progress(o,d),d++,r()}):(n.progress(n._streamAS(e),d),d++,r())},this._onError,function(){n.query.cacheID&&n.query.cacheID===n.query.queryID&&delete s[n.query.cacheID],e()}),p=0,y=new o._nanoSQLQueue(function(e,t,i,o){n._maybeJoin(f,e,function(e){n._stream?((!a||p>=r[0]&&p<r[1])&&h.newItem(e),p++):n._queryBuffer.push(e)},i)},this.error,function(){n._stream?h.finished():o.allAsync(n._queryBuffer,function(e,t,r){n._graph(n.query.graph||[],n.query.tableAS||n.query.table,e,t,r)}).then(function(t){n._queryBuffer=t,n._groupByRows(),n.query.having&&(n._queryBuffer=n._queryBuffer.filter(function(e){return n._where(e,n._havingArgs.slowWhere)})),n.query.orderBy&&!n._hasOrdered&&n._queryBuffer.sort(n._orderByRows),a&&(n._queryBuffer=n._queryBuffer.slice(r[0],r[1])),n._queryBuffer.forEach(function(e,t){n.progress(e,t)}),n.query.cacheID&&n.query.cacheID===n.query.queryID&&delete s[n.query.cacheID],e()})}),g="string"==typeof this.query.table;this._getRecords(function(e,t){var r={target:n.query.table,path:"_all_",events:["select","*"],time:Date.now(),performance:Date.now()-n._startTime,result:e,query:n.query,indexes:n._indexesUsed};g&&n.nSQL.triggerEvent(r),n.query.returnEvent?n.progress(r,t):y.newItem(e)},function(){n.query.returnEvent?e():y.finished()})}}},e.prototype._groupByRows=function(){var e=this;this.query.groupBy||this._hasAggrFn?(this._queryBuffer.sort(function(t,n){return e._sortObj(t,n,e._groupBy)}).forEach(function(t,n){var r=e._groupBy.sort.map(function(n){return String(n.fn?o.execFunction(e.query,n.fn,t,{result:void 0}).result:o.deepGet(n.path,t))}).join(".");void 0===e._sortGroupKeys[r]&&(e._sortGroupKeys[r]=e._sortGroups.length);var i=e._sortGroupKeys[r];e._sortGroups[i]||e._sortGroups.push([]),e._sortGroups[i].push(t)}),this.query.orderBy&&(this._hasOrdered=!0,this._sortGroups=this._sortGroups.map(function(t){return t.sort(function(t,n){return e._sortObj(t,n,e._orderBy)})})),this._queryBuffer=[],this._hasAggrFn?this._sortGroups.forEach(function(t){var n=e._selectArgs.reduce(function(t,n,r){var i=n.value.split("(").shift();return n.isFn&&e.nSQL.functions[i]&&"A"===e.nSQL.functions[i].type&&(t[r]={idx:r,name:n.value,aggr:o.assign(e.nSQL.functions[i].aggregateStart)}),t},[]),r=n.filter(function(e){return e})[0];t.forEach(function(t,r){n.forEach(function(r,i){r&&(n[i].aggr=o.execFunction(e.query,n[i].name,t,n[i].aggr))})}),e._queryBuffer.push(e._selectArgs.reduce(function(t,i,s){var a=i.value;return t[i.as||a]=i.isFn&&n[s]?n[s].aggr.result:i.isFn?o.execFunction(e.query,i.value,n[r.idx].aggr.row,{result:void 0}).result:o.deepGet(i.value,n[r.idx].aggr.row),t},{}))}):this._sortGroups.forEach(function(t){e._queryBuffer.push(e._streamAS(t.pop()))})):this._queryBuffer=this._queryBuffer.map(function(t){return e._streamAS(t)})},e.prototype._buildCombineWhere=function(e,t,n,r){var i=this;return"function"==typeof e?function(t){return e(t,r)}:("string"==typeof e[0]?[e]:e).map(function(e){if(Array.isArray(e[0]))return i._buildCombineWhere(e,t,n,r);if("AND"===e||"OR"===e)return e;var s=o.resolvePath(e[0]),a=o.resolvePath(e[2]),u=s[0]===n;return[u?a.slice(1).join("."):s.slice(1).join("."),u?-1!==e[1].indexOf(">")?e[1].replace(">","<"):e[1].replace("<",">"):e[1],o.deepGet(u?s:a,r)]})},e.prototype._graph=function(e,t,n,i,s){var a=this,u=Array.isArray(e)?e:[e];u&&0!==u.length?o.allAsync(u,function(e,i,s){var u,c=new Error("Must use 'AS' when graphing temporary tables!");if("string"!=typeof e.with.table&&!e.with.as)return a.query.state="error",void a.error(c);if("string"!=typeof a.query.table&&!a.query.tableAS)return a.query.state="error",void a.error(c);n[e.key]=[];var l=a._buildCombineWhere(e.on,e.with.as||e.with.table,t,((u={})[t]=n,u));a._getTable(e.with.as||e.with.table,l,e.with.table,function(t){t.filtered?(t.rows.forEach(function(t){e.single?n[e.key]=t:n[e.key].push(t)}),s(null)):a.nSQL.triggerQuery(r({},o.buildQuery(a.nSQL,t.rows,"select"),{tableAS:e.with.as,actionArgs:e.select,where:l,limit:e.limit,offset:e.offset,orderBy:e.orderBy,groupBy:e.groupBy,graph:e.graph,skipQueue:!0,cacheID:a.query.cacheID}),function(t){e.single?n[e.key]=t:n[e.key].push(t)},function(){s(null)},a._onError)})}).then(function(){s(n,i)}):s(n,i)},e.prototype._upsert=function(e,t,n){var r=this;if(this.query.actionArgs||(n("Can't upsert without records!"),this.query.state="error"),-1!==this.query.table.indexOf(".")||-1!==this.query.table.indexOf("[")){var s=o.resolvePath(this.query.table);this.query.table=s.shift(),this.upsertPath=s}if(this._whereArgs=this.query.where?this._parseWhere(this.query.where):{type:i.IWhereType.none},"error"!==this.query.state){var a=Array.isArray(this.query.actionArgs)?this.query.actionArgs:[this.query.actionArgs],u=this.nSQL.tables[this.query.table];if(this._whereArgs.type===i.IWhereType.none)o.allAsync(a,function(t,n,i,s){var a=o.deepGet(u.pkCol,t);a?o.adapterFilters(r.nSQL,r.query).read(r.query.table,a,function(o){o?r._updateRow(t,o,function(t){e(t,n),i(null)},s):r._newRow(t,function(){e({oldRow:void 0,newRow:t},n),i(null)},s)},s):r._newRow(t,function(t){e(t,n),i(null)},s)}).then(function(){t()}).catch(this._onError);else{if(a.length>1)return this.query.state="error",void n("Cannot upsert multiple records with where condition!");var c=new o._nanoSQLQueue(function(t,n,i,o){0,r._updateRow(a[0],t,function(t){e(t,n),i()},o)},n,function(){t()});this._getRecords(function(e,t){c.newItem(e)},function(){c.finished()})}}},e.prototype._updateRow=function(e,t,n,i){var s=this;this.nSQL.doFilter("updateRow",{result:e,row:t,query:this.query},function(e){var a=s.nSQL.default(s.upsertPath?o.deepSet(s.upsertPath,o.maybeAssign(t),e):r({},t,e),s.query.table);s._diffUpdates(s.query.table,t,a,function(){var e={target:s.query.table,path:"*",events:["upsert","change","*"],time:Date.now(),performance:Date.now()-s._startTime,result:a,oldRow:t,query:s.query,indexes:s._indexesUsed};"string"==typeof s.query.table&&(s.nSQL.triggerEvent(e),s.nSQL.eventFNs[s.query.table]&&Object.keys(s.nSQL.eventFNs[s.query.table]).forEach(function(e){"*"!==e&&(o.objectsEqual(o.deepGet(e,t),o.deepGet(e,a))||s.nSQL.triggerEvent({target:s.query.table,path:e,events:["upsert","change","*"],time:Date.now(),performance:Date.now()-s._startTime,result:a,oldRow:t,query:s.query,indexes:s._indexesUsed},!0))})),n(s.query.returnEvent?e:a)},i)},i)},e.prototype._checkUniqueIndexes=function(e,t,n,r,i,s){var a=this;o.allAsync(Object.keys(r),function(i,s,u,c){var l=a.nSQL.tables[a.query.table].indexes[i].props||{};if(l&&l.unique){var f=[];o.adapterFilters(a.nSQL,a.query).readIndexKey(e,i,r[i],function(e){e!==t&&f.push(e)},function(){f.length>0?c({error:"Unique Index Collision!",row:n,query:a.query}):u(null)},c)}else u(null)}).then(i).catch(s)},e.prototype._diffUpdates=function(e,t,n,r,i){var s=this,a=this._getIndexValues(this.nSQL.tables[this.query.table].indexes,n),u=this._getIndexValues(this.nSQL.tables[this.query.table].indexes,t),c=this.nSQL.tables[e];this._checkUniqueIndexes(e,o.deepGet(c.pkCol,t),t,a,function(){o.allAsync(Object.keys(u).concat(["__pk__"]),function(t,r,i,l){if("__pk__"===t)o.adapterFilters(s.nSQL,s.query).write(e,o.deepGet(c.pkCol,n),n,function(e){o.deepSet(c.pkCol,n,e),i(null)},l);else{var f=s.query.table;if(!1===o.objectsEqual(a[t],u[t]))if(c.indexes[t].isArray){var d=a[t].filter(function(e,n,r){return-1===u[t].indexOf(e)}),h=u[t].filter(function(e,n,r){return-1===a[t].indexOf(e)});o.allAsync([d,h],function(e,r,i){e.length?o.allAsync(e,function(e,i,a){s._updateIndex(f,t,e,o.deepGet(c.pkCol,n),0===r,function(){a(null)},l)}).then(i):i(null)}).then(i)}else o.allAsync(["rm","add"],function(e,r,i){switch(e){case"add":s._updateIndex(f,t,a[t],o.deepGet(c.pkCol,n),!0,function(){i(null)},l);break;case"rm":s._updateIndex(f,t,u[t],o.deepGet(c.pkCol,n),!1,function(){i(null)},l)}}).then(i);else i(null)}}).then(r).catch(i)},i)},e.prototype._updateIndex=function(e,n,r,i,s,a,u){var c={table:e,indexName:n,value:r,pk:i,addToIndex:s,done:a,err:u,query:this.query,nSQL:this.nSQL};t.secondaryIndexQueue[this.nSQL.state.id+this.query.table].newItem(c,function(e,t,n){(e.addToIndex?o.adapterFilters(e.nSQL,e.query).addIndexValue:o.adapterFilters(e.nSQL,e.query).deleteIndexValue)(e.table,e.indexName,e.pk,e.value,function(){e.done(),t()},function(n){e.err(n),t()})})},e.prototype._newRow=function(e,t,n){var r=this;this.nSQL.doFilter("addRow",{result:e,query:this.query},function(e){var i=r.nSQL.tables[r.query.table];e=r.nSQL.default(o.maybeAssign(r.upsertPath?o.deepSet(r.upsertPath,{},e):e),r.query.table);var s=r._getIndexValues(r.nSQL.tables[r.query.table].indexes,e);r._checkUniqueIndexes(r.query.table,o.deepGet(i.pkCol,e),e,s,function(){o.adapterFilters(r.nSQL,r.query).write(r.query.table,o.deepGet(i.pkCol,e),e,function(n){o.deepSet(i.pkCol,e,n),o.allAsync(Object.keys(s),function(t,n,a,u){if(i.indexes[t].isArray){var c=s[t]||[];o.allAsync(c,function(n,s,a){r._updateIndex(r.query.table,t,n,o.deepGet(i.pkCol,e),!0,function(){a(null)},u)}).then(function(){a(null)}).catch(u)}else r._updateIndex(r.query.table,t,s[t],o.deepGet(i.pkCol,e),!0,function(){a(null)},u)}).then(function(){var n={target:r.query.table,path:"*",events:["upsert","*"],time:Date.now(),performance:Date.now()-r._startTime,result:e,oldRow:void 0,query:r.query,indexes:r._indexesUsed};"string"==typeof r.query.table&&r.nSQL.triggerEvent(n),t(r.query.returnEvent?n:e)})},n)},n)},n)},e.prototype._delete=function(e,t,n){var r=this;if(this._whereArgs=this.query.where?this._parseWhere(this.query.where):{type:i.IWhereType.none},"error"!==this.query.state){var s=this.nSQL.tables[this.query.table],a=new o._nanoSQLQueue(function(t,n,i,o){r._removeRowAndIndexes(s,t,function(t){e(t,n),i()},o)},n,function(){t()});this._getRecords(function(e,t){a.newItem(e)},function(){a.finished()})}},e.prototype._removeRowAndIndexes=function(e,t,n,r){var i=this,s=this._getIndexValues(e.indexes,t);this.nSQL.doFilter("deleteRow",{result:t,query:this.query},function(t){o.allAsync(Object.keys(s).concat(["__del__"]),function(n,a,u){if("__del__"===n)o.adapterFilters(i.nSQL,i.query).delete(i.query.table,o.deepGet(e.pkCol,t),function(){u(null)},function(e){i.query.state="error",r(e)});else if(e.indexes[n].isArray){var c=s[n]||[];o.allAsync(c,function(s,a,u){i._updateIndex(i.query.table,n,s,o.deepGet(e.pkCol,t),!1,function(){u(null)},r)}).then(u)}else i._updateIndex(i.query.table,n,s[n],o.deepGet(e.pkCol,t),!1,function(){u(null)},i._onError)}).then(function(){var e={target:i.query.table,path:"_all_",events:["change","delete","*"],time:Date.now(),performance:Date.now()-i._startTime,result:t,query:i.query,indexes:i._indexesUsed};"string"==typeof i.query.table&&i.nSQL.triggerEvent(e),n(i.query.returnEvent?e:t)}).catch(r)},r)},e.prototype._getIndexValues=function(e,t){var n=this;return Object.keys(e).reduce(function(r,i){var s=o.deepGet(e[i].path,t),a=e[i].type;return r[i]=e[i].isArray?(Array.isArray(s)?s:[]).map(function(e){return n.nSQL.indexTypes[a](e)}):n.nSQL.indexTypes[a](s),r},{})},e.prototype._showTables=function(){var e=this;this.progress({tables:Object.keys(this.nSQL.tables)},0),Object.keys(this.nSQL.tables).forEach(function(t,n){e.progress({table:t},n)}),this.complete()},e.prototype._describe=function(e){var t=this;return"string"!=typeof this.query.table?(this.query.state="error",void this.error({error:"Can't call describe on that!",query:this.query})):this.nSQL.tables[this.query.table]?(e?Object.keys(this.nSQL.tables[this.query.table].indexes).forEach(function(e,n){var r=t.nSQL.tables[t.query.table].indexes[e];t.progress(o.assign(r),n)}):this.nSQL.tables[this.query.table].columns.forEach(function(e,n){t.progress(o.assign(e),n)}),void this.complete()):(this.query.state="error",void this.error({error:"Table "+this.query.table+" not found!",query:this.query}))},e.prototype._combineRows=function(e){return Object.keys(e).reduce(function(t,n){var r=e[n];return r?(Object.keys(r).forEach(function(e){t[n+"."+e]=r[e]}),t):t},{})},e.prototype._streamAS=function(e){var t=this;if(this._selectArgs.length){var n={};return this._selectArgs.forEach(function(r){r.isFn?n[r.as||r.value]=o.execFunction(t.query,r.value,e,{}).result:n[r.as||r.value]=o.deepGet(r.value,e)}),this.query.join?this._combineRows(n):n}return this.query.join?this._combineRows(e):e},e.prototype._orderByRows=function(e,t){return this._sortObj(e,t,this._orderBy)},e.prototype._sortObj=function(e,t,n){var r=this,i="string"==typeof this.query.table?this.nSQL.tables[this.query.table].pkCol:[],s=!!i.length&&o.deepGet(i,e),a=!!i.length&&o.deepGet(i,t);return n.sort.reduce(function(n,i){var u=i.fn?o.execFunction(r.query,i.fn,e,{result:void 0}).result:o.deepGet(i.path,e),c=i.fn?o.execFunction(r.query,i.fn,t,{result:void 0}).result:o.deepGet(i.path,t);return n||(u===c?s===a?0:s>a?1:-1:(u>c?1:-1)*("DESC"===i.dir?-1:1))},0)},e.prototype._createTable=function(e,n,i,s){var a=this,u=this.nSQL.tableIds[this.query.table]||o.uuid();new Promise(function(t,n){var r=!1,i=e.name;e._internal||0!==i.indexOf("_")&&null===i.match(/\s/g)&&null===i.match(/[\(\)\]\[\.]/g)?(Object.keys(e.model).forEach(function(t){var i=t.replace(/\s+/g,"-").split(":");1===i.length&&i.push("any"),i[0]&&null===i[0].match(/[\(\)\]\[\.]/g)&&0!==i[0].indexOf("_")||(r=!0,n({error:"Invalid Data Model at "+e.name+"."+t+"! https://docs.nanosql.io/setup/data-models",query:a.query}))}),r||t()):n({error:"Invalid Table Name "+e.name+"! https://docs.nanosql.io/setup/data-models",query:a.query})}).then(function(){return new Promise(function(t,n){a.nSQL.doFilter("configTable",{result:e,query:a.query},t,n)})}).then(function(e){var i=function(e,t){if("string"==typeof e){var n=!1,o=-1!==e.indexOf("[]"),s=e.replace(/\[\]/gim,"");if(0===t&&o)throw new Error("Can't use array types as table definition.");if(Object.keys(a.nSQL.config.types||{}).reduce(function(e,r){return r===s[1]&&(n=!0,(a.nSQL.config.types||{})[r].forEach(function(n){e[n]={model:i(n,t+1)}})),e},{}),!1===n){if(0===t)throw new Error("Type "+e+" not found!");return}}else e;return Object.keys(e).reduce(function(n,o){return 0===(o.split(":")[1]||"any").indexOf("geo")?n[o]={default:{lat:0,lon:0},model:{"lat:float":{max:90,min:-90},"lon:float":{max:180,min:-180}}}:e[o].model?n[o]=r({},e[o],{model:i(e[o].model,t+1)}):n[o]=e[o],n},{})},s=function(e){return Object.keys(e).filter(function(e){return"*"!==e}).map(function(t){return{key:t.split(":")[0],type:t.split(":")[1]||"any",ai:e[t].ai,pk:e[t].pk,default:e[t].default,notNull:e[t].notNull,max:e[t].max,min:e[t].min,model:e[t].model?s(e[t].model):void 0}})},c="",l=i(e.model,0),f=function(e){return"string"==typeof e?"":Object.keys(e).reduce(function(t,n){return e[n]&&e[n].pk?n.split(":")[1]:!t.length&&e[n].model?f(e[n].model):t},"")},d=e.indexes||{},h=!1,p=function(e,t){if("string"==typeof t)return[];var n=!1;return Object.keys(t).reduce(function(r,i){return t[i]&&t[i].pk?(n=!0,t[i].ai&&(h=!0),r.push(i.split(":")[0]),r):!n&&t[i].model?p(e.concat([i.split(":")[0]]),t[i].model):r},e)},y=e.primaryKey?e.primaryKey.split(":")[1]:f(e.model),g={id:u,model:l,columns:s(l),filter:e.filter,actions:e.actions||[],foreignKeys:[],views:e.views||[],indexes:Object.keys(d).map(function(e){return{id:o.resolvePath(e.split(":")[0]).join("."),type:(e.split(":")[1]||"string").replace(/\[\]/gim,""),isArray:-1!==(e.split(":")[1]||"string").indexOf("[]"),path:o.resolvePath(e.split(":")[0]),props:d[e]}}).reduce(function(e,t){return-1===Object.keys(a.nSQL.indexTypes).indexOf(t.type)?(c='Index "'+t.id+'" does not have a valid type!',e):(-1!==t.type.indexOf("geo")?(e[t.id+".lon"]={id:t.id+".lon",type:"float",isArray:!1,path:t.path.concat(["lon"]),props:{offset:180}},e[t.id+".lat"]={id:t.id+".lat",type:"float",isArray:!1,path:t.path.concat(["lat"]),props:{offset:90}}):e[t.id]=t,e)},{}),pkType:y,pkCol:e.primaryKey?o.resolvePath(e.primaryKey.split(":")[0]):p([],e.model),isPkNum:-1!==["number","int","float"].indexOf(y),ai:h};if(0===g.pkCol.length&&(g.pkCol=["_id"],g.pkType="uuid",g.model["_id:uuid"]={pk:!0},g.columns=s(i(g.model,0))),c&&c.length)return Promise.reject(c);var v=n?Object.keys(a.nSQL.tables[a.query.table].indexes):[],m=Object.keys(g.indexes),b=m.filter(function(e){return-1===v.indexOf(e)}),_=[e.name].concat(b);return t.secondaryIndexQueue[a.nSQL.state.id+e.name]=new o._nanoSQLQueue,o.chainAsync(_,function(t,r,i,s){if(0===r){var c={name:t,conf:g};if(a.nSQL.tableIds[c.name]=u,n){delete a.nSQL.tableIds[a.query.table];var l=v.filter(function(e){return-1===m.indexOf(e)});o.allAsync(l,function(e,n,r,i){o.adapterFilters(a.nSQL,a.query).deleteIndex(t,e,function(){r(null)},i)}).then(function(){a.nSQL.tables[c.name]=c.conf,i(null)}).catch(s)}else o.adapterFilters(a.nSQL,a.query).createTable(c.name,c.conf,function(){a.nSQL.tables[c.name]=c.conf,i(null)},s)}else{var f=g.indexes[t];o.adapterFilters(a.nSQL,a.query).createIndex(e.name,f.id,f.type,function(){i(null)},s)}})}).then(function(){return a.nSQL.saveTableIds()}).then(function(){i()}).catch(s)},e.prototype._dropTable=function(e,t,n){var r=this,i=[e];Object.keys(this.nSQL.tables[e].indexes).forEach(function(e){i.push(e)}),o.allAsync(i,function(t,n,i,s){0===n?o.adapterFilters(r.nSQL,r.query).dropTable(t,function(){delete r.nSQL.tables[t],delete r.nSQL.tableIds[t],r.nSQL.saveTableIds().then(function(){i(t)}).catch(s)},s):o.adapterFilters(r.nSQL,r.query).deleteIndex(e,t,i,s)}).then(function(){t()}).catch(n)},e.prototype._onError=function(e){this.query.state="error",this.error(e)},e.prototype._resolveFastWhere=function(e,t,n,r,i){var s=this;if(t.index&&t.parsedFn)this.nSQL.functions[t.parsedFn.name].queryIndex(this.query,t,e,r,i,this._onError);else{var a="_pk_"===t.index,u=this.nSQL.tables[this.query.table].pkCol,c=0,l=new o._nanoSQLQueue(function(t,n,i,l){t?a?(r(e?o.deepGet(u,t):t,0),i()):e?(r(t,c),c++,i()):o.adapterFilters(s.nSQL,s.query).read(s.query.table,t,function(e){e&&r(e,c),c++,i()},s.error):i()},this._onError,i);if(t.indexArray)switch(t.comp){case"INCLUDES":o.adapterFilters(this.nSQL,this.query).readIndexKey(this.query.table,t.index,t.value,function(e){l.newItem(e)},function(){l.finished()},this.error);break;case"INTERSECT ALL":case"INTERSECT":var f={},d=0;o.allAsync(t.value||[],function(e,n,r){o.adapterFilters(s.nSQL,s.query).readIndexKey(s.query.table,t.index,e,function(e){d=n+1,e&&(f[e]=(f[e]||0)+1)},function(){r(null)},s.error)}).then(function(){("INTERSECT"===t.comp?Object.keys(f):Object.keys(f).filter(function(e){return f[e]===d})).forEach(function(e){l.newItem(e)}),l.finished()})}else switch(t.comp){case"=":e&&a?(r(t.value,0),i()):a?o.adapterFilters(this.nSQL,this.query).read(this.query.table,t.value,function(e){l.newItem(e),l.finished()},this.error):o.adapterFilters(this.nSQL,this.query).readIndexKey(this.query.table,t.index,t.value,function(e){l.newItem(e)},function(){l.finished()},this.error);break;case"BETWEEN":a?o.adapterFilters(this.nSQL,this.query).readMulti(this.query.table,"range",t.value[0],t.value[1],n,function(e,t){l.newItem(e)},function(){l.finished()},this._onError):o.adapterFilters(this.nSQL,this.query).readIndexKeys(this.query.table,t.index,"range",t.value[0],t.value[1],n,function(e){l.newItem(e)},function(){l.finished()},this._onError);break;case"IN":var h=n?t.value.sort(function(e,t){return e<t?1:-1}):t.value.sort(function(e,t){return e>t?1:-1});e&&a?(h.forEach(function(e,t){return r(e,t)}),i()):o.chainAsync(h,function(e,n,r){a?o.adapterFilters(s.nSQL,s.query).read(s.query.table,e,function(e){l.newItem(e),r()},s.error):o.adapterFilters(s.nSQL,s.query).readIndexKey(s.query.table,t.index,e,function(e){l.newItem(e)},function(){r()},s.error)}).then(function(){l.finished()})}}},e.prototype._fastQuery=function(e,t){var n=this;if(this._whereArgs.fastWhere)if(1===this._whereArgs.fastWhere.length){var r=this._whereArgs.fastWhere[0],i=this._pkOrderBy&&"DESC"===this._orderBy.sort[0].dir;this._resolveFastWhere(!1,r,i,function(t,n){e(t,n)},t)}else{var s={},a=0;o.chainAsync(this._whereArgs.fastWhere,function(e,t,r){if(t%2!=1){a=t;n._resolveFastWhere(!0,e,!1,function(e){s[e]=(s[e]||0)+1},r)}else r()}).then(function(){var r=[];Object.keys(s).forEach(function(e){s[e]===a&&r.push(e)}),n._resolveFastWhere(!1,{index:"_pk_",col:n.nSQL.tables[n.query.table].pkCol.join("."),comp:"IN",value:r},!1,e,t)})}},e.prototype._getRecords=function(e,t){var n=this,r=function(r){for(var o=0;o<r.length;)n._whereArgs.type!==i.IWhereType.none?n._whereArgs.whereFn?n._whereArgs.whereFn(r[o],o)&&e(r[o],o):n._where(r[o],n._whereArgs.slowWhere)&&e(r[o],o):e(r[o],o),o++;t()};if("string"==typeof this.query.table)switch(this._whereArgs.type){case i.IWhereType.fast:this._fastQuery(e,t);break;case i.IWhereType.medium:this._fastQuery(function(t,r){n._where(t,n._whereArgs.slowWhere)&&e(t,r)},t);break;case i.IWhereType.slow:case i.IWhereType.none:case i.IWhereType.fn:var s=this._pkOrderBy&&"DESC"===this._orderBy.sort[0].dir;o.adapterFilters(this.nSQL,this.query).readMulti(this.query.table,"all",void 0,void 0,s,function(t,r){n._whereArgs.type===i.IWhereType.slow?n._where(t,n._whereArgs.slowWhere)&&e(t,r):n._whereArgs.type===i.IWhereType.fn&&n._whereArgs.whereFn?n._whereArgs.whereFn(t,r)&&e(t,r):e(t,r)},function(){t()},this._onError)}else"function"==typeof this.query.table?this._getTable(this.query.tableAS||this.query.table,this.query.where,this.query.table,function(e){r(e.rows)}):Array.isArray(this.query.table)&&r(this.query.table)},e.prototype._rebuildIndexes=function(e,n,r){var i=this,s=this.query.table;if(this.nSQL.tables[s])if(this.query.where){var a=new o._nanoSQLQueue(function(t,n,r,o){i._removeRowAndIndexes(i.nSQL.tables[s],t,function(){i._newRow(t,r,o),e(t,n)},o)},r,function(){n()});this._getRecords(function(e){a.newItem(e)},function(){a.finished()})}else{var u=Object.keys(this.nSQL.tables[s].indexes);o.allAsync(u,function(e,t,n,r){o.adapterFilters(i.nSQL,i.query).deleteIndex(s,e,function(){o.adapterFilters(i.nSQL,i.query).createIndex(s,e,i.nSQL.tables[s].indexes[e].type,function(){n(null)},r)},r)}).then(function(){t.secondaryIndexQueue[i.nSQL.state.id+s].newItem(o.uuid(),function(t,s,a){var u=new o._nanoSQLQueue(function(t,n,r,o){i._newRow(t,function(t){e(t,n),r()},o)},r,function(){n(),s()});i._getRecords(function(e){u.newItem(e)},function(){u.finished()})})}).catch(r)}else r(new Error("Table "+s+" not found for rebuilding indexes!"))},e.prototype._where=function(e,t){if(t.length>1){for(var n="AND",r=!0,i=0;i<t.length;){var o=t[i];if(i%2==1)n=o;else{var s=!1;s=Array.isArray(o[0])?this._where(e,o):this._compare(o,e),r=0===i?s:"AND"===n?r&&s:r||s}i++}return r}return this._compare(t[0],e)},e.prototype._processLIKE=function(t,n){if(!e.likeCache[n]){var r="";e.likeCache[n]=new RegExp(n.split("").map(function(e){return"\\"===r?(r=e,e):(r=e,"%"===e?".*":"_"===e?".":e)}).join(""),"gmi")}return"string"!=typeof t?"number"==typeof t?null!==String(t).match(e.likeCache[n]):null!==JSON.stringify(t).match(e.likeCache[n]):null!==t.match(e.likeCache[n])},e.prototype._getColValue=function(e,t){return e.fnString?o.execFunction(this.query,e.fnString,t,{result:void 0}).result:o.deepGet(e.col,t)},e.prototype._compare=function(e,t){var n=this._getColValue(e,t),r=e.value,i=e.comp;if("NULL"===r||"NOT NULL"===r){var s=-1!==[void 0,null,""].indexOf(n),a="="===i||"LIKE"===i;switch(r){case"NULL":return a?s:!s;case"NOT NULL":return a?!s:s}}if(-1!==["IN","NOT IN","BETWEEN","INTERSECT","INTERSECT ALL","NOT INTERSECT"].indexOf(i)&&!Array.isArray(r))return this.query.state="error",this.query.error('WHERE "'+i+'" comparison requires an array value!'),!1;switch(i){case"=":return o.objectsEqual(r,n);case"!=":return!o.objectsEqual(r,n);case">":return n>r;case"<":return n<r;case"<=":return n<=r;case">=":return n>=r;case"IN":return-1!==r.indexOf(n);case"NOT IN":return-1===r.indexOf(n);case"REGEXP":case"REGEX":return null!==(n||"").match(r);case"LIKE":return this._processLIKE(n||"",r);case"NOT LIKE":return!this._processLIKE(n||"",r);case"BETWEEN":return r[0]<=n&&r[1]>=n;case"NOT BETWEEN":return r[0]>=n||r[1]<=n;case"INCLUDES":return-1!==(n||[]).indexOf(r);case"NOT INCLUDES":return-1===(n||[]).indexOf(r);case"INTERSECT":return(n||[]).filter(function(e){return r.indexOf(e)>-1}).length>0;case"INTERSECT ALL":return(n||[]).filter(function(e){return r.indexOf(e)>-1}).length===r.length;case"NOT INTERSECT":return 0===(n||[]).filter(function(e){return r.indexOf(e)>-1}).length;default:return!1}},e.prototype._parseSort=function(t,n){var r=t&&t.length?o.hash(JSON.stringify(t)):"";if(!r)return{sort:[],index:""};if(e._sortMemoized[r])return e._sortMemoized[r];var i=!1,s=t.map(function(e){return e.split(" ").map(function(e){return e.trim()})}).reduce(function(e,t){var n=-1!==t[0].indexOf("(");return n&&(i=!0),e.push({path:n?[]:o.resolvePath(t[0]),fn:n?t[0]:void 0,dir:(t[1]||"asc").toUpperCase()}),e},[]),a="";if(n&&!1===i&&1===s.length){var u="string"==typeof this.query.table?this.nSQL.tables[this.query.table].pkCol:[];if(s[0].path[0].length&&o.objectsEqual(s[0].path,u))a="_pk_";else for(var c=Object.keys(this.nSQL.tables[this.query.table].indexes),l=c.length;l--&&!a;)o.objectsEqual(this.nSQL.tables[this.query.table].indexes[c[l]],s[0].path)&&(a=this.nSQL.tables[this.query.table].indexes[c[l]].id)}return e._sortMemoized[r]={sort:s,index:a},e._sortMemoized[r]},e.prototype._parseSelect=function(){var t=this,n=this.query.actionArgs&&this.query.actionArgs.length?JSON.stringify(this.query.actionArgs):"";this._orderBy=this._parseSort(this.query.orderBy||[],"string"==typeof this.query.table),this._groupBy=this._parseSort(this.query.groupBy||[],!1),n?e._selectArgsMemoized[n]?(this._hasAggrFn=e._selectArgsMemoized[n].hasAggrFn,this._selectArgs=e._selectArgsMemoized[n].args):((this.query.actionArgs||[]).forEach(function(e){var n=e.split(/\s+as\s+/i).map(function(e){return e.trim()});if(-1!==n[0].indexOf("(")){var r=n[0].split("(")[0].trim().toUpperCase();t._selectArgs.push({isFn:!0,value:n[0],as:n[1],args:void 0}),t.nSQL.functions[r]?"A"===t.nSQL.functions[r].type&&(t._hasAggrFn=!0):(t.query.state="error",t.error('Function "'+r+'" not found!'))}else t._selectArgs.push({isFn:!1,value:n[0],as:n[1]})}),"error"!==this.query.state&&(e._selectArgsMemoized[n]={hasAggrFn:this._hasAggrFn,args:this._selectArgs})):this._selectArgs=[];var r=!1;this._whereArgs.type===i.IWhereType.none?(r="_pk_"===this._orderBy.index)&&(this._pkOrderBy=!0):(r=!!(this._orderBy.index.length&&this._whereArgs.fastWhere&&o.objectsEqual(this._whereArgs.fastWhere[0].col,this._orderBy.sort[0].path)))&&(this._idxOrderBy=!0),(this._orderBy.sort.length&&!r||this._groupBy.sort.length||this._hasAggrFn)&&(this._stream=!1)},e.prototype._parseWhere=function(t,n){var r=this,s=t||[],a=JSON.stringify(s)+(n?"0":"1");if(e._whereMemoized[a])return e._whereMemoized[a];if("function"==typeof s)return{type:i.IWhereType.fn,whereFn:s};if(!s.length)return e._whereMemoized[a]={type:i.IWhereType.none},e._whereMemoized[a];for(var u="string"==typeof this.query.table?Object.keys(this.nSQL.tables[this.query.table].indexes).map(function(e){return r.nSQL.tables[r.query.table].indexes[e]}):[],c="string"==typeof this.query.table?this.nSQL.tables[this.query.table].pkCol:[],l=function(e,t){var i=!n&&0===t;return e.reduce(function(e,n,s){if(s%2==1)return"string"!=typeof n?(r.query.state="error",r.error("Malformed WHERE statement!"),e):(e.push(n),e);if(!Array.isArray(n))return r.query.state="error",r.error("Malformed WHERE statement!"),e;if(Array.isArray(n[0]))e.push(l(n,t+1));else if(-1!==n[0].indexOf("(")){var a=n[0].split("(")[1].replace(")","").split(",").map(function(e){return e.trim()}).filter(function(e){return e}),f=n[0].split("(")[0].trim().toUpperCase(),d=!1;if(!r.nSQL.functions[f])return r.query.state="error",r.error('Function "'+f+'" not found!'),e;if(i&&r.nSQL.functions[f]&&r.nSQL.functions[f].checkIndex){var h=r.nSQL.functions[f].checkIndex(r.query,a,n);h&&(r._indexesUsed.push(o.assign(n)),d=!0,e.push(h))}d||e.push({fnString:n[0],parsedFn:{name:f,args:a},comp:n[1],value:n[2]})}else{var p=!1,y=i?o.resolvePath(n[0]):[];-1!==["=","BETWEEN","IN"].indexOf(n[1])&&i&&(o.objectsEqual(y,c)?(p=!0,r._indexesUsed.push(o.assign(n)),e.push({index:"_pk_",col:n[0],comp:n[1],value:n[2]})):u.forEach(function(t){!1===p&&o.objectsEqual(t.path,y)&&!1===t.isArray&&(p=!0,r._indexesUsed.push(o.assign(n)),e.push({index:t.id,col:n[0],comp:n[1],value:n[2]}))})),i&&!p&&-1!==["INCLUDES","INTERSECT","INTERSECT ALL"].indexOf(n[1])&&u.forEach(function(t){o.objectsEqual(t.path,y)&&!0===t.isArray&&(p=!0,r._indexesUsed.push(o.assign(n)),e.push({index:t.id,indexArray:!0,col:n[0],comp:n[1],value:n[2]}))}),p||e.push({col:n[0],comp:n[1],value:n[2]})}return e},[])},f=l("string"==typeof s[0]?[s]:s,0),d=!0,h=0,p=-1;h<f.length&&d;)h%2==1?"AND"!==f[h]?d=!1:p=h:Array.isArray(f[h])||!f[h].index?d=!1:p=h,h++;if(p%2==0&&p++,-1===p||"AND"!==f[p]&&f[p])e._whereMemoized[a]={type:i.IWhereType.slow,slowWhere:f};else{var y=f.slice(p+1);e._whereMemoized[a]={type:y.length?i.IWhereType.medium:i.IWhereType.fast,slowWhere:y,fastWhere:f.slice(0,p)}}return e._whereMemoized[a]},e.likeCache={},e._sortMemoized={},e._selectArgsMemoized={},e._whereMemoized={},e}();t._nanoSQLQuery=a},function(e,t,n){var r,i=this&&this.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var o=n(1),s=n(0),a=function(e){function t(t){var n=e.call(this,!0,!1)||this;return n.useLS=t,n.plugin={name:"Sync Storage Adapter",version:o.VERSION},n._index={},n._rows={},n._ai={},n._tableConfigs={},n}return i(t,e),t.prototype.connect=function(e,t,n){this._id=e,t()},t.prototype.createTable=function(e,t,n,r){if(this._index[e]=[],this._rows[e]={},this._tableConfigs[e]=t,this.useLS){var i=localStorage.getItem(this._id+"->"+e+"_idx");i&&(this._index[e]=JSON.parse(i),this._ai[e]=parseFloat(localStorage.getItem(this._id+"->"+e+"_ai")||"0"))}n()},t.prototype.dropTable=function(e,t,n){var r=this;this._index[e].forEach(function(t){r.useLS?localStorage.removeItem(r._id+"->"+e+"__"+t):delete r._rows[e][t]}),this.useLS&&localStorage.removeItem(this._id+"->"+e+"_idx"),delete this._index[e],delete this._rows[e],t()},t.prototype.disconnect=function(e,t){e()},t.prototype.write=function(e,t,n,r,i){if(void 0!==(t=t||s.generateID(this._tableConfigs[e].pkType,this._ai[e]+1))){if(this._tableConfigs[e].ai&&(this._ai[e]=Math.max(this._ai[e]||0,t)),-1===this._index[e].indexOf(t)){var o=s.binarySearch(this._index[e],t,!1);this._index[e].splice(o,0,t),this.useLS&&(localStorage.setItem(this._id+"->"+e+"_idx",JSON.stringify(this._index[e])),localStorage.setItem(this._id+"->"+e+"_ai",String(this._ai[e])))}s.deepSet(this._tableConfigs[e].pkCol,n,t),this.useLS?(localStorage.setItem(this._id+"->"+e+"__"+t,JSON.stringify(n)),r(t)):(this._rows[e][t]=s.deepFreeze(n),r(t))}else i(new Error("Can't add a row without a primary key!"))},t.prototype.read=function(e,t,n,r){if(this.useLS){var i=localStorage.getItem(this._id+"->"+e+"__"+t);n(i?JSON.parse(i):void 0)}else n(this._rows[e][t])},t.prototype.delete=function(e,t,n,r){var i=this._index[e].indexOf(t);-1!==i&&(this._index[e].splice(i,1),this.useLS&&localStorage.setItem(this._id+"->"+e+"_idx",JSON.stringify(this._index[e].keys()))),this.useLS?localStorage.removeItem(this._id+"->"+e+"__"+t):delete this._rows[e][t],n()},t.prototype.readMulti=function(e,t,n,r,i,o,a,u){var c=this,l={range:[n,r],offset:[n,n+r],all:[]}[t],f=function(){switch(t){case"all":return c._index[e].slice();case"offset":var n=c._index[e].length-1;return i?c._index[e].slice(n-l[1],n-l[0]):c._index[e].slice(l[0],l[1]);case"range":for(var r=s.binarySearch(c._index[e],l[0],!1),o=s.binarySearch(c._index[e],l[1],!1);c._index[e][o]>l[1];)o--;for(;c._index[e][r]<l[0];)r++;return c._index[e].slice(r,o+1)}return[]}();i&&f.reverse(),f.forEach(function(t,n){c.useLS?o(JSON.parse(localStorage.getItem(c._id+"->"+e+"__"+t)||"{}"),n):o(c._rows[e][t],n)}),a()},t.prototype.getTableIndex=function(e,t,n){t(this._index[e].slice())},t.prototype.getTableIndexLength=function(e,t,n){t(this._index[e].length)},t}(n(2).nanoSQLMemoryIndex);t.SyncStorage=a},function(e,t,n){var r=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(0),o=function(){function e(e,t,n,o,s){this._db=e,this._AV=s||"",this._query="string"==typeof n?r({},i.buildQuery(e,t,n),{comments:[],state:"pending",action:n,actionArgs:o,result:[]}):r({},n(e),{state:"pending",result:[]})}return e.prototype.where=function(e){return this._query.where=e,this},e.prototype.orderBy=function(e){return this._query.orderBy=e,this},e.prototype.groupBy=function(e){return this._query.groupBy=e,this},e.prototype.having=function(e){return this._query.having=e,this},e.prototype.join=function(e){var t=this,n="Join commands requires table and type arguments!";return Array.isArray(e)?e.forEach(function(e){e.with.table&&e.type||(t._error=n)}):e.with.table&&e.type||(this._error=n),this._query.join=e,this},e.prototype.limit=function(e){return this._query.limit=e,this},e.prototype.comment=function(e){return this._query.comments.push(e),this},e.prototype.tag=function(e){return this._query.tags.push(e),this},e.prototype.extend=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return this._query.extend.push({scope:e,args:t}),this},e.prototype.union=function(e,t){return this._query.union={queries:e,type:t?"all":"distinct"},this},e.prototype.offset=function(e){return this._query.offset=e,this},e.prototype.emit=function(){return this._query},e.prototype.ttl=function(e,t){if(void 0===e&&(e=60),"upsert"!==this._query.action)throw new Error("nSQL: Can only do ttl on upsert queries!");return this._query.ttl=e,this._query.ttlCols=t||[],this},e.prototype.graph=function(e){return this._query.graph=e,this},e.prototype.from=function(e){return"string"==typeof e?this._query.table=e:(this._query.table=e.table,this._query.tableAS=e.as),this},e.prototype.into=function(e){return this._query.table=e,this},e.prototype.on=function(e){return this._query.table=e,this},e.prototype.toCSV=function(e){var t=this;return t.exec().then(function(n){return Promise.resolve(t._db.JSONtoCSV(n,e))})},e.prototype.exec=function(e){var t=this;return new Promise(function(n,r){var i=[];t._query.returnEvent=e,t.stream(function(e){e&&i.push(e)},function(){n(i)},r)})},e.prototype.streamEvent=function(e,t,n){this._query.returnEvent=!0,this._db.triggerQuery(this._query,e,t,n)},e.prototype.stream=function(e,t,n){this._db.triggerQuery(this._query,e,t,n)},e.prototype.cache=function(){var e=this;return new Promise(function(t,n){var r=i.uuid();e.exec().then(function(n){e._db._queryCache[r]=n,t({id:r,total:n.length})}).catch(n)})},e}();t._nanoSQLQueryBuilder=o}])});