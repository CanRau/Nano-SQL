!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(window,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=11)}([function(e,t,n){(function(e){var r=this&&this.__assign||function(){return(r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var i=n(5),s=n(6);t.blankTableDefinition={id:"",name:"",model:{},columns:[],indexes:{},actions:[],queries:{},views:[],pkType:"string",pkCol:[],isPkNum:!1,ai:!1},t.binarySearch=function(e,n,r,i,s){var a=i||0,o=s||e.length;if(e[a]>=n)return r?-1:a;if(e[o]<=n)return r?-1:o+1;var u=Math.floor((a+o)/2);return n==e[u]?u:o-1==a?r?-1:o:n>e[u]?t.binarySearch(e,n,r,u,o):n<e[u]?t.binarySearch(e,n,r,a,u):r?-1:o},t.titleCase=function(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()},t.slugify=function(e){return String(e).replace(/\s+/g,"-").replace(/[^0-9a-z\-]/gi,"").toLowerCase()},t.buildQuery=function(e,n,r,i){return{databaseID:e,table:r||n.selectedTable,parent:n,action:i,state:"pending",result:[],time:Date.now(),queryID:t.fastID(),extend:[],comments:[],tags:[]}},t.keyToDate=function(e,t,n){return n&&"date"===t?Date.parse(n):n},t.adapterFilters=function(e,n,i){return{write:function(r,s,a,o,u){e&&(s=t.keyToDate(n,n.getDB(e)._tables[r].pkType,s),n.doFilter(e,"adapterWrite",{res:{table:r,pk:s,row:a,complete:o,error:u},query:i},function(t){t&&(n.getDB(e)._tables[t.res.table].mode||n.getDB(e).adapter).write(n.getDB(e)._tableIds[t.res.table],t.res.pk,t.res.row,function(e){t.res.complete(e)},t.res.error)},u))},read:function(s,a,o,u){e&&(a=t.keyToDate(n,n.getDB(e)._tables[s].pkType,a),n.doFilter(e,"adapterRead",{res:{table:s,pk:a,complete:o,error:u},query:i},function(i){i&&(n.getDB(e)._tables[i.res.table].mode||n.getDB(e).adapter).read(n.getDB(e)._tableIds[i.res.table],i.res.pk,function(s){if(s)if("date"===n.getDB(e)._tables[i.res.table].pkType){var a=r({},s);t.deepSet(n.getDB(e)._tables[i.res.table].pkCol,a,new Date(i.res.pk).toISOString()),i.res.complete(a)}else i.res.complete(s);else i.res.complete(void 0)},i.res.error)},u))},readMulti:function(s,a,o,u,c,l,d,f){e&&(o=t.keyToDate(n,n.getDB(e)._tables[s].pkType,o),u=t.keyToDate(n,n.getDB(e)._tables[s].pkType,u),n.doFilter(e,"adapterReadMulti",{res:{table:s,type:a,offsetOrLow:o,limitOrHigh:u,reverse:c,onRow:l,complete:d,error:f},query:i},function(i){i&&(n.getDB(e)._tables[i.res.table].mode||n.getDB(e).adapter).readMulti(n.getDB(e)._tableIds[i.res.table],i.res.type,i.res.offsetOrLow,i.res.limitOrHigh,i.res.reverse,function(s,a){if("date"===n.getDB(e)._tables[i.res.table].pkType){var o=r({},s),u=t.deepGet(n.getDB(e)._tables[i.res.table].pkCol,o);t.deepSet(n.getDB(e)._tables[i.res.table].pkCol,o,new Date(u).toISOString()),i.res.onRow(o,a)}else i.res.onRow(s,a)},function(){i.res.complete()},i.res.error)},f))},connect:function(t,r,s){e&&n.doFilter(e,"adapterConnect",{res:{id:t,complete:r,error:s},query:i},function(t){t&&n.getDB(e).adapter.connect(t.res.id,t.res.complete,t.res.error)},s)},disconnect:function(t,r){e&&n.doFilter(e,"adapterDisconnect",{res:{complete:t,error:r},query:i},function(t){t&&n.getDB(e).adapter.disconnect(t.res.complete,t.res.error)},r)},createTable:function(t,r,s,a){e&&n.doFilter(e,"adapterCreateTable",{res:{table:t,tableData:r,complete:s,error:a},query:i},function(t){t&&(r.mode||n.getDB(e).adapter).createTable(n.getDB(e)._tableIds[t.res.table],t.res.tableData,t.res.complete,t.res.error)},a)},dropTable:function(t,r,s){e&&n.doFilter(e,"adapterDropTable",{res:{table:t,complete:r,error:s},query:i},function(t){t&&(n.getDB(e)._tables[t.res.table].mode||n.getDB(e).adapter).dropTable(n.getDB(e)._tableIds[t.res.table],t.res.complete,t.res.error)},s)},delete:function(r,s,a,o){e&&(s=t.keyToDate(n,n.getDB(e)._tables[r].pkType,s),n.doFilter(e,"adapterDelete",{res:{table:r,pk:s,complete:a,error:o},query:i},function(t){t&&(n.getDB(e)._tables[t.res.table].mode||n.getDB(e).adapter).delete(n.getDB(e)._tableIds[t.res.table],t.res.pk,t.res.complete,t.res.error)},o))},getTableIndex:function(t,r,s){e&&n.doFilter(e,"adapterGetTableIndex",{res:{table:t,complete:r,error:s},query:i},function(t){t&&(n.getDB(e)._tables[t.res.table].mode||n.getDB(e).adapter).getTableIndex(n.getDB(e)._tableIds[t.res.table],t.res.complete,t.res.error)},s)},getTableIndexLength:function(t,r,s){e&&n.doFilter(e,"adapterGetTableIndexLength",{res:{table:t,complete:r,error:s},query:i},function(t){t&&(n.getDB(e)._tables[t.res.table].mode||n.getDB(e).adapter).getTableIndexLength(n.getDB(e)._tableIds[t.res.table],t.res.complete,t.res.error)},s)},createIndex:function(t,r,s,a,o){e&&n.doFilter(e,"adapterCreateIndex",{res:{table:t,indexName:r,type:s,complete:a,error:o},query:i},function(t){t&&(n.getDB(e)._tables[t.res.table].mode||n.getDB(e).adapter).createIndex(n.getDB(e)._tableIds[t.res.table],t.res.indexName,t.res.type,t.res.complete,t.res.error)},o)},deleteIndex:function(t,r,s,a){e&&(n.getDB(e)._tables[t].indexes[r]?n.doFilter(e,"adapterDeleteIndex",{res:{table:t,indexName:r,complete:s,error:a},query:i},function(t){t&&(n.getDB(e)._tables[t.res.table].mode||n.getDB(e).adapter).deleteIndex(n.getDB(e)._tableIds[t.res.table],t.res.indexName,t.res.complete,t.res.error)},a):a({error:"Index "+r+" not found!"}))},addIndexValue:function(r,s,a,o,u,c){if(e)if(n.getDB(e)._tables[r].indexes[s]){var l=void 0===o||"undefined"===o?"__NULL__":o;"number"==typeof l&&n.getDB(e)._tables[r].indexes[s].props&&n.getDB(e)._tables[r].indexes[s].props.offset&&(l+=n.getDB(e)._tables[r].indexes[s].props.offset||0),n.getDB(e)._tables[r].indexes[s].props&&n.getDB(e)._tables[r].indexes[s].props.ignore_case&&(l=String(l||"").toUpperCase()),l=t.keyToDate(n,n.getDB(e)._tables[r].indexes[s].isDate?"date":"",l),n.doFilter(e,"adapterAddIndexValue",{res:{table:r,indexName:s,key:a,value:l,complete:u,error:c},query:i},function(t){t&&(n.getDB(e)._tables[t.res.table].mode||n.getDB(e).adapter).addIndexValue(n.getDB(e)._tableIds[t.res.table],t.res.indexName,t.res.key,t.res.value,t.res.complete,t.res.error)},c)}else c({error:"Index "+s+" not found!"})},deleteIndexValue:function(r,s,a,o,u,c){if(e)if(n.getDB(e)._tables[r].indexes[s]){var l=void 0===o||"undefined"===o?"__NULL__":o;"number"==typeof l&&n.getDB(e)._tables[r].indexes[s].props&&n.getDB(e)._tables[r].indexes[s].props.offset&&(l+=n.getDB(e)._tables[r].indexes[s].props.offset||0),n.getDB(e)._tables[r].indexes[s].props&&n.getDB(e)._tables[r].indexes[s].props.ignore_case&&(l=String(l||"").toUpperCase()),l=t.keyToDate(n,n.getDB(e)._tables[r].indexes[s].isDate?"date":"",l),n.doFilter(e,"adapterDeleteIndexValue",{res:{table:r,indexName:s,key:a,value:l,complete:u,error:c},query:i},function(t){t&&(n.getDB(e)._tables[t.res.table].mode||n.getDB(e).adapter).deleteIndexValue(n.getDB(e)._tableIds[t.res.table],t.res.indexName,t.res.key,t.res.value,t.res.complete,t.res.error)},c)}else c({error:"Index "+s+" not found!"})},readIndexKey:function(r,s,a,o,u,c){if(e)if(n.getDB(e)._tables[r].indexes[s]){var l="NULL"===a?"__NULL__":a;"number"==typeof l&&n.getDB(e)._tables[r].indexes[s].props&&n.getDB(e)._tables[r].indexes[s].props.offset&&(l+=n.getDB(e)._tables[r].indexes[s].props.offset||0),l=t.keyToDate(n,n.getDB(e)._tables[r].indexes[s].isDate?"date":"",l),n.getDB(e)._tables[r].indexes[s].props&&n.getDB(e)._tables[r].indexes[s].props.ignore_case&&(l=String(l||"").toUpperCase()),n.doFilter(e,"adapterReadIndexKey",{res:{table:r,indexName:s,pk:l,onRowPK:o,complete:u,error:c},query:i},function(t){t&&(n.getDB(e)._tables[t.res.table].mode||n.getDB(e).adapter).readIndexKey(n.getDB(e)._tableIds[t.res.table],t.res.indexName,t.res.pk,t.res.onRowPK,t.res.complete,t.res.error)},c)}else c({error:"Index "+s+" not found!"})},readIndexKeys:function(r,s,a,o,u,c,l,d,f){if(e){var h=o,p=u;n.getDB(e)._tables[r].indexes[s]?("number"==typeof h&&"number"==typeof p&&"range"===a&&n.getDB(e)._tables[r].indexes[s]&&n.getDB(e)._tables[r].indexes[s].props.offset&&(h+=n.getDB(e)._tables[r].indexes[s].props.offset||0,p+=n.getDB(e)._tables[r].indexes[s].props.offset||0),h=t.keyToDate(n,n.getDB(e)._tables[r].indexes[s].isDate?"date":"",h),p=t.keyToDate(n,n.getDB(e)._tables[r].indexes[s].isDate?"date":"",p),"range"===a&&n.getDB(e)._tables[r].indexes[s].props&&n.getDB(e)._tables[r].indexes[s].props.ignore_case&&(h=String(h||"").toUpperCase(),p=String(p||"").toUpperCase()),n.doFilter(e,"adapterReadIndexKeys",{res:{table:r,indexName:s,type:a,offsetOrLow:h,limitOrHigh:p,reverse:c,onRowPK:l,complete:d,error:f},query:i},function(t){t&&(n.getDB(e)._tables[t.res.table].mode||n.getDB(e).adapter).readIndexKeys(n.getDB(e)._tableIds[t.res.table],t.res.indexName,t.res.type,t.res.offsetOrLow,t.res.limitOrHigh,t.res.reverse,function(e,n){"__NULL__"!==e&&t.res.onRowPK(e,n)},t.res.complete,t.res.error)},f)):f({error:"Index "+s+" not found!"})}}}},t.maybeDate=function(e){var t=Date.parse(e);return isNaN(t)?e:t},t.mutateRowTypes=function(e,t,n,r){if(!e)return t;if(!r.getDB(e)._tables[n])throw new Error('nSQL: Table "'+n+'" not found!');var i=function(e,t,n){return t?n&&n.length&&-1!==n.indexOf("[]")?Array.isArray(t)?t.map(function(t){return i(e,t,n.slice(0,n.lastIndexOf("[]")))}):[]:(e.forEach(function(e){if(e.model)if(-1!==e.type.indexOf("[]")){var n=void 0!==t?t[e.key]:[];Array.isArray(n)?t[e.key]=n.map(function(t){return i(e.model,t,e.type.slice(0,e.type.lastIndexOf("[]")))}):t[e.key]=[]}else t[e.key]=i(e.model,void 0!==t?t[e.key]:void 0);else switch(e.type){case"date":t[e.key]=new Date(t[e.key]).toISOString();break;default:t[e.key]=t[e.key]}}),t):t};return i(r.getDB(e)._tables[n].columns,t)},t.noop=function(){},t.throwErr=function(e){throw new Error(e)},t.nan=function(e){return isNaN(e)||null===e?0:parseFloat(e)},t.assign=function(e){return e?JSON.parse(JSON.stringify(e)):e},t.objectsEqual=function(e,t){return e===t||"object"==typeof e&&(!(!e||!t)&&s(e,t))};var a=function(){function e(e,t,n){this.processItem=e,this.onError=t,this.onComplete=n,this._items=[],this._going=!1,this._done=!1,this._count=0,this._triggeredComplete=!1,this._progressBuffer=this._progressBuffer.bind(this)}return e.prototype._progressBuffer=function(){var e=this;if(!this._triggeredComplete){if(this._done&&!this._items.length)return this._triggeredComplete=!0,void(this.onComplete&&this.onComplete());if(this._items.length){var n=function(){e._count++,e._count%100==0?t.setFast(e._progressBuffer):e._progressBuffer()},r=this._items.shift()||[];r[1]?r[1](r[0],n,this.onError?this.onError:t.noop):this.processItem&&this.processItem(r[0],this._count,n,this.onError?this.onError:t.noop)}else this._going=!1}},e.prototype.finished=function(){this._done=!0,this._triggeredComplete||this._going||this._items.length||(this._triggeredComplete=!0,this.onComplete&&this.onComplete())},e.prototype.newItem=function(e,t){this._items.push([e,t]),this._going||(this._going=!0,this._progressBuffer())},e}();t._nanoSQLQueue=a,t.chainAsync=function(e,n){return new Promise(function(r,i){if(e&&e.length){var s=[],a=0,o=function(){a<e.length?n(e[a],a,function(e){s.push(e||0),++a%250==0?t.setFast(function(){o()}):o()},function(e){i(e)}):r(s)};o()}else r([])})},t.allAsync=function(e,t){return e&&e.length?Promise.all((e||[]).map(function(e,n){return new Promise(function(r,i){t(e,n,r,i)})})):Promise.resolve([])};var o="undefined"==typeof window?"":navigator.userAgent||"";t.isSafari=0!==o.length&&(/^((?!chrome|android).)*safari/i.test(o)||/iPad|iPhone|iPod/.test(o)&&!window.MSStream),t.isMSBrowser=0!==o.length&&(o.indexOf("MSIE ")>0||o.indexOf("Trident/")>0||o.indexOf("Edge/")>0),t.isAndroid=/Android/.test(o),t.random16Bits=function(){if("undefined"==typeof crypto)return Math.round(Math.random()*Math.pow(2,16));if(crypto.getRandomValues){var t=new Uint16Array(1);return crypto.getRandomValues(t),t[0]}return void 0!==e&&e._crypto.randomBytes?e._crypto.randomBytes(2).reduce(function(e,t){return t*e}):Math.round(Math.random()*Math.pow(2,16))},t.throttle=function(e,t,n){var r=!1;return function(){for(var i=[],s=0;s<arguments.length;s++)i[s]=arguments[s];r||(r=!0,setTimeout(function(){t.apply(e,i),r=!1},n))}},t.timeid=function(e){for(var n=Math.round((new Date).getTime()/(e?1:1e3)).toString();n.length<(e?13:10);)n="0"+n;for(var r=(t.random16Bits()+t.random16Bits()).toString(16);r.length<5;)r="0"+r;return n+"-"+r},t.intersect=function(e,t){return!(!e||!t)&&(!(!e.length||!t.length)&&(e||[]).filter(function(e){return-1!==(t||[]).indexOf(e)}).length>0)},t.fastID=function(){return[0,0].map(function(e){return Math.round(1024*Math.random()).toString(16)}).join("")},t.uuid=function(){var e,n,r="";return[r,r,r,r,r,r,r,r].reduce(function(i,s,a){for(e=t.random16Bits(),n=3===a?4:4===a?(e%16&3|8).toString(16):r,e=e.toString(16);e.length<4;)e="0"+e;return i+([2,3,4,5].indexOf(a)>-1?"-":r)+(n+e).slice(0,4)},r)},t.hash=function(e){for(var t=5381,n=e.length;n;)t=33*t^e.charCodeAt(--n);return(t>>>0).toString(16)},t.generateID=function(e,n){var r={int:function(e){return e},date:function(e){return e},float:function(e){return e},uuid:t.uuid,timeId:function(){return t.timeid()},timeIdms:function(){return t.timeid(!0)}};return r[e]?r[e](n||1):void 0},t.cleanArgs2=function(e,n,r,i){var s=function(r,a,o){if(-1!==r.indexOf("[]")){var u=r.slice(0,r.lastIndexOf("[]"));return Array.isArray(a)?a.map(function(e){return s(u,e,o)}):[]}if("string"==typeof o){var c=o.replace(/\[\]/gim,""),l=Object.keys(i.getDB(e).config.types||{}).reduce(function(t,n){return n===c?(i.getDB(e).config.types||{})[n]:t},void 0);if(!l)throw new Error("Can't find type "+c+"!");return s(o,n,l)}var d={},f=!1,h=[];return Object.keys(o).forEach(function(n){var r=n.split(":");"*"===r[0]?f=!0:(h.push(r[0]),d[r[0]]=t.cast(e,r[1],a[r[0]],!1,i))}),f&&t.isObject(a)&&Object.keys(a).filter(function(e){return-1===h.indexOf(e)}).forEach(function(e){d[e]=a[e]}),d};return s("string"==typeof r?r:"",n,r)},t.cleanArgs=function(e,n,r,i){var s={},a=n.length;for(Object.keys(i.getDB(e).config.types||{});a--;){var o=n[a].split(":");o.length>1?s[o[0]]=t.cast(e,o[1],r[o[0]]||void 0,!0,i):s[o[0]]=r[o[0]]||void 0}return s},t.isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},t.objSort=function(e,n){return function(r,i){var s=e?t.deepGet(e,r)>t.deepGet(e,i)?-1:1:r>i?-1:1;return n?-1*s:s}},t.execFunction=function(e,n,r,i){var s,a=n.match(/\((.*)\)/gim);if(!a[0])return{result:void 0};var o=a[0].substr(1,a[0].length-2).split(/\,\s?(?![^\(]*\))/).map(function(e){return e.trim()}),u=n.split("(").shift(),c=o.map(function(n){return-1!==n.indexOf("(")?t.execFunction(e,n,r,i).result:n});return e.parent.functions[u]?(s=e.parent.functions[u]).call.apply(s,[e,r,i].concat(c)):{result:void 0}},t.cast=function(e,n,r,i,s){if("any"===n||"blob"===n||"*"===n)return r;if(-1!==n.indexOf("[]")){var a=n.slice(0,n.lastIndexOf("[]"));return Array.isArray(r)?r.map(function(n){return t.cast(e,a,n,i)}):[]}var o=typeof r,u={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},c=s&&e&&s.getDB(e).config.types||{};if(-1!==Object.keys(c).indexOf(n)){if(t.isObject(r)){var l=c[n];return Object.keys(l).reduce(function(n,a){var o=a.split(":");return n[o[0]]=t.cast(e,o[1],r[o[0]],i,s),n},{})}return{}}var d=function(e,n){switch(e){case"safestr":return d("string",n).replace(/[&<>"'`=\/]/gim,function(e){return u[e]});case"int":return"number"!==o||n%1!=0?Math.round(t.nan(n)):n;case"number":case"float":return"number"!==o?t.nan(n):n;case"array":return Array.isArray(n)?n:[];case"date":case"uuid":case"timeId":case"timeIdms":case"string":return"string"!==o?String(n):n;case"object":case"obj":case"map":return t.isObject(n)?n:{};case"boolean":case"bool":return!0===n||1===n}return i?r:null};if(null==r)return null;var f=d(String(n||"").toLowerCase(),r);return void 0!==f&&["int","float","number"].indexOf(n)>-1&&isNaN(f)?0:f},t.rad2deg=function(e){return 180*e/Math.PI},t.deg2rad=function(e){return e*(Math.PI/180)},t.crowDistance=function(e,n,r,i,s){void 0===s&&(s=6371);var a=t.deg2rad(r-e),o=t.deg2rad(i-n),u=Math.pow(Math.sin(a/2),2)+Math.cos(t.deg2rad(e))*Math.cos(t.deg2rad(r))*Math.pow(Math.sin(o/2),2);return s*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))},t.levenshtein=function(e,t){return i(e,t)};var u={};t.resolvePath=function(e){if(!e)return[];if(u[e])return u[e].slice();var t=-1!==e.indexOf("[")?e.split(/\.|\[/gim).map(function(e){return e.replace(/\]/gim,"")}):e.split(".");return u[e]=t,u[e].slice()},t.getFnValue=function(e,n){return n.match(/\".*\"|\'.*\'/gim)?n.replace(/\"|\'/gim,""):t.deepGet(n,e)},t.deepFreeze=function(e){return Object.getOwnPropertyNames(e||{}).forEach(function(n){var r=e[n];"object"==typeof r&&null!==r&&(e[n]=t.deepFreeze(r))}),Object.freeze(e)},t.deepSet=function(e,n,r){var i=function(e,n,s){e[n+1]?(s[e[n]]&&(Array.isArray(s[e[n]])||t.isObject(s[e[n]]))||(isNaN(e[n+1])?s[e[n]]={}:s[e[n]]=[]),i(e,n+1,s[e[n]])):s[e[n]]=r};return i(Array.isArray(e)?e:t.resolvePath(e),0,n),n},t.deepGet=function(e,n){var r=function(e,t,n){return e[t]&&n?r(e,t+1,n[e[t]]):n};return r(Array.isArray(e)?e:t.resolvePath(e),0,n)},t.maybeAssign=function(e){return Object.isFrozen(e)?t.assign(e):e};var c=function(e){return e[0].apply(null,Array.prototype.slice.call(e,1))};t.setFast="undefined"!=typeof Promise?function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];Promise.resolve().then(function(){c(e)})}:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];setTimeout(function(){c(e)},0)}}).call(this,n(4))},function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.VERSION=2.27,function(e){e[e.NONE=0]="NONE",e[e.CASCADE=1]="CASCADE",e[e.RESTRICT=2]="RESTRICT",e[e.SET_NULL=3]="SET_NULL"}(t.InanoSQLFKActions||(t.InanoSQLFKActions={})),function(e){e[e.fast=0]="fast",e[e.medium=1]="medium",e[e.slow=2]="slow",e[e.fn=3]="fn",e[e.none=4]="none"}(t.IWhereType||(t.IWhereType={}))},function(e,t,n){var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var s=n(1),a=n(0),o=function(e){function t(t){var n=e.call(this,!0,!1)||this;return n.useLS=t,n.plugin={name:"Sync Storage Adapter",version:s.VERSION},n._index={},n._rows={},n._ai={},n._tableConfigs={},n}return i(t,e),t.prototype.connect=function(e,t,n){this._id=e,t()},t.prototype.createTable=function(e,t,n,r){if(this._index[e]=[],this._rows[e]={},this._tableConfigs[e]=t,this.useLS){var i=localStorage.getItem(this._id+"->"+e+"_idx");i&&(this._index[e]=JSON.parse(i),this._ai[e]=parseFloat(localStorage.getItem(this._id+"->"+e+"_ai")||"0"))}n()},t.prototype.dropTable=function(e,t,n){var r=this;this._index[e].forEach(function(t){r.useLS?localStorage.removeItem(r._id+"->"+e+"__"+t):delete r._rows[e][t]}),this.useLS&&localStorage.removeItem(this._id+"->"+e+"_idx"),delete this._index[e],delete this._rows[e],t()},t.prototype.disconnect=function(e,t){e()},t.prototype.write=function(e,t,n,r,i){if(void 0!==(t=t||a.generateID(this._tableConfigs[e].pkType,this._ai[e]+1))){if(this._tableConfigs[e].ai&&(this._ai[e]=Math.max(this._ai[e]||0,t)),-1===this._index[e].indexOf(t)){if(this._ai[e])this._index[e].push(t);else{var s=a.binarySearch(this._index[e],t,!1);this._index[e].splice(s,0,t)}this.useLS&&(localStorage.setItem(this._id+"->"+e+"_idx",JSON.stringify(this._index[e])),localStorage.setItem(this._id+"->"+e+"_ai",String(this._ai[e])))}a.deepSet(this._tableConfigs[e].pkCol,n,t),this.useLS?(localStorage.setItem(this._id+"->"+e+"__"+t,JSON.stringify(n)),r(t)):(this._rows[e][t]=a.deepFreeze(n),r(t))}else i(new Error("Can't add a row without a primary key!"))},t.prototype.read=function(e,t,n,r){if(this.useLS){var i=localStorage.getItem(this._id+"->"+e+"__"+t);n(i?JSON.parse(i):void 0)}else n(this._rows[e][t])},t.prototype.delete=function(e,t,n,r){var i=this._index[e].indexOf(t);-1!==i&&(this._index[e].splice(i,1),this.useLS&&localStorage.setItem(this._id+"->"+e+"_idx",JSON.stringify(this._index[e].keys()))),this.useLS?localStorage.removeItem(this._id+"->"+e+"__"+t):delete this._rows[e][t],n()},t.prototype.readMulti=function(e,t,n,r,i,s,o,u){var c=this,l={range:[n,r],offset:[n,n+r],all:[]}[t],d=function(){switch(t){case"all":return c._index[e].slice();case"offset":var n=c._index[e].length-1;return i?c._index[e].slice(n-l[1],n-l[0]):c._index[e].slice(l[0],l[1]);case"range":for(var r=a.binarySearch(c._index[e],l[0],!1),s=a.binarySearch(c._index[e],l[1],!1);c._index[e][s]>l[1];)s--;for(;c._index[e][r]<l[0];)r++;return c._index[e].slice(r,s+1)}return[]}();i&&d.reverse(),d.forEach(function(t,n){c.useLS?s(JSON.parse(localStorage.getItem(c._id+"->"+e+"__"+t)||"{}"),n):s(c._rows[e][t],n)}),o()},t.prototype.getTableIndex=function(e,t,n){t(this._index[e].slice())},t.prototype.getTableIndexLength=function(e,t,n){t(this._index[e].length)},t}(n(3).nanoSQLMemoryIndex);t.SyncStorage=o},function(e,t,n){var r=this&&this.__assign||function(){return(r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var i=n(0);t.err=new Error("Memory index doesn't support this action!");var s=function(){function e(e,t){this.assign=e,this.useCache=t}return e.prototype.connect=function(e,n,r){r(t.err)},e.prototype.disconnect=function(e,n){n(t.err)},e.prototype.createTable=function(e,n,r,i){i(t.err)},e.prototype.dropTable=function(e,n,r){r(t.err)},e.prototype.write=function(e,n,r,i,s){s(t.err)},e.prototype.read=function(e,n,r,i){i(t.err)},e.prototype.delete=function(e,n,r,i){i(t.err)},e.prototype.readMulti=function(e,n,r,i,s,a,o,u){u(t.err)},e.prototype.getTableIndex=function(e,n,r){r(t.err)},e.prototype.getTableIndexLength=function(e,n,r){r(t.err)},e.prototype.createIndex=function(e,t,n,s,a){var o="_idx_"+e+"_"+t;this.createTable(o,r({},i.blankTableDefinition,{pkType:n,pkCol:["id"],isPkNum:-1!==["float","int","number"].indexOf(n)}),function(){s()},a)},e.prototype.deleteIndex=function(e,t,n,r){var i="_idx_"+e+"_"+t;this.dropTable(i,n,r)},e.prototype.addIndexValue=function(e,t,n,r,s,a){var o=this,u="_idx_"+e+"_"+t;this.read(u,r,function(e){var t=e?e.pks:[];if(0===(t=o.assign?i.assign(t):t).length)t.push(n);else{var c=i.binarySearch(t,n,!1);t.splice(c,0,n)}o.write(u,r,{id:n,pks:o.assign?i.assign(t):t},s,a)},a)},e.prototype.deleteIndexValue=function(e,t,n,r,s,a){var o=this,u="_idx_"+e+"_"+t;this.read(u,r,function(e){var t=e?e.pks:[];if(0!==(t=o.assign?i.assign(t):t).length){var c=t.length<100?t.indexOf(n):i.binarySearch(t,n,!0);-1!==c&&t.splice(c,1),t.length?o.write(u,r,{id:n,pks:o.assign?i.assign(t):t},s,a):o.delete(u,r,s,a)}else s()},a)},e.prototype.readIndexKey=function(e,t,n,r,i,s){var a="_idx_"+e+"_"+t;this.read(a,n,function(e){e?(e.pks.forEach(r),i()):i()},s)},e.prototype.readIndexKeys=function(e,t,n,r,i,s,a,o,u){var c="_idx_"+e+"_"+t;this.readMulti(c,n,r,i,s,function(e){e&&e.pks.forEach(function(t){a(t,e.id)})},o,u)},e}();t.nanoSQLMemoryIndex=s},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";e.exports=function(e,t,n){var s,a,o,u,c,l,d,f;if(e===t)return 0;if(s=e.length,a=t.length,0===s)return a;if(0===a)return s;n&&(e=e.toLowerCase(),t=t.toLowerCase());d=0;for(;d<s;)i[d]=e.charCodeAt(d),r[d]=++d;f=0;for(;f<a;)for(o=t.charCodeAt(f),u=c=f++,d=-1;++d<s;)l=o===i[d]?c:c+1,c=r[d],r[d]=u=c>u?l>u?u+1:l:l>c?c+1:l;return u};var r=[],i=[]},function(e,t,n){"use strict";var r=Array.isArray,i=Object.keys,s=Object.prototype.hasOwnProperty;e.exports=function e(t,n){if(t===n)return!0;if(t&&n&&"object"==typeof t&&"object"==typeof n){var a,o,u,c=r(t),l=r(n);if(c&&l){if((o=t.length)!=n.length)return!1;for(a=o;0!=a--;)if(!e(t[a],n[a]))return!1;return!0}if(c!=l)return!1;var d=t instanceof Date,f=n instanceof Date;if(d!=f)return!1;if(d&&f)return t.getTime()==n.getTime();var h=t instanceof RegExp,p=n instanceof RegExp;if(h!=p)return!1;if(h&&p)return t.toString()==n.toString();var y=i(t);if((o=y.length)!==i(n).length)return!1;for(a=o;0!=a--;)if(!s.call(n,y[a]))return!1;for(a=o;0!=a--;)if(!e(t[u=y[a]],n[u]))return!1;return!0}return t!=t&&n!=n}},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this.eventListeners={}}return e.prototype.on=function(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)},e.prototype.off=function(e,t){var n=this;this.eventListeners[e]&&this.eventListeners[e].length&&this.eventListeners[e].forEach(function(r,i){r===t&&n.eventListeners[e].splice(i,1)})},e.prototype.trigger=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.eventListeners[e]&&this.eventListeners[e].forEach(function(e){return e.apply(void 0,t)})},e}();t.ReallySmallEvents=n,t.RSE=new n},function(e,t,n){(function(e){Object.defineProperty(t,"__esModule",{value:!0});var r,i=n(0),s=n(2),a=n(9),o=n(10);void 0!==e&&(r=e._rocksAdapter),t.detectStorage=function(){return"undefined"==typeof window?"RKS":i.isSafari&&void 0!==window.openDatabase?"WSQL":"undefined"!=typeof indexedDB?"IDB":void 0!==window.openDatabase?"WSQL":"LS"},t.resolveMode=function(e,n){if("string"!=typeof e)return e;switch("PERM"===e&&(e=t.detectStorage()),e){case"TEMP":return new s.SyncStorage(!1);case"LS":return new s.SyncStorage(!0);case"WSQL":return new a.WebSQL(n&&n.size);case"IDB":return new o.IndexedDB(n&&n.version);case"RKS":case"LVL":return new r(n&&n.path);default:throw new Error("Cannot find mode "+e+"!")}}}).call(this,n(4))},function(e,t,n){var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var s=n(1),a=n(0),o=n(3);t.SQLiteAbstract=function(e,t){var n=[],r={},i=function(e){if(-1===n.indexOf(e))throw Error("No table "+e+" found!");return'"'+e+'"'};return{createAI:function(t,n){e(!0,'CREATE TABLE IF NOT EXISTS "_ai" (id TEXT PRIMARY KEY UNIQUE, inc BIGINT)',[],a.noop,t,n)},createTable:function(t,i,s,o,u){n.push(t),r[t]=i,e(!0,'CREATE TABLE IF NOT EXISTS "'+t+'" (id '+(i.isPkNum?"REAL":"TEXT")+" PRIMARY KEY UNIQUE, data TEXT)",[],a.noop,function(){if(i.ai){var n=[];e(!1,'SELECT "inc" FROM "_ai" WHERE id = ?',[t],function(e){n.push(e)},function(){n.length?(s[t]=parseInt(n[0].inc),o()):(s[t]=0,e(!0,'INSERT into "_ai" (id, inc) VALUES (?, ?)',[t,0],a.noop,o,u))},u)}else o()},u)},dropTable:function(t,r,s){e(!0,"DROP TABLE IF EXISTS "+i(t),[],a.noop,function(){e(!0,'UPDATE "_ai" SET inc = ? WHERE id = ?',[0,t],a.noop,function(){n.splice(n.indexOf(t),1),r()},s)},s)},write:function(t,n,r,s,o,u,c,l,d){if(void 0!==(s=s||a.generateID(t,c[r]+1))){u&&(c[r]=Math.max(s,c[r])),a.deepSet(n,o,s);var f=JSON.stringify(o),h=function(){u&&s>=c[r]?e(!0,'UPDATE "_ai" SET inc = ? WHERE id = ?',[c[r],r],a.noop,function(){l(s)},d):l(s)},p=[];e(!1,"SELECT id FROM "+i(r)+" WHERE id = ?",[s],function(e){p.push(e)},function(){p.length?e(!0,"UPDATE "+i(r)+" SET data = ? WHERE id = ?",[f,s],a.noop,h,d):e(!0,"INSERT INTO "+i(r)+" (id, data) VALUES (?, ?)",[s,f],a.noop,h,d)},d)}else d(new Error("Can't add a row without a primary key!"))},read:function(t,n,r,s){var a=[];e(!1,"SELECT data FROM "+i(t)+" WHERE id = ?",[n],function(e){a.push(e)},function(){a.length?r(JSON.parse(a[0].data)):r(void 0)},s)},remove:function(t,n,r,s){e(!0,"DELETE FROM "+i(t)+" WHERE id = ?",[n],a.noop,function(){r()},s)},getIndex:function(t,n,r){var s=[];e(!1,"SELECT id FROM "+i(t)+" ORDER BY id",[],function(e){s.push(e.id)},function(){n(s)},r)},getNumberOfRecords:function(t,n,r){var s=[];e(!1,"SELECT COUNT(*) FROM "+i(t),[],function(e){s.push(e)},function(){n(s[0]["COUNT(*)"])},r)},readMulti:function(t,n,r,s,a,o,u,c){var l="SELECT data FROM "+i(t);"range"===n&&(l+=" WHERE id BETWEEN ? AND ?");var d=l+=a?" ORDER BY id DESC":" ORDER BY id";"offset"===n&&(d+=" LIMIT "+s+" OFFSET "+(a?r+1:r));e(!1,d,"range"===n?[r,s]:[],function(e,t){o(JSON.parse(e.data),t)},function(){u()},c)}}};var u=function(e){function n(n,r){var i=e.call(this,!1,!1)||this;return i.plugin={name:"WebSQL Adapter",version:s.VERSION},i._size=1e3*(n||0)*1e3,i._ai={},i._query=i._query.bind(i),i._tableConfigs={},i._sqlite=t.SQLiteAbstract(i._query,r||500),i}return i(n,e),n.prototype.connect=function(e,t,n){var r=this;this._id=e;try{this._db=window.openDatabase(this._id,this.nSQL.dbs[e]?String(this.nSQL.getDB(e).config.version||"1.0"):"1.0",this._id,a.isAndroid?5e6:this._size)}catch(e){n(e)}a.setFast(function(){r._sqlite.createAI(t,n)})},n.prototype.createTable=function(e,t,n,r){this._tableConfigs[e]=t,this._sqlite.createTable(e,t,this._ai,n,r)},n.prototype._query=function(e,t,n,r,i,s){var a=function(e){e.executeSql(t,n,function(e,t){for(var n=0;n<t.rows.length;n++)r(t.rows.item(n),n);i()},function(e,t){return s(t),!1})};e?this._db.transaction(a):this._db.readTransaction(a)},n.prototype.dropTable=function(e,t,n){this._sqlite.dropTable(e,t,n)},n.prototype.disconnect=function(e,t){e()},n.prototype.write=function(e,t,n,r,i){this._sqlite.write(this._tableConfigs[e].pkType,this._tableConfigs[e].pkCol,e,t,n,this._tableConfigs[e].ai,this._ai,r,i)},n.prototype.read=function(e,t,n,r){this._sqlite.read(e,t,n,r)},n.prototype.delete=function(e,t,n,r){this._sqlite.remove(e,t,n,r)},n.prototype.readMulti=function(e,t,n,r,i,s,a,o){this._sqlite.readMulti(e,t,n,r,i,s,a,o)},n.prototype.getTableIndex=function(e,t,n){this._sqlite.getIndex(e,t,n)},n.prototype.getTableIndexLength=function(e,t,n){this._sqlite.getNumberOfRecords(e,t,n)},n}(o.nanoSQLMemoryIndex);t.WebSQL=u},function(e,t,n){var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var s=n(1),a=n(0),o=function(e){function t(t){var n=e.call(this,!1,!1)||this;return n.version=t,n.plugin={name:"IndexedDB Adapter",version:s.VERSION},n._db={},n._ai={},n._tableConfigs={},n}return i(t,e),t.prototype.connect=function(e,t,n){this._id=e,t()},t.prototype.createTable=function(e,t,n,r){var i=this,s=1;this._tableConfigs[e]=t;var o=a.hash(JSON.stringify(t.columns));this.version?s=this.version:(s=parseInt(localStorage.getItem(this._id+"_"+e+"_idb_version")||"1"),(localStorage.getItem(this._id+"_"+e+"_idb_hash")||o)!==o&&s++,localStorage.setItem(this._id+"_"+e+"_idb_version",String(s)),localStorage.setItem(this._id+"_"+e+"_idb_hash",o));var u=indexedDB.open(this._id+"_"+e,s);this._ai[e]=parseInt(localStorage.getItem(this._id+"_"+e+"_idb_ai")||"0"),u.onerror=r;u.onupgradeneeded=function(n){i._db[e]=n.target.result,i._db[e].objectStoreNames.contains(e)||i._db[e].createObjectStore(e,{keyPath:t.pkCol.join(".")})},u.onsuccess=function(t){i._db[e]=t.target.result,n()}},t.prototype.dropTable=function(e,t,n){var r=this,i=this._db[e].transaction(e,"readwrite");i.onerror=n;var s=i.objectStore(e).clear();s.onerror=n,s.onsuccess=function(){r._db[e].close(),delete r._db[e],localStorage.removeItem(r._id+"_"+e+"_idb_version"),localStorage.removeItem(r._id+"_"+e+"_idb_hash"),localStorage.removeItem(r._id+"_"+e+"_idb_ai"),t()}},t.prototype.disconnect=function(e,t){var n=this;a.allAsync(Object.keys(this._db),function(e,t,r,i){n._db[e].close(),a.setFast(function(){r()})}).then(e).catch(t)},t.prototype.store=function(e,t,n,r){var i=this._db[e].transaction(e,t);i.onabort=r,i.onerror=r,n(i,i.objectStore(e))},t.prototype.write=function(e,t,n,r,i){void 0!==(t=t||a.generateID(this._tableConfigs[e].pkType,this._ai[e]+1))?(this._ai[e]=Math.max(t,this._ai[e]),this._tableConfigs[e].ai&&(this._ai[e]=a.cast(this._id,"int",Math.max(this._ai[e]||0,t)),localStorage.setItem(this._id+"_"+e+"_idb_ai",String(this._ai[e]))),a.deepSet(this._tableConfigs[e].pkCol,n,t),this.store(e,"readwrite",function(e,s){try{s.put(n).onsuccess=function(){r(t)}}catch(e){i(e)}},i)):i(new Error("Can't add a row without a primary key!"))},t.prototype.read=function(e,t,n,r){this.store(e,"readonly",function(e,r){var i=r.get(t);i.onerror=function(e){n(void 0)},i.onsuccess=function(){n(i.result)}},r)},t.prototype.delete=function(e,t,n,r){this.store(e,"readwrite",function(e,i){var s=i.delete(t);s.onerror=r,s.onsuccess=function(e){n()}},r)},t.prototype.readMulti=function(e,t,n,r,i,s,a,o){var u=0,c="offset"===t?n:0,l=c+r,d=!0;this.store(e,"readonly",function(e,f){if(f.getAll){var h=f.getAll("range"!==t?void 0:IDBKeyRange.bound(n,r,!1,!1),"offset"!==t||i?void 0:r+n);h.onsuccess=function(e){var o=i?e.target.result.reverse():e.target.result;if("offset"===t){var u=i?1:0;o.slice(n+u,n+r+u).forEach(s)}else o.forEach(s);a()},h.onerror=o}else f.openCursor("range"!==t?void 0:IDBKeyRange.bound(n,r,!1,!1),i?"prev":"next").onsuccess=function(e){var r=e.target.result;if(r){if("offset"===t){if(d){var o=i?c+1:c;return r.advance(o),u=o,void(d=!1)}(i?l>=u:l>u)&&s(r.value,u-n)}else s(r.value,u);u++,r.continue()}else a()}},o)},t.prototype.getTableIndex=function(e,t,n){var r=this,i=[];this.store(e,"readonly",function(s,o){var u;o.getAllKeys?((u=o.getAllKeys()).onsuccess=function(e){t(e.target.result)},u.onerror=n):((u=o.openCursor()).onsuccess=function(n){var s=n.target.result;s?(i.push(a.deepGet(r._tableConfigs[e].pkCol,s.value)),s.continue()):t(i)},u.onerror=n)},n)},t.prototype.getTableIndexLength=function(e,t,n){this.store(e,"readonly",function(r,i){var s=r.objectStore(e).count();s.onsuccess=function(){t(s.result)},s.onerror=n},n)},t}(n(3).nanoSQLMemoryIndex);t.IndexedDB=o},function(e,t,n){e.exports=n(12)},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(13),i=n(10),s=n(9),a=n(7),o=n(2);window.RSE=a.RSE;var u=0;console.log("Testing IndexedDB"),new r.nanoSQLAdapterTest(i.IndexedDB,[]).test().then(function(){console.log("Testing WebSQL"),new r.nanoSQLAdapterTest(s.WebSQL,[]).test().then(function(){console.log("Tests Sync Storage (LocalStorage)"),new r.nanoSQLAdapterTest(o.SyncStorage,[!0]).test().then(function(){console.log("Tests Complete"),a.RSE.trigger("done",u)}).catch(function(e){console.error(e),u++})}).catch(function(e){console.error(e),u++})}).catch(function(e){console.error(e),u++})},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(14);t.myConsole=Object.create(console,{assert:{value:function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if("undefined"==typeof window)try{console.assert.apply(console,[e,t].concat(n))}catch(e){console.error(e.stack)}else console.assert.apply(console,[e,t].concat(n))},configurable:!0,enumerable:!0,writable:!0}});var s=function(){function e(e,t){this.adapter=e,this.args=t}return e.prototype.test=function(){var e=this;return this.PrimaryKeys().then(function(){return console.log("✓ Primary Key Tests Passed"),e.Writes()}).then(function(){return console.log("✓ Write Tests Passed"),e.RangeReads()}).then(function(){return console.log("✓ Range Read Tests Passed (number)"),e.RangeReadsUUID()}).then(function(){return console.log("✓ Range Read Tests Passed (uuid)"),e.Deletes()}).then(function(){return console.log("✓ Delete Tests Passed"),e.SecondayIndexes()}).then(function(){console.log("✓ Secondary Index Passed"),console.log("✓ All Tests Passed!******")})},e.newTable=function(e,t,n,r,i,s){e.nSQL=t,e.createTable(n,r,function(){t.dbs[123]||(t.dbs[123]={adapter:e,_tables:{},_tableIds:{}}),t.getDB("123")._tables[n]=r,i()},s)},e.prototype.Deletes=function(){var n,s=new((n=this.adapter).bind.apply(n,[void 0].concat(this.args))),a=new i.nanoSQL,o=[];return new Promise(function(t,n){s.nSQL=a,s.connect("123",function(){e.newTable(s,a,"test",{id:r.uuid(),name:"test",model:{"id:int":{ai:!0,pk:!0},"name:string":{}},columns:[{key:"id",type:"int"},{key:"name",type:"string"}],indexes:{},actions:[],queries:{},views:[],pkType:"int",pkCol:["id"],isPkNum:!0,ai:!0},t,n)},n)}).then(function(){return new Promise(function(e,t){for(var n=[],i=0;i<500;i++)o.push({id:i+1,name:"Title "+(i+1)}),n.push("Title "+(i+1));r.chainAsync(n,function(e,n,r){s.write("test",null,{name:e},r,t)}).then(e)})}).then(function(){return new Promise(function(e,n){s.delete("test",3,function(){var i=[];s.readMulti("test","all",void 0,void 0,!1,function(e,t){i.push(e)},function(){var s=r.objectsEqual(i,o.filter(function(e){return 3!==e.id}));t.myConsole.assert(s,"Delete Test"),s?e():n({e:o.filter(function(e){return 3!==e.id}),g:i})},n)},n)})}).then(function(){return new Promise(function(e,t){s.dropTable("test",function(){s.disconnect(e,t)},t)})})},e.prototype.SecondayIndexes=function(){var n,s=new((n=this.adapter).bind.apply(n,[void 0].concat(this.args))),a=new i.nanoSQL,o=[];return new Promise(function(t,n){s.nSQL=a,s.connect("123",function(){e.newTable(s,a,"test",{id:r.uuid(),name:"test",model:{"id:int":{ai:!0,pk:!0},"name:string":{}},columns:[{key:"id",type:"int"},{key:"name",type:"string"}],indexes:{name:{id:"name",isArray:!1,type:"string",path:["name"],props:{},isDate:!1}},actions:[],queries:{},views:[],pkType:"int",pkCol:["id"],isPkNum:!0,ai:!0},t,n)},n)}).then(function(){return new Promise(function(e,t){for(var n=0;n<500;n++){var i=n+1;i<=9?i="00"+i:i<=99&&(i="0"+i),o.push({id:n+1,name:"Title "+i})}s.createIndex("test","name","string",function(){r.chainAsync(o,function(e,n,r){s.write("test",null,e,function(){s.addIndexValue("test","name",e.id,e.name,r,t)},t)}).then(e)},t)})}).then(function(){return new Promise(function(e,n){var i=[];s.readIndexKey("test","name","Title 005",function(e){i.push(e)},function(){var s=r.objectsEqual(i,[5]);t.myConsole.assert(s,"Secondary Index Single Read"),s?e():n({e:[5],g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];s.readIndexKeys("test","name","range","Title 004","Title 020",!1,function(e,t){i.push(e)},function(){var s=o.filter(function(e){return e.name>="Title 004"&&e.name<="Title 020"}).map(function(e){return e.id}),a=r.objectsEqual(i,s);t.myConsole.assert(a,"Secondary Index Range Read"),a?e():n({e:s,g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];s.readIndexKeys("test","name","offset",10,20,!1,function(e){i.push(e)},function(){var s=o.filter(function(e,t){return t>=10&&t<30}).map(function(e){return e.id}),a=r.objectsEqual(i,s);t.myConsole.assert(a,"Secondary Index Offset Read"),a?e():n({e:s,g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];s.readIndexKeys("test","name","range","Title 010","~",!0,function(e,t){i.push(e)},function(){var s=o.filter(function(e){return e.name>="Title 010"}).map(function(e){return e.id}).reverse(),a=r.objectsEqual(i,s);t.myConsole.assert(a,"Secondary Index Range Read Reverse"),a?e():n({e:s,g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];s.readIndexKeys("test","name","offset",10,20,!0,function(e){i.push(e)},function(){var s=o.filter(function(e,t){return t>=469&&t<489}).map(function(e){return e.id}).reverse(),a=r.objectsEqual(i,s);t.myConsole.assert(a,"Secondary Index Offset Read Reverse"),a?e():n({e:s,g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];s.deleteIndexValue("test","name",10,"Title 010",function(){s.readIndexKeys("test","name","all",void 0,void 0,!1,function(e){i.push(e)},function(){var s=o.filter(function(e){return 10!==e.id}).map(function(e){return e.id}),a=r.objectsEqual(i,s);t.myConsole.assert(a,"Secondary Index Remove Value"),a?e():n({e:s,g:i})},n)},n)})})},e.prototype.RangeReads=function(){var n,s=new((n=this.adapter).bind.apply(n,[void 0].concat(this.args))),a=new i.nanoSQL,o=[],u=[];return new Promise(function(t,n){s.nSQL=a,s.connect("123",function(){e.newTable(s,a,"test",{id:r.uuid(),name:"test",model:{"id:int":{ai:!0,pk:!0},"name:string":{}},columns:[{key:"id",type:"int"},{key:"name",type:"string"}],indexes:{},actions:[],views:[],queries:{},pkType:"int",pkCol:["id"],isPkNum:!0,ai:!0},t,n)},n)}).then(function(){return new Promise(function(e,t){for(var n=[],i=0;i<500;i++)o.push({id:i+1,name:"Title "+(i+1)}),n.push("Title "+(i+1)),u.push(i+1);r.chainAsync(n,function(e,n,r){s.write("test",null,{name:e},r,t)}).then(e)})}).then(function(){return new Promise(function(e,n){var i=[];s.readMulti("test","range",10,20,!0,function(e,t){i.push(e)},function(){var s=o.filter(function(e){return e.id>=10&&e.id<=20}).reverse(),a=r.objectsEqual(i,s);t.myConsole.assert(a,"Select Range Test (Reverse)"),a?e():n({e:s,g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];s.readMulti("test","offset",10,20,!0,function(e,t){i.push(e)},function(){var s=o.filter(function(e,t){return t>=469&&t<489}).reverse(),a=r.objectsEqual(i,s);t.myConsole.assert(a,"Select Offset Test (Reverse)"),a?e():n({e:s,g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];s.readMulti("test","all",void 0,void 0,!0,function(e,t){i.push(e)},function(){var s=o.slice().reverse(),a=r.objectsEqual(i,s);t.myConsole.assert(a,"Select All Rows Test (reverse)"),a?e():n({e:s,g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];s.readMulti("test","range",10,20,!1,function(e,t){i.push(e)},function(){var s=o.filter(function(e){return e.id>=10&&e.id<=20}),a=r.objectsEqual(i,s);t.myConsole.assert(a,"Select Range Test 2"),a?e():n({e:s,g:i})},n)})}).then(function(){return new Promise(function(e,n){var i=[];s.readMulti("test","offset",10,20,!1,function(e,t){i.push(e)},function(){var s=r.objectsEqual(i,o.filter(function(e){return e.id>10&&e.id<=30}));t.myConsole.assert(s,"Select Offset / Limit Test"),s?e():n({g:i,e:o.filter(function(e){return e.id>10&&e.id<=30})})},n)})}).then(function(){return new Promise(function(e,n){var i=[];s.readMulti("test","all",void 0,void 0,!1,function(e,t){i.push(e)},function(){var s=r.objectsEqual(i,o);t.myConsole.assert(s,"Select Entire Table"),s?e():n({e:o,g:i})},n)})}).then(function(){return new Promise(function(e,n){s.getTableIndex("test",function(i){var s=r.objectsEqual(i,u);t.myConsole.assert(s,"Select Index Test"),s?e():n({e:u,g:i})},n)})}).then(function(){return new Promise(function(e,n){s.getTableIndexLength("test",function(r){var i=500===r;t.myConsole.assert(i,"Select Index Length Test"),i?e():n({e:500,g:r})},n)})}).then(function(){return new Promise(function(e,t){s.dropTable("test",function(){s.disconnect(e,t)},t)})})},e.prototype.RangeReadsUUID=function(){var n,s=new((n=this.adapter).bind.apply(n,[void 0].concat(this.args))),a=new i.nanoSQL,o=[],u=[];return new Promise(function(t,n){s.nSQL=a,s.connect("123",function(){e.newTable(s,a,"test",{id:r.uuid(),name:"test",model:{"id:uuid":{pk:!0},"name:string":{}},columns:[{key:"id",type:"uuid"},{key:"name",type:"string"}],indexes:{},actions:[],views:[],queries:{},pkType:"uuid",pkCol:["id"],isPkNum:!1,ai:!1},t,n)},n)}).then(function(){return new Promise(function(e,t){for(var n=[],i=0;i<500;i++){var a=r.uuid();o.push({id:a,name:"Title "+i}),n.push("Title "+i),u.push(a)}u.sort(function(e,t){return e>t?1:-1}),o.sort(function(e,t){return e.id>t.id?1:-1}),r.chainAsync(o,function(e,n,r){s.write("test",e.id,e,r,t)}).then(e)})}).then(function(){return new Promise(function(e,n){var i=[];s.readMulti("test","offset",10,20,!1,function(e,t){i.push(e)},function(){var s=r.objectsEqual(i,o.filter(function(e,t){return t>=10&&t<30}));t.myConsole.assert(s,"Select Range Test 2"),s?e():n({g:i,e:o.filter(function(e,t){return t>=10&&t<30})})},n)})}).then(function(){return new Promise(function(e,n){var i=[];s.readMulti("test","range",o[10].id,o[20].id,!1,function(e,t){i.push(e)},function(){var s=r.objectsEqual(i,o.filter(function(e){return e.id>=o[10].id&&e.id<=o[20].id}));t.myConsole.assert(s,"Select Range Test (Primary Key)"),s?e():n({g:i,e:o.filter(function(e){return e.id>=o[10].id&&e.id<=o[20].id})})},n)})}).then(function(){return new Promise(function(e,n){var i=[];s.readMulti("test","all",void 0,void 0,!1,function(e,t){i.push(e)},function(){var s=r.objectsEqual(i,o);t.myConsole.assert(s,"Select Entire Table Test"),s?e():n({e:o,g:i})},n)})}).then(function(){return new Promise(function(e,n){s.getTableIndex("test",function(i){var s=r.objectsEqual(i,u);t.myConsole.assert(s,"Select Index Test"),s?e():n({e:u,g:i})},n)})}).then(function(){return new Promise(function(e,n){s.getTableIndexLength("test",function(r){var i=500===r;t.myConsole.assert(i,"Select Index Length Test"),i?e():n({e:500,g:r})},n)})}).then(function(){return new Promise(function(e,t){s.dropTable("test",function(){s.disconnect(e,t)},t)})})},e.prototype.Writes=function(){var n,s=new((n=this.adapter).bind.apply(n,[void 0].concat(this.args))),a=new i.nanoSQL;return new Promise(function(t,n){s.nSQL=a,s.connect("123",function(){e.newTable(s,a,"test",{id:r.uuid(),name:"test",model:{"id:int":{pk:!0,ai:!0},"name:string":{},"posts:string[]":{}},columns:[{key:"id",type:"int"},{key:"name",type:"string"},{key:"posts",type:"string[]"}],indexes:{},actions:[],views:[],queries:{},pkType:"int",pkCol:["id"],isPkNum:!0,ai:!0},t,n)},n)}).then(function(){return new Promise(function(e,n){s.write("test",null,{name:"Test",posts:[1,2]},function(i){s.read("test",i,function(i){var s={name:"Test",id:1,posts:[1,2]},a=r.objectsEqual(i,s);t.myConsole.assert(a,"Insert Test"),a?e():n({e:s,g:i})},n)},n)})}).then(function(){return new Promise(function(e,n){s.write("test",1,{id:1,name:"Testing",posts:[1,2]},function(i){s.read("test",i,function(i){var s={name:"Testing",id:1,posts:[1,2]},a=r.objectsEqual(i,s);t.myConsole.assert(a,"Update Test"),a?e():n({e:s,g:i})},n)},n)})}).then(function(){return new Promise(function(e,n){s.write("test",1,{id:1,name:"Testing"},function(i){s.read("test",i,function(i){var s={name:"Testing",id:1},a=r.objectsEqual(i,s);t.myConsole.assert(a,"Replace Test"),a?e():n({e:s,g:i})},n)},n)})}).then(function(){return new Promise(function(e,t){s.dropTable("test",function(){s.disconnect(e,t)},t)})})},e.prototype.PrimaryKeys=function(){var n,s=new((n=this.adapter).bind.apply(n,[void 0].concat(this.args))),a=new i.nanoSQL;return new Promise(function(t,n){s.nSQL=a,s.connect("123",function(){Promise.all(["test","test2","test3","test4","test5","test6","test7","test8"].map(function(t){return new Promise(function(n,i){e.newTable(s,a,t,{id:r.uuid(),name:"test",model:{test:{"id:int":{pk:!0,ai:!0},"name:string":{}},test2:{"id:uuid":{pk:!0},"name:string":{}},test3:{"id:timeId":{pk:!0},"name:string":{}},test4:{"id:timeIdms":{pk:!0},"name:string":{}},test5:{"id:uuid":{pk:!0},"name:string":{}},test6:{"id:float":{pk:!0},"name:string":{}},test7:{"nested:obj":{model:{"id:int":{pk:!0}}},"name:string":{}},test8:{"id:string":{pk:!0},"name:string":{}}}[t],columns:[{test:{key:"id",type:"int"},test2:{key:"id",type:"uuid"},test3:{key:"id",type:"timeId"},test4:{key:"id",type:"timeIdms"},test5:{key:"id",type:"uuid"},test6:{key:"id",type:"float"},test7:{key:"nested",model:[{key:"id",type:"int"}]},test8:{key:"id",type:"string"}}[t],{key:"name",type:"string"}],indexes:{},actions:[],queries:{},views:[],pkType:{test:"int",test2:"uuid",test3:"timeId",test4:"timeIdms",test5:"uuid",test6:"float",test7:"int",test8:"string"}[t],pkCol:"test7"===t?["nested","id"]:["id"],isPkNum:{test:!0,test2:!1,test3:!1,test4:!1,test5:!1,test6:!0,test7:!0,test8:!1}[t],ai:{test:!0,test2:!1,test3:!1,test4:!1,test5:!1,test6:!1,test7:!1,test8:!1}[t]},n,i)})})).then(t).catch(n)},n)}).then(function(){return new Promise(function(e,n){s.write("test",null,{name:"Test"},function(i){var a=r.objectsEqual(i,1);t.myConsole.assert(a,"Test Auto Incriment Integer."),a?s.read("test",1,function(i){var s=r.objectsEqual(i.id,1);t.myConsole.assert(s,"Select Integer Primary Key."),s?e():n({e:1,g:i.id})},n):n(i)},n)})}).then(function(){return new Promise(function(e,n){s.write("test2",null,{name:"Test"},function(i){var a=i.match(/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/);t.myConsole.assert(a,"Test UUID."),a?s.read("test2",i,function(s){var a=r.objectsEqual(s.id,i);t.myConsole.assert(a,"Select UUID Primary Key."),a?e():n({e:i,g:s.id})},n):n({e:"valid uuid",g:i})},n)})}).then(function(){return new Promise(function(e,n){s.write("test3",null,{name:"Test"},function(i){var a=i.match(/^\w{10}-\w{1,5}$/);t.myConsole.assert(a,"Test timeId."),a?s.read("test3",i,function(s){var a=r.objectsEqual(s.id,i);t.myConsole.assert(a,"Select timeId Primary Key."),a?e():n({e:i,g:s.id})},n):n({e:"valid timeid",g:i})},n)})}).then(function(){return new Promise(function(e,n){s.write("test4",null,{name:"Test"},function(i){var a=i.match(/^\w{13}-\w{1,5}$/);t.myConsole.assert(a,"Test timeIdms."),a?s.read("test4",i,function(s){var a=r.objectsEqual(s.id,i);t.myConsole.assert(a,"Select timeIdms Primary Key."),a?e():n({e:i,g:s.id})},n):n({e:"valid timeidms",g:i})},n)})}).then(function(){return new Promise(function(e,n){for(var i=[],a=0;a<20;a++)i.push(r.uuid());r.chainAsync(i,function(e,t,r){s.write("test5",e,{id:e,name:"Test "+t},r,n)}).then(function(){i.sort();var a=[];s.readMulti("test5","all",void 0,void 0,!1,function(e,t){a.push(e.id)},function(){var s=r.objectsEqual(a,i);t.myConsole.assert(s,"Test Sorted Primary Keys."),s?e():n({e:i,g:a})},n)})})}).then(function(){return new Promise(function(e,n){for(var i=[],a=0;a<20;a++)i.push({id:Math.random(),name:"Test "+a});r.chainAsync(i,function(e,t,r){s.write("test6",e.id,e,r,n)}).then(function(){var a=[];s.readMulti("test6","all",void 0,void 0,!1,function(e){a.push(e)},function(){var o=r.objectsEqual(a,i.sort(function(e,t){return e.id>t.id?1:-1}));t.myConsole.assert(o,"Test float primary keys."),o?s.read("test6",i[0].id,function(s){var a=r.objectsEqual(s.id,i[0].id);t.myConsole.assert(a,"Select Float Primary Key."),a?e():n({e:i[0].id,g:s.id})},n):n({e:i.sort(function(e,t){return e.id>t.id?1:-1}),g:a})},n)}).catch(n)})}).then(function(){return new Promise(function(e,n){for(var i=[],a=1;a<20;a++)i.push({nested:{id:a},name:"Test "+a});r.chainAsync(i,function(e,t,r){s.write("test7",e.nested.id,e,r,n)}).then(function(){var a=[];s.readMulti("test7","all",void 0,void 0,!1,function(e){a.push(e)},function(){var o=r.objectsEqual(a,i);t.myConsole.assert(o,"Test Nested primary keys."),o?s.read("test7",i[2].nested.id,function(s){var a=r.objectsEqual(s.nested.id,i[2].nested.id);t.myConsole.assert(a,"Select Nested Primary Key."),a?e():n({e:i[0].nested.id,g:s.id})},n):n({e:i.sort(function(e,t){return e.id>t.id?1:-1}),g:a})},n)}).catch(n)})}).then(function(){return new Promise(function(e,n){for(var i=[],a=" !#$%&'()*+,-./0123456789;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_abcdefghijklmnopqrstuvwxyz{|}~".split(""),o=0;o<a.length;o++)i.push({id:a[o],name:"Test "+o});r.chainAsync(i,function(e,t,r){s.write("test8",e.id,e,r,n)}).then(function(){var a=[];s.readMulti("test8","all",void 0,void 0,!1,function(e){a.push(e)},function(){var s=r.objectsEqual(a,i);t.myConsole.assert(s,"Test strings sort properly."),s?e():n({e:i,g:a})},n)}).catch(n)})}).then(function(){return Promise.all(["test","test2","test3","test4","test5","test6","test7","test8"].map(function(e){return new Promise(function(t,n){s.dropTable(e,t,n)})})).then(function(){return new Promise(function(e,t){s.disconnect(e,t)})})})},e}();t.nanoSQLAdapterTest=s},function(e,t,n){var r=this&&this.__assign||function(){return(r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var i=n(7),s=n(0),a=n(1);t.InanoSQLInstance=a.InanoSQLInstance;var o=n(15),u=n(16),c=n(17),l=n(0),d=n(8),f=n(2),h=function(){function e(){this.dbs={},this.version=a.VERSION,this.planetRadius=6371;var e=function(e){return"object"==typeof e?JSON.stringify(e):String(e)},t=function(e){return function(t){return isNaN(t)||null===t?0:e(t)}};this.indexTypes={string:e,geo:function(e){},float:t(parseFloat),int:t(parseInt),number:t(parseFloat),date:t(parseInt),uuid:e,timeId:e,timeIdms:e},this._checkTTL=this._checkTTL.bind(this),o.attachDefaultFns(this)}return e.prototype.getDB=function(e){var t=e||this.selectedDB;if(!this.dbs[t])throw new Error("Database "+t+" doesn't exist!");return this.dbs[t]},e.prototype._rebuildFKs=function(){var e=this;this.getDB().state.cacheId=s.uuid(),this.getDB()._fkRels={},Object.keys(this.getDB()._tables).forEach(function(t){var n=e.getDB()._tables[t];Object.keys(n.indexes).forEach(function(r){var i=n.indexes[r];if(i.props&&i.props.foreignKey){var o=s.resolvePath(i.props.foreignKey.target),u=o.shift();e.getDB()._fkRels[u]||(e.getDB()._fkRels[u]=[]),e.getDB()._fkRels[u].push({selfPath:o.map(function(e){return e.replace(/\[\]/gim,"")}),selfIsArray:-1!==i.props.foreignKey.target.indexOf("[]"),childTable:t,childPath:i.path,childIsArray:i.isArray,childIndex:r,onDelete:i.props.foreignKey.onDelete||a.InanoSQLFKActions.NONE})}})})},e.prototype.doFilter=function(e,t,n,r,i){var a=this;e&&this.getDB(e).filters[t]?s.chainAsync(this.getDB(e).filters[t],function(r,s,o){a.getDB(e).filters[t][s](n,function(e){n=e,o()},i)}).then(function(){r(n)}):r(n)},e.prototype.getCache=function(e,t){if(!this.getDB()._queryCache[e])throw new Error('Cache "'+e+'" not found!');return t?this.getDB()._queryCache[e].slice(t.offset,t.offset+t.limit):this.getDB()._queryCache[e].slice()},e.prototype.clearCache=function(e){var t=void 0!==this.getDB()._queryCache[e];return delete this.getDB()._queryCache[e],t},e.prototype.clearTTL=function(e){var t=this,n=this.selectedTable+"."+e;return new Promise(function(e,i){t.triggerQuery(t.selectedDB,r({},s.buildQuery(t.selectedDB,t,"_ttl","delete"),{where:["key","=",n]}),s.noop,e,i)})},e.prototype.expires=function(e){var t=this;return new Promise(function(n,i){var a=t.selectedTable+"."+e,o=[];t.triggerQuery(t.selectedDB,r({},s.buildQuery(t.selectedDB,t,"_ttl","select"),{where:["key","=",a]}),function(e){o.push(e)},function(){o.length?n({time:(o[0].date-Date.now())/1e3,cols:o[0].cols}):n({time:-1,cols:[]})},i)})},e.prototype._checkTTL=function(){var e=this;if(!this.getDB().config.disableTTL){this.getDB()._ttlTimer&&clearTimeout(this.getDB()._ttlTimer);var t=0,n=0,i=function(){var a=[];e.triggerQuery(e.selectedDB,r({},s.buildQuery(e.selectedDB,e,"_ttl","select"),{limit:20,offset:20*t}),function(e){a.push(e)},function(){a.length?s.chainAsync(a,function(t,i,a){if(t.date<Date.now()){var o=function(){e.triggerQuery(e.selectedDB,r({},s.buildQuery(e.selectedDB,e,"_ttl","delete"),{where:["key","=",t.key]}),s.noop,a,s.throwErr)},u=t.key.split("."),c=u[0],l=-1===["float","int","number"].indexOf(e.getDB()._tables[c].pkType)?u[1]:parseFloat(u[1]);if(t.cols.length){var d={};t.cols.forEach(function(e){d[e]=null}),e.triggerQuery(e.selectedDB,r({},s.buildQuery(e.selectedDB,e,c,"upsert"),{actionArgs:d,where:[e.getDB()._tables[c].pkCol,"=",l]}),s.noop,o,s.throwErr)}else e.triggerQuery(e.selectedDB,r({},s.buildQuery(e.selectedDB,e,c,"delete"),{where:[e.getDB()._tables[c].pkCol,"=",l]}),s.noop,o,s.throwErr)}else n=Math.max(n,t.date),a()}).then(function(){t++,i()}):n&&(e.getDB()._ttlTimer=setTimeout(e._checkTTL,n-Date.now()))},s.throwErr)};i()}},e.prototype.selectTable=function(e){return e&&(this.selectedTable=e),this},e.prototype.getPeers=function(){return JSON.parse(localStorage.getItem("nsql-peers-"+this.getDB().state.id)||"[]")},e.prototype._initPlugins=function(e){var t=this;return new Promise(function(n,r){var i={};(e.plugins||[]).forEach(function(e){(e.filters||[]).forEach(function(e){i[e.name]||(i[e.name]=[]);for(var t=e.priority;i[e.name][t];)t++;i[e.name][t]=e.call})}),Object.keys(i).forEach(function(e){t.getDB().filters[e]=[],i[e].forEach(function(n){n&&t.getDB().filters[e].unshift(n)})});var s=function(e,t){return!t||!t.length||(1===t.length?e>=t[0]:e>=t[0]&&e<t[1])},o=!1;(e.plugins||[]).forEach(function(t){if(t.dependencies){var n=t.dependencies||{};Object.keys(t.dependencies).forEach(function(i,u,c){if("core"===i)s(a.VERSION,n[i])||(o=!0,r('Plugin "'+t.name+'" requires a different core version of nano-sql!'));else{var l=(e.plugins||[]).reduce(function(e,t){return t.name===i?t:e});l||(o=!0,r('Plugin "'+t.name+'" requires plugin "'+i+"\" but it isn't installed!")),s(l.version,n[i])||(o=!0,r('Plugin "'+t.name+'" requires a different version of "'+i+'"!'))}})}}),o||n()})},e.prototype._saveTableIds=function(){var e=this;return new Promise(function(t,n){e.triggerQuery(e.selectedDB,r({},s.buildQuery(e.selectedDB,e,"_util","upsert"),{actionArgs:s.assign({key:"tableIds",value:e.getDB(e.selectedDB)._tableIds})}),s.noop,t,n)})},e.prototype.presetQuery=function(e,t){if("string"!=typeof this.selectedTable)throw new Error("Can't get table queries without selecting a table!");if(!(-1!==Object.keys(this.getDB()._tables[this.selectedTable].queries).indexOf(e)))throw new Error("Can't find preset query "+e+"!");var n=this.getDB()._tables[this.selectedTable].queries[e].args,r={};n&&(r=s.cleanArgs2(this.selectedDB,t,n,this));var i=this.getDB()._tables[this.selectedTable].queries[e].call(this,r),a=this.query("");return a._query=i,a},e.prototype.useDatabase=function(e){return this.selectedDB=e,this},e.prototype.createDatabase=function(e){return this.connect(e)},e.prototype.listDatabases=function(){return Object.keys(this.dbs)},e.prototype.dropDatabase=function(e){var t=this;return new Promise(function(n,i){var a=Object.keys(t.getDB(e)._tables);s.chainAsync(a,function(n,i,a,o){var u=t.getDB(e)._tables[n];t.triggerQuery(e,r({},s.buildQuery(e,t,u.name,"drop")),s.noop,function(){a()},o)}).then(function(){delete t.dbs[e],n()}).catch(i)})},e.prototype.connect=function(e){var t=this;void 0===e&&(e={});var n=String(e.id)||"nSQL_DB";if(this.dbs[n])throw new Error("nSQL: "+n+" database has already been created!");return this.dbs[n]={adapter:new f.SyncStorage,_ttlTimer:0,_Q:new s._nanoSQLQueue,state:{activeAV:"",hasAnyEvents:!1,peers:[],pid:s.uuid(),id:s.uuid(),cacheId:s.uuid(),peerEvents:[],focused:!0,peerMode:!1,connected:!1,ready:!1,exportQueryObj:!1},config:{id:n,queue:!1},_tables:{},_fkRels:{},_tableIds:{_util:"_util",_ttl:"_ttl"},_queryCache:{},filters:{},eventFNs:{Core:{"*":new i.ReallySmallEvents},"*":{"*":new i.ReallySmallEvents}}},this.selectedDB=n,this._initPlugins(e).then(function(){return new Promise(function(r,i){t.doFilter(n,"config",{res:e},function(e){r(e.res)},i)})}).then(function(e){return t.getDB(n).state.id=n,t.getDB(n).config=r({plugins:[]},e),"undefined"!=typeof window&&e&&e.peer&&(t.getDB(n).state.peerMode=!0),new Promise(function(e,r){t.doFilter(n,"willConnect",{res:t},function(){e()},r)})}).then(function(){return new Promise(function(e,r){t.getDB(n).adapter=d.resolveMode(t.getDB(n).config.mode||"TEMP",t.getDB(n).config),t.getDB(n).adapter.plugin&&(t.getDB(n).config.plugins||[]).push(t.getDB(n).adapter.plugin),t._initPlugins(t.getDB(n).config).then(function(){t.getDB(n).adapter.nSQL=t,s.adapterFilters(n,t).connect(t.getDB(n).state.id,function(){t.doFilter(n,"postConnect",{res:t.getDB(n).config},function(r){t.getDB(n).config=r.res,e()},r)},r)}).catch(r),t.getDB(n).config.planetRadius&&(t.planetRadius=t.getDB(n).config.planetRadius)})}).then(function(){t.triggerEvent(n,{target:"Core",targetId:t.getDB(n).state.id,path:"*",events:["connect"],time:Date.now()}),t.getDB(n).state.connected=!0;var e=["_util","_ttl"].concat((t.getDB(n).config.tables||[]).map(function(e){return e.name}));return s.chainAsync(e,function(e,i,a,o){switch(e){case"_util":t.triggerQuery(n,r({},s.buildQuery(n,t,"_util","create table"),{actionArgs:{name:"_util",model:{"key:string":{pk:!0},"value:any":{}},_internal:!0}}),s.noop,function(){t.triggerQuery(n,r({},s.buildQuery(n,t,"_util","select"),{where:["key","=","tableIds"]}),function(e){t.getDB(n)._tableIds=r({},t.getDB(n)._tableIds,e.value)},function(){a()},o)},o);break;case"_ttl":t.triggerQuery(n,r({},s.buildQuery(n,t,"_ttl","create table"),{actionArgs:{name:"_ttl",model:{"key:string":{pk:!0},"table:string":{},"cols:string[]":{},"date:number":{}},_internal:!0}}),s.noop,a,o);break;default:var u=(t.getDB(n).config.tables||[]).filter(function(t){return t.name===e})[0];if(!u)return void o("Table not found!");t.triggerQuery(n,r({},s.buildQuery(n,t,e,"create table"),{actionArgs:u}),s.noop,a,o)}})}).then(function(){return new Promise(function(e,i){var o;t.triggerQuery(n,r({},s.buildQuery(n,t,"_util","select"),{where:["key","=","version"]}),function(e){e&&(o=e.value)},function(){!o||o<2?t.triggerQuery(n,r({},s.buildQuery(n,t,"_util","upsert"),{actionArgs:{key:"version",value:a.VERSION}}),s.noop,e,i):e()},i)})}).then(function(){return new Promise(function(e,i){var a;t.getDB(n).config.version?t.triggerQuery(n,r({},s.buildQuery(n,t,"_util","select"),{where:["key","=","db-version"]}),function(e){e&&(a=e.value)},function(){var o=function(e,i,a){t.triggerQuery(n,r({},s.buildQuery(n,t,"_util","upsert"),{actionArgs:{key:"db-version",value:e}}),s.noop,i,a)};if(a){var u=function(){if(a===t.getDB(n).config.version)o(t.getDB(n).config.version||0,e,i);else{var r=t.getDB(n).config.onVersionUpdate;if(!r)return void o(t.getDB(n).config.version||0,e,i);r(a).then(function(e){o(a=e,function(){s.setFast(u)},i)}).catch(i)}};u()}else o(t.getDB(n).config.version||0,e,i)},i):e()})}).then(function(){return new Promise(function(e,r){var i={target:"Core",path:"*",targetId:t.getDB(n).state.id,events:["ready"],time:Date.now()};t.doFilter(n,"ready",{res:i},function(r){t.triggerEvent(n,r.res),t.getDB(n).state.ready=!0,t.getDB(n).config.disableTTL||t._checkTTL(),t.getDB(n).config.peer&&t._initPeers(),e()},r)})})},e.prototype._initPeers=function(){var e=this,n=0;this.getDB().state.pid=s.uuid(),this.getDB().state.peers=this.getPeers(),this.getDB().state.peers.unshift(this.getDB().state.pid),localStorage.setItem("nsql-peers-"+this.getDB().state.id,JSON.stringify(this.getDB().state.peers)),window.addEventListener("storage",function(t){if(t.key==="nsql-peers-"+e.getDB().state.id&&(e.getDB().state.peers=e.getPeers()),t.key&&0===t.key.indexOf(e.getDB().state.pid+".")){localStorage.removeItem(t.key);var i=JSON.parse(t.newValue||"{}");e.getDB().state.peerEvents.push(i.query.queryID||""),e.triggerEvent(e.selectedDB,r({},i,{types:["peer change"]})),s.setFast(function(){e.triggerEvent(e.selectedDB,i)})}if(++n>50&&e.getDB().state.peers[0]===e.getDB().state.pid){n=0;for(var a=localStorage.length,o={};a--;){var u=localStorage.key(a),c=u?u.match(/\w{8}-\w{4}-\w{4}-\w{4}-\w{8}/gim):null;if(u&&c){var l=(c||[""])[0];o[l]||(o[l]=[]),o[l].push(u)}}Object.keys(o).forEach(function(t){o[t].length>10&&(e.getDB().state.peers=e.getDB().state.peers.filter(function(e){return e!==t}),o[t].forEach(function(e){localStorage.removeItem(e)}),localStorage.setItem("nsql-peers-"+e.getDB().state.id,JSON.stringify(e.getDB().state.peers)))})}}),window.onblur=function(){e.getDB().state.focused=!1},window.onfocus=function(){e.getDB().state.peers=e.getDB().state.peers.filter(function(t){return t!==e.getDB().state.pid}),e.getDB().state.peers.unshift(e.getDB().state.pid),localStorage.setItem("nsql-peers-"+e.getDB().state.id,JSON.stringify(e.getDB().state.peers)),e.getDB().state.focused=!0},t.nSQL("*").on("change",function(t){var n=e.getDB().state.peerEvents.indexOf(t.query.queryID||"");-1===n?e.getDB().state.peers.filter(function(t){return t!==e.getDB().state.pid}).forEach(function(e){localStorage.setItem(e+"."+t.query.queryID,JSON.stringify(t))}):e.getDB().state.peerEvents.splice(n,1)}),window.addEventListener("beforeunload",function(){return e.getDB().state.peers=e.getDB().state.peers.filter(function(t){return t!==e.getDB().state.pid}),localStorage.setItem("nsql-peers-"+e.getDB().state.id,JSON.stringify(e.getDB().state.peers)),!1})},e.prototype.every=function(e){for(var t=0,n=[];t<=e.length;)e.every?t%e.every==0&&n.push(t+(e.offset||0)):n.push(t+(e.offset||0)),t++;return n},e.prototype.on=function(e,t,n){var r=this,a=n||("string"!=typeof this.selectedTable?"":this.selectedTable);this.doFilter(this.selectedDB,"onEvent",{res:{action:e,callback:t}},function(t){switch(t.res.action){case"connect":case"ready":case"disconnect":case"peer change":case"slow query":r.getDB().eventFNs.Core["*"].on(t.res.action,t.res.callback);break;case"select":case"change":case"delete":case"upsert":case"*":var n=s.resolvePath(a);r.getDB().eventFNs[n[0]]||(r.getDB().eventFNs[n[0]]={"*":new i.ReallySmallEvents});var o=n.filter(function(e,t){return t>0}).join(".")||"*";r.getDB().eventFNs[n[0]][o]||(r.getDB().eventFNs[n[0]][o]=new i.ReallySmallEvents),r.getDB().eventFNs[n[0]][o].on(t.res.action,t.res.callback);break;default:new Promise(function(t,n){r.doFilter(r.selectedDB,"customEvent",{res:{nameSpace:"",path:"*"},selectedTable:a,action:e,on:!0},t,n)}).then(function(n){if(!n.res.nameSpace)throw new Error('Invalid event "'+e+'"!');r.getDB().eventFNs[n.res.nameSpace]||(r.getDB().eventFNs[n.res.nameSpace]={"*":new i.ReallySmallEvents}),r.getDB().eventFNs[n.res.nameSpace][n.res.path]||(r.getDB().eventFNs[n.res.nameSpace][n.res.path]=new i.ReallySmallEvents),r.getDB().eventFNs[n.res.nameSpace][n.res.path].on(t.res.action,t.res.callback),r._refreshEventChecker()})}r._refreshEventChecker()},s.noop)},e.prototype.off=function(e,t,n){var r=this,a=n||("string"!=typeof this.selectedTable?"":this.selectedTable);this.doFilter(this.selectedDB,"onEvent",{res:{action:e,callback:t}},function(t){switch(t.res.action){case"connect":case"ready":case"disconnect":case"peer change":case"slow query":r.getDB().eventFNs.Core["*"].off(t.res.action,t.res.callback);break;case"select":case"change":case"delete":case"upsert":case"*":var n=s.resolvePath(a);r.getDB().eventFNs[n[0]]||(r.getDB().eventFNs[n[0]]={"*":new i.ReallySmallEvents});var o=n.filter(function(e,t){return t>0}).join(".")||"*";r.getDB().eventFNs[n[0]][o]||(r.getDB().eventFNs[n[0]][o]=new i.ReallySmallEvents),r.getDB().eventFNs[n[0]][o].off(t.res.action,t.res.callback);break;default:new Promise(function(t,n){r.doFilter(r.selectedDB,"customEvent",{res:{nameSpace:"",path:"*"},selectedTable:a,action:e,on:!0},t,n)}).then(function(n){if(!n.res.nameSpace)throw new Error('Invalid event "'+e+'"!');r.getDB().eventFNs[n.res.nameSpace]||(r.getDB().eventFNs[n.res.nameSpace]={"*":new i.ReallySmallEvents}),r.getDB().eventFNs[n.res.nameSpace][n.res.path]||(r.getDB().eventFNs[n.res.nameSpace][n.res.path]=new i.ReallySmallEvents),r.getDB().eventFNs[n.res.nameSpace][n.res.path].off(t.res.action,t.res.callback),r._refreshEventChecker()})}r._refreshEventChecker()},s.noop)},e.prototype._refreshEventChecker=function(){var e=this;return this.getDB().state.hasAnyEvents=Object.keys(this.getDB().eventFNs).reduce(function(t,n){return!0===t||(Object.keys(e.getDB().eventFNs[n]).reduce(function(t,r){return Object.keys(e.getDB().eventFNs[n][r].eventListeners).length+t},0)>0||t)},!1),this},e.prototype.getView=function(e,t){return this._doAV("v",this.selectedTable,e,t)},e.prototype.doAction=function(e,t){return this._doAV("a",this.selectedTable,e,t)},e.prototype._doAV=function(e,t,n,r){var i=this;return"string"!=typeof this.selectedTable?Promise.reject("Can't do Action/View with selected table!"):new Promise(function(s,a){i.doFilter(i.selectedDB,"actionView",{res:{AVType:e,table:t,AVName:n,AVArgs:r}},s,a)}).then(function(e){var t="a"===e.res.AVType?"actions":"views",n=i.getDB()._tables[e.res.table][t].reduce(function(t,n){return n.name===e.res.AVName?n:t},null);return n?n.call(n.args?s.cleanArgs(i.selectedDB,n.args,e.res.AVArgs,i):{},i):new Promise(function(t,n){return n(e.res.AVType+' "'+e.res.AVName+'" Not Found!')})})},e.prototype.query=function(e,t){if(this.selectedDB){var n=this.getDB().state.activeAV;return this.getDB().state.activeAV="",new c._nanoSQLQueryBuilder(this.selectedDB,this,this.selectedTable,e,t,n)}return new c._nanoSQLQueryBuilder(this.selectedDB,this,this.selectedTable,e,t,"")},e.prototype.triggerQuery=function(e,t,n,r,i){var s=this,a=function(t){e&&"string"==typeof t.res.table&&s.getDB(e).config.queue&&!t.res.skipQueue?s.getDB(e)._Q.newItem({query:t.res,onRow:n,complete:r,error:i},function(t,n,r){new u._nanoSQLQuery(e,s,t.query,t.onRow,function(){n(),t.complete()},function(e){n(),t.error(e)})}):new u._nanoSQLQuery(e,s,t.res,function(e){n(e)},r,i)};if("string"==typeof t.table){if(!this.getDB(e).state.connected)return void i("nSQL: Can't do a query before the database is connected!");this.doFilter(e,"query",{res:t},a,i)}else a({res:t})},e.prototype.triggerEvent=function(e,t,n){var r=this;return e?(this.doFilter(e,"event",{res:t},function(t){r.getDB(e).state.hasAnyEvents&&s.setFast(function(){t.res.events.forEach(function(i){if(n||Object.keys(r.getDB(e).eventFNs["*"]).forEach(function(n){r.getDB(e).eventFNs["*"][n].trigger(i,t.res)}),r.getDB(e).eventFNs[t.res.target])if("_all_"===t.res.path)Object.keys(r.getDB(e).eventFNs[t.res.target]).forEach(function(n){r.getDB(e).eventFNs[t.res.target][n].trigger(i,t.res)});else{if(!r.getDB(e).eventFNs[t.res.target][t.res.path])return;r.getDB(e).eventFNs[t.res.target][t.res.path].trigger(i,t.res)}})})},function(e){console.log("Event suppressed",e)}),this):this},e.prototype.default=function(e,t,n){var r=this;if(!e)return t;if(t=t||{},!n&&"string"!=typeof this.selectedTable)throw new Error("Must select table to generate defualts!");if(n=n||this.selectedTable,!this.getDB(e)._tables[n])throw new Error('nSQL: Table "'+n+'" not found in database '+e+" for generating default object!");var i="",a=function(n,o,u){var c={};if(o=o||{},u&&u.length&&-1!==u.indexOf("[]"))return Array.isArray(o)?o.map(function(e){return a(n,e,u.slice(0,u.lastIndexOf("[]")))}):[];var l=!1;if(n.forEach(function(n){if("*"!==n.key){if(n.model)if(-1!==n.type.indexOf("[]")){var u=void 0!==o?o[n.key]:[];Array.isArray(u)?c[n.key]=u.map(function(e){return a(n.model,e,n.type.slice(0,n.type.lastIndexOf("[]")))}):c[n.key]=[]}else c[n.key]=a(n.model,void 0!==o?o[n.key]:void 0);else{var d=void 0!==o[n.key]?s.cast(e,n.type,o[n.key],!1,r):"function"==typeof n.default?n.default(t):n.default;void 0!==n.max&&d>n.max&&(i="Data error, column "+n.key+" can't be greater than "+n.max+"!"),void 0!==n.min&&d<n.min&&(i="Data error, column "+n.key+" can't be less than "+n.min+"!"),c[n.key]=d}!n.notNull||null!==c[n.key]&&void 0!==c[n.key]||(i="Data error, "+n.key+" cannot be null!"),null===c[n.key]&&(c[n.key]=void 0)}else l=!0}),i.length)throw new Error(i);if(l&&o){var d=n.map(function(e){return e.key});Object.keys(o).filter(function(e){return-1===d.indexOf(e)}).forEach(function(e){c[e]=o[e]})}return c};return a(this.getDB(e)._tables[n].columns,t)},e.prototype.rawDump=function(e,t,n){var r=this,i=t?e:Object.keys(this.getDB()._tables).filter(function(t){return!e.length||-1!==e.indexOf(t)});return s.chainAsync(i,function(e,i,a,o){if(t){var u=-1!==e.indexOf(":")?e.split(":")[0]:e,c=-1!==e.indexOf(":")?[e.split(":")[1]]:Object.keys(r.getDB()._tables[e].indexes);s.chainAsync(c,function(e,t,i,a){s.adapterFilters(r.selectedDB,r).readIndexKeys(u,e,"all",void 0,void 0,!1,function(t,r){n(u+"."+e,{indexId:r,rowId:t})},i,a)}).then(a).catch(o)}else s.adapterFilters(r.selectedDB,r).readMulti(e,"all",void 0,void 0,!1,function(t){n(e,t)},a,o||s.noop)})},e.prototype.rawImport=function(e,t,n){var r=this,i=0,a=Object.keys(e).reduce(function(t,n){return t+=e[n].length},0),o=Object.keys(this.getDB()._tables),u=t?Object.keys(e):Object.keys(e).filter(function(e){return-1!==o.indexOf(e)});return s.chainAsync(u,function(o,u,c,l){if(t){var d=o.split(".")[0],f=o.split(".")[1];s.chainAsync(e[o],function(e,t,n,i){s.adapterFilters(r.selectedDB,r).addIndexValue(d,f,e.rowId,e.indexId,n,i)}).then(c).catch(l)}else{var h=r.getDB()._tables[o].pkCol;s.chainAsync(e[o],function(e,t,u,c){s.deepGet(h,e)||!c?s.adapterFilters(r.selectedDB,r).write(o,s.deepGet(h,e),e,function(e){u(),i++,n&&n(Math.round(i/a*1e4)/100)},c||s.noop):c("No primary key found, can't import: "+JSON.stringify(e))}).then(c).catch(l)}})},e.prototype.disconnect=function(e){var t=this;return new Promise(function(n,r){var i=e?[e]:Object.keys(t.dbs);s.chainAsync(i,function(e,n,r,i){t.doFilter(e,"disconnect",{},function(){s.adapterFilters(e,t).disconnect(function(){delete t.dbs[e],r()},i)},i)}).then(function(){n()}).catch(r)})},e.prototype.extend=function(e){for(var t=this,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];return new Promise(function(r,i){t.doFilter(t.selectedDB,"extend",{scope:e,args:n,res:null},r,i)})},e.prototype.loadJS=function(e,t,n){var i=this,a=this.selectedTable;if("string"!=typeof a)return Promise.reject("nSQL: Can't load JS into temporary table!");var o=e.length,u=0;return(n?s.allAsync:s.chainAsync)(e,function(e,n,c,l){i.triggerQuery(i.selectedDB,r({},s.buildQuery(i.selectedDB,i,a,"upsert"),{actionArgs:e}),function(e){},function(){u++,t&&t(u/o*1e4/100),c()},l)})},e.prototype.JSONtoCSV=function(e,t,n){var r=[];if(!e.length)return"";var i=[];return n?i=n:(e.forEach(function(e){i=Object.keys(e).concat(i)}),i=i.filter(function(e,t,n){return n.indexOf(e)===t})),t&&r.push(i.map(function(e){return'"'+e+'"'}).join(",")),e.forEach(function(e){r.push(i.map(function(t){return null===e[t]||void 0===e[t]?"":"string"==typeof e[t]?'"'+e[t].replace(/\"/g,'""')+'"':"boolean"==typeof e[t]?!0===e[t]?"true":"false":"object"==typeof e[t]?'"'+JSON.stringify(e[t]).replace(/\"/g,'""')+'"':e[t]}).join(","))}),r.join("\n")},e.prototype.csvToArray=function(e){for(var t,n="",r=[""],i=[r],s=0,a=0,o=!0,u=0,c=e;u<c.length;u++)'"'===(t=c[u])?(o&&t===n&&(r[s]+=t),o=!o):","===t&&o?t=r[++s]="":"\n"===t&&o?("\r"===n&&(r[s]=r[s].slice(0,-1)),r=i[++a]=[t=""],s=0):r[s]+=t,n=t;return i[0]},e.prototype.CSVtoJSON=function(e,t){var n=this,r=[];return e.split(/\r?\n|\r|\t/gim).map(function(e,i){if(0!==i){if(!(String(e).trim().length<1)){var s=n.csvToArray(e);if(s){s=s.map(function(e){return e.trim()});for(var a=r.length,o={};a--;)if(s[a])if("true"===s[a]||"false"===s[a])o[r[a]]="true"===s[a];else if(0===s[a].indexOf("{")||0===s[a].indexOf("["))try{o[r[a]]=JSON.parse(s[a])}catch(e){o[r[a]]=s[a]}else 0===s[a].indexOf('"')?o[r[a]]=s[a].slice(1,s[a].length-1).replace(/\"\"/gim,'"'):o[r[a]]=s[a];return t?t(o):o}}}else r=e.split(",").map(function(e){return e.substring(1,e.length-1)})}).filter(function(e){return e})},e.prototype.loadCSV=function(e,t,n,i){var a=this,o=this.selectedTable;if("string"!=typeof o)return Promise.reject("nSQL: Can't load CSV into temporary table!");var u=this.CSVtoJSON(e,t),c=i?s.allAsync:s.chainAsync,l=0;return c(u,function(e,t,i,c){a.triggerQuery(a.selectedDB,r({},s.buildQuery(a.selectedDB,a,o,"upsert"),{actionArgs:e}),s.noop,function(){l++,n&&n(Math.round(l/u.length*1e4)/100),i()},c||s.noop)})},e}();t.nanoSQL=h,t.nSQLv1Config=function(e){var t={},n={},i="",s=function(e){return(i=e||i)&&!t[i]&&(t[i]={name:i,model:{},indexes:{},actions:[],views:[]}),{model:function(n){var r={};return t[i].model=n.reduce(function(e,t){var n=t.key+":"+t.type;return e[n]={},t.props&&(-1!==t.props.indexOf("pk")&&(e[n].pk=!0),-1!==t.props.indexOf("ai")&&(e[n].ai=!0),r&&-1!==t.props.indexOf("idx")&&(r[n]={})),e},{}),t[i].indexes=r,s(e)},actions:function(n){return t[i].actions=n,s(e)},views:function(n){return t[i].views=n,s(e)},config:function(t){return n=t,s(e)},table:function(e){return s(e)},rowFilter:function(n){return t[i].filter=n,s(e)}}};return e(s),r({id:n.id||"nanoSQL_DB"},n,{tables:Object.keys(t).map(function(e){return t[e]})})};var p=new h;t.nSQL=function(e){return p.selectTable(e)},"undefined"!=typeof window&&(window["@nano-sql"]||(window["@nano-sql"]={}),window["@nano-sql"].core={nSQL:t.nSQL,nanoSQL:h,utilities:l,nSQLv1Config:t.nSQLv1Config})},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(5),s={},a=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return t.map(function(t){return parseFloat(isNaN(t)?r.getFnValue(e,t):t)})};t.attachDefaultFns=function(e){e.functions={COUNT:{type:"A",aggregateStart:{result:0,row:{}},call:function(e,t,n,i){return i&&"*"!==i?r.getFnValue(t,i)&&n.result++:n.result++,n.row=t,n}},MAX:{type:"A",aggregateStart:{result:void 0,row:{}},call:function(e,t,n,i){var s=r.getFnValue(t,i)||0;return void 0===n.result?(n.result=s,n.row=t):s>n.result&&(n.result=s,n.row=t),n}},MIN:{type:"A",aggregateStart:{result:void 0,row:{}},call:function(e,t,n,i){var s=r.getFnValue(t,i)||0;return void 0===n.result?(n.result=s,n.row=t):s<n.result&&(n.result=s,n.row=t),n}},GREATEST:{type:"S",call:function(e,t,n){for(var i=[],s=3;s<arguments.length;s++)i[s-3]=arguments[s];return{result:i.map(function(e){return isNaN(e)?r.getFnValue(t,e):parseFloat(e)}).sort(function(e,t){return e<t?1:-1})[0]}}},LEAST:{type:"S",call:function(e,t,n){for(var i=[],s=3;s<arguments.length;s++)i[s-3]=arguments[s];return{result:i.map(function(e){return isNaN(e)?r.getFnValue(t,e):parseFloat(e)}).sort(function(e,t){return e>t?1:-1})[0]}}},AVG:{type:"A",aggregateStart:{result:0,row:{},total:0,records:0},call:function(e,t,n,i){var s=parseFloat(r.getFnValue(t,i)||0)||0;return n.total+=isNaN(s)?0:s,n.records++,n.result=n.total/n.records,n.row=t,n}},SUM:{type:"A",aggregateStart:{result:0,row:{}},call:function(e,t,n,i){var s=parseFloat(r.getFnValue(t,i)||0)||0;return n.result+=isNaN(s)?0:s,n.row=t,n}},ADD:{type:"S",call:function(e,t,n){for(var r=[],i=3;i<arguments.length;i++)r[i-3]=arguments[i];return{result:a(t,r).reduce(function(e,t,n){return 0===n?t:e+t})}}},SUB:{type:"S",call:function(e,t,n){for(var r=[],i=3;i<arguments.length;i++)r[i-3]=arguments[i];return{result:a(t,r).reduce(function(e,t,n){return 0===n?t:e-t})}}},DIV:{type:"S",call:function(e,t,n,r){for(var i=[],s=4;s<arguments.length;s++)i[s-4]=arguments[s];return{result:a(t,i).reduce(function(e,t,n){return 0===n?t:e/t})}}},MULT:{type:"S",call:function(e,t,n){for(var r=[],i=3;i<arguments.length;i++)r[i-3]=arguments[i];return{result:a(t,r).reduce(function(e,t,n){return 0===n?t:e*t})}}},MOD:{type:"S",call:function(e,t,n,r,i){var s=a(t,r,i);return{result:s[0]%s[1]}}},PI:{type:"S",call:function(e,t,n){return{result:Math.PI}}},TRUNCATE:{type:"S",call:function(e,t,n,r,i){var s=a(t,r,i),o=s[0],u=s[1];return{result:parseFloat(o.toFixed(u))}}},LOWER:{type:"S",call:function(e,t,n,i){return{result:String(r.getFnValue(t,i)).toLowerCase()}}},TRIM:{type:"S",call:function(e,t,n,i){return{result:String(r.getFnValue(t,i)).trim()}}},UPPER:{type:"S",call:function(e,t,n,i){return{result:String(r.getFnValue(t,i)).toUpperCase()}}},CAST:{type:"S",call:function(e,t,n,i,s){return{result:r.cast(e.databaseID,r.getFnValue(t,s),r.getFnValue(t,i),!1,e.parent)}}},CONCAT:{type:"S",call:function(e,t,n){for(var i=[],s=3;s<arguments.length;s++)i[s-3]=arguments[s];return{result:i.map(function(e){return r.getFnValue(t,e)}).join("")}}},CONCAT_WS:{type:"S",call:function(e,t,n,i){for(var s=[],a=4;a<arguments.length;a++)s[a-4]=arguments[a];return{result:s.map(function(e){return r.getFnValue(t,e)}).join(r.getFnValue(t,i))}}},REPLACE:{type:"S",call:function(e,t,n,i,s,a){var o=String(r.getFnValue(t,i)),u=String(r.getFnValue(t,s)),c=String(r.getFnValue(t,a));return{result:o.replace(u,c)}}},STRCMP:{type:"S",call:function(e,t,n,i,s){var a=String(r.getFnValue(t,i)),o=String(r.getFnValue(t,s));return a<o?{result:-1}:a>o?{result:1}:{result:0}}},LEVENSHTEIN:{type:"S",call:function(e,t,n,a,o){var u=r.getFnValue(t,a),c=r.getFnValue(t,o),l=u+"::"+c;return s[l]||(s[l]=i(u,c)),{result:s[l]}}},IF:{type:"S",call:function(e,t,n,i,s,a){var o=i.split(/<|=|>|<=|>=/gim).map(function(e){return isNaN(e)?r.getFnValue(t,e):parseFloat(e)}),u=i.match(/<|=|>|<=|>=/gim)[0];if(!u)return{result:r.getFnValue(t,a)};switch(u){case"=":return o[0]==o[1]?r.getFnValue(t,s):r.getFnValue(t,a);case">":return o[0]>o[1]?r.getFnValue(t,s):r.getFnValue(t,a);case"<":return o[0]<o[1]?r.getFnValue(t,s):r.getFnValue(t,a);case"<=":return o[0]<=o[1]?r.getFnValue(t,s):r.getFnValue(t,a);case">=":return o[0]<o[1]?r.getFnValue(t,s):r.getFnValue(t,a);default:return{result:r.getFnValue(t,a)}}}},CROW:{type:"S",call:function(t,n,i,s,a,o){var u=r.getFnValue(n,s+".lat"),c=r.getFnValue(n,s+".lon");return{result:r.crowDistance(u,c,parseFloat(a),parseFloat(o),e.planetRadius)}},checkIndex:function(t,n,i){if("<"===i[1]||"<="===i[1]){var s="string"==typeof t.table?e.getDB(t.databaseID)._tables[t.table].indexes:{},a=r.resolvePath(n[0]),o=[];if(Object.keys(s).forEach(function(e){var t=s[e];"float"===t.type&&r.objectsEqual(t.path.slice(0,t.path.length-1),a)&&o.push(e.replace(".lat","").replace(".lon",""))}),2===o.length)return{index:o[0],parsedFn:{name:"CROW",args:n},comp:i[1],value:i[2]}}return!1},queryIndex:function(t,n,i,s,a,o){var u=t.table,c=n.index+".lat",l=n.index+".lon",d=n.comp,f=parseFloat(n.value||"0"),h=parseFloat(n.parsedFn?n.parsedFn.args[1]:"0"),p=parseFloat(n.parsedFn?n.parsedFn.args[2]:"0"),y=f/(2*e.planetRadius*Math.PI)*360,g=[-1,1].map(function(e){return h+y*e}),b=[],_=[],v=!1,m=Math.max(90-y,0);if(Math.abs(g[0])>m||Math.abs(g[1])>m)v=!0,g[0]<-1*m&&(g=[-90,g[1]]),g[1]>m&&(g=[g[0],90]);else{var D=Math.max(Math.abs(g[0]),Math.abs(g[1]));if(b=[-1,1].map(function(e){return p+y*e/Math.cos(r.deg2rad(D))}),Math.abs(b[0])>180){var I=Math.abs(b[0])-180;_=[180-I,180]}if(Math.abs(b[1])>180){I=Math.abs(b[1])-180;_=[-180,-180+I]}}var w={};r.allAsync([c,l,l],function(n,i,s,a){var o=[g,b,_][i];o.length?r.adapterFilters(t.databaseID,e,t).readIndexKeys(u,n,"range",o[0],o[1],!1,function(e,t){w[e]?w[e].num++:w[e]={key:e,lat:0,lon:0,num:0},0===i?w[e].lat=t-90:w[e].lon=t-180},function(){s(null)},a):s(null)}).then(function(){var u=0,c=(v?Object.keys(w):Object.keys(w).filter(function(t){if(w[t].num<1)return!1;var n=r.crowDistance(w[t].lat,w[t].lon,h,p,e.planetRadius);return"<"===d?n<f:n<=f})).map(function(e){return w[e]});v||!i?r.allAsync(c,function(a,o,c,l){r.adapterFilters(t.databaseID,t.parent,t).read(t.table,a.key,function(a){if(a){if(!v)return s(a,o),void c(null);var l=r.deepGet((n.parsedFn?n.parsedFn.args[0]:"")+".lat",a),y=r.deepGet((n.parsedFn?n.parsedFn.args[0]:"")+".lon",a),g=r.crowDistance(l,y,h,p,e.planetRadius);("<"===d?g<f:g<=f)&&(s(i?r.deepGet(e.getDB(t.databaseID)._tables[t.table].pkCol,a):a,u),u++),c(null)}else c(null)},l)}).catch(o).then(function(){a()}):c.forEach(function(e,t){s(e.key,t)})}).catch(o)}}},(Object.getOwnPropertyNames?Object.getOwnPropertyNames(Math):["abs","acos","asin","atan","atan2","ceil","cos","exp","floor","log","pow","random","round","sin","sqrt","tan"]).filter(function(e){return-1===["min","max"].indexOf(e)}).forEach(function(t){e.functions[t.toUpperCase()]={type:"S",call:function(e,n,r){for(var i=[],s=3;s<arguments.length;s++)i[s-3]=arguments[s];return{result:Math[t].apply(null,a.apply(void 0,[n].concat(i)))}}}})}},function(e,t,n){var r=this&&this.__assign||function(){return(r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),s=n(0),a=n(8);t.secondaryIndexQueue={};var o={},u=function(){function e(e,t,n,r,i,s){var a=this;this.databaseID=e,this.nSQL=t,this.query=n,this.progress=r,this.complete=i,this.error=s,this._queryBuffer=[],this._stream=!0,this._selectArgs=[],this._pkOrderBy=!1,this._idxOrderBy=!1,this._sortGroups=[],this._sortGroupKeys={},this.query.state="processing",this._indexesUsed=[],this._startTime=Date.now();var o=n.action.toLowerCase().trim();if(this._orderByRows=this._orderByRows.bind(this),this._onError=this._onError.bind(this),-1===["select","clone","create table","create table if not exists"].indexOf(o)&&"string"!=typeof n.table)return this.query.state="error",void this.error('Only "select" and "clone" queries are available for this resource!');if(!("string"!=typeof n.table||this.databaseID&&this.nSQL.getDB(this.databaseID).state.connected))return this.query.state="error",void this.error("Can't execute query before the database has connected!");var u=function(e,t){return"string"==typeof a.query.table&&a.query.table?e&&!a.query.actionArgs?(a.query.state="error",void a.error(a.query.action+" query requires an additional argument!")):void t():(a.query.state="error",void a.error(a.query.action+" query requires a table argument!"))},c=function(){"error"!==a.query.state&&(a.query.state="complete",a.complete())};switch(this.query.cacheID||(this.query.cacheID=this.query.queryID),o){case"select":this._select(c,this.error);break;case"upsert":u(!0,function(){a._upsert(a.progress,a.complete,a.error)});break;case"delete":u(!1,function(){a._delete(a.progress,a.complete,a.error)});break;case"show tables":this._showTables();break;case"describe":this._describe();break;case"describe indexes":this._describe("idx");break;case"drop":case"drop table":this._dropTable(this.query.table,c,this.error);break;case"create table":case"create table if not exists":this._createTable(this.query.actionArgs,!1,r,c,this.error);break;case"alter table":u(!0,function(){a._createTable(a.query.actionArgs,!0,r,c,a.error)});break;case"rebuild indexes":u(!1,function(){a._rebuildIndexes(a.progress,c,a.error)});break;case"conform rows":u(!1,function(){a._conform(a.progress,c,a.error)});break;case"clone":u(!0,function(){a._clone(a.progress,c,a.error)});break;default:this.nSQL.doFilter(this.databaseID,"customQuery",{res:void 0,query:this.query,onRow:r,complete:i,error:s},function(){a.query.state="error",a.error('Query type "'+n.action+'" not supported!')},function(e){a.query.state="error",a.error(e)})}}return e.prototype._clone=function(e,t,n){var i=this,o=this.query.actionArgs&&this.query.actionArgs.mode,u=this.query.actionArgs&&this.query.actionArgs.getAdapter,c=this.query.actionArgs&&this.query.actionArgs.id||this.query.parent.getDB(this.databaseID).state.id;if(c&&o){var l=a.resolveMode(o),d="*"!==this.query.table?[this.query.table]:Object.keys(this.nSQL.getDB(this.databaseID)._tables),f={};l.connect(c,function(){s.chainAsync(d,function(t,r,a,o){var u=i.query.parent.getDB(i.databaseID)._tables[t];u?l.createTable(i.query.parent.getDB(i.databaseID)._tableIds[u.name],u,function(){f[u.name]=i.query.parent.getDB(i.databaseID)._tableIds[u.name],s.allAsync(Object.keys(u.indexes),function(e,t,n,r){var s=u.indexes[e];l.createIndex(i.query.parent.getDB(i.databaseID)._tableIds[u.name],e,s.type,n,r)}).then(function(){var t=new s._nanoSQLQueue(function(t,n,r,a){e({target:u.name,targetId:i.query.parent.getDB(i.databaseID)._tableIds[u.name],object:t},n),n++,l.write(i.query.parent.getDB(i.databaseID)._tableIds[u.name],s.deepGet(u.pkCol,t),t,r,a)},n,function(){s.chainAsync(Object.keys(u.indexes),function(t,n,r,a){u.indexes[t];s.adapterFilters(i.databaseID,i.query.parent,i.query).readIndexKeys(u.name,t,"all",void 0,void 0,!1,function(r,o){e({target:i.query.parent.getDB(i.databaseID)._tableIds[u.name]+"."+t,targetId:u.name+"."+t,object:{key:o,rowId:r}},n),n++,l.addIndexValue(i.query.parent.getDB(i.databaseID)._tableIds[u.name],t,r,o,s.noop,a)},r,a)}).then(function(){a()}).catch(n)});s.adapterFilters(i.databaseID,i.query.parent,i.query).readMulti(u.name,"all",void 0,void 0,!1,function(e,n){t.newItem(e)},function(){t.finished()},n)}).catch(n)},n):o("Table "+u+" not found!")}).then(function(){l.createTable("_util",r({},s.blankTableDefinition,{name:"_util",model:{"key:string":{pk:!0},"value:any":{}}}),function(){l.read("_util","tableIds",function(e){var i=r({},e&&e.value||{},f);l.write("_util","taleIds",{key:"tableIds",value:i},function(){u?(u(l),t()):l.disconnect(function(){t()},n)},n)},n)},n)}).catch(n)},n)}else n("Id & Mode required for clone query!")},e.prototype._conform=function(e,t,n){var r=this,i=this.query.table,a=this.query.actionArgs||function(e){return e};if(this.databaseID&&this.nSQL.getDB(this.databaseID)._tables[i]){var o=new s._nanoSQLQueue(function(t,a,o,u){var c=r.nSQL.default(r.databaseID||"",t,i);r.nSQL.doFilter(r.databaseID,"conformRow",{res:c,oldRow:t,query:r.query},function(n){r._diffUpdates(r.query.table,t,n.res,function(){var u={target:i,path:"*",events:["upsert","change","*"],time:Date.now(),performance:Date.now()-r._startTime,result:n.res,oldRow:t,query:r.query,indexes:r._indexesUsed};r.nSQL.getDB(r.databaseID).state.hasAnyEvents&&(r.nSQL.triggerEvent(r.databaseID||"",u),Object.keys(r.nSQL.getDB(r.databaseID).eventFNs[r.query.table]).forEach(function(e){"*"!==e&&(s.objectsEqual(s.deepGet(e,t),s.deepGet(e,n.res))||r.nSQL.triggerEvent(r.databaseID||"",{target:r.query.table,path:e,events:["upsert","change","*"],time:Date.now(),performance:Date.now()-r._startTime,result:n.res,oldRow:t,query:r.query,indexes:r._indexesUsed},!0))})),r._startTime=Date.now(),e(r.query.returnEvent?u:n.res,a),0,o()},u)},n)},n,function(){t()});this._getRecords(function(e,t){o.newItem(a(e))},function(){o.finished()},n)}else n(new Error("Table "+i+" not found for conforming!"))},e.prototype._getTable=function(e,t,n,r){var i=this,s=this.query.cacheID;if("function"==typeof n){if(o[s]||(o[s]={}),!o[s][e])return o[s][e]={loading:!0,rows:[],cache:!0},void n(t).then(function(t){var n=t.cache&&!t.filtered||!1;o[s][e]={loading:!1,rows:n?t.rows:[],cache:n},r(t)}).catch(this._onError);if(o[s][e].loading)return void setTimeout(function(){i._getTable(e,t,n,r)},10);if(o[s][e].cache)return void r({filtered:!1,rows:o[s][e].rows,cache:!0});n(t).then(function(e){r(e)}).catch(this._onError)}else r({rows:n,filtered:!1,cache:!1})},e.prototype._maybeJoin=function(e,t,n,i){var a,o=this;if(!e[0])return n(t),void i();var u=function(t,i,a){var c=e[i],l=0,d=[];if("cross"!==c.type&&!c.on)return o.query.state="error",void o.error(new Error("Non 'cross' joins require an 'on' parameter!"));var f=new Error("Must use 'AS' when joining temporary tables!");if("string"!=typeof c.with.table&&!c.with.as)return o.query.state="error",void o.error(f);if("string"!=typeof o.query.table&&!o.query.tableAS)return o.query.state="error",void o.error(f);var h=new s._nanoSQLQueue(function(t,r,s,a){e[i+1]?u(t,i+1,s):(n(t),s())},o.error,a),p="string"==typeof c.with.table?o.nSQL.getDB(o.databaseID)._tables[c.with.table].pkCol:[],y=String(c.with.as||c.with.table),g=String(o.query.tableAS||o.query.table);o.nSQL.triggerQuery(o.databaseID,r({},s.buildQuery(o.databaseID,o.nSQL,c.with.table,"select"),{tableAS:c.with.as,cacheID:o.query.cacheID,where:c.on&&"cross"!==c.type?o._buildCombineWhereJoin(c.on,c.with.as||c.with.table,t):void 0,skipQueue:!0}),function(e){var n;l++,"right"!==c.type&&"outer"!==c.type||d.push(p?s.deepGet(p,e):s.hash(JSON.stringify(e))),h.newItem(r({},t,((n={})[y]=e,n)))},function(){var e,n;switch(c.type){case"left":0===l&&h.newItem(r({},t,((e={})[y]=void 0,e))),h.finished();break;case"inner":case"cross":h.finished();break;case"outer":case"right":0===l&&"outer"===c.type&&h.newItem(r({},t,((n={})[y]=void 0,n))),o.nSQL.triggerQuery(o.databaseID,r({},s.buildQuery(o.databaseID,o.nSQL,c.with.table,"select"),{skipQueue:!0,cacheID:o.query.cacheID,where:p?[p,"NOT IN",d]:void 0}),function(e){var n;(p||-1===d.indexOf(s.hash(JSON.stringify(e))))&&h.newItem(r({},t,((n={})[g]=void 0,n[y]=e,n)))},function(){h.finished()},function(e){o.query.state="error",o.error(e)})}},function(e){o.query.state="error",o.error(e)})};u(((a={})[String(this.query.tableAS||this.query.table)]=t,a),0,i)},e.prototype._select=function(e,t){var n=this;if(this._whereArgs=this.query.where?this._parseWhere(this.query.where,"string"!=typeof this.query.table||void 0!==this.query.union):{type:i.IWhereType.none},this._havingArgs=this.query.having?this._parseWhere(this.query.having,!0):{type:i.IWhereType.none},this._parseSelect(),"error"!==this.query.state){var r=[this.query.offset||0,(this.query.offset||0)+(this.query.limit||0)],a=r[0]+r[1]>0,u={},c=function(e){return(n.query.distinct||[]).reduce(function(t,n){return t+JSON.stringify(s.deepGet(n,e)||{})},"")};if(this.query.union){var l=[],d=[],f=0;s.chainAsync(this.query.union.queries,function(e,t,i){e().then(function(e){d.length||(d=Object.keys(e[0])),n.query.where&&(e=e.filter(function(e,t){return n._where(e,n._whereArgs.slowWhere)})),e=e.map(function(e){if(n.query.union&&"distinct"===n.query.union.type){var r=s.hash(JSON.stringify(e));if(0===t)l.push(r);else{if(-1!==l.indexOf(r))return;l.push(r)}}return Object.keys(e).reduce(function(t,n,r){return r<d.length&&(t[d[r]]=e[n]),t},{})}).filter(function(e){return e}),n.query.orderBy?n._queryBuffer=n._queryBuffer.concat(e.map(function(e){var t=!0;if(n.query.distinct){var r=c(e);u[r]?t=!1:u[r]=!0}var i=n._streamAS(e);return(!n.query.having||n._where(i,n._havingArgs.slowWhere))&&t?i:void 0}).filter(function(e){return e})):e.forEach(function(e,t){var i=!0;if(n.query.distinct){var s=c(e);u[s]?i=!1:u[s]=!0}if(i){var o=n._streamAS(e);(!n.query.having||n._where(o,n._havingArgs.slowWhere))&&(a?f>=r[0]&&f<r[1]&&n.progress(o,f):n.progress(o,f),f++)}}),i()})}).then(function(){if(n.query.orderBy){var t=n._orderBy.sort.length>1?n.quickSort(n._queryBuffer,n._orderBy):n._queryBuffer.sort(n._orderByRows);(a?t.slice(r[0],r[1]):t).forEach(n.progress)}n.query.cacheID&&n.query.cacheID===n.query.queryID&&delete o[n.query.cacheID],e()})}else{var h=Array.isArray(this.query.join)?this.query.join:[this.query.join],p=0,y=new s._nanoSQLQueue(function(e,t,r,i){if(n.query.graph)n._graph(n.query.graph||[],n.query.tableAS||n.query.table,e,g,function(t,i){var s=!0;if(n.query.distinct){var a=c(t);u[a]?s=!1:u[a]=!0}if(!s)return p++,void r();var o=n._streamAS(t);n.query.having?n._where(n._streamAS(e),n._havingArgs.slowWhere)&&n.progress(o,p):n.progress(o,p),p++,r()});else{var s=!0;if(n.query.distinct){var a=c(e);u[a]?s=!1:u[a]=!0}if(!s)return p++,void r();n.progress(n._streamAS(e),p),p++,r()}},this._onError,function(){n.query.cacheID&&n.query.cacheID===n.query.queryID&&delete o[n.query.cacheID],e()}),g=0,b=new s._nanoSQLQueue(function(e,t,i,s){n._maybeJoin(h,e,function(e){n._stream?((!a||g>=r[0]&&g<r[1])&&y.newItem(e),g++):n._queryBuffer.push(e)},i)},this.error,function(){n._stream?y.finished():s.allAsync(n._queryBuffer,function(e,t,r){n._graph(n.query.graph||[],n.query.tableAS||n.query.table,e,t,r)}).then(function(t){n._queryBuffer=t,n._groupByRows(),n.query.having&&(n._queryBuffer=n._queryBuffer.filter(function(e){return n._where(e,n._havingArgs.slowWhere)})),n.query.orderBy&&!n._hasOrdered&&(n._orderBy.sort.length>1?n._queryBuffer=n.quickSort(n._queryBuffer,n._orderBy):n._queryBuffer.sort(n._orderByRows)),a&&(n._queryBuffer=n._queryBuffer.slice(r[0],r[1])),n._queryBuffer.forEach(function(e,t){var r=!0;if(n.query.distinct){var i=c(e);u[i]?r=!1:u[i]=!0}r&&n.progress(e,t)}),n.query.cacheID&&n.query.cacheID===n.query.queryID&&delete o[n.query.cacheID],e()})}),_="string"==typeof this.query.table;this._getRecords(function(e,t){var r={target:n.query.table,path:"_all_",events:["select","*"],time:Date.now(),performance:Date.now()-n._startTime,result:e,query:n.query,indexes:n._indexesUsed};_&&n.nSQL.triggerEvent(n.databaseID,r),n._startTime=Date.now(),n.query.returnEvent?n.progress(r,t):b.newItem(e)},function(){n.query.returnEvent?e():b.finished()},t)}}},e.prototype._groupByRows=function(){var e=this;if(this.query.groupBy||this._hasAggrFn)if((this._groupBy?this._queryBuffer.sort(function(t,n){return e._sortObj(t,n,e._groupBy)}):this._queryBuffer).forEach(function(t,n){var r=e._groupBy.sort.map(function(n){return String(n.fn?s.execFunction(e.query,n.fn,t,{result:void 0}).result:s.deepGet(n.path,t))}).join(".");void 0===e._sortGroupKeys[r]&&(e._sortGroupKeys[r]=e._sortGroups.length);var i=e._sortGroupKeys[r];e._sortGroups[i]||e._sortGroups.push([]),e._sortGroups[i].push(t)}),this.query.orderBy&&(this._hasOrdered=!0,this._sortGroups=this._sortGroups.map(function(t){return t.sort(function(t,n){return e._sortObj(t,n,e._orderBy)})})),this._queryBuffer=[],this._hasAggrFn){var t=function(){return e._selectArgs.reduce(function(t,n,r){var i=n.value.split("(").shift();return n.isFn&&e.nSQL.functions[i]&&"A"===e.nSQL.functions[i].type&&(t[r]={idx:r,name:n.value,aggr:s.assign(e.nSQL.functions[i].aggregateStart)}),t},[])};if(this._sortGroups.forEach(function(n){var r=t(),i=r.filter(function(e){return e})[0];n.reverse().forEach(function(t,n){r.forEach(function(n,i){n&&(r[i].aggr=s.execFunction(e.query,r[i].name,t,r[i].aggr))})}),e._queryBuffer.push(e._selectArgs.reduce(function(t,n,a){var o=n.value;return t[n.as||o]=n.isFn&&r[a]?r[a].aggr.result:n.isFn?s.execFunction(e.query,n.value,r[i.idx].aggr.row,{result:void 0}).result:s.deepGet(n.value,r[i.idx].aggr.row)||null,t},{}))}),!this._queryBuffer.length){var n=t(),r=n.filter(function(e){return e})[0];this._queryBuffer.push(this._selectArgs.reduce(function(t,i,a){var o=i.value;return t[i.as||o]=i.isFn&&n[a]?n[a].aggr.result:i.isFn?s.execFunction(e.query,i.value,n[r.idx].aggr.row,{result:void 0}).result:s.deepGet(i.value,n[r.idx].aggr.row)||null,t},{}))}}else this._sortGroups.forEach(function(t){e._queryBuffer.push(e._streamAS(t.shift()))});else this._queryBuffer=this._queryBuffer.map(function(t){return e._streamAS(t)})},e.prototype._buildCombineWhereJoin=function(e,t,n){var r=this;return"function"==typeof e?function(t){return e(t,n)}:("string"==typeof e[0]?[e]:e).map(function(e){if(Array.isArray(e[0]))return r._buildCombineWhereJoin(e,t,n);if("AND"===e||"OR"===e)return e;var i=s.resolvePath(e[0]),a=s.resolvePath(e[2]),o=i[0]!==t;return[o?a.slice(1).join("."):i.slice(1).join("."),o?-1!==e[1].indexOf(">")?e[1].replace(">","<"):e[1].replace("<",">"):e[1],s.deepGet(o?i:a,n)]})},e.prototype._graph=function(e,t,n,i,a){var o=this,u=Array.isArray(e)?e:[e];u&&0!==u.length?s.allAsync(u,function(e,i,a){var u,c=new Error("Must use 'AS' when graphing temporary tables!");if("string"!=typeof e.with.table&&!e.with.as)return o.query.state="error",void o.error(c);if("string"!=typeof o.query.table&&!o.query.tableAS)return o.query.state="error",void o.error(c);n[e.key]=[];var l=o._buildCombineWhereJoin(e.on,e.with.as||e.with.table,((u={})[t]=n,u));o._getTable(e.with.as||e.with.table,l,e.with.table,function(t){t.filtered?(t.rows.forEach(function(t){e.single?n[e.key]=t:n[e.key].push(t)}),a(null)):o.nSQL.triggerQuery(o.databaseID,r({},s.buildQuery(o.databaseID,o.nSQL,t.rows,"select"),{tableAS:e.with.as,actionArgs:e.select,where:l,limit:e.limit,offset:e.offset,orderBy:e.orderBy,groupBy:e.groupBy,graph:e.graph,skipQueue:!0,cacheID:o.query.cacheID}),function(t){e.single?n[e.key]=t:n[e.key].push(t)},function(){a(null)},o._onError)})}).then(function(){a(n,i)}):a(n,i)},e.prototype._upsert=function(e,t,n){var r=this;if(this.query.actionArgs||(n("Can't upsert without records!"),this.query.state="error"),-1!==this.query.table.indexOf(".")||-1!==this.query.table.indexOf("[")){var a=s.resolvePath(this.query.table);this.query.table=a.shift(),this.upsertPath=a}if(this._whereArgs=this.query.where?this._parseWhere(this.query.where):{type:i.IWhereType.none},"error"!==this.query.state){var o=Array.isArray(this.query.actionArgs)?this.query.actionArgs:[this.query.actionArgs],u=this.nSQL.getDB(this.databaseID)._tables[this.query.table];if(this._whereArgs.type===i.IWhereType.none)s.allAsync(o,function(t,n,i,a){var o=s.deepGet(u.pkCol,t);o?s.adapterFilters(r.databaseID,r.nSQL,r.query).read(r.query.table,o,function(s){s?r._updateRow(t,s,function(t){e(t,n),i(null)},a):r._newRow(t,function(t){e(t,n),i(null)},a)},a):r._newRow(t,function(t){e(t,n),i(null)},a)}).then(function(){t()}).catch(this._onError);else{if(o.length>1)return this.query.state="error",void n("Cannot upsert multiple records with where condition!");var c=new s._nanoSQLQueue(function(t,n,i,s){0,r._updateRow(o[0],t,function(t){e(t,n),i()},s)},n,function(){t()});this._getRecords(function(e,t){c.newItem(e)},function(){c.finished()},n)}}},e.prototype._updateRow=function(e,t,n,i){var a=this;this.nSQL.doFilter(this.databaseID,"updateRow",{res:e,row:t,query:this.query},function(e){var o=a.nSQL.default(a.databaseID,a.upsertPath?s.deepSet(a.upsertPath,s.maybeAssign(t),e.res):r({},t,e.res),a.query.table);a._diffUpdates(a.query.table,t,o,function(){var e={target:a.query.table,path:"*",events:["upsert","change","*"],time:Date.now(),performance:Date.now()-a._startTime,result:o,oldRow:t,query:a.query,indexes:a._indexesUsed};a.nSQL.doFilter(a.databaseID,"updateRowEvent",{res:e,query:a.query},function(e){"string"==typeof a.query.table&&(a.nSQL.triggerEvent(a.databaseID,e.res),a.nSQL.getDB(a.databaseID).eventFNs[a.query.table]&&Object.keys(a.nSQL.getDB(a.databaseID).eventFNs[a.query.table]).forEach(function(e){"*"!==e&&(s.objectsEqual(s.deepGet(e,t),s.deepGet(e,o))||a.nSQL.triggerEvent(a.databaseID,{target:a.query.table,path:e,events:["upsert","change","*"],time:Date.now(),performance:Date.now()-a._startTime,result:o,oldRow:t,query:a.query,indexes:a._indexesUsed},!0))}),a._startTime=Date.now()),n(a.query.returnEvent?e.res:o)},i)},i)},i)},e.prototype._checkUniqueIndexes=function(e,t,n,r,i,a){var o=this;s.allAsync(Object.keys(r),function(i,a,u,c){var l=o.nSQL.getDB(o.databaseID)._tables[o.query.table].indexes[i].props||{};if(l&&l.unique){var d=[];s.adapterFilters(o.databaseID,o.nSQL,o.query).readIndexKey(e,i,r[i],function(e){e!==t&&d.push(e)},function(){d.length>0?c({error:"Unique Index Collision!",row:n,query:o.query}):u(null)},c)}else u(null)}).then(i).catch(a)},e.prototype._diffUpdates=function(e,t,n,r,i){var a=this,o=this._getIndexValues(this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes,n),u=this._getIndexValues(this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes,t),c=this.nSQL.getDB(this.databaseID)._tables[e];this._checkUniqueIndexes(e,s.deepGet(c.pkCol,t),t,o,function(){s.allAsync(Object.keys(u).concat(["__pk__"]),function(t,r,i,l){if("__pk__"===t)s.adapterFilters(a.databaseID,a.nSQL,a.query).write(e,s.deepGet(c.pkCol,n),n,function(e){s.deepSet(c.pkCol,n,e),i(null)},l);else{var d=a.query.table;if(!1===s.objectsEqual(o[t],u[t]))if(c.indexes[t].isArray){var f=o[t].filter(function(e,n,r){return-1===u[t].indexOf(e)}),h=u[t].filter(function(e,n,r){return-1===o[t].indexOf(e)});s.allAsync([f,h],function(e,r,i){e.length?s.allAsync(e,function(e,i,o){a._updateIndex(d,t,e,s.deepGet(c.pkCol,n),0===r,function(){o(null)},l)}).then(i):i(null)}).then(i)}else s.chainAsync(["rm","add"],function(e,r,i){switch(e){case"add":a._updateIndex(d,t,o[t],s.deepGet(c.pkCol,n),!0,function(){i(null)},l);break;case"rm":a._updateIndex(d,t,u[t],s.deepGet(c.pkCol,n),!1,function(){i(null)},l)}}).then(i);else i(null)}}).then(r).catch(i)},i)},e.prototype._updateIndex=function(e,n,r,i,a,o,u){var c=this,l={table:e,indexName:n,value:r,pk:i,addToIndex:a,done:o,err:u,query:this.query,nSQL:this.nSQL};this.nSQL.doFilter(this.databaseID,"updateIndex",{res:l,query:this.query},function(e){t.secondaryIndexQueue[c.nSQL.getDB(c.databaseID).state.id+e.res.indexName].newItem(e.res,function(e,t,n){(e.addToIndex?s.adapterFilters(c.databaseID,e.nSQL,e.query).addIndexValue:s.adapterFilters(c.databaseID,e.nSQL,e.query).deleteIndexValue)(e.table,e.indexName,e.pk,e.value,function(){e.done(),t()},function(n){e.err(n),t()})})},u)},e.prototype._newRow=function(e,t,n){var r=this;this.nSQL.doFilter(this.databaseID,"addRow",{res:e,query:this.query},function(e){var i=r.nSQL.getDB(r.databaseID)._tables[r.query.table];e.res=r.nSQL.default(r.databaseID,s.maybeAssign(r.upsertPath?s.deepSet(r.upsertPath,{},e.res):e.res),r.query.table);var a=s.deepGet(i.pkCol,e.res),o=r._getIndexValues(r.nSQL.getDB(r.databaseID)._tables[r.query.table].indexes,e.res);r._checkUniqueIndexes(r.query.table,a,e.res,o,function(){s.adapterFilters(r.databaseID,r.nSQL,r.query).write(r.query.table,a,e.res,function(u){s.deepSet(i.pkCol,e.res,u),s.allAsync(Object.keys(o),function(e,t,n,u){if(i.indexes[e].isArray){var c=o[e]||[];s.allAsync(c,function(t,n,i){r._updateIndex(r.query.table,e,t,a,!0,function(){i(null)},u)}).then(function(){n(null)}).catch(u)}else r._updateIndex(r.query.table,e,o[e],a,!0,function(){n(null)},u)}).then(function(){var i={target:r.query.table,path:"*",events:["upsert","change","*"],time:Date.now(),performance:Date.now()-r._startTime,result:e.res,oldRow:void 0,query:r.query,indexes:r._indexesUsed};r.nSQL.doFilter(r.databaseID,"addRowEvent",{res:i,query:r.query},function(n){"string"==typeof r.query.table&&r.nSQL.triggerEvent(r.databaseID,n.res),r._startTime=Date.now(),t(r.query.returnEvent?n.res:e.res)},n)})},n)},n)},n)},e.prototype._delete=function(e,t,n){var a=this;if(this._whereArgs=this.query.where?this._parseWhere(this.query.where):{type:i.IWhereType.none},"error"!==this.query.state){var o=this.nSQL.getDB(this.databaseID)._tables[this.query.table],u=new s._nanoSQLQueue(function(t,n,u,c){new Promise(function(e,n){var o=a.query.table;a.nSQL.getDB(a.databaseID)._fkRels[o]&&a.nSQL.getDB(a.databaseID)._fkRels[o].length?s.allAsync(a.nSQL.getDB(a.databaseID)._fkRels[o],function(e,n,o,u){var c=s.deepGet(e.selfPath,t),l=s.cast(a.databaseID,"any[]",e.selfIsArray?c:[c]);s.allAsync(l,function(t,n,c,l){switch(e.onDelete){case i.InanoSQLFKActions.RESTRICT:var d=0;s.adapterFilters(a.databaseID,a.nSQL,a.query).readIndexKey(e.childTable,e.childIndex,t,function(e){d++},function(){d>0?l("Foreign key restraint error, can't delete!"):c()},u);break;case i.InanoSQLFKActions.CASCADE:var f=[];s.adapterFilters(a.databaseID,a.nSQL,a.query).readIndexKey(e.childTable,e.childIndex,t,function(e){f.push(e)},function(){a.nSQL.triggerQuery(a.databaseID,r({},s.buildQuery(a.databaseID,a.nSQL,e.childTable,"delete"),{where:[e.childPath.join("."),e.childIsArray?"INCLUDES":"IN",f]}),s.noop,c,l)},u);break;case i.InanoSQLFKActions.SET_NULL:var h=[];s.adapterFilters(a.databaseID,a.nSQL,a.query).readIndexKey(e.childTable,e.childIndex,t,function(e){h.push(e)},function(){var t;a.nSQL.triggerQuery(a.databaseID,r({},s.buildQuery(a.databaseID,a.nSQL,e.childTable,"upsert"),{actionArgs:(t={},t[e.childPath.join(".")]=null,t),where:[e.childPath.join("."),e.childIsArray?"INCLUDES":"IN",f]}),s.noop,c,l)},u);break;default:o()}}).then(o).catch(u)}).then(e).catch(n):e()}).then(function(){a._removeRowAndIndexes(o,t,function(t){e(t,n),u()},c)}).catch(c)},n,function(){t()});this._getRecords(function(e,t){u.newItem(e)},function(){u.finished()},n)}},e.prototype._removeRowAndIndexes=function(e,t,n,r){var i=this,a=this._getIndexValues(e.indexes,t);this.nSQL.doFilter(this.databaseID,"deleteRow",{res:t,query:this.query},function(t){s.allAsync(Object.keys(a).concat(["__del__"]),function(n,o,u){if("__del__"===n)s.adapterFilters(i.databaseID,i.nSQL,i.query).delete(i.query.table,s.deepGet(e.pkCol,t.res),function(){u(null)},function(e){i.query.state="error",r(e)});else if(e.indexes[n].isArray){var c=a[n]||[];s.allAsync(c,function(a,o,u){i._updateIndex(i.query.table,n,a,s.deepGet(e.pkCol,t.res),!1,function(){u(null)},r)}).then(u)}else i._updateIndex(i.query.table,n,a[n],s.deepGet(e.pkCol,t.res),!1,function(){u(null)},i._onError)}).then(function(){var e={target:i.query.table,path:"_all_",events:["change","delete","*"],time:Date.now(),performance:Date.now()-i._startTime,result:t.res,query:i.query,indexes:i._indexesUsed};i.nSQL.doFilter(i.databaseID,"deleteRowEvent",{res:e,query:i.query},function(e){"string"==typeof i.query.table&&i.nSQL.triggerEvent(i.databaseID,e.res),i._startTime=Date.now(),n(i.query.returnEvent?e.res:t.res)},r)}).catch(r)},r)},e.prototype._getIndexValues=function(e,t){var n=this;return Object.keys(e).reduce(function(r,i){var a=s.deepGet(e[i].path,t),o=e[i].isDate?"string":e[i].type;return r[i]=e[i].isArray?(Array.isArray(a)?a:[]).map(function(e){return n.nSQL.indexTypes[o](e)}):n.nSQL.indexTypes[o](a),r},{})},e.prototype._showTables=function(){var e=this;Object.keys(this.nSQL.getDB(this.databaseID)._tables).forEach(function(t,n){e.progress({table:t,id:e.nSQL.getDB(e.databaseID)._tableIds[t]},n)}),this.complete()},e.prototype._describe=function(e){var t=this;if(void 0===e&&(e="table"),"string"!=typeof this.query.table)return this.query.state="error",void this.error({error:"Can't call describe on that!",query:this.query});if(!this.nSQL.getDB(this.databaseID)._tables[this.query.table])return this.query.state="error",void this.error({error:"Table "+this.query.table+" not found!",query:this.query});switch(e){case"table":this.nSQL.getDB(this.databaseID)._tables[this.query.table].columns.forEach(function(e,n){t.progress(s.assign(e),n)});break;case"idx":Object.keys(this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes).forEach(function(e,n){var r=t.nSQL.getDB(t.databaseID)._tables[t.query.table].indexes[e];t.progress(s.assign(r),n)})}this.complete()},e.prototype._combineRows=function(e){return Object.keys(e).reduce(function(t,n){var r=e[n];return r?(Object.keys(r).forEach(function(e){t[n+"."+e]=r[e]}),t):t},{})},e.prototype._streamAS=function(e){var t=this,n=(this.query.distinct||[]).map(function(e){return{isFn:!1,value:e}}),r=(this._selectArgs||[]).concat(n);if(r.length){var i={};return r.forEach(function(n){n.isFn?i[n.as||n.value]=s.execFunction(t.query,n.value,e,{}).result:i[n.as||n.value]=s.deepGet(n.value,e)}),this.query.join?this._combineRows(i):i}return this.query.join?this._combineRows(e):e},e.prototype.quickSort=function(e,t){var n=this;if(e.length<2)return e;for(var r=function(e){return t.sort.reduce(function(t,r,i){var a=r.fn?s.execFunction(n.query,r.fn,e,{result:void 0}).result:s.deepGet(r.path,e);return t.push({v:a,d:String(r.dir).toUpperCase()}),t},[])},i=function(e,t){for(var n=0,r=0;r<e.length;)n||e[r].v===t[r].v||(n=(e[r].v>t[r].v?1:-1)*("DESC"===e[r].d?-1:1)),r++;return n},a=r(e[Math.floor(Math.random()*e.length)]),o=[],u=[],c=[],l=0,d=e;l<d.length;l++){var f=d[l],h=i(r(f),a);h>0?c.push(f):h<0?o.push(f):u.push(f)}return this.quickSort(o,t).concat(u).concat(this.quickSort(c,t))},e.prototype._orderByRows=function(e,t){return this._sortObj(e,t,this._orderBy)},e.prototype._sortObj=function(e,t,n){var r=this;return n.sort.reduce(function(n,i){var a=i.fn?s.execFunction(r.query,i.fn,e,{result:void 0}).result:s.deepGet(i.path,e),o=i.fn?s.execFunction(r.query,i.fn,t,{result:void 0}).result:s.deepGet(i.path,t);return a===o?0:n||(a>o?1:-1)*("DESC"===i.dir?-1:1)},0)},e.prototype._tableID=function(){return[0,1].map(function(){for(var e=s.random16Bits().toString(16);e.length<4;)e="0"+e;return e}).join("-")},e.prototype._createTable=function(e,n,i,o,u){var c=this,l=this.nSQL.getDB(this.databaseID)._tableIds[e.name]||this._tableID();n||-1===Object.keys(this.nSQL.getDB(this.databaseID)._tables).indexOf(e.name)||(n=!0),new Promise(function(t,n){var r=!1,i=e.name;e._internal||0!==i.indexOf("_")&&null===i.match(/\s/g)&&null===i.match(/[\(\)\]\[\.]/g)?(Object.keys(e.model).forEach(function(t){var i=t.replace(/\s+/g,"-").split(":");1===i.length&&i.push("any"),i[0]&&null===i[0].match(/[\(\)\]\[\.]/g)&&0!==i[0].indexOf("_")||(r=!0,n({error:"Invalid Data Model at "+e.name+"."+t+"! https://docs.nanosql.io/setup/data-models",query:c.query}))}),r||t()):n({error:"Invalid Table Name "+e.name+"! https://docs.nanosql.io/setup/data-models",query:c.query})}).then(function(){return new Promise(function(t,n){c.nSQL.doFilter(c.databaseID,"configTable",{res:e,query:c.query},t,n)})}).then(function(e){var t=function(e,n){if("string"==typeof e){var i=!1,s=-1!==e.indexOf("[]"),a=e.replace(/\[\]/gim,"");if(0===n&&s)throw new Error("Can't use array types as table definition.");if(Object.keys(c.nSQL.getDB(c.databaseID).config.types||{}).reduce(function(e,t){return t===a[1]?(i=!0,(c.nSQL.getDB(c.databaseID).config.types||{})[t]):e},{}),!1===i){if(0===n)throw new Error("Type "+e+" not found!");return}}else e;return Object.keys(e).reduce(function(i,s){return 0===(s.split(":")[1]||"any").indexOf("geo")?i[s]={default:{lat:0,lon:0},model:{"lat:float":{max:90,min:-90},"lon:float":{max:180,min:-180}}}:e[s].model?i[s]=r({},e[s],{model:t(e[s].model,n+1)}):i[s]=e[s],i},{})},n=function(e){return Object.keys(e).filter(function(e){return"*"!==e}).map(function(t){return{key:t.split(":")[0],type:t.split(":")[1]||"any",ai:e[t].ai,pk:e[t].pk,default:e[t].default,notNull:e[t].notNull,max:e[t].max,min:e[t].min,model:e[t].model?n(e[t].model):void 0}})},i="",o=t(e.res.model,0),u=function(e){return"string"==typeof e?"":Object.keys(e).reduce(function(t,n){return e[n]&&e[n].pk?n.split(":")[1]:!t.length&&e[n].model?u(e[n].model):t},"")},d=e.res.indexes||{},f=!1,h=function(e,t){if("string"==typeof t)return[];var n=!1;return Object.keys(t).reduce(function(r,i){return t[i]&&t[i].pk?(n=!0,t[i].ai&&(f=!0),r.push(i.split(":")[0]),r):!n&&t[i].model?h(e.concat([i.split(":")[0]]),t[i].model):r},e)},p=e.res.primaryKey?e.res.primaryKey.split(":")[1]:u(e.res.model),y={id:l,name:e.res.name,mode:e.res.mode?a.resolveMode(e.res.mode):void 0,model:o,columns:n(o),filter:e.res.filter,actions:e.res.actions||[],views:e.res.views||[],queries:(e.res.queries||[]).reduce(function(e,t){return e[t.name]=t,e},{}),indexes:Object.keys(d).map(function(e){var t=(e.split(":")[1]||"string").replace(/\[\]/gim,"");return{id:s.resolvePath(e.split(":")[0]).join("."),type:"date"===t?"int":t,isArray:-1!==(e.split(":")[1]||"string").indexOf("[]"),path:s.resolvePath(e.split(":")[0]),props:d[e],isDate:"date"===t}}).reduce(function(e,t){return-1===Object.keys(c.nSQL.indexTypes).indexOf(t.type)?(i='Index "'+t.id+'" does not have a valid type!',e):(-1!==t.type.indexOf("geo")?(e[t.id+".lon"]={id:t.id+".lon",type:"float",isArray:!1,path:t.path.concat(["lon"]),props:{offset:180},isDate:!1},e[t.id+".lat"]={id:t.id+".lat",type:"float",isArray:!1,path:t.path.concat(["lat"]),props:{offset:90},isDate:!1}):e[t.id]=t,e)},{}),pkType:p,pkCol:e.res.primaryKey?s.resolvePath(e.res.primaryKey.split(":")[0]):h([],e.res.model),isPkNum:-1!==["number","int","float","date"].indexOf(p),ai:f};return 0===y.pkCol.length&&(y.pkCol=["_id"],y.pkType="uuid",y.model["_id:uuid"]={pk:!0},y.columns=n(t(y.model,0))),i&&i.length?Promise.reject(i):new Promise(function(e,t){c.nSQL.doFilter(c.databaseID,"configTableSystem",{res:y,query:c.query},function(t){e(t.res)},t)})}).then(function(e){var t=c.nSQL.getDB(c.databaseID)._tables[c.query.table]&&c.nSQL.getDB(c.databaseID)._tables[c.query.table].mode;return e.mode||t?new Promise(function(r,i){if(n&&e.mode===t)r(e);else{var s=function(){e.mode?e.mode.connect(c.nSQL.getDB(c.databaseID).state.id,function(){r(e)},i):r(e)};t?t.disconnect(function(){s()},i):s()}}):Promise.resolve(e)}).then(function(e){var r=n?Object.keys(c.nSQL.getDB(c.databaseID)._tables[c.query.table].indexes):[],a=Object.keys(e.indexes),o=a.filter(function(e){return-1===r.indexOf(e)}),u=[e.name].concat(o);return i(e,0),s.chainAsync(u,function(i,o,u,l){if(0===o){var d={name:i,conf:e};if(c.nSQL.getDB(c.databaseID)._tableIds[d.name]=e.id,n){delete c.nSQL.getDB(c.databaseID)._tableIds[c.query.table];var f=r.filter(function(e){return-1===a.indexOf(e)});s.allAsync(f,function(e,t,n,r){s.adapterFilters(c.databaseID,c.nSQL,c.query).deleteIndex(i,e,function(){n(null)},r)}).then(function(){c.nSQL.getDB(c.databaseID)._tables[d.name]=d.conf,u(null)}).catch(l)}else s.adapterFilters(c.databaseID,c.nSQL,c.query).createTable(d.name,d.conf,function(){c.nSQL.getDB(c.databaseID)._tables[d.name]=d.conf,u(null)},l)}else{var h=e.indexes[i];t.secondaryIndexQueue[c.nSQL.getDB(c.databaseID).state.id+h.id]=new s._nanoSQLQueue,s.adapterFilters(c.databaseID,c.nSQL,c.query).createIndex(e.name,h.id,h.type,function(){u(null)},l)}})}).then(function(){return c.nSQL._rebuildFKs(),"_util"===c.query.table?Promise.resolve():c.nSQL._saveTableIds()}).then(function(){o()}).catch(u)},e.prototype._dropTable=function(e,t,n){var a=this;new Promise(function(t,n){a.nSQL.getDB(a.databaseID)._fkRels[e]&&a.nSQL.getDB(a.databaseID)._fkRels[e].length?s.allAsync(a.nSQL.getDB(a.databaseID)._fkRels[e],function(e,t,n,o){switch(e.onDelete){case i.InanoSQLFKActions.RESTRICT:var u=0;s.adapterFilters(a.databaseID,a.nSQL,a.query).readIndexKeys(e.childTable,e.childIndex,"offset",0,1,!1,function(e,t){u++},function(){u>0?o("Foreign key restraint error, can't drop!"):n()},o);break;case i.InanoSQLFKActions.CASCADE:var c=[];s.adapterFilters(a.databaseID,a.nSQL,a.query).readIndexKeys(e.childTable,e.childIndex,"all",0,0,!1,function(e,t){c.push(e)},function(){a.nSQL.triggerQuery(a.databaseID,r({},s.buildQuery(a.databaseID,a.nSQL,e.childTable,"delete"),{where:[e.childPath.join("."),e.childIsArray?"INCLUDES":"IN",c]}),s.noop,n,o)},o);break;case i.InanoSQLFKActions.SET_NULL:var l=[];s.adapterFilters(a.databaseID,a.nSQL,a.query).readIndexKeys(e.childTable,e.childIndex,"all",0,0,!1,function(e,t){l.push(e)},function(){var t;a.nSQL.triggerQuery(a.databaseID,r({},s.buildQuery(a.databaseID,a.nSQL,e.childTable,"upsert"),{actionArgs:(t={},t[e.childPath.join(".")]=null,t),where:[e.childPath.join("."),e.childIsArray?"INCLUDES":"IN",c]}),s.noop,n,o)},o);break;default:n()}}).then(t).catch(n):t()}).then(function(){var n=[];return Object.keys(a.nSQL.getDB(a.databaseID)._tables[e].indexes).forEach(function(e){n.push(e)}),n.push(e),s.chainAsync(n,function(t,r,i,o){r===n.length-1?s.adapterFilters(a.databaseID,a.nSQL,a.query).dropTable(t,function(){delete a.nSQL.getDB(a.databaseID)._tables[t],delete a.nSQL.getDB(a.databaseID)._tableIds[t],a.nSQL._saveTableIds().then(function(){i(t)}).catch(o)},o):s.adapterFilters(a.databaseID,a.nSQL,a.query).deleteIndex(e,t,i,o)}).then(function(){t()})}).catch(n)},e.prototype._onError=function(e){this.query.state="error",this.error(e)},e.prototype._resolveFastWhere=function(e,t,n,r,i){var a=this;if(t.index&&t.parsedFn)this.nSQL.functions[t.parsedFn.name].queryIndex(this.query,t,e,r,i,this._onError);else{var o="_pk_"===t.index,u=this.nSQL.getDB(this.databaseID)._tables[this.query.table].pkCol,c=0,l=new s._nanoSQLQueue(function(t,n,i,l){t?o?(r(e?s.deepGet(u,t):t,0),i()):e?(r(t,c),c++,i()):s.adapterFilters(a.databaseID,a.nSQL,a.query).read(a.query.table,t,function(e){e&&r(e,c),c++,i()},a.error):i()},this._onError,i);if(t.indexArray)switch(t.comp){case"INCLUDES LIKE":s.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKeys(this.query.table,t.index,"range",t.value.replace(/\%/gim,"")+" ",t.value.replace(/\%/gim,"")+"~",n,function(e){l.newItem(e)},function(){l.finished()},this._onError);break;case"INCLUDES":s.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKey(this.query.table,t.index,t.value,function(e){l.newItem(e)},function(){l.finished()},this.error);break;case"INTERSECT ALL":case"INTERSECT":var d={},f=0;s.allAsync(t.value||[],function(e,n,r){s.adapterFilters(a.databaseID,a.nSQL,a.query).readIndexKey(a.query.table,t.index,e,function(e){f=n+1,e&&(d[e]=(d[e]||0)+1)},function(){r(null)},a.error)}).then(function(){("INTERSECT"===t.comp?Object.keys(d):Object.keys(d).filter(function(e){return d[e]===f})).forEach(function(e){l.newItem(e)}),l.finished()})}else switch(t.comp){case"=":e&&o?(r(t.value,0),i()):o?s.adapterFilters(this.databaseID,this.nSQL,this.query).read(this.query.table,t.value,function(e){l.newItem(e),l.finished()},this.error):s.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKey(this.query.table,t.index,t.value,function(e){l.newItem(e)},function(){l.finished()},this.error);break;case"LIKE":o?s.adapterFilters(this.databaseID,this.nSQL,this.query).readMulti(this.query.table,"range",t.value.replace(/\%/gim,"")+"0",t.value.replace(/\%/gim,"")+"Z",n,function(e,t){l.newItem(e)},function(){l.finished()},this._onError):s.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKeys(this.query.table,t.index,"range",t.value.replace(/\%/gim,"")+" ",t.value.replace(/\%/gim,"")+"~",n,function(e){l.newItem(e)},function(){l.finished()},this._onError);break;case"BETWEEN":o?s.adapterFilters(this.databaseID,this.nSQL,this.query).readMulti(this.query.table,"range",t.value[0],t.value[1],n,function(e,t){l.newItem(e)},function(){l.finished()},this._onError):s.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKeys(this.query.table,t.index,"range",t.value[0],t.value[1],n,function(e){l.newItem(e)},function(){l.finished()},this._onError);break;case"IN":var h=n?t.value.sort(function(e,t){return e<t?1:-1}):t.value.sort(function(e,t){return e>t?1:-1});e&&o?(h.forEach(function(e,t){return r(e,t)}),i()):s.allAsync(h,function(e,n,r){o?s.adapterFilters(a.databaseID,a.nSQL,a.query).read(a.query.table,e,function(e){l.newItem(e),r()},a.error):s.adapterFilters(a.databaseID,a.nSQL,a.query).readIndexKey(a.query.table,t.index,e,function(e){l.newItem(e)},function(){r()},a.error)}).then(function(){l.finished()})}}},e.prototype._fastQuery=function(e,t){var n=this;if(this._whereArgs.fastWhere)if(1===this._whereArgs.fastWhere.length){var r=this._whereArgs.fastWhere[0],i=this._pkOrderBy&&"DESC"===this._orderBy.sort[0].dir;this._resolveFastWhere(!1,r,i,function(t,n){e(t,n)},t)}else{var a={},o=0;s.chainAsync(this._whereArgs.fastWhere,function(e,t,r){if(t%2!=1){o=t;n._resolveFastWhere(!0,e,!1,function(e){a[e]=(a[e]||0)+1},r)}else r()}).then(function(){var r=[];Object.keys(a).forEach(function(e){a[e]===o&&r.push(e)}),n._resolveFastWhere(!1,{index:"_pk_",col:n.nSQL.getDB(n.databaseID)._tables[n.query.table].pkCol.join("."),comp:"IN",value:r,type:n.nSQL.getDB(n.databaseID)._tables[n.query.table].pkType},!1,e,t)})}},e.prototype._getRecords=function(e,t,n){var r=this,a=function(n){for(var s=0;s<n.length;)r._whereArgs.type!==i.IWhereType.none?r._whereArgs.whereFn?r._whereArgs.whereFn(n[s],s)&&e(n[s],s):r._where(n[s],r._whereArgs.slowWhere)&&e(n[s],s):e(n[s],s),s++;t()};if("string"==typeof this.query.table)switch(this._whereArgs.type){case i.IWhereType.fast:this._fastQuery(function(t,n){e(s.mutateRowTypes(r.databaseID,t,r.query.table,r.nSQL),n)},t);break;case i.IWhereType.medium:this._fastQuery(function(t,n){r._where(t,r._whereArgs.slowWhere)&&e(s.mutateRowTypes(r.databaseID,t,r.query.table,r.nSQL),n)},t);break;case i.IWhereType.slow:case i.IWhereType.none:case i.IWhereType.fn:var o=this._pkOrderBy&&"DESC"===this._orderBy.sort[0].dir;s.adapterFilters(this.databaseID,this.nSQL,this.query).readMulti(this.query.table,"all",void 0,void 0,o,function(t,n){r._whereArgs.type===i.IWhereType.slow?r._where(t,r._whereArgs.slowWhere)&&e(s.mutateRowTypes(r.databaseID,t,r.query.table,r.nSQL),n):r._whereArgs.type===i.IWhereType.fn&&r._whereArgs.whereFn?r._whereArgs.whereFn(t,n)&&e(s.mutateRowTypes(r.databaseID,t,r.query.table,r.nSQL),n):e(s.mutateRowTypes(r.databaseID,t,r.query.table,r.nSQL),n)},function(){t()},this._onError)}else"function"==typeof this.query.table?this._getTable(this.query.tableAS||s.fastID(),this.query.where,this.query.table,function(e){a(e.rows)}):Array.isArray(this.query.table)?a(this.query.table):n("Can't get selected table!")},e.prototype._rebuildIndexes=function(e,t,n){var r=this,a=this.query.table;if(this.nSQL.getDB(this.databaseID)._tables[a])if(this._whereArgs=this.query.where?this._parseWhere(this.query.where):{type:i.IWhereType.none},this.query.where){var o=new s._nanoSQLQueue(function(t,n,i,s){r._removeRowAndIndexes(r.nSQL.getDB(r.databaseID)._tables[a],t,function(){r._newRow(t,i,s),e(t,n)},s)},n,function(){t()});this._getRecords(function(e){o.newItem(e)},function(){o.finished()},n)}else{var u=Object.keys(this.nSQL.getDB(this.databaseID)._tables[a].indexes);s.allAsync(u,function(e,t,n,i){s.adapterFilters(r.databaseID,r.nSQL,r.query).deleteIndex(a,e,function(){s.adapterFilters(r.databaseID,r.nSQL,r.query).createIndex(a,e,r.nSQL.getDB(r.databaseID)._tables[a].indexes[e].type,function(){n(null)},i)},i)}).then(function(){var i=new s._nanoSQLQueue(function(t,n,i,o){var u=r._getIndexValues(r.nSQL.getDB(r.databaseID)._tables[a].indexes,t),c=s.deepGet(r.nSQL.getDB(r.databaseID)._tables[a].pkCol,t);s.allAsync(Object.keys(u),function(i,s,o,l){var d=u[i];r._updateIndex(a,i,d,c,!0,function(){e(t,n),o()},l)}).then(i).catch(o)},n,function(){t()});r._getRecords(function(e){i.newItem(e)},function(){i.finished()},n)}).catch(n)}else n(new Error("Table "+a+" not found for rebuilding indexes!"))},e.prototype._where=function(e,t){if(t.length>1){for(var n="AND",r=!0,i=0;i<t.length;){var s=t[i];if(i%2==1)n=s;else{var a=!1;a=Array.isArray(s)?this._where(e,s):this._compare(s,e),r=0===i?a:"AND"===n?r&&a:r||a}i++}return r}return this._compare(t[0],e)},e.prototype._processLIKE=function(t,n){if(!e.likeCache[n]){var r="",i=n.split("").length-1;e.likeCache[n]=new RegExp(n.split("").map(function(e,t){return"\\"===r?(r=e,e):(r=e,"%"===e?".*":"_"===e?".":0===t?"^"+e:t===i?e+"$":e)}).join(""),"gmi")}return"string"!=typeof t?"number"==typeof t?null!==String(t).match(e.likeCache[n]):null!==JSON.stringify(t).match(e.likeCache[n]):null!==t.match(e.likeCache[n])},e.prototype._getColValue=function(e,t){var n=e.fnString?s.execFunction(this.query,e.fnString,t,{result:void 0}).result:s.deepGet(e.col,t);return"date"===e.type?Array.isArray(n)?n.map(function(e){return s.maybeDate(e)}):s.maybeDate(n):n},e.prototype._compare=function(e,t){var n=this,r=this._getColValue(e,t),i=e.value,a=e.comp;if("NULL"===i||"NOT NULL"===i){var o=-1!==[void 0,null,""].indexOf(r),u="="===a||"LIKE"===a;switch(i){case"NULL":return u?o:!o;case"NOT NULL":return u?!o:o}}if(-1!==["IN","NOT IN","BETWEEN","INTERSECT","INTERSECT ALL","NOT INTERSECT"].indexOf(a)&&!Array.isArray(i))return this.query.state="error",this.query.error('WHERE "'+a+'" comparison requires an array value!'),!1;switch(a){case"=":return s.objectsEqual(i,r);case"!=":return!s.objectsEqual(i,r);case">":return r>i;case"<":return r<i;case"<=":return r<=i;case">=":return r>=i;case"IN":return-1!==i.indexOf(r);case"NOT IN":return-1===i.indexOf(r);case"REGEXP":case"REGEX":return null!==(r||"").match(i);case"LIKE":return this._processLIKE(r||"",i);case"NOT LIKE":return!this._processLIKE(r||"",i);case"BETWEEN":return i[0]<=r&&i[1]>=r;case"NOT BETWEEN":return i[0]>=r||i[1]<=r;case"INCLUDES":return-1!==(r||[]).indexOf(i);case"INCLUDES LIKE":return(r||[]).filter(function(e){return n._processLIKE(e,i)}).length>0;case"NOT INCLUDES":return-1===(r||[]).indexOf(i);case"INTERSECT":return(r||[]).filter(function(e){return i.indexOf(e)>-1}).length>0;case"INTERSECT ALL":return(r||[]).filter(function(e){return i.indexOf(e)>-1}).length===i.length;case"NOT INTERSECT":return 0===(r||[]).filter(function(e){return i.indexOf(e)>-1}).length;default:return!1}},e.prototype._parseSort=function(t,n){var r=(t&&t.length?s.hash(JSON.stringify(t)):"")+("string"==typeof this.query.table?this.nSQL.getDB(this.databaseID).state.cacheId:"");if(!r)return{sort:[],index:""};if(e._sortMemoized[r])return e._sortMemoized[r];var i=!1,a=t.map(function(e){return e.split(" ").map(function(e){return e.trim()})}).reduce(function(e,t){var n=-1!==t[0].indexOf("(");return n&&(i=!0),e.push({path:n?[]:s.resolvePath(t[0]),fn:n?t[0]:void 0,dir:(t[1]||"asc").toUpperCase()}),e},[]),o="";if(n&&!1===i&&1===a.length){var u="string"==typeof this.query.table?this.nSQL.getDB(this.databaseID)._tables[this.query.table].pkCol:[];if(a[0].path[0].length&&s.objectsEqual(a[0].path,u))o="_pk_";else for(var c=Object.keys(this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes),l=c.length;l--&&!o;)s.objectsEqual(this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes[c[l]],a[0].path)&&(o=this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes[c[l]].id)}return e._sortMemoized[r]={sort:a,index:o},e._sortMemoized[r]},e.prototype._parseSelect=function(){var t=this,n=(this.query.actionArgs&&this.query.actionArgs.length?JSON.stringify(this.query.actionArgs):"")+("string"==typeof this.query.table?this.nSQL.getDB(this.databaseID).state.cacheId:"");this._orderBy=this._parseSort(this.query.orderBy||[],"string"==typeof this.query.table),this._groupBy=this._parseSort(this.query.groupBy||[],!1),n?e._selectArgsMemoized[n]?(this._hasAggrFn=e._selectArgsMemoized[n].hasAggrFn,this._selectArgs=e._selectArgsMemoized[n].args):((this.query.actionArgs||[]).forEach(function(e){var n=e.split(/\s+as\s+/i).map(function(e){return e.trim()});if(-1!==n[0].indexOf("(")){var r=n[0].split("(")[0].trim().toUpperCase();t._selectArgs.push({isFn:!0,value:n[0],as:n[1],args:void 0}),t.nSQL.functions[r]?"A"===t.nSQL.functions[r].type&&(t._hasAggrFn=!0):(t.query.state="error",t.error('Function "'+r+'" not found!'))}else t._selectArgs.push({isFn:!1,value:n[0],as:n[1]})}),"error"!==this.query.state&&(e._selectArgsMemoized[n]={hasAggrFn:this._hasAggrFn,args:this._selectArgs})):this._selectArgs=[];var r=!1;this._whereArgs.type===i.IWhereType.none?(r="_pk_"===this._orderBy.index)&&(this._pkOrderBy=!0):(r=!!(this._orderBy.index.length&&this._whereArgs.fastWhere&&s.objectsEqual(this._whereArgs.fastWhere[0].col,this._orderBy.sort[0].path)))&&(this._idxOrderBy=!0),(this._orderBy.sort.length&&!r||this._groupBy.sort.length||this._hasAggrFn)&&(this._stream=!1)},e.prototype._parseWhere=function(t,n){var r=this,a=t||[],o=JSON.stringify(a,function(e,t){return t&&t.constructor&&"RegExp"===t.constructor.name?t.toString():t})+(n?"0":"1")+("string"==typeof this.query.table?this.nSQL.getDB(this.databaseID).state.cacheId:"");if(e._whereMemoized[o])return e._whereMemoized[o];if("function"==typeof a)return{type:i.IWhereType.fn,whereFn:a};if(!a.length)return e._whereMemoized[o]={type:i.IWhereType.none},e._whereMemoized[o];for(var u="string"==typeof this.query.table?Object.keys(this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes).map(function(e){return r.nSQL.getDB(r.databaseID)._tables[r.query.table].indexes[e]}):[],c="string"==typeof this.query.table?this.nSQL.getDB(this.databaseID)._tables[this.query.table].pkCol:[],l="string"==typeof this.query.table?this.nSQL.getDB(this.databaseID)._tables[this.query.table].pkType:"",d=function(e,t){var i=!n&&0===t;return e.reduce(function(e,n,a){if(a%2==1)return"string"!=typeof n?(r.query.state="error",r.error("Malformed WHERE statement!"),e):(e.push(n),e);if(!Array.isArray(n))return r.query.state="error",r.error("Malformed WHERE statement!"),e;if(Array.isArray(n[0]))e.push(d(n,t+1));else if(-1!==n[0].indexOf("(")){var o=n[0].split("(")[1].replace(")","").split(",").map(function(e){return e.trim()}).filter(function(e){return e}),f=n[0].split("(")[0].trim().toUpperCase(),h=!1;if(!r.nSQL.functions[f])return r.query.state="error",r.error('Function "'+f+'" not found!'),e;if(i&&r.nSQL.functions[f]&&r.nSQL.functions[f].checkIndex){var p=r.nSQL.functions[f].checkIndex(r.query,o,n);p&&(r._indexesUsed.push(s.assign(n)),h=!0,e.push(p))}h||e.push({fnString:n[0],parsedFn:{name:f,args:o},comp:n[1],value:n[2]})}else{var y=!1,g=i?s.resolvePath(n[0]):[];-1!==["=","BETWEEN","IN","LIKE"].indexOf(n[1])&&i&&("LIKE"!==n[1]||n[2].match(/.*\%$/gim))&&(s.objectsEqual(g,c)?"LIKE"===n[1]&&"string"!==l||(y=!0,r._indexesUsed.push(s.assign(n)),e.push({index:"_pk_",col:n[0],comp:n[1],value:n[2],type:l})):u.forEach(function(t){"LIKE"===n[1]&&"string"!==t.type||!1===y&&s.objectsEqual(t.path,g)&&!1===t.isArray&&"NOT NULL"!==n[2]&&(y=!0,r._indexesUsed.push(s.assign(n)),e.push({index:t.id,col:n[0],comp:n[1],value:n[2],type:r.nSQL.getDB(r.databaseID)._tables[r.query.table].indexes[t.id].type}))})),i&&!y&&-1!==["INCLUDES","INTERSECT","INTERSECT ALL","INCLUDES LIKE"].indexOf(n[1])&&u.forEach(function(t){s.objectsEqual(t.path,g)&&!0===t.isArray&&("INCLUDES LIKE"===n[1]&&"string"!==t.type||(y=!0,r._indexesUsed.push(s.assign(n)),e.push({index:t.id,indexArray:!0,col:n[0],comp:n[1],value:n[2],type:r.nSQL.getDB(r.databaseID)._tables[r.query.table].indexes[t.id].type})))});var b="string"==typeof r.query.table?(_=r.nSQL.getDB(r.databaseID)._tables[r.query.table].columns,v=s.resolvePath(n[0]),(m=function(e,t){var n=t.filter(function(t){return t.key===v[e]})[0];return n?v[e+1]?n.model?m(e+1,n.model):"":n.type:""})(0,_)):"";y||e.push({col:n[0],comp:n[1],value:"date"===b?Array.isArray(n[2])?n[2].map(function(e){return s.maybeDate(e)}):s.maybeDate(n[2]):n[2],type:b})}return e;var _,v,m},[])},f=d("string"==typeof a[0]?[a]:a,0),h=!0,p=0,y=-1;p<f.length&&h;)p%2==1?"AND"!==f[p]?h=!1:y=p:Array.isArray(f[p])||!f[p].index?h=!1:y=p,p++;if(y%2==0&&y++,-1===y||"AND"!==f[y]&&f[y])e._whereMemoized[o]={type:i.IWhereType.slow,slowWhere:f};else{var g=f.slice(y+1);e._whereMemoized[o]={type:g.length?i.IWhereType.medium:i.IWhereType.fast,slowWhere:g,fastWhere:f.slice(0,y)}}return e._whereMemoized[o]},e._whereMemoized={},e._sortMemoized={},e._selectArgsMemoized={},e.likeCache={},e}();t._nanoSQLQuery=u},function(e,t,n){var r=this&&this.__assign||function(){return(r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var i,s=n(0),a=n(6),o=function(){function e(e,t,n,i,a,o){this.databaseID=e,this._db=t,this._AV=o||"",this._query="string"==typeof i?r({},s.buildQuery(e,t,n,i),{comments:[],state:"pending",action:i,actionArgs:a,result:[]}):r({},i(t),{state:"pending",result:[]})}return e.prototype.where=function(e){return this._query.where=e,this},e.prototype.orderBy=function(e){return Array.isArray(e)?this._query.orderBy=e:this._query.orderBy=Object.keys(e).map(function(t){return t+" "+String(e[t]).toUpperCase()}),this},e.prototype.distinct=function(e){return this._query.distinct=e,this},e.prototype.groupBy=function(e){return Array.isArray(e)?this._query.groupBy=e:this._query.groupBy=Object.keys(e).map(function(t){return t+" "+String(e[t]).toUpperCase()}),this},e.prototype.having=function(e){return this._query.having=e,this},e.prototype.join=function(e){var t=this,n="Join commands requires table and type arguments!";return Array.isArray(e)?e.forEach(function(e){e.with.table&&e.type||(t._error=n)}):e.with.table&&e.type||(this._error=n),this._query.join=e,this},e.prototype.limit=function(e){return this._query.limit=e,this},e.prototype.comment=function(e){return this._query.comments.push(e),this},e.prototype.tag=function(e){return this._query.tags.push(e),this},e.prototype.extend=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return this._query.extend.push({scope:e,args:t}),this},e.prototype.union=function(e,t){return this._query.union={queries:e,type:t?"all":"distinct"},this},e.prototype.offset=function(e){return this._query.offset=e,this},e.prototype.emit=function(){return this._query},e.prototype.ttl=function(e,t){if(void 0===e&&(e=60),"upsert"!==this._query.action)throw new Error("nSQL: Can only do ttl on upsert queries!");return this._query.ttl=e,this._query.ttlCols=t||[],this},e.prototype.graph=function(e){return this._query.graph=e,this},e.prototype.from=function(e){return"string"==typeof e||Array.isArray(e)?this._query.table=e:(this._query.table=e.table,this._query.tableAS=e.as),this},e.prototype.into=function(e){return this._query.table=e,this},e.prototype.on=function(e){return this._query.table=e,this},e.prototype.toCSV=function(e){var t=this;return this.exec().then(function(n){return Promise.resolve(t._db.JSONtoCSV(n,e))})},e.prototype.copyTo=function(e,t){return this._query.copyTo={table:e,mutate:t||function(e){return e}},this},e.prototype.exec=function(e){var t=this;return new Promise(function(n,r){var i=[];t.stream(function(e){e&&i.push(e)},function(){n(i)},r,e)})},e.prototype.listen=function(e){return new u(this.databaseID,this._query,e&&e.debounce,e&&e.unique,e&&e.compareFn)},e.prototype.stream=function(e,t,n,i){var a=this;if(this._query.returnEvent=i,this._db.dbs[this.databaseID]&&this._db.getDB(this.databaseID).state.exportQueryObj)e(this._query),t&&t();else{var o=this._query.copyTo?new s._nanoSQLQueue(function(t,n,i,o){a._query.parent.triggerQuery(a.databaseID,r({},s.buildQuery(a.databaseID,a._query.parent,a._query.copyTo&&a._query.copyTo.table||"","upsert"),{actionArgs:a._query.copyTo&&a._query.copyTo.mutate(t)}),s.noop,function(){e(t),i()},o)},n,function(){t&&t()}):void 0;this._db.triggerQuery(this.databaseID,this._query,function(t){o?o.newItem(t):e(t)},function(){o?o.finished():t&&t()},n||s.noop)}},e.prototype.cache=function(e,t,n){var r=this,i=s.fastID(),a=[],o=!1,u=0,c=n||{pageSize:0,onPage:s.noop};this.stream(function(e){a.push(e),c.pageSize&&c.onPage&&a.length%c.pageSize==0&&(o=!0,c.onPage(u,a.slice(a.length-c.pageSize)),u++,c.doNotCache&&(a=[]))},function(){c.pageSize&&c.onPage&&(!o||c.doNotCache?c.onPage(0,a.slice()):c.onPage(u,a.slice(u*c.pageSize))),c.doNotCache?(a=[],e("",0)):(r._db.getDB(r.databaseID)._queryCache[i]=a,e(i,a.length))},t)},e}();t._nanoSQLQueryBuilder=o,function(e){e[e.stream=0]="stream",e[e.exec=1]="exec"}(i||(i={}));var u=function(){function e(e,t,n,r,i){var o=this;if(void 0===n&&(n=500),void 0===r&&(r=!1),void 0===i&&(i=a),this.databaseID=e,this.query=t,this.debounce=n,this.unique=r,this.compareFn=i,this._listenTables=[],this._active=!0,this.trigger=this.trigger.bind(this),this._doQuery=this._doQuery.bind(this),this._throttleTrigger=this._doQuery.bind(this),this._cbs={stream:[s.noop,s.noop,s.noop,!1],exec:[s.noop,!1]},"string"!=typeof t.table)throw new Error("Can't listen on dynamic tables!");if("select"!==t.action)throw new Error("Can't listen to this kind of query!");if(this._listenTables.push(t.table),t.join){var u=Array.isArray(t.join)?t.join:[t.join];this._listenTables.concat(this._getTables(u))}if(t.graph){var c=Array.isArray(t.graph)?t.graph:[t.graph];this._listenTables.concat(this._getTables(c))}this._listenTables=this._listenTables.filter(function(e,t,n){return n.indexOf(e)===t}),this._throttleTrigger=s.throttle(this,this._doQuery,n),this._listenTables.forEach(function(e){t.parent.on("change",o._throttleTrigger,e)})}return e.prototype._getTables=function(e){var t=this,n=[];return e.forEach(function(e){e.with&&e.with.table&&"string"==typeof e.with.table&&n.push(e.with.table);var r=e.graph;if(r){var i=Array.isArray(r)?r:[r];n.concat(t._getTables(i))}}),n},e.prototype._doQuery=function(){var e=this;if(this._active&&void 0!==this._mode)switch(this._mode){case i.stream:this.query.returnEvent=this._cbs.stream[3],this.query.parent.triggerQuery(this.databaseID,this.query,this._cbs.stream[0],this._cbs.stream[1],this._cbs.stream[2]);break;case i.exec:this.query.returnEvent=this._cbs.exec[1];var t=[];this.query.parent.triggerQuery(this.databaseID,this.query,function(e){t.push(e)},function(){if(e.unique){(!e._oldValues||(e._oldValues.length!==t.length||!e.compareFn(e._oldValues,t)))&&(e._oldValues=t,e._cbs.exec[0](s.assign(t)))}else e._cbs.exec[0](t)},function(t){e._cbs.exec[0]([],t)})}},e.prototype._maybeError=function(){if(void 0!==this._mode)throw new Error("Listen can't have multiple exports!")},e.prototype.trigger=function(){this._throttleTrigger()},e.prototype.stream=function(e,t,n,r){if(this.unique)throw new Error("Can't use unique with stream listener!");this._maybeError(),this._mode=i.stream,this._cbs.stream=[e,t,n,r||!1],this._doQuery()},e.prototype.exec=function(e,t){this._maybeError(),this._mode=i.exec,this._cbs.exec=[e,t||!1],this._doQuery()},e.prototype.unsubscribe=function(){var e=this;this._active=!1,this._listenTables.forEach(function(t){e.query.parent.off("change",e._throttleTrigger,t)})},e}()}])});