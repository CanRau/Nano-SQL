<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Testing</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="nano-sql.min.js"></script>
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/alasql/0.4.3/alasql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.1.0/es6-promise.auto.js"></script>
    <script>
        function test() {

            nSQL().connect({
                id: "test",
                tables: [
                    {
                        name: "users",
                        model: [
                            {
                                key: "id:uuid",
                                props: ["pk()"]
                            },
                            {
                                key: "name:string"
                            },
                            {
                                key: "age:int",
                                default: 18
                            },
                            {
                                key: "meta:any",
                                default: {}
                            },
                            {
                                key: "tags:string[]",
                                default: []
                            }
                        ],
                        indexes: [
                            { name: "Tags", key: "tags:string[]" },
                            { name: "Age", key: "age:int" }
                        ]
                    }
                ],
            }).then(() => {
                return nSQL("users").query("upsert", [{ name: "Billy", age: 20, meta: { color: "blue" }, tags: ["some", "tags", "here"] }, { name: "Scott", age: 30, meta: { color: "orange" }, tags: ["some"] }, { name: "Jeb", meta: { color: "yellow" } }]).exec();
            }).then(() => {
                console.time("sel");
                return nSQL("users").query("upsert", { age: 21 }).where(["meta.color", "=", "blue"]).exec();
            }).then((result) => {
                console.log(result);
                console.time("sel");
                console.log(nSQL());
                return nSQL("users").query("select").where([["tags", "INTERSECT ALL", ["here", "some"]], "AND", ["age", "=", 21]]).exec();
            }).then((rows) => {
                console.timeEnd("sel");
                console.log(JSON.stringify(rows, null, 4));
            }).catch((err) => {
                console.error(err);
            });

/*
            nSQL().query("select", ["author[0].name AS author", "body", "comments[0].totalComments AS commentsTotal", "id", "title"]).from({
                table: () => fetch("https://jsonplaceholder.typicode.com/posts").then(d => d.json()),
                as: "posts"
            }).graph([
                {
                    key: "author",
                    with: {
                        table: () => fetch("https://jsonplaceholder.typicode.com/users").then(d => d.json()),
                        as: "author"
                    },
                    on: ["author.id", "=", "posts.userId"]
                },
                {
                    key: "comments",
                    select: ["COUNT(*) as totalComments"],
                    with: {
                        table: () => fetch("https://jsonplaceholder.typicode.com/comments").then(d => d.json()),
                        as: "comments"
                    },
                    on: ["comments.postId", "=", "posts.id"]
                }
            ]).exec().then((rows) => {
                console.log(rows);
            });
            
            nSQL().query("select", ["userId", "COUNT(*)"]).groupBy(["userId"]).from(() => {
                return fetch("https://jsonplaceholder.typicode.com/posts").then(d => d.json());
            }).exec().then((rows) => {
                console.log("POSTS", rows);
            })*/
            
            nSQL().query("select").from({
                table: () => fetch("https://jsonplaceholder.typicode.com/posts").then(d => d.json()),
                as: "posts"
            }).where(["userId", "=", 3]).join([
                {
                    type: "inner",
                    with: {
                        table: () => fetch("https://jsonplaceholder.typicode.com/comments").then(d => d.json()),
                        as: "comments"
                    },
                    on: ["posts.id", "=", "comments.postId"]
                },
                {
                    type: "inner",
                    with: {
                        table: () => fetch("https://jsonplaceholder.typicode.com/users").then(d => d.json()),
                        as: "users"
                    },
                    on: ["users.id", "=", "posts.userId"]
                }
            ])
            .exec().then((rows) => {
                console.log("POSTS", rows);
            })
        }
        test();

    </script>
</head>

<body>
    <button onclick="testNanoSQL()">Test nanoSQL</button>
    <button onclick="testAlaSQL()">Test alaSQL</button>
    <script>
        function makeid() {
            var text = "";
            var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

            for (var i = 0; i < 10; i++)
                text += possible.charAt(Math.floor(Math.random() * possible.length));

            return text;
        }

        function testAlaSQL() {
            console.log("Creating 100 in memory databases, writing 100 random rows to each.")

            function runTest(complete) {

                var mybase = new alasql.Database();
                mybase.exec(
                    `CREATE TABLE users (
                    id INT PRIMARY KEY AUTO_INCREMENT,
                    name TEXT,
                    pass TEXT,
                    email TEXT
                )`
                );


                let i = 0;
                var start = Date.now();
                const w = () => {
                    if (i < 100) {
                        mybase.exec(`INSERT INTO users (name, pass, email) VALUES (?, ?, ?)`, [makeid(), makeid(),
                        makeid()
                        ], () => {
                            i++;
                            Promise.resolve().then(w);
                        });
                    } else {

                        // start = Date.now();
                        // mybase.exec("UPDATE users SET name=? WHERE id BETWEEN 10 AND 30", [makeid()], (rows) => {
                        // console.log("READ", (Date.now() - start))
                        complete(Date.now() - start);
                        // })
                    }

                }
                w();
            }


            let k = 0;
            let results = [];

            function nextTest() {
                if (k < 100) {
                    runTest(function (result) {
                        console.log(k + ": " + result)
                        results.push(result);
                        k++;
                        Promise.resolve().then(nextTest);
                    })
                } else {
                    console.log("AVG:" + results.reduce((prev, cur) => {
                        return prev + cur;
                    }, 0) / results.length);
                }
            }

            nextTest();
        }

        function testNanoSQL() {
            console.log("Creating 100 in memory databases, writing 100 random rows to each.");

            function runTest(complete) {

                var db = new NanoSQL();

                db.selectTable("users").connect({
                    id: "test",
                    queue: false,
                    tables: [
                        {
                            name: "users",
                            model: [
                                { key: "id:int", props: ["pk()", "ai()"] },
                                { key: "name:any" },
                                { key: "pass:any" },
                                { key: "email:any" }
                            ]
                        }
                    ]
                }).then(function () {
                    var start = Date.now();
                    let i = 0;
                    const w = () => {
                        if (i < 100) {
                            db.query("upsert", {
                                name: makeid(),
                                pass: makeid(),
                                email: makeid()
                            }).exec().then(() => {
                                i++;
                                Promise.resolve().then(w);
                                // setTimeout(w, 10);
                            });
                        } else {
                            // start = Date.now();
                            // db.table("users").query("upsert", {name: makeid()}).where(["id", "BETWEEN", [10, 30]]).exec().then(() => {
                            complete((Date.now() - start));
                            // });
                            //console.log("WRITE", (new Date().getTime() - start))
                        }

                    }
                    w();
                });
            }
            // runTest((time) => { console.log(time) });
            // return;

            let k = 0;
            let results = [];

            function nextTest() {
                if (k < 100) {
                    runTest(function (result) {
                        console.log(k + ": " + result)
                        results.push(result);
                        k++;
                        Promise.resolve().then(nextTest);
                    })
                } else {
                    console.log("AVG:" + results.reduce((prev, cur) => {
                        return prev + cur;
                    }, 0) / results.length);
                }
            }

            nextTest();
        }
    </script>
</body>

</html>